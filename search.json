[{"title":"Linuxæ–‡ä»¶æè¿°ç¬¦","url":"/2025/03/26/Linuxæ–‡ä»¶æè¿°ç¬¦/","content":"## æ–‡ä»¶æè¿°ç¬¦(file descriptor)\næˆ‘ä»¬çŸ¥é“åœ¨Linuxç³»ç»Ÿä¸­ä¸€åˆ‡çš†å¯ä»¥çœ‹æˆæ˜¯æ–‡ä»¶ï¼Œæ–‡ä»¶åˆå¯åˆ†ä¸ºï¼šæ™®é€šæ–‡ä»¶ã€ç›®å½•æ–‡ä»¶ã€é“¾æ¥æ–‡ä»¶å’Œè®¾å¤‡æ–‡ä»¶ã€‚åœ¨æ“ä½œè¿™äº›æ‰€è°“çš„æ–‡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¯æ“ä½œä¸€æ¬¡å°±æ‰¾ä¸€æ¬¡åå­—ï¼Œè¿™ä¼šè€—è´¹å¤§é‡çš„æ—¶é—´å’Œæ•ˆç‡ã€‚æ‰€ä»¥Linuxä¸­è§„å®šæ¯ä¸€ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªç´¢å¼•ï¼Œè¿™æ ·è¦æ“ä½œæ–‡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥æ‰¾åˆ°ç´¢å¼•å°±å¯ä»¥å¯¹å…¶è¿›è¡Œæ“ä½œäº†ã€‚\n\næ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å°±æ˜¯å†…æ ¸ä¸ºäº†é«˜æ•ˆç®¡ç†è¿™äº›å·²ç»è¢«æ‰“å¼€çš„æ–‡ä»¶æ‰€åˆ›å»ºçš„ç´¢å¼•ï¼Œå…¶æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼ˆé€šå¸¸æ˜¯å°æ•´æ•°ï¼‰ï¼Œç”¨äºæŒ‡ä»£è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰€æœ‰æ‰§è¡ŒI/Oæ“ä½œçš„ç³»ç»Ÿè°ƒç”¨éƒ½é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥å®ç°ã€‚åŒæ—¶è¿˜è§„å®šç³»ç»Ÿåˆšåˆšå¯åŠ¨çš„æ—¶å€™ï¼Œ0æ˜¯æ ‡å‡†è¾“å…¥ï¼Œ1æ˜¯æ ‡å‡†è¾“å‡ºï¼Œ2æ˜¯æ ‡å‡†é”™è¯¯ã€‚è¿™æ„å‘³ç€å¦‚æœæ­¤æ—¶å»æ‰“å¼€ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå®ƒçš„æ–‡ä»¶æè¿°ç¬¦ä¼šæ˜¯3ï¼Œå†æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯4â€¦â€¦\n\nLinuxå†…æ ¸å¯¹æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨æ ¼ï¼Œé‡Œé¢å­˜å‚¨äº†æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä½œä¸ºç´¢å¼•ä¸ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶ç›¸å¯¹åº”çš„å…³ç³»ï¼Œç®€å•ç†è§£å°±æ˜¯ä¸‹å›¾è¿™æ ·ä¸€ä¸ªæ•°ç»„ï¼Œæ–‡ä»¶æè¿°ç¬¦ï¼ˆç´¢å¼•ï¼‰å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦è¡¨è¿™ä¸ªæ•°ç»„çš„ä¸‹æ ‡ï¼Œæ•°ç»„çš„å†…å®¹å°±æ˜¯æŒ‡å‘ä¸€ä¸ªä¸ªæ‰“å¼€çš„æ–‡ä»¶çš„æŒ‡é’ˆã€‚\n\n![æ–‡ä»¶æŒ‡é’ˆ](/images/linux/file_1.png)\n\nä¸Šé¢åªæ˜¯ç®€å•ç†è§£ï¼Œå®é™…ä¸Šå…³äºæ–‡ä»¶æè¿°ç¬¦ï¼ŒLinuxå†…æ ¸ç»´æŠ¤äº†3ä¸ªæ•°æ®ç»“æ„ï¼š\n\n- è¿›ç¨‹çº§çš„æ–‡ä»¶æè¿°ç¬¦è¡¨\n- ç³»ç»Ÿçº§çš„æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦è¡¨\n- æ–‡ä»¶ç³»ç»Ÿçš„i-nodeè¡¨\n\nä¸€ä¸ª Linux è¿›ç¨‹å¯åŠ¨åï¼Œä¼šåœ¨å†…æ ¸ç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ª PCB æ§åˆ¶å—ï¼ŒPCB å†…éƒ¨æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼ˆFile descriptor tableï¼‰ï¼Œè®°å½•ç€å½“å‰è¿›ç¨‹æ‰€æœ‰å¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå³å½“å‰è¿›ç¨‹æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ã€‚è¿›ç¨‹çº§çš„æè¿°ç¬¦è¡¨çš„æ¯ä¸€æ¡è®°å½•äº†å•ä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦çš„ç›¸å…³ä¿¡æ¯ï¼Œè¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨äº†æ–‡ä»¶æè¿°ç¬¦3ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹ä¹Ÿå¯ä»¥ç”¨3ã€‚é™¤äº†è¿›ç¨‹çº§çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œç³»ç»Ÿè¿˜éœ€è¦ç»´æŠ¤å¦å¤–ä¸¤å¼ è¡¨ï¼šæ‰“å¼€æ–‡ä»¶è¡¨ã€i-node è¡¨ã€‚è¿™ä¸¤å¼ è¡¨å­˜å‚¨äº†æ¯ä¸ªæ‰“å¼€æ–‡ä»¶çš„æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰ã€‚ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶å¥æŸ„å­˜å‚¨äº†ä¸ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶ç›¸å…³çš„å…¨éƒ¨ä¿¡æ¯ã€‚\n\nç³»ç»Ÿçº§çš„æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼š\n\n- å½“å‰æ–‡ä»¶åç§»é‡ï¼ˆè°ƒç”¨read()å’Œwrite()æ—¶æ›´æ–°ï¼Œæˆ–ä½¿ç”¨lseek()ç›´æ¥ä¿®æ”¹ï¼‰\n- æ‰“å¼€æ–‡ä»¶æ—¶çš„æ ‡è¯†ï¼ˆopen()çš„flagså‚æ•°ï¼‰\n- æ–‡ä»¶è®¿é—®æ¨¡å¼ï¼ˆå¦‚è°ƒç”¨open()æ—¶æ‰€è®¾ç½®çš„åªè¯»æ¨¡å¼ã€åªå†™æ¨¡å¼æˆ–è¯»å†™æ¨¡å¼ï¼‰\n- ä¸ä¿¡å·é©±åŠ¨ç›¸å…³çš„è®¾ç½®\n- å¯¹è¯¥æ–‡ä»¶i-nodeå¯¹è±¡çš„å¼•ç”¨ï¼Œå³i-node è¡¨æŒ‡é’ˆ\n\næ–‡ä»¶ç³»ç»Ÿçš„i-nodeè¡¨ï¼š\n\n- æ–‡ä»¶ç±»å‹ï¼ˆä¾‹å¦‚ï¼šå¸¸è§„æ–‡ä»¶ã€å¥—æ¥å­—æˆ–FIFOï¼‰å’Œè®¿é—®æƒé™\n- ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥æ–‡ä»¶æ‰€æŒæœ‰çš„é”åˆ—è¡¨\n- æ–‡ä»¶çš„å„ç§å±æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¤§å°ä»¥åŠä¸ä¸åŒç±»å‹æ“ä½œç›¸å…³çš„æ—¶é—´æˆ³\n\n![æ–‡ä»¶æè¿°ç¬¦ã€æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ä»¥åŠi-nodeä¹‹é—´çš„å…³ç³»](/images/linux/file_1.gif)\n- åœ¨è¿›ç¨‹ A ä¸­ï¼Œæ–‡ä»¶æè¿°ç¬¦ 1 å’Œ 20 éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªæ‰“å¼€æ–‡ä»¶è¡¨é¡¹ï¼Œæ ‡å·ä¸º 23ï¼ˆæŒ‡å‘äº†æ‰“å¼€æ–‡ä»¶è¡¨ä¸­ä¸‹æ ‡ä¸º 23 çš„æ•°ç»„å…ƒç´ ï¼‰ï¼Œè¿™å¯èƒ½æ˜¯é€šè¿‡è°ƒç”¨ dup()ã€dup2()ã€fcntl() æˆ–è€…å¯¹åŒä¸€ä¸ªæ–‡ä»¶å¤šæ¬¡è°ƒç”¨äº† open() å‡½æ•°å½¢æˆçš„ã€‚\n- è¿›ç¨‹ A çš„æ–‡ä»¶æè¿°ç¬¦ 2 å’Œè¿›ç¨‹ B çš„æ–‡ä»¶æè¿°ç¬¦ 2 éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™å¯èƒ½æ˜¯åœ¨è°ƒç”¨ fork() åå‡ºç°çš„ï¼ˆå³è¿›ç¨‹ Aã€B æ˜¯çˆ¶å­è¿›ç¨‹å…³ç³»ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸åŒçš„è¿›ç¨‹ç‹¬è‡ªå»è°ƒç”¨ open() å‡½æ•°æ‰“å¼€äº†åŒä¸€ä¸ªæ–‡ä»¶ï¼Œæ­¤æ—¶è¿›ç¨‹å†…éƒ¨çš„æè¿°ç¬¦æ­£å¥½åˆ†é…åˆ°ä¸å…¶ä»–è¿›ç¨‹æ‰“å¼€è¯¥æ–‡ä»¶çš„æè¿°ç¬¦ä¸€æ ·ã€‚\n- è¿›ç¨‹ A çš„æè¿°ç¬¦ 0 å’Œè¿›ç¨‹ B çš„æè¿°ç¬¦ 3 åˆ†åˆ«æŒ‡å‘ä¸åŒçš„æ‰“å¼€æ–‡ä»¶è¡¨é¡¹ï¼Œä½†è¿™äº›è¡¨é¡¹å‡æŒ‡å‘ i-node è¡¨çš„åŒä¸€ä¸ªæ¡ç›®ï¼ˆæ ‡å·ä¸º 1976ï¼‰ï¼›æ¢è¨€ä¹‹ï¼Œå®ƒä»¬æŒ‡å‘äº†åŒä¸€ä¸ªæ–‡ä»¶ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºæ¯ä¸ªè¿›ç¨‹å„è‡ªå¯¹åŒä¸€ä¸ªæ–‡ä»¶å‘èµ·äº† open() è°ƒç”¨ã€‚åŒä¸€ä¸ªè¿›ç¨‹ä¸¤æ¬¡æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿä¼šå‘ç”Ÿç±»ä¼¼æƒ…å†µã€‚\n\nè¿™å°±è¯´æ˜ï¼šåŒä¸€ä¸ªè¿›ç¨‹çš„ä¸åŒæ–‡ä»¶æè¿°ç¬¦å¯ä»¥æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ï¼›ä¸åŒè¿›ç¨‹å¯ä»¥æ‹¥æœ‰ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼›ä¸åŒè¿›ç¨‹çš„åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥æŒ‡å‘ä¸åŒçš„æ–‡ä»¶ï¼ˆä¸€èˆ¬ä¹Ÿæ˜¯è¿™æ ·ï¼Œé™¤äº† 0ã€1ã€2 è¿™ä¸‰ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼‰ï¼›ä¸åŒè¿›ç¨‹çš„ä¸åŒæ–‡ä»¶æè¿°ç¬¦ä¹Ÿå¯ä»¥æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ã€‚","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"Linuxé˜»å¡ä¸éé˜»å¡IO","url":"/2025/03/26/Linuxé˜»å¡ä¸éé˜»å¡IO/","content":"## é˜»å¡IO\né˜»å¡çŠ¶æ€ä¸‹åº”ç”¨ç¨‹åºä»é©±åŠ¨è¯»å–å‡½æ•°æ—¶ï¼Œè‹¥kernelå›æŠ¥è®¾å¤‡ä¸å¯ç”¨ï¼Œåº”ç”¨ç¨‹åºå¯¹åº”çš„çº¿ç¨‹å°†ä¼šè¿›å…¥ç¡çœ ï¼Œç­‰å¾…è®¾å¤‡å¯ç”¨åç”±è®¾å¤‡é€šçŸ¥åº”ç”¨ç¨‹åºå¹¶å°†å…¶å”¤é†’ä»¥ç»§ç»­æ‰§è¡Œã€‚\n\nLinuxä¾é ç­‰å¾…é˜Ÿåˆ—(wait queue)æ¥è¿›è¡Œè¿›ç¨‹åŒæ­¥ï¼Œå…¶å…è®¸è¿›ç¨‹åœ¨æŸä¸ªæ¡ä»¶æ»¡è¶³å‰è¿›å…¥ç¡çœ ï¼Œå¹¶åœ¨æ¡ä»¶æ»¡è¶³æ—¶ç”±é©±åŠ¨è¿›è¡Œå”¤é†’ï¼Œé¿å…CPUå¿™ç­‰ã€‚\n\n### ç­‰å¾…é˜Ÿåˆ—\nåŸºæœ¬çš„ç­‰å¾…é˜Ÿåˆ—åŒ…æ‹¬ï¼š\n- äº‹ä»¶(event)ï¼šé€šå¸¸æ˜¯ ç¡¬ä»¶ä¸­æ–­ã€æ•°æ®å¯ç”¨ æˆ– èµ„æºé‡Šæ”¾ ç­‰\n- ç­‰å¾…é˜Ÿåˆ—å¤´ï¼ˆ`wait_queue_head_t`ï¼‰ï¼šæ¯ä¸ªç­‰å¾…é˜Ÿåˆ—éƒ½æœ‰ä¸€ä¸ªé˜Ÿåˆ—å¤´ï¼Œç”¨äºç®¡ç†åœ¨æ­¤ç­‰å¾…çš„è¿›ç¨‹\n- ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼ˆ`wait_queue_t`ï¼‰ï¼šè¡¨ç¤ºç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒåŒ…å«è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯\n\nç­‰å¾…é˜Ÿåˆ—å¤´ç»“æ„ä½“ï¼š\n```\ntypedef struct __wait_queue_head {\n    spinlock_t lock;         // ä¿æŠ¤ç­‰å¾…é˜Ÿåˆ—çš„è‡ªæ—‹é”\n    struct list_head task_list; \n} wait_queue_head_t;\n```\næ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œ`task_list`ä¸ºæ‰€æœ‰ç­‰å¾…æŸäº‹ä»¶å‘ç”Ÿçš„è¿›ç¨‹é“¾è¡¨ã€‚ç­‰å¾…é˜Ÿåˆ—å¤´ç»´æŠ¤ç­‰å¾…è¯¥äº‹ä»¶çš„æ‰€æœ‰è¿›ç¨‹ï¼Œé€šè¿‡è‡ªæ—‹é”æ¥ä¿æŠ¤å¯¹`task_list`çš„è®¿é—®ä»¥é˜²æ­¢ç«äº‰æ¡ä»¶ã€‚\n\nç­‰å¾…é˜Ÿåˆ—é¡¹ï¼š\n```\ntypedef struct wait_queue_entry {\n    unsigned int flags;\n    struct task_struct *task;  // è¿›ç¨‹çš„task_struct\n    struct list_head entry;    // è¿æ¥åˆ°ç­‰å¾…é˜Ÿåˆ—\n} wait_queue_entry_t;\n```\nç­‰å¾…é˜Ÿåˆ—é¡¹ä»£è¡¨æ­£åœ¨ç­‰å¾…äº‹ä»¶çš„è¿›ç¨‹ï¼Œè¿›ç¨‹ä¼šè¢«æŒ‚è½½è‡³`task_list`ï¼Œè¿›å…¥ç¡çœ ã€‚\n\nè¿™é‡Œç»“æ„ä½“ä¸­çš„`task_struct`æ˜¯Linuxçš„è¿›ç¨‹æè¿°ç¬¦ï¼Œè¯¥ç»“æ„ä½“ä¼šç®¡ç†æ‰€æœ‰çš„è¿›ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿è€Œä¸”å¾ˆå¤æ‚çš„ç»“æ„ä½“ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„é‡`volatile long state`ï¼Œç”¨äºè¡¨ç¤ºè¿›ç¨‹å½“å‰çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼š\n- `TASK_RUNNING`ï¼šæ­£åœ¨è¿è¡Œæˆ–å‡†å¤‡è¿è¡Œ\n- `TASK_INTERRUPTIBLE`ï¼šå¤„äºå¯è¢«ä¸­æ–­çš„ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿã€‚æ­¤è¿‡ç¨‹ä¸‹è¿›ç¨‹å¯è¢«ä¿¡å·å”¤é†’\n- `TASK_UNINTERRUPTIBLE`ï¼šå¤„äºä¸å¯è¢«ä¸­æ–­çš„ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿã€‚æ­¤è¿‡ç¨‹ä¸‹è¿›ç¨‹ä¸å¯è¢«ä¿¡å·å”¤é†’ï¼Œåªèƒ½ç­‰å¾…äº‹ä»¶å‘ç”Ÿ\n- `TASK_STOPPED`ï¼šè¿›ç¨‹åœæ­¢æ‰§è¡Œ\n- `TASK_TRACED`ï¼šè¿›ç¨‹æ­£åœ¨è¢«è°ƒè¯•å™¨è¿½è¸ª\n- `TASK_DEAD`ï¼šè¿›ç¨‹å·²ç»ˆæ­¢ï¼Œç­‰å¾…è¢«é‡Šæ”¾\n- `TASK_WAKEKILL`ï¼šè¿›ç¨‹å¤„äºå¯è¢«æ€æ­»çš„ç¡çœ çŠ¶æ€ï¼Œå³ä½¿åœ¨ä¸å¯ä¸­æ–­çš„ç¡çœ ä¸­ï¼Œä¹Ÿèƒ½è¢«ç‰¹å®šä¿¡å·å”¤é†’æˆ–ç»ˆæ­¢\n- `TASK_WAKING`ï¼šè¿›ç¨‹æ­£åœ¨ä»ç¡çœ çŠ¶æ€ä¸­è¢«å”¤é†’ï¼Œå°šæœªè¿›å…¥å¯è¿è¡Œé˜Ÿåˆ—\n- `TASK_NOLOAD`ï¼šè¿›ç¨‹ä¸åº”å½±å“è´Ÿè½½è®¡ç®—ï¼Œé€šå¸¸ç”¨äºå†…æ ¸çº¿ç¨‹\n\nå¯¹äºç­‰å¾…é˜Ÿåˆ—ï¼Œå‰ä¸‰ç§çŠ¶æ€æ¯”è¾ƒå¸¸è§ã€‚\n\n### ç­‰å¾…é˜Ÿåˆ—çš„ä½¿ç”¨æ–¹å¼\n1. å®šä¹‰å’Œåˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—å¤´\n```\nstruct xxx_dev {\n    .......\n    wait_queue_head_t r_wait;\n}\n```\n2. è®¾å®šç­‰å¾…æ¡ä»¶å’Œäº‹ä»¶ï¼ˆä»¥æŒ‰é”®ä¸ºä¾‹ï¼‰\n```\n    DECLARE_WAITQUEUE(wait, current);   /* åˆ›å»ºç­‰å¾…é˜Ÿåˆ— */\n    if (atomic_read(&dev->releasekey) == 0){    /* å¦‚æœæŒ‰é”®æœªæŒ‰ä¸‹ */\n        add_wait_queue(&dev->r_wait, &wait);    /* æ·»åŠ å½“å‰çº¿ç¨‹è‡³ç­‰å¾…é˜Ÿåˆ— */\n        __set_current_state(TASK_INTERRUPTIBLE);    /* åˆ‡æ¢è¿›ç¨‹æ¨¡å¼è‡³å¯ä¸­æ–­ç¡çœ çŠ¶æ€ */\n        schedule(); /* è®©å‡ºCPUï¼Œç­‰å¾…è¢«å”¤é†’ */\n        if (signal_pending(current)){   /* å¦‚æœæœ‰ä¿¡å·æ‰“æ–­ç¡çœ ï¼Œé€€å‡º */\n            ret = -ERESTARTSYS;\n            goto wait_error;\n        }\n        __set_current_state(TASK_RUNNING);  /* è¿›ç¨‹æ¢å¤è¿è¡Œ */\n        remove_wait_queue(&dev->r_wait, &wait); /* ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å½“å‰çº¿ç¨‹ */\n    }\n```\nå…¶ä¸­ï¼š\n- `DECLARE_WAITQUEUE(name, tsk)`ï¼šç”¨äºåˆ›å»ºç­‰å¾…é˜Ÿåˆ—ï¼Œ`name`ä¸ºé˜Ÿåˆ—åç§°ï¼Œ`tsk`ä¸ºé˜Ÿåˆ—æ‰€å¯¹åº”çš„è¿›ç¨‹ï¼Œä¸€èˆ¬ä½¿ç”¨`current`ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹\n- `add_wait_queue(wait_queue_head_t *q, wait_queue_t *wait)`ï¼š`q`ä¸ºç­‰å¾…é˜Ÿåˆ—è¦åŠ å…¥çš„ç­‰å¾…é˜Ÿåˆ—å¤´ï¼Œ`wait`ä¸ºè¦åŠ å…¥çš„ç­‰å¾…é˜Ÿåˆ—é¡¹\n\n3. è®¾å®šå”¤é†’æ¡ä»¶ï¼ˆä»¥æŒ‰é”®ä¸ºä¾‹ï¼‰\n```\n    /* å”¤é†’è¿›ç¨‹ */\n    if(atomic_read(&dev->releasekey)){  /* å®Œæˆä¸€æ¬¡æŒ‰é”®è¿‡ç¨‹ */\n        wake_up_interruptible(&dev->r_wait);\n    }\n```\næ­¤å¤„å¯é€‰`wake_up()`å’Œ`wake_up_interruptible()`ï¼š\n- `wake_up()`ä¼šå”¤é†’æ‰€æœ‰åœ¨`r_wait`æ‰€å±é˜Ÿåˆ—ä¸­ç­‰å¾…çš„è¿›ç¨‹\n- `wake_up_interruptible`ä»…å”¤é†’ä¸€ä¸ªå¤„äº`TASK_INTERRUPTIBLE`çŠ¶æ€çš„è¿›ç¨‹\n\nå”¤é†’åï¼Œè¿›ç¨‹å°†åœ¨è¢«è°ƒåº¦å™¨é€‰æ‹©åä»`schedule()`ä½ç½®å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚\n\n### â€œä¿¡å·â€\nä¸ŠèŠ‚æåˆ°åœ¨`wake_up_interruptible()`ä¸‹ç¡çœ ä¸­çš„è¿›ç¨‹ä¼šè¢«ä¿¡å·å”¤é†’ã€‚ä¿¡å·æ˜¯Linuxçš„å¼‚æ­¥è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œç”¨äºé€šçŸ¥è¿›ç¨‹å‘ç”Ÿäº†æŸç§äº‹ä»¶ï¼Œæ¯”å¦‚ç”¨æˆ·æŒ‰ä¸‹ Ctrl + C ç»ˆæ­¢è¿›ç¨‹ï¼Œæˆ–è€…è¿›ç¨‹è¯•å›¾è®¿é—®éæ³•å†…å­˜åœ°å€å¯¼è‡´æ®µé”™è¯¯ï¼ˆSIGSEGVï¼‰ã€‚\n\n| ä¿¡å·ç¼–å· | ä¿¡å·åç§°  | æè¿°                         | é»˜è®¤å¤„ç†æ–¹å¼ |\n|---------|---------|----------------------------|------------|\n| `1`     | `SIGHUP`  | ç»ˆç«¯æŒ‚èµ·ï¼ˆç”¨æˆ·é€€å‡º shellï¼‰    | ç»ˆæ­¢       |\n| `2`     | `SIGINT`  | ç”¨æˆ·ç»ˆæ­¢è¿›ç¨‹ï¼ˆCtrl + Cï¼‰     | ç»ˆæ­¢       |\n| `9`     | `SIGKILL` | ç«‹å³ç»ˆæ­¢è¿›ç¨‹ï¼ˆä¸èƒ½è¢«æ•è·æˆ–å¿½ç•¥ï¼‰ | ç»ˆæ­¢       |\n| `11`    | `SIGSEGV` | æ®µé”™è¯¯ï¼ˆéæ³•è®¿é—®å†…å­˜ï¼‰       | ç»ˆæ­¢       |\n| `15`    | `SIGTERM` | ç»ˆæ­¢è¿›ç¨‹ï¼ˆé»˜è®¤ `kill` å‘é€ï¼‰ | ç»ˆæ­¢       |\n| `17`    | `SIGCHLD` | å­è¿›ç¨‹ç»“æŸ                  | å¿½ç•¥       |\n\nå¦‚æœå¤„äº`TASK_INTERRUPTIBLE`çŠ¶æ€ä¸‹çš„è¿›ç¨‹æ¥æ”¶åˆ°ä¿¡å·ï¼Œå…¶ä¼šæå‰è¿”å›å¹¶å”¤é†’ç¡çœ ä¸­çš„è¿›ç¨‹ã€‚åœ¨ç¡çœ çŠ¶æ€è¢«ä¿¡å·ä¸­æ–­çš„è¿›ç¨‹é€šå¸¸ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ä¿¡å·éœ€è¦å¤„ç†ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æå‰è¿”å›ï¼Œé¿å…æ— é™ç­‰å¾…ã€‚\n\n## éé˜»å¡IO\néé˜»å¡æ¨¡å¼ä¸‹è‹¥è®¾å¤‡ä¸å¯ç”¨æˆ–æ•°æ®æœªå‡†å¤‡å¥½æ—¶ï¼Œè®¾å¤‡ä¼šå‘kernelè¿”å›é”™è¯¯ç ã€‚åº”ç”¨ç¨‹åºä¼šé‡æ–°è¯»å–æ•°æ®ï¼ˆæˆ–æ‰§è¡Œå…¶ä»–æ“ä½œï¼‰ï¼Œå¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°æ•°æ®è¯»å–æˆåŠŸã€‚\n\néé˜»å¡æ¨¡å¼ä¸‹è¯»å–æ•°æ®æ—¶ï¼Œéœ€è¦ä¿®æ”¹æ‰“å¼€æ–‡ä»¶çš„æ–¹å¼ï¼š\n```\nfd = open(\"/dev/xxx_dev\", O_RDWR | O_NONBLOCK);\n```\n`O_NONBLOCK`è¡¨ç¤ºä½¿ç”¨éé˜»å¡æ¨¡å¼ã€‚\n\n### è½®è¯¢\n#### Select\n```\nint select(int nfds, \n           fd_set *readfds, \n           fd_set *writefds,\n           fd_set *exceptfds, \n           struct timeval *timeout)\n```\n- `nfds`ï¼šç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚å®ƒæ˜¯æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸­æœ€å¤§å€¼åŠ  1ã€‚å³ï¼Œnfds = max(fd1, fd2, ..., fdN) + 1ã€‚\n- `readfds`ï¼šå¾…æ£€æµ‹æ˜¯å¦å¯è¯»çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚ç”¨ FD_SET() å®æ·»åŠ æ–‡ä»¶æè¿°ç¬¦ï¼ŒFD_ZERO() åˆå§‹åŒ–ä¸ºç©ºã€‚\n- `writefds`ï¼šå¾…æ£€æµ‹æ˜¯å¦å¯å†™çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆ\n- `exceptfds`ï¼šå¾…æ£€æµ‹æ˜¯å¦å‘ç”Ÿå¼‚å¸¸çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆ\n- `timeout`ï¼šæŒ‡å®šç­‰å¾…æ—¶é—´çš„ç»“æ„ä½“ã€‚å¦‚æœä¸º NULLï¼Œåˆ™ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿï¼›å¦‚æœä¸ºé›¶ï¼ˆtimeout = {0, 0}ï¼‰ï¼Œåˆ™éé˜»å¡åœ°è¿”å›\n- è¿”å›å€¼ï¼šå¯æ“ä½œæ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°\n\n`readfds`ã€`writefds`å’Œ`exceptfds`éƒ½ä¸º`fd_set`ç±»å‹ï¼ŒæŒ‡å‘æè¿°ç¬¦é›†åˆï¼Œç”¨äºæŒ‡æ˜å…³å¿ƒå“ªäº›æè¿°ç¬¦ï¼Œä»¥åŠæè¿°ç¬¦éœ€è¦æ»¡è¶³çš„æ¡ä»¶ã€‚`readfds`è´Ÿè´£ç›‘è§†æŒ‡å®šæè¿°ç¬¦é›†çš„è¯»å˜åŒ–ï¼Œå³ç›‘è§†è¿™äº›æ–‡ä»¶æ˜¯å¦å¯è¯»å–ï¼Œåªè¦è¿™äº›é›†åˆä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¢«è¯»å–ï¼Œselectå°±ä¼šè¿”å›å¤§äº0çš„å€¼è¡¨ç¤ºæ–‡ä»¶å¯è¯»å–ã€‚è‹¥æ²¡æœ‰æ–‡ä»¶å¯è¯»å–ï¼Œåˆ™æ ¹æ®`timeout`åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚`readfds`å¯ä»¥è®¾ç½®ä¸ºNULLï¼Œè¡¨ç¤ºä¸å…³å¿ƒæ–‡ä»¶çš„å¯è¯»æ€§å˜åŒ–ã€‚`writefds`å’Œ`exceptfds`çš„ç”¨æ³•ä¹Ÿç±»ä¼¼ã€‚\n\nå¦‚æœè¦ä»ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ª`fd_set`å˜é‡ï¼Œç”¨äºä¼ é€’ç»™`readfds`ã€‚`fd_set`å¯ä»¥é€šè¿‡è¿™å‡ ä¸ªå®è¿›è¡Œæ“ä½œï¼š\n```\nvoid FD_ZERO(fd_set *set)           /* æ¸…é›¶fd_setçš„æ‰€æœ‰ä½ */\nvoid FD_SET(int fd, fd_set *set)    /* å°†fd_setæŸä¸ªä½ç½®1 */\nvoid FD_CLR(int fd, fd_set *set)    /* å°†fd_setæŸä¸ªä½ç½®0ï¼ˆåˆ é™¤æŸä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼‰ */\nint FD_ISSET(int fd, fd_set *set)   /* æµ‹è¯•ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å±äºæŸä¸ªé›†åˆ */\n```\n\nä½¿ç”¨selectå¯¹æŸä¸ªè®¾å¤‡é©±åŠ¨æ–‡ä»¶è¿›è¡Œéé˜»å¡è®¿é—®çš„ç¤ºä¾‹ï¼š\n```\nvoid main(void)\n{\n    int ret, fd;            //è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦\n    fd_set readfds;         //è¯»æ“ä½œæ–‡ä»¶æè¿°ç¬¦é›†\n    struct timeval timeout; //è¶…æ—¶ç»“æ„ä½“\n\n    fd = open(\"dev_xxx\", O_RDWR | O_NONBLOCK);  //éé˜»å¡è®¿é—®\n\n    FD_ZERO(&readfds);      //æ¸…é™¤readfs\n    FD_SET(fd, &readfds);   //å°†fdæ·»åŠ è‡³readfds\n\n    timeout.tv_sec = 0\n    timeout.tv_usec = 500000;\n\n    ret = select(fd + 1, &readfds, NULL, NULL, &timeout);   //ä»…ç›‘æµ‹æ–‡ä»¶æ˜¯å¦å¯è¯»\n    switch (ret)\n    {\n        case 0:                     //è¶…æ—¶\n            printf(\"timeout\\r\\n\");\n            break;\n        case -1:                    //é”™è¯¯\n            printf(\"error\\r\\n\");\n            break;\n        default:                    //å¯è¯»å–æ•°æ®\n            if (FD_ISSET(fd, &readfds)){    //åˆ¤æ–­æ˜¯å¦ä¸ºfdæ–‡ä»¶æè¿°ç¬¦\n                //ç”¨readå‡½æ•°è¯»å–æ•°æ®\n            }\n            break;\n    }\n}\n```\n\n#### poll\n```\nint poll(struct pollfd *fds, \n         nfds_t nfds, \n         int timeout)\n```\n`fds`ï¼šå¾…ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆä»¥åŠè¦ç›‘è§†çš„äº‹ä»¶ï¼Œæ•°ç»„å…ƒç´ ä¸º`pollfd`ç±»å‹ï¼š\n```\nstruct pollfd {\n    int     fd;         //æ–‡ä»¶æè¿°ç¬¦\n    short   events;     //è¯·æ±‚çš„äº‹ä»¶\n    short   revents;    //è¿”å›çš„äº‹ä»¶\n}\n```\neventsä¸ºå¾…ç›‘è§†äº‹ä»¶ï¼ŒåŒ…å«ï¼š\n```\nPOLLIN æœ‰æ•°æ®å¯ä»¥è¯»å–ã€‚\nPOLLPRI æœ‰ç´§æ€¥çš„æ•°æ®éœ€è¦è¯»å–ã€‚\nPOLLOUT å¯ä»¥å†™æ•°æ®ã€‚\nPOLLERR æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚\nPOLLHUP æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æŒ‚èµ·ã€‚\nPOLLNVAL æ— æ•ˆçš„è¯·æ±‚ã€‚\nPOLLRDNORM ç­‰åŒäº POLLIN\n```\n`nfds`ï¼špollå‡½æ•°è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡\n`timeout`ï¼šè¶…æ—¶æ—¶é—´\n\npollå‡½æ•°ä½¿ç”¨ç¤ºä¾‹:\n```\nvoid main(void)\n{\n    int ret, fd;            //è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦\n    struct pollfd fds;\n\n    fd = open(\"dev_xxx\", O_RDWR | O_NONBLOCK);  //éé˜»å¡è®¿é—®\n\n    fds.fd = fd;\n    fds.event = POLLIN;     //ç›‘è§†æ–‡ä»¶æ˜¯å¦å¯ä»¥è¯»å–\n\n    ret = poll(&fds, 1, 500);   //è½®è¯¢æ–‡ä»¶æ˜¯å¦å¯æ“ä½œï¼Œè¶…æ—¶æ—¶é—´500ms\n    if (ret){               //å¯è¯»å–\n        ...\n    }else if (ret == 0){    //è¶…æ—¶\n        ...\n    }else if (ret < 0){     //é”™è¯¯\n        ...\n    }\n}\n```\né©±åŠ¨ç¨‹åºï¼š\n```\nunsigned int imx6uirq_poll(struct file *filp, struct poll_table_struct *wait)\n{\n    unsigned int mask = 0;\n    struct imx6uirq_dev *dev = (struct imx6uirq_dev *)filp->private_data;\n\n    poll_wait(filp, &dev->r_wait, wait);    //æŒ‚è½½é©±åŠ¨è‡³ç­‰å¾…é˜Ÿåˆ—\n\n    if (atomic_read(&dev->releasekey)){\n        mask = POLLIN | POLLRDNORM;         //è¿”å›ï¼Œå‘ŠçŸ¥æœ‰æ•°æ®å¯è¯»\n    }\n\n    return mask;\n}\n\nstatic struct file_operations imx6uirq_fops = {\n    .owner = THIS_MODULE,\n    .open = imx6uirq_open,\n    .read = imx6uirq_read,\n    .poll = imx6uirq_poll,      //ç»‘å®špollè‡³fops\n};\n```\n\n#### epoll\nepollä¸»è¦è§£å†³å¤§å¹¶å‘é—®é¢˜ï¼Œç”¨äºè§£å†³ä¼ ç»Ÿçš„selectå’Œpollä¼šéšç€ç›‘å¬fdæ•°é‡å¢åŠ è€Œå‡ºç°æ•ˆç‡ä½ä¸‹çš„é—®é¢˜ã€‚\n\nä½¿ç”¨epollå‰åº”ç”¨ç¨‹åºè¦å…ˆç”¨`epoll_create`åˆ›å»ºä¸€ä¸ªepollå¥æŸ„ï¼š\n```\nint epoll_create(int size)\n\nreturn:\nepollå¥æŸ„ï¼Œ-1è¡¨ç¤ºåˆ›å»ºå¤±è´¥\n```\nå¥æŸ„åˆ›å»ºå®Œæˆåï¼Œç”¨`epoll_ctl`å‘å…¶ä¸­è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ä»¥åŠç›‘è§†çš„äº‹ä»¶ï¼š\n```\nint epoll_ctl(int   epfd,\n              int   op,\n              int   fd,\n              struct epoll_event *event)\n\nepfdï¼šè¦æ“ä½œçš„ epoll å¥æŸ„\n\nopï¼šè¡¨ç¤ºè¦å¯¹ epfd(epoll å¥æŸ„)è¿›è¡Œçš„æ“ä½œï¼Œå¯ä»¥è®¾ç½®ä¸ºï¼š\nEPOLL_CTL_ADD å‘ epfd æ·»åŠ æ–‡ä»¶å‚æ•° fd è¡¨ç¤ºçš„æè¿°ç¬¦ã€‚\nEPOLL_CTL_MOD ä¿®æ”¹å‚æ•° fd çš„ event äº‹ä»¶ã€‚\nEPOLL_CTL_DEL ä» epfd ä¸­åˆ é™¤ fd æè¿°ç¬¦ã€‚\n\nfdï¼šè¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ã€‚\n\neventï¼šè¦ç›‘è§†çš„äº‹ä»¶ç±»å‹ï¼Œä¸º epoll_event ç»“æ„ä½“ç±»å‹æŒ‡é’ˆï¼š\n\nstruct epoll_event {\n        uint32_t events;   /* epoll äº‹ä»¶ */\n        epoll_data_t data; /* ç”¨æˆ·æ•°æ® */\n};\n\neventsè¡¨ç¤ºè¦ç›‘è§†çš„äº‹ä»¶ï¼Œå¯é€‰ï¼š\nEPOLLIN æœ‰æ•°æ®å¯ä»¥è¯»å–ã€‚\nEPOLLOUT å¯ä»¥å†™æ•°æ®ã€‚\nEPOLLPRI æœ‰ç´§æ€¥çš„æ•°æ®éœ€è¦è¯»å–ã€‚\nEPOLLERR æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚\nEPOLLHUP æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æŒ‚èµ·ã€‚\nEPOLLET è®¾ç½® epoll ä¸ºè¾¹æ²¿è§¦å‘ï¼Œé»˜è®¤è§¦å‘æ¨¡å¼ä¸ºæ°´å¹³è§¦å‘ã€‚\nEPOLLONESHOT ä¸€æ¬¡æ€§çš„ç›‘è§†ï¼Œå½“ç›‘è§†å®Œæˆä»¥åè¿˜éœ€è¦å†æ¬¡ç›‘è§†æŸä¸ª fdï¼Œé‚£ä¹ˆå°±éœ€è¦å°†\nfd é‡æ–°æ·»åŠ åˆ° epoll é‡Œé¢ã€‚\n```\nè®¾ç½®å®Œæˆåï¼Œè°ƒç”¨`epoll_wait()`ç­‰å¾…äº‹ä»¶å‘ç”Ÿï¼š\n```\nint epoll_wait(int epfd,                    //è¦ç­‰å¾…çš„poll\n               struct epoll_event *events,  //æŒ‡å‘epoll_eventç»“æ„ä½“çš„æ•°ç»„\n               int maxevents,               //eventsæ•°ç»„å¤§å°\n               int timeout)                 //è¶…æ—¶æ—¶é—´ï¼Œms\n```","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"Linuxä¸­æ–­æœºåˆ¶","url":"/2025/03/26/Linuxä¸­æ–­æœºåˆ¶/","content":"## è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯èŠ‚ç‚¹\nIMX6ULLå’ŒIMX6ULçš„ä¸­æ–­æ§åˆ¶å™¨å‘ˆå…¼å®¹å…³ç³»ï¼Œå³IMX6ULLç»§æ‰¿IMX6ULçš„GICèŠ‚ç‚¹ä¿¡æ¯ã€‚åœ¨`imx6ul.dtsi`ä¸­æœ‰ï¼š\n```\n\tintc: interrupt-controller@a01000 {\n\t\tcompatible = \"arm,gic-400\", \"arm,cortex-a7-gic\";\n        /* GIC_PPIï¼šç§æœ‰å¤–è®¾ä¸­æ–­ï¼Œéå…±äº«\n           9:ä¸­æ–­å·ä¸º9\n           GIC_CPU_MASK_SIMPLE(1):PPIåªå‘é€ç»™CPU0å¤„ç†\n           IRQ_TYPE_LEVEL_HIGHï¼šç”µå¹³è§¦å‘ï¼Œé«˜ç”µå¹³æœ‰æ•ˆ */\n\t\tinterrupts = <GIC_PPI 9 (GIC_CPU_MASK_SIMPLE(1) | IRQ_TYPE_LEVEL_HIGH)>;\n        /* ä¸­æ–­æè¿°éœ€3ä¸ªå•å…ƒ */\n\t\t#interrupt-cells = <3>;\n        /* å£°æ˜èŠ‚ç‚¹ä¸ºä¸­æ–­æ§åˆ¶å™¨ */\n\t\tinterrupt-controller;\n        /* çˆ¶ç±»ä¸ºè‡ªèº«ï¼Œè¯´æ˜æ˜¯é¡¶çº§GIC */\n\t\tinterrupt-parent = <&intc>;\n        /* GICå¯„å­˜å™¨åŸºåœ°å€å’Œå¤§å° */\n\t\treg = <0x00a01000 0x1000>,  /* GICåˆ†å‘å™¨åŸºåœ°å€ */\n\t\t\t  <0x00a02000 0x2000>,  /* GIC CPUæ¥å£åŸºåœ°å€ */\n\t\t\t  <0x00a04000 0x2000>,  /* GICè™šæ‹ŸCPUæ¥å£ */\n\t\t\t  <0x00a06000 0x2000>;  /* GICè™šæ‹Ÿåˆ†å‘å™¨ */\n\t};\n```\nè¿™é‡Œçš„`interrupt-cells`é€šå¸¸æ ¼å¼ä¸º`<ä¸­æ–­ç±»å‹ ä¸­æ–­å· æ ‡å¿—ä½>`æˆ–`<ä¸­æ–­å· æ ‡å¿—ä½>`ï¼Œå…¶ä¸­\n- ä¸­æ–­ç±»å‹ï¼š\n    + `0`ï¼šSPIï¼Œå…±äº«å¤–è®¾ä¸­æ–­\n    + `1`ï¼šPPIï¼Œç§æœ‰å¤–è®¾ä¸­æ–­\n- ä¸­æ–­å·ï¼šè®¾å¤‡ä¸­æ–­IDï¼ŒSPIä¸­æ–­å·èŒƒå›´ä¸º0~987ï¼ŒPPIä¸­æ–­å·èŒƒå›´ä¸º0~15\n- æ ‡å¿—ä½ï¼š\n    + `IRQ_TYPE_NONE`ï¼šKernelä¸å‚ä¸è®¾ç½®ï¼Œè·Ÿéšuboot\n\t+ `IRQ_TYPE_EDGE_RISING`ï¼šä¸Šå‡æ²¿è§¦å‘\n\t+ `IRQ_TYPE_EDGE_FALLING`ï¼šä¸‹é™æ²¿è§¦å‘\n\t+ `IRQ_TYPE_EDGE_BOTH `ï¼šåŒè¾¹æ²¿è§¦å‘\n\t+ `IRQ_TYPE_LEVEL_HIGH`ï¼šé«˜ç”µå¹³è§¦å‘\n\t+ `IRQ_TYPE_LEVEL_LOW`ï¼šä½ç”µå¹³è§¦å‘\n\nGPIOä¹Ÿå¯ä»¥ä½œä¸ºGICï¼š\n```\ngpio5: gpio@20ac000 {\n\t\tcompatible = \"fsl,imx6ul-gpio\", \"fsl,imx35-gpio\";\n\t\treg = <0x020ac000 0x4000>;\n        /* å…±äº«ä¸­æ–­ï¼Œä¸­æ–­å·74ï¼Œé«˜ç”µå¹³è§¦å‘\n           å…±äº«ä¸­æ–­ï¼Œä¸­æ–­å·75ï¼Œé«˜ç”µå¹³è§¦å‘ */\n\t\tinterrupts = <GIC_SPI 74 IRQ_TYPE_LEVEL_HIGH>,\n\t\t\t\t\t <GIC_SPI 75 IRQ_TYPE_LEVEL_HIGH>;\n\t\tclocks = <&clks IMX6UL_CLK_GPIO5>;\n\t\tgpio-controller;\n\t\t#gpio-cells = <2>;\n\t\tinterrupt-controller;   /* å£°æ˜ä¸ºä¸­æ–­æ§åˆ¶å™¨ */\n\t\tgpio-ranges = <&iomuxc 0 7 10>, <&iomuxc 10 5 2>;\n}\n```\n\nä¸­æ–­éœ€è¦åœ¨èŠ‚ç‚¹ä¸­é…ç½®ï¼Œå¦‚`imx6ul-14x14-evk.dtsi`ä¸­`i2c1`èŠ‚ç‚¹ä¸‹çš„ï¼š\n```\n\tfxls8471@1e {\n\t\tcompatible = \"fsl,fxls8471\";\n\t\treg = <0x1e>;\n\t\tposition = <0>;\n\t\tinterrupt-parent = <&gpio5>;    /* GICä¸ºGPIO5 */\n\t\tinterrupts = <0 8>; /* ä¸­æ–­å·ä¸º0ï¼Œä½ç”µå¹³è§¦å‘ */\n\t};\n```\n\nç®€å•æ¥è¯´ï¼Œè®¾å¤‡æ ‘èŠ‚ç‚¹ä¸­æè¿°ä¸­æ–­çš„ä¿¡æ¯æœ‰ï¼š\n- `#interrupt-cells`ï¼šä¸­æ–­æºcellä¸ªæ•°\n- `interrupt-controller`ï¼šå£°æ˜å½“å‰èŠ‚ç‚¹ä¸ºä¸­æ–­æ§åˆ¶å™¨\n- `interrupts`ï¼šæŒ‡å®šä¸­æ–­å·å’Œä¸­æ–­è§¦å‘æ¨¡å¼\n- `interrupt-parent`ï¼šçˆ¶ä¸­æ–­(GIC)\n\n## ç”¨æ³•\n1. ä¿®æ”¹è®¾å¤‡æ ‘\n2. è®¾å¤‡ç»“æ„ä½“ä¸­å£°æ˜`irqreturn_t (*handler)(int, void *)`(ä¹Ÿå¯ä»¥ä¸å£°æ˜)å’Œ`int irqnum`(å­˜æ”¾ä¸­æ–­å·)\n3. é€šè¿‡`irq_of_parse_and_map`å‘è®¾å¤‡æ ‘ç”³è¯·ä¸­æ–­ä¿¡æ¯\n```\nunsigned int irq_of_parse_and_map(struct device_node *node, int index);\n```\nè¯¥å‡½æ•°è¿”å›ç”³è¯·åˆ°çš„ä¸­æ–­å·ã€‚\n4. åˆå§‹åŒ–æ—¶å‘kernelç”³è¯·ä¸­æ–­ï¼š\n```\nrequest_irq(unsigned int irq, irq_handler_t handler, unsigned long flags,\n\t    const char *name, void *dev)\n```\n- `irq`ï¼šä¸­æ–­å·\n- `handler`ï¼šä¸­æ–­æœåŠ¡å‡½æ•°\n- `flags`ï¼šæ ‡å¿—ä½ï¼Œå¯é€‰ï¼š\n```\n#define IRQF_TRIGGER_NONE\t0x00000000\n#define IRQF_TRIGGER_RISING\t0x00000001\n#define IRQF_TRIGGER_FALLING\t0x00000002\n#define IRQF_TRIGGER_HIGH\t0x00000004\n#define IRQF_TRIGGER_LOW\t0x00000008\n#define IRQF_TRIGGER_MASK\t(IRQF_TRIGGER_HIGH | IRQF_TRIGGER_LOW | \\\n\t\t\t\t IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING)\n#define IRQF_TRIGGER_PROBE\t0x00000010\n```\n- `*name`ï¼šç”Ÿæˆä¸­æ–­çš„è®¾å¤‡å\n- `*dev`ï¼šCookieï¼Œä¼ é€’è®¾å¤‡ç»“æ„ä½“åœ°å€\n5. è®¾å¤‡æ³¨é”€æ—¶é‡Šæ”¾ä¸­æ–­ï¼š\n```\nvoid *free_irq(unsigned int irq, void *dev);\n```\n- `irq`ï¼šä¸­æ–­å·\n- `*dev`ï¼šCookieï¼Œä¼ é€’è®¾å¤‡ç»“æ„ä½“åœ°å€\n\n## ä¾‹ç¨‹\n```\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/libata.h>   /* æ–°ç‰ˆkernelä¸å†æ”¯æŒide.h */\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/gpio.h>\n#include <linux/cdev.h>\n#include <linux/device.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_gpio.h>\n#include <asm/mach/map.h>\n#include <asm/uaccess.h>\n#include <asm/io.h>\n#include <linux/semaphore.h>\n#include <linux/timer.h>\n#include <linux/of_irq.h>\n#include <linux/irq.h>\n\n#define IMX6UIRQ_CNT         1\n#define IMX6UIRQ_NAME   \"imx6uirq\"\n#define KEY0VALUE       0x01\n#define INVAKEY         0xFF\n#define KEY_NUM         1\n\nstruct irq_keydesc {\n    int gpio;\n    int irqnum;             /* ä¸­æ–­å· */\n    unsigned char value;    /* æŒ‰é”®å¯¹åº”çš„é”®å€¼ */\n    char name[10];          \n    irqreturn_t (*handler)(int, void *);    /* ä¸­æ–­æœåŠ¡å‡½æ•° */\n};\n\nstruct irq_led {\n    int gpio;\n};\n\nstruct imx6uirq_dev {\n    dev_t devid;\n    struct cdev cdev;\n    struct class *class;\n    struct device *device;\n    int major;\n    int minor;\n    struct device_node *nd;\n    atomic_t keyvalue;      /* æœ‰æ•ˆæŒ‰é”®é”®å€¼ */\n    atomic_t releasekey;    /* æ ‡è®°æ˜¯å¦å®Œæˆä¸€æ¬¡æŒ‰é”® */\n    struct timer_list timer;\n    struct irq_keydesc irqkeydesc; /* æŒ‰é”®æè¿°ç»“æ„ä½“ */\n    struct irq_led irqled;\n};\n\nstruct imx6uirq_dev imx6uirq;\n\n/* IRQæœåŠ¡å‡½æ•°ï¼Œå»¶æ—¶10msï¼Œæ¶ˆæŠ– */\nstatic irqreturn_t key0_handler(int irq, void *dev_id)\n{\n    struct imx6uirq_dev *dev = (struct imx6uirq_dev *)dev_id;\n\n    mod_timer(&dev->timer, jiffies + msecs_to_jiffies(10)); /* å»¶æ—¶10msï¼Œæ¶ˆæŠ– */\n    return IRQ_RETVAL(IRQ_HANDLED);\n}\n\n/* å®šæ—¶å™¨æœåŠ¡å‡½æ•°ï¼Œåˆ°æœŸåå†æ¬¡è¯»å–æŒ‰é”®å€¼ï¼Œå¦‚æœè¿˜æ˜¯æŒ‰ä¸‹è¡¨ç¤ºæŒ‰é”®æœ‰æ•ˆ */\nvoid timer_function(struct timer_list *t)\n{\n    unsigned char value;\n    struct irq_keydesc *keydesc;\n    struct imx6uirq_dev *dev = from_timer(dev, t, timer);\n\n    keydesc = &dev->irqkeydesc;\n\n    value = gpio_get_value(keydesc->gpio);  /* è¯»å–IOç”µå¹³ */\n    if (value == 0){    /* å¦‚æœæŒ‰ä¸‹ */\n        int sta = gpio_get_value(dev->irqled.gpio);\n        gpio_set_value(dev->irqled.gpio, !sta);\n        atomic_set(&dev->keyvalue, keydesc->value);\n    }else{      /* å¦‚æœæ¾å¼€ */\n        atomic_set(&dev->keyvalue, 0x80 | keydesc->value);\n        atomic_set(&dev->releasekey, 1);    /* æ ‡è®°æ¾å¼€æŒ‰é”® */\n    }\n}\n\nstatic int keyio_init(void)\n{\n    int ret = 0;\n\n    imx6uirq.nd = of_find_node_by_path(\"/key\");\n    if (imx6uirq.nd == NULL){\n        printk(\"find node failed\\r\\n\");\n        return -EINVAL;\n    }\n\n    imx6uirq.irqkeydesc.gpio = of_get_named_gpio(imx6uirq.nd, \"key-gpio\", 0);\n    if (imx6uirq.irqkeydesc.gpio < 0){\n        printk(\"unable get key gpio\\r\\n\");\n        return -EINVAL;\n    }\n\n    imx6uirq.irqled.gpio = of_get_named_gpio(imx6uirq.nd, \"led-gpio\", 0);\n    if (imx6uirq.irqled.gpio < 0){\n        printk(\"unable get led gpio\\r\\n\");\n        return -EINVAL;\n    }\n\n    sprintf(imx6uirq.irqkeydesc.name, \"KEY0\");\n    gpio_request(imx6uirq.irqkeydesc.gpio, imx6uirq.irqkeydesc.name);\n    ret = gpio_direction_input(imx6uirq.irqkeydesc.gpio);\n    if (ret < 0){\n        printk(\"unable set key pin level\\r\\n\");\n        return ret;\n    }\n    imx6uirq.irqkeydesc.irqnum = irq_of_parse_and_map(imx6uirq.nd, 0);\n    printk(\"key0: gpio = %d, irqnum = %d\\r\\n\", imx6uirq.irqkeydesc.gpio, imx6uirq.irqkeydesc.irqnum);\n\n    gpio_request(imx6uirq.irqled.gpio, \"LED\");\n    ret = gpio_direction_output(imx6uirq.irqled.gpio, 1);\n    if (ret < 0){\n        printk(\"unable set led pin level\\r\\n\");\n        return ret;\n    }\n\n    imx6uirq.irqkeydesc.handler = key0_handler;\n    imx6uirq.irqkeydesc.value = KEY0VALUE;\n\n    ret = request_irq(imx6uirq.irqkeydesc.irqnum, imx6uirq.irqkeydesc.handler, IRQF_TRIGGER_FALLING|IRQF_TRIGGER_RISING, imx6uirq.irqkeydesc.name, &imx6uirq);\n\n    if (ret < 0){\n        printk(\"IRQ request failed, error code: %d\\r\\n\", ret);\n    }\n\n    timer_setup(&imx6uirq.timer, timer_function, 0);\n\n    return 0;\n}\n\nstatic int imx6uirq_open(struct inode *inode, struct file *filp)\n{\n    filp->private_data = &imx6uirq;\n    return 0;\n}\n\nstatic ssize_t imx6uirq_read(struct file *filp, char __user *buf, size_t cnt, loff_t *offt)\n{\n    int ret = 0;\n    unsigned char keyvalue = 0;\n    unsigned char releasekey = 0;\n    struct imx6uirq_dev *dev = (struct imx6uirq_dev *)filp->private_data;\n\n    keyvalue = atomic_read(&dev->keyvalue);\n    releasekey = atomic_read(&dev->releasekey);\n\n    if (releasekey){\n        if (keyvalue & 0x80){\n            keyvalue &= ~(0x80);\n            ret = copy_to_user(buf, &keyvalue, sizeof(keyvalue));\n        }else{\n            goto data_error;\n        }\n        atomic_set(&dev->releasekey, 0);\n    }else{\n        goto data_error;\n    }\n    return 0;\n\ndata_error:\n    return -EINVAL;\n}\n\nstatic struct file_operations imx6uirq_fops = {\n    .owner = THIS_MODULE,\n    .open = imx6uirq_open,\n    .read = imx6uirq_read,\n};\n\nstatic int __init imx6uirq_init(void)\n{\n    if (imx6uirq.major){\n        imx6uirq.devid = MKDEV(imx6uirq.major, 0);\n        register_chrdev_region(imx6uirq.devid, IMX6UIRQ_CNT, IMX6UIRQ_NAME);\n    }else{\n        alloc_chrdev_region(&imx6uirq.devid, 0, IMX6UIRQ_CNT, IMX6UIRQ_NAME);\n        imx6uirq.major = MAJOR(imx6uirq.devid);\n        imx6uirq.minor = MINOR(imx6uirq.devid);\n    }\n    printk(\"KEY reg ok, major = %d, minor = %d\\r\\n\", imx6uirq.major, imx6uirq.minor);\n\n    cdev_init(&imx6uirq.cdev, &imx6uirq_fops);\n    cdev_add(&imx6uirq.cdev, imx6uirq.devid, IMX6UIRQ_CNT);\n\n    imx6uirq.class = class_create(IMX6UIRQ_NAME);\n    if (IS_ERR(imx6uirq.class)){\n        return PTR_ERR(imx6uirq.class);\n    }\n\n    imx6uirq.device = device_create(imx6uirq.class, NULL, imx6uirq.devid, NULL, IMX6UIRQ_NAME);\n    if (IS_ERR(imx6uirq.device)){\n        return PTR_ERR(imx6uirq.device);\n    }\n\n    atomic_set(&imx6uirq.keyvalue, INVAKEY);\n    atomic_set(&imx6uirq.releasekey, 0);\n    keyio_init();\n\n    return 0;\n}\n\nstatic void __exit imx6uirq_exit(void)\n{\n    del_timer_sync(&imx6uirq.timer);\n\n    free_irq(imx6uirq.irqkeydesc.irqnum, &imx6uirq);\n    gpio_free(imx6uirq.irqkeydesc.gpio);\n\n    cdev_del(&imx6uirq.cdev);\n    unregister_chrdev_region(imx6uirq.devid, IMX6UIRQ_CNT);\n    device_destroy(imx6uirq.class, imx6uirq.devid);\n    class_destroy(imx6uirq.class);\n}\n\nmodule_init(imx6uirq_init);\nmodule_exit(imx6uirq_exit);\nMODULE_LICENSE(\"GPL\");\n```\n\n","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"Linuxå†…æ ¸å®šæ—¶å™¨","url":"/2025/03/26/Linuxå†…æ ¸å®šæ—¶å™¨/","content":"æ–°ç‰ˆæœ¬Kernelä¸‹å®šæ—¶å™¨APIå¾—åˆ°äº†æ¯”è¾ƒå¥½çš„ä¼˜åŒ–ï¼Œä»¥æ­£ç‚¹åŸå­é˜¿å°”æ³•åŸºäº4.4ç‰ˆæœ¬kernelçš„æ—§ç‰ˆAPIä¸ºä¾‹åšå¯¹æ¯”ï¼š\n## å®šæ—¶å™¨å›è°ƒå‡½æ•°ï¼š\n### æ—§ç‰ˆï¼š\n```\nvoid timer_function(unsigned long arg)\n {\n struct timer_dev *dev = (struct timer_dev *)arg;\n static int sta = 1;\n\n /* ....... */\n\n }\n```\n### æ–°ç‰ˆï¼š\n```\nvoid timer_function(struct timer_list *t)\n{\n\tstruct timer_dev *dev = from_timer(dev, t, timer);\t/* ä»å®šæ—¶å™¨å®ä¾‹è·å–çˆ¶çº§ç»“æ„ä½“ */\n\tstatic int sta = 1;\n\n /* ....... */\n}\n```\næ–°ç‰ˆå®šæ—¶å™¨å›è°ƒå‡½æ•°å½¢å‚ç›´æ¥ä¸ºtimer_listå®ä¾‹ï¼Œè€Œå®šæ—¶å™¨çˆ¶çº§ç»“æ„ä½“ä¸å†é€šè¿‡`arg`è·å–ï¼Œkernelæä¾›äº†`from_timer`å‡½æ•°ï¼š\n```\n#define from_timer(var, callback_timer, timer_fieldname) \\\n\tcontainer_of(callback_timer, typeof(*var), timer_fieldname)\n```\nè¿™ä¸ªå®è‡ª`container_of()`æ‰©å±•è€Œæ¥ï¼š\n```\n/**\n * container_of - cast a member of a structure out to the containing structure\n * @ptr:\tthe pointer to the member.\n * @type:\tthe type of the container struct this is embedded in.\n * @member:\tthe name of the member within the struct.\n *\n * WARNING: any const qualifier of @ptr is lost.\n */\n#define container_of(ptr, type, member) ({\t\t\t\t\\\n\tvoid *__mptr = (void *)(ptr);\t\t\t\t\t\\\n\tstatic_assert(__same_type(*(ptr), ((type *)0)->member) ||\t\\\n\t\t      __same_type(*(ptr), void),\t\t\t\\\n\t\t      \"pointer type mismatch in container_of()\");\t\\\n\t((type *)(__mptr - offsetof(type, member))); })\n```\n`container_of`èƒ½ä»ç»“æ„ä½“æˆå‘˜æŒ‡é’ˆæ¨å¯¼å‡ºå…¶çˆ¶çº§ç»“æ„ä½“çš„æŒ‡é’ˆï¼š\n- `ptr`ï¼šæŒ‡å‘ç»“æ„ä½“ `member` æˆå‘˜çš„æŒ‡é’ˆã€‚\n- `type`ï¼šåŒ…å« `member` æˆå‘˜çš„ç»“æ„ä½“ç±»å‹ã€‚\n- `member`ï¼š`type` ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡åã€‚\n\næ‰©å±•åï¼Œ`from_timer`èƒ½æ ¹æ®ä»¥ä¸‹å½¢å‚è®¡ç®—å‡ºå…¶æ‰€å±çš„çˆ¶çº§ç»“æ„ä½“(è¿™é‡Œä¸º`timer_dev`)çš„æŒ‡é’ˆï¼š\n- `var`ï¼šç›®æ ‡ç»“æ„ä½“çš„å˜é‡ï¼ˆä¸æ˜¯æŒ‡é’ˆï¼Œè€Œæ˜¯å˜é‡åï¼‰ã€‚\n- `callback_timer`ï¼šæŒ‡å‘ `timer_list` ç»“æ„ä½“çš„æŒ‡é’ˆï¼ˆå®šæ—¶å™¨å›è°ƒä¼ å…¥çš„å‚æ•°ï¼‰ã€‚\n- `timer_fieldname`ï¼š`timer_list` åœ¨ `var` ç»“æ„ä½“ä¸­çš„å­—æ®µåã€‚\n\n## å®šæ—¶å™¨åˆå§‹åŒ–å‡½æ•°\n### æ—§ç‰ˆ\næ—§ç‰ˆAPIæ¯”è¾ƒå¤æ‚ï¼Œè¿˜è¦æ‰‹åŠ¨è®¾ç½®ç»“æ„ä½“æˆå‘˜ï¼š\n```\ninit_timer(&timerdev.timer);\ntimerdev.timer.function = timer_function;\ntimerdev.timer.data = (unsigned long)&timerdev;\n```\n### æ–°ç‰ˆ\nKernelæä¾›`timer_setup()`ï¼Œè¿™ä¸ªå®å®é™…ä¸Šç”±`init_timer_key()`å‡½æ•°æ‰©å±•è€Œæ¥ï¼š\n```\n#define timer_setup(timer, callback, flags)\t\t\t\\\n\t__init_timer((timer), (callback), (flags))\n```\n```\n#define __init_timer(_timer, _fn, _flags)\t\t\t\t\\\n\tinit_timer_key((_timer), (_fn), (_flags), NULL, NULL)\n```\n```\nvoid init_timer_key(struct timer_list *timer, void (*func)(struct timer_list*), unsigned int flags, const char *name, struct lock_class_key *key)\n\nusage: initialize a timer\n\nParameters:\n\nstruct timer_list *timer\nthe timer to be initialized\n\nvoid (*func)(struct timer_list *)\ntimer callback function\n\nunsigned int flags\ntimer flags\n\nconst char *name\nname of the timer\n\nstruct lock_class_key *key\nlockdep class key of the fake lock used for tracking timer sync lock dependencies\n\nDescription:\n\ninit_timer_key() must be done to a timer prior to calling any of the other timer functions.\n```\nå®é™…ä¸Š`timer_setup(&timerdev.timer, timer_function, 0)`å°±ç­‰äºï¼š\n```\ninit_timer_key(&timerdev.timer, timer_function, 0, NULL, NULL);\n```\næ³¨æ„è¿™é‡Œçš„`timer_function`å¿…é¡»ä½¿ç”¨`timer_list*`ç±»å‹ä½œä¸ºå½¢å‚ï¼Œä¸èƒ½ç”¨æ—§ç‰ˆçš„`arg`å»ä¼ é€’ã€‚\n\n## ä»æ­£ç‚¹åŸå­é˜¿å°”æ³•ç¬¬äº”åç« ç¤ºä¾‹ä»£ç ä¿®æ”¹è€Œæ¥çš„æ–°ä»£ç \n```\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/libata.h>   /* æ–°ç‰ˆkernelä¸å†æ”¯æŒide.h */\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/gpio.h>\n#include <linux/cdev.h>\n#include <linux/device.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_gpio.h>\n#include <asm/mach/map.h>\n#include <asm/uaccess.h>\n#include <asm/io.h>\n#include <linux/semaphore.h>\n#include <linux/timer.h>\n\n#define \tTIMER_CNT     \t1\n#define \tTIMER_NAME      \"timer\"\n#define \tCLOSE_CMD     \t(_IO(0xEF, 0x1))\n#define \tOPEN_CMD \t    (_IO(0xEF, 0x2))\n#define \tSETPERIOD_CMD  \t(_IO(0xEF, 0x3))\n#define \tLED_ON \t      \t1\n#define \tLED_OFF        \t0\n\n/* Timer device struct */\nstruct timer_dev{\n dev_t devid;\t\t\t\n struct cdev cdev;\t\t\n struct class *class;\t\n struct device *device;\t\n int major;\t\t\t\t\n int minor;\t\t\t\t\n struct device_node *nd;\t\n int led_gpio;\n int timeperiod;\t\t\t/* å®šæ—¶å™¨å‘¨æœŸ(ms) */\n struct timer_list timer;\t/* å®šæ—¶å™¨ */\n spinlock_t lock;\t\t\t/* è‡ªæ—‹é” */\n};\n\nstruct timer_dev timerdev;\t/* å£°æ˜å®šæ—¶å™¨å®ä¾‹ */\n\nstatic int led_init(void)\n{\n\tint ret = 0;\n\n\t/* ä»è®¾å¤‡æ ‘æŸ¥æ‰¾ledèŠ‚ç‚¹ */\n\ttimerdev.nd = of_find_node_by_path(\"/gpioled\");\n\tif (timerdev.nd == NULL){\n\t\treturn -EINVAL;\n\t}\n\n\t/* ä»èŠ‚ç‚¹æŸ¥æ‰¾gpiopin */\n\ttimerdev.led_gpio = of_get_named_gpio(timerdev.nd, \"led-gpio\", 0);\n\tif (timerdev.led_gpio < 0){\n\t\tprintk(\"Unable get led gpio\\r\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t/* ç”³è¯·GPIO */\n\tgpio_request(timerdev.led_gpio, \"led\");\n\n\t/* ä¸Šæ‹‰è¾“å‡º */\n\tret = gpio_direction_output(timerdev.led_gpio, 1);\t\n\tif (ret < 0){\n\t\tprintk(\"cannot set gpio\\r\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int timer_open(struct inode *inode, struct file *filp)\n{\n\tint ret = 0;\n\tfilp->private_data = &timerdev;\t/* è®¾ç½®ç§æœ‰å˜é‡ä»¥ä¿å­˜ç»“æ„ä½“ */\n\n\ttimerdev.timeperiod = 1000;\t/* é»˜è®¤å®šæ—¶å™¨å‘¨æœŸ1000ms */\n\n\t/* åˆå§‹åŒ–LED */\n\tret = led_init();\n\tif (ret < 0){\n\t\tprintk(\"led initialize failed\\r\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic long timer_unlocked_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n\tstruct timer_dev *dev = (struct timer_dev *)filp->private_data;\t/* ä»fopsè·å–ä¿å­˜çš„timerdev */\n\tint timerperiod;\n\tunsigned long flags;\n\n\tswitch (cmd) {\n\t\t/* å…³é—­å®šæ—¶å™¨ */\n\t\tcase CLOSE_CMD:\n\t\t\tdel_timer_sync(&dev->timer);\n\t\t\tbreak;\n\n\t\t/* æ‰“å¼€å®šæ—¶å™¨ */\n\t\tcase OPEN_CMD:\n\t\t\tspin_lock_irqsave(&dev->lock, flags);\t/* ä¸Šé” */\n\t\t\ttimerperiod = dev->timeperiod;\t/* ä¿æŠ¤çŠ¶æ€ä¸‹ä¿®æ”¹timerperiodä¸ºé»˜è®¤å®šæ—¶å™¨å‘¨æœŸ */\n\t\t\tspin_unlock_irqrestore(&dev->lock, flags);\t/* è§£é” */\n\t\t\tmod_timer(&dev->timer, jiffies + msecs_to_jiffies(timerperiod));\t/* é‡å¯å®šæ—¶å™¨ */\n\t\t\tbreak;\n\n\t\t/* ä¿®æ”¹å®šæ—¶å™¨å‘¨æœŸ */\n\t\tcase SETPERIOD_CMD:\n\t\t\tspin_lock_irqsave(&dev->lock, flags);\t/* ä¸Šé” */\n\t\t\tdev->timeperiod = arg;\t/* ä¿æŠ¤çŠ¶æ€ä¸‹ä»ç”¨æˆ·ç©ºé—´è·å–å®šæ—¶å™¨å‘¨æœŸå¹¶èµ‹å€¼ */\n\t\t\tspin_unlock_irqrestore(&dev->lock, flags);\t/* è§£é” */\n\t\t\tmod_timer(&dev->timer, jiffies + msecs_to_jiffies(arg));\t/* é‡å¯å®šæ—¶å™¨ */\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tbreak;\n\t}\n\treturn 0;\n}\n\t\nstatic struct file_operations timer_fops = {\n\t.owner = THIS_MODULE,\n\t.open = timer_open,\n\t.unlocked_ioctl = timer_unlocked_ioctl,\n};\n\n/* å®šæ—¶å™¨å›è°ƒ */\nvoid timer_function(struct timer_list *t)\n{\n\tstruct timer_dev *dev = from_timer(dev, t, timer);\t/* ä»å®šæ—¶å™¨å®ä¾‹è·å–çˆ¶çº§ç»“æ„ä½“ */\n\tstatic int sta = 1;\n\tint timerperiod;\n\tunsigned long flags;\n\n\t/* ç¿»è½¬LED */\n\tsta = !sta;\n\tgpio_set_value(dev->led_gpio, sta);\n\n\tspin_lock_irqsave(&dev->lock, flags);\t/* ä¸Šé” */\n\ttimerperiod = dev->timeperiod;\t/* ä¿æŠ¤çŠ¶æ€ä¸‹è·å–å½“å‰å®šæ—¶å™¨å‘¨æœŸ */\n\tspin_unlock_irqrestore(&dev->lock, flags);\t/* è§£é” */\n\tmod_timer(&dev->timer, jiffies + msecs_to_jiffies(dev->timeperiod));\t/* é‡å¯å®šæ—¶å™¨ */\n}\n\nstatic int __init timer_init(void)\n{\n\t/* åˆå§‹åŒ–è‡ªæ—‹é” */\n\tspin_lock_init(&timerdev.lock);\n\n\t/* æ³¨å†Œè®¾å¤‡ */\n\tif (timerdev.major){\n\t\ttimerdev.devid = MKDEV(timerdev.major, 0);\n\t\tregister_chrdev_region(timerdev.devid, TIMER_CNT, TIMER_NAME);\n\t}else{\n\t\talloc_chrdev_region(&timerdev.devid, 0, 1, TIMER_NAME);\n\t\ttimerdev.major = MAJOR(timerdev.devid);\n\t\ttimerdev.minor = MINOR(timerdev.devid);\n\t}\n\tprintk(\"Device reg ok, major = %d, minor = %d\\r\\n\", timerdev.major, timerdev.minor);\n\n\t/* é…ç½®CDEV*/\n\ttimerdev.cdev.owner = THIS_MODULE;\n\tcdev_init(&timerdev.cdev, &timer_fops);\n\tcdev_add(&timerdev.cdev, timerdev.devid, TIMER_CNT);\n\n\t/* é…ç½®CLASS */\n\ttimerdev.class = class_create(TIMER_NAME);\n\tif (IS_ERR(timerdev.class)){\n\t\treturn PTR_ERR(timerdev.class);\n\t}\n\n\t/* é…ç½®DEVICE */\n\ttimerdev.device = device_create(timerdev.class, NULL, timerdev.devid, NULL, TIMER_NAME);\n\tif (IS_ERR(timerdev.device))\n\t{\n\t\treturn PTR_ERR(timerdev.device);\n\t}\n\n\t/* åˆå§‹åŒ–å®šæ—¶å™¨ */\n\ttimer_setup(&timerdev.timer, timer_function, 0);\n\n\treturn 0;\n}\n\nstatic void __exit timer_exit(void)\n{\n\tgpio_set_value(timerdev.led_gpio, 1);\n\tdel_timer_sync(&timerdev.timer);\n\n\tcdev_del(&timerdev.cdev);\n\tunregister_chrdev_region(timerdev.devid, TIMER_CNT);\n\n\tdevice_destroy(timerdev.class, timerdev.devid);\n\tclass_destroy(timerdev.class);\n}\n\nmodule_init(timer_init);\nmodule_exit(timer_exit);\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"aki\");\n```\n\n\n","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"Linuxå¹¶å‘ä¸ç«äº‰","url":"/2025/03/24/Linuxå¹¶å‘ä¸ç«äº‰/","content":"## åŸå­æ“ä½œ\nåŸå­æ“ä½œèƒ½å¤Ÿåœ¨æ— é”æ¡ä»¶ä¸‹å®ç°çº¿ç¨‹å®‰å…¨æ“ä½œï¼Œé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å˜é‡å¯¼è‡´æ•°æ®ç«äº‰ã€‚æ¯”è¾ƒé€‚ç”¨äºç®€å•çš„è®¡æ•°æˆ–æ ‡å¿—å˜é‡ç­‰å°å‹å…±äº«æ•°æ®ã€‚ä½†æ˜¯åŸå­æ“ä½œåªèƒ½ä¿è¯å•ä¸ªåŸå­å˜é‡çš„åŸå­æ€§ï¼Œä¸èƒ½ä¿æŠ¤å¤æ‚æ•°æ®ç»“æ„ã€‚å¹¶ä¸”è™½ç„¶å…¶ä¸ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œä½†å¯èƒ½å¯¼è‡´æ´»é”ï¼Œå³å¤šä¸ªçº¿ç¨‹ä¸æ–­é‡è¯•å¹¶ç«äº‰CPUèµ„æºã€‚\n\né©±åŠ¨ä¸­é€šè¿‡åŸå­æ“ä½œæ¥ä¿æŠ¤è¿›ç¨‹çš„æ–¹å¼ä¸ºï¼š\n1. åœ¨è®¾å¤‡ç»“æ„ä½“ä¸­å£°æ˜åŸå­å˜é‡\n```\nstruct gpioled_dev{\n    ......\n    atomic_t lock;   /* åŸå­å˜é‡ */\n}\n```\n2. openå‡½æ•°ä¸­åˆ¤æ–­åŸå­å˜é‡çš„å€¼æ¥æ£€æŸ¥ç›®æ ‡è®¾å¤‡æœ‰æ— è¢«åˆ«çš„åº”ç”¨è°ƒç”¨\n```\nstatic int led_open(...)\n{\n    if (!atomic_dec_and_test(&gpioled.lock)){\n        atomic_inc(&gpioled.lock);\n        return -EBUSY;\n    }\n}\n```\nè¿™æ®µä»£ç çš„é€»è¾‘æ˜¯ï¼Œ`atomic_dec_and_test`å°†åŸå­å˜é‡é€’å‡å¹¶æ£€æŸ¥å…¶æ˜¯å¦ä¸º0.å¦‚æœä¸º0ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹è·å¾—è®¿é—®æƒé™ï¼›å¦‚æœé€’å‡ååŸå­å˜é‡ä»å¤§äº0ï¼Œè¯´æ˜å·²ç»æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰æƒé™ï¼Œå½“å‰çº¿ç¨‹ä¸èƒ½è®¿é—®ã€‚å¦‚æœå½“å‰çº¿ç¨‹å¯ä»¥è®¿é—®ï¼Œåˆ™å°†åŸå­å˜é‡æ¢å¤åŸå€¼ï¼Œé¿å…å½±å“è®¡æ•°ã€‚\n\nåœ¨é©±åŠ¨æ–‡ä»¶å…³é—­æ—¶ï¼Œé‡Šæ”¾åŸå­å˜é‡ï¼š\n```\nstatic int led_release(...)\n{\n    ......\n    atomic_inc(&dev->lock);\n}\n```\n\nåœ¨é©±åŠ¨å…¥å£å‡½æ•°å†…ï¼Œåˆå§‹åŒ–åŸå­å˜é‡ä¸º1ï¼š\n```\nstatic int __init led_init(void)\n{\n    ...\n\n    atomic_set(&gpioled.lock, 1);\n}\n```\n\n## è‡ªæ—‹é”(Spinlock)\nè¿™æ˜¯ä¸€ç§è½»é‡çº§çš„é”ï¼Œé€šè¿‡ä¸æ–­å¾ªç¯æ£€æŸ¥é”çš„çŠ¶æ€æ¥ç­‰å¾…èµ„æºï¼Œè€Œéè®©çº¿ç¨‹è¿›å…¥ç¡çœ ã€‚\n\n- çº¿ç¨‹åœ¨ç­‰å¾…é”æ—¶ä¼šä¸æ–­æ£€æŸ¥ï¼Œä¸é‡Šæ”¾CPUæ—¶é—´\n- é€‚ç”¨äº**ä¸´ç•ŒåŒºæ‰§è¡Œæ—¶é—´çŸ­**çš„åœºæ™¯ï¼Œå¦åˆ™æµªè´¹CPUèµ„æº\n- éœ€è¦æ˜¾å¼åŠ é”/è§£é”ï¼Œé€‚ç”¨äºä¿æŠ¤å¤æ‚çš„æ•°æ®ç»“æ„\n\nè‡ªæ—‹é”ä¿æŠ¤çš„æ˜¯ä¸´ç•ŒåŒºï¼Œå³`spin_lock_irqsave()`åˆ°`spin_unlock_irqrestore()`ä¹‹é—´çš„\nä»£ç æ‰€æ“ä½œçš„å…±äº«å˜é‡ã€‚\n\nè‡ªæ—‹é”é€‚ç”¨äºä¸´ç•ŒåŒºæ‰§è¡Œæ—¶é—´çŸ­æˆ–é”çš„æŒæœ‰æ—¶é—´çŸ­çš„æƒ…å†µï¼Œæˆ–å¤šæ ¸CPUåœºæ™¯ã€‚æ“ä½œè‡ªæ—‹é”æ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨`spin_lock_irqsave`å’Œ`spin_unlock_irqrestore`å‡½æ•°ï¼Œå…¶ä¼šå…³é—­ä¸­æ–­ï¼Œé¿å…IRQæŠ¢å é”ä»¥é€ æˆç«äº‰é—®é¢˜ã€‚è§£é”æ—¶å‡½æ•°ä¼šä¸€å¹¶æ¢å¤ä¸­æ–­ï¼Œé˜²æ­¢ä¸­æ–­æ°¸ä¹…å…³é—­ã€‚\n```\nå‡½æ•°å£°æ˜ï¼š\n\tvoid spin_lock_irqsave(spinlock_t *lock, unsigned long flags);\nå‡½æ•°åŠŸèƒ½ï¼š\n\t1. ä¿å­˜æœ¬åœ°ä¸­æ–­çŠ¶æ€\n\t2. å…³é—­æœ¬åœ°ä¸­æ–­\n\t3. è·å–è‡ªæ—‹é”\nå‚æ•°è¯´æ˜ï¼š\n\tlockï¼šè¢«å®šä¹‰ä¸”åˆå§‹åŒ–è¿‡çš„é”ï¼›\n\tflagsï¼šä¿å­˜æœ¬åœ°ä¸­æ–­çŠ¶æ€ï¼›\n```\n\né©±åŠ¨é€šè¿‡è‡ªæ—‹é”æ¥ä¿æŠ¤çº¿ç¨‹çš„æ–¹æ³•ï¼š\n1. è®¾å¤‡ç»“æ„ä½“ä¸­å£°æ˜è®¾å¤‡çŠ¶æ€å’Œè‡ªæ—‹é”ï¼š\n```\nstrcut gpioled_dev {\n    ......\n    int dev_stats; /* è®¾å¤‡çŠ¶æ€ï¼Œ0ï¼šæœªä½¿ç”¨ï¼›>0ï¼šå·²ç»è¢«ä½¿ç”¨ */\n    spinlock_t lock;   /* è‡ªæ—‹é” */\n}\n```\n2. openå‡½æ•°ä¸­æ£€æŸ¥é”çš„çŠ¶æ€\n```\nstatic int led_open(...)\n{\n    ......\n    spin_lock_irqsave(&gpioled.lock ,flags);    /* ä¸Šé” */\n    if (gpioled.dev_stats){     /* å¦‚æœè®¾å¤‡å·²ç»è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨ */\n        spin_unlock_irqrestore(&gpioled.lock, flags);   /* è§£é” */\n        return -EBUSY;  /* è®¾å¤‡æ­£å¿™ */\n    }\n    gpioled.dev_stats++;    /* å¦‚æœè®¾å¤‡æœªæ‰“å¼€ï¼Œåˆ™æ›´æ–°è®¾å¤‡çŠ¶æ€ä¸ºå·²ç»æ‰“å¼€ */\n    spin_unlock_irqrestore(&gpioled.lock, flags);   /* è§£é” */\n}\n```\n3. releaseå‡½æ•°ä¸­æ›´æ–°é”çš„çŠ¶æ€\n```\nstatic int led_release(...)\n{\n    ......\n    spin_lock_irqsave(&dev->lock, flags);   /* ä¸Šé” */\n    if (dev->dev_stats){\n        dev->dev_stats--;   /* æ›´æ–°è®¾å¤‡çŠ¶æ€è‡³æœªä½¿ç”¨ */\n    }\n    spin_unlock_irqrestore(&dev->lock, flags);  /* è§£é” */\n}\n```\n\n4. è®¾å¤‡åˆå§‹åŒ–æ—¶åˆå§‹åŒ–è‡ªæ—‹é”\n```\nstatic int __init led_init(void)\n{\n    ......\n    spin_lock_init(&gpioled.lock);\n}\n```\n\n*é—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸åœ¨è®¾å¤‡ï¼ˆçº¿ç¨‹ï¼‰è¢«ä½¿ç”¨åç›´æ¥ä¸Šé”ï¼Œè€Œæ˜¯ä¸Šé”ååˆè§£é”ï¼Ÿ è¿™æ ·ä¸å°±é˜²æ­¢å…¶ä»–çº¿ç¨‹è®¿é—®äº†å—ï¼Ÿ*\nç®€å•æ¥è¯´ï¼Œé”çš„ä½œç”¨ä¸æ˜¯ç”¨æ¥â€œé”ä½æ•´ä¸ªè®¾å¤‡â€ï¼Œè€Œæ˜¯ç”¨æ¥â€œä¿æŠ¤å¯¹å…±äº«èµ„æºçš„è®¿é—®â€ã€‚\nåœ¨ `led_open()` é‡Œï¼Œæˆ‘ä»¬ç”¨è‡ªæ—‹é”æ¥ä¿è¯æ£€æŸ¥ & ä¿®æ”¹è®¾å¤‡çŠ¶æ€è¿™æ®µä»£ç æ˜¯åŸå­çš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥é”ä½æ•´ä¸ªè®¾å¤‡çš„è®¿é—®æƒé™ã€‚\n\nå‡è®¾æˆ‘ä»¬åœ¨ `gpioled.dev_stats++` ä¹‹åä¸è§£é”ï¼Œè€Œæ˜¯è®©é”ä¸€ç›´ä¿æŒä¸é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å°±æ— æ³•å†è¿›å…¥ `led_open()`ï¼Œä½†è¿™å¸¦æ¥äº†ä¸¤ä¸ªå¤§é—®é¢˜ï¼š\n1. æ•´ä¸ªè®¾å¤‡ä¼šè¢«é”æ­»ï¼Œè¿™ä¸ªè®¾å¤‡æ— æ³•å†è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨\n2. `led_release`æ— æ³•å†è·å–é”ï¼Œè®¾å¤‡æ— æ³•è¢«é‡Šæ”¾ï¼Œé€ æˆæ­»é”ã€‚\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œé”ä¿æŠ¤çš„ä¸æ˜¯è¿™ä¸ªè®¾å¤‡ï¼Œè€Œæ˜¯è®¾å¤‡ä¸­çš„æŸä¸ªé‡(è¿™é‡Œå°±æ˜¯`gpioled.dev_stats`)ï¼Œè¿™ä¸ªé‡ç”¨äºæ£€æŸ¥è¯¥è®¾å¤‡æ˜¯å¦å·²ç»/æ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨ã€‚\n\n## ä¿¡å·é‡(Semaphore)\nå’Œè‡ªæ—‹é”ä¸åŒï¼Œä¿¡å·é‡å¯ä»¥é˜»å¡çº¿ç¨‹ï¼Œå¦‚æœè·å–ä¸åˆ°ä¿¡å·é‡ï¼Œçº¿ç¨‹å°†ä¼šè¿›å…¥ç¡çœ ä»¥é‡Šæ”¾CPUèµ„æºï¼Œé€‚ç”¨äºé•¿æ—¶é—´è®¿é—®èµ„æºçš„åœºæ™¯ï¼ˆå¦‚è®¿é—®æ–‡ä»¶ã€æ“ä½œè®¾å¤‡ç­‰ï¼‰ã€‚çº¿ç¨‹ä¼šè¿›å…¥ç¡çœ è¿™ç‚¹æ¶‰åŠä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ‰ä¸€å®šçš„å¼€é”€ã€‚\n```\nstruct semaphore sem;\nsema_init(&sem, 1);  // åˆå§‹åŒ–ä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º1ï¼ˆç±»ä¼¼äº’æ–¥é”ï¼‰\n\ndown(&sem);  // ğŸ”’ è·å–ä¿¡å·é‡ï¼ˆå¦‚æœå·²ç»è¢«å ç”¨ï¼Œå½“å‰çº¿ç¨‹ä¼šè¿›å…¥ç¡çœ ï¼‰\nshared_resource++;  // è®¿é—®å…±äº«èµ„æº\nup(&sem);    // ğŸ”“ é‡Šæ”¾ä¿¡å·é‡\n```\n\n## äº’æ–¥ä½“(Mutex)\nå’Œä¿¡å·é‡ä¸åŒï¼Œäº’æ–¥ä½“ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å¾—é”ï¼ˆä¿¡å·é‡å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé˜»å¡ï¼ˆç¡çœ ï¼‰ã€‚\n1. ç»“æ„ä½“ä¸­å£°æ˜äº’æ–¥ä½“\n```\nstruct mutex lock;\n```\n2. openå‡½æ•°ä¸­è·å–äº’æ–¥ä½“(`interruptible`è¡¨ç¤ºè¯¥å‡½æ•°å¯è¢«ä¿¡å·æ‰“æ–­)\n```\nif (mutexc_lock_interruptible(&gpioled.lock)){\n    return -ERESTARTSYS;\n}\n```\n3. releaseæ—¶é‡Šæ”¾äº’æ–¥é”\n```\nmutex_unlock(&dev->lock);\n```\n4. åˆå§‹åŒ–è®¾å¤‡æ—¶åˆå§‹åŒ–äº’æ–¥é”\n```\nmutex_init(&gpioled.lock);\n```\n\n## å¯¹æ¯”\nå‡è®¾ä½ å»é“¶è¡ŒğŸ¦å–é’±ï¼š\n\n- ğŸ”¢ åŸå­å˜é‡ï¼ˆAtomicï¼‰ï¼šé“¶è¡Œé—¨å£æœ‰ä¸€ä¸ªâ€œå½“å‰æ’é˜Ÿäººæ•°â€æ˜¾ç¤ºå±ï¼Œæ¯ä¸ªäººæ¥éƒ½å¯ä»¥å®‰å…¨åœ°åŠ  1 æˆ–å‡ 1ï¼Œä½†ä¸ä¼šæ§åˆ¶è°å»åŠä¸šåŠ¡ï¼ˆåªé€‚ç”¨äºç®€å•è®¡æ•°ï¼‰ã€‚\n\n- ğŸ”„ è‡ªæ—‹é”ï¼ˆSpinlockï¼‰ï¼šä½ å»é“¶è¡Œå–é’±ï¼Œå‘ç°æŸœå°æœ‰äººï¼Œä½ ç«™åœ¨é‚£é‡Œç­‰ï¼Œç›´åˆ°è½®åˆ°ä½ ï¼ˆCPU å¿™ç­‰ï¼‰ã€‚\n\n- ğŸ”¢ ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼šé“¶è¡Œæœ‰å¤šä¸ªæŸœå°ï¼Œä½ å¯ä»¥å»ä»»ä½•ç©ºé—²çš„æŸœå°åŠç†ä¸šåŠ¡ï¼ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼‰ã€‚\n\n- ğŸ›‘ äº’æ–¥ä½“ï¼ˆMutexï¼‰ï¼šä½ å»é“¶è¡Œå–é’±ï¼Œå‘ç°æŸœå°æœ‰äººï¼Œä½ å»ç­‰å€™åŒºåç€ï¼Œç­‰æŸœå°ç©ºäº†å†å»ï¼ˆçº¿ç¨‹ç¡çœ ï¼‰ã€‚\n\n\n","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶","url":"/2025/03/14/Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶/","content":"## å­—ç¬¦è®¾å¤‡\nå­—ç¬¦è®¾å¤‡æ˜¯ Linux é©±åŠ¨ä¸­æœ€åŸºæœ¬çš„ä¸€ç±»è®¾å¤‡é©±åŠ¨ï¼Œå­—ç¬¦è®¾å¤‡å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚ï¼ŒæŒ‰ç…§å­—èŠ‚æµè¿›è¡Œè¯»å†™æ“ä½œçš„è®¾å¤‡ï¼Œè¯»å†™æ•°æ®æ˜¯åˆ†å…ˆåé¡ºåºçš„ã€‚æœ€å¸¸è§çš„ç‚¹ç¯ã€æŒ‰é”®ã€IICã€SPIï¼ŒLCD ç­‰ç­‰éƒ½æ˜¯å­—ç¬¦è®¾å¤‡ï¼Œè¿™äº›è®¾å¤‡çš„é©±åŠ¨å°±å«åšå­—ç¬¦è®¾å¤‡é©±åŠ¨ã€‚\n\n## å­—ç¬¦è®¾å¤‡é©±åŠ¨å·¥ä½œæµç¨‹\n### åŠ è½½/å¸è½½é©±åŠ¨æ¨¡å—\nLinuxçš„é©±åŠ¨æœ‰ä¸¤ç§å·¥ä½œæ–¹å¼ï¼š\n- é©±åŠ¨ç¼–è¯‘è¿›kernelï¼Œkernelå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œé©±åŠ¨ç¨‹åº\n- é©±åŠ¨ç¼–è¯‘ä¸ºæ¨¡å—(`.ko`)ï¼Œkernelå¯åŠ¨åè°ƒç”¨`insmod`åŠ è½½é©±åŠ¨æ¨¡å—\n\næ¨¡å—æœ‰åŠ è½½å’Œå¸è½½ä¸¤ç§æ“ä½œï¼š\n```\nmodule_init(xxx_init);  //æ³¨å†Œæ¨¡å—åŠ è½½\nmodule_exit(xxx_exit);  //æ³¨å†Œæ¨¡å—å¸è½½\n```\n`module_init`ç”¨äºå‘Kernelæ³¨å†Œä¸€ä¸ªæ¨¡å—åŠ è½½å‡½æ•°ï¼Œå½“`insmod`æ—¶ï¼Œè¯¥å‡½æ•°å°±ä¼šè¢«Kernelè°ƒç”¨ã€‚\n\nå­—ç¬¦è®¾å¤‡é©±åŠ¨çš„æ¨¡å—åŠ è½½å’Œå¸è½½æ¨¡æ¿å¦‚ä¸‹ï¼š\n```\n/* é©±åŠ¨å…¥å£ */\nstatic int __init xxx_init(void)\n{\n    /* å…¥å£å‡½æ•°å…·ä½“å†…å®¹ */\n    return 0;\n}\n\n/* é©±åŠ¨å‡ºå£ */\nstatic void __exit xxx_exit(void)\n{\n    /* å‡ºå£å‡½æ•°å…·ä½“å†…å®¹ */\n}\n\n/* å°†ä¸Šé¢ä¸¤ä¸ªå‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å…¥å£å’Œå‡ºå£å‡½æ•° */\nmodule_init(xxx_init); \nmodule_exit(xxx_exit); \n```\n\né©±åŠ¨ç¼–è¯‘å®Œæˆåï¼ŒKernelæœ‰ä¸¤ç§å‘½ä»¤ç”¨äºåŠ è½½é©±åŠ¨æ¨¡å—ï¼š`insmod`å’Œ`modprobe`ï¼š\n- `insmod`æ˜¯æœ€ç®€å•çš„æ¨¡å—åŠ è½½å‘½ä»¤ï¼Œç”¨äºåŠ è½½æŒ‡å®šçš„`.ko`æ¨¡å—ï¼Œæ¯”å¦‚`insmod drv.ko`ã€‚ä½†`insmod`ä¸èƒ½è§£å†³æ¨¡å—çš„ä¾èµ–å…³ç³»ã€‚\n- `modprobe`å¯ä»¥è‡ªåŠ¨åˆ†ææ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œç„¶ååŠ è½½æ‰€æœ‰çš„ä¾èµ–æ¨¡å—åˆ°Kernelä¸­ã€‚\n\næ¨¡å—å¸è½½åˆ™ä½¿ç”¨`rmmod`æˆ–`modprobe -r`ã€‚\n\næ¨èï¼šåŠ è½½ä½¿ç”¨`modprobe`ï¼Œå¸è½½ä½¿ç”¨`rmmod`ã€‚\n\n### æ³¨å†Œä¸æ³¨é”€\næ¨¡å—åŠ è½½æˆåŠŸåéœ€è¦æ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼Œå¸è½½æ¨¡å—æ—¶ä¹Ÿéœ€è¦æ³¨é”€ç›¸å…³å­—ç¬¦è®¾å¤‡ï¼š\n```\nstatic inline int register_chrdev(unsigned int major, const char *name, const struct file_operation *fops)\nstatic inline void unregister_chrdev(unsigned int major, const char *name)\n```\n`register_chrdev`ç”¨äºæ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼Œå½¢å‚æœ‰ï¼š\n- `major`ï¼šä¸»è®¾å¤‡å·\n- `name`ï¼šè®¾å¤‡å\n- `fops`ï¼šç»“æ„ä½“`file_operations`ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘æ“ä½œå‡½æ•°é›†åˆå˜é‡\n\n`unregister_chrdev`ç”¨äºæ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼Œå½¢å‚æœ‰ï¼š\n- `major`ï¼šä¸»è®¾å¤‡å·\n- `name`ï¼šè®¾å¤‡å\n\nä¸€åŠå­—ç¬¦è®¾å¤‡çš„æ³¨å†Œåœ¨å…¥å£å‡½æ•°ä¸­è¿›è¡Œï¼Œæ³¨é”€åœ¨å‡ºå£å‡½æ•°ä¸­æ‰§è¡Œï¼š\n```\nstatic struct file_operations test_fops;\n\nstatic int __init xxx_init(void)\n{\n    int retvalue = 0;\n\n    /* æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ */\n    retvalue = register_chrdev(200, \"chrtest\", &test_ops);  /* ä¸»è®¾å¤‡å·200ï¼Œè®¾å¤‡å\"chrtest\" */\n    if (retvalue < 0)\n    {\n        error_handler();\n    }\n\n    return 0;\n}\n\nstatic void __exit xxx_exit(void)\n{\n    /* æ³¨é”€å­—ç¬¦è®¾å¤‡é©±åŠ¨ */\n    unregister_chrdev(200, \"chrtest\");\n}\n\n/* å°†ä¸ªå‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å…¥å£å’Œå‡ºå£å‡½æ•° */\nmodule_init(xxx_init);\nmodule_exit(xxx_exit);\n```\n\nç»ˆç«¯ä¸­`car /proc/devices`å¯æŸ¥çœ‹å½“å‰å·²è¢«ä½¿ç”¨çš„è®¾å¤‡å·\n\n### å®ç°è®¾å¤‡çš„å…·ä½“æ“ä½œå‡½æ•°\nåœ¨å¯¹`test_fops`è¿›è¡Œåˆå§‹åŒ–ä¹‹å‰ï¼Œé¦–å…ˆè¦åˆ†æéœ€æ±‚ï¼Œå³`chrtest`è¿™ä¸ªè®¾å¤‡éœ€è¦å®ç°å“ªäº›åŠŸèƒ½ï¼š\n1. å¯¹`chrtest`èƒ½å¤Ÿè¿›è¡Œæ‰“å¼€å’Œå…³é—­æ“ä½œã€‚è¿™æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚\n2. å¯¹`chrtest`è¿›è¡Œè¯»å†™æ“ä½œã€‚å‡è®¾è®¾å¤‡æ§åˆ¶ç€ä¸€æ®µç¼“å†²åŒºï¼ˆå†…å­˜ï¼‰ï¼Œåº”ç”¨éœ€è¦é€šè¿‡`read`å’Œ`write`å¯¹ç¼“å†²åŒºè¿›è¡Œè¯»å†™æ“ä½œï¼Œå› æ­¤éœ€è¦å®ç°`file_operations`ä¸­çš„`read`å’Œ`write`ä¸¤ä¸ªå‡½æ•°ã€‚\n\nä¿®æ”¹ä»£ç ï¼š\n```\n/* æ‰“å¼€è®¾å¤‡ */\nstatic int chrtest_open(struct inode *inode, struct file *filp)\n{\n    return 0;\n}\n\n/* ä»è®¾å¤‡è¯»å– */\nstatic ssize_t chrtest_read(struct file *filp, char __user *buf, size_t cnt, loff_t *offt)\n{\n    return 0;\n}\n\n/* å‘è®¾å¤‡å†™æ•°æ® */\nstatic ssize_t chrtest_write(struct file *filp, const char __user *buf, size_t cnt, loff_t *offt)\n{\n    return 0;\n}\n\n/* å…³é—­/é‡Šæ”¾è®¾å¤‡ */\nstatic int chrtest_release(struct inode *inode, struct file *filp)\n{\n    return 0;\n}\n\n/* åˆå§‹åŒ–file_operationsç»“æ„ä½“ */\nstatic struct file_operations test_fops = {\n    .owner = THIS_MODULE, \n    .open = chrtest_open,\n    .read = chrtest_read,\n    .write = chrtest_write,\n    .release = chrtest_release,\n};\n\nstatic int __init xxx_init(void)\n{\n    int retvalue = 0;\n\n    /* æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ */\n    retvalue = register_chrdev(200, \"chrtest\", &test_ops);  /* ä¸»è®¾å¤‡å·200ï¼Œè®¾å¤‡å\"chrtest\" */\n    if (retvalue < 0)\n    {\n        error_handler();\n    }\n\n    return 0;\n}\n\nstatic void __exit xxx_exit(void)\n{\n    /* æ³¨é”€å­—ç¬¦è®¾å¤‡é©±åŠ¨ */\n    unregister_chrdev(200, \"chrtest\");\n}\n\n/* å°†ä¸ªå‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å…¥å£å’Œå‡ºå£å‡½æ•° */\nmodule_init(xxx_init);\nmodule_exit(xxx_exit);\n```\n\nè¿™é‡Œçš„å‡½æ•°å½¢å‚éœ€è¦ä½¿ç”¨Linuxé©±åŠ¨æ¡†æ¶æ‰€è§„å®šçš„æ ‡å‡†æ ¼å¼ï¼š\n- `struct inode *inode`ï¼šæŒ‡å‘è®¾å¤‡æ–‡ä»¶çš„ ç´¢å¼•èŠ‚ç‚¹ï¼Œæè¿°äº†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€æ–‡ä»¶ç±»å‹ç­‰ï¼‰\n- `struct file *filp`ï¼šè¡¨ç¤º å·²æ‰“å¼€çš„æ–‡ä»¶ï¼ŒåŒ…å«æ–‡ä»¶çš„å½“å‰çŠ¶æ€ã€è®¿é—®æ¨¡å¼ç­‰ä¿¡æ¯ã€‚\n- `char __user *buf`ï¼šç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œå†…æ ¸éœ€è¦å°†æ•°æ®æ‹·è´åˆ°è¿™ä¸ªç¼“å†²åŒº\n- `size_t cnt`ï¼šå†™å…¥çš„å­—èŠ‚æ•°ï¼Œè¡¨ç¤ºç”¨æˆ·è¯·æ±‚å†™å…¥çš„é•¿åº¦\n- `loff_t *offt`ï¼šæ–‡ä»¶åç§»é‡ï¼Œç”¨äºæ”¯æŒæ–‡ä»¶çš„éšæœºè®¿é—®\n\n### æ·»åŠ LICENSEå’Œä½œè€…ä¿¡æ¯\nLICENSEä¸æ·»åŠ ç¼–è¯‘ä¼šæŠ¥é”™ï¼š\n```\nMODULE_LICENSE();\n```\n\n### è®¾å¤‡å·åˆ†é…\n#### é™æ€åˆ†é…\nWIP\n\n#### åŠ¨æ€åˆ†é…\næ¨èä½¿ç”¨åŠ¨æ€åˆ†é…è®¾å¤‡å·ï¼š\n```\nint alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count, const char *name)\n```\n- `dev`ï¼šä¿å­˜ç”³è¯·åˆ°çš„è®¾å¤‡å·\n- `baseminor`ï¼šæ¬¡è®¾å¤‡å·èµ·å§‹åœ°å€ï¼Œalloc_chrdev_region å¯ä»¥ç”³è¯·ä¸€æ®µè¿ç»­çš„å¤šä¸ªè®¾å¤‡å·ï¼Œè¿™äº›è®¾å¤‡å·çš„ä¸»è®¾å¤‡å·ä¸€æ ·ï¼Œä½†æ˜¯æ¬¡è®¾å¤‡å·ä¸åŒï¼Œæ¬¡è®¾å¤‡å·ä»¥ baseminor ä¸ºèµ·å§‹åœ°å€åœ°å€å¼€å§‹é€’å¢ã€‚ä¸€èˆ¬ baseminor ä¸º 0ï¼Œä¹Ÿå°±æ˜¯è¯´æ¬¡è®¾å¤‡å·ä» 0 å¼€å§‹ã€‚\n- `count`ï¼šè¦ç”³è¯·çš„è®¾å¤‡å·æ•°é‡\n- `name`ï¼šè®¾å¤‡å\n\né‡Šæ”¾è®¾å¤‡å·å‡½æ•°ï¼š\n```\nvoid unregister_chrdev_region(dev_t from, unsigned count)\n```\n- `from`ï¼šè¦é‡Šæ”¾çš„è®¾å¤‡å·\n- `count`ï¼šä»`from`å¼€å§‹è¦é‡Šæ”¾çš„è®¾å¤‡å·æ•°é‡\n\n#### cdev\ncdev æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºè¡¨ç¤ºå­—ç¬¦è®¾å¤‡çš„ä¸€ä¸ªç»“æ„ä½“ã€‚å®ƒæ˜¯ Linux å­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦ç”¨äºç®¡ç†å­—ç¬¦è®¾å¤‡çš„æ³¨å†Œå’Œæ–‡ä»¶æ“ä½œçš„ç»‘å®šã€‚å½“æ³¨å†Œä¸€ä¸ªå­—ç¬¦è®¾å¤‡æ—¶ï¼Œcdev ä¼šå¸®åŠ©å†…æ ¸å¤„ç†ä¸è®¾å¤‡ç›¸å…³çš„æ“ä½œã€‚\n```\nstruct cdev {\n    struct kobject kobj;\n    struct module *owner;\n    const struct file_operations *ops;  // è®¾å¤‡çš„æ–‡ä»¶æ“ä½œç»“æ„\n    struct list_head list;  // é“¾æ¥åˆ°ç³»ç»Ÿè®¾å¤‡åˆ—è¡¨\n    dev_t dev;  // è®¾å¤‡å·\n};\n```\ncdev çš„ä¸»è¦ä»»åŠ¡æ˜¯å°†æ–‡ä»¶æ“ä½œå‡½æ•°ï¼ˆä¾‹å¦‚ï¼šopenã€readã€write ç­‰ï¼‰å’Œè®¾å¤‡è¿›è¡Œå…³è”ã€‚å½“è®¾å¤‡è¢«æ‰“å¼€ã€è¯»å†™æˆ–é‡Šæ”¾æ—¶ï¼Œå†…æ ¸ä¼šé€šè¿‡ cdev ç»“æ„ä½“æ‰¾åˆ°ç›¸åº”çš„æ“ä½œå‡½æ•°å¹¶è°ƒç”¨å®ƒä»¬ã€‚\n\ncdevåº”å½“æŒ‰ç…§é¡ºåºè¢«ä½¿ç”¨ï¼š\n1. åˆå§‹åŒ–\n```\nstruct cdev chrdev_cdev;\ncdev_init(&chrdev_cdev, &fops);\n```\nè¿™ä¸ªæ“ä½œå¯ä»¥é€šè¿‡`cdev_alloc()`æ¥ä¸€æ¬¡æ€§å®Œæˆï¼š\n```\nstruct cdev *cdev_alloc(void)\n{\n\tstruct cdev *p = kzalloc(sizeof(struct cdev), GFP_KERNEL);\n\tif (p) {\n\t\tINIT_LIST_HEAD(&p->list);\n\t\tkobject_init(&p->kobj, &ktype_cdev_dynamic);\n\t}\n\treturn p;\n}\n```\n2. æ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼šä½¿ç”¨ `cdev_add` å‡½æ•°å°†å…¶æ³¨å†Œåˆ°å†…æ ¸ã€‚è¿™æ ·ï¼Œå†…æ ¸å°±èƒ½å¤Ÿåœ¨æ”¶åˆ°å¯¹è¯¥è®¾å¤‡çš„è¯·æ±‚æ—¶ï¼Œè°ƒç”¨å¯¹åº”çš„æ–‡ä»¶æ“ä½œå‡½æ•°ã€‚\n```\nint ret = cdev_add(&chrdev_cdev, dev_num, 1);\nif (ret < 0) {\n    printk(\"Failed to add cdev\\n\");\n    return ret;\n}\n```\n3. æ³¨é”€å­—ç¬¦è®¾å¤‡\n```\ncdev_del(&chrdev_cdev);\n```\n\n#### å…¶ä»–\né©±åŠ¨ä¸­è¿˜ä¼šç”¨åˆ°`copy_to_user`å‡½æ•°ï¼š\n```\nstatic inline long copy_to_user(void __user *to, const void *from, unsigned long n)\n```\nè¯¥å‡½æ•°ç”¨äºå°†å†…æ ¸ç©ºé—´ä¸­çš„æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚\n\n## æµ‹è¯•APP\n### Cåº“æ–‡ä»¶æ“ä½œ\n#### open()\n```\nint open(const char *pathname, int flags)\n```\n- `pathname`:è¦æ‰“å¼€çš„è®¾å¤‡æˆ–è€…æ–‡ä»¶å\n- `flags`ï¼šæ–‡ä»¶æ‰“å¼€æ¨¡å¼ï¼Œä»¥ä¸‹ä¸‰ç§æ¨¡å¼å¿…é€‰å…¶ä¸€ï¼š\n    + `O_RDONLY` åªè¯»æ¨¡å¼\n    + `O_WRONLY` åªå†™æ¨¡å¼\n    + `O_RDWR` è¯»å†™æ¨¡å¼\n\nå¦‚æœæ–‡ä»¶æ‰“å¼€æˆåŠŸçš„è¯è¿”å›æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦.\n### read()\n```\nssize_t read(int fd, void *buf, size_t count)\n```\n- `fd`:è¦è¯»å–çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯»å–æ–‡ä»¶ä¹‹å‰è¦å…ˆç”¨ open å‡½æ•°æ‰“å¼€æ–‡ä»¶ï¼Œopen å‡½æ•°æ‰“å¼€æ–‡ä»¶æˆåŠŸä»¥åä¼šå¾—åˆ°æ–‡ä»¶æè¿°ç¬¦\n- `buf`:æ•°æ®è¯»å–åˆ°æ­¤ buf ä¸­\n- `count`:è¦è¯»å–çš„æ•°æ®é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚æ•°\n\nè¯»å–æˆåŠŸçš„è¯è¿”å›è¯»å–åˆ°çš„å­—èŠ‚æ•°ï¼›å¦‚æœè¿”å› 0 è¡¨ç¤ºè¯»å–åˆ°äº†æ–‡ä»¶æœ«å°¾ï¼›å¦‚æœè¿”å›è´Ÿå€¼ï¼Œè¡¨ç¤ºè¯»å–å¤±è´¥ã€‚\n\n### write()\n```\nssize_t write(int fd, const void *buf, size_t count);\n```\n- `fd`:è¦è¿›è¡Œå†™æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå†™æ–‡ä»¶ä¹‹å‰è¦å…ˆç”¨ open å‡½æ•°æ‰“å¼€æ–‡ä»¶ï¼Œopen å‡½æ•°æ‰“å¼€æ–‡ä»¶æˆåŠŸä»¥åä¼šå¾—åˆ°æ–‡ä»¶æè¿°ç¬¦\n- `buf`:è¦å†™å…¥çš„æ•°æ®\n- `count`:è¦å†™å…¥çš„æ•°æ®é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚æ•°\n\nè¿”å›å€¼ï¼šå†™å…¥æˆåŠŸçš„è¯è¿”å›å†™å…¥çš„å­—èŠ‚æ•°ï¼›å¦‚æœè¿”å› 0 è¡¨ç¤ºæ²¡æœ‰å†™å…¥ä»»ä½•æ•°æ®ï¼›å¦‚æœè¿”å›\nè´Ÿå€¼ï¼Œè¡¨ç¤ºå†™å…¥å¤±è´¥\n\n### close()\n```\nint close(int fd);\n```\n\n0 è¡¨ç¤ºå…³é—­æˆåŠŸï¼Œè´Ÿå€¼è¡¨ç¤ºå…³é—­å¤±è´¥ã€‚\n\n## fopsã€cdevã€classã€device \n\n1. å®šä¹‰ fopsï¼Œæä¾› read/write/open/close/ioctl æ“ä½œ\n2. å®šä¹‰ cdevï¼Œå¹¶ç»‘å®š fops\n3. æ³¨å†Œ cdevï¼Œå¹¶åˆ†é… major/minor è®¾å¤‡å·\n4. åˆ›å»º classï¼Œä¾› udev è¯†åˆ«\n5. åˆ›å»º deviceï¼Œåœ¨ `/dev/` ä¸‹è‡ªåŠ¨ç”Ÿæˆè®¾å¤‡æ–‡ä»¶\n\n\n## å®Œæ•´æµç¨‹\n1. å®šä¹‰è®¾å¤‡ä¿¡æ¯ï¼Œç”¨äºæ³¨å†Œè®¾å¤‡è‡³kernel\n```\nstatic dev_t chrdev_devno;\n```\n2. å®šä¹‰æ–‡ä»¶æ“ä½œç»“æ„ä½“ï¼Œç”¨äºå°è£…ç”¨äºæ“ä½œå¤–è®¾çš„åŠŸèƒ½å‡½æ•°\n```\nstatic struct file_operations chrdev_fops = {\n    .owner = THIS_MODULE,\n    .open = chrdev_open,\n    .read = chrdev_read,\n    .write = chrdev_write,\n    .release = chrdev_release,\n};\n```\n3. å®ç°è®¾å¤‡æ“ä½œå‡½æ•°\n```\nstatic int chrdev_open(struct inode *inode, struct file *filp) {\n    return 0;\n}\n\nstatic ssize_t chrdev_read(struct file *filp, char __user *buf, size_t cnt, loff_t *offt) {\n    return 0;\n}\n\nstatic ssize_t chrdev_write(struct file *filp, const char __user *buf, size_t cnt, loff_t *offt) {\n    return 0;\n}\n\nstatic int chrdev_release(struct inode *inode, struct file *filp) {\n    return 0;\n}\n```\n4. åˆå§‹åŒ–å’Œæ¸…ç†\n```\nstatic int __init chrdev_init(void) {\n    int ret;\n    ret = alloc_chrdev_region(&chrdev_devno, 0, 1, \"chrdevbase\");   //åŠ¨æ€åˆ†é…è®¾å¤‡å·\n    if (ret < 0) {\n        printk(\"Failed to register device\\n\");\n        return ret;\n    }\n    cdev_init(&chrdev_cdev, &chrdev_fops);      //æ³¨å†Œcdev\n    ret = cdev_add(&chrdev_cdev, chrdev_devno, 1);      //æ·»åŠ cdev\n    if (ret < 0) {\n        unregister_chrdev_region(chrdev_devno, 1);\n        printk(\"Failed to add cdev\\n\");\n        return ret;\n    }\n    return 0;\n}\n\nstatic void __exit chrdev_exit(void) {\n    cdev_del(&chrdev_cdev);     //é”€æ¯cdev\n    unregister_chrdev_region(chrdev_devno, 1);      //æ³¨é”€è®¾å¤‡å·\n}\n\nmodule_init(hello_init);\nmodule_exit(hello_exit);\n```\n5. åˆ›å»ºèŠ‚ç‚¹ã€‚å¦‚æœåº”ç”¨ç¨‹åºè¦æƒ³ä½¿ç”¨è®¾å¤‡ï¼Œè¿˜å¿…é¡»åˆ›å»ºå­—ç¬¦è®¾å¤‡èŠ‚ç‚¹ï¼š\n```\nmknod /dev/chrdev c 249 0\n```\nç„¶ååº”ç”¨ç¨‹åºæ‰èƒ½å°†è®¾å¤‡å·å’Œå…·ä½“çš„è®¾å¤‡è¿æ¥èµ·æ¥å¹¶ä½¿ç”¨ã€‚\n\nå¦‚æœåˆå§‹åŒ–ä¸­åˆ›å»ºäº†`device`å’Œ`class`ç±»ï¼Œä¼šè‡ªåŠ¨ç”ŸæˆèŠ‚ç‚¹ã€‚\n\n## LEDç‚¹ç¯ç¤ºä¾‹\n```\n/* **************Includes************** */\n#include \"linux/fs.h\"\n#include \"linux/printk.h\"\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/ide.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/gpio.h>\n#include <linux/cdev.h>\n#include <linux/device.h>\n#include <asm/mach/map.h>\n#include <asm/uaccess.h>\n#include <asm/io.h>\n\n/* **************Defines************** */\n#define LED_DEVICE_CNT    1\n#define LED_DEVICE_NAME   \"led_dev\"\n#define LEDON   1\n#define LEDOFF  0\n\n/* å¯„å­˜å™¨ç‰©ç†åœ°å€ */\n#define CCM_CCGR1_BASE            (0x020C406C)\n#define SW_MUX_GPIO1_IO03_BASE    (0x020E0068)\n#define SW_PAD_GPIO1_IO03_BASE    (0x020E02F4)\n#define GPIO1_DR_BASE             (0x0209C000)\n#define GPIO1_GDIR_BASE           (0x0209C004)\n\n/* å¯„å­˜å™¨è™šæ‹Ÿåœ°å€ */\nstatic void __iomem *IMX6U_CCM_CCGR1;\nstatic void __iomem *SW_MUX_GPIO1_IO03;\nstatic void __iomem *SW_PAD_GPIO1_IO03;\nstatic void __iomem *GPIO1_DR;\nstatic void __iomem *GPIO1_GDIR;\n\n/* è®¾å¤‡ç»“æ„ä½“ */\nstruct led_dev{\n  dev_t devid;\n  struct cdev cdev;\n  struct class *class;\n  struct device *device;\n  int major;\n  int minor;\n};\n\n/* å£°æ˜å®ä¾‹ */\nstruct led_dev led;\n\n/* LEDåˆ‡æ¢å¼€å…³å‡½æ•° */\nvoid led_switch(u8 status)\n{\n  u32 val = 0;\n\n  if (status == LEDON){\n    val = readl(GPIO1_DR);\n    val &= ~(1 << 3);\n    writel(val, GPIO1_DR);\n  }else if (status == LEDOFF){\n    val = readl(GPIO1_DR);\n    val |= (1 << 3);\n    writel(val, GPIO1_DR);\n  }\n}\n\n/***********  fopsç»“æ„ä½“å‡½æ•°å¡«å…… **************/\nstatic int led_open(struct inode *inode, struct file *filp)\n{\n  filp->private_data = &led;  /* è®¾ç½®ç§æœ‰å˜é‡ */\n  return 0;\n}\n\nstatic ssize_t led_read(struct file *filp, char __user *buf, size_t cnt, loff_t *offt)\n{\n  return 0;\n}\n\nstatic ssize_t led_write(struct file *filp, char __user *buf, size_t cnt, loff_t *offt)\n{\n  int retvalue;\n  unsigned char databuf[1];\n  unsigned char led_status;\n\n  retvalue = copy_from_user(databuf, buf, cnt);\n  if (retvalue < 0){\n    printk(\"copy from user failed\\r\\n\");\n    return -EFAULT;\n  }\n\n  led_status = databuf[0];\n\n  switch (led_status) {\n    case LEDON:\n      led_switch(LEDON);\n      break;\n    case LEDOFF:\n      led_switch(LEDOFF);\n      break;\n  }\n\n  return 0;\n}\n\nstatic int led_release(struct inode *inode, struct file *filp)\n{\n  return 0;\n}\n\n/* fopsç»“æ„ä½“ */\nstatic struct file_operations led_fops = {\n  .owner = THIS_MODULE,\n  .open = led_open,\n  .read = led_read,\n  .write = led_write,\n  .release = led_release,\n};\n\n/* è®¾å¤‡åˆå§‹åŒ–å‡½æ•° */\nstatic int __init led_init(void)\n{\n  int retvalue = 0;\n  u32 val = 0;\n\n  /* è·å–å¯„å­˜å™¨è™šæ‹Ÿåœ°å€ */\n  IMX6U_CCM_CCGR1 = ioremap(CCM_CCGR1_BASE, 4);\n  SW_MUX_GPIO1_IO03 = ioremap(SW_MUX_GPIO1_IO03_BASE, 4);\n  SW_PAD_GPIO1_IO03 = ioremap(SW_PAD_GPIO1_IO03_BASE, 4);\n  GPIO1_DR = ioremap(GPIO1_DR_BASE, 4);\n  GPIO1_GDIR = ioremap(GPIO1_GDIR_BASE, 4);\n\n  /* ä½¿èƒ½æ—¶é’Ÿ */\n  val =readl(IMX6U_CCM_CCGR1);\n  val &= ~(3 << 26);\n  val |= (3 << 26);\n  writel(val, IMX6U_CCM_CCGR1);\n\n  /* è®¾ç½® GPIO1_IO03 å¤ç”¨ */\n  writel(5, SW_MUX_GPIO1_IO03);\n\n  /* é…ç½® GPIO1_IO03 */\n  writel(0x10B0, SW_PAD_GPIO1_IO03);\n\n  /* è®¾ç½® GPIO1_IO03 ä¸ºè¾“å‡º */\n  val = readl(GPIO1_GDIR);\n  val &= ~(1 << 3);\n  val |= (1 << 3);\n  writel(val, GPIO1_GDIR);\n\n  /* æ³¨å†Œè®¾å¤‡ */\n  if (led.major){\n    /* å¦‚æœäº‹å…ˆæŒ‡å®šäº†ä¸»è®¾å¤‡å· */\n    led.devid = MKDEV(led.major, 0);\n    register_chrdev_region(led.devid, LED_DEVICE_CNT, LED_DEVICE_NAME);\n  }else {\n    /* åŠ¨æ€åˆ†é… */\n    alloc_chrdev_region(&led.devid, 0, LED_DEVICE_CNT, LED_DEVICE_NAME);\n    led.major = MAJOR(led.devid);\n    led.minor = MINOR(led.devid);\n  }\n  printk(\"led register ok: major= %d, minor = %d\\r\\n\", led.major, led.minor);\n\n  /* åˆå§‹åŒ–Cdev */\n  led.cdev.owner = THIS_MODULE;\n  cdev_init(&led.cdev, &led_fops);\n\n  /* å‘å†…æ ¸æ³¨å†Œcdev */\n  retvalue = cdev_add(&led.cdev, led.devid, LED_DEVICE_CNT);\n  if (retvalue < 0){\n    printk(\"cdev add failed\\r\\n\");\n    return retvalue;\n  }\n\n  /* åˆ›å»ºè®¾å¤‡ç±» */\n  led.class = class_create(THIS_MODULE, LED_DEVICE_NAME);\n  if (IS_ERR(led.class)){\n    printk(\"class create failed\\r\\n\");\n    return PTR_ERR(led.class);\n  }\n\n  /* åˆ›å»ºè®¾å¤‡å®ä¾‹ */\n  led.device = device_create(led.class, NULL, led.devid, NULL, LED_DEVICE_NAME);\n  if (IS_ERR(led.device)){\n    printk(\"device create failed\\r\\n\");\n    return PTR_ERR(led.device);\n  }\n\n  return 0;\n}\n\n/* è®¾å¤‡å‡ºå£å‡½æ•° */\nstatic void __exit led_exit(void)\n{\n  /* é‡Šæ”¾å¯„å­˜å™¨æ˜ å°„ */\n  iounmap(IMX6U_CCM_CCGR1);\n  iounmap(SW_MUX_GPIO1_IO03);\n  iounmap(SW_PAD_GPIO1_IO03);\n  iounmap(GPIO1_DR);\n  iounmap(GPIO1_GDIR);\n\n  /* é”€æ¯cdevï¼Œæ³¨é”€è®¾å¤‡å· */\n  cdev_del(&led.cdev);\n  unregister_chrdev_region(led.devid, LED_DEVICE_CNT);\n\n  /* é”€æ¯è®¾å¤‡ç±»å’Œè®¾å¤‡å®ä¾‹ */\n  device_destroy(led.class, led.devid);\n  class_destroy(led.class);\n}\n\nmodule_init(led_init);\nmodule_exit(led_exit);\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"aki\");\n\n\n```","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"IMX6ULL Linuxå†…æ ¸ç§»æ¤","url":"/2025/03/11/Linuxå†…æ ¸ç§»æ¤/","content":"## å‡†å¤‡å·¥ä½œ\n### ç½‘ç»œè®¾ç½®\nå…³é—­ä¸»æœºçš„Ubuntuçš„é˜²ç«å¢™ï¼š\n```\nsudo ufw disable\n```\nç¡®è®¤VMWareä½¿ç”¨æ¡¥æ¥æ¨¡å¼ï¼Œä¸»æœºã€è™šæ‹Ÿæœºå’Œå¼€å‘æ¿ä¸‰è€…å¤„äºåŒä¸€ç½‘æ®µï¼Œå¦‚ï¼š\n- ä¸»æœºï¼š192.168.1.100\n- è™šæ‹Ÿæœºï¼š192.168.1.105\n- å¼€å‘æ¿ï¼š192.168.1.103 (DHCPè·å–)\n\nåœ¨ubootä¸‹ï¼Œå¼€å‘æ¿pingè™šæ‹Ÿæœºå’Œä¸»æœºã€è™šæ‹Ÿæœºpingä¸»æœºåº”å½“éƒ½èƒ½pingé€šã€‚æœªåŠ è½½Linuxå†…æ ¸å‰ç½‘å¡å°šæœªä½¿èƒ½ï¼Œè™šæ‹Ÿæœºpingå¼€å‘æ¿åº”å½“pingä¸é€šã€‚\n\n### TFTPæ­å»º\nTFTPå¸¸è§ç”¨é€”ï¼š\n- U-Boot åŠ è½½ Linux å†…æ ¸ã€è®¾å¤‡æ ‘å’Œæ ¹æ–‡ä»¶ç³»ç»Ÿ\n- NFS ç»“åˆ TFTP è¿›è¡Œç½‘ç»œå¯åŠ¨\n- å›ºä»¶æ›´æ–°\n- å¼€å‘è°ƒè¯•\n\nå®‰è£…xinetdï¼š\n```\nsudo apt install xinetd\n```\næ£€æŸ¥`/etc/xinetd.conf`æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š\n```\n# Simple configuration file for xinetd\n#\n# Some defaults, and include /etc/xinetd.d/\ndefaults\n{\n# Please note that you need a log_type line to be able to use log_on_success\n# and log_on_failure. The default is the following :\n# log_type = SYSLOG daemon info\n}\nincludedir /etc/xinetd.d\n```\næ–°å»ºTFTPç›®å½•äº`/home/aki/linux`ï¼Œç„¶å`chmod 777`è¯¥ç›®å½•ã€‚\n\nå®‰è£…tftp-hpaå’Œtftpd-hpaï¼š\n```\nsudo apt install tftp-hpa tftpd-hpa\n```\nå®‰è£…å®Œåï¼Œ`sudo nvim /etc/default/tftpd-hpa`ï¼Œä¿®æ”¹tftpç›®å½•ä¸ºTFTPæœåŠ¡å™¨å·¥ä½œç›®å½•ï¼š\n\n![TFTP_DIRECTORY](/images/linux/linux_1.png)\n\nç„¶å`sudo nvim /etc/xinetd.d/tftp`ï¼Œæ·»åŠ ï¼š\n```\nserver tftp\n {\n socket_type = dgram\n wait = yes\n disable = no\n user = root\n protocol = udp\n server = /usr/sbin/in.tftpd\n server_args = -s /home/aki/linux/tftp -c\n #log_on_success += PID HOST DURATION\n #log_on_failure += HOST\n per_source = 11\n cps =100 2\n flags =IPv4\n }\n```\nä¿å­˜ï¼Œé‡å¯TFTPæœåŠ¡ï¼š`sudo service tftpd-hpa restart`ï¼Œé‡å¯xinetdæœåŠ¡ï¼š`sudo service xinetd restart`\n\n### NFSæ­å»º\nNFSä¸»è¦ç”¨äºï¼š\n- åµŒå…¥å¼è®¾å¤‡çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆRootFSï¼‰æŒ‚è½½ï¼šåœ¨å¼€å‘é˜¶æ®µï¼ŒNFS æœåŠ¡å™¨å¯ä»¥å­˜æ”¾ æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆRootFSï¼‰ï¼ŒåµŒå…¥å¼è®¾å¤‡é€šè¿‡ç½‘ç»œç›´æ¥æŒ‚è½½ï¼Œè€Œæ— éœ€çƒ§å½•åˆ° Flash æˆ– SD å¡\n- è¿œç¨‹æ–‡ä»¶è®¿é—®ï¼šå¦‚å¼€å‘æ¿è®¿é—®PCå…±äº«ç›®å½•\n\nå®‰è£…NFSæœåŠ¡ï¼š\n```\nsudo apt install nfs-kernel-server\n```\næ–°å»ºNFSå…±äº«ç›®å½•å¹¶`chmod 777`ï¼š\n```\nsudo mkdir /home/aki/linux/nfs\nsudo chmod 777 /home/aki/linux/nfs\n```\nå®‰è£…å®Œåï¼Œ`sudo nvim /etc/exports`ï¼Œåœ¨æœ€åæ·»åŠ ï¼š\n```\n/home/aki/linux/nfs *(rw,sync,no_root_squash)\n```\nä¿å­˜é€€å‡ºï¼Œé‡å¯NFSæœåŠ¡ï¼š`sudo /etc/init.d/nfs-kernel-server restart`ï¼Œç¡®è®¤å…±äº«ç›®å½•å·²ç»é…ç½®å®Œæ¯•ï¼š`shouwmount -e`\n\n## Linuxé•œåƒæµ‹è¯•\nå…ˆç¡®è®¤å®˜æ–¹linuxé•œåƒæ˜¯å¦å¯ä»¥ã€‚åœ¨linuxæ ¹ç›®å½•ä¸­ï¼Œä¿®æ”¹é¡¶å±‚Makefileï¼Œæ·»åŠ `ARCH`å’Œ`CROSS_COMPILE`å˜é‡ï¼Œç„¶å\n```\nmake clean\nmake imx_v7_mfg_defconfig\n```\nç„¶å\n```\nmake -j16\n```\nmakeå®Œæˆåmakefileä¼šæç¤ºå¾—åˆ°ä¸¤ä¸ªé‡è¦çš„æ–‡ä»¶ï¼š\n- zImageï¼šlinuxå†…æ ¸é•œåƒï¼Œä½äº`/arch/arm/boot/`\n- imx6ull-14x14-evk.dtbï¼šç¼–è¯‘åçš„è®¾å¤‡æ ‘æ–‡ä»¶ï¼Œä½äº`/arch/arm/boot/dts/`\n\nç„¶åï¼Œå¯åŠ¨ubootï¼Œè®¾ç½®ubootä¸­çš„env`bootargs`ä¸ºï¼š\n```\nconsole=ttymxc0,115200 root=/dev/mmcblk 1p2 rootwait rw\n```\nè¡¨æ˜å°†ä»eMMC/SDå¡çš„ç¬¬2åˆ†åŒºå¯åŠ¨ Linuxã€‚ç„¶åï¼Œä¿®æ”¹`bootcmd`ï¼š\n```\nsetenv bootcmd 'tftp 80800000 zImage;tftp 83000000 imx6ull-14x14-evk.dtb;bootz 80800000 - 83000000`\n```\nè¡¨æ˜å°†é€šè¿‡TFTPä»è™šæ‹Ÿæœºæ‹‰å–å†…æ ¸é•œåƒå’Œè®¾å¤‡æ ‘å¹¶å¯åŠ¨å†…æ ¸ã€‚ç„¶åï¼Œ`boot`ï¼Œå¯åŠ¨å†…æ ¸ã€‚\n\n\n## é…ç½®ä¸»é¢‘ã€EMMCå’Œç½‘ç»œé©±åŠ¨\n### ä¸»é¢‘è®¾ç½®\nWIP\n\n### EMMCè®¾ç½®\n6.6ç‰ˆæœ¬çš„Kernelå·²ç»é»˜è®¤ç¦ç”¨1.8Vä¾›ç”µï¼ŒåŒæ—¶è‡ªåŠ¨å¯ç”¨äº†8ä½å®½çš„EMMCæ€»çº¿ï¼Œæ‰€ä»¥ä¸ç”¨è¿›è¡Œå…¶ä»–çš„è®¾ç½®ã€‚\n\n### ç½‘ç»œé©±åŠ¨\nå’Œubootä¸­è¿›è¡Œè¿‡çš„å¾ˆåƒã€‚å·²çŸ¥NXPåŸç‰ˆè®¾å¤‡æ ‘ä¸­çš„SPI4èŠ‚ç‚¹ä¸­çš„ä¸¤ä¸ªå¼•è„šå’ŒSR8201Fçš„å†²çªï¼Œå› æ­¤æ‰“å¼€`/arch/arm/boot/dts/nxp/imx/imx6ul-14x14-evk.dtsi`è¿™ä¸ªåº•å±‚è®¾å¤‡æ ‘ï¼Œæ‰¾åˆ°`pinctrl_spi4: spi4grp`è¿™ä¸ªèŠ‚ç‚¹ï¼Œåˆ æ‰åŒ…å«`GPIO5 7`å’Œ`GPIO5 8`çš„ä¸¤è¡Œã€‚ç„¶åå‰å¾€`SPI4`çš„å­èŠ‚ç‚¹ï¼ŒæŠŠstatusæ”¹æˆ`disable`ï¼Œç›´æ¥ç¦ç”¨æ‰SPI4ã€‚\n\nç„¶åï¼Œä¿®æ”¹pinctrlå¤ç”¨ä¿¡æ¯ï¼Œæ¥åˆ°`&iomuxc`èŠ‚ç‚¹ï¼Œåœ¨èŠ‚ç‚¹æœ«å°¾æ–°å¢ä¸¤ä¸ª`pinctrl group`ï¼š\n```\npinctrl_enet1_reset: enet1resetgrp {\n    fsl,pins = <\n        /* used for enet1 reset */\n        MX6ULL_PAD_SNVS_TAMPER7__GPIO5_IO07 0x10B0 \n    >;\n};\n\npinctrl_enet2_reset: enet2resetgrp {\n    fsl,pins = <\n        /* used for enet2 reset */\n        MX6ULL_PAD_SNVS_TAMPER8__GPIO5_IO08 0x10B0 \n    >;\n};\n```\næŒ‰ç…§æ­¥éª¤è¿˜éœ€è¦ä¿®æ”¹ENET1å’ŒENET2çš„ç½‘ç»œæ—¶é’Ÿå¼•è„šé…ç½®ï¼Œä½†æ˜¯6.6ç‰ˆæœ¬çš„kernelè®¾å¤‡æ ‘å·²ç»æ·»åŠ äº†ï¼Œå°±ä¸ç”¨æ‰‹åŠ¨æ“ä½œäº†ã€‚\n\nç»§ç»­ï¼Œåœ¨`fec1`å’Œ`fec2`èŠ‚ç‚¹é‡ŒåŠ å…¥åˆšåˆšè®¾ç½®å¥½çš„å¤ä½å¼•è„šçš„`pinctrl group`ä¿¡æ¯ï¼š\n```\n&fec1 {\n    .....\n    pinctrl-0 = <&pinctrl_enet1\n                 &pinctrl_enet1_reset>;\n    .....\n}\n\n&fec2 {\n    .....\n    pinctrl-0 = <&pinctrl_enet2\n                 &pinctrl_enet2_reset>;\n    .....\n}\n```\nç»§ç»­ï¼Œæ£€æŸ¥è®¾å¤‡æ ‘`fec1`å’Œ`fec2`èŠ‚ç‚¹ä¸‹`mdio`å­èŠ‚ç‚¹ä¸­çš„PHYåœ°å€æ˜¯å¦æ­£ç¡®ã€‚æ–°ç‰ˆkernelé»˜è®¤éƒ½æ˜¯è®¾ç½®å¥½çš„ã€‚\n\nç„¶åï¼Œåœ¨`defconfig`é‡Œå‘ŠçŸ¥kernelä½¿ç”¨realtekçš„PHYé©±åŠ¨ï¼š\n```\nCONFIG_REALTEK_PHY=y\n```\n\næœ€åï¼Œæ ¹æ®SR8201Få¤ä½åè‡³å°‘å»¶æ—¶150msæ‰èƒ½å¼€å§‹ä½¿ç”¨çš„è¦æ±‚ï¼Œä¿®æ”¹`drivers/net/ethernet/freescale/fec_main.c`ï¼Œåœ¨`static void fec_reset_phy()`å‡½æ•°çš„æœ«å°¾åŠ å…¥:\n```\nmsleep(200);\n```\né‡æ–°ç¼–è¯‘kernelï¼Œç„¶åå¯åŠ¨ï¼Œé€šè¿‡`ifconfig`è§‚å¯Ÿç½‘å¡æ˜¯å¦å·¥ä½œæ­£å¸¸ï¼ˆæ­£å¸¸æƒ…å†µä¸‹ETH1ä¼šè‡ªåŠ¨å¯åŠ¨ï¼‰ï¼š\n```\nifconfig eth0 up    //å¯åŠ¨ETH0ç½‘å¡\nifconfig eth1 up    //å¯åŠ¨ETH1ç½‘å¡\nifconfig eth0 192.168.xx.xx\nifconfig eth1 192.168.xx.xx\n```\n\n## æ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ\nä½¿ç”¨busyboxæ„å»ºï¼Œåœ¨busyboxæ ¹ç›®å½•çš„é¡¶å±‚Makefileä¸­æ·»åŠ `ARCH`å’Œ`CORSS_COMPILE`ï¼Œç„¶åï¼š\n```\nmake defconfig\nmake menuconfig\n```\nè¿›å…¥å›¾å½¢åŒ–é…ç½®ç•Œé¢ï¼š\n- é€‰ä¸­Settings->Build static binary\n- é€‰ä¸­Setttings->vi-style line editing commands\n- å–æ¶ˆé€‰ä¸­Linux Module Utilities->Simpilified modutils\n\nç¼–è¯‘busyboxæ—¶å¿…é¡»ä½¿ç”¨é™æ€åº“ï¼ŒåŠ¨æ€åº“ä¼šç¼ºåº“æ–‡ä»¶å¯¼è‡´dnsè§£ææ²¡æ³•æ­£å¸¸ä½¿ç”¨ã€‚\n\nç„¶åï¼Œ\n```\nmake \nmake install CONFIG_PREFIX=/home/aki/linux/nfs/rootfs\n```\n*æ³¨æ„*ï¼š1.37.0ç‰ˆæœ¬busyboxæŠ¥å‘Šæœ‰ä¸€ä¸ªbugï¼Œå³ï¼š\n```\ncompilation\nof tc.c fails with: \n\nnetworking/tc.c: In function â€˜cbq_print_optâ€™:\nnetworking/tc.c:236:27: error: â€˜TCA_CBQ_MAXâ€™ undeclared (first use in this\nfunction); did you mean â€˜TCA_CBS_MAXâ€™?\n  236 |         struct rtattr *tb[TCA_CBQ_MAX+1];\n      |                           ^~~~~~~~~~~\n      |                           TCA_CBS_MAX\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n```\nå’ŒCBQé˜Ÿåˆ—ç®¡ç†æœ‰å…³çš„å¤§é‡å®ä¼šæŠ¥é”™ï¼Œè§£å†³æ–¹æ³•æ˜¯æŠŠ`tc.c`ä»`/busybox/networking`æ–‡ä»¶å¤¹é‡Œåˆ é™¤ã€‚\n\nç„¶åï¼Œéœ€è¦å°†ç¼–è¯‘å™¨æ‰€åŒ…å«çš„åº“æ–‡ä»¶å…¨éƒ¨æ‰“åŒ…åˆ°æ ¹ç›®å½•ä¸‹ã€‚\n\nä½¿ç”¨NFSæŒ‚è½½æ—¶ï¼Œbootargsè¦è®¾æˆï¼š\n```\nsetenv bootargs 'console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.1.105:/home/aki/linux/nfs/rootfs,vers=3,proto=tcp rw ip=192.168.1.103:192.168.1.105:192.168.1.1:255.255.255.0::eth0:off'\n```\n*æ³¨æ„*ï¼šè¿™é‡Œé€šè¿‡`vers=3`å¼ºåˆ¶ä½¿ç”¨NFS v3ç‰ˆæœ¬ï¼Œå¦åˆ™ä¼šæŒ‚è½½å¤±è´¥ã€‚\n\n\nå¦‚æœç¢°åˆ°hotplugï¼šcanâ€™t create /proc/sys/kernel/hotplug: nonexistent directoryé—®é¢˜ï¼š[å‚è§](https://blog.csdn.net/m0_51149752/article/details/146395215?spm=1001.2014.3001.5502)\n\n`fstab`è¦åŠ ä¸€è¡Œï¼š\n```\nmdev  /dev  ramfs defaults 0 0\n```","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"NXP å®˜æ–¹u-bootç§»æ¤å’Œå¯åŠ¨è¿‡ç¨‹","url":"/2025/03/07/ubootç§»æ¤/","content":"## å®˜æ–¹U-Bootä¸‹è½½\n[Github](https://github.com/nxp-imx/uboot-imx)\nä¸‹è½½åæ‹·è´`tar.bz2`è‡³Linuxï¼Œç„¶å`tar -vxjf`\n\n## U-bootå·¥ç¨‹ç›®å½•\n![ç¼–è¯‘åçš„ubootæºç ](/images/linux/uboot_7.png)\né™¤äº†æ–‡ä»¶å¤¹ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ–‡ä»¶ï¼š\n![ç¼–è¯‘åçš„ubootæºç ](/images/linux/uboot_8.png)\n\n## éªŒè¯defconfig\n`cd /configs/`ï¼Œç¡®è®¤å­˜åœ¨æœ‰I.MX6ULLçš„é…ç½®æ–‡ä»¶ï¼š\n\n![mx6ullé…ç½®æ–‡ä»¶](/images/linux/uboot_1.png)\n\næ–°ç‰ˆæœ¬ubootä¸­`mx6ull_14x14_evk_defconfig`ç”¨äºä¼ ç»Ÿçš„éå®‰å…¨å¯åŠ¨ï¼ˆNon-Secure Bootï¼‰æ¨¡å¼ï¼Œè€Œ`mx6ull_14x14_evk_plugin_defconfig`æ”¯æŒå®‰å…¨å¯åŠ¨ï¼ˆSecure Bootï¼‰ï¼Œå…è®¸ U-Boot åœ¨ ROM åŠ è½½é˜¶æ®µæ‰§è¡Œè‡ªå®šä¹‰ä»£ç ï¼Œé€šå¸¸ç”¨äº HAB å®‰å…¨å¯åŠ¨åˆå§‹åŒ–ï¼ˆå¦‚ DRAM è®­ç»ƒï¼‰ã€‚é€šå¸¸ä½¿ç”¨å‰è€…å³å¯ã€‚\n\n## æ·»åŠ å˜é‡è‡³é¡¶å±‚Makefile\nåœ¨ubootæ ¹ç›®å½•ä¸‹çš„é¡¶å±‚Makefileä¸­æ·»åŠ ï¼š\n```\nARCH=arm\nCROSS_COMPILE=arm-linux-gnueabihf-\n```\n\n## ç¼–å†™makeç”¨Shellï¼Œç¼–è¯‘\n1. `touch mx6ull_14x14_evk.sh`\n2. \n```\n#!/bin/bash\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- mx6ull_14x14_evk_emmc_defconfig\nmake V=1 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16\n```\n3. `chmod 777 mx6ull_14x14_evk.sh`\n4. `./mx6ull_14x14_evk.sh`ï¼Œç¼–è¯‘\n\nè¿™é‡Œç”¨çš„ubootæ˜¯NXPæœ€æ–°çš„åˆ†æ”¯`v2022.04`ï¼Œè¿™ä¸ªubootç‰ˆæœ¬æ¯”è¾ƒæ–°ï¼Œå¦‚æœç”¨è€ç‰ˆæœ¬çš„äº¤å‰ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒæ¯”è¾ƒæ–°çš„è¯­æ³•ã€‚è¿™é‡Œä½¿ç”¨çš„ubootã€kernelå’Œç¼–è¯‘å™¨çš„ç‰ˆæœ¬éƒ½ä¸ºï¼š\n- ubootï¼š`v2022.04`\n- kernelï¼š`if 6.6y`\n- arm-linux-gnueabihf-gcc: `7.5.0`\n\nç¼–è¯‘å®Œæˆåï¼Œ`imxdownload`çƒ§å½•è‡³SDå¡ï¼Œè®¾ç½®å¼€å‘æ¿ä»SDå¡å¯åŠ¨ã€‚\n\næ­¤æ—¶Ubootå¯åŠ¨ä¹‹åï¼Œç”±äºLCDæœªåšé…ç½®ï¼ŒLCDä¸Šæ˜¯ä¸ä¼šæ˜¾ç¤ºNXPçš„Logoçš„ã€‚ä¸‹ä¸€æ­¥æ˜¯ä¿®æ”¹LCDé©±åŠ¨ã€‚\n\n## ä¿®æ”¹LCDé©±åŠ¨\nIOéƒ¨åˆ†ä¸ç”¨ä¿®æ”¹ï¼Œå®˜æ–¹å’Œå¼€å‘æ¿ä¸€è‡´ï¼Œä»…éœ€ä¿®æ”¹å‚æ•°ã€‚è¾ƒè€ç‰ˆæœ¬çš„LCDå‚æ•°åœ¨`board/freescale/mx6ull_aki/mx6ull_14x14_evk_emmc.c`çš„`display_info_t`ç»“æ„ä½“é‡Œã€‚ä½†æ˜¯æ–°ç‰ˆæœ¬ubootå…¨éƒ¨æŠŠè¯¸å¦‚LCDä¹‹ç±»çš„å¤–è®¾é…ç½®å‚æ•°å…¨éƒ¨ç§»åˆ°äº†è®¾å¤‡æ ‘ä¸­ã€‚å¹¶ä¸”ï¼Œimx6ullæ˜¯ç”±imx6ulè¿™å—æ¿å­æ‹“å±•è€Œæ¥çš„ï¼ŒäºŒè€…çš„è®¾å¤‡æ ‘ä¹Ÿå‘ˆéå¸¸æ˜æ˜¾çš„å±‚æ¬¡å…³ç³»ï¼Œå³å…ˆè¯»imx6ulçš„è®¾å¤‡æ ‘ï¼Œå†è¯»imx6ullçš„ï¼Œæ‰€ä»¥å¾ˆå¤šå¤–è®¾èŠ‚ç‚¹éƒ½åœ¨`/arch/arm/dts/imx6ul-14x14-evk.dtsi`è¿™ä¸ªè®¾å¤‡æ ‘æ–‡ä»¶ä¸­å®šä¹‰ã€‚\n\næ‰“å¼€è¯¥è®¾å¤‡æ ‘æ–‡ä»¶ï¼Œæ‰¾åˆ°ï¼š\n```\n&lcdif {\n\tpinctrl-names = \"default\";\n\tpinctrl-0 = <&pinctrl_lcdif_dat\n\t\t     &pinctrl_lcdif_ctrl>;\n\n\tdisplay = <&display0>;\n\tstatus = \"okay\";\n\n\tdisplay0: display@0 {\n\t\tbits-per-pixel = <24>;\n\t\tbus-width = <24>;\n\n\t\tdisplay-timings {\n\t\t\tnative-mode = <&timing0>;\n\t\t\ttiming0: timing0 {\n\t\t\tclock-frequency = <51200000>;\t//åƒç´ æ—¶é’Ÿé¢‘ç‡ï¼ŒHz\n\t\t\thactive = <1024>;\t\t//æ°´å¹³å¯è§åƒç´ æ•°ï¼ˆæ°´å¹³åˆ†è¾¨ç‡ï¼‰\n\t\t\tvactive = <600>;\t\t//å‚ç›´å¯è§åƒç´ æ•°ï¼ˆå‚ç›´åˆ†è¾¨ç‡ï¼‰\n\t\t\thfront-porch = <160>;\t//æ°´å¹³å‰è‚©ï¼ŒHFP\n\t\t\thback-porch = <140>;\t//æ°´å¹³åè‚©ï¼ŒHBP\n\t\t\thsync-len = <20>;\t\t//æ°´å¹³åŒæ­¥è„‰å†²ï¼ŒHSPW\n\t\t\tvback-porch = <20>;\t\t//æ°´å¹³åè‚©ï¼ŒVBP\n\t\t\tvfront-porch = <12>;\t//æ°´å¹³å‰è‚©ï¼ŒVFP\n\t\t\tvsync-len = <3>;\t\t//å‚ç›´åŒæ­¥è„‰å†²ï¼ŒVSPW\n\n\t\t\thsync-active = <0>;\t\t//æ°´å¹³åŒæ­¥ä¿¡å·ææ€§\n\t\t\tvsync-active = <0>;\t\t//å‚ç›´åŒæ­¥ä¿¡å·ææ€§\n\t\t\tde-active = <1>;\t\t//æ•°æ®ä½¿èƒ½ï¼Œé«˜ç”µå¹³æœ‰æ•ˆ\n\t\t\tpixelclk-active = <0>;\t//ä¸‹é™æ²¿é‡‡æ ·\n\t\t\t};\n\t\t};\n\t};\n};\n```\næŒ‰æ³¨é‡Šä¿®æ”¹å³å¯ã€‚æ–°ç‰ˆè®¾å¤‡æ ‘ä¼¼ä¹æ²¡æœ‰å®šä¹‰LCDåå­—çš„åœ°æ–¹ï¼Œæ„Ÿè§‰ä¸æ˜¯é‚£ä¹ˆåœ¨æ„è®¾å¤‡åï¼Œæ¯•ç«Ÿéƒ½ç”¨è®¾å¤‡æ ‘äº†ã€‚\n\n## è”ç½‘\n### ä¸»æœºéƒ¨åˆ†\nç‰©ç†éƒ¨åˆ†ï¼šè·¯ç”±å™¨WANè¿æ¥æ ¡å›­ç½‘ï¼ŒLAN1æ¥ç”µè„‘ï¼ŒLAN2æ¥å¼€å‘æ¿ENET2ï¼ˆç½‘å¡1ï¼‰ã€‚\n\nVMwareéœ€å¼€å¯æ¡¥æ¥æ¨¡å¼ï¼š\n![æ¡¥æ¥æ¨¡å¼](/images/linux/uboot_5.png)\n\nè™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ä¸­ä¸€èˆ¬ä¼šè‡ªåŠ¨è®¾ç½®æ¡¥æ¥ç½‘å¡ï¼Œä¸ç”¨æ‰‹åŠ¨è®¾ç½®ã€‚æ¡¥æ¥æ¨¡å¼ä¸‹è™šæ‹Ÿæœºå’Œç‰©ç†ä¸»æœºä¸€æ ·å­˜åœ¨äºå±€åŸŸç½‘ä¸­ï¼Œå¯ä»¥å’Œä¸»æœºç›¸é€šï¼Œå’Œäº’è”ç½‘ç›¸é€šï¼Œå’Œå±€åŸŸç½‘ä¸­å…¶å®ƒä¸»æœºç›¸é€šã€‚\n\né…ç½®æˆæ¡¥æ¥æ¨¡å¼åè™šæ‹Ÿæœºçš„IPã€ç½‘å…³ã€DNSã€netmaskç­‰å…¨éƒ¨ä¼šè‡ªåŠ¨é…ç½®ã€‚åœ¨è™šæ‹Ÿæœºä¸­`ifconfig`ï¼š\n```\nens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.1.105  netmask 255.255.255.0  broadcast 192.168.1.255\n        ether 00:0c:29:0d:4a:09  txqueuelen 1000  (ä»¥å¤ªç½‘)\n        RX packets 4642  bytes 4241810 (4.2 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 2980  bytes 400799 (400.7 KB)\n        TX errors 0  dropped 5 overruns 0  carrier 0  collisions 0\n\nlo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536\n        inet 127.0.0.1  netmask 255.0.0.0\n        inet6 ::1  prefixlen 128  scopeid 0x10<host>\n        loop  txqueuelen 1000  (æœ¬åœ°ç¯å›)\n        RX packets 1298  bytes 110055 (110.0 KB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 1298  bytes 110055 (110.0 KB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n```\næ­¤æ—¶ä¸»æœºçš„IPv4åœ°å€ä¸º192.168.1.100ï¼Œå¯ä»¥çœ‹åˆ°æ¡¥æ¥æ¨¡å¼å·²ç»ç”Ÿæ•ˆï¼Œä¸»æœºå’Œè™šæ‹Ÿæœºå¤„äºåŒä¸€ä¸ªç½‘æ®µä¸‹ã€‚\n\n### æ¿çº§éƒ¨åˆ†\nå®˜æ–¹çš„NXP IMX6ULL EVKå¼€å‘æ¿ä½¿ç”¨çš„ä¸æ˜¯LAN8720Aè¿™ä¸ªICï¼Œå› æ­¤éœ€è¦ä¿®æ”¹ä¸€ç³»åˆ—è®¾ç½®ã€‚å¥½åœ¨å®˜æ–¹çš„æ¿å­å’Œæ­£ç‚¹åŸå­é˜¿å°”æ³•å¼€å‘æ¿çš„PHYç‰©ç†åœ°å€æ˜¯ä¸€è‡´çš„ï¼Œè¿™ç‚¹ä»è®¾å¤‡æ ‘é‡Œå¯ä»¥çœ‹åˆ°ï¼š\n```\n&fec1 {\n\tpinctrl-names = \"default\";\n\tpinctrl-0 = <&pinctrl_enet1>;\n\tphy-mode = \"rmii\";\n\tphy-handle = <&ethphy0>;\n  phy-reset-gpios = <&gpio5 7 GPIO_ACTIVE_LOW>;\n  phy-reset-duration = <100>;\n  phy-reset-post-delay = <100>;\n\tstatus = \"disable\";\n};\n\n&fec2 {\n\tpinctrl-names = \"default\";\n\tpinctrl-0 = <&pinctrl_enet2>;\n\tphy-mode = \"rmii\";\n\tphy-handle = <&ethphy1>;\n  phy-reset-gpios = <&gpio5 8 GPIO_ACTIVE_LOW>;\n  phy-reset-duration = <100>;\n  phy-reset-post-delay = <100>;\n\tstatus = \"okay\";\n\n\tmdio {\n\t\t#address-cells = <1>;\n\t\t#size-cells = <0>;\n\n\t\tethphy0: ethernet-phy@2 {\n\t\t\treg = <2>;\t//PHY0ç‰©ç†åœ°å€ä¸º2\n\t\t\tmicrel,led-mode = <1>;\n\t\t\tclocks = <&clks IMX6UL_CLK_ENET_REF>;\n\t\t\tclock-names = \"rmii-ref\";\n\t\t};\n\n\t\tethphy1: ethernet-phy@1 {\n\t\t\treg = <1>;\t//PHY1ç‰©ç†åœ°å€ä¸º1\n\t\t\tmicrel,led-mode = <1>;\n\t\t\tclocks = <&clks IMX6UL_CLK_ENET2_REF>;\n\t\t\tclock-names = \"rmii-ref\";\n\t\t};\n\t};\n};\n```\n### åˆå§‹åŒ–æ£€æŸ¥\næ£€æŸ¥`/common/board_r.c`ï¼Œå…¶ä¸­ä»ç½‘ç»œåˆå§‹åŒ–å…¥å£`initr_net`å¼€å§‹Ubootä¼šè¿›è¡Œç½‘ç»œè®¾ç½®ï¼Œå…¶ä¸­`initr_net`ä¼šè°ƒç”¨`eth_initialize()`è¿›è¡Œç½‘ç»œåˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨`reset_phy()`å¯¹PHYè¿›è¡Œå¤ä½ï¼Œè€Œ`phy_init()`ä¸­æœ‰ä»¥ä¸‹æ¡ä»¶å®è¯­å¥ï¼š\n```\nint phy_init(void)\n{\n...\n#ifdef CONFIG_PHY_MICREL_KSZ8XXX\n    phy_micrel_ksz8xxx_init();\n#endif \n#ifdef CONFIG_PHY_MICREL_KSZ90X1\n    phy_micrel_ksz90x1_init();\n#endif\n...\n#ifdef CONFIG_PHY_SMSC\n    phy_smsc_init();\n#endif\n...\n    genphy_init();\n \n    return 0;\n}\n```\næ˜¾ç„¶è¿™æ˜¯æ ¹æ®`defconfig`é‡Œçš„é”®å€¼æ¥å¯¹åº”ä¸åŒçš„PHYåˆå§‹åŒ–å‡½æ•°ã€‚é˜¿å°”æ³•å¼€å‘æ¿ä¸Šçš„SR8201Fæ˜¯Realtekå…¬å¸ç”Ÿäº§çš„ï¼Œå› æ­¤æ ¹æ®`phy_init`ï¼Œ`defconfig`é‡Œè¦è®¾ç½®`CONFIG_PHY_REALTEK=y`æ‰ä¼šè§¦å‘`phy_realtek_init()`è¿™ä¸ªå‡½æ•°ã€‚\n\næ‰“å¼€`/configs/imx6ull_14x14_evk_emmc_defconfig`ï¼Œåˆ é™¤æˆ–å±è”½ï¼š\n```\nCONFIG_PHY_MICREL=y\nCONFIG_PHY_MICREL_KSZ8XXX=y\n```\næ·»åŠ ï¼š\n```\nCONFIG_PHY_REALTEK=y\n```\nï¼ˆä¸è¿‡è¿™é‡Œæˆ‘ä¸€å¼€å§‹é”™è¯¯çš„æ”¹æˆäº†`CONFIG_PHY_SMSC=y`ï¼Œå‘ç°ç½‘ç»œä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰\n### é…ç½®fecå¤ä½ç®¡è„š\n`fecmxc_probe`å‡½æ•°ä¸­è¿˜è°ƒç”¨äº†`fec_gpio_reset()`æ¥å¤ä½fecç½‘å¡ï¼š\n```\n#if CONFIG_IS_ENABLED(DM_GPIO)\n\tfec_gpio_reset(priv);\n#endif\n\t/* Reset chip. */\n\twritel(readl(&priv->eth->ecntrl) | FEC_ECNTRL_RESET,\n\t       &priv->eth->ecntrl);\n\tstart = get_timer(0);\n\twhile (readl(&priv->eth->ecntrl) & FEC_ECNTRL_RESET) {\n\t\tif (get_timer(start) > (CONFIG_SYS_HZ * 5)) {\n\t\t\tprintf(\"FEC MXC: Timeout resetting chip\\n\");\n\t\t\tgoto err_timeout;\n\t\t}\n\t\tudelay(10);\n\t}\n```\nè€Œè¿™é‡Œè®¾å¤‡æ ‘ä¼šä½¿ç”¨`fecmxc_of_to_plat`è¿™ä¸ªOFå‡½æ•°æ¥è¯»å–èŠ‚ç‚¹ä¿¡æ¯åˆ°é©±åŠ¨ï¼Œè¯¥å‡½æ•°ä¸­æœ‰ï¼š\n```\n#if CONFIG_IS_ENABLED(DM_GPIO)\n\tret = gpio_request_by_name(dev, \"phy-reset-gpios\", 0,\n\t\t\t\t   &priv->phy_reset_gpio, GPIOD_IS_OUT);\n\tif (ret < 0)\n\t\treturn 0; /* property is optional, don't return error! */\n\n\tpriv->reset_delay = dev_read_u32_default(dev, \"phy-reset-duration\", 1);\n\tif (priv->reset_delay > 1000) {\n\t\tprintf(\"FEC MXC: phy reset duration should be <= 1000ms\\n\");\n\t\t/* property value wrong, use default value */\n\t\tpriv->reset_delay = 1;\n\t}\n\n\tpriv->reset_post_delay = dev_read_u32_default(dev,\n\t\t\t\t\t\t      \"phy-reset-post-delay\",\n\t\t\t\t\t\t      0);\n\tif (priv->reset_post_delay > 1000) {\n\t\tprintf(\"FEC MXC: phy reset post delay should be <= 1000ms\\n\");\n\t\t/* property value wrong, use default value */\n\t\tpriv->reset_post_delay = 0;\n\t}\n#endif\n```\nå¯ä»¥çœ‹åˆ°è¿™é‡Œä¾èµ–èŠ‚ç‚¹çš„ä¸‰ä¸ªç”¨äºæè¿°å¤ä½çš„å€¼ï¼š\n- `phy-reset-gpios`\n- `phy-reset-duration`\n- `phy-reset-post-delay`\n\nå›åˆ°è®¾å¤‡æ ‘ï¼Œå°†è¿™ä¸‰ä¸ªå±æ€§åŠ è¿›èŠ‚ç‚¹ï¼š\n```\n&fec1 {\n\tpinctrl-names = \"default\";\n\tpinctrl-0 = <&pinctrl_enet1>;\n\tphy-mode = \"rmii\";\n\tphy-handle = <&ethphy0>;\n    phy-reset-gpios = <&gpio5 7 GPIO_ACTIVE_LOW>;\n    phy-reset-duration = <100>;\n    phy-reset-post-delay = <100>;\n\tstatus = \"disable\";\n};\n\n&fec2 {\n\tpinctrl-names = \"default\";\n\tpinctrl-0 = <&pinctrl_enet2>;\n\tphy-mode = \"rmii\";\n\tphy-handle = <&ethphy1>;\n    phy-reset-gpios = <&gpio5 8 GPIO_ACTIVE_LOW>;\n    phy-reset-duration = <100>;\n    phy-reset-post-delay = <100>;\n\tstatus = \"okay\";\n\n\tmdio {\n\t\t#address-cells = <1>;\n\t\t#size-cells = <0>;\n\n\t\tethphy0: ethernet-phy@2 {\n\t\t\treg = <2>;\n\t\t\tmicrel,led-mode = <1>;\n\t\t\tclocks = <&clks IMX6UL_CLK_ENET_REF>;\n\t\t\tclock-names = \"rmii-ref\";\n\t\t};\n\n\t\tethphy1: ethernet-phy@1 {\n\t\t\treg = <1>;\n\t\t\tmicrel,led-mode = <1>;\n\t\t\tclocks = <&clks IMX6UL_CLK_ENET2_REF>;\n\t\t\tclock-names = \"rmii-ref\";\n\t\t};\n\t};\n};\n```\n`GPIO5_IO07`å’Œ`GPIO5_IO08`ä¼šè·ŸSPI4çš„ä¸¤ä¸ªIOå†²çªï¼Œè¿™é‡Œç›´æ¥æŠŠspi4 disableæ‰å³å¯ã€‚é€šå¸¸ubootä¼šè‡ªåŠ¨åŠ è½½fec2ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘æŠŠfec1ä¹Ÿdisableäº†ã€‚\n\næœ€åï¼Œè¿˜éœ€è¦åœ¨`/drviers/net/phy`ä¸­ï¼Œæ‰¾åˆ°`genphy_config_aneg`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£PHYè‡ªåå•†çš„å®Œæ•´é…ç½®ï¼Œåœ¨åˆå§‹åŒ–PHYæ—¶ä¼šè°ƒç”¨ï¼ˆé€šè¿‡æ“ä½œ`BMCR_RESET`ä½ï¼‰ã€‚åœ¨å‡½æ•°ä¸­åŠ å…¥ï¼š\n```\nint genphy_config_aneg(struct phy_device *phydev)\n{\n\tint result;\n  \n  /* Soft reset */\n  phy_reset(phydev);\n  mdelay(150);\t//ICè¦æ±‚å¤ä½åå»¶æ—¶150ms\n\n  ......\n}\n```\n\n### ubootè®¾ç½®\nåœ¨ubootå†…è®¾ç½®å¼€å‘æ¿ç½‘ç»œé…ç½®ï¼š\n```\nsetenv ipaddr 192.168.1.55\nsetenv ethaddr b8:ae:1d:01:00:00\nsetenv gatewayip 192.168.1.1\nsetenv netmask 255.255.255.0\nsetenv serverip 192.168.1.105   # Ubuntu IP\n```\nç„¶å`saveenv`ï¼Œä¿å­˜å˜é‡ã€‚\n\nubootæ”¯æŒè‡ªåŠ¨é…ç½®ç‰©ç†åœ°å€ï¼Œåªéœ€è¦åœ¨defconfigä¸­åŠ å…¥ï¼š`CONFIG_NET_RANDOM_ETHADDR=y`\n\nå¦‚æœå¯¹é™æ€IPæ²¡æœ‰è¦æ±‚ï¼Œæˆ–è€…æƒ³è¦ç®€å•ä¸€ç‚¹ï¼Œå¯ä»¥ç›´æ¥åœ¨Ubootå†…ä½¿ç”¨`DHCP`å‘½ä»¤ã€‚DHCPä¼šè‡ªåŠ¨ç”³è¯·å¯ç”¨IPï¼Œè‡ªåŠ¨é…ç½®ç½‘å…³ã€DNSã€å­ç½‘æ©ç ç­‰ã€‚\n\næ­¤æ—¶åœ¨Ubootå†…ping è™šæ‹Ÿæœºåœ°å€`192.168.1.105`ï¼Œåº”å½“æ˜¯èƒ½Pingé€šçš„ã€‚ä¸ºé˜²æ­¢IPè¢«å¤ç”¨ï¼Œå…³é—­è™šæ‹Ÿæœºï¼Œå†Pingä¸€æ¬¡è™šæ‹Ÿæœºï¼Œå¦‚æœæ— æ³•Pingé€šï¼Œè¯´æ˜é…ç½®æ­£ç¡®ï¼š\n![Pingæµ‹è¯•](/images/linux/uboot_6.png)\n\nåè¿‡æ¥ï¼Œä»è™šæ‹ŸæœºPingå¼€å‘æ¿ï¼Œè‚¯å®šæ˜¯Pingä¸é€šçš„ï¼ˆPingé€šäº†è¯´æ˜æœ‰é—®é¢˜ï¼Œè¿™ä¸ªIPè¢«å…¶ä»–çš„ä»€ä¹ˆä¸œè¥¿å¤ç”¨äº†ï¼‰ï¼Œå› ä¸ºæ­¤æ—¶Linuxå†…æ ¸è¿˜æœªå¯åŠ¨ï¼Œç½‘å£ä¸ä¼šè¢«ä½¿èƒ½ã€‚\n\næ­¤æ—¶ï¼Œä¸‰å°æœºå™¨çš„IPåœ°å€åˆ†åˆ«ä¸ºï¼š\n- ä¸»æœºï¼š192.168.1.100\n- è™šæ‹Ÿæœºï¼š192.168.1.105\n- å¼€å‘æ¿ï¼š192.168.1.101(DHCPè·å–)\n\n## ubootå¯åŠ¨æµç¨‹\n### resetå‡½æ•°\nubootç¼–è¯‘åä¼šåœ¨æ ¹ç›®å½•ä¸‹ç”Ÿæˆé“¾æ¥è„šæœ¬`u-boot.lds`ã€‚å…¶å†…å®¹çš„å‰å‡ è¡Œé‡Œæœ‰ï¼š\n```\nOUTPUT_FORMAT(\"elf32-littlearm\", \"elf32-littlearm\", \"elf32-littlearm\")\nOUTPUT_ARCH(arm)\nENTRY(_start)\nSECTIONS\n{\n    ........\n```\nå¾ˆæ˜¾ç„¶ç¬¬3è¡Œçš„`ENTRY(_start)`ä¸­çš„`_start`æ˜¯ä»£ç å…¥å£ç‚¹ï¼Œåœ¨`arch/arm/lib/vectors.S`ä¸­å®šä¹‰ï¼š\n```\n/*\n *  vectors - Generic ARM exception table code\n *\n *  Copyright (c) 1998\tDan Malek <dmalek@jlc.net>\n *  Copyright (c) 1999\tMagnus Damm <kieraypc01.p.y.kie.era.ericsson.se>\n *  Copyright (c) 2000\tWolfgang Denk <wd@denx.de>\n *  Copyright (c) 2001\tAlex ZÃ¼pke <azu@sysgo.de>\n *  Copyright (c) 2001\tMarius GrÃ¶ger <mag@sysgo.de>\n *  Copyright (c) 2002\tAlex ZÃ¼pke <azu@sysgo.de>\n *  Copyright (c) 2002\tGary Jennejohn <garyj@denx.de>\n *  Copyright (c) 2002\tKyle Harris <kharris@nexus-tech.net>\n *\n * SPDX-License-Identifier:\tGPL-2.0+\n */\n\n#include <config.h>\n\n/*\n *************************************************************************\n *\n * Symbol _start is referenced elsewhere, so make it global\n *\n *************************************************************************\n */\n\n.globl _start\n\n/*\n *************************************************************************\n *\n * Vectors have their own section so linker script can map them easily\n *\n *************************************************************************\n */\n\n\t.section \".vectors\", \"ax\"\n\n/*\n *************************************************************************\n *\n * Exception vectors as described in ARM reference manuals\n *\n * Uses indirect branch to allow reaching handlers anywhere in memory.\n *\n *************************************************************************\n */\n\n_start:\n\n#ifdef CONFIG_SYS_DV_NOR_BOOT_CFG\n\t.word\tCONFIG_SYS_DV_NOR_BOOT_CFG\n#endif\n\n\tb\treset\n\tldr\tpc, _undefined_instruction\n\tldr\tpc, _software_interrupt\n\tldr\tpc, _prefetch_abort\n\tldr\tpc, _data_abort\n\tldr\tpc, _not_used\n\tldr\tpc, _irq\n\tldr\tpc, _fiq\n\n.................\n\n```\næ˜¾ç„¶`_start`åé¢å°±æ˜¯ä¸­æ–­å‘é‡è¡¨ï¼Œ`.section \".vectors\", \"ax\"`è¡¨æ˜æ­¤ä»£ç å­˜æ”¾åœ¨`vectors`é‡Œé¢ï¼Œå…·ä½“çš„åœ°å€å¯ä»¥åœ¨`u-boot.map`ä¸­æŸ¥è¯¢ã€‚`b reset`è·³è½¬è‡³resetå‡½æ•°å†…ï¼Œè¯¥å‡½æ•°åœ¨`arch/arm/cpu/armv7/start.S`é‡Œï¼š\n```\nreset:\n /* Allow the board to save important registers */\n b save_boot_params\n```\n`reset`å‡½æ•°ç´§æ¥ç€åˆè·³è½¬åˆ°äº†`save_boot_params`å‡½æ•°ï¼Œè¯¥å‡½æ•°åŒæ ·å®šä¹‰åœ¨`start.S`é‡Œï¼š\n```\nENTRY(save_boot_params)\n b save_boot_params_ret @ back to my caller\n```\nè¿™ä¸ªå‡½æ•°åˆç›´æ¥è·³è½¬åˆ°äº†`save_boot_params_ret`å‡½æ•°ï¼š\n```\nsave_boot_params_ret:\n /*\n * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 \n * mode, except if in HYP mode already\n */\n mrs r0, cpsr       @ è¯»å–CPSR\n and r1, r0, #0x1f  @ æå–bit0 - bit4ï¼Œç”¨äºè®¾ç½®Cortex-A7å·¥ä½œæ¨¡å¼\n teq r1, #0x1a      @ åˆ¤æ–­å¤„ç†å™¨æ˜¯å¦å¤„äºHYPæ¨¡å¼\n bicne r0, r0, #0x1f @ è‹¥ä¸å¤„äºHYPæ¨¡å¼ï¼Œæ¸…é™¤æ¨¡å¼ä½\n orrne r0, r0, #0x13 @ è¿›å…¥SVCæ¨¡å¼ï¼ˆç‰¹æƒï¼‰\n orr r0, r0, #0xc0   @ å…³é—­FIQå’ŒIRQ\n msr cpsr,r0         @ æ¢å¤CPSR\n```\nç„¶åï¼Œç»§ç»­æ‰§è¡Œï¼š\n```\n /*\n * Setup vector:\n * (OMAP4 spl TEXT_BASE is not 32 byte aligned.\n * Continue to use ROM code vector only in OMAP4 spl)\n */\n #if !(defined(CONFIG_OMAP44XX) && defined(CONFIG_SPL_BUILD))       \n /* Set V=0 in CP15 SCTLR register - for VBAR to point to vector */\n mrc p15, 0, r0, c1, c0, 0 @ è¯»å– CP15 SCTLR å¯„å­˜å™¨\n bic r0, #CR_V @ V = 0\n mcr p15, 0, r0, c1, c0, 0 @ å†™ CP15 SCTLR å¯„å­˜å™¨ï¼ŒVæ¸…é›¶ï¼Œå‡†å¤‡é‡å®šä½å‘é‡è¡¨\n\n /* CP15 VBAR å¯„å­˜å™¨ä¸­è®¾ç½®å‘é‡è¡¨åœ°å€ */\n ldr r0, =_start\n mcr p15, 0, r0, c12, c0, 0 @Set VBAR\n #endif\n```\nç»§ç»­æ‰§è¡Œï¼š\n```\n/* the mask ROM code should have PLL and others stable */\n #ifndef CONFIG_SKIP_LOWLEVEL_INIT\n bl cpu_init_cp15       @ è®¾ç½®CP15ç›¸å…³å†…å®¹\n bl cpu_init_crit       \n #endif\n\n bl _main\n```\nè¿™å·²ç»æ˜¯è·³è½¬è‡³mainçš„æœ€åä¸€æ­¥ã€‚`cpu_init_crit`å®šä¹‰å¦‚ä¸‹ï¼š\n```\nENTRY(cpu_init_crit)\n /*\n * Jump to board specific initialization...\n * The Mask ROM will have already initialized\n * basic memory. Go here to bump up clock rate and handle\n * wake up conditions.\n */\n b lowlevel_init @ go setup pll,mux,memory\n ENDPROC(cpu_init_crit)\n```\næ³¨é‡Šå·²ç»å†™äº†ï¼Œè¯¥å‡½æ•°å³å°†è¦è·³è½¬åˆ°çš„`lowlevel_init`ä¼šè®¾ç½®PLLã€MUXå’Œå†…å­˜ã€‚\n### lowlevel_init\nå‡½æ•°åœ¨`arch/arm/cpu/armv7/lowlevel_init.S`ä¸­å®šä¹‰ï¼š\n```\n/*\n * A lowlevel_init function that sets up the stack to call a C function to\n * perform further init.\n *\n * (C) Copyright 2010\n * Texas Instruments, <www.ti.com>\n *\n * Author :\n *\tAneesh V\t<aneesh@ti.com>\n *\n * SPDX-License-Identifier:\tGPL-2.0+\n */\n\n#include <asm-offsets.h>\n#include <config.h>\n#include <linux/linkage.h>\n\nENTRY(lowlevel_init)\n\t/*\n\t * Setup a temporary stack. Global data is not available yet.\n\t */\n\tldr\tsp, =CONFIG_SYS_INIT_SP_ADDR\n\tbic\tsp, sp, #7 /* 8-byte alignment for ABI compliance */\n#ifdef CONFIG_SPL_DM\n\tmov\tr9, #0\n#else\n\t/*\n\t * Set up global data for boards that still need it. This will be\n\t * removed soon.\n\t */\n#ifdef CONFIG_SPL_BUILD\n\tldr\tr9, =gdata\n#else\n\tsub\tsp, sp, #GD_SIZE\n\tbic\tsp, sp, #7\n\tmov\tr9, sp\n#endif\n#endif\n\t/*\n\t * Save the old lr(passed in ip) and the current lr to stack\n\t */\n\tpush\t{ip, lr}\n\n\t/*\n\t * Call the very early init function. This should do only the\n\t * absolute bare minimum to get started. It should not:\n\t *\n\t * - set up DRAM\n\t * - use global_data\n\t * - clear BSS\n\t * - try to start a console\n\t *\n\t * For boards with SPL this should be empty since SPL can do all of\n\t * this init in the SPL board_init_f() function which is called\n\t * immediately after this.\n\t */\n\tbl\ts_init\n\tpop\t{ip, pc}\nENDPROC(lowlevel_init)\n```\nç¬¬22è¡Œ`ldr\tsp, =CONFIG_SYS_INIT_SP_ADDR`ï¼Œå°†æ ˆæŒ‡é’ˆæŒ‡å‘`CONFIG_SYS_INIT_SP_ADDR`ï¼Œè¿™ä¸ªå®åœ¨`include/configs/mx6ullevk.h`é‡Œå®šä¹‰ï¼š\n```\n#define CONFIG_SYS_INIT_RAM_ADDR IRAM_BASE_ADDR\n#define CONFIG_SYS_INIT_RAM_SIZE IRAM_SIZE\n\n#define CONFIG_SYS_INIT_SP_OFFSET \\\n(CONFIG_SYS_INIT_RAM_SIZE - GENERATED_GBL_DATA_SIZE)\n#define CONFIG_SYS_INIT_SP_ADDR \\\n(CONFIG_SYS_INIT_RAM_ADDR + CONFIG_SYS_INIT_SP_OFFSET)\n```\n`IRAM_BASE_ADDR`å’Œ`IRAM_SIZE`åœ¨`arch/arm/include/asm/arch-mx6/imx-regs.h`ä¸­å®šä¹‰ï¼Œå®é™…ä¸Šå°±æ˜¯MX6ULLå†…éƒ¨OCRAMçš„é¦–åœ°å€å’Œå¤§å°ã€‚è¿™é‡Œ`CONFIG_SYS_INIT_RAM_ADDR = IRAM_BASE_ADDR = 0x00900000`ï¼Œ`CONFIG_SYS_INIT_RAM_SIZE = 0x00020000 =128KB`ã€‚\n\næ ¹æ®è¿™ä¸¤è¡Œï¼š\n```\n#define CONFIG_SYS_INIT_SP_OFFSET \\\n(CONFIG_SYS_INIT_RAM_SIZE - GENERATED_GBL_DATA_SIZE)\n#define CONFIG_SYS_INIT_SP_ADDR \\\n(CONFIG_SYS_INIT_RAM_ADDR + CONFIG_SYS_INIT_SP_OFFSET)\n```\næ˜¾ç„¶è¿˜éœ€è¦çŸ¥é“`GENERATED_GBL_DATA_SIZE`çš„å€¼ï¼Œåœ¨`include/generated/generic-asm-offsets.h`ä¸­å®šä¹‰ï¼Œå¤§å°ä¸º256.é‚£ä¹ˆç»¼ä¸Šï¼Œ`CONFIG_SYS_INIT_SP_ADDR`çš„å€¼å¦‚ä¸‹ï¼š\n```\nCONFIG_SYS_INIT_SP_OFFSET = 0x00020000 - 256 = 0x1FF00\nCONFIG_SYS_INIT_SP_ADDR = 0x00900000 + 0x1FF00 = 0x0091FF00\n```\næ­¤æ—¶æ ˆæŒ‡é’ˆSPæŒ‡å‘0x0091FF00ï¼Œè¿™å±äºIMX6ULLçš„å†…éƒ¨RAMã€‚\n\nå›åˆ°lowlevel_init.Sï¼Œ`bic\tsp, sp, #7`å¯¹æ ˆæŒ‡é’ˆä½œ8å­—èŠ‚å¯¹é½å¤„ç†ã€‚ç¬¬34è¡Œ`sub\tsp, sp, #GD_SIZE`ç”¨æ ˆæŒ‡é’ˆå‡å»`GD_SIZE`ï¼Œè¿™ä¸ªå˜é‡åœ¨`generic-asm-offsets.h`ä¸­å®šä¹‰ï¼Œå¤§å°ä¸º248ï¼›ç¬¬35è¡Œ`bic\tsp, sp, #7`ï¼Œ8å­—èŠ‚å¯¹é½SPï¼Œæ­¤æ—¶`SP=0x0091FF00 - 248 = 0x0091FE08`ã€‚ç¬¬36è¡Œå°†SPä¿å­˜è‡³R9ï¼Œç¬¬42è¡Œå°†ipå’Œlrå…¥æ ˆï¼Œ57è¡Œè°ƒç”¨s_initå‡½æ•°ï¼Œç„¶å58è¡Œå‡ºæ ˆipå’Œlrï¼Œå¹¶å°†lrèµ‹ç»™pcã€‚\n\n### s_init\nlowlevel_initåœ¨æœ€åå›è°ƒç”¨s_initï¼Œå®šä¹‰åœ¨`arch/arm/cpu/armv7/mx6/soc.c`ä¸­ã€‚å¯¹äºMX6ULLè€Œè¨€ï¼Œs_init()æ˜¯ä¸ªç©ºå‡½æ•°ï¼ˆä¸æ»¡è¶³è§¦å‘è¦æ±‚ï¼‰ã€‚è‡³æ­¤lowlevel_initç»“æŸï¼Œè¿”å›cpu_init_critï¼Œè¯¥å‡½æ•°ä¹Ÿç»“æŸï¼Œæœ€åè¿”å›save_boot_params_retï¼Œç´§æ¥ç€å°±ä¼šæ‰§è¡Œ_mainå‡½æ•°ã€‚\n\n### _main\nå®šä¹‰åœ¨`arch/arm/lib/crt0.S`ã€‚æ€»ä½“è€Œè¨€éå¸¸é•¿ï¼Œæ€»å…±è°ƒç”¨äº†4ä¸ªå‡½æ•°ï¼š`board_init_f`ã€`relocate_code`ã€`relocate_vectors`ã€`board_init_r`ã€‚\n#### board_init_f\nåœ¨`common/board_f.c`ä¸­å®šä¹‰ï¼Œè¯¥å‡½æ•°çš„å·¥ä½œï¼š\n- åˆå§‹åŒ–å¤–è®¾ï¼ŒåŒ…æ‹¬ä¸²å£ã€å®šæ—¶å™¨ç­‰ï¼Œå¹¶æ‰“å°ä¸€äº›æ¶ˆæ¯\n- åˆå§‹åŒ– gd çš„å„ä¸ªæˆå‘˜å˜é‡ï¼Œuboot ä¼šå°†è‡ªå·±é‡å®šä½åˆ° DRAM æœ€åé¢çš„åœ°å€åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯å°†è‡ªå·±æ‹·è´åˆ° DRAM æœ€åé¢çš„å†…å­˜åŒºåŸŸä¸­ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ç»™ Linux è…¾å‡ºç©ºé—´ï¼Œé˜²æ­¢ Linux kernel è¦†ç›–æ‰ ubootï¼Œå°† DRAM å‰é¢çš„åŒºåŸŸå®Œæ•´çš„ç©ºå‡ºæ¥ã€‚åœ¨æ‹·è´ä¹‹å‰è‚¯å®šè¦ç»™ uboot å„éƒ¨åˆ†åˆ†é…å¥½å†…å­˜ä½ç½®å’Œå¤§å°ï¼Œæ¯”å¦‚ gd åº”è¯¥å­˜æ”¾åˆ°å“ªä¸ªä½ç½®ï¼Œmalloc å†…å­˜æ± åº”è¯¥å­˜æ”¾åˆ°å“ªä¸ªä½ç½®ç­‰ç­‰ã€‚è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åœ¨ gd çš„æˆå‘˜å˜é‡ä¸­ï¼Œå› æ­¤è¦å¯¹ gd çš„è¿™äº›æˆå‘˜å˜é‡åšåˆå§‹åŒ–ã€‚æœ€ç»ˆå½¢æˆä¸€ä¸ªå®Œæ•´çš„å†…å­˜mapï¼Œåœ¨åé¢é‡å®šä½ uboot çš„æ—¶å€™å°±ä¼šç”¨åˆ°è¿™ä¸ªå†…å­˜mapã€‚\n\nè¯¥å‡½æ•°ä¸­åŒ…æ‹¬éå¸¸å…³é”®çš„ä¸€è¡Œï¼š\n```\nif (initcall_run_list(init_sequence_f))\nhang();\n```\n`initcall_run_list`ä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—å¤–è®¾ï¼š\n```\nstatic init_fnc_t init_sequence_f[] = {\nsetup_mon_len,       //è®¾ç½®ä»£ç é•¿åº¦\ninitf_malloc,        //åˆå§‹åŒ–mallocç›¸å…³çš„æˆå‘˜å˜é‡\ninitf_console_record,   //æ— æ•ˆï¼Œè¿”å›0\narch_cpu_init,          //åŸºæœ¬çš„arch cpuä¾èµ–é¡¹åˆå§‹åŒ–\ninitf_dm, \narch_cpu_init_dm, \nmark_bootstage, \nboard_early_init_f,     //åˆå§‹åŒ–ä¸²å£IOé…ç½®\ntimer_init,         //åˆå§‹åŒ–Cortex-A7å†…æ ¸å®šæ—¶å™¨ï¼Œä¸ºUbootæä¾›æ—¶é—´(ç±»ä¼¼systick)\nboard_postclk_init,     //è®¾ç½®VDDSOCç”µå‹\nget_clocks,             //è·å–SDå¡å¤–è®¾æ—¶é’Ÿ\nenv_init,               //åˆå§‹åŒ–ç¯å¢ƒå˜é‡\ninit_baud_rate,         //åˆå§‹åŒ–æ³¢ç‰¹ç‡\nserial_init,            //åˆå§‹åŒ–ä¸²å£\nconsole_init_f, \ndisplay_options,        //ä¸²å£æ‰“å°ä¿¡æ¯\ndisplay_text_info,      //æ‰“å°è°ƒè¯•ä¿¡æ¯\nprint_cpuinfo,          //æ‰“å°CPUä¿¡æ¯\nshow_board_info,        //æ‰“å°æ¿å­ä¿¡æ¯ï¼Œè°ƒç”¨checkboard()\nINIT_FUNC_WATCHDOG_INIT     //æ— æ•ˆ\nINIT_FUNC_WATCHDOG_RESET    //æ— æ•ˆ\ninit_func_i2c,          //åˆå§‹åŒ–I2C\nannounce_dram_init,     \ndram_init,              //è®¾ç½®gd->ram_size\npost_init_f,            //æµ‹è¯•å‡½æ•°\nINIT_FUNC_WATCHDOG_RESET\ntestdram,               //æ— æ•ˆ\nINIT_FUNC_WATCHDOG_RESET\nINIT_FUNC_WATCHDOG_RESET\n/*\n* Now that we have DRAM mapped and working, we can\n* relocate the code and continue running from DRAM.\n*\n* Reserve memory at end of RAM for (top down in that order):\n* - area that won't get touched by U-Boot and Linux (optional)\n* - kernel log buffer\n* - protected RAM\n* - LCD framebuffer\n* - monitor code\n* - board info struct\n*/\nsetup_dest_addr,        //è®¾ç½®gd->ram_size(ramå¤§å°)ï¼Œgd->ram_top(ramæœ€é«˜åœ°å€)å’Œgd->relocaddr(é‡å®šä½åæœ€é«˜åœ°å€)\nreserve_round_4k,       //gd->relocaddr 4å­—èŠ‚å¯¹é½\nreserve_mmu,            //ç•™å‡ºMMUçš„TLBè¡¨ä½ç½®\nreserve_trace, \nreserve_uboot,          //ç•™å‡ºé‡å®šä½åubootæ‰€å å†…å­˜åŒºåŸŸï¼Œå¤§å°ç”±gd->monlenæŒ‡å®šï¼Œç•™å‡ºçš„ç©ºé—´éœ€4KBå¯¹é½å¹¶è®¾ç½®gd->start_addr_sp\nreserve_malloc,         //ç•™å‡ºmallocåŒºåŸŸï¼Œç”±å®TOTAL_MALLOC_LENå®šä¹‰(é»˜è®¤16MB)\nreserve_board,          //ç•™å‡ºbd_tå†…å­˜åŒº\nsetup_machine,          //æ— æ•ˆ\nreserve_global_data,    //ç•™å‡ºgd_tå†…å­˜åŒºåŸŸ\nreserve_fdt,            //æ— æ•ˆ\nreserve_arch,           //ç©º\nreserve_stacks,         //ç•™å‡ºæ ˆç©ºé—´ï¼Œå¦‚æœä½¿èƒ½IRQè¿˜éœ€è¦ç•™å‡ºIRQç›¸åº”çš„å†…å­˜\nsetup_dram_config,      //è®¾ç½®DRAMï¼Œå‘ŠçŸ¥linux DRAMèµ·å§‹åœ°å€å’Œå¤§å°\nshow_dram_config, \ndisplay_new_sp,         //æ˜¾ç¤ºæ–°çš„spä½ç½®\nINIT_FUNC_WATCHDOG_RESET\nreloc_fdt,              //æ— æ•ˆ\nsetup_reloc,            //è®¾ç½®gdçš„å…¶ä»–æˆå‘˜å˜é‡\nNULL,\n};\n```\nè‡³æ­¤ï¼Œ`board_init_f`æ‰§è¡Œå®Œæˆï¼Œæœ€ç»ˆçš„å†…å­˜åˆ†é…ï¼š\n![å†…å­˜åˆ†é…](/images/linux/uboot_9.png)\n\n#### relocate_code / relocate_vectors\nç”¨äºæ‹·è´ä»£ç å’Œé‡å®šä½å‘é‡è¡¨ã€‚\n\n#### board_init_r\nç”¨äºåˆå§‹åŒ–é«˜çº§å¤–è®¾ï¼ŒåŒ…æ‹¬EMMCã€LCDã€BSPèŠ¯ç‰‡ã€ç½‘ç»œç­‰ã€‚\n\n### å°ç»“\næ€»çš„æ¥è¯´ï¼Œubootçš„æ±‡ç¼–å¯åŠ¨é˜¶æ®µåŒ…æ‹¬ï¼š\n1. å…¥å£ç‚¹ï¼š`_start`(`arch/arm/lib/vectors.S`)è®¾ç½®å¼‚å¸¸å‘é‡è¡¨\n2. CPUæ¨¡å¼åˆ‡æ¢ï¼šè¿›å…¥SVCæ¨¡å¼ï¼Œç¦ç”¨IRQ/FIQ\n3. å…³é—­MMU/Cacheï¼Œç¡®ä¿ç›´æ¥è®¿é—®ç‰©ç†åœ°å€\n4. åˆå§‹åŒ–æ ˆæŒ‡é’ˆ\n5. lowlevel_initï¼ˆæ¿çº§ç‰¹å®šï¼‰ï¼š\n\t- é…ç½®ç³»ç»Ÿæ—¶é’Ÿ\n\t- DDRæ§åˆ¶å™¨åˆå§‹åŒ–\n6. ä»£ç é‡å®šä½ï¼šå°†U-Bootä»åŠ è½½åœ°å€ï¼ˆå¦‚SRAMï¼‰æ‹·è´åˆ°DDRç›®æ ‡åœ°å€\n\nCè¯­è¨€åˆå§‹åŒ–é˜¶æ®µ(`board_init_f`)åŒ…æ‹¬ï¼š\n1. å…¨å±€æ•°æ®ç»“æ„åˆå§‹åŒ–ï¼š`gd_t`å’Œ`bd_t`\n2. ä½çº§é©±åŠ¨åˆå§‹åŒ–ï¼š\n\t- ä¸²å£ã€GPIOã€MMUã€å†…æ ¸å®šæ—¶å™¨\n\t- DDR\n3. é‡å®šä½å‡†å¤‡\n\t- è®¡ç®—ubootåœ¨DDRä¸­çš„æœ€ç»ˆä½ç½®ï¼Œé¢„ç•™å†…æ ¸ã€DTBã€initrdã€ä»£ç ç©ºé—´\n\t- æ‰§è¡Œé‡å®šä½ï¼Œæ›´æ–°ä»£ç åœ°å€ç›¸å…³å¼•ç”¨(å¦‚å…¨å±€å˜é‡æŒ‡é’ˆ)\n4. è®¾å¤‡æ ‘é¢„è§£æï¼šè‹¥ä½¿ç”¨DTSï¼ŒåŠ è½½å¹¶æ ¡éªŒDTB\n\né‡å®šä½åä¸»æµç¨‹(`board_init_r`)åŒ…æ‹¬ï¼š\n1. é«˜çº§å¤–è®¾åˆå§‹åŒ–ï¼š\n\t- ä»¥å¤ªç½‘ã€SDã€USBã€EEPROMç­‰\n\t- å±•å¼€DTBï¼ŒåŒ¹é…é©±åŠ¨ï¼Œè®¾ç½®ç¡¬ä»¶å‚æ•°\n2. ç¯å¢ƒå˜é‡åŠ è½½ï¼šä»å­˜å‚¨ä»‹è´¨è¯»å–`uEnv.txt`æˆ–ç¯å¢ƒåˆ†åŒº\n3. ç”¨æˆ·äº¤äº’\n\t- æ£€æµ‹è¾“å…¥\n\t- åŠ è½½zImageã€è®¾å¤‡æ ‘ã€initrdåˆ°æŒ‡å®šå†…å­˜åœ°å€\n\t- å‡†å¤‡åŠ è½½å†…æ ¸","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"IMX6UL DDR3é…ç½®","url":"/2025/03/05/DDR3é…ç½®/","content":"## RAMå’ŒROM\n- RAMï¼šRandom-access memoryï¼Œéšæœºå­˜å‚¨å™¨ï¼Œéšæ—¶è¯»å†™ï¼Œé€Ÿåº¦å¿«ï¼Œæ‰ç”µåæ•°æ®ä¸¢å¤±ã€‚å†…å­˜æ¡å³ä¸ºå¸¸è§çš„RAMã€‚ARMä¸­æ ˆã€å †(mallocç”³è¯·çš„å†…å­˜)ã€å…¨å±€åŒºï¼ˆ.bssæ®µã€.dataæ®µï¼‰éƒ½å­˜æ”¾åœ¨RAMä¸­ã€‚\n- ROMï¼šRead-only memoryï¼Œåªè¯»å­˜å‚¨å™¨ã€‚å®¹é‡å¤§ï¼Œé€Ÿåº¦æ…¢ï¼Œæ‰ç”µåæ•°æ®ç•™å­˜ã€‚\n\nå¯¹äºIMX6Uï¼Œ256/512MBçš„DDR3ä¸ºRAMï¼Œ512MBçš„NANF Flashæˆ–8GB EMMCä¸ºROMã€‚\n\n## SRAM\nStatic Random-Access Memoryï¼Œé™æ€éšæœºå­˜å‚¨å™¨ã€‚â€œé™æ€â€çš„æ„æ€æ˜¯åªè¦SRAMä¸Šç”µï¼ŒSRAMé‡Œé¢çš„æ•°æ®å°±ä¼šä¸€ç›´ä¿å­˜ï¼Œç›´åˆ°SRAMæ‰ç”µã€‚ä¸ºäº†éšæœºè¯»å–ä»»ä½•ä¸€ä¸ªåœ°å€ç©ºé—´å†…çš„æ•°æ®ï¼ŒSRAMçš„åœ°å€çº¿å’Œæ•°æ®çº¿åˆ†ç¦»ã€‚\n\nä»¥F103/F407å¸¸ç”¨çš„IS62WV51216 SRAMè€Œè¨€ï¼Œå…¶åŒ…æ‹¬å‡ ä¸ªéƒ¨åˆ†ï¼š\n\n![IS62WV51216æ¡†å›¾](/images/linux/sram_1.png)\n\n1. åœ°å€çº¿ï¼Œç”¨äºå¯»å€ã€‚åœ°å€çº¿çš„æ ¹æ•°ä»£è¡¨ç€èƒ½å¤Ÿè®¿é—®çš„åœ°å€å¤§å°ï¼Œ19æ ¹çº¿å°±èƒ½è®¿é—®2^19=524288=512KBçš„å†…å­˜ã€‚è¯¥SRAMæ˜¯16ä½å®½çš„ï¼Œä¸€æ¬¡è®¿é—®ä¸¤ä¸ªå­—èŠ‚ï¼Œå®é™…çš„å¯è®¿é—®å¤§å°ä¸º512KB*2=1MBã€‚\n2. æ•°æ®çº¿ï¼Œç”¨äºä¼ è¾“æ•°æ®ã€‚16ä½å®½å³æœ‰16æ ¹æ•°æ®çº¿ï¼Œé«˜ä½å­—èŠ‚åˆ†å¼€ä¼ è¾“ã€‚\n3. æ§åˆ¶çº¿ã€‚åŒ…æ‹¬ï¼š\n    - CS1/CS2ï¼šç‰‡é€‰ä¿¡å·\n    - OEï¼šè¾“å‡ºä½¿èƒ½ä¿¡å·\n    - WEï¼šå†™ä½¿èƒ½ä¿¡å·\n    - UB/LBï¼šé«˜å­—èŠ‚/ä½å­—èŠ‚æ§åˆ¶ä¿¡å·\n\nSRAMæœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯æˆæœ¬é«˜ã€ä»·æ ¼é«˜ã€‚\n\n## SDRAM\nSynchronous Dynamic Random Access Memoryï¼ŒåŒæ­¥åŠ¨æ€éšæœºå­˜å‚¨å™¨ã€‚â€œåŒæ­¥â€çš„æ„æ€æ˜¯ SDRAM å·¥ä½œéœ€è¦æ—¶é’Ÿçº¿ï¼Œâ€œåŠ¨æ€â€çš„æ„æ€æ˜¯ SDRAM ä¸­çš„æ•°æ®éœ€è¦ä¸æ–­çš„åˆ·æ–°æ¥ä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œâ€œéšæœºâ€çš„æ„æ€å°±æ˜¯å¯ä»¥è¯»å†™ä»»æ„åœ°å€çš„æ•°æ®ã€‚ç›¸æ¯”SRAMï¼ŒSDRAMè¯»å†™é€Ÿåº¦è¾ƒæ…¢ï¼ˆè¦æŒç»­åˆ·æ–°ï¼‰ï¼Œä½†æ˜¯å®¹é‡å¤§ï¼Œä»·æ ¼æ›´ä½ï¼ŒåŠŸè€—ä¹Ÿæ›´ä½ï¼Œé€‚åˆåšå¤§å®¹é‡å­˜å‚¨ã€‚\n\nSDRAMå·²ç»å‘å±•åˆ°äº†ç¬¬å››ä»£ï¼š\n    1. SDRAM\n    2. DDR SDRAM\n    3. DDR2 SDRAM\n    4. DDR3 SDRAM\n    5. DDR4 SDRAM\n\nSTM32F429/F767ç­‰éƒ½æ”¯æŒSDRAMã€‚å°±ä»¥ STM32 å¼€å‘æ¿æœ€å¸¸ç”¨çš„åé‚¦ W9825G6KH ä¸ºä¾‹ï¼ŒW9825G6KH æ˜¯ä¸€æ¬¾ 16 ä½å®½(æ•°æ®ä½ä¸º 16 ä½)ã€32MB çš„ SDRAMã€é€Ÿåº¦ä¸€èˆ¬ä¸º 133MHzã€166MHz æˆ– 200MHzï¼š\n\n![W9825G6KHæ¡†å›¾](/images/linux/sram_2.png)\n\n1. æ§åˆ¶çº¿\n    - CLKï¼šæ—¶é’Ÿçº¿ï¼ŒSDRAMä¸­â€œåŒæ­¥â€äºŒå­—è¡¨æ˜å…¶å¿…å®šéœ€è¦æ—¶é’Ÿçº¿\n    - CKEï¼šæ—¶é’Ÿä½¿èƒ½ä¿¡å·çº¿\n    - CSï¼šç‰‡é€‰ä¿¡å·\n    - RASï¼šè¡Œé€‰é€šä¿¡å·ã€‚ä¸SRAMä¸åŒï¼ŒSDRAMé€šè¿‡è¡Œã€åˆ—æ¥ç¡®å®šå…·ä½“çš„å­˜å‚¨åŒºåŸŸï¼Œç±»ä¼¼äºâ€œåæ ‡â€ï¼Œå› æ­¤æœ‰è¡Œåœ°å€å’Œåˆ—åœ°å€ä¹‹åˆ†\n    - CASï¼šåˆ—é€‰é€šä¿¡å·\n    - WEï¼šå†™ä½¿èƒ½ä¿¡å·\n2. A10åœ°å€çº¿ï¼šé™¤äº†åœ°å€çº¿å¤–ï¼ŒA10çº¿è¿˜æ§åˆ¶Auto-prechargeï¼ˆé¢„å……ç”µï¼‰ã€‚SDRAMå†…éƒ¨åˆ†ä¸ºå¤šä¸ªBANKï¼Œè¯»å†™å®Œæˆåå¦‚æœè¦å¯¹åŒä¸€ä¸ªBANKä¸­çš„å¦ä¸€è¡Œè¿›è¡Œå¯»å€ï¼Œåˆ™å¿…é¡»å°†åŸæ¥çš„æœ‰æ•ˆè¡Œå…³é—­ï¼Œç„¶åå‘é€æ–°çš„è¡Œ/åˆ—åœ°å€ã€‚å…³é—­ç°åœ¨æ­£å·¥ä½œçš„è¡Œï¼Œæ‰“å¼€æ–°è¡Œçš„æ“ä½œå°±å«åšé¢„å……ç”µã€‚\n3. åœ°å€çº¿ï¼šA0-A12ï¼Œå…±13æ ¹ï¼ŒåŒ…å«è¡Œåœ°å€å’Œåˆ—åœ°å€ã€‚å¦‚W9825G6KHçš„A0-A8æ˜¯åˆ—åœ°å€(9ä½)ï¼ŒA0-A12æ˜¯è¡Œåœ°å€(13ä½)ï¼Œå¯å¯»å€èŒƒå›´ä¸º2^9*2^13=4194304B=4MBã€‚ è€ƒè™‘åˆ°ä½å®½ä¸º2ï¼Œ4MB * 2=8MBï¼Œå…±4ä¸ªBANKï¼Œå› æ­¤å®¹é‡ä¸º32MBã€‚\n4. BANKé€‰æ‹©çº¿ï¼šåœ¨ä¸€ç‰‡ SDRAM ä¸­å› ä¸ºæŠ€æœ¯ã€æˆæœ¬ç­‰åŸå› ï¼Œä¸å¯èƒ½åšä¸€ä¸ªå…¨å®¹é‡çš„ BANKã€‚è€Œä¸”ï¼Œå› ä¸º SDRAM çš„å·¥ä½œåŸç†ï¼Œå•ä¸€çš„ BANK ä¼šå¸¦æ¥ä¸¥é‡çš„å¯»å€å†²çªï¼Œå‡ä½å†…å­˜è®¿é—®æ•ˆç‡ã€‚ä¸ºæ­¤ï¼Œå‚å•†åœ¨ä¸€ç‰‡ SDRAM ä¸­åˆ†å‰²å‡ºå¤šå— BANKï¼Œä¸€èˆ¬éƒ½æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼Œæ¯”å¦‚ 2ï¼Œ4ï¼Œ8 ç­‰ã€‚å¦‚æœæœ‰4ä¸ªBANKï¼Œé‚£ä¹ˆBANKé€‰æ‹©åˆ™éœ€è¦ä¸¤æ ¹çº¿ï¼ŒåŒç†8ä¸ªBANKå°±éœ€è¦ä¸‰æ ¹çº¿ã€‚\n5. BANKåŒºåŸŸ\n6. æ•°æ®çº¿ï¼š16ä½å®½ï¼Œå…±16æ ¹æ•°æ®çº¿\n7. é«˜ä½å­—èŠ‚é€‰æ‹©çº¿\n\n## DDR\nDouble Data Rate SDRAMï¼ŒåŒå€é€Ÿç‡SDRAMã€‚\n- DDR1:ä¸€ä¸ªCLKå‘¨æœŸå†…ï¼Œåœ¨ä¸Šå‡æ²¿å’Œä¸‹é™æ²¿å„ä¼ è¾“ä¸€æ¬¡æ•°æ®ï¼Œè¯¥è¿‡ç¨‹è¢«ç§°ä¸ºprefetchï¼ˆé¢„å–ï¼‰\n- DDR2ï¼šåœ¨DDR1çš„åŸºç¡€ä¸Šå°†é¢„å–å¢åŠ åˆ°äº†4bit\n- DDR3ï¼šåœ¨DDR2çš„åŸºç¡€ä¸Šå°†é¢„å–å¢åŠ åˆ°äº†8bitï¼ŒDDR3åˆç»†åˆ†ä¸ºä»¥ä¸‹å‹å·ï¼š\n    + LPDDR3ï¼šä½åŠŸè€—ï¼Œç”µå‹ä¸º1.2V\n    + DDR3ï¼šæ ‡å‹ï¼Œç”µå‹ä¸º1.5Vï¼Œå°å¼æœºå¤šä½¿ç”¨è¯¥ç±»\n    + DDR3Lï¼šä½å‹ï¼Œç”µå‹ä¸º1.35Vï¼Œæ‰‹æœºã€åµŒå…¥å¼è®¾å¤‡ã€ç¬”è®°æœ¬ç­‰å¤šä½¿ç”¨è¯¥ç±»\n\n## DDR3\nä»¥NT5CC256M16ER-EKä¸ºä¾‹ï¼š\n![DDR3Læ¡†å›¾](/images/linux/sram_3.png)\n1. æ§åˆ¶çº¿\n    - ODTï¼šç‰‡ä¸Šç»ˆç«¯ä½¿èƒ½ï¼Œä½¿èƒ½å’Œç¦æ­¢ç‰‡å†…ç»ˆç«¯ç”µé˜»\n    - ZQï¼šè¾“å‡ºé©±åŠ¨æ ¡å‡†çš„å¤–éƒ¨å‚è€ƒå¼•è„šï¼Œåº”å¤–æ¥240æ¬§ç”µé˜»è‡³VSSQ\n    - RESETï¼šå¤ä½\n    - CKEï¼šæ—¶é’Ÿä½¿èƒ½\n    - A12ï¼šåœ°å€çº¿ï¼Œå¤ç”¨ä¸ºBCå¼•è„šï¼Œåœ¨READå’ŒWRITEå‘½ä»¤æœŸé—´ä¼šè¢«é‡‡æ ·ä»¥å†³å®šburst chopæ˜¯å¦æ‰§è¡Œ\n    - CKå’ŒCK#ï¼šæ—¶é’Ÿä¿¡å·ã€‚DDR3ä½¿ç”¨å·®åˆ†æ—¶é’Ÿçº¿ï¼Œæ‰€æœ‰çš„æ§åˆ¶å’Œåœ°å€ä¿¡å·éƒ½ä¼šåœ¨CKçš„ä¸Šå‡æ²¿å’ŒCK#çš„ä¸‹é™æ²¿äº¤å‰å¤„è¢«é‡‡é›†\n    - CS#ï¼šç‰‡é€‰ä¿¡å·\n    - RAS#ã€CAS#ã€WE#ï¼šè¡Œé€‰é€šï¼Œåˆ—é€‰é€šå’Œå†™ä½¿èƒ½ä¿¡å·\n2. åœ°å€çº¿ï¼šA0-A14ï¼Œåˆ—åœ°å€ä¸ºA0-A9å…±10æ ¹ï¼Œè¡Œåœ°å€ä¸ºA0-A14å…±15æ ¹ï¼Œä¸€ä¸ªBANKå¤§å°å³ä¸º2^10 * 2^15 * 2=64MBã€‚ICå…±æœ‰8ä¸ªBANKï¼ŒåŠ èµ·æ¥å°±æ˜¯512MBã€‚\n3. BANKé€‰æ‹©çº¿ï¼š8ä¸ªBANKï¼Œéœ€è¦3æ ¹é€‰æ‹©çº¿\n4. BANKåŒºåŸŸ\n5. æ•°æ®çº¿ï¼š16ä½å®½ï¼Œå…±éœ€16æ ¹æ•°æ®çº¿\n6. æ•°æ®é€‰é€šå¼•è„šï¼šDQSå’ŒDQS#ï¼Œå·®åˆ†ä¿¡å·\n7. æ•°æ®è¾“å…¥å±è”½å¼•è„šï¼šDM\n\n## DDR3å…³é”®æ—¶é—´å‚æ•°\n1. ä¼ è¾“é€Ÿç‡ï¼šå¦‚1066MT/Sã€1600MT/Sã€1866MT/S ç­‰\n2. tRCDå‚æ•°ï¼šRAS-to-CAS Delayï¼Œå³è¡Œå¯»å€åˆ°åˆ—å¯»å€ä¹‹é—´çš„å»¶è¿Ÿã€‚DDRçš„å¯»å€æµç¨‹æ˜¯å…ˆæŒ‡å®š BANK åœ°å€ï¼Œç„¶åå†æŒ‡å®šè¡Œåœ°å€ï¼Œæœ€åæŒ‡å®šåˆ—åœ°å€ç¡®å®šæœ€ç»ˆè¦å¯»å€çš„å•å…ƒã€‚BANK åœ°å€å’Œè¡Œåœ°å€æ˜¯åŒæ—¶å‘å‡ºçš„ï¼Œè¿™ä¸ªå‘½ä»¤å«åšâ€œè¡Œæ¿€æ´»â€(Row Active)ã€‚è¡Œæ¿€æ´»ä»¥åå°±å‘é€åˆ—åœ°å€å’Œå…·ä½“çš„æ“ä½œå‘½ä»¤(è¯»è¿˜æ˜¯å†™)ï¼Œè¿™ä¸¤ä¸ªæ˜¯åŒæ—¶å‘å‡ºçš„ï¼Œå› æ­¤ä¸€èˆ¬ä¹Ÿç”¨â€œè¯»/å†™å‘½ä»¤â€è¡¨ç¤ºåˆ—å¯»å€ã€‚åœ¨è¡Œæœ‰æ•ˆ(è¡Œæ¿€æ´»)åˆ°è¯»å†™å‘½ä»¤å‘å‡ºçš„è¿™æ®µæ—¶é—´é—´éš”å«åš tRCDã€‚è¯¥å‚æ•°åœ¨åˆå§‹åŒ–DDR3æ—¶éœ€è¦é…ç½®\n3. CLå‚æ•°ï¼šCAS Latencyï¼Œåˆ—åœ°å€é€‰é€šæ½œä¼æœŸï¼Œåˆ—åœ°å€å‘å‡ºåï¼Œæ•°æ®ä»å­˜å‚¨å•å…ƒåˆ°å†…å­˜èŠ¯ç‰‡IOæ¥å£ä¸Šçš„æ—¶é—´ã€‚ä¸€èˆ¬tRCDå’ŒCLå¤§å°ä¸€æ ·\n4. ALå‚æ•°ï¼šAdditive Latencyï¼Œå‰ç½®CASåè¯»å†™æ“ä½œå¹¶æ²¡æœ‰æå‰ï¼Œä¾æ—§éœ€è¦ALæ¥ä¿è¯è¶³å¤Ÿçš„å»¶è¿Ÿï¼ˆæ½œä¼ï¼‰æœŸã€‚ALå’ŒCLç›¸åŠ ç»„æˆäº†RLï¼ˆRead Latencyï¼‰\n5. tRCå‚æ•°ï¼šä¸¤ä¸ª ACTIVE å‘½ä»¤ï¼Œæˆ–è€… ACTIVE å‘½ä»¤åˆ° REFRESH å‘½ä»¤ä¹‹é—´çš„å‘¨æœŸ\n6. tRASå‚æ•°ï¼šACTIVE å‘½ä»¤åˆ° PRECHARGE å‘½ä»¤ä¹‹é—´çš„æœ€å°æ—¶é—´ï¼ŒDDR3L çš„æ•°æ®æ‰‹å†ŒåŒæ ·ä¹Ÿä¼šç»™å‡ºæ­¤å‚æ•°\n\n## I.MX6U MMDCæ§åˆ¶å™¨\n### IO\nMMDC æ˜¯ I.MX6Uçš„å†…å­˜æ§åˆ¶å™¨ï¼Œæ˜¯ä¸€ä¸ªå¤šæ¨¡çš„ DDR æ§åˆ¶å™¨ï¼Œå¯ä»¥è¿æ¥ 16 ä½å®½çš„ DDR3/DDR3Lã€16 ä½\nå®½çš„ LPDDR2ï¼ŒMMDC æ˜¯ä¸€ä¸ªå¯é…ç½®ã€é«˜æ€§èƒ½çš„ DDR æ§åˆ¶å™¨ã€‚MMDC å¤–è®¾åŒ…å«ä¸€ä¸ªå†…æ ¸(MMDC_CORE)å’Œ PHY(MMDC_PHY)ï¼Œå†…æ ¸å’Œ PHY çš„åŠŸèƒ½å¦‚ä¸‹ï¼š\n- MMDCå†…æ ¸ï¼šè´Ÿè´£é€šè¿‡AXIæ¥å£ä¸ç³»ç»Ÿé€šä¿¡ã€DDRå‘½ä»¤ç”Ÿæˆã€DDRå‘½ä»¤ä¼˜åŒ–ã€è¯»å†™æ•°æ®è·¯å¾„\n- MMDCPHYï¼šè´Ÿè´£æ—¶åºè°ƒæ•´å’Œæ ¡å‡†ï¼Œä¿éšœæ•°æ®åœ¨400MHzå†…è¢«å‡†ç¡®æ•è·\n\nå› ä¸ºç¡¬ä»¶è¦æ±‚ä¸¥æ ¼ï¼ŒI.MX6Uçš„DDRå¼•è„šæ²¡æœ‰å¤ç”¨ï¼š\n![DDRä¿¡å·IO](/images/linux/sram_4.png)\n\n### æ—¶é’Ÿæº\n![MMDCæ—¶é’Ÿæº](/images/linux/sram_5.png)\n1. pre_periph2æ—¶é’Ÿé€‰æ‹©å™¨ï¼Œç”±CBCMRçš„PRE_PERIPH2_CLK_SEL ä½æ§åˆ¶ï¼š\n| PRE_PERIPH2_CLK_SEL(bit22:21) | æ—¶é’Ÿæº       |\n| ----------------------------- | --------- |\n| 00                             | PLL2      |\n| 01                             | PLL2_PFD2 |\n| 10                            | PLL2_PFD0 |\n| 11                            | PLL4      |\nå…ˆå‰çš„æ—¶é’Ÿé…ç½®å·²ç»å°†PLL2_PFD2è®¾ç½®ä¸º396MHzï¼ˆçº¦400MHzï¼‰ï¼Œå› æ­¤DDRé¢‘ç‡ä¹Ÿä¸º400MHz\n2. periph2_clk æ—¶é’Ÿé€‰æ‹©å™¨ï¼Œç”± CBCDR å¯„å­˜å™¨çš„ PERIPH2_CLK_SEL ä½(bit26)æ§åˆ¶ï¼Œç½®0æ—¶é€‰æ‹©pll2_main_clkä½œä¸ºperiph2_clkçš„æ—¶é’Ÿæºï¼Œå› æ­¤`periph2_clk = PLL2_PFD0 = 396MHz`\n3. åˆ†é¢‘å™¨ï¼Œç”± CBCDR å¯„å­˜å™¨çš„ FABRIC_MMDC_PODF ä½(bit5:3)è®¾ç½®ï¼Œ0 - 7 å¯¹åº”1 - 8 åˆ†é¢‘ï¼Œæ­¤å¤„åº”è®¾ç½®1åˆ†é¢‘ï¼Œå³è¯¥ä½ç½®0\n\n### DDRé©±åŠ¨\n1. ä½¿ç”¨excelè¡¨ç”Ÿæˆincæ–‡ä»¶\n2. åŠ è½½incè‡³NXP DDR Test Toolï¼Œè¿æ¥USB OTGçº¿ï¼Œè®¾ç½®MCUä»USBå¯åŠ¨ï¼Œå¼€å§‹æ ¡å‡†\n3. æ ¡å‡†åçš„å¯„å­˜å™¨æ•°æ®å›å¡«è‡³incæ–‡ä»¶ï¼Œé‡æ–°ä¸‹è½½ï¼Œè¿›è¡Œå‹åŠ›æµ‹è¯•\n","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"IMX6ULLå¤–éƒ¨ä¸­æ–­é…ç½®","url":"/2025/03/04/IMX6ULLå¤–éƒ¨ä¸­æ–­é…ç½®/","content":"## Cortex-A7ä¸­æ–­ç³»ç»Ÿ\n### ä¸­æ–­å‘é‡è¡¨\nCortex-A7çš„ä¸­æ–­å‘é‡è¡¨å…±æœ‰8ä¸ªå¼‚å¸¸ä¸­æ–­ï¼Œå…¶ä¸­ä¸€ä¸ªæœªä½¿ç”¨ï¼Œæœ‰æ•ˆä¸­æ–­ä¸º7ä¸ªï¼š\n\n| å‘é‡åœ°å€ | ä¸­æ–­ç±»å‹                           | ä¸­æ–­æ¨¡å¼             |\n| ---- | ------------------------------ | ---------------- |\n| 0X00 | å¤ä½ä¸­æ–­(Rest)                     | ç‰¹æƒæ¨¡å¼(SVC)        |\n| 0X04 | æœªå®šä¹‰æŒ‡ä»¤ä¸­æ–­(Undefined Instruction) | æœªå®šä¹‰æŒ‡ä»¤ä¸­æ­¢æ¨¡å¼(Undef) |\n| 0X08 | è½¯ä¸­æ–­(Software Interrupt,SWI)    | ç‰¹æƒæ¨¡å¼(SVC)        |\n| 0X0C | æŒ‡ä»¤é¢„å–ä¸­æ­¢ä¸­æ–­(Prefetch Abort)       | ä¸­æ­¢æ¨¡å¼             |\n| 0X10 | æ•°æ®è®¿é—®ä¸­æ­¢ä¸­æ–­(Data Abort)           | ä¸­æ­¢æ¨¡å¼             |\n| 0X14 | æœªä½¿ç”¨(Not Used)                  | æœªä½¿ç”¨              |\n| 0X18 | IRQ ä¸­æ–­(IRQ Interrupt)          | å¤–éƒ¨ä¸­æ–­æ¨¡å¼(IRQ)      |\n| 0X1C | FIQ ä¸­æ–­(FIQ Interrupt)          | å¿«é€Ÿä¸­æ–­æ¨¡å¼(FIQ)      |\n\nä¸åŒäºCortex-Måœ¨ä¸­æ–­å‘é‡è¡¨ä¸­åˆ—å‡ºäº†æ‰€æœ‰çš„ä¸­æ–­å‘é‡ï¼ŒCortex-Aå°†æ‰€æœ‰å±äºå†…æ ¸CPUçš„å¤–éƒ¨ä¸­æ–­æ”¾åœ¨0x18çš„IRQä¸­æ–­ä¸­ï¼Œä»»æ„å¤–éƒ¨ä¸­æ–­éƒ½ä¼šè§¦å‘IRQä¸­æ–­ï¼Œç„¶ååœ¨IRQä¸­æ–­ä¸­é€šè¿‡è¯»å–å¯„å­˜å™¨çš„æ–¹å¼æ¥åˆ¤æ–­å…·ä½“çš„ä¸­æ–­ç±»å‹ï¼Œç„¶ååšå‡ºç›¸åº”å¤„ç†ã€‚\n\n### æ±‡ç¼–ä»£ç (å¯åŠ¨æ–‡ä»¶`start.S`)\n#### ä¸­æ–­å‘é‡è¡¨\n```\n.global _start  \t\t\t\t/* å…¨å±€æ ‡å· */\n\n_start:\n\tldr pc, =Reset_Handler\t\t/* å¤ä½ä¸­æ–­ \t\t\t\t\t*/\t\n\tldr pc, =Undefined_Handler\t/* æœªå®šä¹‰ä¸­æ–­ \t\t\t\t\t*/\n\tldr pc, =SVC_Handler\t\t/* SVC(Supervisor)ä¸­æ–­ \t\t*/\n\tldr pc, =PrefAbort_Handler\t/* é¢„å–ç»ˆæ­¢ä¸­æ–­ \t\t\t\t\t*/\n\tldr pc, =DataAbort_Handler\t/* æ•°æ®ç»ˆæ­¢ä¸­æ–­ \t\t\t\t\t*/\n\tldr\tpc, =NotUsed_Handler\t/* æœªä½¿ç”¨ä¸­æ–­\t\t\t\t\t*/\n\tldr pc, =IRQ_Handler\t\t/* IRQä¸­æ–­ \t\t\t\t\t*/\n\tldr pc, =FIQ_Handler\t\t/* FIQ(å¿«é€Ÿä¸­æ–­)æœªå®šä¹‰ä¸­æ–­ \t\t\t*/\n```\næŒ‡å®šä¸­æ–­å‘ç”Ÿåè°ƒç”¨å¯¹åº”çš„ä¸­æ–­å¤ä½å‡½æ•°ã€‚`pc`ä¸ºç¨‹åºè®¡æ•°å™¨ï¼Œç”¨æ¥æŒ‡å‡ºä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨ä¸»å­˜å‚¨å™¨ä¸­çš„åœ°å€ã€‚ä¸­æ–­å‘ç”Ÿåï¼Œä¸»ç¨‹åºçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ä¼šè‡ªåŠ¨æ›´æ–°ä¸ºä¸­æ–­æœåŠ¡å‡½æ•°çš„åœ°å€ã€‚\n\n### GICæ§åˆ¶å™¨\n![GIC v2æ¡†å›¾](/images/linux/GIC_1.png)\n\nç±»ä¼¼äºSTM32çš„NVICï¼ŒCortex-Açš„ä¸­æ–­æ§åˆ¶å™¨åå­—å«GICï¼ŒGICè´Ÿè´£å¤„ç†è¾“å…¥çš„æ‰€æœ‰ä¸­æ–­ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªIRQä¿¡å·ä¸ŠæŠ¥ç»™ARMå†…æ ¸ã€‚GICå°†ä¼—å¤šçš„ä¸­æ–­æºåˆ†ä¸ºä¸‰ç±»ï¼š\n- SPIï¼Œå…±äº«ä¸­æ–­ï¼Œå¸¸è§å¤–éƒ¨ä¸­æ–­å‡å±äºSPIä¸­æ–­\n- PPIï¼Œç§æœ‰ä¸­æ–­ï¼ŒæŒ‡å®šæ ¸å¿ƒå¤„ç†\n- SGIï¼Œè½¯ä»¶ä¸­æ–­ï¼Œé€šè¿‡å‘å¯„å­˜å™¨`GICR_SGIR`å†™å…¥æ•°æ®è§¦å‘ï¼Œå¸¸ç”¨äºå¤šæ ¸é€šä¿¡\n\n### ä¸­æ–­ID\nI.MX6ULçš„1020ä¸ªä¸­æ–­IDåˆ†é…å¦‚ä¸‹ï¼š\n- ID0 - ID15ï¼šåˆ†é…è‡³SGI\n- ID16 - ID31ï¼šåˆ†é…è‡³PPI\n- ID32 - ID1019ï¼šåˆ†é…è‡³SPI\n\nI.MX6Uçš„ä¸­æ–­æºç”±å®˜æ–¹SDKåœ¨`MCIMX6Y2.h`ä¸­ç»™å‡ºï¼Œå…±æœ‰160ä¸ªï¼Œæ¯ä¸ªä¸­æ–­æºæœ‰ç‹¬å±çš„ä¸­æ–­IDã€‚\n\n### GICé€»è¾‘åˆ†å—\nGICæ¶æ„åˆ†ä¸ºä¸¤ä¸ªé€»è¾‘å—ï¼š\n- Distributorï¼šåˆ†å‘å™¨ç«¯ï¼Œè´Ÿè´£å¤„ç†ä¸­æ–­äº‹ä»¶åˆ†å‘é—®é¢˜ï¼ˆä¸­æ–­äº‹ä»¶è¯¥å‘é€åˆ°å“ªä¸ªCPU Interfaceä¸Šå»ï¼‰ã€‚åˆ†å‘å™¨æ”¶é›†æ‰€æœ‰çš„ä¸­æ–­æºï¼Œå¯æ§åˆ¶æ¯ä¸ªä¸­æ–­çš„ä¼˜å…ˆçº§ï¼Œå…·ä½“åŠŸèƒ½æœ‰ï¼š\n    1. å…¨å±€ä¸­æ–­ä½¿èƒ½æ§åˆ¶\n    2. æ§åˆ¶æ¯ä¸ªä¸­æ–­çš„ä½¿èƒ½æˆ–å…³é—­\n    3. è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§\n    4. è®¾ç½®æ¯ä¸ªä¸­æ–­çš„ç›®æ ‡å¤„ç†å™¨åˆ—è¡¨\n    5. è®¾ç½®æ¯ä¸ªå¤–éƒ¨ä¸­æ–­çš„è§¦å‘æ¨¡å¼ï¼šç”µå¹³è§¦å‘æˆ–è¾¹æ²¿è§¦å‘\n    6. è®¾ç½®æ¯ä¸ªä¸­æ–­å±äºç»„ 0 è¿˜æ˜¯ç»„ 1\n- CPU Interfaceï¼šCPUæ¥å£ç«¯ï¼Œå…·ä½“åŠŸèƒ½æœ‰ï¼š\n    1. ä½¿èƒ½æˆ–è€…å…³é—­å‘é€åˆ° CPU Core çš„ä¸­æ–­è¯·æ±‚ä¿¡å·\n    2. åº”ç­”ä¸­æ–­\n    3. é€šçŸ¥ä¸­æ–­å¤„ç†å®Œæˆ\n    4. è®¾ç½®ä¼˜å…ˆçº§æ©ç ï¼Œé€šè¿‡æ©ç æ¥è®¾ç½®å“ªäº›ä¸­æ–­ä¸éœ€è¦ä¸ŠæŠ¥ç»™ CPU Core\n    5. å®šä¹‰æŠ¢å ç­–ç•¥\n    6. å½“å¤šä¸ªä¸­æ–­åˆ°æ¥çš„æ—¶å€™ï¼Œé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ä¸­æ–­é€šçŸ¥ç»™ CPU Core\n\nGICæ§åˆ¶å™¨çš„æ‰€æœ‰å¯„å­˜å™¨åœ¨`core_ca7.h`ä¸­å£°æ˜ï¼š\n```\n/*\n * GICå¯„å­˜å™¨æè¿°ç»“æ„ä½“ï¼Œ\n * GICåˆ†ä¸ºåˆ†å‘å™¨ç«¯å’ŒCPUæ¥å£ç«¯\n */\ntypedef struct\n{\n        uint32_t RESERVED0[1024];\n  __IOM uint32_t D_CTLR;                 /*!< Offset: 0x1000 (R/W) Distributor Control Register */\n  __IM  uint32_t D_TYPER;                /*!< Offset: 0x1004 (R/ )  Interrupt Controller Type Register */\n  __IM  uint32_t D_IIDR;                 /*!< Offset: 0x1008 (R/ )  Distributor Implementer Identification Register */\n        uint32_t RESERVED1[29];\n  __IOM uint32_t D_IGROUPR[16];          /*!< Offset: 0x1080 - 0x0BC (R/W) Interrupt Group Registers */\n        uint32_t RESERVED2[16];\n  __IOM uint32_t D_ISENABLER[16];        /*!< Offset: 0x1100 - 0x13C (R/W) Interrupt Set-Enable Registers */\n        uint32_t RESERVED3[16];\n  __IOM uint32_t D_ICENABLER[16];        /*!< Offset: 0x1180 - 0x1BC (R/W) Interrupt Clear-Enable Registers */\n        uint32_t RESERVED4[16];\n  __IOM uint32_t D_ISPENDR[16];          /*!< Offset: 0x1200 - 0x23C (R/W) Interrupt Set-Pending Registers */\n        uint32_t RESERVED5[16];\n  __IOM uint32_t D_ICPENDR[16];          /*!< Offset: 0x1280 - 0x2BC (R/W) Interrupt Clear-Pending Registers */\n        uint32_t RESERVED6[16];\n  __IOM uint32_t D_ISACTIVER[16];        /*!< Offset: 0x1300 - 0x33C (R/W) Interrupt Set-Active Registers */\n        uint32_t RESERVED7[16];\n  __IOM uint32_t D_ICACTIVER[16];        /*!< Offset: 0x1380 - 0x3BC (R/W) Interrupt Clear-Active Registers */\n        uint32_t RESERVED8[16];\n  __IOM uint8_t  D_IPRIORITYR[512];      /*!< Offset: 0x1400 - 0x5FC (R/W) Interrupt Priority Registers */\n        uint32_t RESERVED9[128];\n  __IOM uint8_t  D_ITARGETSR[512];       /*!< Offset: 0x1800 - 0x9FC (R/W) Interrupt Targets Registers */\n        uint32_t RESERVED10[128];\n  __IOM uint32_t D_ICFGR[32];            /*!< Offset: 0x1C00 - 0xC7C (R/W) Interrupt configuration registers */\n        uint32_t RESERVED11[32];\n  __IM  uint32_t D_PPISR;                /*!< Offset: 0x1D00 (R/ ) Private Peripheral Interrupt Status Register */\n  __IM  uint32_t D_SPISR[15];            /*!< Offset: 0x1D04 - 0xD3C (R/ ) Shared Peripheral Interrupt Status Registers */\n        uint32_t RESERVED12[112];\n  __OM  uint32_t D_SGIR;                 /*!< Offset: 0x1F00 ( /W) Software Generated Interrupt Register */\n        uint32_t RESERVED13[3];\n  __IOM uint8_t  D_CPENDSGIR[16];        /*!< Offset: 0x1F10 - 0xF1C (R/W) SGI Clear-Pending Registers */\n  __IOM uint8_t  D_SPENDSGIR[16];        /*!< Offset: 0x1F20 - 0xF2C (R/W) SGI Set-Pending Registers */\n        uint32_t RESERVED14[40];\n  __IM  uint32_t D_PIDR4;                /*!< Offset: 0x1FD0 (R/ ) Peripheral ID4 Register */\n  __IM  uint32_t D_PIDR5;                /*!< Offset: 0x1FD4 (R/ ) Peripheral ID5 Register */\n  __IM  uint32_t D_PIDR6;                /*!< Offset: 0x1FD8 (R/ ) Peripheral ID6 Register */\n  __IM  uint32_t D_PIDR7;                /*!< Offset: 0x1FDC (R/ ) Peripheral ID7 Register */\n  __IM  uint32_t D_PIDR0;                /*!< Offset: 0x1FE0 (R/ ) Peripheral ID0 Register */\n  __IM  uint32_t D_PIDR1;                /*!< Offset: 0x1FE4 (R/ ) Peripheral ID1 Register */\n  __IM  uint32_t D_PIDR2;                /*!< Offset: 0x1FE8 (R/ ) Peripheral ID2 Register */\n  __IM  uint32_t D_PIDR3;                /*!< Offset: 0x1FEC (R/ ) Peripheral ID3 Register */\n  __IM  uint32_t D_CIDR0;                /*!< Offset: 0x1FF0 (R/ ) Component ID0 Register */\n  __IM  uint32_t D_CIDR1;                /*!< Offset: 0x1FF4 (R/ ) Component ID1 Register */\n  __IM  uint32_t D_CIDR2;                /*!< Offset: 0x1FF8 (R/ ) Component ID2 Register */\n  __IM  uint32_t D_CIDR3;                /*!< Offset: 0x1FFC (R/ ) Component ID3 Register */\n\n  __IOM uint32_t C_CTLR;                 /*!< Offset: 0x2000 (R/W) CPU Interface Control Register */\n  __IOM uint32_t C_PMR;                  /*!< Offset: 0x2004 (R/W) Interrupt Priority Mask Register */\n  __IOM uint32_t C_BPR;                  /*!< Offset: 0x2008 (R/W) Binary Point Register */\n  __IM  uint32_t C_IAR;                  /*!< Offset: 0x200C (R/ ) Interrupt Acknowledge Register */\n  __OM  uint32_t C_EOIR;                 /*!< Offset: 0x2010 ( /W) End Of Interrupt Register */\n  __IM  uint32_t C_RPR;                  /*!< Offset: 0x2014 (R/ ) Running Priority Register */\n  __IM  uint32_t C_HPPIR;                /*!< Offset: 0x2018 (R/ ) Highest Priority Pending Interrupt Register */\n  __IOM uint32_t C_ABPR;                 /*!< Offset: 0x201C (R/W) Aliased Binary Point Register */\n  __IM  uint32_t C_AIAR;                 /*!< Offset: 0x2020 (R/ ) Aliased Interrupt Acknowledge Register */\n  __OM  uint32_t C_AEOIR;                /*!< Offset: 0x2024 ( /W) Aliased End Of Interrupt Register */\n  __IM  uint32_t C_AHPPIR;               /*!< Offset: 0x2028 (R/ ) Aliased Highest Priority Pending Interrupt Register */\n        uint32_t RESERVED15[41];\n  __IOM uint32_t C_APR0;                 /*!< Offset: 0x20D0 (R/W) Active Priority Register */\n        uint32_t RESERVED16[3];\n  __IOM uint32_t C_NSAPR0;               /*!< Offset: 0x20E0 (R/W) Non-secure Active Priority Register */\n        uint32_t RESERVED17[6];\n  __IM  uint32_t C_IIDR;                 /*!< Offset: 0x20FC (R/ ) CPU Interface Identification Register */\n        uint32_t RESERVED18[960];\n  __OM  uint32_t C_DIR;                  /*!< Offset: 0x3000 ( /W) Deactivate Interrupt Register */\n} GIC_Type;\n```\nä¸è¿‡ï¼Œè¿™é‡Œåªç»™å‡ºäº†GICå„å¯„å­˜å™¨çš„åç§»åœ°å€ï¼ŒåŸºåœ°å€éœ€è¦é€šè¿‡CP15åå¤„ç†å™¨è·å–ã€‚\n\n### CP15åå¤„ç†å™¨\nCP15åå¤„ç†å™¨å…±æœ‰16ä¸ª32ä½å¯„å­˜å™¨ã€‚å¯¹CP15åå¤„ç†å™¨çš„è®¿é—®å¯é€šè¿‡ä¸‹åˆ—æŒ‡ä»¤å®Œæˆï¼š\n- **MRC**ï¼šå°†CP15çš„å¯„å­˜å™¨æ•°æ®è¯»å–åˆ°ARMå¯„å­˜å™¨ä¸­\n- **MCR**ï¼šå°†ARMå¯„å­˜å™¨æ•°æ®å†™å…¥åˆ°CP15å¯„å­˜å™¨ä¸­ã€‚æ ¼å¼ï¼š`MCR{cond} p15, <opc1>, <Rt>, <CRn>, <CRm>, <opc2>`\n    + condï¼šæŒ‡ä»¤æ‰§è¡Œçš„æ¡ä»¶ç ã€‚è‹¥å¿½ç•¥ï¼Œè¡¨ç¤ºæ— æ¡ä»¶æ‰§è¡Œ\n    + opc1ï¼šCP15è¦æ‰§è¡Œçš„æ“ä½œç \n    + Rtï¼šARMæºå¯„å­˜å™¨\n    + CRnï¼šCP15çš„ç›®æ ‡å¯„å­˜å™¨\n    + CRmï¼šCP15ä¸­é™„åŠ çš„ç›®æ ‡å¯„å­˜å™¨æˆ–æºæ“ä½œæ•°å¯„å­˜å™¨ã€‚å¦‚ä¸éœ€è¦é™„åŠ ä¿¡æ¯ï¼Œè¯¥ä½åº”è®¾ç½®ä¸º`c0`\n    + opc2ï¼šå¯é€‰çš„CP15ç‰¹å®šæ“ä½œç ï¼Œä¸éœ€è¦æ—¶è®¾ç½®ä¸º0\n\nCP15çš„16ä¸ªå¯„å­˜å™¨åœ¨è¢«MRCå’ŒMCRæŒ‡ä»¤è®¿é—®æ—¶ï¼ŒæŒ‡ä»¤ä¸­çš„å‚æ•°æ­é…è‹¥ä¸åŒï¼Œå¾—åˆ°çš„å¯„å­˜å™¨å«ä¹‰ä¹Ÿä¸åŒã€‚ä»¥c0å¯„å­˜å™¨ä¸ºä¾‹ï¼š\n\n![CP15 c0å¯„å­˜å™¨å‚æ•°æ­é…](/images/linux/GIC_2.png)\n\nä¾‹å¦‚ï¼Œå½“`opc1 = 0`, `CRm = c0`, `opc2 = 0`æ—¶ï¼Œæ­¤æ—¶c0æ˜¯MIDRå¯„å­˜å™¨ï¼Œå³ä¸»IDå¯„å­˜å™¨ï¼ŒåŒ…å«å‚å•†ç¼–å·ã€ä¸»ç‰ˆæœ¬å·ã€æ¶æ„ä»£ç ç­‰ä¿¡æ¯ã€‚\n\nå¯¹äºc15å¯„å­˜å™¨:\n![CP15 c15å¯„å­˜å™¨å‚æ•°æ­é…](/images/linux/GIC_3.png)\n\nå¯è§GICåŸºåœ°å€ä¿å­˜åœ¨CBARä¸­ï¼Œå› æ­¤å¯é€šè¿‡`MRC p15, 4, r1, c15, c0, 0`æŒ‡ä»¤è·å–GICåŸºåœ°å€è‡³r1ä¸­ã€‚ç°åœ¨å°±å¯ä»¥è®¾ç½®GICçš„å¯„å­˜å™¨äº†ï¼Œæ¯”å¦‚ï¼šè¯»å–å½“å‰ä¸­æ–­IDï¼Œå°†IDä¿å­˜åœ¨`GICC_IAR`ä¸­ï¼ŒSDKä¸­å·²ç»ç»™å‡º`GICC_IAR`çš„åç§»åœ°å€`__IM  uint32_t C_IAR;                  /*!< Offset: 0x200C (R/ ) Interrupt Acknowledge Register */`ä¸º`0x200C`ï¼Œå› æ­¤è·å–å½“å‰ä¸­æ–­IDçš„æ±‡ç¼–ä»£ç ä¸ºï¼š\n```\nMRC p15, 5, r1, c15, c0 ,0  ;è·å–GICåŸºåœ°å€\nADD r1, r1, #0x2000         ;åŸºåœ°å€+0x2000å¾—åˆ°CPUæ¥å£ç«¯å¯„å­˜å™¨èµ·å§‹åœ°å€\nLDR r0, [r1, #0xC]          ;è¯»å–GIC_IARçš„å€¼\n```\næ€»ç»“ï¼š\n- c0å¯„å­˜å™¨å¯è·å–åˆ°å¤„ç†å™¨å†…æ ¸ä¿¡æ¯\n- c1å¯„å­˜å™¨å¯ä½¿èƒ½æˆ–ç¦æ­¢MMUã€I/D Cache\n- c12å¯„å­˜å™¨å¯è®¾ç½®ä¸­æ–­å‘é‡åç§»\n- c15å¯è·å–GICåŸºåœ°å€\n\n### ä¸­æ–­ä½¿èƒ½\n#### IRQå’ŒFIQæ€»ä¸­æ–­ä½¿èƒ½\næ±‡ç¼–ä¸‹æ”¯æŒä»¥ä¸‹å¿«æ·æŒ‡ä»¤ï¼š\n| æŒ‡ä»¤      | æè¿°      |\n| ------- | ------- |\n| cpsid i | ç¦æ­¢IRQä¸­æ–­ |\n| cpsie i | ä½¿èƒ½IRQä¸­æ–­ |\n| cpsid f | ç¦æ­¢FIQä¸­æ–­ |\n| cpsie f | ä½¿èƒ½FIQä¸­æ–­ |\n\n#### ID0 - ID1019 ä¸­æ–­ä½¿èƒ½å’Œç¦æ­¢\nç”±ä»¥ä¸‹å¯„å­˜å™¨å®Œæˆï¼š\n- `GICD_ISENABLERn`ï¼š`GICD_ISENABLER0`çš„bit[15:0]å¯¹åº”ID15 - 0çš„SGIä¸­æ–­ï¼Œbit[31:16]å¯¹åº”ID31 - 16çš„PPIä¸­æ–­\n- `GICD_ICENABLERn`ï¼š`GICD_ISENABLER1` - `GICD_ISENABLER15`æ§åˆ¶SPIä¸­æ–­\n\n### ä¸­æ–­ä¼˜å…ˆçº§\n#### ä¼˜å…ˆçº§æ•°é‡é…ç½®\n`GICC_PMR`å¯„å­˜å™¨ç”¨äºé…ç½®ä¼˜å…ˆçº§æ•°é‡ï¼Œå¯„å­˜å™¨ä½8ä½æœ‰æ•ˆã€‚I.MX6Uæ˜¯Cortex-A7å†…æ ¸ï¼Œæ”¯æŒ32ä¸ªä¼˜å…ˆçº§ï¼Œå› æ­¤`GICC_PMR`è®¾ç½®ä¸º`0b11111000`.\n\n#### æŠ¢å ä¼˜å…ˆçº§å’Œå­ä¼˜å…ˆçº§ä½æ•°é…ç½®\næŠ¢å ä¼˜å…ˆçº§å’Œå­ä¼˜å…ˆçº§å„å å¤šå°‘ä½ç”±å¯„å­˜å™¨`GICC_BPR`å†³å®šï¼Œä½3ä½æœ‰æ•ˆï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š\n| Binary Point | æŠ¢å ä¼˜å…ˆçº§åŸŸ | å­ä¼˜å…ˆçº§åŸŸ | æè¿°                |\n| ------------ | ------ | ----- | ----------------- |\n| 0            | [7:1]  | [0]   | 7 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ1 çº§å­ä¼˜å…ˆçº§ã€‚ |\n| 1            | [7:2]  | [1:0] | 6 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ2 çº§å­ä¼˜å…ˆçº§ã€‚ |\n| 2            | [7:3]  | [2:0] | 5 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ3 çº§å­ä¼˜å…ˆçº§ã€‚ |\n| 3            | [7:4]  | [3:0] | 4 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ4 çº§å­ä¼˜å…ˆçº§ã€‚ |\n| 4            | [7:5]  | [4:0] | 3 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ5 çº§å­ä¼˜å…ˆçº§ã€‚ |\n| 5            | [7:6]  | [5:0] | 2 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ6 çº§å­ä¼˜å…ˆçº§ã€‚ |\n| 6            | [7:7]  | [6:0] | 1 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ7 çº§å­ä¼˜å…ˆçº§ã€‚ |\n| 7            | æ—       | [7:0] | 0 çº§æŠ¢å ä¼˜å…ˆçº§ï¼Œ8 çº§å­ä¼˜å…ˆçº§ã€‚ |\n\nä¸€èˆ¬è€Œè¨€æ‰€æœ‰çš„ä¸­æ–­ä¼˜å…ˆçº§ä½éƒ½é…ç½®ä¸ºæŠ¢å ä¼˜å…ˆçº§ã€‚å¦‚IMX6Uçš„ä¼˜å…ˆçº§ä½æ•°ä¸º5ï¼ˆ32ä¸ªä¼˜å…ˆçº§ï¼‰ï¼Œå¯è®¾ç½®Binary pointä¸º2ï¼Œè¡¨ç¤º5ä¸ªä¼˜å…ˆçº§ä½å…¨éƒ¨ä¸ºæŠ¢å ä¼˜å…ˆçº§ã€‚\n\n#### ä¼˜å…ˆçº§è®¾ç½®\næŸä¸ªä¸­æ–­IDçš„ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®ç”±å¯„å­˜å™¨`GICD_IPRIORITYR`å®Œæˆï¼Œæ¯ä¸ªä¸­æ–­IDé…æœ‰ä¸€ä¸ªè¯¥å¯„å­˜å™¨ï¼Œå…±512ä¸ªã€‚å¦‚æœä¼˜å…ˆçº§ä¸ªæ•°ä¸º32ï¼Œå³ä½¿ç”¨`GICD_IPRIORITYR`çš„bit[7:4]æ¥è®¾ç½®ä¼˜å…ˆçº§ï¼ˆå®é™…ä¼˜å…ˆçº§å·¦ç§»3ä½ï¼‰ã€‚ä¾‹å¦‚ï¼Œè¦è®¾ç½®ID == 40ä¸­æ–­ä¼˜å…ˆçº§ä¸º5ï¼š`GICD_IPRIORITYR[40] = 5 << 3`\n\næ€»ç»“ä¸€ä¸‹ï¼Œä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®åˆ†ä¸‰éƒ¨åˆ†ï¼š\n1. è®¾ç½®`GICC_PMR`ï¼Œé…ç½®ä¼˜å…ˆçº§ä¸ªæ•°ï¼ŒIMX6Uä¸º32çº§\n2. è®¾ç½®æŠ¢å ä¼˜å…ˆçº§å’Œå­ä¼˜å…ˆçº§ä½æ•°ï¼Œä¸€èˆ¬é»˜è®¤æ‰€æœ‰ä½æ•°éƒ½ä¸ºæŠ¢å ä¼˜å…ˆçº§\n3. è®¾ç½®æŒ‡å®šä¸­æ–­IDçš„ä¼˜å…ˆçº§\n\n### å¤ä½ä¸­æ–­æœåŠ¡å‡½æ•°\næ•´ä¸ªå¯åŠ¨æ–‡ä»¶åœ¨è®¾ç½®å®Œä¸­æ–­å‘é‡è¡¨åï¼Œè¦è¿›è¡Œå¤ä½ä¸­æ–­çš„è®¾ç½®ï¼Œå…¶åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\n1. è®¾ç½®å¤ä½ä¸­æ–­ï¼šå…³é—­IRQï¼Œç„¶åå…³é—­I/D Cacheã€MMUã€å¯¹é½æ£€æµ‹å’Œåˆ†æ”¯é¢„æµ‹\n2. è¿›è¡Œä¸­æ–­å‘é‡è¡¨é‡æ˜ å°„\n3. è®¾ç½®IRQæ¨¡å¼ã€SYSæ¨¡å¼å’ŒSVCæ¨¡å¼ä¸‹çš„æ ˆæŒ‡é’ˆï¼Œæ ˆå¤§å°å‡ä¸º2MB\n4. æ‰“å¼€IRQä¸­æ–­\n5. è·³è½¬è‡³mainå‡½æ•°\n```\n/* å¤ä½ä¸­æ–­ */\t\nReset_Handler:\n\n\tcpsid i\t\t\t\t\t\t/* å…³é—­å…¨å±€ä¸­æ–­ */\n\n\t/* å…³é—­I,DCacheå’ŒMMU \n\t * é‡‡å–è¯»-æ”¹-å†™çš„æ–¹å¼ã€‚\n\t */\n\tmrc     p15, 0, r0, c1, c0, 0     /* è¯»å–CP15çš„C1å¯„å­˜å™¨åˆ°R0ä¸­       \t\t        \t*/\n    bic     r0,  r0, #(0x1 << 12)     /* æ¸…é™¤C1å¯„å­˜å™¨çš„bit12ä½(Iä½)ï¼Œå…³é—­I Cache            \t*/\n    bic     r0,  r0, #(0x1 <<  2)     /* æ¸…é™¤C1å¯„å­˜å™¨çš„bit2(Cä½)ï¼Œå…³é—­D Cache    \t\t\t\t*/\n    bic     r0,  r0, #0x2             /* æ¸…é™¤C1å¯„å­˜å™¨çš„bit1(Aä½)ï¼Œå…³é—­å¯¹é½\t\t\t\t\t\t*/\n    bic     r0,  r0, #(0x1 << 11)     /* æ¸…é™¤C1å¯„å­˜å™¨çš„bit11(Zä½)ï¼Œå…³é—­åˆ†æ”¯é¢„æµ‹\t\t\t\t\t*/\n    bic     r0,  r0, #0x1             /* æ¸…é™¤C1å¯„å­˜å™¨çš„bit0(Mä½)ï¼Œå…³é—­MMU\t\t\t\t       \t*/\n    mcr     p15, 0, r0, c1, c0, 0     /* å°†r0å¯„å­˜å™¨ä¸­çš„å€¼å†™å…¥åˆ°CP15çš„C1å¯„å­˜å™¨ä¸­\t \t\t\t\t*/\n\n#if 0\n\t/* æ±‡ç¼–ç‰ˆæœ¬è®¾ç½®ä¸­æ–­å‘é‡è¡¨åç§» */\n\tldr r0, =0X87800000\n\n\tdsb\n\tisb\n\tmcr p15, 0, r0, c12, c0, 0\n\tdsb\n\tisb\n#endif\n    \n\t/* è®¾ç½®å„ä¸ªæ¨¡å¼ä¸‹çš„æ ˆæŒ‡é’ˆï¼Œ\n\t * æ³¨æ„ï¼šIMX6ULçš„å †æ ˆæ˜¯å‘ä¸‹å¢é•¿çš„ï¼\n\t * å †æ ˆæŒ‡é’ˆåœ°å€ä¸€å®šè¦æ˜¯4å­—èŠ‚åœ°å€å¯¹é½çš„ï¼ï¼ï¼\n\t * DDRèŒƒå›´:0X80000000~0X9FFFFFFF\n\t */\n\t/* è¿›å…¥IRQæ¨¡å¼ */\n\tmrs r0, cpsr\n\tbic r0, r0, #0x1f \t/* å°†r0å¯„å­˜å™¨ä¸­çš„ä½5ä½æ¸…é›¶ï¼Œä¹Ÿå°±æ˜¯cpsrçš„M0~M4 \t*/\n\torr r0, r0, #0x12 \t/* r0æˆ–ä¸Š0x13,è¡¨ç¤ºä½¿ç”¨IRQæ¨¡å¼\t\t\t\t\t*/\n\tmsr cpsr, r0\t\t/* å°†r0 çš„æ•°æ®å†™å…¥åˆ°cpsr_cä¸­ \t\t\t\t\t*/\n\tldr sp, =0x80600000\t/* è®¾ç½®IRQæ¨¡å¼ä¸‹çš„æ ˆé¦–åœ°å€ä¸º0X80600000,å¤§å°ä¸º2MB */\n\n\t/* è¿›å…¥SYSæ¨¡å¼ */\n\tmrs r0, cpsr\n\tbic r0, r0, #0x1f \t/* å°†r0å¯„å­˜å™¨ä¸­çš„ä½5ä½æ¸…é›¶ï¼Œä¹Ÿå°±æ˜¯cpsrçš„M0~M4 \t*/\n\torr r0, r0, #0x1f \t/* r0æˆ–ä¸Š0x13,è¡¨ç¤ºä½¿ç”¨SYSæ¨¡å¼\t\t\t\t\t*/\n\tmsr cpsr, r0\t\t/* å°†r0 çš„æ•°æ®å†™å…¥åˆ°cpsr_cä¸­ \t\t\t\t\t*/\n\tldr sp, =0x80400000\t/* è®¾ç½®SYSæ¨¡å¼ä¸‹çš„æ ˆé¦–åœ°å€ä¸º0X80400000,å¤§å°ä¸º2MB */\n\n\t/* è¿›å…¥SVCæ¨¡å¼ */\n\tmrs r0, cpsr\n\tbic r0, r0, #0x1f \t/* å°†r0å¯„å­˜å™¨ä¸­çš„ä½5ä½æ¸…é›¶ï¼Œä¹Ÿå°±æ˜¯cpsrçš„M0~M4 \t*/\n\torr r0, r0, #0x13 \t/* r0æˆ–ä¸Š0x13,è¡¨ç¤ºä½¿ç”¨SVCæ¨¡å¼\t\t\t\t\t*/\n\tmsr cpsr, r0\t\t/* å°†r0 çš„æ•°æ®å†™å…¥åˆ°cpsr_cä¸­ \t\t\t\t\t*/\n\tldr sp, =0X80200000\t/* è®¾ç½®SVCæ¨¡å¼ä¸‹çš„æ ˆé¦–åœ°å€ä¸º0X80200000,å¤§å°ä¸º2MB */\n\n\tcpsie i\t\t\t\t/* æ‰“å¼€å…¨å±€ä¸­æ–­ */\n#if 0\n\t/* ä½¿èƒ½IRQä¸­æ–­ */\n\tmrs r0, cpsr\t\t/* è¯»å–cpsrå¯„å­˜å™¨å€¼åˆ°r0ä¸­ \t\t\t*/\n\tbic r0, r0, #0x80\t/* å°†r0å¯„å­˜å™¨ä¸­bit7æ¸…é›¶ï¼Œä¹Ÿå°±æ˜¯CPSRä¸­çš„Iä½æ¸…é›¶ï¼Œè¡¨ç¤ºå…è®¸IRQä¸­æ–­ */\n\tmsr cpsr, r0\t\t/* å°†r0é‡æ–°å†™å…¥åˆ°cpsrä¸­ \t\t\t*/\n#endif\n\n\tb main\t\t\t\t/* è·³è½¬åˆ°mainå‡½æ•° \t\t\t \t*/\n```\n### å…¶ä»–ä¸­æ–­\n```\n/* æœªå®šä¹‰ä¸­æ–­ */\nUndefined_Handler:\n\tldr r0, =Undefined_Handler\n\tbx r0\n\n/* SVCä¸­æ–­ */\nSVC_Handler:\n\tldr r0, =SVC_Handler\n\tbx r0\n\n/* é¢„å–ç»ˆæ­¢ä¸­æ–­ */\nPrefAbort_Handler:\n\tldr r0, =PrefAbort_Handler\t\n\tbx r0\n\n/* æ•°æ®ç»ˆæ­¢ä¸­æ–­ */\nDataAbort_Handler:\n\tldr r0, =DataAbort_Handler\n\tbx r0\n\n/* æœªä½¿ç”¨çš„ä¸­æ–­ */\nNotUsed_Handler:\n\n\tldr r0, =NotUsed_Handler\n\tbx r0\n\n    /* FIQä¸­æ–­ */\nFIQ_Handler:\n\n\tldr r0, =FIQ_Handler\t\n\tbx r0\t\n```\n\n### IRQä¸­æ–­æœåŠ¡å‡½æ•°\næ‰€æœ‰çš„å¤–éƒ¨ä¸­æ–­éƒ½ä¼šè§¦å‘IRQä¸­æ–­ï¼Œå› æ­¤IRQä¸­æ–­æœåŠ¡å‡½æ•°çš„å·¥ä½œå°±æ˜¯è·å–å½“å‰å‘ç”Ÿçš„ä¸­æ–­IDä»¥ç¡®å®šä¸­æ–­æ¥æºï¼Œç„¶åæ ¹æ®ä¸åŒçš„å¤–éƒ¨ä¸­æ–­æ¥è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚è¿™é‡Œä¼šæ¶‰åŠåˆ°å‡ ä¸ªARMä¸­å¸¸ç”¨çš„å¯„å­˜å™¨ï¼š\n- IPå¯„å­˜å™¨ï¼šå†…éƒ¨ç¨‹åºè°ƒç”¨æš‚å­˜å¯„å­˜å™¨ï¼Œå­ç¨‹åºçš„è¿æ¥textæ®µä¸­å¸¸ä½¿ç”¨è¯¥è§„åˆ™\n- SPå¯„å­˜å™¨ï¼šæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨å½“å‰æ ˆé¡¶åœ°å€ã€‚ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ˆæ˜¯ç”¨æ¥å­˜å‚¨ä¸´æ—¶å˜é‡ã€å‡½æ•°è°ƒç”¨è¿”å›åœ°å€ç­‰æ•°æ®çš„é‡è¦æ•°æ®ç»“æ„ï¼ŒSPå¯„å­˜å™¨çš„å€¼ä¼šéšç€æ ˆçš„å˜åŒ–è€Œå˜åŒ–\n- LRå¯„å­˜å™¨ï¼šè¿æ¥å¯„å­˜å™¨ï¼Œç¨‹åºè·³è½¬ï¼ˆå­ç¨‹åºè°ƒç”¨ï¼Œä¸­æ–­è·³è½¬ï¼‰åï¼Œarmè‡ªåŠ¨åœ¨è¯¥å¯„å­˜å™¨ä¸­å­˜å…¥åŸç¨‹åºï¼ˆæœªè·³è½¬ï¼‰çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå«å‡½æ•°è°ƒç”¨è¿”å›åœ°å€ã€‚å½“ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼ŒLRå¯„å­˜å™¨ä¼šå­˜å‚¨è°ƒç”¨è¯¥å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œç¨‹åºä¼šè·³è½¬åˆ°LRå¯„å­˜å™¨ä¸­å­˜å‚¨çš„åœ°å€ç»§ç»­æ‰§è¡Œã€‚\n- PCå¯„å­˜å™¨ï¼šç¨‹åºè®¡æ•°å™¨ï¼Œä¿å­˜çš„æ˜¯å½“å‰æ­£åœ¨å–æŒ‡çš„æŒ‡ä»¤çš„åœ°å€ï¼ˆarmé‡‡ç”¨2çº§æµæ°´çº¿ï¼Œå› æ­¤æ˜¯å½“å‰æ­£åœ¨æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€+8ï¼‰ã€‚PCå¯„å­˜å™¨æ˜¯ARMä¸­çš„ç¨‹åºè®¡æ•°å™¨ï¼Œç”¨äºå­˜å‚¨ä¸‹ä¸€æ¡å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ã€‚\n\næ­¤å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„çŠ¶æ€å¯„å­˜å™¨ï¼š\n- CPSRï¼šç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼Œåœ¨ä»»ä½•å¤„ç†å™¨æ¨¡å¼ä¸‹è¢«è®¿é—®ã€‚å®ƒåŒ…å«äº†æ¡ä»¶æ ‡å¿—ä½ã€ä¸­æ–­ç¦æ­¢ä½ã€å½“å‰å¤„ç†å™¨æ¨¡å¼æ ‡å¿—ä»¥åŠå…¶ä»–çš„ä¸€äº›æ§åˆ¶å’ŒçŠ¶æ€ä½ã€‚CPSRåœ¨ç”¨æˆ·çº§ç¼–ç¨‹æ—¶ç”¨äºå­˜å‚¨æ¡ä»¶ç ã€‚\n- SPSRï¼šç¨‹åºçŠ¶æ€ä¿å­˜å¯„å­˜å™¨ï¼Œæ¯ä¸€ç§å¤„ç†å™¨æ¨¡å¼ä¸‹éƒ½æœ‰ä¸€ä¸ªçŠ¶æ€å¯„å­˜å™¨SPSR,SPSRç”¨äºä¿å­˜CPSRçš„çŠ¶æ€ï¼Œä»¥ä¾¿å¼‚å¸¸è¿”å›åæ¢å¤å¼‚å¸¸å‘ç”Ÿæ—¶çš„å·¥ä½œçŠ¶æ€ã€‚å½“ç‰¹å®šçš„å¼‚å¸¸ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªå¯„å­˜å™¨ç”¨äºå­˜æ”¾å½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨çš„å†…å®¹ã€‚åœ¨å¼‚å¸¸ä¸­æ–­é€€å‡ºæ—¶ï¼Œå¯ä»¥ç”¨SPSRæ¥æ¢å¤CPSRã€‚ç”±äºç”¨æˆ·æ¨¡å¼å’Œç³»ç»Ÿæ¨¡å¼ä¸æ˜¯å¼‚å¸¸ä¸­æ–­æ¨¡å¼ï¼Œæ‰€ä»¥ä»–æ²¡æœ‰SPSRã€‚å½“ç”¨æˆ·åœ¨ç”¨æˆ·æ¨¡å¼æˆ–ç³»ç»Ÿæ¨¡å¼è®¿é—®SPSRï¼Œå°†äº§ç”Ÿä¸å¯é¢„çŸ¥çš„åæœã€‚\n\näºŒè€…å¸¸ç”¨äºMRSæˆ–MSRæŒ‡ä»¤,ç”¨äºspsrä¸­çš„å€¼è½¬ç§»åˆ°å¯„å­˜å™¨æˆ–æŠŠå¯„å­˜å™¨çš„å†…å®¹åŠ è½½åˆ°spsrä¸­ï¼Œå¦‚:\n\n```\nmrs r0, spsr                /* è¯»å–spsrå¯„å­˜å™¨ */\nmsr spsr_cxsf, r0            /* æ¢å¤spsr */\n```\n\nIRQä¸­æ–­æœåŠ¡å‡½æ•°çš„ç¼–å†™å¤§è‡´åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\n1. è¿›å…¥IRQæ¨¡å¼ï¼Œä¿å­˜ä¸Šä¸‹æ–‡ã€‚ARMåœ¨è¿›å…¥IRQæ¨¡å¼ä¼šè‡ªåŠ¨åˆ‡æ¢LRå’ŒSPSRï¼Œä½†ä¸ä¼šè‡ªåŠ¨ä¿å­˜å…¶ä»–å¯„å­˜å™¨ï¼Œå› æ­¤éœ€æ‰‹åŠ¨ä¿å­˜r0-r3å’Œr12å¯„å­˜å™¨ï¼ˆåç»­æ“ä½œå¯èƒ½ä¿®æ”¹ï¼‰ã€‚è‡ªåŠ¨åˆ‡æ¢æ—¶ï¼ŒLRä¿å­˜è¢«ä¸­æ–­æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤`-4`ã€‚\n\n```\n/* IRQä¸­æ–­ */\nIRQ_Handler:\n\tpush {lr}\t\t\t\t\t/* ä¿å­˜lråœ°å€ */\n\tpush {r0-r3, r12}\t\t\t/* ä¿å­˜r0-r3ï¼Œr12å¯„å­˜å™¨ */\n```\n\n2. ä¿å­˜ç°åœºã€‚SPSRå­˜å‚¨è¢«ä¸­æ–­å‰CPUçš„æ¨¡å¼çŠ¶æ€ï¼Œå¿…é¡»ä¿å­˜SPSRä»¥æ­£ç¡®æ¢å¤ä¸­æ–­å‰çš„æ‰§è¡Œç¯å¢ƒã€‚\n```\n\tmrs r0, spsr\t\t\t\t/* è¯»å–spsrå¯„å­˜å™¨ */\n\tpush {r0}\t\t\t\t\t/* ä¿å­˜spsrå¯„å­˜å™¨ */\n```\n\n3. è·å–GICä¸­æ–­å·ã€‚é€šè¿‡MRCå‘cp15è¯»å–å¯„å­˜å™¨ä»¥è·å–GICåŸºå€ï¼Œä»è€Œè®¡ç®—GICC_IARåœ°å€å¹¶è¯»å–ï¼Œè¯»å–åè‡ªåŠ¨æ ‡è®°è¯¥ä¸­æ–­ä¸ºactiveçŠ¶æ€ï¼Œè·å–åˆ°çš„ä¸­æ–­å·`r0`ä½œä¸ºå‚æ•°ä¼ é€’ç»™Cè¯­è¨€ISRã€‚\n```\n\tmrc p15, 4, r1, c15, c0, 0 /* è¯»å–CP15çš„C0å¯„å­˜å™¨å†…çš„å€¼åˆ°R1å¯„å­˜å™¨ä¸­\n\t\t\t\t\t\t\t\t* å‚è€ƒæ–‡æ¡£ARM Cortex-A(armV7)ç¼–ç¨‹æ‰‹å†ŒV4.0.pdf P49\n\t\t\t\t\t\t\t\t* Cortex-A7 Technical ReferenceManua.pdf P68 P138\n\t\t\t\t\t\t\t\t*/\t\t\t\t\t\t\t\n\tadd r1, r1, #0X2000\t\t\t/* GICåŸºåœ°å€åŠ 0X2000ï¼Œä¹Ÿå°±æ˜¯GICçš„CPUæ¥å£ç«¯åŸºåœ°å€ */\n\tldr r0, [r1, #0XC]\t\t\t/* GICçš„CPUæ¥å£ç«¯åŸºåœ°å€åŠ 0X0Cå°±æ˜¯GICC_IARå¯„å­˜å™¨ï¼Œ\n\t\t\t\t\t\t\t\t * GICC_IARå¯„å­˜å™¨ä¿å­˜è¿™å½“å‰å‘ç”Ÿä¸­æ–­çš„ä¸­æ–­å·ï¼Œæˆ‘ä»¬è¦æ ¹æ®\n\t\t\t\t\t\t\t\t * è¿™ä¸ªä¸­æ–­å·æ¥ç»å¯¹è°ƒç”¨å“ªä¸ªä¸­æ–­æœåŠ¡å‡½æ•°\n\t\t\t\t\t\t\t\t */\n\tpush {r0, r1}\t\t\t\t/* ä¿å­˜r0,r1 */\n```\n\n4. åˆ‡æ¢è‡³SVCæ¨¡å¼å¹¶è°ƒç”¨Cå‡½æ•°ã€‚IARæ¨¡å¼æ ˆç©ºé—´æœ‰é™ï¼Œåˆ‡æ¢è‡³SVCæ¨¡å¼ï¼ˆç‰¹æƒæ¨¡å¼ï¼‰ä»¥è·å¾—æ›´å¤§çš„æ ˆç©ºé—´ï¼Œå¹¶å…è®¸Cå‡½æ•°å¤„ç†æ›´å¤æ‚çš„é€»è¾‘ï¼Œå¦‚ä¸­æ–­åµŒå¥—ã€‚\n```\n\tcps #0x13\t\t\t\t\t/* è¿›å…¥SVCæ¨¡å¼ï¼Œå…è®¸å…¶ä»–ä¸­æ–­å†æ¬¡è¿›å» */\n\t\n\tpush {lr}\t\t\t\t\t/* ä¿å­˜SVCæ¨¡å¼çš„lrå¯„å­˜å™¨ */\n\tldr r2, =system_irqhandler\t/* åŠ è½½Cè¯­è¨€ä¸­æ–­å¤„ç†å‡½æ•°åˆ°r2å¯„å­˜å™¨ä¸­*/\n\tblx r2\t\t\t\t\t\t/* è¿è¡ŒCè¯­è¨€ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œå¸¦æœ‰ä¸­æ–­å·å‚æ•°ï¼Œä¿å­˜åœ¨R0å¯„å­˜å™¨ä¸­ */\n```\n\n5. æ¢å¤æ¨¡å¼å¹¶å‘é€ä¸­æ–­ç»“æŸä¿¡å·ã€‚å‘å‘GICçš„End of Interrupt Register (GICC_EOIR) å†™å…¥ä¸­æ–­å·ï¼Œå‘ŠçŸ¥ä¸­æ–­æ§åˆ¶å™¨è¯¥ä¸­æ–­å·²å¤„ç†å®Œæ¯•ã€‚\n```\n\tpop {lr}\t\t\t\t\t/* æ‰§è¡Œå®ŒCè¯­è¨€ä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œlrå‡ºæ ˆ */\n\tcps #0x12\t\t\t\t\t/* è¿›å…¥IRQæ¨¡å¼ */\n\tpop {r0, r1}\t\t\t\t\n\tstr r0, [r1, #0X10]\t\t\t/* ä¸­æ–­æ‰§è¡Œå®Œæˆï¼Œå†™EOIR */\n```\n\t\n6. æ¢å¤ä¸­æ–­å‰çŠ¶æ€å¹¶è¿”å›ã€‚\n\nè¿™é‡Œæ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“æé”™çš„ç‚¹ã€‚ARMä½¿ç”¨ä¸‰çº§æµæ°´çº¿æœºåˆ¶ï¼šå–æŒ‡->è¯‘æŒ‡->æ‰§è¡Œï¼Œè€Œæˆ‘ä»¬æ€»ä»¥æ‰§è¡Œä½ç½®ä½œä¸ºå‚è€ƒç‚¹ï¼Œå› æ­¤PCæ°¸è¿œæ˜¯å½“å‰æ‰§è¡Œä½ç½®`+8`ï¼›LRå­˜æ”¾å‡½æ•°è°ƒç”¨ç»“æŸåè¿”å›ç»§ç»­æ‰§è¡Œçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„ä¸‹ä¸€æ¡(`+4`)ã€‚è¿›å…¥IRQä¸­æ–­æ—¶ï¼Œä¸­æ–­æ€»æ˜¯åœ¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤åå†è¿›å…¥ï¼Œæ­¤æ—¶PCæ›´æ–°ä¸º`+12`ï¼Œç›¸åº”çš„LRå˜ä¸º`+8`ï¼Œç„¶åLRè¢«å…¥æ ˆä¿å­˜ã€‚å¦‚æœä¸­æ–­ç»“æŸåï¼Œç›´æ¥å°†LRå‡ºæ ˆï¼Œç¨‹åºä¼šä»`+8`å¤„å¼€å§‹è¿è¡Œï¼Œé‚£ä¹ˆ`+4`å¤„çš„æŒ‡ä»¤å°±ç›´æ¥è¢«è·³è¿‡äº†ã€‚å› æ­¤ï¼Œä¸­æ–­ç»“æŸåå°†LRå‡ºæ ˆæ—¶ï¼Œè¦å°†LR`-4`ã€‚\n\nç”¨è¡¨æ ¼å¯ä»¥è§£é‡Šä¸ºï¼š\n|      |            | çŠ¶æ€Aï¼šä¸­æ–­å‰ | çŠ¶æ€Bï¼šè¿›å…¥ä¸­æ–­å | çŠ¶æ€Cï¼šä¸­æ–­æ¢å¤          |\n| ---- | ---------- | ------- | --------- | ----------------- |\n| 0x00 | MOV R1, R0 | å‡†å¤‡æ‰§è¡Œ    | å·²æ‰§è¡Œ       |                   |\n| 0x04 | MOV R2, R1 | LR      |           | LRï¼ˆæ¢å¤ä¸ºçŠ¶æ€Aæ—¶çš„PCå€¼-4ï¼‰ |\n| 0x08 | MOV R3, R2 | PC      | LRï¼ˆå·²å…¥æ ˆï¼‰   |                   |\n| 0x0c | MOV R4 ,R3 |         |           |                   |\n|      | PCå€¼        | 0x08    | 0x12      | ç”±LRå€¼å†³å®š            |\n|      | LRå€¼        | 0x04    | 0x08      | 0x04              |\n\nå†é€šä¿—ä¸€ç‚¹ï¼šPCå§‹ç»ˆæŒ‡å‘å½“å‰æ‰§è¡ŒæŒ‡ä»¤+8ï¼Œå‘ç”Ÿä¸­æ–­æ—¶ï¼Œå…¥æ ˆä¿å­˜çš„LRå®é™…ä¸Šæ˜¯PCçš„åœ°å€ï¼Œå¦‚æœè¿”å›æ—¶å°†LRç›´æ¥èµ‹ç»™PCï¼Œä¸­é—´å°±è·³è¿‡äº†ä¸€ä¸ªæŒ‡ä»¤ï¼Œå› æ­¤LRå‡ºæ ˆåè¦`-4`æ‰èƒ½èµ‹ç»™PCã€‚\n```\n\tpop {r0}\t\t\t\t\t\t\n\tmsr spsr_cxsf, r0\t\t\t/* æ¢å¤spsr */\n\n\tpop {r0-r3, r12}\t\t\t/* r0-r3,r12å‡ºæ ˆ */\n\tpop {lr}\t\t\t\t\t/* lrå‡ºæ ˆ */\n\tsubs pc, lr, #4\t\t\t\t/* å°†è®¡ç®—åçš„åœ°å€ï¼ˆlr-4ï¼‰èµ‹ç»™pc */\t\n```\n### ä¸­æ–­é©±åŠ¨æ–‡ä»¶ï¼ˆCå‡½æ•°ï¼‰\n1. ä¸­æ–­åˆå§‹åŒ–å‡½æ•°ã€‚å‘é‡è¡¨åŸºåœ°å€è®¾ç½®ä¸ºç¨‹åºå­˜æ”¾å¼€å§‹åœ°å€ã€‚\n```\nvoid int_init(void) {\n    GIC_Init();                        // åˆå§‹åŒ–é€šç”¨ä¸­æ–­æ§åˆ¶å™¨ï¼Œè¯¥å‡½æ•°ç”±SDKæä¾›\n    system_irqtable_init();            // åˆå§‹åŒ–ä¸­æ–­å‡½æ•°è¡¨\n    __set_VBAR((uint32_t)0x87800000);  // è®¾ç½®å‘é‡è¡¨åŸºåœ°å€\n}\n```\n\n2. ä¸­æ–­å‘é‡è¡¨åˆå§‹åŒ–ã€‚å°†æ‰€æœ‰ä¸­æ–­åˆå§‹åŒ–ä¸ºdefault_irqhandlerï¼ˆæ­»å¾ªç¯ï¼‰ï¼Œå¼ºåˆ¶å¼€å‘è€…æ˜¾å¼æ³¨å†Œæœ‰æ•ˆISRï¼Œé¿å…æœªå¤„ç†ä¸­æ–­å¯¼è‡´ä¸å¯æ§è¡Œä¸ºã€‚\n```\nvoid system_irqtable_init(void) {\n    unsigned int i = 0;\n    irqNesting = 0;  // é‡ç½®åµŒå¥—è®¡æ•°å™¨\n    \n    for(i = 0; i < NUMBER_OF_INT_VECTORS; i++) {\n        system_register_irqhandler((IRQn_Type)i, default_irqhandler, NULL);\n    }\n}\n```\n\n3. ä¸­æ–­æ³¨å†Œå‡½æ•°ã€‚ç”¨äºç»‘å®šä¸­æ–­æœåŠ¡å‡½æ•°å’Œä¸­æ–­æºã€‚\n```\nvoid system_register_irqhandler(IRQn_Type irq, system_irq_handler_t handler, void *userParam) {\n    irqTable[irq].irqHandler = handler;   // æ³¨å†Œå¤„ç†å‡½æ•°\n    irqTable[irq].userParam = userParam;  // ç»‘å®šç”¨æˆ·å‚æ•°\n}\n```\n\n4. ä¸­æ–­åˆ†å‘å™¨ã€‚é»˜è®¤å…è®¸ä¸­æ–­åµŒå¥—ã€‚\n```\nvoid system_irqhandler(unsigned int giccIar) {\n    uint32_t intNum = giccIar & 0x3FFUL;  // æå–ä¸­æ–­å·\n    \n    /* æ ¡éªŒä¸­æ–­å·æœ‰æ•ˆæ€§ */\n    if ((intNum == 1023) || (intNum >= NUMBER_OF_INT_VECTORS)) {\n        return;  // éæ³•ä¸­æ–­å·ï¼ˆ1023ä¼ªä¸­æ–­æˆ–ä¸­æ–­å·ä¸åœ¨è¡¨å†…ï¼‰ç›´æ¥è¿”å›\n    }\n \n    irqNesting++;  // åµŒå¥—è®¡æ•°å¢åŠ \n    \n    /* è°ƒç”¨æ³¨å†Œçš„ISR */\n    irqTable[intNum].irqHandler(intNum, irqTable[intNum].userParam);\n \n    irqNesting--;  // åµŒå¥—è®¡æ•°å‡å°‘\n}\n```\n\n### ä¸­æ–­å¤„ç†å…¨æµç¨‹\n1. ç¡¬ä»¶è§¦å‘ï¼šå¤–è®¾è§¦å‘ä¸­æ–­ï¼ŒGICå°†ä¸­æ–­è¯·æ±‚å‘é€è‡³CPUã€‚\n2. æ±‡ç¼–å…¥å£ï¼šCPUè·³è½¬è‡³IRQ_Handlerï¼Œä¿å­˜ä¸Šä¸‹æ–‡å¹¶è°ƒç”¨system_irqhandler(giccIar)ã€‚\n3. ä¸­æ–­åˆ†å‘ï¼š\n    - è§£ægiccIarè·å–æœ‰æ•ˆä¸­æ–­å·\n    - æŸ¥è¡¨irqTable[intNum]è·å–å¤„ç†å‡½æ•°å’Œå‚æ•°\n4. ISRæ‰§è¡Œï¼šæ‰§è¡Œç”¨æˆ·æ³¨å†Œçš„å‡½æ•°ï¼ˆå¦‚uart_isrï¼‰ï¼Œå¤„ç†å…·ä½“ä¸­æ–­ä»»åŠ¡ã€‚\n5. ä¸­æ–­ç»“æŸï¼šæ±‡ç¼–ä»£ç å†™GICC_EOIRé€šçŸ¥GICå¤„ç†å®Œæˆã€‚\n\n\t\t\t\t\t\n## ç¤ºä¾‹ï¼ˆå®šæ—¶å™¨æŒ‰é”®æ¶ˆæŠ–ï¼‰\nå®ç°åŠŸèƒ½ï¼š\n1. æŒ‰ä¸‹æŒ‰é”®ï¼Œè¿›å…¥å¤–éƒ¨ä¸­æ–­ï¼Œåœ¨ä¸­æ–­ä¸­å¼€å¯å®šæ—¶å™¨\n2. å®šæ—¶å™¨ä¸­æ–­ä¸­å®Œæˆæ¶ˆæŠ–å»¶æ—¶ï¼Œä¸­æ–­å‘¨æœŸå³ä¸ºå»¶æ—¶æ—¶é—´ã€‚å¦‚æœå®šæ—¶ä¸­æ–­è§¦å‘ï¼Œè¡¨ç¤ºæ¶ˆæŠ–å®Œæˆï¼Œæ‰§è¡ŒæŒ‰é”®å¤„ç†å‡½æ•°\n### æŒ‰é”®åˆå§‹åŒ–\n1. è®¾ç½®GPIOå¤ç”¨å’ŒConfig\n2. å¡«å……gpioç»“æ„ä½“ï¼Œåˆå§‹åŒ–gpio\n3. ä½¿èƒ½ä¸­æ–­ï¼Œæ³¨å†ŒISRï¼ˆç»‘å®šä¸­æ–­æºå’Œå¯¹åº”çš„ISRï¼‰\n4. åˆå§‹åŒ–å®šæ—¶å™¨\n```\nvoid filterkey_init(void)\n{\t\n\tgpio_pin_config_t key_config;\n\t\n\t/* 1ã€åˆå§‹åŒ–IOå¤ç”¨ */\n\tIOMUXC_SetPinMux(IOMUXC_UART1_CTS_B_GPIO1_IO18,0);\t/* å¤ç”¨ä¸ºGPIO1_IO18 */\n\n\t/* 2ã€ã€é…ç½®GPIO1_IO18çš„IOå±æ€§\t\n\t *bit 16:0 HYSå…³é—­\n\t *bit [15:14]: 11 é»˜è®¤22Kä¸Šæ‹‰\n\t *bit [13]: 1 pullåŠŸèƒ½\n\t *bit [12]: 1 pull/keeperä½¿èƒ½\n\t *bit [11]: 0 å…³é—­å¼€è·¯è¾“å‡º\n\t *bit [7:6]: 10 é€Ÿåº¦100Mhz\n\t *bit [5:3]: 000 å…³é—­è¾“å‡º\n\t *bit [0]: 0 ä½è½¬æ¢ç‡\n\t */\n\tIOMUXC_SetPinConfig(IOMUXC_UART1_CTS_B_GPIO1_IO18,0xF080);\n\t\n\t/* 3ã€åˆå§‹åŒ–GPIOä¸ºä¸­æ–­ */\n\tkey_config.direction = kGPIO_DigitalInput;          /* è¾“å…¥ */\n\tkey_config.interruptMode = kGPIO_IntFallingEdge;    /* ä¸‹é™æ²¿è§¦å‘ */\n\tkey_config.outputLogic = 1;\n\tgpio_init(GPIO1, 18, &key_config);\n\n\tGIC_EnableIRQ(GPIO1_Combined_16_31_IRQn); /* ä½¿èƒ½GICä¸­å¯¹åº”çš„ä¸­æ–­ */\n\t\n\t/* æ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•° */\n\tsystem_register_irqhandler(GPIO1_Combined_16_31_IRQn, \n\t\t\t\t\t\t\t   (system_irq_handler_t)gpio1_16_31_irqhandler, \n\t\t\t\t\t\t\t   NULL);\n\t\n\tgpio_enableint(GPIO1, 18);\t\t/* ä½¿èƒ½GPIO1_IO18çš„ä¸­æ–­åŠŸèƒ½ */\n\n\tfiltertimer_init(66000000/100);\t/* åˆå§‹åŒ–å®šæ—¶å™¨,10ms */\n}\n```\n\n### å®šæ—¶å™¨åˆå§‹åŒ–\n```\nvoid filtertimer_init(unsigned int value)\n{\n\tEPIT1->CR = 0;\t//å…ˆæ¸…é›¶\n\t\n\t/*\n     * CRå¯„å­˜å™¨:\n     * bit25:24 01 æ—¶é’Ÿæºé€‰æ‹©Peripheral clock=66MHz\n     * bit15:4  0  1åˆ†é¢‘\n     * bit3:\t1  å½“è®¡æ•°å™¨åˆ°0çš„è¯ä»LRé‡æ–°åŠ è½½æ•°å€¼\n     * bit2:\t1  æ¯”è¾ƒä¸­æ–­ä½¿èƒ½\n     * bit1:    1  åˆå§‹è®¡æ•°å€¼æ¥æºäºLRå¯„å­˜å™¨å€¼\n     * bit0:    0  å…ˆå…³é—­EPIT1\n     */\n\tEPIT1->CR = (1<<24 | 1<<3 | 1<<2 | 1<<1);\n\n\t/* è®¡æ•°å€¼ */\n\tEPIT1->LR = value;\n\t\n\t/* æ¯”è¾ƒå¯„å­˜å™¨ï¼Œå½“è®¡æ•°å™¨å€¼å’Œæ­¤å¯„å­˜å™¨å€¼ç›¸ç­‰çš„è¯å°±ä¼šäº§ç”Ÿä¸­æ–­ */\n\tEPIT1->CMPR\t= 0;\t\n\t\n\tGIC_EnableIRQ(EPIT1_IRQn);\t/* ä½¿èƒ½GICä¸­å¯¹åº”çš„ä¸­æ–­ */\n\t\n\t/* æ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°\t\t    */\n\tsystem_register_irqhandler(EPIT1_IRQn, (system_irq_handler_t)filtertimer_irqhandler, NULL);\t\n}\n```\n\n\n### GPIO ISRå‡½æ•°\n```\nvoid gpio1_16_31_irqhandler(void)\n{ \n\t/* å¼€å¯å®šæ—¶å™¨ */\n\tfiltertimer_restart(66000000/100);\n\n\t/* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ */\n\tgpio_clearintflags(GPIO1, 18);\n}\n```\n\n### å®šæ—¶å™¨ ISRå‡½æ•°\n```\nvoid filtertimer_irqhandler(void)\n{ \n\tstatic unsigned char state = OFF;\n\n\tif(EPIT1->SR & (1<<0)) \t\t\t\t\t/* åˆ¤æ–­æ¯”è¾ƒäº‹ä»¶æ˜¯å¦å‘ç”Ÿ\t\t\t*/\n\t{\n\t\tfiltertimer_stop();\t\t\t\t\t/* å…³é—­å®šæ—¶å™¨ \t\t\t\t*/\n\t\tif(gpio_pinread(GPIO1, 18) == 0)\t/* KEY0 \t\t\t\t*/\n\t\t{\n\t\t\tstate = !state;\n\t\t\tbeep_switch(state);\t\t\t\t/* åè½¬èœ‚é¸£å™¨ \t\t\t\t*/\n\t\t}\n\t}\n\t\t\n\tEPIT1->SR |= 1<<0; \t\t\t\t\t\t/* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ \t\t\t\t*/\n}\n```\n\n### è¾…åŠ©å‡½æ•°\n```\nvoid filtertimer_stop(void)\n{\n\tEPIT1->CR &= ~(1<<0);\t/* å…³é—­å®šæ—¶å™¨ */\n}\n\nvoid filtertimer_restart(unsigned int value)\n{\n\tEPIT1->CR &= ~(1<<0);\t/* å…ˆå…³é—­å®šæ—¶å™¨ */\n\tEPIT1->LR = value;\t\t/* è®¡æ•°å€¼ \t\t\t*/\n\tEPIT1->CR |= (1<<0);\t/* æ‰“å¼€å®šæ—¶å™¨ \t\t*/\n}\n```","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"I.MX6ULL æ—¶é’Ÿé…ç½®","url":"/2025/03/03/æ—¶é’Ÿé…ç½®/","content":"## æ—¶é’Ÿæ¥æºå’Œç”Ÿæˆ\n![/images/linux/clock_1.png](æ—¶é’Ÿç”Ÿæˆæ¥æº)\nåŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæ—¶é’Ÿæ¥æºï¼š\n1. å¤–éƒ¨æ™¶æŒ¯ï¼Œé«˜é€Ÿæ™¶æŒ¯é¢‘ç‡24Mhzï¼Œä½é€Ÿæ™¶æŒ¯é¢‘ç‡32.768KHz\n2. ä½å‹å·®åˆ†ä¿¡å· (LVDS) I/O ç«¯å£ï¼Œç”¨äºä»å¤–éƒ¨è·å–æ—¶é’Ÿä¿¡å·\n3. é”ç›¸ç¯(PLL)ï¼Œä¸»æ—¶é’ŸåŒ…å«ä¸ƒä¸ª PLLã€‚å…¶ä¸­ä¸¤ä¸ª PLL åˆ†åˆ«é…å¤‡å››ä¸ªç›¸ä½å°æ•°åˆ†é¢‘å™¨ (PFD)ï¼Œä»¥ç”Ÿæˆé¢å¤–çš„é¢‘ç‡ã€‚\n\nä¸ƒä¸ªPLLåŒ…æ‹¬ï¼š\n- PLL1(ARM_PLL)ï¼ŒARMå†…æ ¸æ—¶é’Ÿï¼Œæœ€é«˜å¯å€é¢‘è‡³1.3GHz(ä½†MCUæœ€é«˜ä»…æ”¯æŒåˆ°1.0GHz)\n- PLL2(SYS_PLL/528_PLL)ï¼Œå›ºå®šå€é¢‘22å€ï¼Œä»å¤–éƒ¨é«˜é€Ÿæ™¶æŒ¯çš„24MHzå€é¢‘äº§ç”Ÿ528MHzï¼Œè‡ªå¸¦å››ä¸ªPFDã€‚é€šå¸¸528_PLLå’Œ4è·¯PFDæ˜¯MX6Uå†…éƒ¨ç³»ç»Ÿæ€»çº¿çš„æ—¶é’Ÿæºï¼Œå¦‚é€»è¾‘å•å…ƒã€DDRã€NAND/NORè®¾å¤‡ç­‰\n- PLL3(USB1_PLL)ï¼ŒUSB PHYçš„ç¬¬ä¸€ä¸ªå®ä¾‹ï¼ˆUSBPHY1ï¼Œä¹Ÿç§°ä¸º OTG PHYï¼‰ä¸€èµ·ä½¿ç”¨ã€‚æ­¤ PLL é©±åŠ¨å››ä¸ª PFDï¼ˆPLL3_PFD0...PLL3_PFD3ï¼‰å¹¶ä»¥å›ºå®šä¹˜æ•° 20 è¿è¡Œã€‚è¿™å¯¼è‡´ VCO é¢‘ç‡ä¸º 480 MHzï¼ŒæŒ¯è¡å™¨ä¸º 24 MHzã€‚ä¸» PLL è¾“å‡ºåŠå…¶ PFD è¾“å‡ºç”¨ä½œè®¸å¤šéœ€è¦æ’å®šé¢‘ç‡çš„æ—¶é’Ÿæ ¹çš„è¾“å…¥ï¼Œä¾‹å¦‚ UART å’Œå…¶ä»–ä¸²è¡Œæ¥å£ã€éŸ³é¢‘æ¥å£ç­‰\n- PLL4(Audio_PLL)ï¼Œç”¨äºç”Ÿæˆå…·æœ‰æ ‡å‡†éŸ³é¢‘é¢‘ç‡çš„ä½æŠ–åŠ¨å’Œé«˜ç²¾åº¦éŸ³é¢‘æ—¶é’Ÿã€‚å…¶é¢‘ç‡èŒƒå›´ä¸º 650 MHz è‡³ 1300 MHzï¼Œé¢‘ç‡åˆ†è¾¨ç‡ä¼˜äº 1 Hzã€‚è¯¥æ—¶é’Ÿä¸»è¦ç”¨ä½œä¸²è¡ŒéŸ³é¢‘æ¥å£çš„æ—¶é’Ÿå’Œå¤–éƒ¨éŸ³é¢‘ç¼–è§£ç å™¨çš„å‚è€ƒæ—¶é’Ÿã€‚\n- PLL5(Video_PLL)ï¼Œç”¨äºç”Ÿæˆå…·æœ‰æ ‡å‡†è§†é¢‘é¢‘ç‡çš„ä½æŠ–åŠ¨å’Œé«˜ç²¾åº¦è§†é¢‘æ—¶é’Ÿã€‚PLL æŒ¯è¡å™¨é¢‘ç‡èŒƒå›´ä¸º 650 MHz è‡³ 1300 MHzï¼Œé¢‘ç‡åˆ†è¾¨ç‡ä¼˜äº 1 Hzã€‚è¯¥æ—¶é’Ÿä¸»è¦ç”¨ä½œæ˜¾ç¤ºå’Œè§†é¢‘æ¥å£çš„æ—¶é’Ÿã€‚\n- PLL6(ENET_PLL)ï¼Œå›ºå®š(20+5/6)å€é¢‘ï¼Œè¾“å‡º500MHzï¼Œç”¨äºç”Ÿæˆä»¥å¤ªç½‘\n- PLL7(USB2_PLL)ï¼Œä¸“é—¨ä¸º USB2 PHYï¼ˆUSBPHY2ï¼Œä¹Ÿç§°ä¸º OTG PHYï¼‰æä¾›æ—¶é’Ÿï¼Œå›ºå®šå€é¢‘ 20ï¼Œè¾“å‡ºé¢‘ç‡480MHz\n\n## CCMæ—¶é’Ÿæ ‘\n![æ—¶é’Ÿæ ‘(1)](/images/linux/clock_2.png)\n\n![æ—¶é’Ÿæ ‘(2)](/images/linux/clock_3.png)\n\nå…·ä½“å‚è§æ‰‹å†Œç¬¬629é¡µã€‚\n\n## æ—¶é’Ÿé…ç½®\nä»¥ARMæ—¶é’Ÿé…ç½®ä¸ºä¾‹ï¼š\n\n![ARMæ—¶é’Ÿ](/images/linux/clock_4.png)\n\næ—¶é’Ÿä»PLL1çš„996MHzå¼€å§‹ï¼Œé€šè¿‡å¯„å­˜å™¨CCM_CACRRçš„ARM_PODFä½è¿›è¡Œåˆ†é¢‘ï¼Œå¯é€‰1/2/4/8åˆ†é¢‘ï¼Œç„¶åå¾—åˆ°ARMæ—¶é’ŸARM_CLK_ROOTã€‚ç°è‰²çš„/2åˆ†é¢‘å¹¶æœªå®é™…æ•ˆæœã€‚å…¶ä¸­PLL1é¢‘ç‡å¯é€šè¿‡å¯„å­˜å™¨CCM_ANALOG_PLL_ARMnè®¾ç½®ã€‚\n\n![CCM_CACRRå¯„å­˜å™¨](/images/linux/clock_5.png)\n\n![CCM_ANALOG_PLL_ARMnå¯„å­˜å™¨](/images/linux/clock_6.png)\n\nä¿®æ”¹PLL1æ—¶é’Ÿæ—¶è¦é¦–å…ˆè¦åˆ‡æ¢å†…æ ¸æ—¶é’Ÿæºã€‚\n\n![PLL1æ—¶é’Ÿæº](/images/linux/clock_7.png)\n1. PLL1æœ€ç»ˆè¾“å‡ºæ—¶é’Ÿé¢‘ç‡ã€‚\n2. é€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©pll1çš„æ—¶é’Ÿæºï¼Œç”±CCM_CCSRçš„PLL1_SW_CLK_SELä½å†³å®šã€‚é»˜è®¤ä¸ºpll1_main_clkï¼Œä½†å¦‚æœè¦è°ƒæ•´pll1_main_clké¢‘ç‡ï¼Œåˆ™é¦–å…ˆåº”å°†pll_sw_clkåˆ‡æ¢è‡³step_clkï¼Œè°ƒæ•´å®Œæˆåå†åˆ‡æ¢å›æ¥ã€‚\n3. é€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©step_clkçš„æ—¶é’Ÿæºï¼Œç”±CCM_CCSRçš„STEP_SELä½å†³å®šã€‚é»˜è®¤ä¸ºosc_clkï¼Œå³å¤–éƒ¨é«˜é€Ÿæ™¶æŒ¯ã€‚\n\n![CCM_CCSRå¯„å­˜å™¨](/images/linux/clock_8.png)\n\nè‡³æ­¤ï¼Œä¿®æ”¹I.MX6Uä¸»é¢‘çš„æ­¥éª¤å¯ä»¥å½’çº³ä¸ºï¼š\n1. è®¾ç½®CCM_CCSRçš„STEP_SELä½ï¼Œè®¾ç½®step_clkæ—¶é’Ÿæºä¸ºå¤–éƒ¨24MHzé«˜é€Ÿæ™¶æŒ¯\n2. è®¾ç½®CCM_CCSRçš„PLL1_SW_CLK_SELä½ï¼Œè®¾ç½®pll_sw_clkæ¥æºä¸ºstep_clk=24Mhz\n3. è®¾ç½®CCM_ANALOG_PLL_ARMnï¼Œå°†pll1_main_clkè®¾ç½®ä¸º1056MHz\n4. è®¾ç½®CCM_CCSRçš„PLL1_SW_CLK_SELä½ï¼Œå°†pll1_sw_clkæ—¶é’Ÿæºåˆ‡æ¢å›pll1_main_clk\n5. è®¾ç½®CCM_CACRRçš„ARM_PODFä¸º2åˆ†é¢‘ï¼Œå®Œæˆåˆ†é¢‘è®¾ç½®\n\nå…¶ä»–çš„æ—¶é’Ÿé…ç½®æ–¹å¼å¤§åŒå°å¼‚ã€‚\n\n## ä»£ç \n```\n/*\n * @description\t: åˆå§‹åŒ–ç³»ç»Ÿæ—¶é’Ÿï¼Œè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿä¸º792Mhzï¼Œå¹¶ä¸”è®¾ç½®PLL2å’ŒPLL3å„ä¸ª\n \t\t\t\t  PFDæ—¶é’Ÿ,æ‰€æœ‰çš„æ—¶é’Ÿé¢‘ç‡å‡æŒ‰ç…§I.MX6Uå®˜æ–¹æ‰‹å†Œæ¨èçš„å€¼.\n * @param \t\t: æ— \n * @return \t\t: æ— \n */\nvoid imx6u_clkinit(void)\n{\n\tunsigned int reg = 0;\n\t/* 1ã€è®¾ç½®ARMå†…æ ¸æ—¶é’Ÿä¸º792MHz */\n\t/* 1.1ã€åˆ¤æ–­å½“å‰ARMå†…æ ¸æ˜¯ä½¿ç”¨çš„é‚£ä¸ªæ—¶é’Ÿæºå¯åŠ¨çš„ï¼Œæ­£å¸¸æƒ…å†µä¸‹ARMå†…æ ¸æ˜¯ç”±pll1_sw_clké©±åŠ¨çš„ï¼Œè€Œ\n\t *      pll1_sw_clkæœ‰ä¸¤ä¸ªæ¥æºï¼špll1_main_clkå’Œtep_clkã€‚\n\t *      å¦‚æœæˆ‘ä»¬è¦è®©ARMå†…æ ¸è·‘åˆ°792Mçš„è¯é‚£å¿…é¡»é€‰æ‹©pll1_main_clkä½œä¸ºpll1çš„æ—¶é’Ÿæºã€‚\n\t *      å¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹pll1_main_clkæ—¶é’Ÿçš„è¯å°±å¿…é¡»å…ˆå°†pll1_sw_clkä»pll1_main_clkåˆ‡æ¢åˆ°step_clk,\n\t *\t\tå½“ä¿®æ”¹å®Œpll1_main_clkä»¥ååœ¨å°†pll1_sw_clkåˆ‡æ¢å›pll1_main_clkã€‚è€Œstep_clkçš„æ—¶é’Ÿæºå¯ä»¥é€‰æ‹©\n\t * \t\tæ¿å­ä¸Šçš„24MHzæ™¶æŒ¯ã€‚\n\t */\n\t\n\tif((((CCM->CCSR) >> 2) & 0x1 ) == 0) \t/* å½“å‰pll1_sw_clkä½¿ç”¨çš„pll1_main_clk*/\n\t{\t\n\t\tCCM->CCSR &= ~(1 << 8);\t\t\t\t/* é…ç½®step_clkæ—¶é’Ÿæºä¸º24MH OSC */\t\n\t\tCCM->CCSR |= (1 << 2);\t\t\t\t/* é…ç½®pll1_sw_clkæ—¶é’Ÿæºä¸ºstep_clk */\n\t}\n\n\t/* 1.2ã€è®¾ç½®pll1_main_clkä¸º792MHz\n\t *      å› ä¸ºpll1_sw_clkè¿›ARMå†…æ ¸çš„æ—¶å€™ä¼šè¢«äºŒåˆ†é¢‘ï¼\n\t *      é…ç½®CCM_ANLOG->PLL_ARMå¯„å­˜å™¨\n\t *      bit13: 1 ä½¿èƒ½æ—¶é’Ÿè¾“å‡º\n\t *      bit[6:0]: 66, ç”±å…¬å¼ï¼šFout = Fin * div_select / 2.0ï¼Œ792=24*div_select/2.0,\n\t *              \t\tå¾—å‡ºï¼šdiv_select=    66 \n\t */\n\tCCM_ANALOG->PLL_ARM = (1 << 13) | ((66 << 0) & 0X7F); \t/* é…ç½®pll1_main_clk=792MHz */\n\tCCM->CCSR &= ~(1 << 2);\t\t\t\t\t\t\t\t\t/* å°†pll_sw_clkæ—¶é’Ÿé‡æ–°åˆ‡æ¢å›pll1_main_clk */\n\tCCM->CACRR = 0;\t\t\t\t\t\t\t\t\t\t\t/* ARMå†…æ ¸æ—¶é’Ÿä¸ºpll1_sw_clk/1=792/1=792Mhz */\n\n\t/* 2ã€è®¾ç½®PLL2(SYS PLL)å„ä¸ªPFD */\n\treg = CCM_ANALOG->PFD_528;\n\treg &= ~(0X3F3F3F3F);\t\t/* æ¸…é™¤åŸæ¥çš„è®¾ç½® \t\t\t\t\t\t*/\n\treg |= 32<<24;\t\t\t\t/* PLL2_PFD3=528*18/32=297Mhz \t*/\n\treg |= 24<<16;\t\t\t\t/* PLL2_PFD2=528*18/24=396Mhz(DDRä½¿ç”¨çš„æ—¶é’Ÿï¼Œæœ€å¤§400Mhz) */\n\treg |= 16<<8;\t\t\t\t/* PLL2_PFD1=528*18/16=594Mhz \t*/\n\treg |= 27<<0;\t\t\t\t/* PLL2_PFD0=528*18/27=352Mhz  \t*/\n\tCCM_ANALOG->PFD_528=reg;\t/* è®¾ç½®PLL2_PFD0~3 \t\t \t\t*/\n\n\t/* 3ã€è®¾ç½®PLL3(USB1)å„ä¸ªPFD */\n\treg = 0;\t\t\t\t\t/* æ¸…é›¶   */\n\treg = CCM_ANALOG->PFD_480;\n\treg &= ~(0X3F3F3F3F);\t\t/* æ¸…é™¤åŸæ¥çš„è®¾ç½® \t\t\t\t\t\t\t*/\n\treg |= 19<<24;\t\t\t\t/* PLL3_PFD3=480*18/19=454.74Mhz \t*/\n\treg |= 17<<16;\t\t\t\t/* PLL3_PFD2=480*18/17=508.24Mhz \t*/\n\treg |= 16<<8;\t\t\t\t/* PLL3_PFD1=480*18/16=540Mhz\t\t*/\n\treg |= 12<<0;\t\t\t\t/* PLL3_PFD0=480*18/12=720Mhz\t \t*/\n\tCCM_ANALOG->PFD_480=reg;\t/* è®¾ç½®PLL3_PFD0~3 \t\t\t\t\t*/\t\n\n\t/* 4ã€è®¾ç½®AHBæ—¶é’Ÿ æœ€å°6Mhzï¼Œ æœ€å¤§132Mhz (boot romè‡ªåŠ¨è®¾ç½®å¥½äº†å¯ä»¥ä¸ç”¨è®¾ç½®)*/\n\tCCM->CBCMR &= ~(3 << 18); \t/* æ¸…é™¤è®¾ç½®*/ \n\tCCM->CBCMR |= (1 << 18);\t/* pre_periph_clk=PLL2_PFD2=396MHz */\n\tCCM->CBCDR &= ~(1 << 25);\t/* periph_clk=pre_periph_clk=396MHz */\n\twhile(CCM->CDHIPR & (1 << 5));/* ç­‰å¾…æ¡æ‰‹å®Œæˆ */\n\t\t\n\t/* ä¿®æ”¹AHB_PODFä½çš„æ—¶å€™éœ€è¦å…ˆç¦æ­¢AHB_CLK_ROOTçš„è¾“å‡ºï¼Œä½†æ˜¯\n\t * æˆ‘æ²¡æœ‰æ‰¾åˆ°å…³é—­AHB_CLK_ROOTè¾“å‡ºçš„çš„å¯„å­˜å™¨ï¼Œæ‰€ä»¥å°±æ²¡æ³•è®¾ç½®ã€‚\n\t * ä¸‹é¢è®¾ç½®AHB_PODFçš„ä»£ç ä»…ä¾›å­¦ä¹ å‚è€ƒä¸èƒ½ç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼ï¼\n\t * å†…éƒ¨boot romå°†AHB_PODFè®¾ç½®ä¸ºäº†3åˆ†é¢‘ï¼Œå³ä½¿æˆ‘ä»¬ä¸è®¾ç½®AHB_PODFï¼Œ\n\t * AHB_ROOT_CLKä¹Ÿä¾æ—§ç­‰äº396/3=132Mhzã€‚\n\t */\n#if 0\n\t/* è¦å…ˆå…³é—­AHB_ROOT_CLKè¾“å‡ºï¼Œå¦åˆ™æ—¶é’Ÿè®¾ç½®ä¼šå‡ºé”™ */\n\tCCM->CBCDR &= ~(7 << 10);\t/* CBCDRçš„AHB_PODFæ¸…é›¶ */\n\tCCM->CBCDR |= 2 << 10;\t\t/* AHB_PODF 3åˆ†é¢‘ï¼ŒAHB_CLK_ROOT=132MHz */\n\twhile(CCM->CDHIPR & (1 << 1));/\n* ç­‰å¾…æ¡æ‰‹å®Œæˆ */\n#endif\n\t\n\t/* 5ã€è®¾ç½®IPG_CLK_ROOTæœ€å°3Mhzï¼Œæœ€å¤§66Mhz (boot romè‡ªåŠ¨è®¾ç½®å¥½äº†å¯ä»¥ä¸ç”¨è®¾ç½®)*/\n\tCCM->CBCDR &= ~(3 << 8);\t/* CBCDRçš„IPG_PODFæ¸…é›¶ */\n\tCCM->CBCDR |= 1 << 8;\t\t/* IPG_PODF 2åˆ†é¢‘ï¼ŒIPG_CLK_ROOT=66MHz */\n\t\n\t/* 6ã€è®¾ç½®PERCLK_CLK_ROOTæ—¶é’Ÿ */\n\tCCM->CSCMR1 &= ~(1 << 6);\t/* PERCLK_CLK_ROOTæ—¶é’Ÿæºä¸ºIPG */\n\tCCM->CSCMR1 &= ~(7 << 0);\t/* PERCLK_PODFä½æ¸…é›¶ï¼Œå³1åˆ†é¢‘ */\n}\n```"},{"title":"Linuxä¸‹è§„èŒƒæ€§Makefileè§„åˆ™","url":"/2025/03/02/Linuxä¸‹è§„èŒƒæ€§Makefileè§„åˆ™/","content":"## æ–‡ä»¶ç›®å½•\n- bsp\n    - clk   (æ—¶é’Ÿé©±åŠ¨)\n        - bsp_clk.c\n        - bsp_clk.h\n    - delay (å»¶æ—¶é©±åŠ¨)\n        - bsp_delay.c\n        - bsp_delay.h\n    - led   (LEDé©±åŠ¨)\n        - bsp_led.c\n        - bsp_led.h\n- imx6ul\n    - cc.h  (å˜é‡ç±»å‹å£°æ˜)\n    - fsl_common.h  (NXPå®˜æ–¹SDKé€šç”¨å®å®šä¹‰æ–‡æ¡£)\n    - fsl_iomuxc.h  (NXPå®˜æ–¹SDKå¯„å­˜å™¨åœ°å€å®šä¹‰æ–‡æ¡£)\n    - imx6ul.h      (å¸¸ç”¨å¤´æ–‡ä»¶)\n    - MCIMX6Y2.h    (NXPå®˜æ–¹SDKå¯„å­˜å™¨ç»“æ„ä½“å’Œç›¸å…³ä½å®šä¹‰æ–‡æ¡£)\n- obj\n    .oæ–‡ä»¶ç›®æ ‡åœ°å€\n- project\n    - main.c    (ä¸»å‡½æ•°)\n    - start.S   (å¯åŠ¨æ–‡ä»¶)\n\n\n## Makefile\n```\nCROSS_COMPILE \t?= arm-linux-gnueabihf-\nTARGET\t\t  \t?= bsp\n\nCC \t\t\t\t:= $(CROSS_COMPILE)gcc\nLD\t\t\t\t:= $(CROSS_COMPILE)ld\nOBJCOPY \t\t:= $(CROSS_COMPILE)objcopy\nOBJDUMP \t\t:= $(CROSS_COMPILE)objdump\n\nINCDIRS \t\t:= imx6ul \\\n\t\t\t\t   bsp/clk \\\n\t\t\t\t   bsp/led \\\n\t\t\t\t   bsp/delay \n\t\t\t\t   \t\t\t   \nSRCDIRS\t\t\t:= project \\\n\t\t\t\t   bsp/clk \\\n\t\t\t\t   bsp/led \\\n\t\t\t\t   bsp/delay \n\t\t\t\t   \n\t\t\t\t   \nINCLUDE\t\t\t:= $(patsubst %, -I %, $(INCDIRS))\n\nSFILES\t\t\t:= $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.S))\nCFILES\t\t\t:= $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.c))\n\nSFILENDIR\t\t:= $(notdir  $(SFILES))\nCFILENDIR\t\t:= $(notdir  $(CFILES))\n\nSOBJS\t\t\t:= $(patsubst %, obj/%, $(SFILENDIR:.S=.o))\nCOBJS\t\t\t:= $(patsubst %, obj/%, $(CFILENDIR:.c=.o))\nOBJS\t\t\t:= $(SOBJS) $(COBJS)\n\nVPATH\t\t\t:= $(SRCDIRS)\n\n.PHONY: clean\n\t\n$(TARGET).bin : $(OBJS)\n\t$(LD) -Timx6ul.lds -o $(TARGET).elf $^\n\t$(OBJCOPY) -O binary -S $(TARGET).elf $@\n\t$(OBJDUMP) -D -m arm $(TARGET).elf > $(TARGET).dis\n\n$(SOBJS) : obj/%.o : %.S\n\t$(CC) -Wall -nostdlib -c -O2  $(INCLUDE) -o $@ $<\n\n$(COBJS) : obj/%.o : %.c\n\t$(CC) -Wall -nostdlib -c -O2  $(INCLUDE) -o $@ $<\n\t\nclean:\n\trm -rf $(TARGET).elf $(TARGET).dis $(TARGET).bin $(COBJS) $(SOBJS)\n\n```\n\n## ç»†èŠ‚\n### å·¥å…·é…ç½®\n```\nCROSS_COMPILE \t?= arm-linux-gnueabihf-     # äº¤å‰ç¼–è¯‘å·¥å…·å‰ç¼€ï¼ˆARMæ¶æ„ï¼‰\nTARGET\t\t  \t?= bsp                      # ç›®æ ‡ç¨‹åºåç§°ï¼Œé»˜è®¤è¾“å‡ºæ–‡ä»¶åä¸º `bsp`\n\nCC \t\t\t\t:= $(CROSS_COMPILE)gcc      # C ç¼–è¯‘å™¨\nLD\t\t\t\t:= $(CROSS_COMPILE)ld       # é“¾æ¥å™¨\nOBJCOPY \t\t:= $(CROSS_COMPILE)objcopy  # äºŒè¿›åˆ¶è½¬æ¢å·¥å…·\nOBJDUMP \t\t:= $(CROSS_COMPILE)objdump  # åæ±‡ç¼–å·¥å…·\n```\n\n### ç›®å½•ä¸æ–‡ä»¶ç®¡ç†\n```\nINCDIRS := imx6ul \\            # å¤´æ–‡ä»¶æœç´¢ç›®å½•åˆ—è¡¨ï¼Œ\"\\\"ä¸ºæ¢è¡Œç¬¦\n           bsp/clk \\\n           bsp/led \\\n           bsp/delay\n\nSRCDIRS := project \\           # æºç æœç´¢ç›®å½•åˆ—è¡¨ï¼Œ\"\\\"ä¸ºæ¢è¡Œç¬¦\n           bsp/clk \\\n           bsp/led \\\n           bsp/delay\n\nINCLUDE := $(patsubst %, -I %, $(INCDIRS))  # å°† INCDIRS è½¬æ¢ä¸º gcc çš„ `-I` é€‰é¡¹\n```\n`patsubst`:\n- å‡½æ•°ç”¨æ³•ï¼š`$(patsubst <pattern>,<replacement>,<text>`\n\n- åç§°ï¼šæ¨¡å¼å­—ç¬¦ä¸²æ›¿æ¢å‡½æ•°â€”â€”patsubstã€‚\n\n- åŠŸèƒ½ï¼šæŸ¥æ‰¾`<text>`ä¸­çš„å•è¯ï¼ˆå•è¯ä»¥â€œç©ºæ ¼â€ã€â€œTabâ€æˆ–â€œå›è½¦â€â€œæ¢è¡Œâ€åˆ†éš”ï¼‰æ˜¯å¦ç¬¦åˆæ¨¡å¼`<pattern>`ï¼Œå¦‚æœåŒ¹é…çš„è¯ï¼Œåˆ™ä»¥`<replacement>`æ›¿æ¢ã€‚è¿™é‡Œï¼Œ`<pattern>`å¯ä»¥åŒ…æ‹¬é€šé…ç¬¦â€œ%â€ï¼Œè¡¨ç¤ºä»»æ„é•¿åº¦çš„å­—ä¸²ã€‚å¦‚æœ`<replacement>`ä¸­ä¹ŸåŒ…å«â€œ%â€ï¼Œé‚£ä¹ˆ`<replacement>`ä¸­çš„è¿™ä¸ªâ€œ%â€å°†æ˜¯`<pattern>`ä¸­çš„é‚£ä¸ªâ€œ%â€æ‰€ä»£è¡¨çš„å­—ä¸²ã€‚ï¼ˆå¯ä»¥ç”¨â€œ\\â€æ¥è½¬ä¹‰ï¼Œä»¥â€œ\\%â€æ¥è¡¨ç¤ºçœŸå®å«ä¹‰çš„â€œ%â€å­—ç¬¦ï¼‰\n\n- è¿”å›ï¼šå‡½æ•°è¿”å›è¢«æ›¿æ¢è¿‡åçš„å­—ç¬¦ä¸²ã€‚\n\n- ç¤ºä¾‹ï¼š`$(patsubst %.c,%.o, a.c b.c)`ï¼ŒæŠŠå­—ä¸²â€œa.c b.câ€ç¬¦åˆæ¨¡å¼[%.c]çš„å•è¯æ›¿æ¢æˆ[%.o]ï¼Œè¿”å›ç»“æœæ˜¯â€œa.o b.oâ€\n\n### æºç æ–‡ä»¶æ”¶é›†\n```\nSFILES := $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.S))  # æ‰€æœ‰ .S æ±‡ç¼–æ–‡ä»¶\nCFILES := $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.c))  # æ‰€æœ‰ .c C æ–‡ä»¶\n\nSFILENDIR := $(notdir $(SFILES))  # å»é™¤è·¯å¾„ï¼Œä¿ç•™æ–‡ä»¶åï¼ˆå¦‚ `start.S`ï¼‰\nCFILENDIR := $(notdir $(CFILES))  # å»é™¤è·¯å¾„ï¼Œä¿ç•™æ–‡ä»¶åï¼ˆå¦‚ `main.c`ï¼‰\n\nSOBJS := $(patsubst %, obj/%, $(SFILENDIR:.S=.o))  # æ±‡ç¼–æ–‡ä»¶å¯¹åº”çš„ .o æ–‡ä»¶ï¼ˆæ”¾åœ¨ obj ç›®å½•ï¼‰\nCOBJS := $(patsubst %, obj/%, $(CFILENDIR:.c=.o))  # C æ–‡ä»¶å¯¹åº”çš„ .o æ–‡ä»¶ï¼ˆæ”¾åœ¨ obj ç›®å½•ï¼‰\nOBJS  := $(SOBJS) $(COBJS)                        # æ‰€æœ‰ç›®æ ‡æ–‡ä»¶\n\nVPATH := $(SRCDIRS)  # æŒ‡å®šæºç æœç´¢è·¯å¾„ï¼ŒMake ä¼šåœ¨è¿™äº›ç›®å½•ä¸­æŸ¥æ‰¾ä¾èµ–æ–‡ä»¶\n```\n\n`foreach`ï¼š\n\n- ç”¨æ³•ï¼š`$(foreach <var>, <list>, <expr>)`\n\n- åŠŸèƒ½ï¼šéå† `<list>` ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå°†å…ƒç´ èµ‹å€¼ç»™ `<var>`ï¼Œç„¶åå±•å¼€ `<expr>`ï¼Œæœ€ç»ˆå°†æ‰€æœ‰å±•å¼€ç»“æœåˆå¹¶æˆä¸€ä¸ªç©ºæ ¼åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚\n\n- ç¤ºä¾‹ä¸­çš„ç”¨æ³•ï¼šéå† `SRCDIRS` ä¸­çš„æ¯ä¸ªç›®å½•ï¼Œæ”¶é›†æ‰€æœ‰ `.S` å’Œ `.c` æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚\n    1. `dir` ä¾æ¬¡å– `SRCDIRS` ä¸­çš„å€¼ï¼ˆå¦‚ `project`, `bsp/clk` ç­‰ï¼‰\n    2. `$(wildcard $(dir)/*.S)` å±•å¼€ä¸º `dir` ç›®å½•ä¸‹æ‰€æœ‰ `.S` æ–‡ä»¶çš„è·¯å¾„ï¼ˆå¦‚ `project/start.S, bsp/clk/clk.S`ï¼‰ã€‚\n    3. æœ€ç»ˆ `SFILES` æ˜¯æ‰€æœ‰ `.S` æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ï¼Œ`CFILES` æ˜¯æ‰€æœ‰ `.c` æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ã€‚\n\n`wildcard`ï¼š\n- ç”¨æ³•ï¼š`$(wildcard <pattern>)`\n- åŠŸèƒ½ï¼šåŒ¹é…ç¬¦åˆ `<pattern>` çš„æ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒé€šé…ç¬¦ * å’Œ ?ã€‚\n- ç¤ºä¾‹ä¸­çš„ç”¨æ³•:åœ¨ `foreach` å¾ªç¯ä¸­ï¼Œä¸ºæ¯ä¸ª `dir` ç›®å½•ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ã€‚\n\n### ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶\n```\n$(TARGET).bin : $(OBJS)                       # ä¾èµ–æ‰€æœ‰ .o æ–‡ä»¶\n\t$(LD) -Timx6ul.lds -o $(TARGET).elf $^    # 1. é“¾æ¥ç”Ÿæˆ ELF æ–‡ä»¶\n\t$(OBJCOPY) -O binary -S $(TARGET).elf $@  # 2. æå–äºŒè¿›åˆ¶æ–‡ä»¶\n\t$(OBJDUMP) -D -m arm $(TARGET).elf > $(TARGET).dis  # 3. ç”Ÿæˆåæ±‡ç¼–æ–‡ä»¶\n```\n\n### ç¼–è¯‘è§„åˆ™\n```\n$(SOBJS) : obj/%.o : %.S      # ç¼–è¯‘ .S æ±‡ç¼–æ–‡ä»¶ï¼ˆéœ€é¢„å¤„ç†çš„æ±‡ç¼–ï¼‰\n\t$(CC) -Wall -nostdlib -c -O2 $(INCLUDE) -o $@ $<\n```\n- `-nostdlib`ï¼šä¸é“¾æ¥æ ‡å‡†åº“ï¼Œé€‚ç”¨äºè£¸æœºç¨‹åº\n- `-O2`ï¼šä¼˜åŒ–ç­‰çº§ä¸º2\n- `$(INCLUDE)`ï¼šåŒ…å«å¤´æ–‡ä»¶ç›®å½•çš„`-I`é€‰é¡¹\n\n```\n$(COBJS) : obj/%.o : %.c      # ç¼–è¯‘ .c C æ–‡ä»¶\n\t$(CC) -Wall -nostdlib -c -O2 $(INCLUDE) -o $@ $<\n```\n\n### æ¸…ç†è§„åˆ™\n```\nclean:\n\trm -rf $(TARGET).elf $(TARGET).dis $(TARGET).bin $(COBJS) $(SOBJS)\n```\n\n## å®Œæ•´æµç¨‹ï¼š\n1. æ”¶é›†æºç è·¯å¾„ï¼š\n    - `SFILES = project/start.S bsp/clk/clk.S`\n    - `CFILES = project/main.c bsp/clk/clk.c`\n2. æå–æ–‡ä»¶åï¼š\n    - `SFILENDIR = start.S clk.S`\n    - `CFILENDIR = main.c clk.c`\n3. ç”Ÿæˆç›®æ ‡æ–‡ä»¶åˆ—è¡¨\n    - `SOBJS = obj/start.o obj/clk.o`\n    - `COBJS = obj/main.o obj/clk.o`\n    - `OBJS = obj/start.o obj/clk.o obj/main.o obj/clk.o`\n4. ç¼–è¯‘æ—¶\n    - Make æ ¹æ® `VPATH` åœ¨ `project` å’Œ `bsp/clk` ç›®å½•ä¸­æŸ¥æ‰¾ `start.S` å’Œ `clk.c` ç­‰æ–‡ä»¶ã€‚","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"LVGLå‘ç”Ÿå„ç§å¡æ­»ç°è±¡çš„åŸå› åˆ†æå’Œæ’æ•…","url":"/2025/02/20/LVGLå‘ç”Ÿå„ç§å¡æ­»ç°è±¡çš„åŸå› åˆ†æå’Œæ’æ•…/","content":"## å‰è¨€\nLVGLæ˜¯ä¸€ä¸ªåœ¨ä½¿ç”¨æ—¶éå¸¸å®¹æ˜“äº§ç”Ÿå¡æ­»æ•…éšœçš„GUIåº“ï¼Œå¤§å¤šæ•°å¡æ­»éƒ½å‘ç”Ÿåœ¨åŠ¨æ€é˜¶æ®µï¼ŒåŒ…æ‹¬ä¸”ä¸ä»…é™äºï¼š\n- å¯åŠ¨å¹¶åˆå§‹åŒ–ç¬¬ä¸€ä¸ªé¡µé¢æ—¶\n- åœ¨å¤šä¸ªé¡µé¢é—´æ¥å›åˆ‡æ¢\n- è§¦å‘ç»„ä»¶å›è°ƒæ—¶ï¼ˆä¾‹å¦‚buttonæˆ–timerï¼‰\n- é•¿æ—¶é—´è¿è¡Œå\n\næœ¬æ–‡æ‰€æä¾›çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æˆ‘è‡ªå·±æ‘¸ç´¢å‡ºæ¥çš„ï¼Œä¸ä¸€å®šé€‚ç”¨äºæ‰€æœ‰äººï¼Œä¹Ÿä¸ä¸€å®šæ˜¯æœ€æ ‡å‡†çš„åŠæ³•ã€‚ç½‘ä¸Šå…³äºLVGLçš„æ•™ç¨‹å¾ˆå¤šï¼ŒåŒ…æ‹¬å®˜æ–¹æ–‡æ¡£ï¼Œä½†æ˜¯å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯ä¸æ€ä¹ˆè§„èŒƒçš„ã€‚å®˜æ–¹çš„Github issueä¸­ä¹Ÿæœ‰å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œå“ªæ€•æ˜¯LVGLçš„ä½œè€…ä¹Ÿæ— æ³•è§£å†³æˆ–å®šä½é”™è¯¯ã€‚ä½†æ˜¯LVGLå·²ç»è¿­ä»£åˆ°äº†V9ç‰ˆæœ¬ï¼Œå¤§å¤šæ•°å› ä¸ºè‡ªå¸¦åº“é—®é¢˜å¯¼è‡´çš„é”™è¯¯å·²ç»å¾—åˆ°ä¿®å¤ï¼Œç”±LVGLæœ¬èº«å¸¦æ¥çš„è‡´å‘½é”™è¯¯å·²ç»å¾ˆå°‘ï¼Œå¤§å¤šæ•°é”™è¯¯éƒ½æ¥æºäºç”¨æˆ·è‡ªèº«çš„ä¸è§„èŒƒä»£ç æˆ–è€…æ˜¯ç”¨æ³•ã€‚\n\nå¦‚æœä½ çš„LVGLä¾‹ç¨‹å‘ç”Ÿäº†å¡æ­»ï¼Œé¦–å…ˆåº”å½“æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å°è¯•è§£å†³ï¼š\n1. æ›´æ–°LVGLç‰ˆæœ¬è‡³æœ€æ–°ã€‚åŒæ—¶ï¼Œç¡®ä¿ä½ ä½¿ç”¨çš„å‡½æ•°åœ¨æœ€æ–°çš„LVGLä¸­ä»ç„¶å¯ç”¨ã€‚LVGLåº“å‡½æ•°è¿­ä»£çš„å¾ˆå¿«ï¼Œä¸”è‡ªä»v8.3ä¹‹åå‡ ä¹æ¯ä¸ªå°ç‰ˆæœ¬éƒ½æœ‰å¤§æ”¹ï¼Œv9ä¹‹åæ›´æ˜¯åˆ äº†ä¸€å¤§æ‰¹æˆ‘è®¤ä¸ºå¾ˆå¥½ç”¨çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚`lv_label_recolor()`ï¼‰ã€‚å¦‚æœä½ æŠ„äº†ä¸€ä¸ªæ—§ç‰ˆæœ¬çš„å‡½æ•°å¹¶åœ¨æ–°ç‰ˆæœ¬çš„lvglç¯å¢ƒä¸‹ä½¿ç”¨å®ƒï¼Œå¯èƒ½å¯¼è‡´é—®é¢˜\n2. å°è¯•åœ¨æ¨¡æ‹Ÿå™¨ä¸­å¤ç°ä»£ç ï¼Œç¡®è®¤æ˜¯å¦æ˜¯LVGLåº“è‡ªèº«çš„é—®é¢˜\n3. å¦‚æœLVGLå·¥ä½œåœ¨OSä¸‹ï¼Œå°è¯•åœ¨è£¸æœºä¸­å¤ç°é—®é¢˜ï¼›å¦‚æœè£¸æœºå’ŒOSä¸‹éƒ½å‘ç”Ÿé—®é¢˜ï¼Œè¯´æ˜éƒ¨åˆ†ä»£ç å¯èƒ½å­˜åœ¨é—®é¢˜ï¼›å¦‚æœè£¸æœºä¸‹å·¥ä½œæ­£å¸¸ï¼Œå¤§æ¦‚ç‡æ˜¯çº¿ç¨‹é—®é¢˜å¯¼è‡´çš„LVGLé”™è¯¯ã€‚\n\nå¦‚æœå°è¯•è¿‡ä¸Šè¿°æ–¹æ³•ä¹‹åé—®é¢˜è¿˜æ²¡æœ‰è§£å†³ï¼Œåº”è€ƒè™‘æ˜¯ç”¨æˆ·ä»£ç é€ æˆçš„é—®é¢˜ã€‚\n\n## æ’æ•…\nåœ¨å¼€å§‹å‰ï¼Œç¡®ä¿åœ¨`lv_conf.h`ä¸­å¯ç”¨å†…å­˜ç›‘è§†å’ŒCPUå ç”¨ç›‘è§†ï¼Œå…·ä½“ä¸ºï¼š\n```\n/*1: Enable system monitor component*/\n/*1: Enable system monitor component*/\n#define LV_USE_SYSMON   1\n#if LV_USE_SYSMON\n    /*Get the idle percentage. E.g. uint32_t my_get_idle(void);*/\n    #define LV_SYSMON_GET_IDLE lv_timer_get_idle\n\n    /*1: Show CPU usage and FPS count\n     * Requires `LV_USE_SYSMON = 1`*/\n    #define LV_USE_PERF_MONITOR 1       /* å¯ç”¨CPUæ€§èƒ½ç›‘è§† */\n    #if LV_USE_PERF_MONITOR\n        #define LV_USE_PERF_MONITOR_POS LV_ALIGN_BOTTOM_RIGHT\n\n        /*0: Displays performance data on the screen, 1: Prints performance data using log.*/\n        #define LV_USE_PERF_MONITOR_LOG_MODE 0\n    #endif\n\n    /*1: Show the used memory and the memory fragmentation\n     * Requires `LV_USE_STDLIB_MALLOC = LV_STDLIB_BUILTIN`\n     * Requires `LV_USE_SYSMON = 1`*/\n    #define LV_USE_MEM_MONITOR 1        /* å¯ç”¨å†…å­˜ç›‘è§† */\n    #if LV_USE_MEM_MONITOR\n        #define LV_USE_MEM_MONITOR_POS LV_ALIGN_BOTTOM_LEFT\n    #endif\n\n#endif /*LV_USE_SYSMON*/\n```\n### å¯åŠ¨æ—¶å¡æ­»ã€ç™½å±ã€èŠ±å±\néå¸¸å¸¸è§çš„æƒ…å†µã€‚é¦–å…ˆåœ¨åˆå§‹åŒ–åç§»é™¤æ‰€æœ‰çš„å¯¹è±¡åˆ›å»ºå‡½æ•°ï¼Œä»…ä¿ç•™ä¸€ä¸ªæœ€åŸºæœ¬çš„åˆ›å»ºç©ºç™½å±å¹•çš„å‡½æ•°ï¼Œè¿™ä¹ˆåšæ˜¯ä¸ºäº†æ’é™¤å…¶ä»–å¯¹è±¡å¼•èµ·çš„å¹²æ‰°å› ç´ ã€‚\n\nç„¶åï¼ŒæŒ‰ç…§ä¸‹åˆ—é¡ºåºæ£€æŸ¥ï¼š\n1. ç¡¬ä»¶é—®é¢˜ã€‚\n- ç¡®ä¿å±å¹•å’ŒMCUç¡¬ä»¶è¿æ¥æ­£ç¡®ã€‚æœ€å¥½çš„æ–¹å¼æ˜¯å…ˆä¸è·‘LVGLï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªæœ€åŸºæœ¬çš„å¡«è‰²å‡½æ•°æ¥æµ‹è¯•å±å¹•æ˜¯å¦å·¥ä½œæ­£å¸¸ã€‚\n- ç¡®ä¿ä¾›ç”µæ»¡è¶³è¦æ±‚\n- ç¡®ä¿æ—¶é’Ÿæºæ­£ç¡®é…ç½®\n\n2. æ£€æŸ¥MCUå¯åŠ¨æ–‡ä»¶ä¸­æ ˆå’Œå †å¤§å°æ˜¯å¦è®¾ç½®æ­£ç¡®ã€‚ LVGLæ­£å¸¸è¿è¡Œè‡³å°‘éœ€è¦ä»¥ä¸‹æ¡ä»¶ï¼š\n~~~\nFlash/ROM: > 64 kB for the very essential components (> 180 kB is recommended)\n\nRAM:\nStatic RAM usage: ~2 kB depending on the used features and object types\n\nstack: > 2kB (> 8 kB is recommended)\n\nDynamic data (heap): > 2 KB (> 48 kB is recommended if using several objects).\nSet by LV_MEM_SIZE in lv_conf.h.\n\nDisplay buffer: > \"Horizontal resolution\" pixels (> 10 \"Horizontal resolution\" is recommended)\n\nOne frame buffer in the MCU or in an external display controller\n~~~\n3. æ£€æŸ¥`lv_conf.h`ä¸­å†…å­˜ç¼“å­˜åœ°å€åŠå¤§å°æ˜¯å¦è®¾ç½®æ­£ç¡®ï¼š\n```\n#if LV_USE_STDLIB_MALLOC == LV_STDLIB_BUILTIN\n    /*Size of the memory available for `lv_malloc()` in bytes (>= 2kB)*/\n    #define LV_MEM_SIZE (300U * 1024U)          /*[bytes]*/\n\n    /*Size of the memory expand for `lv_malloc()` in bytes*/\n    #define LV_MEM_POOL_EXPAND_SIZE 0\n\n    /*Set an address for the memory pool instead of allocating it as a normal array. Can be in external SRAM too.*/\n    #define LV_MEM_ADR (0XC0000000+1024*600*2)     /*0: unused*/\n    /*Instead of an address give a memory allocator that will be called to get a memory pool for LVGL. E.g. my_malloc*/\n    #if LV_MEM_ADR == 0\n        #undef LV_MEM_POOL_INCLUDE\n        #undef LV_MEM_POOL_ALLOC\n    #endif\n#endif  /*LV_USE_STDLIB_MALLOC == LV_STDLIB_BUILTIN*/\n```\næˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯å¤–éƒ¨SDRAMä½œä¸ºlvglçš„æ˜¾å­˜åœ°å€ï¼Œå¤§å°ä¸º300KBã€‚å¦‚æœå¯åŠ¨æ—¶ç™½å±ï¼Œä¼˜å…ˆè€ƒè™‘å¢åŠ `LV_MEM_SIZE`çš„å¤§å°ï¼Œè‡³å°‘ä¸º64KBã€‚å¦‚æœå¢åŠ è‡³64KBè¿˜æœªèƒ½è§£å†³å¡æ­»çš„é—®é¢˜ï¼Œå¦‚æœåŸæœ¬ç°å­˜ä½ç½®æ˜¯MCUå†…éƒ¨SRAMï¼Œè€ƒè™‘å°†æ˜¾å­˜ç§»è‡³å¤–éƒ¨SDRAMï¼›å¦‚æœåŸæœ¬æ˜¯å¤–éƒ¨SDRAMï¼Œè€ƒè™‘ç§»åŠ¨è‡³å†…éƒ¨SRAMã€‚\n\n4. æ£€æŸ¥`lv_port_disp.c`å’Œ`lv_port_indev.c`\n\nç¡®è®¤ä»¥ä¸‹é¡¹è®¾ç½®æ­£ç¡®ï¼š\n- å±å¹•åˆ†è¾¨ç‡ï¼š\n```\n#ifndef MY_DISP_HOR_RES\n    #warning Please define or replace the macro MY_DISP_HOR_RES with the actual screen width, default value 320 is used for now.\n    #define MY_DISP_HOR_RES    1024\n#endif\n\n#ifndef MY_DISP_VER_RES\n    #warning Please define or replace the macro MY_DISP_VER_RES with the actual screen height, default value 240 is used for now.\n    #define MY_DISP_VER_RES    600\n#endif\n```\nå±å¹•åˆ†è¾¨ç‡å¦‚æœæ¯”å®é™…å±å¹•å¤§ï¼Œä¼šå¯¼è‡´èŠ±å±ï¼›å¦‚æœæ¯”å®é™…å°ï¼Œå¯èƒ½å¯¼è‡´æ˜¾ç¤ºé”™ä½ã€‚\n\n- `disp_flush()`æ˜¯å¦åœ¨åˆå§‹åŒ–åè¢«æ­£ç¡®è°ƒç”¨\n\n- é¢œè‰²æ·±åº¦æ˜¯å¦é€‰æ‹©æ­£ç¡®ï¼Œlvglé»˜è®¤ä¸ºRGB565\n\n- æ˜¯å¦é€‰æ‹©äº†æ­£ç¡®çš„è¾“å…¥è®¾å¤‡ï¼Œæ²¡æœ‰ç”¨åˆ°çš„è¾“å…¥è®¾å¤‡æ‰€å¯¹åº”çš„åˆå§‹åŒ–ä»£ç è¦æ³¨é‡Šæ‰ã€‚\n\nå¦‚æœLVGLåˆå§‹åŒ–æ­£ç¡®å¹¶è¿›å…¥äº†ç©ºç™½å±å¹•ï¼Œé‚£ä¹ˆè‡³å°‘å±å¹•å·¦ä¸‹è§’å’Œå³ä¸‹è§’ä¼šåˆ†åˆ«æ˜¾ç¤ºå†…å­˜ç›‘è§†å’ŒCPUç›‘è§†çš„å°çª—å£ï¼Œä¸”CPUç›‘è§†çª—å£çš„æ•°å­—åº”å½“æ˜¯åœ¨åŠ¨æ€å˜åŒ–çš„ã€‚\n\n### åˆ‡æ¢é¡µé¢æ—¶å¡æ­»æˆ–èŠ±å±\né€šå¸¸è®¤ä¸ºï¼Œæœ‰ä¸¤ç§åˆ‡æ¢å±å¹•çš„æ–¹å¼ï¼š\n- é€šè¿‡`lv_obj_clean`æˆ–`lv_obj_del`åˆ é™¤æ—§é¡µé¢ï¼Œç„¶å`lv_scr_load`åˆ›å»ºæ–°é¡µé¢ã€‚æ¯”å¦‚ï¼š\n```\n        lv_obj_t *act_scr = lv_scr_act();\n        lv_obj_del(act_scr);\n        create_main_scr();        \n        lv_scr_load(main_scr);\n```\n- é€šè¿‡å‘é¡µé¢æ·»åŠ æˆ–ç§»é™¤`LV_OBJ_FLAG_HIDDEN`æ¥æ§åˆ¶é¡µé¢çš„å¯è§†åŒ–ï¼Œè¿™ä¹ˆåšéœ€è¦äº‹å…ˆä¸€æ¬¡æ€§åˆ›å»ºå®Œæ‰€æœ‰å¯èƒ½éœ€è¦æ˜¾ç¤ºçš„é¡µé¢å¹¶æ·»åŠ flagï¼Œæ¯”å¦‚ï¼š\n```\n        lv_obj_add_flag(main_screen, LV_OBJ_FLAG_HIDDEN); /* éšè—é¡µé¢ */\n        lv_obj_clear_flag(main_screen, LV_OBJ_FLAG_HIDDEN); /* æ˜¾ç¤ºé¡µé¢ */\n```\n\n*å»ºè®®*ï¼š**ä¸è¦**ä½¿ç”¨ç¬¬äºŒç§é€šè¿‡æ§åˆ¶`FLAG_HIDDEN`æ¥å®ç°åˆ‡æ¢é¡µé¢çš„æ–¹æ³•ï¼Œé™¤éä½ çœŸçš„ç¡®è®¤ç¬¬ä¸€ç§æ–¹æ³•æ²¡æ³•ä½¿ç”¨ã€‚å› ä¸ºï¼š\n- åˆå§‹åŒ–æ—¶ä¸€æ¬¡æ€§åˆ›å»ºå¤§é‡é¡µé¢åŠå…¶å­ç±»å¯¹è±¡ä¼šæå¤§çš„å¢åŠ CPUå’Œå†…å­˜è´Ÿæ‹…ã€‚åº”å°½å¯èƒ½é™ä½åŒæ—¶æ“ä½œå¤šä¸ªå¯¹è±¡çš„å¯èƒ½æ€§ã€‚\n- æµªè´¹å†…å­˜ï¼Œé€ æˆå†…å­˜æ³„æ¼ï¼Œé¡µé¢ç®¡ç†æ··ä¹±ã€‚\n- åœ¨LVGL v9åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨æ—¶ï¼Œå¤§æ¦‚ç‡å¯¼è‡´èŠ±å±ï¼ˆå¾ˆå¤šä¾‹å­ï¼‰ï¼Œæ¨æµ‹æ˜¯å¤šä¸ªå¯¹è±¡å åŠ å¸¦æ¥çš„å†…å­˜é—®é¢˜ã€‚\n\nå¦‚æœä¿®æ”¹ä¸ºç¬¬ä¸€ç§æ–¹æ³•åè¿˜å‡ºç°é”™è¯¯ï¼Œå‚ç…§ä»¥ä¸‹æ­¥éª¤ï¼š\n1. ç¡®ä¿LVGLç‰ˆæœ¬ä¸ºæœ€æ–°ã€‚LVGL v9ä¸­`lv_scr_load()`å‡½æ•°çš„æ‰§è¡Œæ­¥éª¤æ˜¯ï¼š\n    1. è·å–å½“å‰æ´»åŠ¨å±å¹•å’Œå…¶å…³è”çš„æ˜¾ç¤ºå™¨å¯¹è±¡\n    2. åˆ¤æ–­å½“å‰å±å¹•æ˜¯å¦ä¸ºå¾…åˆ‡æ¢çš„ç›®æ ‡å±å¹•ï¼Œå¦‚æœæ˜¯ï¼Œé€€å‡ºå‡½æ•°\n    3. åˆ¤æ–­æ˜¯å¦æœ‰åˆ‡æ¢åŠ¨ç”»æ­£åœ¨æ‰§è¡Œï¼Œå¦‚æœæœ‰ï¼Œç«‹å³åˆ‡æ¢è‡³ç›®æ ‡å±å¹•\n    4. åˆ‡æ¢åï¼Œåˆ é™¤æ—§å±å¹•ï¼Œæ›´æ–°`acr_scr`æŒ‡é’ˆè‡³ç›®æ ‡å±å¹•\n    \n    è¿™é‡Œçš„åˆ‡æ¢é€»è¾‘å·²ç»å†™çš„éå¸¸åˆç†äº†ï¼Œå¦‚æœè¿˜æ˜¯æœ‰é”™è¯¯ï¼š\n2. ç¡®ä¿ä½¿ç”¨`lv_obj_del()`è€Œä¸æ˜¯`lv_obj_clean()`æ¥åˆ é™¤æ—§å±å¹•ã€‚ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½æœ‰åŒºåˆ«ï¼Œ`lv_obj_del()`ä¼šç«‹å³åˆ é™¤å¯¹è±¡æœ¬èº«å’Œå…¶å­é¡¹ï¼Œè€Œ`lv_obj_clean()`ä»…åˆ é™¤ç›®æ ‡å¯¹è±¡çš„å­é¡¹ï¼Œè€Œä¸åˆ é™¤ç›®æ ‡å¯¹è±¡æœ¬èº«ï¼Œè¿™å¯èƒ½é€ æˆå†…å­˜æ³„æ¼ã€‚\n\n3. è°ƒæ¢`lv_obj_del()`å’Œ`lv_scr_load()`çš„ä½ç½®ï¼Œå³å…ˆåˆ›å»ºæ–°å±å¹•ï¼Œå†åˆ é™¤æ—§å±å¹•ã€‚ä¹‹å‰æœ‰Github issueæŠ¥å‘Šç§°åœ¨åˆ›å»ºæ–°å±å¹•å‰å°±åˆ é™¤æ—§å±å¹•å¯èƒ½å¯¼è‡´å†…å­˜æ± é—®é¢˜ï¼Œlvglä¼šè®¿é—®ç©ºæŒ‡é’ˆå¯¼è‡´hardfaultã€‚\n\n4. ç¡®ä¿æ—§å±å¹•ï¼ˆåŒ…æ‹¬å…¶å­é¡¹ï¼‰å’Œæ–°å±å¹•ï¼ˆåŒ…æ‹¬å…¶å­é¡¹ï¼‰ä¹‹é—´çš„å¯¹è±¡ä¾èµ–å…³ç³»æ­£ç¡®ã€‚å…·ä½“ä¸€ç‚¹æ¥è¯´ï¼š\n    - æ–°å±å¹•å¿…é¡»å·²ç»è¢«åˆ›å»ºï¼ˆçˆ¶å¯¹è±¡å¿…é¡»å®é™…å­˜åœ¨ä¸”ä¸ºé™æ€ï¼‰\n    - æ–°å±å¹•ä¸­çš„å­é¡¹ä¸èƒ½æŒ‡å‘ã€åŒ…å«æˆ–å¼•ç”¨ä¸å­˜åœ¨çš„å¯¹è±¡ã€‚è¿™ä¹ˆè¯´çš„æ„æ€æ˜¯ï¼Œå¦‚æœä½ æ˜¯åœ¨åˆ‡æ¢å±å¹•æ—¶æ‰åˆ›å»ºæ–°å±å¹•ä¸­çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡åœ¨åˆ‡æ¢å±å¹•å‰æ˜¯ä¸å­˜åœ¨çš„ã€‚å¦‚æœå­é¡¹è¯•å›¾è®¿é—®ä¸€ä¸ªå¹¶ä¸å®é™…å­˜åœ¨çš„å¯¹è±¡ï¼Œå³è®¿é—®ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œé‚£ä¹ˆLVGLå°±ä¼šå¡æ­»ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\n    ```\n    static void btn_to_main_page_cb(lv_event_t *e){\n    if (lv_event_get_code(e) == LV_EVENT_CLICKED){\n        lv_obj_t *act_scr = lv_scr_act();\n        create_main_scr();        \n        lv_scr_load(main_scr);  /* åˆ‡æ¢è‡³main_scr() *ã€`\n        lv_obj_del(act_scr);\n    }\n    }\n\n    static void create_main_scr(){\n        /* ..... */\n        lv_label_set_text_fmt(Example_label);\n    }\n    ```\n\n    è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘å³å°†åˆ‡æ¢åˆ°çš„ç›®æ ‡å±å¹•ä¸­åŒ…å«ä¸€ä¸ªå¯¹`Example_label`çš„æ“ä½œï¼Œè€Œ`Example_label`å¯èƒ½æ˜¯åœ¨å…¶ä»–å±å¹•åˆå§‹åŒ–å‡½æ•°ä¸­è¢«åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå¿…é¡»ç¡®ä¿åœ¨åˆ‡æ¢å‰`Example_label`å°±å·²ç»å­˜åœ¨ã€‚\n\n5. å¦‚æœå¯ç”¨äº†å®šæ—¶å™¨(lv_timer)ï¼Œæ£€æŸ¥å®šæ—¶å™¨åˆ›å»ºä½ç½®å’Œå›è°ƒæ‰§è¡Œä½ç½®ã€‚å‡è®¾`lv_timer_1`ç”¨äºå®æ—¶æ›´æ–°`test_scr`ä¸­çš„æŸä¸ªlabelç»„ä»¶ï¼Œé‚£ä¹ˆ`lv_timer_1`åº”å½“åªåœ¨è¿›å…¥`test_scr`åè¢«åˆ›å»ºï¼Œå¦‚æœå…¶ä»–å±å¹•æ²¡æœ‰ç”¨åˆ°`lv_timer_1`ï¼Œé‚£ä¹ˆ`lv_timer_1`åœ¨é€€å‡º`test_scr`å‰å°±åº”å½“è¢«é”€æ¯ï¼ˆå…ˆé”€æ¯å®šæ—¶å™¨ï¼Œå†åˆ é™¤æ—§å±å¹•ï¼‰ï¼Œå°¤å…¶æ˜¯å½“`lv_timer_1`çš„å›è°ƒå‡½æ•°ä¸­åŒ…æ‹¬å¯¹`test_scr`ä¸­å­å¯¹è±¡çš„å¼•ç”¨ã€æŒ‡å‘å’Œåˆ é™¤æ“ä½œæ—¶ï¼Œå› ä¸ºä¸€æ—¦é€€å‡º`test_scr`ï¼Œå›è°ƒå‡½æ•°æ‰€æŒ‡å‘çš„å¯¹è±¡å°±ä¸å†å­˜åœ¨ï¼ˆè¢«åˆ é™¤ï¼‰ï¼Œå³æŒ‡å‘ç©ºæŒ‡é’ˆï¼ŒLVGLä¼šç«‹å³å¡æ­»ã€‚\n\n    æ¨èä½¿ç”¨è¿™ç§æ–¹å¼æ¥ç®¡ç†å®šæ—¶å™¨çš„åˆ›å»ºï¼š\n    ```\n    static void lvgl_create_timers_1(void)\n    {\n    // å¦‚æœå­˜åœ¨æ—§çš„å®šæ—¶å™¨å¯¹è±¡\n    if (timer_1 != NULL) {\n        lv_timer_del(timer_1);  // åˆ é™¤æ—§çš„å®šæ—¶å™¨\n        timer_1 = NULL;         // æ¸…ç©ºæŒ‡é’ˆ\n    }\n\n    // åˆ›å»ºæ–°çš„å®šæ—¶å™¨\n    timer_1 = lv_timer_create(lvgl_timer_1_cb, 500, NULL);\n    }\n    ```\n\n6. å¦‚æœåˆ°è¿™é‡Œè¿˜æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œåº”ä½¿ç”¨IDEçš„debugåŠŸèƒ½è¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œå®šä½æ•…éšœæ¥æºã€‚ä¸‹é¢æ˜¯å‡ ä¸ªä¾‹å­ï¼š\n    - å‡½æ•°å¡æ­»åœ¨`lv_tlsf.c`ä¸­çš„æŸä¸ªå‡½æ•°ï¼šå†…å­˜ç®¡ç†å‡ºç°é—®é¢˜ï¼Œæå¤§å¯èƒ½æ˜¯è®¿é—®æˆ–é‡Šæ”¾äº†ä¸å­˜åœ¨çš„å†…å­˜ï¼ˆç©ºæŒ‡é’ˆï¼‰ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†äº†å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚\n    - å‡½æ•°å¡æ­»åœ¨`delay`å‡½æ•°ï¼šå‡½æ•°åœåœ¨è¿™é‡Œæ˜¯æ­£å¸¸ç°è±¡ï¼Œè¿™é‡Œçš„å¡æ­»æŒ‡çš„æ˜¯ä¸€ç›´åœ¨delayä¸­å¾ªç¯è€Œä¸è·³å‡ºï¼Œè€ƒè™‘æ—¶é’Ÿé—®é¢˜ï¼Œå¯èƒ½çš„æƒ…å†µä¸‹é™ä½å±å¹•æ—¶é’Ÿé¢‘ç‡ã€‚\n    - å‡½æ•°è·³è½¬è‡³`hardfault_handler()`ï¼šéLVGLè‡ªèº«åŸå› å¸¦æ¥çš„é—®é¢˜ï¼Œå¿…å®šæ˜¯ç”¨æˆ·çš„ä»£ç äº§ç”Ÿäº†é”™è¯¯ã€‚\n\n### è§¦å‘ç»„ä»¶å›è°ƒæ—¶å¡æ­»\n1. ä¸è¦åœ¨å›è°ƒä¸­ä½¿ç”¨`while`ã€`for`æˆ–é•¿æ—¶é—´çš„å»¶æ—¶\n2. ä¸è¦åœ¨å›è°ƒå‡½æ•°ä¸­è®¿é—®å·²ç»è¢«åˆ é™¤æˆ–æ— æ•ˆçš„å¯¹è±¡ï¼Œå‚åŠ ä¸Šä¸€å°èŠ‚ä¸­çš„ç¬¬5æ¡ã€‚è¿™ä¸€æ¡çœ‹ä¼¼ä¸èµ·çœ¼ï¼Œä½†å¾ˆå¤šäººéƒ½ä¸ä¼šæ„è¯†åˆ°è¿™ä¸ªé—®é¢˜\n3. LVGLä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¦‚æœåœ¨OSä¸­ä½¿ç”¨LVGLï¼Œè€ƒè™‘ä¸ºå›è°ƒå‡½æ•°æ·»åŠ æ ‡å¿—ä½æˆ–äº’æ–¥é”ï¼Œé¿å…ç«æ€æ¡ä»¶\n4. å°½å¯èƒ½åœ°ä¼˜åŒ–ä»£ç ï¼Œä¸è¦åµŒå¥—è¿‡å¤šçš„APIæˆ–ä¸€æ¬¡æ€§åˆ›å»ºå¤§é‡å¯¹è±¡ï¼Œgithub issueä¸­æœ‰å› ä¸ºè¿™ä¹ˆå¹²è€Œé€ æˆæ ˆæº¢å‡ºçš„ã€‚\n\n### é•¿æ—¶é—´è¿è¡Œåå¡æ­»\n99%æ˜¯å†…å­˜é—®é¢˜ã€‚ç¡®ä¿åˆ›å»ºæ–°å¯¹è±¡ååˆ é™¤æ—§å¯¹è±¡å¹¶é‡Šæ”¾å†…å­˜ã€‚\n\n## åè¯\næœ€åï¼Œä¸€äº›å¥½ä¹ æƒ¯ï¼Œèƒ½å¤Ÿé«˜æ•ˆçš„è¿›è¡Œdebugï¼š\n- å¯¹LVGLç”³è¯·çš„å…³é”®å†…å­˜æ·»åŠ `static`ï¼Œå°¤å…¶æ˜¯å„ç§ç¼“å†²åŒº\n- å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä»çˆ¶ç±»åˆ°å­ç±»ã€ä»å¤§åˆ°å°ã€ä»å‰åˆ°åä¾æ¬¡å®šä½æ•…éšœæ¥æºï¼Œç€é‡å…³æ³¨â€œåŠ¨æ€é˜¶æ®µâ€ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå¯¹è±¡ã€åˆ é™¤å¯¹è±¡ã€åˆ·æ–°å¯¹è±¡ç­‰ç­‰çš„è¿™äº›æ“ä½œ\n- å–„ç”¨æœç´¢åŠŸèƒ½å’Œå®˜æ–¹æ–‡æ¡£","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"C++ç±»æ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨","url":"/2025/02/18/C-ç±»æ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨/","content":"ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨çš„æ„é€ å‡½æ•°æ˜¾å¼çš„åˆå§‹åŒ–ç±»çš„æˆå‘˜ï¼š\n```\nclass example{\npublic:\n    int a;\n    float b;\n\n    example(): a(0), b(8.8)\n    {}\n}\n```\næ²¡ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨çš„æ„é€ å‡½æ•°æ˜¯å¯¹ç±»çš„æˆå‘˜èµ‹å€¼ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œæ˜¾å¼çš„åˆå§‹åŒ–:\n```\nclass example{\npublic:\n    int a;\n    float b;\n\n    example()\n    {\n        a = 0;\n        b = 8.8;\n    }\n}\n```\nåˆå§‹åŒ–å’Œèµ‹å€¼å¯¹å†…ç½®ç±»å‹çš„æˆå‘˜æ²¡æœ‰ä»€ä¹ˆå¤§çš„åŒºåˆ«ï¼Œåƒä¸Šé¢çš„ä»»ä¸€ä¸ªæ„é€ å‡½æ•°éƒ½å¯ä»¥ã€‚å¯¹éå†…ç½®ç±»å‹æˆå‘˜å˜é‡ï¼Œä¸ºäº†é¿å…ä¸¤æ¬¡æ„é€ ï¼Œæ¨èä½¿ç”¨ç±»æ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨ã€‚ä½†æœ‰çš„æ—¶å€™å¿…é¡»ç”¨å¸¦æœ‰åˆå§‹åŒ–åˆ—è¡¨çš„æ„é€ å‡½æ•°ï¼š\n- æˆå‘˜ç±»å‹æ˜¯**æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°çš„ç±»**ã€‚è‹¥æ²¡æœ‰æä¾›æ˜¾ç¤ºåˆå§‹åŒ–å¼ï¼Œåˆ™ç¼–è¯‘å™¨éšå¼ä½¿ç”¨æˆå‘˜ç±»å‹çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œè‹¥ç±»æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œåˆ™ç¼–è¯‘å™¨å°è¯•ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°å°†ä¼šå¤±è´¥ã€‚\n- **constæˆå‘˜æˆ–å¼•ç”¨ç±»å‹çš„æˆå‘˜**ã€‚å› ä¸º const å¯¹è±¡æˆ–å¼•ç”¨ç±»å‹åªèƒ½åˆå§‹åŒ–ï¼Œä¸èƒ½å¯¹ä»–ä»¬èµ‹å€¼ã€‚\n\n*åˆå§‹åŒ–æ•°æ®æˆå‘˜ä¸å¯¹æ•°æ®æˆå‘˜èµ‹å€¼çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ*\n\nå¯¹äºå†…ç½®æ•°æ®ç±»å‹å’Œå¤åˆç±»å‹ï¼ˆæŒ‡é’ˆï¼Œå¼•ç”¨ï¼‰ï¼Œåˆå§‹åŒ–è¿‡ç¨‹åœ¨æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨å’Œæ„é€ å‡½æ•°ä½“å†…è¿›è¡Œï¼Œåœ¨æ€§èƒ½å’Œç»“æœä¸Šéƒ½æ˜¯ä¸€æ ·çš„ï¼›è€Œå¯¹äºç”¨æˆ·å®šä¹‰ç±»å‹ï¼ˆç±»ç±»å‹ï¼‰ï¼Œåˆå§‹åŒ–ç»“æœç›¸åŒï¼Œä½†æ˜¯æ€§èƒ½ä¸Šå­˜åœ¨å¾ˆå¤§çš„å·®åˆ«ã€‚å› ä¸ºç±»ç±»å‹çš„æ•°æ®æˆå‘˜å¯¹è±¡åœ¨è¿›å…¥å‡½æ•°ä½“å‰å·²ç»æ„é€ å®Œæˆï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨å¤„è¿›è¡Œæ„é€ å¯¹è±¡çš„å·¥ä½œï¼Œè°ƒç”¨æ„é€ å‡½æ•°ï¼Œåœ¨è¿›å…¥å‡½æ•°ä½“ä¹‹åï¼Œè¿›è¡Œçš„æ˜¯å¯¹å·²ç»æ„é€ å¥½çš„ç±»å¯¹è±¡çš„èµ‹å€¼ï¼Œåˆè°ƒç”¨ä¸ªæ‹·è´èµ‹å€¼æ“ä½œç¬¦æ‰èƒ½å®Œæˆï¼ˆå¦‚æœå¹¶æœªæä¾›ï¼Œåˆ™ä½¿ç”¨ç¼–è¯‘å™¨æä¾›çš„é»˜è®¤æŒ‰æˆå‘˜èµ‹å€¼è¡Œä¸ºï¼‰ã€‚\n\n*æ³¨æ„*ï¼šC++åˆå§‹åŒ–ç±»æˆå‘˜æ—¶ï¼ŒæŒ‰ç…§**å£°æ˜çš„é¡ºåº**åˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯æŒ‰ç…§å‡ºç°åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­çš„é¡ºåºã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿ä½ åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­æ”¹å˜äº†æˆå‘˜çš„åˆå§‹åŒ–é¡ºåºï¼Œå®é™…åˆå§‹åŒ–æ—¶ä»ç„¶ä¼šæŒ‰ç…§å£°æ˜é¡ºåºè¿›è¡Œã€‚\n```\nclass MyClass {\npublic:\n    int a;\n    int b;\n\n    // æ„é€ å‡½æ•°\n    MyClass(int x, int y) : b(x), a(y) {\n        // å°½ç®¡åˆå§‹åŒ–åˆ—è¡¨ä¸­ b åœ¨ a å‰é¢ï¼Œä½†å®é™…åˆå§‹åŒ–é¡ºåºæ˜¯ a å…ˆäº b\n    }\n};\n```\nå¾ˆæ˜¾ç„¶è¿™ä¼šå¸¦æ¥æ½œåœ¨é—®é¢˜ï¼Œæ¯”å¦‚å¦‚æœåˆå§‹åŒ–é¡ºåºä¾èµ–äºå…¶ä»–æˆå‘˜çš„å€¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚ä¾‹å¦‚ï¼š\n```\nclass MyClass {\npublic:\n    int a;\n    int b;\n\n    // æ„é€ å‡½æ•°\n    MyClass(int x) : b(x), a(b + 1) {\n        // è¿™é‡Œ a ä¾èµ–äº b çš„å€¼ï¼Œä½†ç”±äº a å…ˆåˆå§‹åŒ–ï¼Œb è¿˜æœªåˆå§‹åŒ–ï¼Œå¯¼è‡´æœªå®šä¹‰è¡Œä¸º\n    }\n};\n```\nè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ­£ç¡®åšæ³•æ˜¯ç¡®ä¿åˆå§‹åŒ–é¡ºåºä¸ä¾èµ–äºå…¶ä»–æˆå‘˜çš„å€¼ï¼Œæˆ–è€…è°ƒæ•´æˆå‘˜çš„å£°æ˜é¡ºåºï¼š\n```\nclass MyClass {\npublic:\n    int b;\n    int a;\n\n    // æ„é€ å‡½æ•°\n    MyClass(int x) : b(x), a(b + 1) {\n        // ç°åœ¨ b å…ˆäº a åˆå§‹åŒ–ï¼Œa å¯ä»¥æ­£ç¡®ä½¿ç”¨ b çš„å€¼\n    }\n};\n```","categories":["C++"]},{"title":"é€‚ç”¨äºCortex-Açš„å¸¸è§GNUæ±‡ç¼–è¯­æ³•","url":"/2025/02/18/é€‚ç”¨äºCortex-Açš„å¸¸è§GNUæ±‡ç¼–è¯­æ³•/","content":"## è¯­å¥\nGNU æ±‡ç¼–è¯­æ³•é€‚ç”¨äºæ‰€æœ‰çš„æ¶æ„ï¼Œå¹¶ä¸æ˜¯ ARM ç‹¬äº«çš„ï¼ŒGNU æ±‡ç¼–ç”±ä¸€ç³»åˆ—çš„è¯­å¥ç»„æˆï¼Œæ¯è¡Œä¸€æ¡è¯­å¥ï¼Œæ¯æ¡è¯­å¥æœ‰ä¸‰ä¸ªå¯é€‰éƒ¨åˆ†ï¼š`label: instruction @ comment`\n- `label`ï¼šæ ‡å·ï¼Œè¡¨ç¤ºåœ°å€ä½ç½®\n- `instruction`ï¼šæŒ‡ä»¤ï¼Œæ±‡ç¼–æŒ‡ä»¤æˆ–ä¼ªæŒ‡ä»¤\n- `@ comment`ï¼šæ³¨é‡Š\n\nARMä¸­çš„æŒ‡ä»¤ã€ä¼ªæŒ‡ä»¤ã€ä¼ªæ“ä½œã€å¯„å­˜å™¨åç­‰å¯ä»¥å…¨éƒ¨ä½¿ç”¨å¤§å†™ï¼Œä¹Ÿå¯ä»¥å…¨éƒ¨ä½¿ç”¨å°å†™ï¼Œä½†æ˜¯ä¸èƒ½å¤§å°å†™æ··ç”¨ã€‚\n\n## ä¼ªæ“ä½œï¼ˆä¼ªæŒ‡ä»¤ï¼‰\nç”¨æˆ·å¯é€šè¿‡`.section`ä¼ªæ“ä½œæ¥å®šä¹‰ä¸€ä¸ªæ®µï¼Œæ±‡ç¼–ç³»ç»Ÿé¢„å®šä¹‰äº†ä¸€äº›æ®µåï¼ŒåŒ…æ‹¬ï¼š\n- `.text`ï¼šä»£ç æ®µ\n- `.data`ï¼šåˆå§‹åŒ–çš„æ•°æ®æ®µ\n- `.bss`ï¼šæœªåˆå§‹åŒ–çš„æ•°æ®æ®µ\n- `.rodata`ï¼šåªè¯»æ•°æ®æ®µ\n\n`.section`ä¹Ÿå¯ç”¨äºè‡ªå®šä¹‰æ®µï¼Œæ¯ä¸ªæ®µä»¥æ®µåå¼€å§‹ï¼Œä»¥ä¸‹ä¸€æ®µåæˆ–æ–‡ä»¶ç»“å°¾ç»“æŸã€‚å¦‚`.section .testsection @é¡¶ä¸€ä¸ªtestsectionæ®µ`\n\næ±‡ç¼–ç¨‹åºçš„é»˜è®¤å…¥å£æ ‡å·æ˜¯`_start`ï¼Œä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é“¾æ¥è„šæœ¬ä¸­ä½¿ç”¨`ENTRY`æ¥æŒ‡æ˜å…¶å®ƒçš„å…¥å£ç‚¹ï¼Œä¸‹é¢çš„ä»£ç å°±æ˜¯ä½¿ç”¨`_start`ä½œä¸ºå…¥å£æ ‡å·ï¼š\n``\n.global _start \n\n_start:\nldr r0, =0x12 @r0=0x12\n``\nä»£ç ä¸­`.global`æ˜¯ä¼ªæ“ä½œï¼Œè¡¨ç¤º`_start`æ˜¯ä¸€ä¸ªå…¨å±€æ ‡å·ï¼ˆæ€§è´¨ç±»ä¼¼äºCè¯­è¨€ä¸­çš„å…¨å±€å˜é‡ï¼‰ã€‚\n\nå¸¸è§çš„ä¼ªæŒ‡ä»¤æœ‰ï¼š\n- `.global`ï¼šå£°æ˜å…¨å±€ç¬¦å·ï¼Œå¦‚`.global main @å£°æ˜mainä¸ºå…¨å±€ç¬¦å·`\n- `.section`ï¼šå®šä¹‰æ®µ\n- `.word`ï¼šå®šä¹‰å­—æ•°æ®\n- `.asciz`ï¼šå®šä¹‰ä»¥nullç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œå¦‚`.asciz \"Hello World\"`\n- `.byte`ï¼šå®šä¹‰å•å­—èŠ‚æ•°æ®ï¼Œæ¯”å¦‚`.byte 0x12`\n- `.short`ï¼šå®šä¹‰åŒå­—èŠ‚æ•°æ®ï¼Œæ¯”å¦‚`.short 0x1234`\n- `.long`ï¼šå®šä¹‰ä¸€ä¸ª4å­—èŠ‚æ•°æ®ï¼Œæ¯”å¦‚`.long 0x12345678`\n- `.equ`ï¼šèµ‹å€¼ï¼Œå¦‚`.equ num, 0x12`è¡¨ç¤º`num=0x12`\n- `.align`ï¼šæ•°æ®å­—èŠ‚å¯¹é½ï¼Œ`.align 4`è¡¨ç¤º4å­—èŠ‚å¯¹é½\n- `.end`ï¼šè¡¨ç¤ºæºæ–‡ä»¶ç»“æŸ\n\n## å¤„ç†å™¨å†…éƒ¨æ•°æ®ä¼ è¾“æŒ‡ä»¤\næœ€å¸¸è§çš„ä¸€ç±»æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ï¼š\n- å°†æ•°æ®ä»ä¸€ä¸ªå¯„å­˜å™¨ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªå¯„å­˜å™¨\n- å°†æ•°æ®ä»ä¸€ä¸ªå¯„å­˜å™¨ä¼ é€’åˆ°ç‰¹æ®Šå¯„å­˜å™¨ï¼Œå¦‚ CPSR å’Œ SPSR å¯„å­˜å™¨\n- å°†ç«‹å³æ•°ä¼ é€’åˆ°å¯„å­˜å™¨\n\n### MOV\nå°†æ•°æ®ä»ä¸€ä¸ªå¯„å­˜å™¨æ‹·è´åˆ°å¦ä¸€ä¸ªå¯„å­˜å™¨ï¼Œæˆ–å°†ä¸€ä¸ªç«‹å³æ•°ä¼ é€’åˆ°å¯„å­˜å™¨ä¸­ã€‚\n```\nMOV R0, R1      @å¯„å­˜å™¨R1ä¸­çš„æ•°æ®ä¼ é€’ç»™R0\nMOV R0, #0x12   @ç«‹å³æ•°0x12ä¼ é€’ç»™R0\n```\n### MRS\nå°†ç‰¹æ®Šå¯„å­˜å™¨ï¼ˆå¦‚CPSRå’ŒSPSRï¼‰ä¸­çš„æ•°æ®ä¼ é€’ç»™é€šç”¨å¯„å­˜å™¨ã€‚*æ³¨æ„*ï¼šè¯»å–ç‰¹æ®Šå¯„å­˜å™¨æ•°æ®æ—¶åªèƒ½ä½¿ç”¨`MRS`æŒ‡ä»¤ã€‚\n```\nMRS R0, CPSR\n```\n### MSR\nå°†æ™®é€šå¯„å­˜å™¨çš„æ•°æ®ä¼ é€’è‡³ç‰¹æ®Šå¯„å­˜å™¨ï¼Œå³å†™å…¥ç‰¹æ®Šå¯„å­˜å™¨ã€‚\n```\nMSR CPSR, R0\n```\n\n## å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤\nARMæ— æ³•ç›´æ¥è®¿é—®å­˜å‚¨å™¨ï¼ˆå¦‚RAMï¼‰ã€‚ä»¥I.MX6ULä¸ºä¾‹ï¼Œå…¶å¯„å­˜å™¨ä¸ºRAMç±»å‹ï¼Œæ±‡ç¼–é…ç½®å¯„å­˜å™¨æ—¶éœ€å€ŸåŠ©å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤ï¼Œå°†å¾…é…ç½®çš„å€¼å†™å…¥åˆ°Rx(x=0~12)å¯„å­˜å™¨ä¸­ï¼Œç„¶åå€ŸåŠ©å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤å°†Rxä¸­çš„æ•°æ®å†™å…¥ä¹‹MX6ULçš„å¯„å­˜å™¨ä¸­ï¼Œè¯»å–äº¦åŒã€‚\n### LDR\nç”¨äºä»å­˜å‚¨å™¨åŠ è½½æ•°æ®è‡³å¯„å­˜å™¨Rxä¸­ï¼Œä¹Ÿå¯ä»¥å°†ä¸€ä¸ªç«‹å³æ•°åŠ è½½åˆ°å¯„å­˜å™¨Rxä¸­ã€‚åŠ è½½ç«‹å³æ•°æ—¶ï¼Œä½¿ç”¨`=`è€Œä¸æ˜¯`#`ï¼Œå¦‚`=0xFFFFFFFF`ã€‚\n\nåœ¨åµŒå…¥å¼å¼€å‘ä¸­ï¼ŒLDRæœ€å¸¸ç”¨çš„å°±æ˜¯è¯»å–CPUçš„å¯„å­˜å™¨å€¼ï¼š\n```\nLDR R0, =0x0209C004     @å°†å¯„å­˜å™¨åœ°å€0x0209C004åŠ è½½åˆ°R0ä¸­ï¼Œå‡†å¤‡å¯»å€\nLDR R1, [R0]            @è¯»å–åœ°å€0x0209C004ä¸­çš„å€¼åˆ°R1ä¸­\n```\n### STR\nä¸LDRç›¸åï¼ŒSTRç”¨äºå°†æ•°æ®å†™å…¥åˆ°å­˜å‚¨å™¨ä¸­ã€‚\n```\nLDR R0, =0x0209C004     @å¯„å­˜å™¨åœ°å€0x0209C004å†™å…¥R0\nLDR R1, =0x20000002     @å¾…å†™å…¥å€¼0x20000002å†™å…¥R1\nSTR R1, [R0]            @R1ä¸­çš„å€¼å†™å…¥R0ä¸­æ‰€ä¿å­˜çš„åœ°å€ä¸­\n```\n\n## è·³è½¬æŒ‡ä»¤\n### BæŒ‡ä»¤\nBæŒ‡ä»¤å°†PCå¯„å­˜å™¨çš„å€¼è®¾ç½®ä¸ºç›®æ ‡è·³è½¬åœ°å€ï¼Œä¸€æ—¦æ‰§è¡ŒBæŒ‡ä»¤ï¼ŒARMå¤„ç†å™¨å°±ä¼šç«‹å³è·³è½¬è‡³æŒ‡å®šçš„ç›®æ ‡åœ°å€ã€‚å¦‚æœå¾…è°ƒç”¨å‡½æ•°ä¸ä¼šå†è¿”å›åˆ°åŸæ¥çš„æ‰§è¡Œå¤„ï¼Œå°±å¯ä»¥ä½¿ç”¨BæŒ‡ä»¤ã€‚\n```\n_start:\n    ldr sp, =0x80200000     @è®¾ç½®æ ˆæŒ‡é’ˆ\n    b main                  @è·³è½¬åˆ°mainå‡½æ•°\n```\n### BLæŒ‡ä»¤\nç›¸æ¯”BæŒ‡ä»¤ï¼ŒBLæŒ‡ä»¤åœ¨è·³è½¬ä¹‹å‰ä¼šåœ¨å¯„å­˜å™¨ LR(R14) ä¸­ä¿å­˜å½“å‰ PC å¯„å­˜å™¨å€¼ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å°† LR å¯„å­˜å™¨ä¸­çš„å€¼é‡æ–°åŠ è½½åˆ° PC ä¸­æ¥ç»§ç»­ä»è·³è½¬ä¹‹å‰çš„ä»£ç å¤„è¿è¡Œï¼Œè¿™æ˜¯å­ç¨‹åºè°ƒç”¨ä¸€ä¸ªåŸºæœ¬ä½†å¸¸ç”¨çš„æ‰‹æ®µï¼Œå¸¸è§äºå„ç§ä¸­æ–­æœåŠ¡ç¨‹åºã€‚\n\nCortex-A å¤„ç†å™¨çš„ irq ä¸­æ–­æœåŠ¡å‡½æ•°éƒ½æ˜¯æ±‡ç¼–å†™çš„ï¼Œä¸»è¦ç”¨æ±‡ç¼–æ¥å®ç°ç°åœºçš„ä¿æŠ¤å’Œæ¢å¤ã€è·å–ä¸­æ–­å·ç­‰ã€‚ä½†æ˜¯å…·ä½“çš„ä¸­æ–­å¤„ç†è¿‡ç¨‹éƒ½æ˜¯ C å‡½æ•°ï¼Œæ‰€ä»¥å°±ä¼šå­˜åœ¨æ±‡ç¼–ä¸­è°ƒç”¨ C å‡½æ•°çš„é—®é¢˜ã€‚è€Œä¸”å½“ C è¯­è¨€ç‰ˆæœ¬çš„ä¸­æ–­å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åæ˜¯éœ€è¦è¿”å›åˆ° irq æ±‡ç¼–ä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå› ä¸ºè¿˜è¦å¤„ç†å…¶ä»–çš„å·¥ä½œï¼Œä¸€èˆ¬æ˜¯æ¢å¤ç°åœºã€‚è¿™ä¸ªæ—¶å€™å°±ä¸èƒ½ç›´æ¥ä½¿ç”¨ B æŒ‡ä»¤äº†ï¼Œå› ä¸º B æŒ‡ä»¤ä¸€æ—¦è·³è½¬å°±å†ä¹Ÿä¸ä¼šå›æ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™è¦ä½¿ç”¨ BL æŒ‡ä»¤ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\n\n```\npush {r0, r1}           @å…¥æ ˆï¼Œä¿å­˜R0, R1\ncps #0x13               @è¿›å…¥SVCæ¨¡å¼ï¼ŒCPSæŒ‡ä»¤ç”¨äºç›´æ¥ä¿®æ”¹CPSRå¯„å­˜å™¨çš„M[4:0]ï¼Œè®©CPUè¿›å…¥ä¸åŒçš„æ¨¡å¼\n\nbl system_irqhandler    @åŠ è½½Cè¯­è¨€ä¸­æ–­å¤„ç†å‡½æ•°è‡³R2å¯„å­˜å™¨\n\ncps #0x12               @è¿›å…¥IRQæ¨¡å¼\npop {r0, r1}            @æ¢å¤ç°åœº\nstr r0, {r1, 0#10}      @ä¸­æ–­æ‰§è¡Œå®Œæˆï¼Œå†™EOIR\n```\n\n## ARMä¸­å¸¸è§çš„å¯„å­˜å™¨\nå‡ ä¸ªARMä¸­å¸¸ç”¨çš„å¯„å­˜å™¨ï¼š\n- IPå¯„å­˜å™¨ï¼šå†…éƒ¨ç¨‹åºè°ƒç”¨æš‚å­˜å¯„å­˜å™¨ï¼Œå­ç¨‹åºçš„è¿æ¥textæ®µä¸­å¸¸ä½¿ç”¨è¯¥è§„åˆ™\n- SPå¯„å­˜å™¨ï¼šæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨å½“å‰æ ˆé¡¶åœ°å€ã€‚ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ˆæ˜¯ç”¨æ¥å­˜å‚¨ä¸´æ—¶å˜é‡ã€å‡½æ•°è°ƒç”¨è¿”å›åœ°å€ç­‰æ•°æ®çš„é‡è¦æ•°æ®ç»“æ„ï¼ŒSPå¯„å­˜å™¨çš„å€¼ä¼šéšç€æ ˆçš„å˜åŒ–è€Œå˜åŒ–\n- LRå¯„å­˜å™¨ï¼šè¿æ¥å¯„å­˜å™¨ï¼Œç¨‹åºè·³è½¬ï¼ˆå­ç¨‹åºè°ƒç”¨ï¼Œä¸­æ–­è·³è½¬ï¼‰åï¼Œarmè‡ªåŠ¨åœ¨è¯¥å¯„å­˜å™¨ä¸­å­˜å…¥åŸç¨‹åºï¼ˆæœªè·³è½¬ï¼‰çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå«å‡½æ•°è°ƒç”¨è¿”å›åœ°å€ã€‚å½“ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼ŒLRå¯„å­˜å™¨ä¼šå­˜å‚¨è°ƒç”¨è¯¥å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œç¨‹åºä¼šè·³è½¬åˆ°LRå¯„å­˜å™¨ä¸­å­˜å‚¨çš„åœ°å€ç»§ç»­æ‰§è¡Œã€‚\n- PCå¯„å­˜å™¨ï¼šç¨‹åºè®¡æ•°å™¨ï¼Œä¿å­˜çš„æ˜¯å½“å‰æ­£åœ¨å–æŒ‡çš„æŒ‡ä»¤çš„åœ°å€ï¼ˆarmé‡‡ç”¨2çº§æµæ°´çº¿ï¼Œå› æ­¤æ˜¯å½“å‰æ­£åœ¨æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€+8ï¼‰ã€‚PCå¯„å­˜å™¨æ˜¯ARMä¸­çš„ç¨‹åºè®¡æ•°å™¨ï¼Œç”¨äºå­˜å‚¨ä¸‹ä¸€æ¡å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ã€‚\n\næ­¤å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„çŠ¶æ€å¯„å­˜å™¨ï¼š\n- CPSRï¼šç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼Œåœ¨ä»»ä½•å¤„ç†å™¨æ¨¡å¼ä¸‹è¢«è®¿é—®ã€‚å®ƒåŒ…å«äº†æ¡ä»¶æ ‡å¿—ä½ã€ä¸­æ–­ç¦æ­¢ä½ã€å½“å‰å¤„ç†å™¨æ¨¡å¼æ ‡å¿—ä»¥åŠå…¶ä»–çš„ä¸€äº›æ§åˆ¶å’ŒçŠ¶æ€ä½ã€‚CPSRåœ¨ç”¨æˆ·çº§ç¼–ç¨‹æ—¶ç”¨äºå­˜å‚¨æ¡ä»¶ç ã€‚\n- SPSRï¼šç¨‹åºçŠ¶æ€ä¿å­˜å¯„å­˜å™¨ï¼Œæ¯ä¸€ç§å¤„ç†å™¨æ¨¡å¼ä¸‹éƒ½æœ‰ä¸€ä¸ªçŠ¶æ€å¯„å­˜å™¨SPSR,SPSRç”¨äºä¿å­˜CPSRçš„çŠ¶æ€ï¼Œä»¥ä¾¿å¼‚å¸¸è¿”å›åæ¢å¤å¼‚å¸¸å‘ç”Ÿæ—¶çš„å·¥ä½œçŠ¶æ€ã€‚å½“ç‰¹å®šçš„å¼‚å¸¸ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªå¯„å­˜å™¨ç”¨äºå­˜æ”¾å½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨çš„å†…å®¹ã€‚åœ¨å¼‚å¸¸ä¸­æ–­é€€å‡ºæ—¶ï¼Œå¯ä»¥ç”¨SPSRæ¥æ¢å¤CPSRã€‚ç”±äºç”¨æˆ·æ¨¡å¼å’Œç³»ç»Ÿæ¨¡å¼ä¸æ˜¯å¼‚å¸¸ä¸­æ–­æ¨¡å¼ï¼Œæ‰€ä»¥ä»–æ²¡æœ‰SPSRã€‚å½“ç”¨æˆ·åœ¨ç”¨æˆ·æ¨¡å¼æˆ–ç³»ç»Ÿæ¨¡å¼è®¿é—®SPSRï¼Œå°†äº§ç”Ÿä¸å¯é¢„çŸ¥çš„åæœã€‚\n\näºŒè€…å¸¸ç”¨äºMRSæˆ–MSRæŒ‡ä»¤,ç”¨äºspsrä¸­çš„å€¼è½¬ç§»åˆ°å¯„å­˜å™¨æˆ–æŠŠå¯„å­˜å™¨çš„å†…å®¹åŠ è½½åˆ°spsrä¸­ï¼Œå¦‚:\n\n```\nmrs r0, spsr                /* è¯»å–spsrå¯„å­˜å™¨ */\nmsr spsr_cxsf, r0            /* æ¢å¤spsr */\n```\n\nARMè¿›å…¥å¼‚å¸¸æ¨¡å¼åï¼ŒSPSRè‡ªåŠ¨ä¿å­˜è¿›å…¥å¼‚å¸¸å‰çš„CPSRçš„å€¼ï¼Œä»¥ä¾¿å¼‚å¸¸è¿”å›åæ¢å¤å¼‚å¸¸å‘ç”Ÿæ—¶çš„å·¥ä½œçŠ¶æ€ã€‚\n\n## LEDç‚¹ç¯ç¤ºä¾‹\n```\n.global _start  /* å…¨å±€æ ‡å· */\n\n/*\n * æè¿°ï¼š\t_startå‡½æ•°ï¼Œç¨‹åºä»æ­¤å‡½æ•°å¼€å§‹æ‰§è¡Œæ­¤å‡½æ•°å®Œæˆæ—¶é’Ÿä½¿èƒ½ã€\n *\t\t  GPIOåˆå§‹åŒ–ã€æœ€ç»ˆæ§åˆ¶GPIOè¾“å‡ºä½ç”µå¹³æ¥ç‚¹äº®LEDç¯ã€‚\n */\n_start:\n\t/* ä¾‹ç¨‹ä»£ç  */\n\t/* 1ã€ä½¿èƒ½æ‰€æœ‰æ—¶é’Ÿ */\n\tldr r0, =0X020C4068 \t/* CCGR0 */\n\tldr r1, =0XFFFFFFFF  \n\tstr r1, [r0]\t\t\n\t\n\tldr r0, =0X020C406C  \t/* CCGR1 */\n\tstr r1, [r0]\n\n\tldr r0, =0X020C4070  \t/* CCGR2 */\n\tstr r1, [r0]\n\t\n\tldr r0, =0X020C4074  \t/* CCGR3 */\n\tstr r1, [r0]\n\t\n\tldr r0, =0X020C4078  \t/* CCGR4 */\n\tstr r1, [r0]\n\t\n\tldr r0, =0X020C407C  \t/* CCGR5 */\n\tstr r1, [r0]\n\t\n\tldr r0, =0X020C4080  \t/* CCGR6 */\n\tstr r1, [r0]\n\t\n\n\t/* 2ã€è®¾ç½®GPIO1_IO03å¤ç”¨ä¸ºGPIO1_IO03 */\n\tldr r0, =0X020E0068\t/* å°†å¯„å­˜å™¨SW_MUX_GPIO1_IO03_BASEåŠ è½½åˆ°r0ä¸­ */\n\tldr r1, =0X5\t\t/* è®¾ç½®å¯„å­˜å™¨SW_MUX_GPIO1_IO03_BASEçš„MUX_MODEä¸º5 */\n\tstr r1,[r0]\n\n\t/* 3ã€é…ç½®GPIO1_IO03çš„IOå±æ€§\t\n\t *bit 16:0 HYSå…³é—­\n\t *bit [15:14]: 00 é»˜è®¤ä¸‹æ‹‰\n     *bit [13]: 0 kepperåŠŸèƒ½\n     *bit [12]: 1 pull/keeperä½¿èƒ½\n     *bit [11]: 0 å…³é—­å¼€è·¯è¾“å‡º\n     *bit [7:6]: 10 é€Ÿåº¦100Mhz\n     *bit [5:3]: 110 R0/6é©±åŠ¨èƒ½åŠ›\n     *bit [0]: 0 ä½è½¬æ¢ç‡\n     */\n    ldr r0, =0X020E02F4\t/*å¯„å­˜å™¨SW_PAD_GPIO1_IO03_BASE */\n    ldr r1, =0X10B0\n    str r1,[r0]\n\n\t/* 4ã€è®¾ç½®GPIO1_IO03ä¸ºè¾“å‡º */\n    ldr r0, =0X0209C004\t/*å¯„å­˜å™¨GPIO1_GDIR */\n    ldr r1, =0X0000008\t\t\n    str r1,[r0]\n\n\t/* 5ã€æ‰“å¼€LED0\n\t * è®¾ç½®GPIO1_IO03è¾“å‡ºä½ç”µå¹³\n\t */\n\tldr r0, =0X0209C000\t/*å¯„å­˜å™¨GPIO1_DR */\n   ldr r1, =0\t\t\n   str r1,[r0]\n\n/*\n * æè¿°ï¼š\tloopæ­»å¾ªç¯\n */\nloop:\n\tb loop \t\t\t\t\n```\n","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"æ„å¤–ä¿®æ”¹/usr/sudoæ‰€å±ç»„å’Œæƒé™åçš„æ¢å¤æ–¹æ³•","url":"/2025/02/18/æ„å¤–ä¿®æ”¹-usr-sudoæ‰€å±ç»„å’Œæƒé™åçš„æ¢å¤æ–¹æ³•/","content":"## é—®é¢˜æ¥æº\nä½¿ç”¨`arm-linux-gnueabihf-gcc`äº¤å‰ç¼–è¯‘æ—¶ï¼Œæç¤ºæƒé™ä¸è¶³ï¼Œå°è¯•ä¿®æ”¹ç›®æ ‡ç¼–è¯‘æ–‡ä»¶å’Œsudoæƒé™ï¼Œæ„å¤–å¯¹/usr/binä½¿ç”¨äº†`sudo chmod 777 /usr/bin`å‘½ä»¤ã€‚\n## Solution\nåœ¨æ— æ³•è·å¾—rootç”¨æˆ·åå’Œå¯†ç çš„æƒ…å†µä¸‹ï¼Œå‚è€ƒä¸€ä¸‹æ–¹å¼è§£å†³ï¼š\n1. é‡å¯ç”µè„‘æŒ‰ä½Shiftä¸æ”¾è¿›å…¥grubï¼Œé€‰æ‹©Ubuntu Advanced Options\n2. é€‰æ‹©recovery modeï¼Œè¿›å…¥æ¢å¤æ¨¡å¼\n3. Recovery menuä¸­é€‰æ‹©rootï¼Œå›è½¦\n4. `chown root:root   /usr/bin/sudo`ï¼Œ`chmod 4755  /usr/bin/sudo`\n5. `chown root:root   /usr/lib/sudo/sudoers.so`ï¼Œ`chmod 4755  /usr/lib/sudo/sudoers.so`\n6. `reboot`ï¼Œé‡æ–°è¿›å…¥ç³»ç»Ÿ\n\nè°¨æ…å¯¹å¾…Linuxä¸­é‡è¦æ–‡ä»¶çš„æƒé™ç»„å’Œæ‰€å±ç”¨æˆ·ç»„é—®é¢˜ã€‚\n","categories":["åµŒå…¥å¼(Linuxå¼€å‘)"]},{"title":"Cppä¸­çš„è™šå‡½æ•°ä¸çº¯è™šå‡½æ•°","url":"/2025/02/15/Cppä¸­çš„è™šå‡½æ•°ä¸çº¯è™šå‡½æ•°/","content":"## è™šå‡½æ•°\n```\nclass Animal {\npublic:\n\tvirtual void speak() {\n\t\tstd::cout << \"Animal speaks\" << std::endl;\n\t}\n};\n```\nè™šå‡½æ•°åœ¨åŸºç±»ä¸­ä½¿ç”¨`virtual`å…³é”®å­—å£°æ˜æˆå‘˜å‡½æ•°ï¼Œå¹¶å…è®¸å­ç±»é‡å†™è¯¥å‡½æ•°ï¼Œä»¥æä¾›ç‰¹å®šäºå­ç±»çš„å®ç°ã€‚é€šä¿—ä¸€ç‚¹çš„è®²ï¼š\n- å¦‚æœå­ç±»æ²¡æœ‰é‡å†™è¯¥å‡½æ•°ï¼ˆå³æä¾›è™šå‡½æ•°çš„å®ç°ï¼‰ï¼Œå°†ä¼šè‡ªåŠ¨è°ƒç”¨åŸºç±»çš„ç¼ºçœè™šå‡½æ•°å®ç°\n- å¦‚æœå­ç±»é‡å†™äº†è¯¥å‡½æ•°ï¼Œåˆ™è°ƒç”¨é‡å†™åçš„å®ç°\n\nåˆ›å»ºè™šå‡½æ•°æ—¶ï¼Œè™šå‡½æ•°æ‰€åœ¨ç±»åœ¨ç”³è¯·å†…å­˜æ—¶ä¼šåŒæ—¶ç”Ÿæˆè™šå‡½æ•°æŒ‡é’ˆ`vptr`ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘â€œè™šå‡½æ•°è¡¨â€`vtbl`ï¼Œè¡¨ä¸­æ•°æ®ä¸ºå‡½æ•°æŒ‡é’ˆï¼Œå­˜å‚¨äº†å¯¹åº”è™šå‡½æ•°å…·ä½“å®ç°æ‰€å¯¹åº”çš„ä½ç½®ã€‚\n\nå› æ­¤ï¼Œè™šå‡½æ•°çš„å®ç°è¿‡ç¨‹æ˜¯ï¼š\n1. é€šè¿‡å¯¹è±¡å†…å­˜ä¸­çš„è™šå‡½æ•°æŒ‡é’ˆ`vptr`æ‰¾åˆ°è™šå‡½æ•°è¡¨`vtbl`\n2. é€šè¿‡`vtbl`ä¸­çš„å‡½æ•°æŒ‡é’ˆæ‰¾åˆ°å¯¹åº”è™šå‡½æ•°çš„å®ç°åŒºåŸŸå¹¶è¿›è¡Œè°ƒç”¨\n\n### ç¤ºä¾‹\n```\n#include <iostream>\n\nclass Animal {\npublic:\n    //å£°æ˜è™šå‡½æ•°\n\tvirtual void speak() {\n\t\tstd::cout << \"Animal speaks\" << std::endl;\n\t}\n};\n\nclass Cat : public Animal {\npublic:\n    //é‡å†™åŸºç±»ä¸­å£°æ˜çš„è™šå‡½æ•°\n\tvoid speak() override {\n\t\tstd::cout << \"Meow\" << std::endl;\n\t}\n};\n\nclass Dog : public Animal {\npublic:\n    //é‡å†™åŸºç±»ä¸­å£°æ˜çš„è™šå‡½æ•°\n\tvoid speak() override {\n\t\tstd::cout << \"Bark\" << std::endl;\n\t}\n};\n\n\nint main() {\n\tAnimal* cat = new Cat();\n\tcat->speak();   //è¿™é‡Œçš„speak()æ¥æºæ˜¯Catç±»ï¼Œè€ŒéAnimalç±»\n\n\tAnimal* dog = new Dog();\n\tdog->speak();   //è¿™é‡Œçš„speak()æ¥æºæ˜¯Dogç±»ï¼Œè€ŒéAnimalç±»\n\n\treturn 0;\n}\n```\n\nç”±äº`speak()`ä¸ºè™šå‡½æ•°ï¼Œ`cat->speak()`ä¼šè°ƒç”¨`Cat::speak()`è€Œé`Animal::speak()`ã€‚å› ä¸ºè™šå‡½æ•°æ˜¯åŠ¨æ€ç»‘å®šï¼ˆè¿è¡Œæ—¶å¤šæ€ï¼‰çš„ï¼Œå…¶æ ¹æ®å¯¹è±¡çš„å®é™…ç±»å‹ï¼ˆCatï¼‰æ¥å†³å®šè°ƒç”¨å“ªä¸ªç‰ˆæœ¬çš„`speak()`ã€‚\n\n## çº¯è™šå‡½æ•°\n```\nclass Animal {\npublic:\n\tvirtual void isalive() = 0; //çº¯è™šå‡½æ•°\n};\n```\nåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒåŸºç±»æœ¬èº«ç”Ÿæˆå¯¹è±¡æ˜¯ä¸åˆæƒ…ç†çš„ã€‚ä¾‹å¦‚ï¼ŒåŠ¨ç‰©ä½œä¸ºä¸€ä¸ªåŸºç±»å¯ä»¥æ´¾ç”Ÿå‡ºè€è™ã€å­”é›€ç­‰å­ç±»ï¼Œä½†åŠ¨ç‰©æœ¬èº«ç”Ÿæˆå¯¹è±¡ï¼ˆâ€œä¸€ä¸ªåŠ¨ç‰©â€æ˜¯ä»€ä¹ˆï¼Ÿï¼‰æ˜æ˜¾ä¸åˆå¸¸ç†ã€‚è€Œé’ˆå¯¹æ¯ç§åŠ¨ç‰©çš„æ–¹æ³•åˆæœ‰æ‰€ä¸åŒï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨å¤šæ€ç‰¹æ€§ï¼Œä¹Ÿå°±éœ€è¦åœ¨åŸºç±»ä¸­å®šä¹‰è™šå‡½æ•°ã€‚\n\nçº¯è™šå‡½æ•°æ˜¯åœ¨åŸºç±»ä¸­å£°æ˜çš„è™šå‡½æ•°ï¼Œå®ƒè¦æ±‚ä»»ä½•æ´¾ç”Ÿç±»éƒ½è¦å®šä¹‰è‡ªå·±çš„å®ç°æ–¹æ³•ï¼Œä»¥å®ç°å¤šæ€æ€§ã€‚å®ç°äº†çº¯è™šå‡½æ•°çš„å­ç±»ï¼Œè¯¥çº¯è™šå‡½æ•°åœ¨å­ç±»ä¸­å°±å˜æˆäº†è™šå‡½æ•°ã€‚\n\nå®šä¹‰çº¯è™šå‡½æ•°æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ª**æ¥å£**ï¼Œç”¨æ¥è§„èŒƒæ´¾ç”Ÿç±»çš„è¡Œä¸ºï¼Œä¹Ÿå³è§„èŒƒç»§æ‰¿è¿™ä¸ªç±»çš„ç¨‹åºå‘˜å¿…é¡»å®ç°è¿™ä¸ªå‡½æ•°ã€‚æ´¾ç”Ÿç±»ä»…ä»…åªæ˜¯ç»§æ‰¿å‡½æ•°çš„æ¥å£ã€‚çº¯è™šå‡½æ•°çš„æ„ä¹‰åœ¨äºï¼Œè®©æ‰€æœ‰çš„ç±»å¯¹è±¡ï¼ˆä¸»è¦æ˜¯æ´¾ç”Ÿç±»å¯¹è±¡ï¼‰éƒ½å¯ä»¥æ‰§è¡Œçº¯è™šå‡½æ•°çš„åŠ¨ä½œï¼Œä½†åŸºç±»æ— æ³•ä¸ºçº¯è™šå‡½æ•°æä¾›ä¸€ä¸ªåˆç†çš„ç¼ºçœå®ç°ã€‚æ‰€ä»¥ç±»çº¯è™šå‡½æ•°çš„å£°æ˜å°±æ˜¯åœ¨å‘Šè¯‰å­ç±»çš„è®¾è®¡è€…ï¼Œâ€œä½ å¿…é¡»æä¾›ä¸€ä¸ªçº¯è™šå‡½æ•°çš„å®ç°ï¼Œä½†æˆ‘ä¸çŸ¥é“ä½ ä¼šæ€æ ·å®ç°å®ƒâ€ã€‚å¯¹äºåŠ¨ç‰©è¿™ä¸ªåŸºç±»è€Œè¨€ï¼Œå®ƒå¿…é¡»æ˜¯æŸä¸€ä¸ªç§ç±»ï¼Œå¯ä»¥æ˜¯é¸Ÿã€ç‹—ã€çŒ«ï¼Œä½†ä¸èƒ½ä»€ä¹ˆéƒ½ä¸æ˜¯ã€‚è¿™ä¸ªâ€œç§ç±»â€å°±å¯ä»¥ä½œä¸ºçº¯è™šå‡½æ•°åœ¨åŸºç±»`Animal`ä¸­å£°æ˜ã€‚\n\n*æ³¨æ„*ï¼šå«æœ‰çº¯è™šå‡½æ•°çš„ç±»ç§°ä¹‹ä¸º**æŠ½è±¡ç±»**ï¼Œå®ƒä¸èƒ½ç”Ÿæˆå¯¹è±¡ï¼ˆåˆ›å»ºå®ä¾‹ï¼‰ï¼Œåªèƒ½åˆ›å»ºå®ƒçš„æ´¾ç”Ÿç±»çš„å®ä¾‹ã€‚æŠ½è±¡ç±»æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»ï¼Œå®ƒæ˜¯ä¸ºäº†æŠ½è±¡å’Œè®¾è®¡çš„ç›®çš„ä¸ºå»ºç«‹çš„ï¼Œå®ƒå¤„äºç»§æ‰¿å±‚æ¬¡ç»“æ„çš„è¾ƒä¸Šå±‚ã€‚æŠ½è±¡ç±»çš„ä¸»è¦ä½œç”¨æ˜¯å°†æœ‰å…³çš„æ“ä½œä½œä¸ºç»“æœæ¥å£ç»„ç»‡åœ¨ä¸€ä¸ªç»§æ‰¿å±‚æ¬¡ç»“æ„ä¸­ï¼Œç”±å®ƒæ¥ä¸ºæ´¾ç”Ÿç±»æä¾›ä¸€ä¸ªå…¬å…±çš„æ ¹ï¼Œæ´¾ç”Ÿç±»å°†å…·ä½“å®ç°åœ¨å…¶åŸºç±»ä¸­ä½œä¸ºæ¥å£çš„æ“ä½œã€‚\n\næŠ½è±¡ç±»åªèƒ½ä½œä¸ºåŸºç±»æ¥ä½¿ç”¨ï¼Œå…¶çº¯è™šå‡½æ•°çš„å®ç°ç”±æ´¾ç”Ÿç±»ç»™å‡ºã€‚å¦‚æœæ´¾ç”Ÿç±»ä¸­æ²¡æœ‰é‡æ–°å®šä¹‰çº¯è™šå‡½æ•°ï¼Œè€Œåªæ˜¯ç»§æ‰¿åŸºç±»çš„çº¯è™šå‡½æ•°ï¼Œåˆ™è¿™ä¸ªæ´¾ç”Ÿç±»ä»ç„¶è¿˜æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚å¦‚æœæ´¾ç”Ÿç±»ä¸­ç»™å‡ºäº†åŸºç±»çº¯è™šå‡½æ•°çš„å®ç°ï¼Œåˆ™è¯¥æ´¾ç”Ÿç±»å°±ä¸å†æ˜¯æŠ½è±¡ç±»äº†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯ä»¥å»ºç«‹å¯¹è±¡çš„å…·ä½“çš„ç±»ã€‚\n\n```\n#include <iostream>\n\nclass Animal {\npublic:\n\tvirtual void speak() {\n\t\tstd::cout << \"Animal speaks\" << std::endl;\n\t}\n\n    //ä¸€ä¸ªåŠ¨ç‰©è¦ä¹ˆæ˜¯æ´»çš„ï¼Œè¦ä¹ˆæ˜¯æ­»çš„ï¼Œå­ç±»ä¸­å¿…é¡»å®šä¹‰è¿™ä¸ªå±æ€§ï¼Œå› æ­¤æ˜¯çº¯è™šå‡½æ•°\n\tvirtual void isalive() = 0;\n};\n\nclass Cat : public Animal {\npublic:\n\tvoid speak() override {\n\t\tstd::cout << \"Meow\" << std::endl;\n\t}\n\n    //é‡å†™åŸºç±»Animalä¸­çš„isalive()çº¯è™šå‡½æ•°\n\tvoid isalive() override {\n\t\tstd::cout << \"Cat is alive\" << std::endl;\n\t}\n};\n\nclass Dog : public Animal {\npublic:\n\tvoid speak() override {\n\t\tstd::cout << \"Bark\" << std::endl;\n\t}\n\n    //é‡å†™åŸºç±»Animalä¸­çš„isalive()çº¯è™šå‡½æ•°\n\tvoid isalive() override {\n\t\tstd::cout << \"Dog is alive\" << std::endl;\n\t}\n};\n\n\nint main() {\n\tAnimal* cat = new Cat();\n\tcat->speak();\n\tcat->isalive();\n\n\tAnimal* dog = new Dog();\n\tdog->speak();\n\tdog->isalive();\n\n\treturn 0;\n}\n```\n\nå¦‚æœè¿™é‡Œä½¿ç”¨`Animal* animal = new Animal()`ï¼Œç¼–è¯‘å™¨å°†æŠ¥é”™ï¼Œå› ä¸º`Animal`åŒ…å«çº¯è™šå‡½æ•°ï¼Œå·²ç»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚","categories":["C++"]},{"title":"LVGL9.2ç§»æ¤è‡³æ­£ç‚¹åŸå­é˜¿æ³¢ç½—STM32F429","url":"/2025/01/10/LVGL9.2ç§»æ¤è‡³æ­£ç‚¹åŸå­é˜¿æ³¢ç½—STM32F429/","content":"*å‚è€ƒæ–‡çŒ®*ï¼šLVGL ç§»æ¤åˆ° STM32 é€šæ³• (https://www.cnblogs.com/Huae/p/18621614)\nå·¥ç¨‹æ–‡ä»¶ï¼š[Github](https://github.com/AkiChen891/LVGL_v9_blank)\n## å‰è¨€\nLVGLï¼ˆLight and Versatile Graphics Libraryï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å›¾å½¢åº“ï¼Œæ—¨åœ¨ä¸ºåµŒå…¥å¼ç³»ç»Ÿæä¾›é«˜æ•ˆã€çµæ´»çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰è§£å†³æ–¹æ¡ˆã€‚å®ƒå…·æœ‰å°å·§çš„å†…å­˜å ç”¨å’Œé«˜æ€§èƒ½çš„æ¸²æŸ“èƒ½åŠ›ï¼Œæ”¯æŒå¤šç§ç¡¬ä»¶å¹³å°ï¼ŒåŒ…æ‹¬å•ç‰‡æœºã€DSP å’Œ ARM å¤„ç†å™¨ç­‰ã€‚LVGL æ”¯æŒä¸°å¯Œçš„æ§ä»¶ï¼ˆå¦‚æŒ‰é’®ã€æ ‡ç­¾ã€å›¾æ ‡ã€æ»šåŠ¨æ¡ç­‰ï¼‰ï¼Œå¹¶æä¾›å¼ºå¤§çš„ä¸»é¢˜ã€æ ·å¼å’ŒåŠ¨ç”»åŠŸèƒ½ï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿè½»æ¾è®¾è®¡å‡ºç¾è§‚ä¸”å“åº”è¿…é€Ÿçš„ç•Œé¢ã€‚æ­¤å¤–ï¼ŒLVGL è¿˜æ”¯æŒè§¦æ‘¸å±ã€å›¾å½¢åŠ é€Ÿï¼ˆå¦‚ DMA2Dï¼‰ã€å¤šçº¿ç¨‹ç­‰ç‰¹æ€§ï¼Œéå¸¸é€‚åˆç”¨äºåµŒå…¥å¼åº”ç”¨ç¨‹åºï¼Œå¦‚æ™ºèƒ½å®¶å±…ã€å·¥ä¸šæ§åˆ¶ã€åŒ»ç–—è®¾å¤‡ç­‰é¢†åŸŸã€‚\n\næœ¬æ–‡å°†ä»‹ç»ä¸€ä¸‹æœ€æ–°çš„LVGL9.2åœ¨æ­£ç‚¹åŸå­é˜¿æ³¢ç½—STMF429IGT6å¼€å‘æ¿ä¸Šçš„ç§»æ¤ã€‚æ­£ç‚¹åŸå­è‡ªå·±çš„ç§»æ¤æ•™ç¨‹è¿˜æ˜¯å‡ å¹´å‰çš„8.2ç‰ˆæœ¬ï¼ŒLVGLåœ¨è¿™ä¸ªç‰ˆæœ¬ä¹‹åå¯¹å¾ˆå¤šAPIè¿›è¡Œäº†ä¼˜åŒ–å’Œè£å‰ªï¼Œå¯¼è‡´æ­£ç‚¹åŸå­çš„æ•™ç¨‹ç°åœ¨å·²ç»ä¸æ˜¯å¾ˆå¥½ç”¨äº†ã€‚ä½†æ˜¯ä¸‡å˜ä¸ç¦»å…¶å®—ï¼ŒLVGLçš„ä¸»æ¶æ„æ²¡æœ‰å˜ï¼Œåªéœ€è¦ä¸€ç‚¹ç»†å¾®çš„æ”¹å˜å°±å¯ä»¥è¿›è¡Œç§»æ¤ã€‚\n\næˆ‘ä½¿ç”¨çš„å±å¹•æ˜¯æ­£ç‚¹åŸå­7å¯¸RGBå±ï¼Œåˆ†è¾¨ç‡ä¸º1024 * 600.ç¼–è¯‘å™¨ä¸ºIAR EW 9.6\n\nåœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿ä½ æœ‰ï¼š\n- ç›¸å…³çš„å¤–è®¾\n- æ­£ç‚¹åŸå­ä¾‹ç¨‹æä¾›çš„ä¸€ç³»åˆ—å¤–è®¾é©±åŠ¨\n- LVGL9.2ç‰ˆæœ¬æºç \n- **LVGLå®˜æ–¹çš„æ–‡æ¡£**ï¼š[ç‚¹å‡»è·³è½¬](https://docs.lvgl.io/master/)\n\næˆ‘ä¸ªäººè®¤ä¸ºLVGLå®˜æ–¹çš„æ–‡æ¡£éå¸¸é‡è¦ï¼Œè€Œä¸”å®ƒç”šè‡³æ˜¯æœ‰å®Œæ•´çš„å®˜æ–¹æˆæƒçš„[ä¸­æ–‡ç‰ˆæœ¬](https://lvgl.100ask.net/master/index.html)çš„ã€‚å¤§å¤šæ•°ä¸œè¥¿éƒ½å¯ä»¥åœ¨ä¸Šé¢æ‰¾åˆ°ã€‚\n\n## å‡†å¤‡å·¥ä½œ\n### æ‹·è´å¤–è®¾é©±åŠ¨\nå°†æ‰€æœ‰å’Œæ˜¾ç¤ºå±ã€è§¦æ‘¸å±ã€SDRAMç­‰æœ‰å…³çš„å¤–è®¾é©±åŠ¨åŠ å…¥å·¥ç¨‹ã€‚æ¢å¥è¯è¯´ï¼Œä½ çš„å·¥ç¨‹éœ€è¦åšåˆ°åœ¨æ²¡æœ‰LVGLçš„ç¯å¢ƒä¸‹ä¹Ÿèƒ½å¤Ÿé€šè¿‡æœ€åŸºæœ¬çš„æ˜¾ç¤ºå‡½æ•°åœ¨å±å¹•ä¸Šæ˜¾ç¤ºä¸œè¥¿çš„çŠ¶æ€ã€‚å¦‚æœä½ çš„å·¥ç¨‹åœ¨æ²¡æœ‰LVGLçš„ç¯å¢ƒä¸‹éƒ½æ²¡æ³•é€šè¿‡æ­£ç‚¹åŸå­ä¾‹ç¨‹é‡Œæä¾›çš„å‡½æ•°æ˜¾ç¤ºä¸œè¥¿ï¼Œé‚£æ˜¾ç„¶æ˜¯æ²¡æœ‰åŠæ³•ç»§ç»­çš„ã€‚\n\n### æ‹·è´LVGLåº“è‡³å·¥ç¨‹æ–‡ä»¶å¤¹\nLVGLä¸‹è½½å¹¶è§£å‹ä¹‹åï¼Œæ–‡ä»¶å¤¹æ ¹ç›®å½•å†…ä¼šåŒ…å«å¾ˆå¤šæ–‡ä»¶å¤¹åŠæ–‡ä»¶ã€‚åœ¨ä¸éœ€è¦demoæˆ–ä¾‹ç¨‹çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨åˆ°å…¶ä¸­çš„è¿™äº›æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š\n- examplesæ–‡ä»¶å¤¹ä¸­çš„portingæ–‡ä»¶å¤¹\n- srcæ–‡ä»¶å¤¹\n- lv_conf_template.h\n- lvgl.h\n\nåœ¨å·¥ç¨‹æ–‡ä»¶å¤¹æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªlvglsæ–‡ä»¶å¤¹ï¼š\n![](/images/lvgl/lvgl1.png)\n\nç„¶åï¼š\n1. åˆ›å»ºä¸€ä¸ªå­æ–‡ä»¶å¤¹ï¼Œåä¸ºlvgl\n2. åˆ›å»ºä¸€ä¸ªå­æ–‡ä»¶å¤¹ï¼Œåä¸ºlvgl_app\n3. å°†ä¹‹å‰æåˆ°çš„lv_conf_template.hé‡å‘½åä¸ºlv_conf.hï¼Œç§»åŠ¨åˆ°lvglsæ–‡ä»¶å¤¹çš„æ ¹ç›®å½•\n4. æ‰“å¼€examples/portingæ–‡ä»¶å¤¹ï¼Œå¤åˆ¶lv_port_disp_template.cã€lv_port_disp_template.hã€lv_port_indev_template.cã€lv_port_indev_template.hå››ä¸ªæ–‡ä»¶åˆ°lvglsæ–‡ä»¶å¤¹æ ¹ç›®å½•ï¼Œå¹¶ä¸”é‡å‘½åå››ä¸ªæ–‡ä»¶ï¼Œå»æ‰\"_template\"ã€‚è¿™æ˜¯åé¢è¦ç”¨åˆ°çš„æ˜¾ç¤ºå±å’Œè§¦æ‘¸å±æ³¨å†Œæ–‡ä»¶\n5. æŠŠsrcæ–‡ä»¶å¤¹å’Œlvgl.hå¤åˆ¶åˆ°lvgls/lvglæ–‡ä»¶å¤¹ä¸­\n\nç°åœ¨çš„lvglsæ–‡ä»¶å¤¹æ˜¯è¿™æ ·çš„ï¼š\n![](/images/lvgl/lvgl2.png)\nlvglæ–‡ä»¶å¤¹ï¼š\n![](/images/lvgl/lvgl3.png)\n\n### æ·»åŠ LVGLåº“æ–‡ä»¶è‡³å·¥ç¨‹\nå°†ä»¥ä¸‹æ–‡ä»¶å…¨éƒ¨æ·»åŠ è¿›å…¥å·¥ç¨‹ï¼ˆå¯ä»¥ä¸€è‚¡è„‘å…¨éƒ¨åŠ ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§åŸæœ¬çš„æ–‡ä»¶ç»“æ„è‡ªå·±æ…¢æ…¢åŠ ï¼‰ï¼š\n- srcæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰cæ–‡ä»¶ï¼Œ**é™¤äº†**ï¼š\n    - drawä¸­çš„nxpã€renesasã€sdl\n    - driversæ–‡ä»¶å¤¹\n- lv_port_disp.cå’Œlv_port_indev.c\n\nï¼ˆåƒä¸‡åˆ«å¿˜äº†srcæ–‡ä»¶å¤¹æ ¹ç›®å½•ä¸‹è¿˜æœ‰ä¸ªlv_init.cï¼‰\n\nç„¶åï¼Œæ·»åŠ å¤´æ–‡ä»¶ç›®å½•ï¼Œåˆ°srcä¸ºæ­¢å°±å¯ä»¥.\n\næˆ‘çš„æ·»åŠ å®Œä¹‹åçš„å·¥ç¨‹ç»“æ„é•¿è¿™ä¸ªæ ·å­ï¼š\n![](/images/lvgl/lvgl4.png)\n\n### ä¿®æ”¹Stackå’ŒHeapå¤§å°\nLVGLéœ€è¦è‡³å°‘2KBçš„Stackå’ŒHeapã€‚\n![](/images/lvgl/lvgl5.png)\n\n## ä»£ç ä¿®æ”¹\n### å®šæ—¶å™¨\nLVGLéœ€è¦ä¸€ä¸ªtickæºæ¥ä¸ºå…¶æä¾›å¿ƒè·³ï¼Œè¿™é‡Œä½¿ç”¨åŸºæœ¬å®šæ—¶å™¨TIM6å®Œæˆï¼ŒPSCä¸º10-1ï¼ŒARRä¸º6000-1.åœ¨tim.cä¸­æ·»åŠ å¦‚ä¸‹çš„å›è°ƒå‡½æ•°ï¼š\n```\nvoid HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)\n{\n  if (htim == &htim6)\n  {\n    lv_tick_inc(1);   /* LVGL systick */\n  }\n}\n```\nåˆ«å¿˜äº†åœ¨å®šæ—¶å™¨åˆå§‹åŒ–æ—¶æ‰“å¼€TIM6çš„Time baseï¼Œè®©å®šæ—¶å™¨å¼€å§‹å·¥ä½œã€‚\n### lv_conf.h\nå¯ç”¨å®ï¼š`#if 1 /*Set it to \"1\" to enable content*/`\næ£€æŸ¥ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š\n- `/*Color depth: 1 (I1), 8 (L8), 16 (RGB565), 24 (RGB888), 32 (XRGB8888)*/#define LV_COLOR_DEPTH 16`ï¼šé¢œè‰²æ·±åº¦ï¼Œé»˜è®¤ä¸ºRGB565\n- `#define LV_MEM_SIZE (64U * 1024U)          /*[bytes]*/`ç¼“å†²åŒºå¤§å°\nï¼Œé»˜è®¤64KB\n\nå…¶ä»–çš„ä¸œè¥¿ç†è®ºä¸Šä½ çœ‹ä¸æ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥æš‚æ—¶ä¸åŠ¨ï¼Œæ—¥åå¯ä»¥å¯¹ç…§ç€æ³¨é‡Šæ…¢æ…¢ç ”ç©¶ã€‚\n\n### lv_port_disp.c\n- è®¾ç½®å±å¹•åˆ†è¾¨ç‡ï¼š\n```\n#ifndef MY_DISP_HOR_RES\n    #warning Please define or replace the macro MY_DISP_HOR_RES with the actual screen width, default value 320 is used for now.\n    #define MY_DISP_HOR_RES    1024\n#endif\n\n#ifndef MY_DISP_VER_RES\n    #warning Please define or replace the macro MY_DISP_VER_RES with the actual screen height, default value 240 is used for now.\n    #define MY_DISP_VER_RES    600\n#endif\n```\næ³¨æ„ï¼Œè¿™é‡Œå¿…é¡»æ ¹æ®è‡ªå·±ä½¿ç”¨çš„å±å¹•åˆ†è¾¨ç‡æ¥è®¾ç½®ï¼å¦‚æœå°ºå¯¸è®¾ç½®çš„æ¯”å®é™…å±å¹•å°ä¼šå¯¼è‡´å®é™…çš„å›¾åƒå ä¸æ»¡æ•´ä¸ªå±å¹•ï¼Œå¦‚æœè®¾ç½®çš„æ¯”å®é™…å¤§ä¼šå¯¼è‡´èŠ±å±ã€æ’•è£‚æˆ–å¹²è„†æ— æ³•æ˜¾ç¤º\n\n- è®¾ç½®ç¼“å†²åŒº\n```\n\nvoid lv_port_disp_init(void)\n{\n    /*-------------------------\n     * Initialize your display\n     * -----------------------*/\n    disp_init();\n\n    /*------------------------------------\n     * Create a display and set a flush_cb\n     * -----------------------------------*/\n    lv_display_t * disp = lv_display_create(MY_DISP_HOR_RES, MY_DISP_VER_RES);\n    lv_display_set_flush_cb(disp, disp_flush);\n\n    /* Example 1\n     * One buffer for partial rendering*/\n    LV_ATTRIBUTE_MEM_ALIGN\n    static uint8_t buf_1_1[MY_DISP_HOR_RES * 10 * BYTE_PER_PIXEL];            /*A buffer for 10 rows*/\n    lv_display_set_buffers(disp, buf_1_1, NULL, sizeof(buf_1_1), LV_DISPLAY_RENDER_MODE_PARTIAL);\n\n    // /* Example 2\n    //  * Two buffers for partial rendering\n    //  * In flush_cb DMA or similar hardware should be used to update the display in the background.*/\n    // LV_ATTRIBUTE_MEM_ALIGN\n    // static uint8_t buf_2_1[MY_DISP_HOR_RES * 10 * BYTE_PER_PIXEL];\n\n    // LV_ATTRIBUTE_MEM_ALIGN\n    // static uint8_t buf_2_2[MY_DISP_HOR_RES * 10 * BYTE_PER_PIXEL];\n    // lv_display_set_buffers(disp, buf_2_1, buf_2_2, sizeof(buf_2_1), LV_DISPLAY_RENDER_MODE_PARTIAL);\n\n    // /* Example 3\n    //  * Two buffers screen sized buffer for double buffering.\n    //  * Both LV_DISPLAY_RENDER_MODE_DIRECT and LV_DISPLAY_RENDER_MODE_FULL works, see their comments*/\n    // LV_ATTRIBUTE_MEM_ALIGN\n    // static uint8_t buf_3_1[MY_DISP_HOR_RES * MY_DISP_VER_RES * BYTE_PER_PIXEL];\n\n    // LV_ATTRIBUTE_MEM_ALIGN\n    // static uint8_t buf_3_2[MY_DISP_HOR_RES * MY_DISP_VER_RES * BYTE_PER_PIXEL];\n    // lv_display_set_buffers(disp, buf_3_1, buf_3_2, sizeof(buf_3_1), LV_DISPLAY_RENDER_MODE_DIRECT);\n\n}\n```\næˆ‘è¿™é‡Œè®¾ç½®çš„æ˜¯å•ç¼“å†²åŒºï¼Œå®é™…æŒ‰ç…§è‡ªå·±éœ€æ±‚æ¥å°±å¯ä»¥ã€‚å¦‚æœä¸æ˜¯å¹²é‚£äº›é«˜åˆ·æ–°ç‡çš„æ´»ï¼Œå•ç¼“å†²è¶³å¤Ÿç”¨äº†ã€‚åŸä¾‹ç¨‹æä¾›äº†ä¸‰ä¸ªç¼“å†²åŒºæ–¹å¼ï¼Œåˆ†åˆ«æ˜¯å•ç¼“å†²ã€åŒç¼“å†²å’Œå…¨å°ºå¯¸åŒç¼“å†²ï¼Œé€‰æ‹©åˆé€‚çš„ä¸€ä¸ªä¹‹åæ³¨é‡Šæ‰å…¶ä»–çš„å‡ ä¸ªå°±å¯ä»¥ã€‚\n\n- æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–\n```\n/*Initialize your display and the required peripherals.*/\nstatic void disp_init(void)\n{\n    /*You code here*/\n    lcd_init();\n    lcd_display_dir(1);\n}\n```\nåœ¨è¿™é‡Œæ·»åŠ å±å¹•çš„åˆå§‹åŒ–å‡½æ•°ã€‚\n\n- è®¾ç½®åˆ·å±\n```\n/*Flush the content of the internal buffer the specific area on the display.\n *`px_map` contains the rendered image as raw pixel map and it should be copied to `area` on the display.\n *You can use DMA or any hardware acceleration to do this operation in the background but\n *'lv_display_flush_ready()' has to be called when it's finished.*/\nstatic void disp_flush(lv_display_t * disp_drv, const lv_area_t * area, uint8_t * px_map)\n{\n    if(1) {\n        /*The most simple case (but also the slowest) to put all pixels to the screen one-by-one*/\n        lcd_color_fill(area->x1, area->y1, area->x2, area->y2, (uint16_t *)px_map);\n\n    }\n    /*IMPORTANT!!!\n     *Inform the graphics library that you are ready with the flushing*/\n    lv_display_flush_ready(disp_drv);\n}\n```\nç”¨æ­£ç‚¹åŸå­ä¾‹ç¨‹ä¸­çš„lcd_color_fill()å‡½æ•°æ›¿ä»£åŸæ¥é»˜è®¤çš„ç”»ç‚¹å‡½æ•°ã€‚\n\n### lv_port_indev.c\n- ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°ï¼Œæ·»åŠ è§¦æ‘¸å±çš„åˆå§‹åŒ–å‡½æ•°\n```\nstatic void touchpad_init(void)\n{\n    /*Your code comes here*/\n    tp_dev.init();\n}\n```\n- ä¿®æ”¹è§¦æ‘¸å±æŒ‰ä¸‹çš„è¯†åˆ«åŠ¨ä½œ\n```\n/*Return true is the touchpad is pressed*/\nstatic bool touchpad_is_pressed(void)\n{\n    /*Your code comes here*/\n    tp_dev.scan(0);\n    if (tp_dev.sta & TP_PRES_DOWN) {\n        return true;\n    }\n    return false;\n}\n```\n- ä¿®æ”¹åæ ‡è¯»å–å‡½æ•°\n```\n/*Get the x and y coordinates if the touchpad is pressed*/\nstatic void touchpad_get_xy(int32_t * x, int32_t * y)\n{\n    /*Your code comes here*/\n\n    (*x) = tp_dev.x[0];\n    (*y) = tp_dev.y[0];\n}\n```\n### main.c\nåˆå§‹åŒ–ä¸€ç³»åˆ—å¤–è®¾ï¼Œå¯¹äºlvglç›¸å…³çš„å¤´æ–‡ä»¶åˆ™è¦æŒ‰é¡ºåºåˆå§‹åŒ–ï¼š\n```\n  lv_init();\n  lv_port_disp_init();\n  lv_port_indev_init();\n```\nåœ¨while(1)ä¸»å¾ªç¯ä¸­æ·»åŠ time_handler\n```\n  while (1)\n  {\n    /* USER CODE END WHILE */\n\n    /* USER CODE BEGIN 3 */\n    lv_timer_handler();\n    delay_ms(5);\n  }\n```\n\nåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå¯ä»¥åŠ ä¸€ç‚¹è‡ªå·±çš„æµ‹è¯•ä»£ç ï¼Œç„¶åç¼–è¯‘çƒ§å½•ï¼ŒLVGLå°±èƒ½æ­£å¸¸æ˜¾ç¤ºäº†ã€‚\n\n![](/images/lvgl/lvgl6.png)\n\nå¦‚æœç¢°åˆ°é—®é¢˜æ¬¢è¿ç«™å†…ç§ä¿¡ã€‚","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"æ•°ç»„ä¸­çš„è§£é¢˜æŠ€å·§","url":"/2025/01/02/æ•°ç»„ä¸­çš„è§£é¢˜æŠ€å·§/","content":"## åŒæŒ‡é’ˆ\nåŒæŒ‡é’ˆèƒ½å¤Ÿå°†$O(n^2)$å¤æ‚åº¦çš„ç®—æ³•é™ä½ä¸º$O(n)$ï¼Œå¹¶ä¸”å¸¸è§äºåŸåœ°ç®—æ³•ã€‚ä¸¤ä¸ªæŒ‡é’ˆèƒ½å¤Ÿåœ¨ä¸€ä¸ªforå¾ªç¯å†…å®Œæˆä¸¤ä¸ªforå¾ªç¯çš„å·¥ä½œã€‚\n\n### åŒå‘æŒ‡é’ˆ\n[283.ç§»åŠ¨é›¶](https://leetcode.cn/problems/move-zeroes)\n\n```\nvoid moveZeroes(int* nums, int numsSize) {\n    int slow = 0;\n\n    for (int i = 0; i < numsSize; i++)\n    {\n        if (nums[i] != 0)       //ä¸è¦åˆ¤æ–­nums[i] == 0ï¼Œå¦åˆ™ä¼šå¾ˆéº»çƒ¦\n        {\n            nums[slow] = nums[i];\n            slow++;\n        }\n    }\n\n    for (int i = slow; i < numsSize; i++)\n    {\n        nums[i] = 0;\n    }\n}\n```\nåœ¨è¿™é‡Œï¼Œslowä½œä¸ºæ…¢æŒ‡é’ˆï¼Œç”¨äºæŒ‡ç¤ºå»æ‰0ä¹‹åçš„â€œæ–°å…ƒç´ â€ï¼Œè€Œå¾ªç¯ä¸­çš„`i`ä½œä¸ºå¿«æŒ‡é’ˆï¼Œè´Ÿè´£å¤„ç†éå†ã€‚å¿«æŒ‡é’ˆèµ°çš„æ¯”æ…¢æŒ‡é’ˆå¿«ï¼Œå› æ­¤æ…¢æŒ‡é’ˆå¯¹å…ƒç´ åšçš„åŸåœ°å¤„ç†ä¸ä¼šå’Œåé¢çš„å¿«æŒ‡é’ˆæ“ä½œå‘ç”Ÿå†²çªã€‚\n\n[27.ç§»é™¤å…ƒç´ ](https://leetcode.cn/problems/remove-element)\n```\nint removeElement(int* nums, int numsSize, int val) {\n    //int fast = 0;\n    int slow = 0;\n\n    for (int i = 0; i < numsSize; i++)\n    {\n        if (nums[i] != val)\n        {\n            nums[slow] = nums[i];\n            slow++; \n        }\n    }\n\n    return slow;\n}\n```\næ€è·¯å’Œä¸Šä¸€é¢˜ç›¸åŒã€‚ä¸»è¦åˆ¤æ–­æ¡ä»¶éƒ½æ˜¯â€œä¸ç­‰äºâ€ï¼Œå› ä¸ºslowè¦æŒ‡å‘çš„å¯¹è±¡æ˜¯å¾…å‚¨å­˜å…ƒç´ ï¼ˆslowè¦é‡æ–°åœ¨æ•°ç»„å†…ä¸ºè¿™äº›å…ƒç´ åˆ†é…ä½ç½®ï¼‰ï¼Œè€Œä¸æ˜¯ç­‰äº`val`çš„å…ƒç´ ã€‚\n\n[26.åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹](https://leetcode.cn/problems/remove-duplicates-from-sorted-array)\n\n```\nint removeDuplicates(int* nums, int numsSize) {\n    int current_pos = 1;\n    for (int i = 1; i < numsSize; i++)\n    {\n        if(nums[i] != nums[i-1])    \n        {\n            nums[current_pos] = nums[i];    \n            current_pos++;\n        }\n    }\n\n    return current_pos;\n}\n```\næ€è·¯ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼Œåˆ¤æ–­å‡ºå½“å‰å…ƒç´ æ˜¯å¦å’Œå‰ä¸€ä¸ªä¸ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´è¯´æ˜è¿™ä¸ªå…ƒç´ è¦ä¿ç•™ï¼Œslowå°±ä¼šæŒ‡å‘è¿™ä¸ªå…ƒç´ ã€‚\n\n[349.ä¸¤ä¸ªæ•°ç»„çš„äº¤é›†](https://leetcode.cn/problems/intersection-of-two-arrays/)\nè¿™é¢˜çš„åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæ’åº+åŒæŒ‡é’ˆã€‚åŒæŒ‡é’ˆæ³•åªéœ€è¦ä¸€æ¬¡å¾ªç¯ï¼Œå‰ææ˜¯æ•°ç»„å¿…é¡»ç»è¿‡æ’åºã€‚æ’åºå®Œåçš„æ•°ç»„æ˜¯å‡åºçš„ï¼Œä¸¤ä¸ªæ•°ç»„åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆä»é¦–ä½å¼€å§‹å‘åéå†å¹¶æ¯”è¾ƒã€‚ä»¥è¿™ä¸¤ä¸ªæ•°ç»„ä¸ºä¾‹ï¼š\n```\n[4,9,5]\n[9,4,9,8,4]\n```\næ’åºä¹‹åçš„ç»“æœä¸º\n```\n[4,5,9]\n[4,4,8,9,9]\n```\nä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«å¼€å§‹éå†ï¼Œå¦‚æœæŒ‡é’ˆ1æŒ‡å‘å€¼å¤§äºæŒ‡é’ˆ2æŒ‡å‘å€¼ï¼Œè¯´æ˜æŒ‡é’ˆ2ä½ç½®åå·¦ï¼Œå¯¹å…¶++ï¼›å¦‚æœæŒ‡é’ˆ1æŒ‡å‘å€¼å°äºæŒ‡é’ˆ2æŒ‡å‘å€¼ï¼Œåˆ™è¯´æ˜æŒ‡é’ˆ1åå·¦ï¼Œå¯¹å…¶++ï¼›å¦‚æœæŒ‡é’ˆ1å’ŒæŒ‡é’ˆ2æŒ‡å‘å€¼å¤§å°ç›¸ç­‰ï¼Œè¯¥å€¼å±äºäº¤é›†ï¼Œæå‡ºå¹¶ä¿å­˜åœ¨resultä¸­ã€‚\n\nè¿™ä¸ªåšæ³•ä¼šå¸¦æ¥é‡å¤å­˜å…¥çš„é—®é¢˜ï¼Œæ¯”å¦‚ä¸Šé¢çš„ç®—ä¾‹ä¸­ï¼Œresultä¼šå…ˆåå­˜å…¥ä¸¤ä¸ª4ã€‚ä¸ºäº†é¿å…è¯¥æƒ…å†µå‘ç”Ÿï¼Œåœ¨å­˜å…¥æ—¶éœ€è¦åšè¿‡æ»¤ï¼Œæ¡ä»¶ä¸ºresultä¸­å¾…å­˜å…¥ä½ç½®çš„å‰ä¸€ä¸ªæ•°ä¸èƒ½ç­‰äºå½“å‰è¦å­˜å…¥çš„è¿™ä¸ªæ•°ï¼ˆ`result[k-1] != nums1[i]`ã€‚å¦‚æœå¾…å­˜å…¥ä½ç½®æ˜¯resultçš„ç¬¬ä¸€ä½ï¼Œåˆ™ä¸ç”¨åˆ¤æ–­ï¼Œç›´æ¥å­˜å…¥`k == 0`ã€‚å› ä¸ºä¸¤ä¸ªæ•°ç»„äº‹å…ˆå·²ç»æ’è¿‡åºï¼Œæ‰€ä»¥è¿™ä¸ªåˆ¤æ–­é€»è¾‘ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼Œä¸å­˜åœ¨æ¼åˆ¤æ–­çš„é—®é¢˜ã€‚\n```\n/**\n * Note: The returned array must be malloced, assume caller calls free().\n */\nint compare(const void *a, const void *b){\n    return *(int *)a - *(int *)b;\n}\n\nint* intersection(int* nums1, int nums1Size, int* nums2, int nums2Size, int* returnSize) {\n    qsort(nums1, nums1Size, sizeof(int), compare);\n    qsort(nums2, nums2Size, sizeof(int), compare);\n    int i = 0;\n    int j = 0;\n    int k = 0;\n    int* result = malloc(sizeof(int) * (nums1Size < nums2Size ? nums1Size : nums2Size));\n\n    while (i < nums1Size && j < nums2Size){\n        if (nums1[i] > nums2[j]){\n            j++;\n        }\n        else if (nums1[i] < nums2[j]){\n            i++;\n        }\n        else if (nums1[i] == nums2[j]){\n            if (k == 0 || result[k - 1] != nums1[i]){\n                result[k++] = nums1[i];\n            }\n            i++;\n            j++;\n        }\n    }\n\n    *returnSize = k;\n    return result;\n}\n```\n\n\n\n## æ’åº\n### å†’æ³¡æ’åº\n```\nvoid bubble_sort(int* nums, int numsSize)\n{\n    for (int i = 0; i < numsSize - 1; i++)\n    {\n        for (int j = 0; j < numsSize - 1 - i; j++)\n        {\n            if (nums[j] > nums[j + 1])\n            {\n                int temp = nums[j];\n                nums[j] = nums[j + 1];\n                nums[j + 1] = temp;\n            }\n        }\n    }\n}\n```\n\n### å¿«é€Ÿæ’åº\n```\n\n```\n\n## å…¶ä»–\n### Boyer-Moore æŠ•ç¥¨ç®—æ³•ï¼ˆä¼—æ•°é—®é¢˜ï¼‰\nBoyer-Moore æŠ•ç¥¨ç®—æ³•æ˜¯ä¸€ç§ç”¨äºå¯»æ‰¾**ä¼—æ•°ï¼ˆMajority Elementï¼‰**çš„é«˜æ•ˆç®—æ³•ã€‚ä¼—æ•°å®šä¹‰ä¸ºä¸€ä¸ªæ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡æ€»é•¿åº¦ä¸€åŠçš„å…ƒç´ ã€‚è¯¥ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œç©ºé—´å¤æ‚åº¦ä¸º O(1)ï¼Œéå¸¸é«˜æ•ˆã€‚æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨è®¡æ•°å™¨ï¼ˆcountï¼‰ç»´æŠ¤å½“å‰å€™é€‰å…ƒç´ çš„â€œä¼˜åŠ¿â€ï¼Œå¦‚æœæŸä¸ªå…ƒç´ åœ¨æ•´ä¸ªæ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠï¼Œç®—æ³•æœ€ç»ˆèƒ½é”å®šè¿™ä¸ªå…ƒç´ ã€‚\n\næ­¥éª¤ä¸ºï¼š \n\n1. **å€™é€‰é˜¶æ®µ**ï¼š\n   - ä»æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œå‡è®¾å®ƒæ˜¯ä¼—æ•°å€™é€‰äººï¼ˆ`candidate`ï¼‰ã€‚\n   - éå†æ•°ç»„ï¼Œå¦‚æœå½“å‰å…ƒç´ ä¸å€™é€‰äººç›¸åŒï¼Œå¢åŠ è®¡æ•°å™¨ï¼ˆ`count++`ï¼‰ï¼›å¦‚æœä¸åŒï¼Œå‡å°‘è®¡æ•°å™¨ï¼ˆ`count--`ï¼‰ã€‚\n   - å½“è®¡æ•°å™¨ä¸ºé›¶æ—¶ï¼Œé‡æ–°é€‰æ‹©ä¸‹ä¸€ä¸ªå…ƒç´ ä½œä¸ºæ–°çš„å€™é€‰äººã€‚\n\n2. **ç¡®è®¤é˜¶æ®µ**ï¼ˆå¯é€‰ï¼Œè§†é—®é¢˜éœ€æ±‚è€Œå®šï¼‰ï¼š\n   - å¦‚æœé¢˜ç›®æ˜ç¡®ä¿è¯æ•°ç»„ä¸­ä¸€å®šæœ‰ä¼—æ•°ï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ï¼Œå€™é€‰äººå³ä¸ºä¼—æ•°ã€‚\n   - å¦‚æœä¸ä¿è¯ä¼—æ•°å­˜åœ¨ï¼Œéœ€è¦å†éå†ä¸€æ¬¡æ•°ç»„ï¼ŒéªŒè¯å€™é€‰äººçš„å‡ºç°æ¬¡æ•°æ˜¯å¦è¶…è¿‡æ•°ç»„çš„ä¸€åŠã€‚\n\n[169.å¤šæ•°å…ƒç´ ](https://leetcode.cn/problems/majority-element)\n```\nint majorityElement(int* nums, int numsSize) {\n    int count = 0;      /* è®¡æ•°å™¨ */\n    int candidate = 0;  /* å€™é€‰äºº */\n\n    for (int i = 0; i < numsSize; i++){\n        if (count == 0){        /* å¦‚æœè®¡æ•°å™¨ä¸º0ï¼Œé€‰ä¸­å½“å‰å…ƒç´ ä¸ºå€™é€‰äºº */\n            candidate = nums[i];\n            count = 1;\n        }else if (nums[i] == candidate){    /* å¦‚æœå½“å‰å…ƒç´ ä¸ºå€™é€‰äºº */\n            count++;\n        }else{\n            count--;\n        }\n    }\n\n    return candidate;\n}\n```\n\n","categories":["æ•°æ®ç»“æ„"]},{"title":"FLASHã€EEPROMå’ŒFLASHæ¨¡æ‹ŸEEPROM","url":"/2025/01/02/FLASHã€EEPROMå’ŒFLASHæ¨¡æ‹ŸEEPROM/","content":"## FLASHå’ŒEEPROM\n**FLASHå­˜å‚¨å™¨**å’Œ**EEPROM**ï¼ˆç”µå¯æ“¦å¯ç¼–ç¨‹åªè¯»å­˜å‚¨å™¨ï¼‰éƒ½å±äº**éæ˜“å¤±æ€§å­˜å‚¨å™¨**ï¼Œä½†å®ƒä»¬åœ¨å·¥ä½œåŸç†ã€ä½¿ç”¨æ–¹å¼ã€åº”ç”¨åœºæ™¯ç­‰æ–¹é¢æœ‰ä¸€äº›åŒºåˆ«ã€‚\n\n### **FLASHå­˜å‚¨å™¨**\n**FLASH**ï¼ˆé—ªå­˜ï¼‰æ˜¯ä¸€ç§éæ˜“å¤±æ€§å­˜å‚¨å™¨ï¼Œèƒ½å¤Ÿåœ¨æ²¡æœ‰ç”µæºçš„æƒ…å†µä¸‹ä¿å­˜æ•°æ®ã€‚å®ƒçš„å·¥ä½œåŸç†ç±»ä¼¼äºEEPROMï¼Œä½†åœ¨æ•°æ®æ“¦é™¤å’Œå†™å…¥çš„æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒã€‚\n\n#### ç‰¹ç‚¹ï¼š\n1. **å¤§å®¹é‡**ï¼šFLASHå­˜å‚¨å™¨ä¸€èˆ¬æä¾›æ¯”EEPROMæ›´å¤§çš„å­˜å‚¨å®¹é‡ï¼Œé€šå¸¸ä»å‡ å…†å­—èŠ‚ï¼ˆMBï¼‰åˆ°å‡ ç™¾å…†å­—èŠ‚ï¼ˆç”šè‡³å‡ ä¸ªGBï¼‰ã€‚\n2. **å—æ“¦é™¤**ï¼šFLASHå­˜å‚¨å™¨ä»¥**å—**ï¼ˆé€šå¸¸ä¸ºå‡ KBåˆ°å‡ MBï¼‰ä¸ºå•ä½è¿›è¡Œæ“¦é™¤ï¼Œæ“¦é™¤æ“ä½œéœ€è¦æ¸…ç©ºæ•´ä¸ªå—ï¼Œè€Œä¸èƒ½åƒEEPROMé‚£æ ·æŒ‰å­—èŠ‚æ“¦é™¤ã€‚è¿™ä½¿å¾—FLASHçš„æ“¦å†™æ¬¡æ•°æ¯”EEPROMæ›´ä½ï¼Œä¸€èˆ¬åœ¨10,000åˆ°100,000æ¬¡ä¹‹é—´ã€‚\n3. **å†™å…¥é€Ÿåº¦è¾ƒå¿«**ï¼šç›¸æ¯”EEPROMï¼ŒFLASHçš„å†™å…¥é€Ÿåº¦æ›´å¿«ï¼Œé€‚ç”¨äºéœ€è¦å¿«é€Ÿå†™å…¥çš„åº”ç”¨åœºæ™¯ã€‚\n4. **åº”ç”¨å¹¿æ³›**ï¼šFLASHä¸»è¦ç”¨äºå­˜å‚¨å¤§å®¹é‡æ•°æ®ï¼Œå¹¿æ³›åº”ç”¨äºå›ºæ€ç¡¬ç›˜ï¼ˆSSDï¼‰ã€Uç›˜ã€å­˜å‚¨å¡ã€æ™ºèƒ½æ‰‹æœºã€åµŒå…¥å¼è®¾å¤‡ç­‰ã€‚\n5. **ç¼–ç¨‹å’Œæ“¦é™¤**ï¼šFLASHå¯ä»¥é€šè¿‡ç”µæ°”æ–¹å¼ç¼–ç¨‹å’Œæ“¦é™¤ï¼Œä½†æ“¦é™¤å’Œç¼–ç¨‹è¿‡ç¨‹æ¯”EEPROMè¦å¤æ‚å¾—å¤šï¼Œä¸”æ— æ³•åƒEEPROMé‚£æ ·è½»æ¾æŒ‰å­—èŠ‚æ›´æ–°æ•°æ®ã€‚\n\n#### ç±»å‹ï¼š\n- **NAND Flash**ï¼šä¸»è¦ç”¨äºå¤§å®¹é‡å­˜å‚¨ï¼Œé€Ÿåº¦å¿«ï¼Œæˆæœ¬ä½ï¼Œå¹¿æ³›ç”¨äºç§»åŠ¨å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚Uç›˜ã€SDå¡ã€SSDç­‰ï¼‰ã€‚\n- **NOR Flash**ï¼šé€Ÿåº¦è¾ƒæ…¢ä½†å¯æŒ‰å­—èŠ‚è¿›è¡Œè¯»å†™ï¼Œä¸»è¦ç”¨äºä»£ç å­˜å‚¨ï¼Œé€‚åˆåµŒå…¥å¼ç³»ç»Ÿã€‚\n\n### **EEPROM vs FLASH**\n| ç‰¹æ€§               | **EEPROM**                        | **FLASH**                           |\n|--------------------|-----------------------------------|-------------------------------------|\n| **å­˜å‚¨å®¹é‡**       | è¾ƒå°ï¼Œä¸€èˆ¬ä¸ºå‡ KBåˆ°å‡ MB             | è¾ƒå¤§ï¼Œå¯ä»¥è¾¾åˆ°å‡ GB                  |\n| **æ•°æ®æ“¦é™¤æ–¹å¼**   | æŒ‰å­—èŠ‚æ“¦é™¤                         | æŒ‰å—æ“¦é™¤ï¼ˆå¤§å—èŒƒå›´ï¼Œä¸€èˆ¬å‡ KBè‡³å‡ MBï¼‰|\n| **å†™å…¥é€Ÿåº¦**       | è¾ƒæ…¢ï¼Œå°¤å…¶åœ¨å•ä¸ªå­—èŠ‚å†™å…¥æ—¶         | è¾ƒå¿«ï¼Œé€‚åˆå¤§å—æ•°æ®å†™å…¥             |\n| **æ“¦å†™æ¬¡æ•°**       | è¾ƒå¤šï¼Œé€šå¸¸è¾¾åˆ°100,000æ¬¡ä»¥ä¸Š        | è¾ƒå°‘ï¼Œé€šå¸¸ä¸º10,000åˆ°100,000æ¬¡      |\n| **åº”ç”¨åœºæ™¯**       | å­˜å‚¨é…ç½®å‚æ•°ã€åºåˆ—å·ã€æ ¡å‡†æ•°æ®ç­‰  | å­˜å‚¨æ“ä½œç³»ç»Ÿã€åº”ç”¨ç¨‹åºã€æ•°æ®æ–‡ä»¶ç­‰ |\n| **ä»·æ ¼**           | è¾ƒè´µï¼Œå°¤å…¶åœ¨å°å®¹é‡æ—¶               | ç›¸å¯¹ä¾¿å®œï¼Œé€‚ç”¨äºå¤§å®¹é‡å­˜å‚¨         |\n\n- **EEPROM**é€šå¸¸ç”¨äºå­˜å‚¨å°‘é‡çš„æ•°æ®ï¼Œæ¯”å¦‚è®¾å¤‡é…ç½®ã€ç”¨æˆ·è®¾ç½®ç­‰ï¼Œéœ€è¦é¢‘ç¹çš„ã€å­—èŠ‚çº§çš„è¯»å†™æ“ä½œã€‚å®ƒçš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥å•ç‹¬å­—èŠ‚æ“¦å†™ï¼Œä½†å®¹é‡è¾ƒå°ï¼Œå†™å…¥é€Ÿåº¦è¾ƒæ…¢ã€‚\n- **FLASH**åˆ™é€‚ç”¨äºå¤§å®¹é‡çš„å­˜å‚¨éœ€æ±‚ï¼Œå¹¿æ³›ç”¨äºå­˜å‚¨æ“ä½œç³»ç»Ÿã€åº”ç”¨ç¨‹åºã€åª’ä½“æ–‡ä»¶ç­‰ã€‚ç”±äºå…¶æŒ‰å—æ“¦é™¤çš„ç‰¹æ€§ï¼Œå†™å…¥é€Ÿåº¦è¾ƒå¿«ï¼Œä½†æ“¦å†™æ¬¡æ•°è¾ƒå°‘ï¼Œé€‚åˆå¤§æ•°æ®é‡çš„å­˜å‚¨ã€‚\n\nå¯¹äºåµŒå…¥å¼ç³»ç»Ÿæ¥è¯´ï¼Œ**EEPROM**é€‚ç”¨äºéœ€è¦é¢‘ç¹æ›´æ–°çš„å°é‡æ•°æ®ï¼Œè€Œ**FLASH**åˆ™é€‚åˆå­˜å‚¨è¾ƒå¤§çš„ç¨‹åºæˆ–æ•°æ®é›†ã€‚\n\n## STM32F429ä¸­çš„FLASH\n### ç»„ç»‡æ¶æ„\n![MCUè‡ªå¸¦FLASHç»„ç»‡](/images/arm/flash1.png)\nSTM32F429 æœ¬èº«æ²¡æœ‰è‡ªå¸¦ EEPROMï¼Œä½†æ˜¯ STM32F429 å…·æœ‰ IAPï¼ˆåœ¨åº”ç”¨ç¼–ç¨‹ï¼‰åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçš„ FLASH å½“æˆ EEPROM æ¥ä½¿ç”¨ã€‚å¯¹äºF429IGT6æ¥è¯´ï¼Œå…¶FLASHå®¹é‡ä¸º1024KBã€‚FLASHæ¨¡å—åˆ†ä¸ºï¼š\n- ä¸»å­˜å‚¨å™¨ï¼šè¯¥éƒ¨åˆ†ç”¨æ¥å­˜æ”¾ä»£ç å’Œæ•°æ®å¸¸æ•°ï¼ˆå¦‚ const ç±»å‹çš„æ•°æ®ï¼‰ã€‚åˆ†ä¸ºä¸¤ä¸ª Bankï¼Œæ¯ä¸ª Bank åˆ†ä¸º 12 ä¸ªæ‰‡åŒºï¼Œå‰ 4 ä¸ªæ‰‡åŒºä¸º 16KB å¤§å°ï¼Œç¬¬äº”ä¸ªæ‰‡åŒºæ˜¯ 64KB å¤§å°ï¼Œå‰©ä¸‹çš„ 7 ä¸ªæ‰‡åŒºéƒ½æ˜¯ 128Kå¤§å°ï¼Œæ€»å…± 1M å­—èŠ‚ã€‚ä¸¤ä¸ª Bank å°±æ˜¯ 2M å­—èŠ‚ã€‚ä¸åŒå®¹é‡çš„ STM32F429ï¼Œæ‹¥æœ‰çš„æ‰‡åŒºæ•°ä¸ä¸€æ ·ã€‚ä»¥STM32F429IGT6ä¸ºä¾‹ï¼Œåªæœ‰ Bank1ï¼Œæ‹¥æœ‰ 12 ä¸ªæ‰‡åŒºï¼Œ1M å­—èŠ‚å®¹é‡ã€‚ä¸»å­˜å‚¨å™¨çš„èµ·å§‹åœ°å€ä¸€èˆ¬ä¸º 0X08000000ï¼ŒB0ã€B1 éƒ½æ¥ GND çš„æ—¶å€™ï¼Œå°±æ˜¯ä»0X08000000 å¼€å§‹è¿è¡Œä»£ç çš„ã€‚\n- ç³»ç»Ÿå­˜å‚¨å™¨ï¼šä¸»è¦ç”¨æ¥å­˜æ”¾ STM32F429çš„ bootloaderä»£ç ï¼Œæ­¤ä»£ç åœ¨å‡ºå‚æ—¶å·²ç»å›ºåŒ–åœ¨ STM32F429 å†…ï¼Œä¸“é—¨ç”¨æ¥ç»™ä¸»å­˜å‚¨å™¨ä¸‹è½½ä»£ç ã€‚å½“ B0 æ¥ V3.3ï¼ŒB1 æ¥ GND çš„æ—¶å€™ï¼Œä»è¯¥å­˜å‚¨å™¨å¯åŠ¨ï¼ˆå³è¿›å…¥ä¸²å£ä¸‹è½½æ¨¡å¼ï¼‰ã€‚\n- OTPåŒºåŸŸï¼ˆä¸€æ¬¡æ€§å¯ç¼–ç¨‹åŒºåŸŸï¼‰ï¼šå…± 528 å­—èŠ‚ï¼Œè¢«åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œå‰é¢ 512å­—èŠ‚ï¼ˆ32 å­—èŠ‚ä¸º1å—ï¼Œåˆ†æˆ16å—ï¼‰ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨ä¸€äº›ç”¨æˆ·æ•°æ®ï¼ˆä¸€æ¬¡æ€§ï¼Œå†™å®Œä¸€æ¬¡ï¼Œæ°¸è¿œä¸å¯ä»¥æ“¦é™¤ï¼‰ï¼Œåé¢ 16 å­—èŠ‚ï¼Œç”¨äºé”å®šå¯¹åº”å—ã€‚\n- é€‰é¡¹å­—èŠ‚ï¼šç”¨äºé…ç½®è¯»ä¿æŠ¤ã€BOR çº§åˆ«ã€è½¯ä»¶/ç¡¬ä»¶çœ‹é—¨ç‹—ä»¥åŠå™¨ä»¶å¤„äºå¾…æœºæˆ–åœæ­¢æ¨¡å¼ä¸‹çš„å¤ä½ã€‚\n\nåœ¨æ‰§è¡Œé—ªå­˜å†™æ“ä½œæ—¶ï¼Œä»»ä½•å¯¹é—ªå­˜çš„è¯»æ“ä½œéƒ½ä¼šé”ä½æ€»çº¿ï¼Œåœ¨å†™æ“ä½œå®Œæˆåè¯»æ“ä½œæ‰èƒ½æ­£\nç¡®åœ°è¿›è¡Œï¼›å³åœ¨è¿›è¡Œå†™æˆ–æ“¦é™¤æ“ä½œæ—¶ï¼Œä¸èƒ½è¿›è¡Œä»£ç æˆ–æ•°æ®çš„è¯»å–æ“ä½œã€‚\n\n### è¯»å–\nä¸ºäº†å‡†ç¡®è¯»å– Flash æ•°æ®ï¼Œå¿…é¡»æ ¹æ® CPU æ—¶é’Ÿ (HCLK) é¢‘ç‡å’Œå™¨ä»¶ç”µæºç”µå‹åœ¨ Flash å­˜å–æ§åˆ¶å¯„å­˜å™¨ (FLASH_ACR) ä¸­æ­£ç¡®åœ°è®¾ç½®ç­‰å¾…å‘¨æœŸæ•° (LATENCY)ã€‚å½“ç”µæºç”µå‹ä½äº 2.1V æ—¶ï¼Œå¿…é¡»å…³é—­é¢„å–ç¼“å†²å™¨ã€‚\n\n![ACLKæ—¶é’Ÿé¢‘ç‡å’Œå¯¹åº”çš„FLASHç­‰å¾…å‘¨æœŸ](/images/arm/flash2.png)\n\nç­‰å¾…å‘¨æœŸé€šè¿‡FLASH_ACRå¯„å­˜å™¨çš„LATENCY[2:0]ä¸‰ä¸ªä½è®¾ç½®ã€‚\n\nSTM32è¯»å–FLASHå¾ˆç®€å•ï¼Œä¾‹å¦‚è¦ä»åœ°å€addrè¯»å–ä¸€ä¸ªå­—ï¼ˆ32ä½ï¼‰ï¼Œåªéœ€è¦ä¸€å¥è¯ï¼š\n\n```\nData = *(volatile uint32_t *)faddr;\n```\n\nå°† faddr å¼ºåˆ¶è½¬æ¢ä¸º `volatile uint32_t` æŒ‡é’ˆï¼Œç„¶åå–è¯¥æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€çš„å€¼ï¼Œå³å¾—åˆ°äº† faddr åœ°å€çš„å€¼ã€‚ç±»ä¼¼çš„ï¼Œå°†ä¸Šé¢çš„ `volatile uint32_t` æ”¹ä¸º `volatile uint8_t`ï¼Œå³å¯è¯»å–æŒ‡å®šåœ°å€çš„ä¸€ä¸ªå­—èŠ‚ã€‚æ­¤å¤„çš„ `volatile` å…³é”®å­—å‘Šè¯‰ç¼–è¯‘å™¨è¯¥åœ°å€çš„å†…å®¹å¯èƒ½éšæ—¶æ”¹å˜ï¼Œå› æ­¤ç¦æ­¢ç¼–è¯‘å™¨å¯¹è¯¥åœ°å€åšä»»ä½•ä¼˜åŒ–ã€‚é€šå¸¸ç”¨äºè¡¨ç¤ºç¡¬ä»¶å¯„å­˜å™¨æˆ–å¤–è®¾çš„å†…å­˜åœ°å€ï¼Œå› ä¸ºè¿™äº›å†…å®¹çš„å€¼å¯èƒ½ç”±å¤–éƒ¨äº‹ä»¶ï¼ˆå¦‚å¤–éƒ¨ç¡¬ä»¶ï¼‰æ”¹å˜ã€‚\n\n### ç¼–ç¨‹å’Œæ“¦é™¤\næ‰§è¡Œä»»ä½• Flashç¼–ç¨‹æ“ä½œï¼ˆæ“¦é™¤æˆ–ç¼–ç¨‹ï¼‰æ—¶ï¼ŒCPUæ—¶é’Ÿé¢‘ç‡ï¼ˆHCLKï¼‰ä¸èƒ½ä½äº 1MHzã€‚åœ¨å¯¹ STM32F429 çš„ Flash æ‰§è¡Œå†™å…¥æˆ–æ“¦é™¤æ“ä½œæœŸé—´ï¼Œä»»ä½•è¯»å– Flash çš„å°è¯•éƒ½ä¼šå¯¼è‡´æ€»çº¿é˜»å¡ã€‚åªæœ‰åœ¨å®Œæˆç¼–ç¨‹æ“ä½œåï¼Œæ‰èƒ½æ­£ç¡®å¤„ç†è¯»æ“ä½œã€‚è¿™æ„å‘³ç€ï¼Œå†™/æ“¦é™¤æ“ä½œè¿›è¡ŒæœŸé—´ä¸èƒ½ä» Flash ä¸­æ‰§è¡Œä»£ç æˆ–æ•°æ®è·å–æ“ä½œã€‚\n\nSTM32F429 ç”¨æˆ·é—ªå­˜çš„ç¼–ç¨‹ä¸€èˆ¬ç”± 6 ä¸ª 32 ä½å¯„å­˜å™¨æ§åˆ¶ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š\n- FLASH è®¿é—®æ§åˆ¶å¯„å­˜å™¨(FLASH_ACR)\n- FLASH ç§˜é’¥å¯„å­˜å™¨(FLASH_KEYR)\n- FLASH é€‰é¡¹ç§˜é’¥å¯„å­˜å™¨(FLASH_OPTKEYR)\n- FLASH çŠ¶æ€å¯„å­˜å™¨(FLASH_SR)\n- FLASH æ§åˆ¶å¯„å­˜å™¨(FLASH_CR)\n- FLASH é€‰é¡¹æ§åˆ¶å¯„å­˜å™¨(FLASH_OPTCR)\n\nSTM32F429å¤ä½åï¼ŒFLASH ç¼–ç¨‹æ“ä½œæ˜¯è¢«ä¿æŠ¤çš„ï¼Œä¸èƒ½å†™å…¥ FLASH_CRå¯„å­˜å™¨ï¼›é€šè¿‡å†™å…¥ç‰¹å®šçš„åºåˆ—ï¼ˆ`0X45670123` å’Œ `0XCDEF89AB`ï¼‰åˆ° FLASH_KEYR å¯„å­˜å™¨æ‰å¯è§£é™¤å†™ä¿æŠ¤ï¼Œåªæœ‰åœ¨å†™ä¿æŠ¤è¢«è§£é™¤åï¼Œæˆ‘ä»¬æ‰èƒ½æ“ä½œç›¸å…³å¯„å­˜å™¨ã€‚\n\nFLASH_CR çš„è§£é”åºåˆ—ä¸ºï¼š\n1. å†™ `0X45670123` åˆ° FLASH_KEYR\n2. å†™ `0XCDEF89AB` åˆ° FLASH_KEYR\n\né€šè¿‡è¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œå³å¯è§£é” FLASH_CRï¼Œå¦‚æœå†™å…¥é”™è¯¯ï¼Œé‚£ä¹ˆ FLASH_CR å°†è¢«é”å®šï¼Œç›´åˆ°ä¸‹æ¬¡å¤ä½åæ‰å¯ä»¥å†æ¬¡è§£é”ã€‚\n\nSTM32F429 é—ªå­˜çš„ç¼–ç¨‹ä½æ•°å¯ä»¥é€šè¿‡ FLASH_CR çš„ PSIZE å­—æ®µé…ç½®ï¼ŒPSIZE çš„è®¾ç½®å¿…é¡»\nå’Œç”µæºç”µå‹åŒ¹é…ï¼š\n![ç¼–ç¨‹/æ“¦é™¤å¹¶è¡Œä½æ•°ä¸ç”µå‹å…³ç³»](/images/arm/flash3.png)\n\nå½“å¼€å‘æ¿ç”µå‹ä¸º3.3Væ—¶ï¼Œ`PSIZE`ä¸º`10`ï¼Œå¹¶è¡Œä½æ•°32ä½ã€‚ä¹Ÿå°±æ˜¯æ“¦é™¤æˆ–ç¼–ç¨‹éƒ½éœ€è¦ä»¥32ä½ä¸ºåŸºç¡€è¿›è¡Œã€‚\n\nFLASHåœ¨ç¼–ç¨‹æ—¶å¿…é¡»è¦æ±‚ç›®æ ‡å†™å…¥åœ°å€çš„FLASHå·²ç»è¢«æ“¦é™¤ï¼ˆå€¼ä¸º`0xFFFFFFFF`ï¼‰ï¼Œå¦åˆ™å°†æ— æ³•å†™å…¥ã€‚\n\nF429çš„FLASHæ ‡å‡†ç¼–ç¨‹æ­¥éª¤å¦‚ä¸‹ï¼š\n1. æ£€æŸ¥FLASH_CRä¸­çš„BSYä½ï¼Œç¡®ä¿æ€»çº¿ç©ºé—²\n2. å°†FLASH_CRå¯„å­˜å™¨çš„PGä½ç½®1ï¼Œæ¿€æ´»FLASHç¼–ç¨‹\n3. é’ˆå¯¹æ‰€éœ€å­˜å‚¨åœ°å€ï¼ˆä¸»å­˜å‚¨å™¨å—æˆ– OTP åŒºåŸŸå†…ï¼‰æ‰§è¡Œæ•°æ®å†™å…¥æ“ä½œï¼š\n    - å¹¶è¡Œä½æ•°ä¸ºx32æ—¶æŒ‰å­—å†™å…¥ï¼ˆPSIZE=02ï¼‰\n4. ç­‰å¾…BSYä½æ¸…é›¶\n\n*æ³¨æ„*ï¼š\n    - ç¼–ç¨‹å‰ç¡®ä¿å†™å…¥åœ°å€å·²ç»æ“¦é™¤\n    - å…ˆè§£é”FLASH_CRåç¼–ç¨‹\n\næ‰‡åŒºæ“¦é™¤æ­¥éª¤å¦‚ä¸‹ï¼š\n1. æ£€æŸ¥FLASH_CRçš„LOOKæ˜¯å¦è§£é”ï¼Œå¦‚æœæ²¡æœ‰åˆ™å…ˆè§£é”\n2. æ£€æŸ¥FLASH_CRä¸­çš„BSYä½ï¼Œç¡®ä¿æ€»çº¿ç©ºé—²\n3. FLASH_CRçš„SERä½ç½®1ï¼Œå¹¶ä»ä¸»å­˜å‚¨å—çš„12ä¸ªæ‰‡åŒºä¸­é€‰æ‹©è¦æ“¦é™¤çš„æ‰‡åŒºï¼ˆSNBï¼‰\n4. FLASH_CRå¯„å­˜å™¨ä¸­STRTä½ç½®1ï¼Œè§¦å‘æ“¦é™¤\n5. ç­‰å¾…BSYä½æ¸…é›¶\n\n### å¯„å­˜å™¨\n#### FLASH_ACR - Flashè®¿é—®æ§åˆ¶å¯„å­˜å™¨\n![FLASH_ACR](/images/arm/flash4.png)\né‡ç‚¹ä¸ºLATENCY[2:0]ä½ï¼Œåº”æ ¹æ®MCUç”µå‹å’Œé¢‘ç‡è®¾ç½®ï¼Œå¦åˆ™æ­»æœºã€‚\n\n#### FLASH_KEYR - Flashå¯†é’¥å¯„å­˜å™¨\n![FLASH_KEYR](/images/arm/flash5.png)\nç”¨äºè§£é”FLASH_CRï¼Œå¿…é¡»æŒ‰é¡ºåºå†™å…¥KEY1å’ŒKEY2\n\n#### FLASH_CR - Flashæ§åˆ¶å¯„å­˜å™¨\n![FLASH_CR](/images/arm/flash6.png)\n- LOCKä½ï¼šç”¨äºæŒ‡ç¤º FLASH_CR å¯„å­˜å™¨æ˜¯å¦è¢«é”ä½ï¼Œè¯¥ä½åœ¨æ£€æµ‹åˆ°æ­£ç¡®çš„è§£é”åºåˆ—åï¼Œç¡¬ä»¶å°†å…¶æ¸…é›¶ã€‚åœ¨ä¸€æ¬¡ä¸æˆåŠŸçš„è§£é”æ“ä½œåï¼Œåœ¨ä¸‹æ¬¡ç³»ç»Ÿå¤ä½ä¹‹å‰ï¼Œè¯¥ä½å°†ä¸å†æ”¹å˜ã€‚\n- PGä½ï¼šç”¨äºé€‰æ‹©ç¼–ç¨‹æ“ä½œï¼Œåœ¨å¾€ FLASH å†™æ•°æ®çš„æ—¶å€™ï¼Œè¯¥ä½éœ€è¦ç½® 1ã€‚\n- SERä½ï¼šä½ç”¨äºé€‰æ‹©æ‰‡åŒºæ“¦é™¤æ“ä½œï¼Œåœ¨æ‰‡åŒºæ“¦é™¤çš„æ—¶å€™ï¼Œéœ€è¦å°†è¯¥ä½ç½® 1ã€‚\n- PSIZE[1:0]ä½ï¼šè®¾ç½®ç¼–ç¨‹å®½åº¦ï¼Œä¸€èˆ¬è®¾ç½® PSIZE =2 å³å¯ï¼ˆ32 ä½ï¼‰ã€‚\n- STRTä½ï¼šè¯¥ä½ç”¨äºå¼€å§‹ä¸€æ¬¡æ“¦é™¤æ“ä½œã€‚åœ¨è¯¥ä½å†™å…¥ 1 ï¼Œå°†æ‰§è¡Œä¸€æ¬¡æ“¦é™¤æ“ä½œã€‚\n- SNB[3:0]ä½ï¼šç”¨äºé€‰æ‹©è¦æ“¦é™¤çš„æ‰‡åŒºç¼–å·ï¼Œå–å€¼èŒƒå›´ä¸º 0~15ã€‚\n\n#### FLASH_SR - FlashçŠ¶æ€å¯„å­˜å™¨\n![FLASH_SR](/images/arm/flash7.png)\n- BSYä½ï¼šç¡®è®¤BANKæ˜¯å¦æ­£åœ¨æ‰§è¡Œç¼–ç¨‹æ“ä½œ\n\n## ä»£ç \n### è¯»å–\n```\n /**\n * @brief       ä»æŒ‡å®šåœ°å€è¯»å–ä¸€ä¸ªå­—ï¼ˆ32ä½ï¼‰\n * @param       faddr   : è¯»å–åœ°å€\n * @retval      è¯»å–åˆ°çš„æ•°æ®ï¼ˆ32ä½ï¼‰\n */\nuint32_t stmflash_read_word(uint32_t faddr)\n{\n    return *(volatile uint32_t *)faddr;\n}\n\n/**\n* @brief ä»æŒ‡å®šåœ°å€å¼€å§‹è¯»å‡ºæŒ‡å®šé•¿åº¦çš„æ•°æ®\n* @param raddr : èµ·å§‹åœ°å€\n* @param pbuf : æ•°æ®æŒ‡é’ˆ\n* @param length: è¦è¯»å–çš„å­—(32)æ•°,å³ 4 ä¸ªå­—èŠ‚çš„æ•´æ•°å€\n* @retval æ— \n*/\nvoid stmflash_read(uint32_t raddr, uint32_t *pbuf, uint32_t length)\n{\n    uint32_t i;\n\n    for (i = 0; i < length; i++)\n    {\n        pbuf[i] = stmflash_read_word(raddr);\n        raddr += 4;\n    }\n}\n```\n### å†™å…¥\nå†™å…¥ç›¸å¯¹æ¥è¯´å¤æ‚ä¸€ç‚¹ï¼Œé¦–å…ˆè¦åˆ¤æ–­å†™å…¥åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆä¸èƒ½è¶…å‡ºFLASHåœ°å€èŒƒå›´ï¼Œä¸èƒ½ä¸æ˜¯4çš„å€æ•°ï¼‰ï¼Œåˆ¤æ–­é€šè¿‡åï¼Œè§£é”FLASHï¼Œç¦ç”¨æ•°æ®ç¼“å­˜ï¼Œç„¶ååˆ¤æ–­å¾…å†™å…¥åœ°å€èŒƒå›´æ˜¯å¦ä¸º`0xFFFFFFFF`ã€‚å¦‚æœæ˜¯ï¼Œè¡¨æ˜è¯¥åœ°å€å·²ç»è¢«æ“¦é™¤ï¼›å¦‚æœä¸æ˜¯ï¼Œè¡¨æ˜è¯¥åœ°å€éœ€è¦å…ˆæ“¦é™¤ï¼Œå†å†™å…¥ã€‚\n```\nvoid stmflash_write(uint32_t waddr, uint32_t *pbuf, uint32_t length)\n{\n    FLASH_EraseInitTypeDef flash_erase_init;\n    HAL_StatusTypeDef flashstatus = HAL_OK;\n    uint32_t sector_error = 0;\n    uint32_t addrx = 0;\n    uint32_t endaddr = 0;\n\n    if (waddr < STM32_FLASH_BASE || waddr % 4 || waddr > (STM32_FLASH_BASE + STM32_FLASH_SIZE)) return;     /* åœ°å€éæ³• */\n\n    HAL_FLASH_Unlock();\n\n    FLASH->ACR &= ~(1 << 10);       /* ç¦ç”¨æ•°æ®ç¼“å­˜ */\n    addrx = waddr;                  /* å†™å…¥èµ·å§‹åœ°å€*/\n    endaddr = waddr + length * 4;   /* å†™å…¥ç»“æŸåœ°å€ */\n\n    if (addrx < 0x1FFF0000)  /* ä¸»å­˜å‚¨åŒº*/\n        while (addrx < endaddr)\n        {\n            if (stmflash_read_word(addrx) != 0xFFFFFFFF)        /* å½“å‰åœ°å€ä¸ä¸º0xFFFFFFFFåˆ™è¡¨ç¤ºéœ€è¦æ“¦é™¤æ­¤åœ°å€ */\n            {\n                flash_erase_init.TypeErase = FLASH_TYPEERASE_SECTORS;\n                flash_erase_init.Sector = stmflash_get_flash_sector(addrx);\n                flash_erase_init.NbSectors = 1;\n                flash_erase_init.VoltageRange = FLASH_VOLTAGE_RANGE_3;\n\n                if (HAL_FLASHEx_Erase(&flash_erase_init, &sector_error) != HAL_OK) break;\n            }\n            else\n            {\n                addrx += 4;\n            }\n            FLASH_WaitForLastOperation(FLASH_WAITETIME);\n        }\n    flashstatus = FLASH_WaitForLastOperation(FLASH_WAITETIME);\n    if (flashstatus == HAL_OK)\n    {\n        while (waddr < endaddr)\n        {\n            if (HAL_FLASH_Program(FLASH_TYPEPROGRAM_WORD, waddr, *pbuf) != HAL_OK) break;\n            waddr += 4;\n            pbuf++;\n        }\n    }\n    FLASH->ACR |= 1 << 10;     /* å¯ç”¨æ•°æ®ç¼“å­˜ */\n\n    HAL_FLASH_Lock();\n}\n```\n\nè¿™é‡Œæœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š\n1. æ“¦é™¤å’Œå†™å…¥æœŸé—´å¿…é¡»ç¦ç”¨æ•°æ®ç¼“å­˜ï¼Œå¦åˆ™ç¼“å­˜å™¨ä¸­çš„ç¼“å­˜å†…å®¹å’Œæ–°çš„å†…å®¹å¯ä»¥ä¸ä¸€è‡´å¯¼è‡´bugã€‚ç¦ç”¨æ•°æ®ç¼“å­˜é€šè¿‡ä½æ“ä½œ`FLASH->ACR &= ~(1 << 10)`å®ç°ï¼Œ`1 << 10`è¡¨ç¤º`1`å·¦ç§»10ä½ï¼Œ`~`è¡¨ç¤ºå–åã€‚\n2. æ“¦é™¤æ“ä½œé€šè¿‡`HAL_FLASHEx_Erase()`å®ç°ï¼ŒHALåº“å¯¹äºè¯¥å‡½æ•°çš„å®šä¹‰ä¸ºï¼š\n```\n/**\n  * @brief  Perform a mass erase or erase the specified FLASH memory sectors\n  * @param[in]  pEraseInit pointer to an FLASH_EraseInitTypeDef structure that\n  *         contains the configuration information for the erasing.\n  *\n  * @param[out]  SectorError pointer to variable  that\n  *         contains the configuration information on faulty sector in case of error\n  *         (0xFFFFFFFFU means that all the sectors have been correctly erased)\n  *\n  * @retval HAL Status\n  */\nHAL_StatusTypeDef HAL_FLASHEx_Erase(FLASH_EraseInitTypeDef *pEraseInit, uint32_t *SectorError)\n```\nå½¢å‚1ä¸ºå­˜å‚¨æ“¦é™¤é…ç½®çš„ç»“æ„ä½“ï¼Œå½¢å‚2ä¸ºå­˜å‚¨æŠ¥é”™ä¿¡æ¯çš„å˜é‡ã€‚\nç»“æ„ä½“æ ¼å¼ä¸ºï¼š\n```\n/**\n  * @brief  FLASH Erase structure definition\n  */\ntypedef struct\n{\n  uint32_t TypeErase;   /*!< Mass erase or sector Erase.\n                             This parameter can be a value of @ref FLASHEx_Type_Erase */\n\n  uint32_t Banks;       /*!< Select banks to erase when Mass erase is enabled.\n                             This parameter must be a value of @ref FLASHEx_Banks */\n\n  uint32_t Sector;      /*!< Initial FLASH sector to erase when Mass erase is disabled\n                             This parameter must be a value of @ref FLASHEx_Sectors */\n\n  uint32_t NbSectors;   /*!< Number of sectors to be erased.\n                             This parameter must be a value between 1 and (max number of sectors - value of Initial sector)*/\n\n  uint32_t VoltageRange;/*!< The device voltage range which defines the erase parallelism\n                             This parameter must be a value of @ref FLASHEx_Voltage_Range */\n\n} FLASH_EraseInitTypeDef;\n```\n3. å…¨éƒ¨æ“¦é™¤å®Œæˆå¹¶ç­‰å¾…`FLASH_WaitForLastOperation(FLASH_WAITETIME)`ä¼ å›`HAL_OK`åï¼Œæ‰å¯ä»¥å¼€å§‹è¿›è¡Œã€‚å†™å…¥å‡½æ•°ä¸º`HAL_FLASH_Program`ï¼š\n```\n/**\n  * @brief  Program byte, halfword, word or double word at a specified address\n  * @param  TypeProgram  Indicate the way to program at a specified address.\n  *                           This parameter can be a value of @ref FLASH_Type_Program\n  * @param  Address  specifies the address to be programmed.\n  * @param  Data specifies the data to be programmed\n  *\n  * @retval HAL_StatusTypeDef HAL Status\n  */\nHAL_StatusTypeDef HAL_FLASH_Program(uint32_t TypeProgram, uint32_t Address, uint64_t Data)\n```\nå½¢å‚1ç”¨äºæŒ‡å®šå†™å…¥çš„æ˜¯å­—èŠ‚ï¼ˆ8ä½ï¼‰ã€åŠä¸ªå­—ï¼ˆ16ä½ï¼‰ã€å­—ï¼ˆ32ä½ï¼‰æˆ–åŒå­—ï¼ˆ64ä½ï¼‰ï¼›å½¢å‚2ä¸ºå†™å…¥åœ°å€ï¼Œå½¢å‚3ä¸ºå¾…å†™å…¥æ•°æ®ã€‚è¿ç»­å†™å…¥æ—¶ï¼Œå½¢å‚3ä¸€èˆ¬è®¾ç½®ä¸ºæŒ‡é’ˆï¼Œæ¯æ¬¡å¾ªç¯å¯¹ç›¸åº”åœ°å€+1å¤„ç†ã€‚\n4. å†™å…¥å®Œæˆåï¼Œå¯ç”¨æ•°æ®ç¼“å­˜ï¼ŒFLASHä¸Šé”ã€‚\n","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"CANåŠå…¶åº”ç”¨","url":"/2024/12/28/CANåŠå…¶åº”ç”¨/","content":"## ç®€ä»‹\n\nCAN æ€»çº¿ç”±å¾·å›½BOSCHå…¬å¸å¼€å‘ï¼Œæ˜¯ä¸€ç§å¤šä¸»æ§æ¶ˆæ¯å¹¿æ’­ç³»ç»Ÿï¼Œå…¶æœ€å¤§ä¿¡å·ä¼ è¾“é€Ÿç‡ä¸º1Mbpsã€‚ä¸USBæˆ–ä»¥å¤ªç½‘ç­‰ä¼ ç»Ÿç½‘ç»œä¸åŒï¼ŒCAN ä¸ä¼šåœ¨ä¸­å¤®æ€»çº¿ä¸»æ§çš„ç›‘ç£ä¸‹ä»èŠ‚ç‚¹Aå‘èŠ‚ç‚¹Bç‚¹å¯¹ç‚¹å‘é€å¤§é‡æ•°æ®åŒ…ã€‚åœ¨CANç½‘ç»œä¸­ï¼Œè®¸å¤šçŸ­æ¶ˆæ¯ï¼ˆå¦‚æ¸©åº¦æˆ–å‘åŠ¨æœºè½¬é€Ÿï¼‰ä¼šå¹¿æ’­åˆ°æ•´ä¸ªç½‘ç»œï¼Œä»è€Œç¡®ä¿ç³»ç»Ÿæ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ã€‚CAN æ˜¯å›½é™…æ ‡å‡†åŒ–ç»„ç»‡ (ISO) å®šä¹‰çš„ä¸²è¡Œé€šä¿¡æ€»çº¿ï¼Œæœ€åˆæ˜¯ä¸ºæ±½è½¦è¡Œä¸šå¼€å‘çš„ï¼Œæ—¨åœ¨ç”¨åŒçº¿æ€»çº¿å–ä»£å¤æ‚çš„çº¿æŸã€‚è¯¥è§„èŒƒè¦æ±‚å…·æœ‰è¾ƒé«˜çš„æŠ—ç”µæ°”å¹²æ‰°èƒ½åŠ›ä»¥åŠè‡ªæˆ‘è¯Šæ–­å’Œä¿®å¤æ•°æ®é”™è¯¯çš„èƒ½åŠ›ã€‚è¿™äº›ç‰¹æ€§ä½¿å¾— CAN åœ¨æ¥¼å®‡è‡ªåŠ¨åŒ–ã€åŒ»ç–—å’Œåˆ¶é€ ä¸šç­‰å„ç§è¡Œä¸šä¸­å¹¿å—æ¬¢è¿ã€‚\n\nCANå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n- **å¤šä¸»æ§åˆ¶**ã€‚åœ¨æ€»çº¿ç©ºé—²æ—¶ï¼Œæ‰€æœ‰å•å…ƒéƒ½å¯ä»¥å‘é€æ¶ˆæ¯ï¼ˆå¤šä¸»æ§åˆ¶ï¼‰ï¼Œè€Œä¸¤ä¸ªä»¥ä¸Šçš„å•å…ƒåŒæ—¶å¼€å§‹å‘é€æ¶ˆæ¯æ—¶ï¼Œæ ¹æ®æ ‡è¯†ç¬¦ï¼ˆIdentifierä»¥ä¸‹ç§°ä¸ºIDï¼‰å†³å®šä¼˜å…ˆçº§ã€‚IDå¹¶ä¸æ˜¯è¡¨ç¤ºå‘é€çš„ç›®çš„åœ°å€ï¼Œè€Œæ˜¯è¡¨ç¤ºè®¿é—®æ€»çº¿çš„æ¶ˆæ¯çš„ä¼˜å…ˆçº§ã€‚ä¸¤ä¸ªä»¥ä¸Šçš„å•å…ƒåŒæ—¶å¼€å§‹å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯¹å„æ¶ˆæ¯IDçš„æ¯ä¸ªä½è¿›è¡Œé€ä¸ªä»²è£æ¯”è¾ƒã€‚ä»²è£è·èƒœï¼ˆè¢«åˆ¤å®šä¸ºä¼˜å…ˆçº§æœ€é«˜ï¼‰çš„å•å…ƒå¯ç»§ç»­å‘é€æ¶ˆæ¯ï¼Œä»²è£å¤±åˆ©çš„å•å…ƒåˆ™ç«‹åˆ»åœæ­¢å‘é€è€Œè¿›è¡Œæ¥æ”¶å·¥ä½œã€‚\n\n- **ç³»ç»Ÿçš„æŸ”è½¯æ€§**ã€‚ä¸æ€»çº¿ç›¸è¿çš„å•å…ƒæ²¡æœ‰ç±»ä¼¼äºâ€œåœ°å€â€çš„ä¿¡æ¯ã€‚å› æ­¤åœ¨æ€»çº¿ä¸Šå¢åŠ å•å…ƒæ—¶ï¼Œè¿æ¥åœ¨æ€»çº¿ä¸Šçš„å…¶å®ƒå•å…ƒçš„è½¯ç¡¬ä»¶åŠåº”ç”¨å±‚éƒ½ä¸éœ€è¦æ”¹å˜ã€‚\n\n- **é€šä¿¡é€Ÿåº¦è¾ƒå¿«ï¼Œé€šä¿¡è·ç¦»è¿œ**ã€‚æœ€é«˜1Mbpsï¼ˆè·ç¦»å°äº40Mï¼‰ï¼Œæœ€è¿œå¯è¾¾10KMï¼ˆé€Ÿç‡ä½äº5Kbpsï¼‰ã€‚\n\n- **å…·æœ‰é”™è¯¯æ£€æµ‹ã€é”™è¯¯é€šçŸ¥å’Œé”™è¯¯æ¢å¤åŠŸèƒ½**ã€‚æ‰€æœ‰å•å…ƒéƒ½å¯ä»¥æ£€æµ‹é”™è¯¯ï¼ˆé”™è¯¯æ£€æµ‹åŠŸèƒ½ï¼‰ï¼Œæ£€æµ‹å‡ºé”™è¯¯çš„å•å…ƒä¼šç«‹å³åŒæ—¶é€šçŸ¥å…¶ä»–æ‰€æœ‰å•å…ƒï¼ˆé”™è¯¯é€šçŸ¥åŠŸèƒ½ï¼‰ï¼Œæ­£åœ¨å‘é€æ¶ˆæ¯çš„å•å…ƒä¸€æ—¦æ£€æµ‹å‡ºé”™è¯¯ï¼Œä¼šå¼ºåˆ¶ç»“æŸå½“å‰çš„å‘é€ã€‚å¼ºåˆ¶ç»“æŸå‘é€çš„å•å…ƒä¼šä¸æ–­åå¤åœ°é‡æ–°å‘é€æ­¤æ¶ˆæ¯ç›´åˆ°æˆåŠŸå‘é€ä¸ºæ­¢ï¼ˆé”™è¯¯æ¢å¤åŠŸèƒ½ï¼‰ã€‚\n\n- **æ•…éšœå°é—­åŠŸèƒ½**ã€‚CANå¯ä»¥åˆ¤æ–­å‡ºé”™è¯¯çš„ç±»å‹æ˜¯æ€»çº¿ä¸Šæš‚æ—¶çš„æ•°æ®é”™è¯¯ï¼ˆå¦‚å¤–éƒ¨å™ªå£°ç­‰ï¼‰è¿˜æ˜¯æŒç»­çš„æ•°æ®é”™è¯¯ï¼ˆå¦‚å•å…ƒå†…éƒ¨æ•…éšœã€é©±åŠ¨å™¨æ•…éšœã€æ–­çº¿ç­‰ï¼‰ã€‚ç”±æ­¤åŠŸèƒ½ï¼Œå½“æ€»çº¿ä¸Šå‘ç”ŸæŒç»­æ•°æ®é”™è¯¯æ—¶ï¼Œå¯å°†å¼•èµ·æ­¤æ•…éšœçš„å•å…ƒä»æ€»çº¿ä¸Šéš”ç¦»å‡ºå»ã€‚\n\n- **è¿æ¥èŠ‚ç‚¹å¤š**ã€‚CANæ€»çº¿æ˜¯å¯åŒæ—¶è¿æ¥å¤šä¸ªå•å…ƒçš„æ€»çº¿ã€‚å¯è¿æ¥çš„å•å…ƒæ€»æ•°ç†è®ºä¸Šæ˜¯æ²¡æœ‰é™åˆ¶çš„ã€‚ä½†å®é™…ä¸Šå¯è¿æ¥çš„å•å…ƒæ•°å—æ€»çº¿ä¸Šçš„æ—¶é—´å»¶è¿ŸåŠç”µæ°”è´Ÿè½½çš„é™åˆ¶ã€‚é™ä½é€šä¿¡é€Ÿåº¦ï¼Œå¯è¿æ¥çš„å•å…ƒæ•°å¢åŠ ï¼›æé«˜é€šä¿¡é€Ÿåº¦ï¼Œåˆ™å¯è¿æ¥çš„å•å…ƒæ•°å‡å°‘ã€‚\n\nCAN åè®®ç»è¿‡ ISO æ ‡å‡†åŒ–åæœ‰ä¸¤ä¸ªæ ‡å‡†ï¼šISO11898 æ ‡å‡†ï¼ˆé«˜é€Ÿ CANï¼‰å’Œ ISO11519-2 æ ‡å‡†ï¼ˆä½é€Ÿ CANï¼‰ã€‚å…¶ä¸­ ISO11898 æ˜¯é’ˆå¯¹é€šä¿¡é€Ÿç‡ä¸º 125Kbps~1Mbps çš„é«˜é€Ÿé€šä¿¡æ ‡å‡†ï¼Œè€ŒISO11519-2 æ˜¯é’ˆå¯¹é€šä¿¡é€Ÿç‡ä¸º 125Kbps ä»¥ä¸‹çš„ä½é€Ÿé€šä¿¡æ ‡å‡†ã€‚\n\nä¸‹æ–‡é»˜è®¤ä»‹ç»ISO11898-2æ ‡å‡†ä¸‹çš„CANï¼Œä¹Ÿå°±æ˜¯é«˜é€ŸCANã€‚\n\n## ç‰©ç†å±‚\n![é«˜é€ŸCANæ€»çº¿](/images/arm/CAN1.png)\né«˜é€ŸCANæ€»çº¿å‘ˆç°é—­ç¯ç»“æ„ï¼Œæ€»å…±ç”±ä¸¤æ ¹çº¿ï¼ˆCAN_Highå’ŒCAN_Lowï¼‰ç»„æˆï¼Œæ€»çº¿ä¸¤ç«¯å„ä¸²è”120Î©ç”µé˜»ï¼Œç”¨äºé˜»æŠ—åŒ¹é…ã€‚æ¯ä¸ªæŒ‚è½½èŠ‚ç‚¹æ‹¥æœ‰ç‹¬ç«‹çš„CANæ§åˆ¶å™¨ï¼ˆé€šå¸¸é›†æˆäºMCUå†…ï¼‰å’ŒCANæ”¶å‘å™¨ï¼ˆé€šå¸¸ä¸ºå¤–éƒ¨ICï¼‰ã€‚\n\n![é«˜é€ŸCANç‰©ç†å±‚ç‰¹æ€§](/images/arm/CAN2.png)\n\nä¸RS485ç±»ä¼¼ï¼ŒCANé€šè¿‡å·®åˆ†ä¿¡å·ä¼ è¾“æ•°æ®ï¼Œä»¥é™ä½å…±æ¨¡å™ªå£°çš„å¹²æ‰°ï¼Œé€šè¿‡CANæ€»çº¿ä¸Šä¸¤æ ¹çº¿ä¹‹é—´çš„ç”µä½å·®æ¥åˆ¤æ–­æ€»çº¿ç”µå¹³ã€‚æ€»çº¿ç”µå¹³åˆ†ä¸ºæ˜¾æ€§ï¼ˆDominantï¼‰ç”µå¹³å’Œéšæ€§ï¼ˆRecessiveï¼‰ç”µå¹³ã€‚å½“æ€»çº¿ä¸Šä»»ä½•è®¾å¤‡ä¼ è¾“æ˜¾æ€§ (0) æ—¶ï¼Œé«˜é€Ÿ CAN ä¿¡å·ä¼šå°† CANH çº¿é©±åŠ¨è‡³ 3.5 Vï¼Œå°† CANL çº¿é©±åŠ¨è‡³ 1.5 Vï¼›è€Œå¦‚æœæ²¡æœ‰è®¾å¤‡ä¼ è¾“æ˜¾æ€§ï¼Œåˆ™ç»ˆç«¯ç”µé˜»ä¼šå°†ä¸¤æ¡çº¿è¢«åŠ¨åœ°è¿”å›åˆ°éšæ€§ (1) çŠ¶æ€ï¼Œæ ‡ç§°å·®åˆ†ç”µå‹ä¸º 0 Vã€‚ï¼ˆæ¥æ”¶å™¨å°†ä»»ä½•å°äº 0.5 V çš„å·®åˆ†ç”µå‹è§†ä¸ºéšæ€§ã€‚ï¼‰æ˜¾æ€§å·®åˆ†ç”µå‹çš„æ ‡ç§°å€¼ä¸º 2 Vã€‚æ˜¾æ€§å…±æ¨¡ç”µå‹ (CANH+CANL)/2 å¿…é¡»åœ¨å…±æ¨¡çš„ 1.5 è‡³ 3.5 V èŒƒå›´å†…ï¼Œè€Œéšæ€§å…±æ¨¡ç”µå‹å¿…é¡»åœ¨å…±æ¨¡çš„ Â±12V èŒƒå›´å†…ã€‚\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹æ–‡ä¸­ï¼š\n- æ˜¾æ€§ç”µå¹³ï¼šé€»è¾‘ 0\n- éšæ€§ç”µå¹³ï¼šé€»è¾‘ 1\n\nå¯è§ï¼Œæ˜¾æ€§ç”µå¹³çš„â€œæ˜¾æ€§â€å…·æœ‰â€œä¼˜å…ˆâ€çš„æ„å‘³ï¼Œå³æ€»çº¿ä¸Šåªè¦æœ‰ä¸€ä¸ªå•å…ƒè¾“å‡ºæ˜¾æ€§ç”µå¹³ï¼Œæ€»çº¿ä¸Šå³ä¸ºæ˜¾æ€§ç”µå¹³ã€‚è€Œéšæ€§ç”µå¹³çš„â€œéšæ€§â€å…·æœ‰â€œåŒ…å®¹â€çš„æ„å‘³ï¼Œåªæœ‰æ‰€æœ‰çš„å•å…ƒéƒ½è¾“å‡ºéšæ€§ç”µå¹³ï¼Œæ€»çº¿ä¸Šæ‰ä¸ºéšæ€§ç”µå¹³ã€‚\n\n## åè®®\nCANåè®®é€šè¿‡5ç§ç±»å‹çš„å¸§è¿›è¡Œï¼š\n- æ•°æ®å¸§ï¼šç”¨äºå‘é€å•å…ƒå‘æ¥æ”¶å•å…ƒä¼ é€æ•°æ®\n- é¥æ§å¸§ï¼šç”¨äºæ¥æ”¶å•å…ƒå‘å…·æœ‰ç›¸åŒIDçš„å‘é€å•å…ƒè¯·æ±‚æ•°æ®\n- é”™è¯¯å¸§ï¼šç”¨äºå½“æ£€æµ‹å‡ºé”™è¯¯æ—¶å‘å…¶å®ƒå•å…ƒé€šçŸ¥é”™è¯¯\n- è¿‡è½½å¸§ï¼šç”¨äºæ¥æ”¶å•å…ƒé€šçŸ¥å…¶å°šæœªåšå¥½æ¥æ”¶å‡†å¤‡\n- é—´éš”å¸§ï¼šç”¨äºå°†æ•°æ®å¸§åŠé¥æ§å¸§ä¸å‰é¢çš„å¸§åˆ†ç¦»å¼€æ¥\n\næ•°æ®å¸§å’Œé¥æ§å¸§è¿˜åˆ†ä¸ºæ ‡å‡†æ ¼å¼å’Œæ‰©å±•æ ¼å¼ä¸¤ç§ï¼Œæ ‡å‡†æ ¼å¼çš„æ ‡è¯†ç¬¦ï¼ˆIdentifierï¼‰ä¸º11ä½ï¼Œæ‰©å±•æ ¼å¼ä¸º29ä½ã€‚\n\n### æ ‡å‡†æ ¼å¼ä¸‹çš„æ•°æ®å¸§\n![é«˜é€ŸCANæ ‡å‡†æ ¼å¼ä½æ ‡è¯†](/images/arm/CAN3.png)\n![é«˜é€ŸCANæ ‡å‡†æ ¼å¼ä½æ ‡è¯†](/images/arm/CAN4.png)\n*æ³¨æ„*ï¼šä¸‹æ–¹Dè¡¨ç¤ºæ˜¾æ€§ç”µå¹³ï¼ˆé€»è¾‘0ï¼‰ï¼ŒRè¡¨ç¤ºéšæ€§ç”µå¹³ï¼ˆé€»è¾‘1ï¼‰ï¼ŒD/Rè¡¨ç¤ºé€»è¾‘ç”µå¹³è§†é…ç½®è€Œå®šã€‚\n\næ•°æ®å¸§ç”±7ä¸ªæ®µæ„æˆï¼Œåˆ†åˆ«ä¸ºï¼š\n- å¸§èµ·å§‹\n- ä»²è£æ®µï¼šè¡¨ç¤ºè¯¥å¸§ä¼˜å…ˆçº§\n- æ§åˆ¶æ®µï¼šè¡¨ç¤ºæ•°æ®å­—èŠ‚æ•°å’Œä¿ç•™ä½\n- æ•°æ®æ®µï¼šæ•°æ®å†…å®¹ï¼Œä¸€å¸§ä¸€èˆ¬å¯å‘é€0-8ä¸ªå­—èŠ‚\n- CRCæ®µï¼šæ ¡éªŒå¸§ä¼ è¾“æ­£ç¡®æ€§\n- ACKæ®µï¼šç¡®è®¤æ˜¯å¦æ­£å¸¸æ¥æ”¶\n- å¸§ç»“æŸ\n\n#### å¸§èµ·å§‹ï¼ˆ1ä½ï¼‰\n- SOFï¼š1ä½ï¼Œæ˜¾æ€§ç”µå¹³ï¼Œå¸§èµ·å§‹ï¼ˆStart of Frameï¼‰ï¼Œå•ä¸ªæ˜¾æ€§å¸§èµ·å§‹ (SOF) ä½æ ‡è®°æ¶ˆæ¯çš„å¼€å§‹ï¼Œç”¨äºåœ¨ç©ºé—²ååŒæ­¥æ€»çº¿ä¸Šçš„èŠ‚ç‚¹ã€‚\n\n#### ä»²è£æ®µï¼ˆ11ä½ï¼‰\n- Identifierï¼š11ä½ï¼ˆæ‰©å±•ä¸‹ä¸º29ä½ï¼‰ï¼Œå³æ ‡è¯†ç¬¦ï¼Œåˆåä»²è£æ®µï¼Œæ ‡å‡†CANæ¨¡å¼ä¸‹ä¸º 11 ä½ï¼Œç”¨äºç¡®å®šæ¶ˆæ¯çš„ä¼˜å…ˆçº§ã€‚äºŒè¿›åˆ¶å€¼è¶Šä½ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚\n\n*æ³¨æ„ï¼šæ— è®ºæ˜¯æ ‡å‡†æ ¼å¼è¿˜æ˜¯æ‰©å±•æ ¼å¼ï¼Œéƒ½ç¦æ­¢IDçš„é«˜7ä½éƒ½ä¸ºéšæ€§ï¼Œå³ç¦æ­¢è®¾å®šIDä¸º1111111XXXXã€‚*\n\n- RTRï¼š1ä½ï¼Œç”¨äºæ ‡è¯†æ˜¯å¦ä¸ºè¿œç¨‹å¸§ï¼ˆ0ï¼šæ•°æ®å¸§ï¼›1ï¼šè¿œç¨‹å¸§ï¼‰\n\n#### æ§åˆ¶æ®µï¼ˆ6ä½ï¼‰\n- IDEï¼š1ä½ï¼Œæ ‡è¯†ç¬¦é€‰æ‹©ä½ï¼ˆ0ï¼šä½¿ç”¨æ ‡å‡†IDï¼›1ï¼šä½¿ç”¨æ‰©å±•IDï¼‰\n- r0ï¼š1ä½ï¼Œæ˜¾æ€§ç”µå¹³ï¼Œä¿ç•™ä½ï¼ˆå¯èƒ½ç”¨äºæœªæ¥çš„æ ‡å‡†ä¿®è®¢ï¼‰\n- DLCï¼š4ä½ï¼Œæ ‡è¯†å½“å‰æ­£åœ¨ä¼ è¾“çš„æ•°æ®çš„å­—èŠ‚æ•°ï¼Œé«˜ä½åœ¨å‰\n\n*æ³¨æ„*ï¼šå¯¹äºDLCä½ï¼Œé€šå¸¸åªå…è®¸ä¼ è¾“0-8ï¼Œä½†æ¥æ”¶æ–¹å¯¹DLC=9~15çš„æƒ…å†µå¹¶ä¸è§†ä½œé”™è¯¯\n\n| æ•°æ®å­—èŠ‚æ•° | DLC3 | DLC2 | DLC1 | DLC0 |\n|------------|------|------|------|------|\n| 0          | D    | D    | D    | D    |\n| 1          | D    | D    | D    | R    |\n| 2          | D    | D    | R    | D    |\n| 3          | D    | D    | R    | R    |\n| 4          | D    | R    | D    | D    |\n| 5          | D    | R    | D    | R    |\n| 6          | D    | R    | R    | D    |\n| 7          | D    | R    | R    | R    |\n| 8          | R    | D    | D    | D    |\n\nè¡¨ä¸­Då’ŒRå®é™…ä¸Šå°±æ˜¯0å’Œ1.æ¯”å¦‚8ä¸ªå­—èŠ‚æ‰€å¯¹åº”çš„RDDDå®é™…ä¸Šå°±æ˜¯äºŒè¿›åˆ¶çš„1000.\n\n#### æ•°æ®æ®µï¼ˆ0-64ä½ï¼‰\næ•°æ®æ®µæœ€å¤šä¼ è¾“8å­—èŠ‚æ•°æ®ï¼Œä»æœ€é«˜ä½ï¼ˆMSBï¼‰å¼€å§‹è¾“å‡ºã€‚\n\n#### CRCæ®µï¼ˆ16ä½ï¼‰\n- CRCé¡ºåºï¼š15ä½ï¼Œå¾ªç¯å†—ä½™æ ¡éªŒä¸Šä¸€ä¸ªä¼ è¾“çš„æ•°æ®\n- CRCç•Œå®šç¬¦ï¼š1ä½ï¼Œéšæ€§ç”µå¹³ï¼Œç”¨äºåˆ†å‰²\n\n*CRC é¡ºåºæ˜¯æ ¹æ®å¤šé¡¹å¼ç”Ÿæˆçš„ CRC å€¼ï¼ŒCRC çš„è®¡ç®—èŒƒå›´åŒ…æ‹¬å¸§èµ·å§‹ã€ä»²è£æ®µã€æ§åˆ¶æ®µã€æ•°æ®æ®µã€‚æ¥æ”¶æ–¹ä»¥åŒæ ·çš„ç®—æ³•è®¡ç®— CRC å€¼å¹¶è¿›è¡Œæ¯”è¾ƒï¼Œä¸ä¸€è‡´æ—¶ä¼šé€šæŠ¥é”™è¯¯ã€‚*\n\n#### ACKæ®µï¼ˆ2ä½ï¼‰\n- ACKæ§½ï¼ˆACK Slotï¼‰ï¼š1ä½\n- ACKç•Œå®šç¬¦ï¼š1ä½ï¼Œéšæ€§ç”µå¹³\n\n*æ³¨æ„*ï¼šå¯¹äºACK Slotï¼Œå…¶å·¥ä½œæ–¹å¼ä¸ºï¼š\n- å¯¹äºå‘é€å•å…ƒï¼šå‘é€å•å…ƒåœ¨ACK Slotå‘é€1ä¸ªéšæ€§ä½\n- å¯¹äºæ¥æ”¶å•å…ƒï¼šæ¥æ”¶åˆ°æ­£ç¡®ä¿¡æ¯çš„å•å…ƒåœ¨ACK Slotå‘é€æ˜¾æ€§ä½ï¼Œé€šçŸ¥å‘é€å•å…ƒæ­£å¸¸æ¥æ”¶ç»“æŸã€‚è¯¥åŠ¨ä½œç§°ä½œâ€œå‘é€ ACKâ€æˆ–è€…â€œè¿”å› ACKâ€ã€‚\n\n#### å¸§ç»“æŸï¼ˆ7ä½ï¼‰\nè¡¨ç¤ºå¸§ç»“æŸï¼Œç”±7ä¸ªéšæ€§ä½æ„æˆã€‚\n\n\n### é”™è¯¯å¸§\n*WIP*\n\n## ä½æ—¶åº\nç”±å‘é€å•å…ƒåœ¨éåŒæ­¥çš„æƒ…å†µä¸‹å‘é€çš„æ¯ç§’é’Ÿçš„ä½æ•°ç§°ä¸ºä½é€Ÿç‡ã€‚ä¸€ä¸ªä½å¯åˆ†ä¸º4æ®µï¼š\n- åŒæ­¥æ®µï¼ˆSSï¼‰\n- ä¼ æ’­æ—¶é—´æ®µï¼ˆPTSï¼‰\n- ç›¸ä½ç¼“å†²æ®µ1ï¼ˆPBS1ï¼‰\n- ç›¸ä½ç¼“å†²æ®µ2ï¼ˆPBS2ï¼‰\nè¿™äº›æ®µåˆç”±å¯ç§°ä¸º Time Quantumï¼ˆä»¥ä¸‹ç§°ä¸º Tqï¼‰çš„æœ€å°æ—¶é—´å•ä½æ„æˆã€‚\n\n1ä½åˆ†ä¸º4ä¸ªæ®µï¼Œæ¯ä¸ªæ®µåˆç”±è‹¥å¹²ä¸ªTqæ„æˆï¼Œè¿™ç§°ä¸ºä½æ—¶åºã€‚\n\n1ä½ç”±å¤šå°‘ä¸ªTqæ„æˆã€æ¯ä¸ªæ®µåˆç”±å¤šå°‘ä¸ªTqæ„æˆç­‰ï¼Œå¯ä»¥ä»»æ„è®¾å®šä½æ—¶åºã€‚é€šè¿‡è®¾å®šä½æ—¶åºï¼Œå¤šä¸ªå•å…ƒå¯åŒæ—¶é‡‡æ ·ï¼Œä¹Ÿå¯ä»»æ„è®¾å®šé‡‡æ ·ç‚¹ã€‚\n\n![æ®µåŠå…¶ä½œç”¨](/images/arm/can5.png)\n\n![1ä¸ªä½çš„æ„æˆ](/images/arm/CAN6.png)\nå›¾ä¸­çš„é‡‡æ ·ç‚¹æ˜¯æŒ‡è¯»å–æ€»çº¿ç”µå¹³å¹¶å°†å…¶ä½œä¸ºä½å€¼çš„ç‚¹ï¼Œä½äºPBS1ç»“æŸå¤„ã€‚\n\n## ä»²è£\nCANæœ¬è´¨æ˜¯åŠåŒå·¥é€šä¿¡ï¼Œå› ä¸ºæ€»çº¿ä¸ŠåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªä¿¡å·ä¼ è¾“ï¼ŒIDä¼˜å…ˆçº§ä¸å¤Ÿçš„ä¿¡å·ä¼šåœ¨ä»²è£æ—¶å¤±å»å‘é€æƒã€‚å…·ä½“ä¸ºï¼š\n- è‹¥æ€»çº¿ç©ºé—²ï¼šæœ€å…ˆå¼€å§‹å‘é€æ¶ˆæ¯çš„å•å…ƒå–å¾—å‘é€æƒ\n- è‹¥å¤šä¸ªå•å…ƒåŒæ—¶å‘é€ï¼šå„å‘é€å•å…ƒä»ä»²è£æ®µçš„ç¬¬ä¸€ä½å¼€å§‹è¿›è¡Œä»²è£ï¼Œè¿ç»­è¾“å‡ºæ˜¾æ€§ç”µå¹³ï¼ˆé€»è¾‘0ï¼‰æœ€å¤šçš„å•å…ƒå¯ç»§ç»­å‘é€\n\n![CANæ€»çº¿ä»²è£è¿‡ç¨‹](/images/arm/CAN7.png)\n\n## STM32F4çš„CANæ§åˆ¶å™¨\n### åŸºæœ¬ä¿¡æ¯ä¸æ ‡è¯†ç¬¦æ»¤æ³¢å™¨\nSTM32F4è‡ªå¸¦çš„æ˜¯bxCANï¼Œå³åŸºæœ¬æ‰©å±•CANï¼Œå…¶æ”¯æŒCANåè®®2.0Aå’Œ2.0Bã€‚CAN2.0Aåªèƒ½å¤„ç†æ ‡å‡†æ•°æ®å¸§ï¼Œæ‰©å±•å¸§çš„å†…å®¹ä¼šè¯†åˆ«é”™è¯¯ï¼›è€ŒCAN2.0B Activeå¯ä»¥å¤„ç†æ ‡å‡†æ•°æ®å¸§å’Œæ‰©å±•æ•°æ®å¸§ï¼›CAN2.0B Passiveåªèƒ½å¤„ç†æ ‡å‡†æ•°æ®å¸§ï¼Œå¿½ç•¥æ‰©å±•å¸§ã€‚\n\nF429è‡ªå¸¦ä¸¤ä¸ªCANæ§åˆ¶å™¨ï¼šCAN1å’ŒCAN2.ä¸¤ä¸ªCANåˆ†åˆ«æ‹¥æœ‰è‡ªå·±çš„å‘é€é‚®ç®±å’Œæ¥æ”¶FIFOï¼Œä½†äºŒè€…å…±ç”¨28ä¸ªæ»¤æ³¢å™¨ï¼Œå…¶åˆ†é…æ–¹å¼é€šè¿‡`CAN_FMR`å¯„å­˜å™¨è®¾ç½®ã€‚æ»¤æ³¢å™¨ç”¨äºé€‰æ‹©æ€§æ¥æ”¶ç¬¦åˆç‰¹å®šæ¡ä»¶çš„ CAN æ¶ˆæ¯ï¼Œé€šè¿‡å¯¹ CAN æŠ¥æ–‡çš„æ ‡è¯†ç¬¦ï¼ˆIDï¼‰è¿›è¡Œç­›é€‰ï¼Œåªæ¥æ”¶æ»¡è¶³æ¡ä»¶çš„æŠ¥æ–‡ï¼Œå°†ä¸ç›¸å…³çš„æŠ¥æ–‡ä¸¢å¼ƒã€‚è¿™å¯ä»¥é¿å… MCU å¯¹æ‰€æœ‰æ¥æ”¶åˆ°çš„ CAN æŠ¥æ–‡è¿›è¡Œå¤„ç†ï¼Œä»è€Œæå‡ç³»ç»Ÿæ•ˆç‡ã€‚\n\næ»¤æ³¢å™¨æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š\n- **æ ‡è¯†ç¬¦æ©ç æ¨¡å¼ï¼ˆIdentifier Mask Modeï¼‰ï¼š**\n  - é€šè¿‡æ©ç å®šä¹‰å“ªäº›ä½éœ€è¦åŒ¹é…ã€‚\n  - çµæ´»æ€§é«˜ï¼Œé€‚åˆå¤„ç†æŸäº›ä½é€šé…çš„åœºæ™¯ã€‚\n  - æ©ç ä¸­çš„æ¯ä¸€ä½å¯ä»¥è®¾ç½®ä¸ºï¼š\n    - **\"0\"ï¼š** å¿½ç•¥å¯¹åº”ä½ã€‚\n    - **\"1\"ï¼š** åŒ¹é…å¯¹åº”ä½ã€‚\n  - ä¾‹ï¼šç›®æ ‡åªæ¥æ”¶ä»¥`0x2A`ï¼ˆ`101010`ï¼‰ä¸ºå‰å…­ä½çš„æ ‡è¯†ç¬¦ï¼Œåˆ™é…ç½®è¿‡æ»¤å™¨çš„æ ‡è¯†ç¬¦ä¸º`0x2A0`ï¼ˆ`10101000000`ï¼‰ï¼Œæ©ç ä¸º`0xFC0`ï¼ˆ`11111100000`ï¼‰ï¼Œæ¥æ”¶åˆ°çš„IDä¸æ©ç è¿›è¡ŒæŒ‰ä½æ¯”è¾ƒï¼ŒåªåŒ¹é…æ©ç ä¸º1çš„ä½ã€‚\n\n- **æ ‡è¯†ç¬¦åˆ—è¡¨æ¨¡å¼ï¼ˆIdentifier List Modeï¼‰ï¼š**\n  - ç›´æ¥æŒ‡å®šä¸€ç»„æ ‡è¯†ç¬¦ï¼Œåªæœ‰åŒ¹é…è¿™äº›æ ‡è¯†ç¬¦çš„æ¶ˆæ¯æ‰ä¼šé€šè¿‡ã€‚\n  - é€‚åˆæ˜ç¡®çš„æ ‡è¯†ç¬¦åŒ¹é…ã€‚\n  - ä¾‹ï¼šæŒ‡å®š`0x1A5`ä¸ºæœŸæœ›æ ‡è¯†ç¬¦ï¼Œåˆ™åªæœ‰æ¥æ”¶åˆ°çš„IDç­‰äº`0x1A5`æ—¶è¯¥æ¶ˆæ¯æ‰ä¼šè¢«å…è®¸é€šè¿‡ã€‚\n\n### å‘é€\nCAN æ§åˆ¶å™¨æœ‰ 3 ä¸ªå‘é€é‚®ç®±ï¼ˆTx Mailboxï¼‰ï¼Œç”¨äºå­˜å‚¨å¾…å‘é€çš„æ¶ˆæ¯ã€‚å‘é€æ—¶ï¼Œå°†æ¶ˆæ¯å†™å…¥ç©ºé—²é‚®ç®±ï¼Œç„¶åç¡¬ä»¶æ ¹æ®ä»²è£æœºåˆ¶å°†æ¶ˆæ¯å‘é€åˆ°æ€»çº¿ä¸Šã€‚ä»²è£å¤±è´¥çš„æ¶ˆæ¯ä¼šè¢«é‡æ–°åŠ å…¥å‘é€é˜Ÿåˆ—ï¼Œç›´åˆ°æˆåŠŸå‘é€ã€‚\n\n![CANé€šè¿‡é‚®ç®±å‘é€](/images/arm/CAN8.png)\n\næ­£å¸¸å‘é€æµç¨‹ä¸ºï¼š\n1. é…ç½®CANå‘é€å¸§ï¼ŒåŒ…æ‹¬ï¼š\n        - æ¶ˆæ¯çš„æ ‡è¯†ç¬¦ï¼ˆ11ä½æˆ–29ä½ï¼‰\n        - å¸§ç±»å‹ï¼ˆæ•°æ®å¸§æˆ–è¿œç¨‹å¸§ï¼‰\n        - å¡«å……å¾…å‘é€æ•°æ®\n        - å£°æ˜å¾…å‘é€æ•°æ®é•¿åº¦\n2. æ£€æŸ¥é‚®ç®±çŠ¶æ€\n        - ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå‘é€é‚®ç®±ç©ºé—²ï¼ˆ`TME=1`ï¼‰\n3. é‚®ç®±è¯·æ±‚å‘é€\n        - è®¾ç½®CAN_TIxRçš„TXRQä½ä¸º`1`\n4. é‚®ç®±æŒ‚å·\n        - `RQCP=0`,`TXOK=0`,`TME=0`\n        - ç­‰å¾…æˆä¸ºæœ€é«˜ä¼˜å…ˆçº§\n5. é¢„å®šå‘é€\n        - å·²æˆä¸ºæœ€é«˜ä¼˜å…ˆçº§\n        - ç­‰å¾…CANæ€»çº¿ç©ºé—²\n6. å‘é€\n7. å‘é€æˆåŠŸ\n        - `RQCP=1`,`TXOK=1`,`TME=1`\n        - å›åˆ°é‚®ç®±ç©ºé—²çŠ¶æ€\n7. å‘é€å¤±è´¥\n        - `RQCP=1`,`TXOK=0`,`TME=1`\n        - å›åˆ°é‚®ç®±ç©ºé—²çŠ¶æ€\n\n### æ¥æ”¶\nCANæ¥æ”¶åˆ°çš„æœ‰æ•ˆæŠ¥æ–‡ï¼Œè¢«å­˜å‚¨åœ¨3çº§é‚®ç®±æ·±åº¦çš„FIFOä¸­ã€‚FIFOå®Œå…¨ç”±ç¡¬ä»¶æ¥ç®¡ç†ï¼Œä»è€ŒèŠ‚çœäº† CPU çš„å¤„ç†è´Ÿè·ï¼Œç®€åŒ–äº†è½¯ä»¶å¹¶ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚åº”ç”¨ç¨‹åºåªèƒ½é€šè¿‡è¯»å–FIFOè¾“å‡ºé‚®ç®±ï¼Œæ¥è¯»å– FIFO ä¸­æœ€å…ˆæ”¶åˆ°çš„æŠ¥æ–‡ã€‚\n\nCANçš„æ¥æ”¶æœ‰2ä¸ªFIFOï¼Œæˆ‘ä»¬æ¯ä¸ªæ»¤æ³¢å™¨ç»„éƒ½å¯ä»¥è®¾ç½®å…¶å…³è”çš„ FIFOï¼Œé€šè¿‡ `CAN_FFA1R` çš„è®¾ç½®ï¼Œå¯ä»¥å°†æ»¤æ³¢å™¨ç»„å…³è”åˆ°FIFOO/FIFO1.\n\n*æœ‰æ•ˆæŠ¥æ–‡ï¼šæŒ‡é‚£äº›æ­£ç¡®è¢«æ¥æ”¶çš„ï¼ˆç›´åˆ°EOFéƒ½æ²¡æœ‰é”™è¯¯ï¼‰ä¸”é€šè¿‡äº†æ ‡è¯†ç¬¦è¿‡æ»¤çš„æŠ¥æ–‡ã€‚*\n\n![CANé€šè¿‡FIFOæ¥æ”¶](/images/arm/CAN9.png)\n\nFIFOæ¥æ”¶åˆ°çš„æŠ¥æ–‡æ•°å¯ä»¥é€šè¿‡æŸ¥è¯¢`CAN_RFxR`çš„FMPå¯„å­˜å™¨å¾—åˆ°ã€‚\n\n*æ³¨æ„*ï¼šå¿…é¡»åœ¨FIFOæº¢å‡ºä¹‹å‰è¯»å‡ºè‡³å°‘1ä¸ªæŠ¥æ–‡ï¼Œå¦åˆ™ä¸‹ä¸ªæŠ¥æ–‡åˆ°æ¥æ—¶FIFOå°†æº¢å‡ºï¼Œå¯¼è‡´æœ€æ—©æ”¶åˆ°çš„æŠ¥æ–‡ä¸¢å¤±ã€‚æ¯è¯»å‡º1ä¸ªæŠ¥æ–‡ï¼Œç›¸åº”çš„æŒ‚å·å°±å‡1ï¼Œç›´åˆ°FIFOä¸ºç©ºã€‚\n\n### ä½æ—¶é—´ç‰¹æ€§\nä¸åŒäºåŸæœ¬çš„CANåè®®ï¼ŒSTM32æŠŠä¼ æ’­æ—¶é—´æ®µï¼ˆPTSï¼‰å’Œç›¸ä½ç¼“å†²æ®µï¼ˆPBS1ï¼‰åˆå¹¶ï¼Œæ‰€ä»¥STM32çš„CANä¸€ä¸ªä½åªæœ‰3æ®µï¼š\n- åŒæ­¥æ®µï¼ˆSYNC_SEGï¼‰\n- æ—¶é—´æ®µ1ï¼ˆBS1ï¼‰\n- æ—¶é—´æ®µ2ï¼ˆBS2ï¼‰\n\n![STM32ä¸­çš„CANä½æ—¶åº](/images/arm/CAN10.png)\n\nå›¾ä¸­ç»™å‡ºäº†CANæ³¢ç‰¹ç‡çš„è®¡ç®—å…¬å¼ï¼Œåªéœ€è¦çŸ¥é“CAN_BTRä¸­BRPã€TS1å’ŒTS2çš„è®¾ç½®å°±å¯ä»¥è®¡ç®—ã€‚\n\n### å¯„å­˜å™¨\n*WIP*","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"STM32ä¸­çš„SPI","url":"/2024/12/17/STM32ä¸­çš„SPI/","content":"## SPIç®€ä»‹\n### æ¥å£ã€å·¥ä½œåŸç†ä¸ä¼ è¾“æ–¹å¼\nSPIæ¥å£å…±æœ‰å››ä¸ªPin:\n- MISOï¼ˆMaster In / Slave Outï¼‰ä¸»è®¾å¤‡æ•°æ®è¾“å…¥ï¼Œä»è®¾å¤‡æ•°æ®è¾“å‡ºã€‚\n- MOSIï¼ˆMaster Out / Slave Inï¼‰ä¸»è®¾å¤‡æ•°æ®è¾“å‡ºï¼Œä»è®¾å¤‡æ•°æ®è¾“å…¥ã€‚\n- SCLKï¼ˆSerial Clockï¼‰æ—¶é’Ÿä¿¡å·ï¼Œç”±ä¸»è®¾å¤‡äº§ç”Ÿã€‚\n- CSï¼ˆChip Selectï¼‰ä»è®¾å¤‡ç‰‡é€‰ä¿¡å·ï¼Œç”±ä¸»è®¾å¤‡äº§ç”Ÿã€‚\n\nSPIçš„å·¥ä½œåŸç†ï¼šåœ¨ä¸»æœºå’Œä»æœºéƒ½æœ‰ä¸€ä¸ªä¸²è¡Œç§»ä½å¯„å­˜å™¨ï¼Œä¸»æœºé€šè¿‡å‘å®ƒçš„ SPI ä¸²è¡Œå¯„å­˜å™¨å†™å…¥ä¸€ä¸ªå­—èŠ‚æ¥å‘èµ·ä¸€æ¬¡ä¼ è¾“ã€‚ä¸²è¡Œç§»ä½å¯„å­˜å™¨é€šè¿‡ MOSI ä¿¡å·çº¿å°†å­—èŠ‚ä¼ é€ç»™ä»æœºï¼Œä»æœºä¹Ÿå°†è‡ªå·±çš„ä¸²è¡Œç§»ä½å¯„å­˜å™¨ä¸­çš„å†…å®¹é€šè¿‡ MISO ä¿¡å·çº¿è¿”å›ç»™ä¸»æœºã€‚è¿™æ ·ï¼Œä¸¤ä¸ªç§»ä½å¯„å­˜å™¨ä¸­\nçš„å†…å®¹å°±è¢«äº¤æ¢ã€‚å¤–è®¾çš„å†™æ“ä½œå’Œè¯»æ“ä½œæ˜¯åŒæ­¥å®Œæˆçš„ã€‚å¦‚æœåªæ˜¯è¿›è¡Œå†™æ“ä½œï¼Œä¸»æœºåªéœ€å¿½ç•¥æ¥æ”¶åˆ°çš„å­—èŠ‚ã€‚åä¹‹ï¼Œè‹¥ä¸»æœºè¦è¯»å–ä»æœºçš„ä¸€ä¸ªå­—èŠ‚ï¼Œå°±å¿…é¡»å‘é€ä¸€ä¸ªç©ºå­—èŠ‚å¼•å‘ä»æœºä¼ è¾“ã€‚\n\nSPIçš„ä¼ è¾“æ–¹å¼ï¼š\n- å…¨åŒå·¥ï¼šä»»ä½•æ—¶åˆ»ï¼Œä¸»æœºä¸ä»æœºä¹‹é—´éƒ½å¯ä»¥åŒæ—¶è¿›è¡Œæ•°æ®çš„å‘é€å’Œæ¥æ”¶\n- å•å·¥ï¼šæ•°æ®ä¼ è¾“æ˜¯å›ºå®šå•å‘çš„\n- åŠåŒå·¥ï¼šå…è®¸æ•°æ®åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¼ è¾“ï¼Œä½†åŒä¸€æ—¶åˆ»åªèƒ½ä¼ è¾“ä¸€ä¸ªæ–¹å‘çš„æ•°æ®ï¼ˆå¦‚IICï¼‰\n\nSPIä¾æ®CPOLå’ŒCPHAçš„ä¸åŒçŠ¶æ€åˆ†æˆäº†4ç§æ¨¡å¼ã€‚å…¶ä¸­CPOLå’ŒCPHAåˆ†åˆ«æ˜¯ï¼š\n- CPOLï¼ˆClock Polarityï¼Œæ—¶é’Ÿææ€§ï¼‰ï¼šå®šä¹‰ä¸ºä¸»ä»æœºæ²¡æœ‰æ•°æ®ä¼ è¾“æ—¶ï¼ŒSCLçº¿çš„ç”µå¹³çŠ¶æ€ã€‚å‡å¦‚ç©ºé—²çŠ¶æ€ä¸‹SCLçº¿ä¸ºé«˜ç”µå¹³ï¼Œåˆ™`COPL=1`ï¼›è‹¥ä¸ºä½ç”µå¹³ï¼Œåˆ™`COPL=0`\n- CPHAï¼ˆClock Phaseï¼Œæ—¶é’Ÿç›¸ä½ï¼‰ï¼šæ•°æ®é‡‡æ ·æ—¶åˆ»ï¼Œå³åœ¨æ—¶é’Ÿä¿¡å·çš„å“ªä¸ªè¾¹æ²¿ä¸Šæ•°æ®è¢«ä¼ è¾“æˆ–é‡‡æ ·ã€‚è‹¥`CPHA=0`ï¼Œåˆ™æ•°æ®åœ¨æ—¶é’Ÿçš„ç¬¬ä¸€ä¸ªè¾¹æ²¿ï¼ˆå³æ—¶é’Ÿä¿¡å·çš„ä¸Šå‡æ²¿æˆ–ä¸‹é™æ²¿ï¼‰é‡‡æ ·ï¼Œæ•°æ®åœ¨ç¬¬äºŒä¸ªè¾¹æ²¿ï¼ˆå¦ä¸€ä¸ªç›¸åçš„è¾¹æ²¿ï¼‰è¢«ä¼ è¾“ï¼›è‹¥`CPHA=1`ï¼Œåˆ™æ•°æ®åœ¨æ—¶é’Ÿçš„ç¬¬äºŒä¸ªè¾¹æ²¿ï¼ˆä¸CPHA = 0æ—¶ä¸åŒï¼‰é‡‡æ ·ï¼Œæ•°æ®åœ¨ç¬¬ä¸€ä¸ªè¾¹æ²¿ä¼ è¾“ã€‚\n\næŒ‰ç…§CPOLå’ŒCPHAçš„ä¸åŒï¼ŒSPIçš„å››ç§æ¨¡å¼åˆ†åˆ«ä¸ºï¼š\n\n| SPIå·¥ä½œæ¨¡å¼ | CPOL | CPHA | SCLç©ºé—²çŠ¶æ€ | é‡‡æ ·è¾¹æ²¿ | é‡‡æ ·æ—¶åˆ» |\n|---------|------|------|---------|------|------|\n| 0       | 0    | 0    | LOW     | ä¸Šå‡æ²¿  | å¥‡æ•°è¾¹æ²¿ | \n| 1       | 0    | 1    | LOW     | ä¸‹é™æ²¿  | å¶æ•°è¾¹æ²¿ | \n| 2       | 1    | 0    | HIGH    | ä¸‹é™æ²¿  | å¥‡æ•°è¾¹æ²¿ |  \n| 3       | 1    | 1    | HIGH    | ä¸Šå‡æ²¿  | å¶æ•°è¾¹æ²¿ | \n\nå®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸ä½¿ç”¨**æ¨¡å¼0**å’Œ**æ¨¡å¼3**ï¼Œå³éƒ½åœ¨å¥‡æ•°è¾¹æ²¿é‡‡æ ·ã€‚\n\n### SPIå¯„å­˜å™¨\nSPIé€šå¸¸éœ€è¦ç”¨åˆ°ä»¥ä¸‹16ä½å¯„å­˜å™¨ï¼š\n- SPIæ§åˆ¶å¯„å­˜å™¨ï¼ˆSPI_CR1ï¼‰ï¼šæ§åˆ¶ä¸»è®¾å¤‡æ¨¡å¼é€‰æ‹©ï¼Œä¼ è¾“æ–¹å‘ï¼Œæ•°æ®æ ¼å¼ï¼Œæ—¶é’Ÿææ€§ã€æ—¶é’Ÿç›¸ä½å’Œä½¿èƒ½ç­‰ã€‚\n- SPIçŠ¶æ€å¯„å­˜å™¨ï¼ˆSPI_SRï¼‰ï¼šç”¨äºæŸ¥è¯¢SPIå½“å‰çŠ¶æ€\n- SPIæ•°æ®å¯„å­˜å™¨ï¼ˆSPI_DRï¼‰ï¼šåŒå¯„å­˜å™¨ï¼ŒåŒ…å«å‘é€ç¼“å­˜ä¸æ¥æ”¶ç¼“å­˜\n\n## NOR Flash ï¼ˆW25Q256ï¼‰\n### ç®€ä»‹\nNOR Flash æ˜¯ä¸€ç§éæ˜“å¤±æ€§å­˜å‚¨å™¨ï¼Œå¹¿æ³›åº”ç”¨äºåµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å¿«é€Ÿè¯»å–æ•°æ®çš„åœºæ™¯ã€‚å®ƒä¸ NAND Flash çš„ä¸»è¦åŒºåˆ«åœ¨äºå­˜å‚¨å•å…ƒçš„ç»“æ„å’Œè¯»å†™æ€§èƒ½ã€‚NOR Flash ä½¿ç”¨å¹¶è¡Œçš„åœ°å€å’Œæ•°æ®æ€»çº¿ï¼Œå…¶å­˜å‚¨å•å…ƒæ˜¯åŸºäº NOR é—¨ï¼ˆä¸€ä¸ªé€»è¾‘é—¨ï¼‰ã€‚è¿™ç§ç»“æ„ä½¿å¾—å®ƒèƒ½å¤ŸæŒ‰å­—èŠ‚ï¼ˆByteï¼‰ç›´æ¥è¯»å–æ•°æ®ã€‚ç”±äº NOR Flash æ”¯æŒæŒ‰å­—èŠ‚éšæœºè®¿é—®ï¼Œå› æ­¤åœ¨è¯»å–é€Ÿåº¦ä¸Šä¼˜äº NAND Flashã€‚å®ƒé€‚åˆäºå­˜å‚¨å›ºä»¶ã€ä»£ç ç­‰ç»å¸¸è¯»å–çš„åº”ç”¨ã€‚å…¶å†™å…¥æ“ä½œè¾ƒæ…¢ï¼Œé€šå¸¸éœ€è¦å…ˆå°†æ•´ä¸ªå—ï¼ˆblockï¼‰æ“¦é™¤åæ‰èƒ½è¿›è¡Œå†™å…¥ã€‚æ¯ä¸ªå•å…ƒçš„æ“¦å†™æ¬¡æ•°æœ‰é™ï¼Œé€šå¸¸ä¸ºæ•°ä¸‡åˆ°æ•°åä¸‡æ¬¡ï¼Œå› æ­¤åœ¨éœ€è¦é¢‘ç¹å†™å…¥çš„åœºæ™¯ä¸­ï¼ŒNOR Flash çš„è€ç”¨æ€§è¾ƒå·®ã€‚NOR Flash ä¸»è¦åº”ç”¨äºåµŒå…¥å¼ç³»ç»Ÿï¼Œå¦‚å­˜å‚¨å¼•å¯¼ç¨‹åºã€å›ºä»¶ï¼ˆBIOSï¼‰ç­‰ã€‚å®ƒä¹Ÿå¹¿æ³›åº”ç”¨äºæ±½è½¦ã€æ™ºèƒ½è®¾å¤‡ã€æ¶ˆè´¹ç”µå­ç­‰é¢†åŸŸï¼Œç”¨ä½œå­˜å‚¨å¯åŠ¨ä»£ç ã€é…ç½®æ•°æ®ç­‰ã€‚å¯¹äºä½åŠŸè€—è®¾å¤‡ï¼ŒNOR Flash é€‚åˆç”¨äºç”µæ± ä¾›ç”µä¸”ä¸é¢‘ç¹å†™å…¥çš„åº”ç”¨ã€‚æ€»çš„æ¥è¯´ï¼ŒNOR Flash ä¸»è¦ä¼˜åŠ¿æ˜¯å…¶å¿«é€Ÿçš„è¯»å–èƒ½åŠ›ï¼Œé€‚åˆå­˜å‚¨ä»£ç å’Œé…ç½®ç­‰ç»å¸¸è¯»å–çš„å†…å®¹ï¼Œè€Œå†™å…¥å’Œæ“¦é™¤æ“ä½œè¾ƒä¸ºç¼“æ…¢ã€‚\n\nNORä¸NANDåœ¨æ•°æ®å†™å…¥å‰éƒ½éœ€è¦æœ‰**æ“¦é™¤**æ“ä½œã€‚\n\nNM25Q128 æ”¯æŒæ ‡å‡†çš„ SPIï¼Œè¿˜æ”¯æŒåŒè¾“å‡º/å››è¾“å‡ºçš„ SPIï¼Œæœ€å¤§ SPI æ—¶é’Ÿå¯ä»¥åˆ° 104Mhzï¼ˆåŒè¾“å‡ºæ—¶ç›¸å½“äº 208Mhzï¼Œå››è¾“å‡ºæ—¶ç›¸å½“äº 416Mï¼‰ã€‚\n\n![W25Q256 ICå¼•è„š](/images/arm/spi1.png)\n\n- CSï¼šç‰‡é€‰å¼•è„šï¼Œä½ç”µå¹³æœ‰æ•ˆ\n- DOï¼šMISOå¼•è„š\n- WPï¼šå†™ä¿æŠ¤å¼•è„šã€‚é«˜ç”µå¹³æ—¶å¯è¯»å¯å†™ï¼Œä½ç”µå¹³æ—¶åªè¯»\n- DIï¼šMOSIå¼•è„š\n- CLKï¼šä¸²è¡Œæ—¶é’Ÿå¼•è„š\n- HOLDï¼šä¿æŒå¼•è„šï¼Œä½ç”µå¹³æœ‰æ•ˆ\n\nå¯¹äºW25Q256çš„å­˜å‚¨æ¶æ„è€Œè¨€ï¼Œä»å¤§åˆ°å°å¯ä»¥åˆ†ä¸ºè¿™ä¹ˆå‡ çº§ï¼š\n- 256ä¸ªå—ï¼ˆBlockï¼‰ï¼Œæ¯ä¸ª64Kå­—èŠ‚\n    + æ¯ä¸ªå—åˆ†ä¸º16ä¸ªæ‰‡åŒºï¼ˆSectorï¼‰ï¼Œæ¯ä¸ª4Kå­—èŠ‚\n        - æ¯ä¸ªæ‰‡åŒºåˆ†ä¸º16ä¸ªé¡µï¼ˆPageï¼‰ï¼Œæ¯ä¸ª256å­—èŠ‚\n\nW25Q256çš„æœ€å°æ“¦é™¤å•ä½ä¸ºä¸€ä¸ªæ‰‡åŒºï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å¿…é¡»æ“¦é™¤4Kä¸ªå­—èŠ‚ã€‚è¿™æ ·æˆ‘ä»¬éœ€è¦ç»™W25Q256å¼€è¾Ÿä¸€ä¸ªè‡³å°‘4Kå­—èŠ‚çš„ç¼“å­˜åŒºï¼Œè¿™æ ·å¯¹SRAMè¦æ±‚æ¯”è¾ƒé«˜ï¼Œè¦æ±‚èŠ¯ç‰‡å¿…é¡»æœ‰4Kä»¥ä¸Šçš„SRAMæ‰èƒ½å¾ˆå¥½çš„æ“ä½œã€‚\n\n### çŠ¶æ€å¯„å­˜å™¨ï¼ˆStatus Registerï¼‰\nW25Q256æ‹¥æœ‰3ä¸ªçŠ¶æ€å¯„å­˜å™¨ï¼Œåˆ†åˆ«ä¸ºSR1ï¼ŒSR2å’ŒSR3.å…·ä½“ä½œç”¨å¯å‚è§æ‰‹å†Œ7.1èŠ‚ã€‚ä¸‹é¢æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€äº›å¯„å­˜å™¨ä½ï¼š\n![SR1](/images/arm/spi5.png)\n- S0ï¼šBUSYä½ï¼Œåªè¯»ã€‚ç½®1è¡¨ç¤ºè®¾å¤‡å¿™ï¼ˆæœ‰æ“ä½œæ­£åœ¨è¿›è¡Œï¼‰ï¼Œç½®0è¡¨ç¤ºè®¾å¤‡ç©ºé—²ï¼Œå‡†å¤‡å¥½æ¥æ”¶å…¶ä»–æŒ‡ä»¤ã€‚\n- S1ï¼šå†™ä½¿èƒ½é”å­˜å™¨ï¼ˆWELï¼‰ï¼Œåªè¯»ã€‚ç½®1è¡¨ç¤ºå†™ä½¿èƒ½ï¼Œç½®0è¡¨ç¤ºå†™ç¦ç”¨ã€‚\n\n![SR3](/images/arm/spi6.png)\n- S17ï¼šADPä½ã€‚ç½®0æ—¶ï¼Œè®¾å¤‡å¯åŠ¨å°†ä¼šå¼•å¯¼è‡³3å­—èŠ‚åœ°å€æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸‹è‹¥è¦è®¿é—®128Mbä»¥å¤–çš„flashåˆ™å¿…é¡»å¯ç”¨é™„åŠ åœ°å€å¯„å­˜å™¨ï¼ˆExtended Addr Regï¼‰ï¼›ç½®1æ—¶ï¼Œè®¾å¤‡å¯åŠ¨å¼•å¯¼è‡³4å­—èŠ‚åœ°å€æ¨¡å¼ã€‚\n\n### æŒ‡ä»¤ä¸å·¥ä½œæ—¶åº\n#### å†™ä½¿èƒ½ï¼ˆWrite Enableï¼‰- 06H\nå†™ä½¿èƒ½æŒ‡ä»¤ç”¨äºå°†SR1çš„WELä½ç½®1.è¯¥æŒ‡ä»¤å¿…é¡»åœ¨æ‰€æœ‰é¡µæ“ä½œï¼ˆPage Programï¼‰ã€æ‰‡åŒºæ“¦é™¤ã€å—æ“¦é™¤ã€èŠ¯ç‰‡æ“¦é™¤å’Œå†™å…¥çŠ¶æ€å¯„å­˜å™¨æ“ä½œå‰è°ƒç”¨ã€‚\n\n![å†™ä½¿èƒ½æŒ‡ä»¤æ—¶åº](/images/arm/spi6.png)\n\n```\n /**\n* @brief IC å†™ä½¿èƒ½ Write Enable\n* @param NULL\n* @retval NULL\n*/\nvoid w25q256_write_enable(void)\n{\n    NORFLASH_CS(0);     \n\n    uint8_t code = 0x06;\n    HAL_SPI_Transmit(&hspi5, (uint8_t *)&code, 1, 1000);\n\n    NORFLASH_CS(1);\n}\n```\n\n#### å†™ç¦ç”¨ï¼ˆWrite Disableï¼‰ - 04H\nè¯¥æŒ‡ä»¤ä¼šå°†SR1-WELç½®0.ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒWELä½ä¼šåœ¨æ‰€æœ‰é¡µæ“ä½œï¼ˆPage Programï¼‰ã€æ‰‡åŒºæ“¦é™¤ã€å—æ“¦é™¤ã€èŠ¯ç‰‡æ“¦é™¤ã€å†™å…¥çŠ¶æ€å¯„å­˜å™¨æ“ä½œå’ŒICå¤ä½åè‡ªåŠ¨ç½®ä¸º0.\n```\n /**\n* @brief IC å…³é—­å†™ä½¿èƒ½ Write Disable\n* @param NULL\n* @retval NULL\n*/\nvoid w25q256_write_disable(void)\n{\n    NORFLASH_CS(0);\n\n    uint8_t code = 0x04;\n    HAL_SPI_Transmit(&hspi5, (uint8_t *)&code, 1, 1000);\n\n    NORFLASH_CS(1);\n}\n```\n\n#### è¯»å–çŠ¶æ€å¯„å­˜å™¨ - 05H/35H/15H\nè¯¥æŒ‡ä»¤ç”¨äºè¯»å–çŠ¶æ€å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œ`05H`ç”¨äºè¯»å–SR1ï¼Œ`35H`è¯»å–SR2ï¼Œ`15H`è¯»å–SR3.è¯¥æŒ‡ä»¤å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¢«è°ƒç”¨ï¼Œé€šè¿‡ä½æ“ä½œç”¨äºç¡®è®¤BUSYä½æ˜¯å¦ä¸º0ï¼ˆ`&0x01`ï¼‰ï¼Œä»¥ç¡®è®¤ICæ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶å¦ä¸€æ¡æŒ‡ä»¤ã€‚\n```\n/**\n* @brief è¯»å–ICçŠ¶æ€å¯„å­˜å™¨ Read Status Register\n * @note        SR-1\n *              BIT7  6   5   4   3   2   1   0\n *              SPR   RV  TB BP2 BP1 BP0 WEL BUSY\n *              SPR:é»˜è®¤ä¸º0ï¼Œä¿æŠ¤ä½ï¼Œé…åˆWPä½¿ç”¨\n *              TB,BP2,BP1,BP0:FLASHåŒºåŸŸå†™ä¿æŠ¤è®¾ç½®\n *              WEL:å†™ä½¿èƒ½é”å®š\n *              BUSY:å¿™æ ‡è®°ä¸ºï¼ˆ1ï¼šå¿™ï¼›0ï¼šç©ºé—²ï¼‰\n *              é»˜è®¤:0x00\n *\n *              SR-2\n *              BIT7  6   5   4   3   2   1   0\n *              SUS   CMP LB3 LB2 LB1 (R) QE  SRP1\n *\n *              SR-3\n *              BIT7      6    5    4   3   2   1   0\n *              HOLD/RST  DRV1 DRV0 (R) (R) WPS ADP ADS\n* @param sr:çŠ¶æ€å¯„å­˜å™¨ç¼–å·\n* @retval rxbyteï¼šæ¥æ”¶åˆ°çš„8ä½å¯„å­˜å™¨å€¼\n*/\nuint8_t w25q256_read_status_reg(uint8_t sr)\n{\n    uint8_t rxbyte, readsr = 0;\n\n    NORFLASH_CS(0);\n\n    switch (sr)\n    {\n        case 1:\n            readsr = 0x05;      /* SR1è¯»æŒ‡ä»¤ */\n            break;\n        \n        case 2:\n            readsr = 0x35;      /* SR2è¯»æŒ‡ä»¤ */\n            break;\n        \n        case 3:\n            readsr = 0x15;      /* SR3è¯»æŒ‡ä»¤ */\n            break;\n    }\n\n    HAL_SPI_Transmit(&hspi5, (uint8_t *)&readsr, sizeof(readsr), 1000);   /* ä¸»æœºå‘é€å¯¹åº”æŒ‡ä»¤ */\n    HAL_SPI_Receive(&hspi5, (uint8_t *)&rxbyte, sizeof(rxbyte), 1000);\n\n    NORFLASH_CS(1);\n\n    return rxbyte;\n}\n```\n```\n/**\n * @brief       ç­‰å¾…ç©ºé—²\n * @param       NULL\n * @retval      NULL\n */\nstatic void norflash_wait_busy(void)\n{\n    while ((w25q256_read_status_reg(1) & 0x01) == 0x01);               /* ç­‰å¾…BUSYä½æ¸…ç©º */\n}\n```\n\n#### è¿›å…¥/é€€å‡º4å­—èŠ‚åœ°å€æ¨¡å¼ - B7H/E9H\n4å­—èŠ‚åœ°å€å¯ç”¨æ—¶ï¼Œå­˜å…¥/è¯»å–æ•°æ®æ—¶å¯»å€åœ°å€ä¸º32ä½è€Œé24ä½ï¼Œå¯ä»¥è®¿é—®128Mbä»¥å¤–çš„Flashã€‚\n```\n/**\n* @brief è¿›å…¥4å­—èŠ‚åœ°å€æ¨¡å¼ Enter 4-Byte Address Mode\n* @note å…è®¸ä½¿ç”¨32ä½åœ°å€ä»¥è®¿é—®128Mbä»¥å¤–åŒºåŸŸ\n* @param NULL\n* @retval NULL\n*/\nvoid w25q256_enter_4byte_mode(void)\n{\n    uint8_t code = 0xB7;\n\n    NORFLASH_CS(0);\n    HAL_SPI_Transmit(&hspi5, &code, 1, 1000);\n    NORFLASH_CS(1);\n}\n```\n```\n /**\n* @brief é€€å‡º4å­—èŠ‚åœ°å€æ¨¡å¼ Exit 4-Byte Address Mode\n* @note é4å­—èŠ‚åœ°å€æ¨¡å¼ä¸‹è¦è®¿é—®128Mbä»¥å¤–åŒºåŸŸéœ€è¦ä½¿ç”¨æ‹“å±•åœ°å€å¯„å­˜å™¨ï¼ˆExtended Addr Regï¼‰\n* @param NULL\n* @retval NULL\n*/\nvoid w25q256_exit_4byte_mode(void)\n{\n    uint8_t code = 0xE9;\n\n    NORFLASH_CS(0);\n    HAL_SPI_Transmit(&hspi5, &code, 1, 1000);\n    NORFLASH_CS(1);\n}\n```\n#### è¯»æ“ä½œï¼ˆ32ä½åœ°å€æ¨¡å¼ï¼‰ - 13H\n![W25Q256 è¯»æ“ä½œï¼ˆ32ä½åœ°å€æ¨¡å¼ï¼‰æ—¶åº](/images/arm/spi2.png)\nè¯»æ“ä½œæ—¶åºåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š\n1. æ‹‰ä½CSç”µå¹³ï¼Œæ¿€æ´»ç‰‡é€‰\n2. MOSIå‘é€13Hï¼Œç„¶åå‘é€å¾…è¯»å–32ä½åœ°å€\n3. ä»æœºåœ¨CLKä¸‹é™æ²¿ä»MISOå‘é€å¯¹åº”åœ°å€çš„æ•°æ®\n4. æ‹‰é«˜CSç”µå¹³ï¼Œä¼ è¾“åœæ­¢\n\n```\n /**\n* @brief è¯»å–æ•°æ®(32ä½åœ°å€æ¨¡å¼) Read Data(4Byte Addr Mode)\n* @note å‚è§datasheet 8.2.10\n* @param pbuf:æ¥æ”¶ç¼“å­˜åŒºåœ°å€ \n* @param addrï¼šç›®æ ‡åœ°å€\n* @param datalenï¼šæ¥æ”¶é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰\n* @retval NULL\n*/\nvoid w25q256_read_data_4byte_mode(uint8_t *pbuf, uint32_t addr, uint16_t datalen)\n{\n    uint8_t read_data_code = 0x13;\n\n    NORFLASH_CS(0);\n    HAL_SPI_Transmit(&hspi5, &read_data_code, 1, 1000);     /* å‘é€32ä½æ¨¡å¼è¯»æŒ‡ä»¤ */\n    HAL_SPI_Transmit(&hspi5, (uint8_t *) &addr, 4, 1000);   /* å‘é€32ä½ç›®æ ‡å†…å­˜åœ°å€ */\n    HAL_SPI_Receive(&hspi5, pbuf, datalen, 1000);   /* æ¥æ”¶è¯»å–å€¼ */\n    NORFLASH_CS(1);\n}\n```\n#### é¡µç¼–ç¨‹ï¼ˆPage Programï¼‰ - 02H\n*å‚è§*ï¼šdatasheet 8.2.25\n![W25Q256 é¡µå†™æ“ä½œæ—¶åº](/images/arm/spi3.png)\n\né¡µé¢ç¼–ç¨‹æŒ‡ä»¤å…è®¸åœ¨å…ˆå‰æ“¦é™¤çš„ (FFh) å†…å­˜ä½ç½®å¯¹ 1 å­—èŠ‚åˆ° 256 å­—èŠ‚ï¼ˆä¸€é¡µï¼‰çš„æ•°æ®è¿›è¡Œç¼–ç¨‹ã€‚å¿…é¡»å…ˆæ‰§è¡Œå†™ä½¿èƒ½æŒ‡ä»¤ï¼Œè®¾å¤‡æ‰ä¼šæ¥å—é¡µé¢ç¼–ç¨‹æŒ‡ä»¤ï¼ˆWEL= 1ï¼‰ã€‚\n\nå¦‚æœè¦ç¼–ç¨‹æ•´ä¸ª 256 å­—èŠ‚é¡µé¢ï¼Œåˆ™æœ€åä¸€ä¸ªåœ°å€å­—èŠ‚ï¼ˆ8 ä¸ªæœ€ä½æœ‰æ•ˆåœ°å€ä½ï¼‰åº”è®¾ç½®ä¸º 0ã€‚å¦‚æœæœ€åä¸€ä¸ªåœ°å€å­—èŠ‚ä¸ä¸ºé›¶ï¼Œå¹¶ä¸”æ—¶é’Ÿæ•°è¶…è¿‡å‰©ä½™é¡µé¢é•¿åº¦ï¼Œåˆ™å¯»å€å°†ç»•å›åˆ°é¡µé¢çš„å¼€å¤´ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥ç¼–ç¨‹å°‘äº 256 ä¸ªå­—èŠ‚ï¼ˆéƒ¨åˆ†é¡µé¢ï¼‰ï¼Œè€Œä¸ä¼šå¯¹åŒä¸€é¡µé¢å†…çš„å…¶ä»–å­—èŠ‚äº§ç”Ÿä»»ä½•å½±å“ã€‚\n\n*æ³¨æ„*ï¼šæ‰§è¡Œéƒ¨åˆ†é¡µé¢ç¼–ç¨‹çš„ä¸€ä¸ªæ¡ä»¶æ˜¯æ—¶é’Ÿæ•°ä¸èƒ½è¶…è¿‡å‰©ä½™çš„é¡µé•¿åº¦ã€‚å¦‚æœå‘è®¾å¤‡å‘é€äº†è¶…è¿‡ 256 ä¸ªå­—èŠ‚ï¼Œå¯»å€å°†ç»•å›åˆ°é¡µé¢çš„å¼€å¤´å¹¶è¦†ç›–å…ˆå‰å‘é€çš„æ•°æ®ã€‚\n```\n\n```\n\n\n\n\n\n\n![W25Q256 æ‰‡åŒºæ“¦é™¤æ—¶åº](/images/arm/spi4.png)\nW25Q256æ‰‡åŒºå¤§å°ä¸º4Kå­—èŠ‚ï¼Œæ“¦é™¤æ‰‡åŒºåæ‰€æœ‰æ‰‡åŒºä½å…¨éƒ¨ç½®1ï¼Œå³æ‰‡åŒºå­—èŠ‚ä¸º`FFH`ã€‚\n1. ä¸»æœºå‘é€â€œå†™ä½¿èƒ½â€æŒ‡ä»¤\n2. ç¡®å®šSPIæ€»çº¿çŠ¶æ€ï¼šè¯»å–çŠ¶æ€å¯„å­˜å™¨çš„BUSYä½ï¼Œç­‰å¾…BUSYä½ä¸º0åï¼Œç»§ç»­ä¸‹ä¸€æ­¥\n3. ä¸»æœºæ‹‰ä½CSå¼•è„š\n4. ä¸»æœºä»MOSIå‘é€`20H`åˆ°ä»æœºï¼Œç„¶åå‘é€24ä½æ‰‡åŒºåœ°å€\n5. ä¸»æœºæ‹‰é«˜CSå¼•è„šï¼Œè¯»å–å¯„å­˜å™¨çŠ¶æ€ï¼Œç­‰å¾…æ‰‡åŒºæ“¦é™¤å®Œæˆ\n\nW25Q256è¿˜æœ‰æ•´ä¸ªICæ“¦é™¤çš„æ“ä½œï¼Œåªéœ€å‘é€`C7H`åˆ°ICå³å¯å®ç°æ•´ç‰‡æ“¦é™¤ã€‚\n","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"STM32ä¸­çš„I2Cé€šä¿¡ã€AP3216Cå…‰ä¼ æ„Ÿå™¨ã€‘","url":"/2024/12/13/STM32ä¸­çš„I2Cé€šä¿¡ã€AP3216Cå…‰ä¼ æ„Ÿå™¨ã€‘/","content":"## AP3216C \n### ç®€ä»‹\nAP3216C æ˜¯æ•¦å—ç§‘æŠ€æ¨å‡ºçš„ä¸€æ¬¾ä¸‰åˆä¸€ç¯å¢ƒä¼ æ„Ÿå™¨ï¼Œ å®ƒåŒ…å«äº†ï¼šæ•°å­—ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨ï¼ˆALSï¼‰ã€æ¥è¿‘ä¼ æ„Ÿå™¨ï¼ˆPSï¼‰å’Œä¸€ä¸ªçº¢å¤– LEDï¼ˆIRï¼‰ã€‚è¯¥èŠ¯ç‰‡é€šè¿‡ IIC æ¥å£å’Œ MCU è¿æ¥ï¼Œå¹¶æ”¯æŒä¸­æ–­ï¼ˆINTï¼‰è¾“å‡ºã€‚AP3216C çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š\n- IIC æ¥å£ï¼Œæ”¯æŒé«˜è¾¾ 400KHz é€šä¿¡é€Ÿç‡\n- æ”¯æŒå¤šç§å·¥ä½œæ¨¡å¼ï¼ˆALSã€PS+IRã€ALS+PS+IR ç­‰ï¼‰\n- å†…ç½®æ¸©åº¦è¡¥å¿ç”µè·¯\n- å·¥ä½œæ¸©åº¦æ”¯æŒ-30~80â„ƒ\n- ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨å…·æœ‰ 16 ä½åˆ†è¾¨ç‡\n- æ¥è¿‘ä¼ æ„Ÿå™¨å…·æœ‰ 10 ä½åˆ†è¾¨ç‡\n- çº¢å¤–ä¼ æ„Ÿå™¨å…·æœ‰ 10 ä½åˆ†è¾¨ç‡\n- è¶…å°å°è£…ï¼ˆ4.1*2.4*1.35mmï¼‰\n\nå› ä¸ºä»¥ä¸Šä¸€äº›ç‰¹æ€§ï¼ŒAP3216C è¢«å¹¿æ³›åº”ç”¨äºæ™ºèƒ½æ‰‹æœºä¸Šé¢ï¼Œç”¨æ¥æ£€æµ‹å…‰å¼ºåº¦ï¼ˆè‡ªåŠ¨èƒŒå…‰æ§åˆ¶ï¼‰ï¼Œå’Œæ¥è¿‘å¼€å…³æ§åˆ¶ï¼ˆå¬ç­’é è¿‘è€³æœµï¼Œæ‰‹æœºè‡ªåŠ¨ç­å±åŠŸèƒ½ï¼‰ã€‚\n\n### å†™å¯„å­˜å™¨\n![AP3216Cå†™å¯„å­˜å™¨æ—¶åº](/images/arm/3216c1.png)\nå…ˆå‘é€ AP3216C çš„åœ°å€ï¼ˆ7 ä½ï¼Œä¸º`0X1E`ï¼Œå·¦ç§»ä¸€ä½åä¸º `0X3C`ï¼‰ï¼Œæœ€ä½ä½ W=0 è¡¨ç¤ºå†™æ•°æ®ï¼Œéšåå‘é€ 8 ä½å¯„å­˜å™¨åœ°å€ï¼Œæœ€åå‘é€ 8 ä½å¯„å­˜å™¨å€¼ã€‚å…¶ä¸­ï¼šSï¼Œè¡¨ç¤º IIC èµ·å§‹ä¿¡å·ï¼›Wï¼Œè¡¨ç¤ºè¯»/å†™æ ‡å¿—ä½ï¼ˆW=0 è¡¨ç¤ºå†™ï¼ŒW=1 è¡¨ç¤ºè¯»ï¼‰ï¼›Aï¼Œè¡¨ç¤ºåº”ç­”ä¿¡å·ï¼›Pï¼Œè¡¨ç¤º IIC åœæ­¢ä¿¡å·ã€‚\n\n### è¯»å¯„å­˜å™¨\n![AP3216Cå¯„å­˜å™¨è¯´æ˜](/images/arm/3216c2.png)\n\n*æ³¨æ„*ï¼šAP3216Cçš„è¯»å–é—´éš”è‡³å°‘éœ€è¦å¤§äº112.5msï¼ˆä¸€æ¬¡ALS+PS+IRè½¬æ¢çš„æ—¶é—´ï¼‰\n\n## å·¥ç¨‹\n### ap3216c.h\n```\n #include \"sys.h\"\n #include \"main.h\"\n\n #ifndef __AP3216C_H\n #define __AP3216C_H\n\n #define AP3216C_ADDR 0x3C  /* åŸè®¾å¤‡åœ°å€ä¸º0x1Eï¼Œå·¦ç§»ä¸€ä½ä¸º0x3C*/\n\n #endif\n\n uint8_t ap3216c_init(void);\n uint8_t ap3216c_write_one_byte(uint8_t reg, uint8_t data);\n uint8_t ap3216c_read_one_byte(uint8_t reg);\n void ap3216c_read_data(uint16_t *ir, uint16_t *ps, uint16_t *als);\n ```\n ### ap3216c.c\n```\n#include \"main.h\"\n #include \"sys.h\"\n #include \"ap3216c.h\"\n #include \"custom_i2c.h\"\n #include \"delay.h\"\n\n /**\n* @brief åˆå§‹åŒ– AP3216C\n* @param æ— \n* @retval è¿”å›å€¼:0,åˆå§‹åŒ–æˆåŠŸ; 1,åˆå§‹åŒ–å¤±è´¥\n*/\nuint8_t ap3216c_init(void)\n{\n    uint8_t temp = 0;\n    iic_init();\n\n    ap3216c_write_one_byte(0x00, 0x04);     /* è½¯å¤ä½AP3216C */\n    delay_ms(50);                           /* ICå¤ä½è‡³å°‘éœ€è¦11.5ms */\n    ap3216c_write_one_byte(0x00, 0x03);     /* ALS+PS+IRåŠŸèƒ½æ¿€æ´» */\n    temp = ap3216c_read_one_byte(0x00);     /* è¯»å–åˆšåˆšå†™å…¥çš„0x03æŒ‡ä»¤ */\n    if (temp == 0x03) return 0;             /* ICåˆå§‹åŒ–æˆåŠŸ */\n    else return 1;                          /* ICåˆå§‹åŒ–å¤±è´¥ */\n}\n\n/**\n* @brief AP3216C å†™å…¥ä¸€ä¸ªå­—èŠ‚\n* @param reg : AP3216Cç›®æ ‡å¯„å­˜å™¨åœ°å€\n* @param data : å¾…å†™å…¥æ•°æ®\n* @retval 0, æˆåŠŸ;\n          1, å¤±è´¥;\n*/\nuint8_t ap3216c_write_one_byte(uint8_t reg, uint8_t data)\n{\n    iic_start();\n    \n    iic_send_byte(AP3216C_ADDR | 0x00);     /* å‘é€è®¾å¤‡åœ°å€ï¼Œæœ€ä½ä½ä¸º0ï¼Œå†™å‘½ä»¤ */\n\n    if (iic_wait_ack())     /* ç­‰å¾…åº”ç­”*/\n    {\n        iic_stop();         /* ç­‰å¾…åº”ç­”å¤±è´¥åˆ™ç›´æ¥åœæœº */\n        return 1;\n    }\n\n    iic_send_byte(reg);     /* å‘é€ç›®æ ‡å¯„å­˜å™¨åœ°å€ï¼ˆæŒ‡é’ˆï¼‰*/\n    iic_wait_ack();         /* ç­‰å¾…åº”ç­” */\n    iic_send_byte(data);    /* å‘é€å¾…å†™å…¥æ•°æ® */\n\n    if (iic_wait_ack())     /* ç­‰å¾…åº”ç­”*/\n    {\n        iic_stop();         /* ç­‰å¾…åº”ç­”å¤±è´¥åˆ™ç›´æ¥åœæœº */\n        return 1;\n    }\n\n    iic_stop();\n    return 0;\n}\n\n/**\n* @brief AP3216C è¯»å–ä¸€ä¸ªå­—èŠ‚\n* @param reg : å¾…è¯»å–å¯„å­˜å™¨åœ°å€\n* @retval è¯»åˆ°çš„æ•°æ®\n*/\nuint8_t ap3216c_read_one_byte(uint8_t reg)\n{\n    uint8_t result;\n\n    iic_start();\n\n    iic_send_byte(AP3216C_ADDR | 0x00);     /* å‘é€è®¾å¤‡åœ°å€ï¼Œæœ€ä½ä½ä¸º0ï¼Œå†™å‘½ä»¤*/\n    iic_wait_ack();\n\n    iic_send_byte(reg);     /* å‘é€å¾…è¯»å–å¯„å­˜å™¨åœ°å€ */\n    iic_wait_ack();\n\n    iic_start();            /* å‡†å¤‡å¼€å§‹è¯»å–ï¼Œé‡æ–°å¯åŠ¨IICä»¥åˆ‡æ¢æ¨¡å¼ */\n    iic_send_byte(AP3216C_ADDR | 0x01);     /* å‘é€è®¾å¤‡åœ°å€ï¼Œæœ€ä½ä½ä¸º1ï¼Œè¯»å‘½ä»¤*/\n    iic_wait_ack();\n    result = iic_read_byte(0);              /* è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¯»å®Œåå‘é€NACKï¼Œè¡¨ç¤ºè¯»å–ç»“æŸ */\n    iic_stop();\n    \n    return result;      /* è¿”å›è¯»å–ç»“æœ */\n}\n\n/**\n* @brief è¯»å– AP3216C çš„æ•°æ®\n* @note è¯»å–åŸå§‹æ•°æ®ï¼ŒåŒ…æ‹¬ ALS,PS å’Œ IR\n* å¦‚æœåŒæ—¶æ‰“å¼€ ALS,IR+PS çš„è¯ä¸¤æ¬¡æ•°æ®è¯»å–çš„æ—¶é—´é—´éš”è¦å¤§äº 112.5ms\n* @param ir : IR ä¼ æ„Ÿå™¨å€¼\n* @param ps : PS ä¼ æ„Ÿå™¨å€¼\n* @param als : ALS ä¼ æ„Ÿå™¨å€¼\n* @retval æ— \n*/\nvoid ap3216c_read_data(uint16_t *ir, uint16_t *ps, uint16_t *als)\n{\n    uint8_t rx_buf[6];      /* è¯»å–ç¼“å†²åŒº */\n    uint8_t i;\n\n    for (i = 0; i < 6; i++) /* å¾ªç¯6æ¬¡ä»¥è¯»å–6ä¸ªå¯„å­˜å™¨çš„å€¼ */\n    {\n        rx_buf[i] = ap3216c_read_one_byte(0x0A + i);\n    }\n\n    /* æå–IRä¼ æ„Ÿå™¨å€¼ */\n    if (rx_buf[0] & 0x80)   /* åˆ¤æ–­IRç¬¬7ä½æ˜¯å¦ä¸º1 */\n    {\n        *ir = 0;            /* ç¬¬7ä½è‹¥ä¸º1åˆ™IRæ•°æ®æ— æ•ˆ */\n    }\n    else\n    {\n        /* rx_buf[1] << 2ï¼š0x0Bï¼ˆIRé«˜ä½ï¼‰æ•°æ®å·¦ç§»2ä½ï¼Œç»™ä½ä½æ•°æ®ç•™å‡ºç©ºä½™*/\n        /* rx_buf[0] & 0x03ï¼šæå–0x0Aï¼ˆIRä½ä½ï¼‰æ•°æ®çš„ç¬¬0ä½å’Œç¬¬1ä½ï¼Œä¹Ÿå°±æ˜¯IRçš„æœ€ä½2ä½*/\n        /* äºŒè€…è¿›è¡Œæˆ–è¿ç®—å¾—åˆ°IRçš„æœ€ç»ˆå€¼ */\n        *ir = ((uint16_t)rx_buf[1] << 2) | (rx_buf[0] & 0x03);  \n    }\n\n    /* æå–ALSä¼ æ„Ÿå™¨å€¼ */\n    *als = rx_buf[2] | ((uint16_t)rx_buf[3] << 8);\n\n    /* æå–PSä¼ æ„Ÿå™¨å€¼ */\n    if (rx_buf[4] & 0x40)   /* åˆ¤æ–­0x0Eç¬¬6ä½æ˜¯å¦ä¸º1*/\n    {\n        *ps = 0;            /* PSæ•°æ®æ— æ•ˆ */\n    }\n    else\n    {\n        /* (rx_buf[4] & 0x0F)ï¼šå–0x0Eçš„3:0ä½ï¼Œä¹Ÿå°±æ˜¯PSçš„ä½4ä½ */\n        /* ((uint16_t)(rx_buf[5] & 0x3F) << 4):å–0x0Fçš„5:0ä½ç„¶åå·¦ç§»4ä½ï¼Œç»™ä½4ä½ç•™ä½ç½® */\n        /* äºŒè€…è¿›è¡Œæˆ–è¿ç®—å¾—åˆ°PSçš„æœ€ç»ˆå€¼ */\n        *ps = ((uint16_t)(rx_buf[5] & 0x3F) << 4) | (rx_buf[4] & 0x0F);\n    }\n}\n```\n### main.c\n```\n  /* USER CODE BEGIN 2 */\n  while (ap3216c_init())    /* AP3216Cåˆå§‹åŒ–å¤±è´¥ */\n  {\n    uint8_t txbuf[] = \"ap3216c init failed!\\n\";\n    HAL_UART_Transmit_IT(&huart1, txbuf, sizeof(txbuf));\n    led_red(1);\n  }\n  /* USER CODE END 2 */\n```\n\n```\nwhile (1)\n  {\n    /* USER CODE END WHILE */\n    ap3216c_read_data(&ir, &ps, &als);\n\n    uint8_t txbuf[23];\n\n    sprintf(txbuf, \"ir:%d, ps:%d, als:%d\\r\\n\", ir, ps, als);\n    HAL_UART_Transmit_IT(&huart1, (uint8_t *)txbuf, sizeof(txbuf));\n\n    led_green_toggle();\n    delay_ms(120);    /* å»¶æ—¶120msä»¥ä¿è¯AP3216Cé‡‡æ ·æ­£ç¡® */\n    /* USER CODE BEGIN 3 */\n\n  }\n```\n### æµ‹è¯•\n![ä¸²å£æ‰“å°ç»“æœ](/images/arm/3216c3.png)","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"RNNï¼šåŸç†ã€ç»„æˆä¸ç®€å•å®ç°","url":"/2024/12/12/RNNï¼šåŸç†ã€ç»„æˆä¸ç®€å•å®ç°/","content":"## ä¼ ç»ŸRNN\nå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æœ€æ—©å¯ä»¥è¿½æº¯åˆ°1980å¹´ä»£æœ«ï¼Œå½“æ—¶çš„ç ”ç©¶è€…å¸Œæœ›è®¾è®¡ä¸€ç§èƒ½å¤Ÿå¤„ç†æ—¶é—´åºåˆ—æ•°æ®æˆ–å…·æœ‰æ—¶åºä¾èµ–å…³ç³»çš„æ•°æ®çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚RNNçš„è®¾è®¡çµæ„Ÿæ¥è‡ªç”Ÿç‰©ç¥ç»ç½‘ç»œçš„å·¥ä½œåŸç†ï¼Œå®ƒæ¨¡æ‹Ÿäº†å¤§è„‘ç¥ç»å…ƒçš„åé¦ˆæœºåˆ¶ï¼Œé€šè¿‡é€’å½’è¿æ¥æ¥æ•æ‰æ•°æ®ä¸­å‰åæ—¶åˆ»çš„ä¾èµ–å…³ç³»ã€‚\n\n### å†å²\nRNNçš„åˆæœŸå‘å±•å¯è¿½æº¯åˆ°1986å¹´ï¼ŒDavid Rumelhart å’Œ Geoffrey Hinton ç­‰äººæå‡ºäº†åå‘ä¼ æ’­ç®—æ³•ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ„å»ºäº†ç®€å•çš„RNNæ¨¡å‹ã€‚æœ€åˆçš„RNNèƒ½å¤Ÿé€šè¿‡è®­ç»ƒå­¦ä¹ è¾“å…¥æ•°æ®çš„æ—¶åºæ¨¡å¼ã€‚RNN è·Ÿä¼ ç»Ÿç¥ç»ç½‘ç»œæœ€å¤§çš„åŒºåˆ«åœ¨äºæ¯æ¬¡éƒ½ä¼šå°†å‰ä¸€æ¬¡çš„è¾“å‡ºç»“æœï¼Œå¸¦åˆ°ä¸‹ä¸€æ¬¡çš„éšè—å±‚ä¸­ï¼Œä¸€èµ·è®­ç»ƒã€‚\n\n### å·¥ä½œåŸç†\nä»¥ä¸€ä¸ªæœ€ç®€å•çš„è¯­åºä¸ºä¾‹ï¼šç”¨æˆ·è¾“å…¥äº†ä¸€å¥â€œwhat time is itâ€ï¼Œé¦–å…ˆéœ€è¦å¯¹è¿™å¥è¯è¿›è¡Œåˆ†è¯ï¼š\n\n![ç¬¬ä¸€æ­¥ï¼šåˆ†è¯](/images/DL/rnn1.gif)\n\nå°†åˆ†è¯ç»“æœæŒ‰é¡ºåºè¾“å…¥RNNã€‚é¦–å…ˆè¾“å…¥â€œwhatâ€ï¼š\n\n![ç¬¬äºŒæ­¥ï¼šè¾“å…¥\"what\"](/images/DL/rnn2.gif)\n\næŒ‰é¡ºåºè¾“å…¥å‰©ä¸‹çš„åˆ†è¯ï¼Œç¬¬ä¸‰æ­¥è¾“å…¥â€œtimeâ€ã€‚æŒ‰ç…§RNNçš„ç»“æ„ï¼Œè¾“å…¥\"time\"æ—¶ï¼Œä¹‹å‰è¾“å…¥çš„\"what\"ä¼šå¯¹RNNçš„è¾“å‡ºäº§ç”Ÿå½±å“ï¼ˆéšè—å±‚ä¸­æœ‰ä¸€åŠæ˜¯é»‘è‰²çš„ï¼‰\n\n![ç¬¬ä¸‰æ­¥ï¼šè¾“å…¥\"time\"](/images/DL/rnn3.gif)\n\nä»¥æ­¤ç±»æ¨ï¼Œæ¯ä¸€ä¸ªå†å²è¾“å…¥éƒ½ä¼šå¯¹æœªæ¥è¾“å‡ºäº§ç”Ÿå½±å“ï¼Œç›´è§‚æ˜¾ç¤ºä¸ºæ¯ä¸€ä¸ªåœ†å½¢éšè—å±‚ä¸­éƒ½åŒ…å«äº†ä¹‹å‰æ‰€æœ‰å†å²è¾“å…¥æ‰€æŒ‡ä»£çš„é¢œè‰²ã€‚\n\n![ç¬¬å››æ­¥ï¼šå†å²è¾“å…¥ä¼šå½±å“æœªæ¥è¾“å‡º](/images/DL/rnn4.gif)\n\næœ€åéœ€è¦è¾“å‡ºç»“æœï¼ˆæ­¤å¤„æ˜¯åˆ¤æ–­è¿™å¥è¯çš„æ„å›¾ï¼‰æ—¶ï¼Œåªéœ€è¦è¾“å‡ºæœ€åä¸€å±‚çš„ç»“æœã€‚\n\n### ç»„æˆå’ŒåŸºæœ¬ç»“æ„\nRNNçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†æ˜¯**å¾ªç¯ç»“æ„**ï¼Œå®ƒä½¿å¾—ç½‘ç»œèƒ½å¤Ÿè®°ä½ä¹‹å‰æ—¶åˆ»çš„ä¿¡æ¯ï¼Œå¹¶é€šè¿‡è¿™ç§â€œè®°å¿†â€æ¥å½±å“å½“å‰æ—¶åˆ»çš„è®¡ç®—ã€‚RNNçš„åŸºæœ¬ç»“æ„å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†æ¥ç†è§£ï¼š\n\n#### 1. è¾“å…¥å±‚ï¼ˆInput Layerï¼‰\nè¾“å…¥åºåˆ—æ•°æ®ï¼Œé€šå¸¸è¡¨ç¤ºä¸ºä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å…¥å‘é‡ $ x_t $ã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ä¸­ï¼Œè¾“å…¥å¯ä»¥æ˜¯ä¸€ä¸ªè¯å‘é‡ï¼›åœ¨æ—¶é—´åºåˆ—é¢„æµ‹ä»»åŠ¡ä¸­ï¼Œè¾“å…¥å¯ä»¥æ˜¯æŸä¸€æ—¶åˆ»çš„ä¼ æ„Ÿå™¨æ•°æ®ã€‚\n\n#### 2. éšå±‚ï¼ˆHidden Layerï¼‰\néšè—å±‚ç”±å¤šä¸ªç¥ç»å…ƒç»„æˆï¼Œæ¯ä¸ªç¥ç»å…ƒçš„è¾“å‡ºä¸ä»…å—åˆ°å½“å‰è¾“å…¥çš„å½±å“ï¼Œè¿˜å—åˆ°å‰ä¸€æ—¶åˆ»éšå±‚çŠ¶æ€çš„å½±å“ã€‚è¯¥å±‚çš„è®¡ç®—è¿‡ç¨‹å¯ä»¥è¡¨ç¤ºä¸ºï¼š\n$$\nh_t = f(W_{xh}x_t + W_{hh}h_{t-1} + b_h)\n$$\nå…¶ä¸­ï¼Œ$ h_t $ æ˜¯å½“å‰æ—¶åˆ»çš„éšå±‚çŠ¶æ€ï¼Œ$ x_t $ æ˜¯å½“å‰è¾“å…¥ï¼Œ$ h_{t-1} $ æ˜¯å‰ä¸€æ—¶åˆ»çš„éšå±‚çŠ¶æ€ï¼Œ$ W_{xh} $ å’Œ $W_{hh} $ æ˜¯æƒé‡çŸ©é˜µï¼Œ$ b_h $ æ˜¯åç½®é¡¹ï¼Œ$ f $ æ˜¯æ¿€æ´»å‡½æ•°ï¼ˆå¦‚tanhæˆ–ReLUï¼‰ã€‚\n\n#### 3. è¾“å‡ºå±‚ï¼ˆOutput Layerï¼‰\nè¾“å‡ºå±‚ç”¨äºç”Ÿæˆé¢„æµ‹ç»“æœï¼Œé€šå¸¸å¯ä»¥è¡¨ç¤ºä¸ºï¼š\n$$\ny_t = g(W_{hy}h_t + b_y)\n$$\nå…¶ä¸­ï¼Œ$ y_t $ æ˜¯å½“å‰æ—¶åˆ»çš„è¾“å‡ºï¼Œ$ W_{hy} $ æ˜¯ä»éšå±‚åˆ°è¾“å‡ºçš„æƒé‡çŸ©é˜µï¼Œ$ b_y $ æ˜¯è¾“å‡ºå±‚çš„åç½®é¡¹ï¼Œ$ g $ æ˜¯è¾“å‡ºçš„æ¿€æ´»å‡½æ•°ï¼ˆä¾‹å¦‚softmaxæˆ–sigmoidï¼Œå–å†³äºä»»åŠ¡ï¼‰ã€‚\n\n\n### åº”ç”¨\nRNNåœ¨æ—¶é—´åºåˆ—æ•°æ®å¤„ç†ä¸­çš„ä¼˜åŠ¿æ˜¯èƒ½å¤Ÿ**æ•æ‰æ—¶é—´åºåˆ—çš„åŠ¨æ€å˜åŒ–å’Œæ—¶åºä¾èµ–å…³ç³»**ï¼Œå› æ­¤å®ƒç‰¹åˆ«é€‚ç”¨äºå¤„ç†å’Œé¢„æµ‹å…·æœ‰æ—¶åºç‰¹å¾çš„æ•°æ®ã€‚\n\nRNNçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå³çŸ­æœŸçš„è®°å¿†å½±å“è¾ƒå¤§ï¼Œé•¿æœŸçš„è®°å¿†å½±å“è¾ƒå°ã€‚è‹¥æ•´ä¸ªæ—¶é—´åºåˆ—éå¸¸é•¿ï¼ŒRNNç”šè‡³å¯èƒ½ä¸¢å¤±å¾ˆä¹…ä¹‹å‰çš„å†å²è¾“å…¥ã€‚åŒæ—¶ï¼Œè®­ç»ƒRNNä¹Ÿéœ€è¦å¤§é‡çš„æˆæœ¬ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“å¸¦æ¥æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚è¿™å°±å¼•å‡ºäº†åæ¥çš„å˜ç§ï¼šé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRUï¼‰ä¸é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼‰ã€‚\n\n## é—¨æ§å¾ªç¯å•å…ƒï¼ˆGRUï¼‰\n*å‚è€ƒæ–‡çŒ®ï¼šCho, K., Van MerriÃ«nboer, B., Bahdanau, D., & Bengio, Y. (2014). On the properties of neural machine translation: encoder-decoder approaches. arXiv preprint arXiv:1409.1259.*\n### æ¥æº\nGRUè¢«ç”¨äºè§£å†³ä¼ ç»ŸRNNçš„æ¢¯åº¦å¼‚å¸¸é—®é¢˜ã€‚è¿™ç§æ¢¯åº¦å¼‚å¸¸é—®é¢˜åœ¨åºåˆ—é—®é¢˜ä¸­æ˜¯éå¸¸å¸¸è§çš„ï¼Œæ¯”å¦‚ï¼š\n- æ—©æœŸè§‚æµ‹å€¼å¯¹é¢„æµ‹æ‰€æœ‰æœªæ¥è§‚æµ‹å€¼å…·æœ‰éå¸¸é‡è¦çš„æ„ä¹‰ã€‚ è€ƒè™‘ä¸€ä¸ªæç«¯æƒ…å†µï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªè§‚æµ‹å€¼åŒ…å«ä¸€ä¸ªæ ¡éªŒå’Œï¼Œ ç›®æ ‡æ˜¯åœ¨åºåˆ—çš„æœ«å°¾è¾¨åˆ«æ ¡éªŒå’Œæ˜¯å¦æ­£ç¡®ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªè¯å…ƒçš„å½±å“è‡³å…³é‡è¦ã€‚ æˆ‘ä»¬å¸Œæœ›æœ‰æŸäº›æœºåˆ¶èƒ½å¤Ÿåœ¨ä¸€ä¸ªè®°å¿†å…ƒé‡Œå­˜å‚¨é‡è¦çš„æ—©æœŸä¿¡æ¯ã€‚ å¦‚æœæ²¡æœ‰è¿™æ ·çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸ç»™è¿™ä¸ªè§‚æµ‹å€¼æŒ‡å®šä¸€ä¸ªéå¸¸å¤§çš„æ¢¯åº¦ï¼Œ å› ä¸ºå®ƒä¼šå½±å“æ‰€æœ‰åç»­çš„è§‚æµ‹å€¼ã€‚\n- ä¸€äº›ç‰¹å¾æˆ–ç°è±¡æ²¡æœ‰ç›¸å…³çš„è§‚æµ‹å€¼ã€‚ ä¾‹å¦‚ï¼Œåœ¨å¯¹ç½‘é¡µå†…å®¹è¿›è¡Œæƒ…æ„Ÿåˆ†ææ—¶ï¼Œ å¯èƒ½æœ‰ä¸€äº›è¾…åŠ©HTMLä»£ç ä¸ç½‘é¡µä¼ è¾¾çš„æƒ…ç»ªæ— å…³ã€‚ æˆ‘ä»¬å¸Œæœ›æœ‰ä¸€äº›æœºåˆ¶æ¥è·³è¿‡éšçŠ¶æ€è¡¨ç¤ºä¸­çš„æ­¤ç±»è¯å…ƒã€‚\n- åºåˆ—çš„å„ä¸ªéƒ¨åˆ†ä¹‹é—´å­˜åœ¨é€»è¾‘ä¸­æ–­ã€‚ ä¾‹å¦‚ï¼Œä¹¦çš„ç« èŠ‚ä¹‹é—´å¯èƒ½ä¼šæœ‰è¿‡æ¸¡å­˜åœ¨ï¼Œ æˆ–è€…è¯åˆ¸çš„ç†Šå¸‚å’Œç‰›å¸‚ä¹‹é—´å¯èƒ½ä¼šæœ‰è¿‡æ¸¡å­˜åœ¨ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½æœ‰ä¸€ç§æ–¹æ³•æ¥é‡ç½®æˆ‘ä»¬çš„å†…éƒ¨çŠ¶æ€è¡¨ç¤ºã€‚\n\n### å·¥ä½œåŸç†\nGRUä¸ä¼ ç»ŸRNNçš„å…³é”®åŒºåˆ«åœ¨äºï¼ŒGRUæ”¯æŒéšçŠ¶æ€çš„é—¨æ§ã€‚è¿™æ„å‘³ç€æ¨¡å‹æœ‰ä¸“é—¨çš„æœºåˆ¶æ¥ç¡®å®šåº”è¯¥ä½•æ—¶æ›´æ–°éšçŠ¶æ€ï¼Œ ä»¥åŠåº”è¯¥ä½•æ—¶é‡ç½®éšçŠ¶æ€ã€‚ è¿™äº›æœºåˆ¶æ˜¯å¯å­¦ä¹ çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿè§£å†³äº†ä¸Šé¢åˆ—å‡ºçš„é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœç¬¬ä¸€ä¸ªåºåˆ—æ•°æ®å˜åŒ–ç°è±¡éå¸¸é‡è¦ï¼ˆå¦‚å‘ç”µæœºæ•…éšœä¸­åŒé—´çŸ­è·¯çš„é‚£ä¸€ç¬é—´ï¼‰ï¼Œ æ¨¡å‹å°†å­¦ä¼šåœ¨ç¬¬ä¸€æ¬¡è§‚æµ‹ä¹‹åä¸æ›´æ–°éšçŠ¶æ€ã€‚åŒæ ·ï¼Œæ¨¡å‹ä¹Ÿå¯ä»¥å­¦ä¼šè·³è¿‡ä¸ç›¸å…³çš„ä¸´æ—¶è§‚æµ‹ã€‚æœ€åï¼Œæ¨¡å‹è¿˜å°†å­¦ä¼šåœ¨éœ€è¦çš„æ—¶å€™é‡ç½®éšçŠ¶æ€ã€‚ \n\n#### é‡ç½®é—¨ï¼ˆReset Gateï¼‰\né‡ç½®é—¨ç”¨äºå†³å®šå½“å‰æ—¶åˆ»çš„è¾“å…¥æ•°æ®åœ¨è®¡ç®—å½“å‰çŠ¶æ€æ—¶å¯¹ä¹‹å‰çŠ¶æ€çš„å½±å“ç¨‹åº¦ã€‚å³å®ƒå†³å®šåœ¨è®¡ç®—æ–°çš„å€™é€‰éšè—çŠ¶æ€æ—¶ï¼Œå‰ä¸€æ—¶åˆ»çš„éšå±‚çŠ¶æ€åº”è¯¥æœ‰å¤šå¤§çš„å½±å“ã€‚\n\nå…¬å¼è¡¨ç¤ºä¸ºï¼š\n$$\nr_t = \\sigma(W_r x_t + U_r h_{t-1} + b_r)\n$$\nå…¶ä¸­ï¼Œ$r_t$ æ˜¯é‡ç½®é—¨çš„è¾“å‡ºï¼Œ$W_r$ å’Œ $U_r$ æ˜¯æƒé‡çŸ©é˜µï¼Œ$x_t$ æ˜¯å½“å‰æ—¶åˆ»çš„è¾“å…¥ï¼Œ$h_{t-1}$ æ˜¯å‰ä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€ï¼Œ$b_r$ æ˜¯åç½®é¡¹ï¼Œ$\\sigma$ æ˜¯sigmoidæ¿€æ´»å‡½æ•°ã€‚\n\nå½“ $r_t$ æ¥è¿‘0æ—¶ï¼Œè¡¨ç¤ºå‰ä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€å¯¹å½“å‰æ—¶åˆ»çš„å½±å“å¾ˆå°ï¼Œç½‘ç»œå°†â€œé‡ç½®â€ä¹‹å‰çš„è®°å¿†ã€‚\n\n#### æ›´æ–°é—¨ï¼ˆUpdate Gateï¼‰\næ›´æ–°é—¨æ§åˆ¶ç€å½“å‰æ—¶åˆ»çš„éšè—çŠ¶æ€åº”è¯¥å¦‚ä½•æ›´æ–°ï¼Œå®ƒå†³å®šäº†å½“å‰æ—¶åˆ»çš„è¾“å‡ºåº”ä¿ç•™å¤šå°‘æ¥è‡ªä¸Šä¸€æ—¶åˆ»çš„çŠ¶æ€ï¼Œå¤šå°‘æ¥è‡ªå½“å‰è¾“å…¥çš„å€™é€‰éšè—çŠ¶æ€ã€‚æ›´æ–°é—¨çš„å€¼æ¥è¿‘1æ—¶ï¼Œæ„å‘³ç€å½“å‰æ—¶åˆ»çš„éšè—çŠ¶æ€ä¿ç•™æ›´å¤šæ¥è‡ªå‰ä¸€æ—¶åˆ»çš„è®°å¿†ï¼›è€Œæ¥è¿‘0æ—¶ï¼Œæ„å‘³ç€æ›´å¤šçš„ä¾èµ–äºå½“å‰è¾“å…¥ã€‚\n\nå…¬å¼è¡¨ç¤ºä¸ºï¼š\n$$\nz_t = \\sigma(W_z x_t + U_z h_{t-1} + b_z)\n$$\nå…¶ä¸­ï¼Œ$z_t$ æ˜¯æ›´æ–°é—¨çš„è¾“å‡ºï¼Œ$W_z$ å’Œ $U_z$ æ˜¯æƒé‡çŸ©é˜µï¼Œ$x_t$ æ˜¯å½“å‰æ—¶åˆ»çš„è¾“å…¥ï¼Œ$h_{t-1}$ æ˜¯å‰ä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€ï¼Œ$b_z$ æ˜¯åç½®é¡¹ã€‚\n\n![GRUä¸­è®¡ç®—é‡ç½®é—¨å’Œæ›´æ–°é—¨](/images/DL/gru-1.svg)\n\n#### å€™é€‰éšè—çŠ¶æ€ï¼ˆCandidate Hidden Stateï¼‰\nå€™é€‰éšè—çŠ¶æ€æ˜¯GRUç½‘ç»œæ ¹æ®å½“å‰è¾“å…¥å’Œé‡ç½®é—¨çš„ä½œç”¨è®¡ç®—å‡ºæ¥çš„ï¼Œè¡¨ç¤ºç½‘ç»œåœ¨å½“å‰æ—¶åˆ»å¸Œæœ›æ›´æ–°çš„â€œè®°å¿†â€ã€‚å®ƒæ˜¯åŸºäºå½“å‰è¾“å…¥å’Œå‰ä¸€æ—¶åˆ»çš„è®°å¿†çŠ¶æ€è®¡ç®—çš„ã€‚\n\nå…¬å¼è¡¨ç¤ºä¸ºï¼š\n$$\n\\tilde{h}_t = \\tanh(W_h x_t + U_h (r_t \\cdot h_{t-1}) + b_h)\n$$\nå…¶ä¸­ï¼Œ$\\tilde{h}_t$ æ˜¯å€™é€‰éšè—çŠ¶æ€ï¼Œ$W_h$ å’Œ $U_h$ æ˜¯æƒé‡çŸ©é˜µï¼Œ$r_t$ æ˜¯é‡ç½®é—¨çš„è¾“å‡ºï¼Œ$\\cdot$ è¡¨ç¤ºæŒ‰å…ƒç´ ç›¸ä¹˜ï¼ˆHadamardç§¯ï¼‰ï¼Œ$\\tanh$ æ˜¯tanhæ¿€æ´»å‡½æ•°ã€‚\n\n![GRUä¸­è®¡ç®—å€™é€‰éšè—çŠ¶æ€](/images/DL/gru-2.svg)\n\n\n#### æœ€ç»ˆéšè—çŠ¶æ€ï¼ˆFinal Hidden Stateï¼‰\næœ€ç»ˆçš„éšè—çŠ¶æ€æ˜¯å½“å‰æ—¶åˆ»å€™é€‰éšè—çŠ¶æ€å’Œä¸Šä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€çš„åŠ æƒå¹³å‡ã€‚åŠ æƒç³»æ•°ç”±æ›´æ–°é—¨ $z_t$ æ§åˆ¶ï¼Œè¡¨ç¤ºä¿¡æ¯åº”è¯¥æ›´æ–°å¤šå°‘ï¼Œä¿ç•™å¤šå°‘ã€‚\n\nå…¬å¼è¡¨ç¤ºä¸ºï¼š\n$$\nh_t = (1 - z_t) \\cdot \\tilde{h}_t + z_t \\cdot h_{t-1}\n$$\nå…¶ä¸­ï¼Œ$h_t$ æ˜¯å½“å‰æ—¶åˆ»çš„æœ€ç»ˆéšè—çŠ¶æ€ï¼Œ$\\tilde{h}_t$ æ˜¯å€™é€‰éšè—çŠ¶æ€ï¼Œ$z_t$ æ˜¯æ›´æ–°é—¨ï¼Œ$h_{t-1}$ æ˜¯å‰ä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€ã€‚\n\n![GRUä¸­è®¡ç®—æœ€ç»ˆéšè—çŠ¶æ€](/images/DL/gru-3.svg)\n\n### ç®€å•åº”ç”¨\nGRUååˆ†é€‚åˆç”¨äºæ—¶é—´åºåˆ—æ•°æ®çš„ç‰¹å¾è¯†åˆ«ã€æå–å’Œé¢„æµ‹ï¼Œå°¤å…¶æ˜¯è¾ƒé•¿æ—¶é—´å†…çš„æ—¶é—´åºåˆ—ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç”¨äºé¢„æµ‹æœªæ¥ä¸€æ®µæ—¶é—´å†…å¤©æ°”çŠ¶å†µçš„æ¨¡å‹ï¼Œå…¶ä½¿ç”¨äº”ä¸ªGRUå±‚ï¼Œç”¨äºå¯¹å››ä¸ªä¸åŒå˜é‡ï¼ˆæœ€é«˜æ¸©ã€æœ€ä½æ¸©ã€é™æ°´é‡ä¸é£é€Ÿï¼‰è¿›è¡Œå›å½’ä»»åŠ¡ã€‚æ•°æ®é›†æ¥è‡ªäº[Kaggle](https://www.kaggle.com/datasets/ananthr1/weather-prediction)\n```\nimport pandas as pd\nimport numpy as np\nfrom sklearn.preprocessing import MinMaxScaler\nfrom sklearn.model_selection import train_test_split\nfrom tensorflow.keras.models import Model\nfrom tensorflow.keras.layers import Input, GRU, Dense, Dropout\nimport tensorflow.keras.backend as K\nimport matplotlib.pyplot as plt\n\n# 1. åŠ è½½CSVæ–‡ä»¶ï¼Œè¯»å–æ—¥æœŸæ•°æ®ï¼Œå¹¶è½¬æ¢ä¸ºæ—¥æœŸæ ¼å¼\ndf = pd.read_csv('seattle-weather.csv', parse_dates=['date'])\n\n# 2. å¤„ç†ç¼ºå¤±å€¼ï¼Œä½¿ç”¨å‰å‘å¡«å……ï¼ˆå‰ä¸€ä¸ªæœ‰æ•ˆå€¼å¡«å……ï¼‰\ndf.fillna(method='ffill', inplace=True)\n\n# 3. è§„èŒƒåŒ–æ•°å€¼ç‰¹å¾\n# ä½¿ç”¨ MinMaxScaler å°†æ•°æ®ç¼©æ”¾åˆ° 0 å’Œ 1 ä¹‹é—´\nscaler = MinMaxScaler()\nscaled_features = ['precipitation', 'temp_max', 'temp_min', 'wind']  # éœ€è¦è§„èŒƒåŒ–çš„ç‰¹å¾\ndf[scaled_features] = scaler.fit_transform(df[scaled_features])\n\n# 4. åˆ›å»ºæ—¶é—´åºåˆ—æ•°æ®ï¼šè¾“å…¥Xæ˜¯è¿‡å»window_sizeå¤©çš„ç‰¹å¾ï¼Œyæ˜¯ç›®æ ‡åˆ—ï¼ˆtemp_max, temp_min, precipitation, windï¼‰\ndef create_sequences(df, window_size, target_columns):\n    X, y = [], []\n    for i in range(len(df) - window_size):\n        # è¿‡å» window_size å¤©çš„æ•°æ®ä½œä¸ºè¾“å…¥\n        X.append(df.iloc[i:i + window_size][scaled_features].values)\n        # å½“å‰å¤©çš„ç›®æ ‡ç‰¹å¾ä½œä¸ºè¾“å‡º\n        y.append(df.iloc[i + window_size][target_columns].values)  # å¤šç›®æ ‡å›å½’\n    return np.array(X), np.array(y)\n\n# è®¾ç½®æ—¶é—´çª—å£ä¸º15å¤©ï¼Œç›®æ ‡åˆ—ä¸ºæ°”æ¸©ã€é™æ°´é‡å’Œé£é€Ÿ\nwindow_size = 15\ntarget_columns = ['temp_max', 'temp_min', 'precipitation', 'wind']  # ç›®æ ‡åˆ—ï¼šæ¸©åº¦ã€é™æ°´é‡å’Œé£é€Ÿ\nX, y = create_sequences(df, window_size, target_columns)\n\n# 5. åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œé‡‡ç”¨80%çš„æ•°æ®ç”¨äºè®­ç»ƒï¼Œ20%ç”¨äºæµ‹è¯•\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, shuffle=False)\n\n# 6. è½¬æ¢æ•°æ®æ ¼å¼\nX_train, y_train = np.array(X_train), np.array(y_train)\nX_test, y_test = np.array(X_test), np.array(y_test)\n\n# å°†ç›®æ ‡å€¼æ•°æ®ç±»å‹è½¬æ¢ä¸º float32ï¼Œä»¥ä¾¿æ¨¡å‹è®­ç»ƒ\ny_train = y_train.astype(np.float32)\ny_test = y_test.astype(np.float32)\n\n# è¾“å‡ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„å½¢çŠ¶ï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®\nprint(\"X_train shape:\", X_train.shape)\nprint(\"X_test shape:\", X_test.shape)\nprint(\"y_train shape:\", y_train.shape)\nprint(\"y_test shape:\", y_test.shape)\n\n# 7. æ„å»ºå…±äº«åº•å±‚GRUç½‘ç»œ + å¤šç›®æ ‡å›å½’æ¨¡å‹\n\n# è¾“å…¥å±‚ï¼Œå½¢çŠ¶ä¸º (window_size, 4)ï¼Œå³è¿‡å»15å¤©çš„4ä¸ªç‰¹å¾\ninput_layer = Input(shape=(window_size, len(scaled_features)))\n\n# æ„å»ºå¤šå±‚GRUç½‘ç»œï¼Œæ¯å±‚åé¢éƒ½æ·»åŠ Dropoutå±‚ï¼Œä»¥é˜²æ­¢è¿‡æ‹Ÿåˆ\nx = GRU(256, return_sequences=True)(input_layer)  # ç¬¬1å±‚GRUï¼Œè¿”å›æ‰€æœ‰æ—¶é—´æ­¥çš„è¾“å‡º\nx = Dropout(0.2)(x)  # Dropoutï¼Œä¸¢å¼ƒ20%çš„ç¥ç»å…ƒ\n\nx = GRU(256, return_sequences=True)(x)  # ç¬¬2å±‚\nx = Dropout(0.2)(x)  # Dropout\n\nx = GRU(128, return_sequences=True)(x)  # ç¬¬3å±‚\nx = Dropout(0.2)(x)  # Dropout\n\nx = GRU(128, return_sequences=True)(x)  # ç¬¬4å±‚\nx = Dropout(0.2)(x)  # Dropout\n\nx = GRU(64)(x)  # ç¬¬5å±‚ï¼Œåªè¿”å›æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡º\nx = Dropout(0.2)(x)  # Dropout\n\n# 4ä¸ªç›®æ ‡åˆ—çš„ç‹¬ç«‹è¾“å‡ºå±‚ï¼Œæ¯ä¸ªè¾“å‡ºå±‚é¢„æµ‹ä¸€ä¸ªç›®æ ‡\ntemp_max_output = Dense(1, name='temp_max')(x)  # è¾“å‡ºæ¸©åº¦æœ€å¤§å€¼\ntemp_min_output = Dense(1, name='temp_min')(x)  # è¾“å‡ºæ¸©åº¦æœ€å°å€¼\nprecipitation_output = Dense(1, name='precipitation')(x)  # è¾“å‡ºé™æ°´é‡\nwind_output = Dense(1, name='wind')(x)  # è¾“å‡ºé£é€Ÿ\n\n# å®šä¹‰æ¨¡å‹ï¼Œè¾“å…¥ä¸ºè¾“å…¥å±‚ï¼Œè¾“å‡ºä¸º4ä¸ªç›®æ ‡ç‰¹å¾\nmodel = Model(inputs=input_layer, outputs=[temp_max_output, temp_min_output, precipitation_output, wind_output])\n\n# 8. ç¼–è¯‘æ¨¡å‹\n\n# å®šä¹‰åŠ æƒæŸå¤±å‡½æ•°\ndef weighted_loss(y_true, y_pred):\n    # ä¸ºæ¯ä¸ªç›®æ ‡ç‰¹å¾è®¾ç½®æƒé‡\n    temp_max_weight = 1.0\n    temp_min_weight = 1.0\n    precipitation_weight = 10.0  # ä¸ºé™æ°´å¢åŠ æƒé‡\n    wind_weight = 50.0  # ä¸ºé£é€Ÿå¢åŠ æƒé‡\n\n    # è®¡ç®—åŠ æƒçš„æŸå¤±\n    loss = K.mean(K.square(y_true - y_pred), axis=-1)  # è®¡ç®—å‡æ–¹è¯¯å·®\n    weights = K.constant([temp_max_weight, temp_min_weight, precipitation_weight, wind_weight])\n\n    return K.mean(loss * weights, axis=-1)  # è®¡ç®—åŠ æƒåçš„æŸå¤±\n\n# ç¼–è¯‘æ¨¡å‹ï¼Œä½¿ç”¨Adamä¼˜åŒ–å™¨å’Œå‡æ–¹è¯¯å·®ä½œä¸ºæŸå¤±å‡½æ•°\nmodel.compile(optimizer='adam',\n              loss='mean_squared_error',  # å¯¹æ¯ä¸ªè¾“å‡ºä½¿ç”¨å‡æ–¹è¯¯å·®\n              metrics={  # ä¸ºæ¯ä¸ªç›®æ ‡åˆ—å®šä¹‰MAEå’ŒMSEæŒ‡æ ‡\n                  'temp_max': ['mae', 'mse'],         # é’ˆå¯¹ temp_max è¾“å‡ºå®šä¹‰ MAE å’Œ MSE\n                  'temp_min': ['mae', 'mse'],         # é’ˆå¯¹ temp_min è¾“å‡ºå®šä¹‰ MAE å’Œ MSE\n                  'precipitation': ['mae', 'mse'],    # é’ˆå¯¹ precipitation è¾“å‡ºå®šä¹‰ MAE å’Œ MSE\n                  'wind': ['mae', 'mse']              # é’ˆå¯¹ wind è¾“å‡ºå®šä¹‰ MAE å’Œ MSE\n              })\n\n# 9. è®­ç»ƒæ¨¡å‹\nhistory = model.fit(X_train, [y_train[:, 0], y_train[:, 1], y_train[:, 2], y_train[:, 3]],\n                    epochs=150, batch_size=32,  # è®¾ç½®è®­ç»ƒçš„è½®æ¬¡å’Œæ¯æ‰¹æ¬¡çš„æ ·æœ¬æ•°\n                    validation_data=(X_test, [y_test[:, 0], y_test[:, 1], y_test[:, 2], y_test[:, 3]]))  # éªŒè¯é›†æ•°æ®\n\n# 10. æ¨¡å‹è¯„ä¼°ï¼Œè¿”å›æŸå¤±å€¼å’Œæ¯ä¸ªç›®æ ‡ç‰¹å¾çš„è¯„ä¼°æŒ‡æ ‡\nresults = model.evaluate(X_test, [y_test[:, 0], y_test[:, 1], y_test[:, 2], y_test[:, 3]])\n\n# results è¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«äº†æŸå¤±å€¼å’Œå„ä¸ªç›®æ ‡ç‰¹å¾çš„MAEå’ŒMSE\ntest_loss = results[0]\ntest_mae_temp_max = results[2]  # temp_max å¯¹åº”çš„ MAE\ntest_mae_temp_min = results[4]  # temp_min å¯¹åº”çš„ MAE\ntest_mae_precipitation = results[6]  # precipitation å¯¹åº”çš„ MAE\ntest_mae_wind = results[8]  # wind å¯¹åº”çš„ MAE\n\n# è¾“å‡ºè¯„ä¼°ç»“æœ\nprint(f'Test Loss (MSE): {test_loss:.4f}')\nprint(f'Test MAE for temp_max: {test_mae_temp_max:.4f}')\nprint(f'Test MAE for temp_min: {test_mae_temp_min:.4f}')\nprint(f'Test MAE for precipitation: {test_mae_precipitation:.4f}')\nprint(f'Test MAE for wind: {test_mae_wind:.4f}')\n\n# 11. å¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹\nplt.figure(figsize=(12, 6))\n\n# ç»˜åˆ¶æ€»ä½“ Lossï¼ˆMSEï¼‰\nplt.subplot(1, 2, 1)\nplt.plot(history.history['loss'], label='Train Loss')\nplt.plot(history.history['val_loss'], label='Val Loss')\nplt.title('Model Loss (MSE)')\nplt.xlabel('Epochs')\nplt.ylabel('Loss')\nplt.legend()\n\n# ç»˜åˆ¶æ¯ä¸ªè¾“å‡ºçš„ MAE\nplt.subplot(1, 2, 2)\nplt.plot(history.history['temp_max_mae'], label='Train temp_max MAE')\nplt.plot(history.history['val_temp_max_mae'], label='Val temp_max MAE')\nplt.plot(history.history['temp_min_mae'], label='Train temp_min MAE')\nplt.plot(history.history['val_temp_min_mae'], label='Val temp_min MAE')\nplt.plot(history.history['precipitation_mae'], label='Train precipitation MAE')\nplt.plot(history.history['val_precipitation_mae'], label='Val precipitation MAE')\nplt.plot(history.history['wind_mae'], label='Train wind MAE')\nplt.plot(history.history['val_wind_mae'], label='Val wind MAE')\n```\nè¿™ä¸ªæ¨¡å‹æœ¬è´¨ä¸Šæ‰§è¡Œäº†ä¸€ä¸ªå¤šå˜é‡å›å½’ä»»åŠ¡ï¼Œå…¶ä¸­å¼•å…¥äº†weighted_losså‡½æ•°ï¼Œå…¶é€šè¿‡ä¸ºæ¯ä¸ªç›®æ ‡ç‰¹å¾è®¾ç½®ä¸åŒçš„æƒé‡ï¼Œè°ƒæ•´å®ƒä»¬åœ¨æ€»æŸå¤±ä¸­çš„å½±å“åŠ›ï¼Œä½¿å¾—æ¨¡å‹åœ¨è®­ç»ƒæ—¶èƒ½å¤Ÿæ›´åŠ å…³æ³¨æŸäº›ç‰¹å¾çš„é¢„æµ‹å‡†ç¡®æ€§ã€‚è¿™å¯¹äºå¤šç›®æ ‡å›å½’ä»»åŠ¡å°¤ä¸ºé‡è¦ï¼Œç‰¹åˆ«æ˜¯åœ¨ç‰¹å¾çš„é‡è¦æ€§æˆ–å°ºåº¦å·®å¼‚è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œæœ‰åŠ©äºæé«˜æ¨¡å‹çš„é¢„æµ‹æ€§èƒ½ã€‚\n\næ¨¡å‹åœ¨ç»è¿‡ç²—ç•¥è°ƒè¯•ä¹‹åè¾“å‡ºäº†ä»¥ä¸‹ç»“æœï¼š\n\n![MSEå’ŒMAEæŒ‡æ ‡éšè¿­ä»£æ¬¡æ•°å˜åŒ–](/images/DL/weather1.png)\n\n![é¢„æµ‹ç»“æœä¸å®é™…ç»“æœå¯¹æ¯”](/images/DL/weather2.png)\n\nå¯ä»¥çœ‹å‡ºå¯¹äºæœ€é«˜æ°”æ¸©å’Œæœ€ä½æ°”æ¸©ï¼Œæ¨¡å‹ç»™å‡ºäº†éå¸¸å¥½çš„ç»“æœã€‚è¿™ä¹Ÿè·ŸGRUçš„ç‰¹æ€§æœ‰å…³ï¼Œå› ä¸ºå…¶èƒ½å°½å¯èƒ½å¤šåœ°æ•æ‰åˆ°å˜é‡ä¸æ—¶é—´çš„å…³ç³»ã€‚è€Œå¯¹äºé‚£äº›å˜åŒ–å’Œæ—¶é—´ä¸å‘ˆéå¸¸æ˜æ˜¾å…³ç³»çš„å˜é‡â€”â€”â€”â€”æ¯”å¦‚é™æ°´é‡å’Œé£é€Ÿâ€”â€”â€”â€”æ¨¡å‹ç»™å‡ºçš„ç»“æœå¹¶ä¸æ˜¯éå¸¸å°½äººæ„ï¼Œå³ä½¿è¿™ä¸¤ä¸ªå˜é‡å·²ç»è¢«æ·»åŠ äº†ç›¸å½“é«˜çš„æƒé‡ã€‚å°¤å…¶æ˜¯é™æ°´é‡ï¼Œå…¶çªå˜æ¬¡æ•°å’Œè¶‹åŠ¿æ˜æ˜¾é«˜äºå…¶ä»–å‡ ä¸ªå˜é‡ï¼Œæ¨¡å‹ä¹Ÿæ— æ³•åšå‡ºæ¯”è¾ƒå¥½çš„è®¡ç®—ç»“æœã€‚\n\nè¿™åªæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åº”ç”¨ï¼Œå¦‚æœç»“åˆå…¶ä»–æ–¹æ³•ï¼Œé¢„æµ‹å‡†ç¡®åº¦åº”å½“èƒ½è¾¾åˆ°ä¸€ä¸ªæ¯”è¾ƒé«˜çš„å€¼ã€‚\n","categories":["æ·±åº¦å­¦ä¹ "]},{"title":"STM32ä¸­çš„I2Cé€šä¿¡ã€24CXX EEPROMã€‘","url":"/2024/12/07/STM32ä¸­çš„I2Cé€šä¿¡ã€24CXX EEPROMã€‘/","content":"## I2Cç®€ä»‹\nI2Cæ˜¯ç”±æ•°æ®çº¿SDAå’Œæ—¶é’Ÿçº¿SCLæ„æˆçš„ä¸²è¡Œæ€»çº¿ï¼Œç”¨äºå‘é€æˆ–æ¥æ”¶æ•°æ®ã€‚å…¶ä¸­SDAç”¨äºä¼ è¾“æ•°æ®ã€‚SCLç”¨äºåŒæ­¥æ—¶é’Ÿä¿¡å·ã€‚I2Cè¿˜æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š\n1. ä¸»ä»æ¶æ„\n    - ä¸»æœºï¼ˆMasterï¼‰ï¼šæ§åˆ¶é€šä¿¡è¿‡ç¨‹ï¼Œç”Ÿæˆæ—¶é’Ÿä¿¡å·å¹¶å¯åŠ¨é€šä¿¡\n    - ä»æœºï¼ˆSlaveï¼‰ï¼šå“åº”ä¸»æœºæŒ‡ä»¤ï¼ŒæŒ‰åœ°å€åŒ¹é…å‚ä¸é€šä¿¡\n2. åœ°å€ï¼šæ¯ä¸ªä»è®¾å¤‡å…·æœ‰å”¯ä¸€çš„7ä½æˆ–10ä½åœ°å€ï¼Œç”¨äºè¯†åˆ«é€šä¿¡ç›®æ ‡ã€‚ä¸»è®¾å¤‡åœ¨é€šä¿¡å¼€å§‹æ—¶å‘é€ä»è®¾å¤‡åœ°å€ï¼Œä»è®¾å¤‡å“åº”åå¼€å§‹æ•°æ®ä¼ è¾“\n3. åŠåŒå·¥é€šä¿¡ï¼š æ•°æ®çº¿æ”¯æŒåŒå‘é€šä¿¡ï¼Œä½†åŒä¸€æ—¶åˆ»åªå…è®¸æ•°æ®å•å‘ä¼ è¾“\n4. æ•°æ®é€Ÿç‡ï¼š\n    - æ ‡å‡†æ¨¡å¼ï¼ˆStandard Modeï¼‰ï¼šæœ€å¤§é€Ÿç‡100 kbps\n    - å¿«é€Ÿæ¨¡å¼ï¼ˆFast Modeï¼‰ï¼šæœ€å¤§é€Ÿç‡400 kbps\n    - é«˜é€Ÿæ¨¡å¼ï¼ˆHigh-Speed Modeï¼‰ï¼šæœ€å¤§é€Ÿç‡3.4 Mbps\n5. å¼€æ¼è®¾è®¡ï¼šä¿¡å·çº¿é€šå¸¸é‡‡ç”¨å¼€æ¼é©±åŠ¨ï¼Œéœ€è¦å¤–éƒ¨ä¸Šæ‹‰ç”µé˜»å°†ä¿¡å·çº¿æ‹‰é«˜åˆ°é€»è¾‘é«˜ç”µå¹³ã€‚å› æ­¤æ€»çº¿ç©ºé—²æ—¶ï¼ŒSDAå’ŒDCLéƒ½ä¸ºé«˜ç”µå¹³ã€‚\n6. å¤šè®¾å¤‡è¿æ¥ï¼šå¯ä»¥æœ‰å¤šä¸ªå…·å¤‡ IIC é€šä¿¡èƒ½åŠ›çš„è®¾å¤‡æŒ‚è½½åœ¨ä¸Šé¢ï¼ŒåŒæ—¶æ”¯æŒå¤šä¸ªä¸»æœºå’Œå¤šä¸ªä»æœºï¼Œè¿æ¥åˆ°æ€»çº¿çš„æ¥å£æ•°é‡åªç”±æ€»çº¿ç”µå®¹ 400pF çš„é™åˆ¶å†³å®šã€‚\n\n## I2Cæ—¶åºå’Œè¯»å†™æ“ä½œ\n### æ—¶åºä¿¡å·\n![I2Cæ€»çº¿æ—¶åºå›¾](/images/arm/i2c1.png)\n1. èµ·å§‹ä¿¡å·ï¼šä¸»æœºå‘å‡ºï¼Œä¸ºç”µå¹³è·³å˜ä¿¡å·è€Œéæ’ç”µå¹³ä¿¡å·ã€‚SCLä¸ºé«˜ç”µå¹³æœŸé—´ï¼ŒSDAç”±é«˜ç”µå¹³è·³å˜è‡³ä½ç”µå¹³ï¼Œæ€»çº¿è¢«å ç”¨ï¼Œå‡†å¤‡æ•°æ®ä¼ è¾“\n2. åœæ­¢ä¿¡å·ï¼šä¸»æœºå‘å‡ºï¼Œä¸ºç”µå¹³è·³å˜ä¿¡å·è€Œéæ’ç”µå¹³ä¿¡å·ã€‚SCLä¸ºé«˜ç”µå¹³æœŸé—´ï¼ŒSDAç”±ä½ç”µå¹³è·³å˜è‡³é«˜ç”µå¹³ï¼Œæ€»çº¿ç©ºé—²\n3. åº”ç­”ä¿¡å·ï¼šå‘é€å™¨æ¯å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œå°±åœ¨æ—¶é’Ÿè„‰å†² 9 æœŸé—´é‡Šæ”¾æ•°æ®çº¿ï¼Œç”±æ¥æ”¶å™¨åé¦ˆä¸€ä¸ªåº”ç­”ä¿¡å·ã€‚åº”ç­”ä¿¡å·ä¸ºä½ç”µå¹³æ—¶ï¼Œè§„å®šä¸ºæœ‰æ•ˆåº”ç­”ä½ï¼ˆACK ç®€ç§°åº”ç­”ä½ï¼‰ï¼Œè¡¨ç¤ºæ¥æ”¶å™¨å·²ç»æˆåŠŸåœ°æ¥æ”¶äº†è¯¥å­—èŠ‚ã€‚åº”ç­”ä¿¡å·ä¸ºé«˜ç”µå¹³æ—¶ï¼Œè§„å®šä¸ºéåº”ç­”ä½ï¼ˆNACKï¼‰ï¼Œä¸€èˆ¬è¡¨ç¤ºæ¥æ”¶å™¨æ¥æ”¶è¯¥å­—èŠ‚æ²¡æœ‰æˆåŠŸ\n4. æ•°æ®æœ‰æ•ˆæ€§ï¼šæ€»çº¿è¿›è¡Œæ•°æ®ä¼ é€æ—¶ï¼Œæ—¶é’Ÿä¿¡å·ä¸ºé«˜ç”µå¹³æœŸé—´ï¼Œæ•°æ®çº¿ä¸Šçš„æ•°æ®å¿…é¡»ä¿æŒç¨³å®šï¼Œåªæœ‰åœ¨æ—¶é’Ÿçº¿ä¸Šçš„ä¿¡å·ä¸ºä½ç”µå¹³æœŸé—´ï¼Œæ•°æ®çº¿ä¸Šçš„é«˜ç”µå¹³æˆ–ä½ç”µå¹³çŠ¶æ€æ‰å…è®¸å˜åŒ–ã€‚æ•°æ®åœ¨ SCL çš„ä¸Šå‡æ²¿åˆ°æ¥ä¹‹å‰å°±éœ€å‡†å¤‡å¥½ã€‚å¹¶åœ¨ä¸‹é™æ²¿åˆ°æ¥ä¹‹å‰å¿…é¡»ç¨³å®š\n5. æ•°æ®ä¼ è¾“ï¼šæ€»çº¿ä¸Šä¼ é€çš„æ¯ä¸€ä½æ•°æ®éƒ½æœ‰ä¸€ä¸ªæ—¶é’Ÿè„‰å†²ç›¸å¯¹åº”ï¼ˆæˆ–åŒæ­¥æ§åˆ¶ï¼‰ï¼Œå³åœ¨ SCL ä¸²è¡Œæ—¶é’Ÿçš„é…åˆä¸‹ï¼Œåœ¨ SDA ä¸Šé€ä½åœ°ä¸²è¡Œä¼ é€æ¯ä¸€ä½æ•°æ®ã€‚æ•°æ®ä½çš„ä¼ è¾“æ˜¯è¾¹æ²¿è§¦å‘\n6. ç©ºé—²çŠ¶æ€ï¼šSDA å’Œ SCLä¸¤æ¡ä¿¡å·çº¿åŒæ—¶å¤„äºé«˜ç”µå¹³æ—¶ï¼Œè§„å®šä¸ºæ€»çº¿çš„ç©ºé—²çŠ¶æ€ã€‚æ­¤æ—¶å„ä¸ªå™¨ä»¶çš„è¾“å‡ºçº§åœºæ•ˆåº”ç®¡å‡å¤„åœ¨æˆªæ­¢çŠ¶æ€ï¼Œå³é‡Šæ”¾æ€»çº¿ï¼Œç”±ä¸¤æ¡ä¿¡å·çº¿å„è‡ªçš„ä¸Šæ‹‰ç”µé˜»æŠŠç”µå¹³æ‹‰é«˜\n\n### å†™æ“ä½œ\n![I2Cå†™æ“ä½œé€šè®¯](/images/arm/i2c2.png)\n\n1. ä¸»æœºå‘é€èµ·å§‹ä¿¡å·ï¼Œä»¤æ€»çº¿ä¸Šçš„æ‰€æœ‰ä»æœºç­‰å¾…æ¥æ”¶æ•°æ®\n2. ä¸»æœºå‘é€ä»æœºåœ°å€+'0'ï¼ˆå†™æ“ä½œï¼‰ç»„æˆçš„8ä½æ•°æ®ã€‚ä»æœºæ¥æ”¶åˆ°åœ°å€åï¼Œæ¯”å¯¹è¯¥åœ°å€æ˜¯å¦ä¸ºæœ¬æœºåœ°å€ã€‚è‹¥ä¸ºæœ¬æœºåœ°å€ï¼Œä»æœºå‘é€åº”ç­”ä¿¡å·\n3. ä¸»æœºå‘ä»æœºå‘é€æ•°æ®\n\n### è¯»æ“ä½œ\n![I2Cè¯»æ“ä½œé€šè®¯](/images/arm/i2c3.png)\n\n1. ä¸»æœºå‘é€èµ·å§‹ä¿¡å·ï¼Œä»¤æ€»çº¿ä¸Šçš„æ‰€æœ‰ä»æœºç­‰å¾…æ¥æ”¶æ•°æ®\n2. ä¸»æœºå‘é€ä»æœºåœ°å€+'1'ï¼ˆè¯»æ“ä½œï¼‰ç»„æˆçš„8ä½æ•°æ®ã€‚ä»æœºæ¥æ”¶åˆ°åœ°å€åï¼Œæ¯”å¯¹è¯¥åœ°å€æ˜¯å¦ä¸ºæœ¬æœºåœ°å€ã€‚è‹¥ä¸ºæœ¬æœºåœ°å€ï¼Œä»æœºå‘é€åº”ç­”ä¿¡å·\n3. ä»æœºå‘ä¸»æœºå‘é€æ•°æ®\n\nè‹¥ä¸»æœºä¸€ç›´è¿”å›åº”ç­”ä¿¡å·ï¼Œé‚£ä¹ˆä»æœºå¯ä»¥ä¸€ç›´å‘é€æ•°æ®ï¼Œç›´åˆ°ä¸»æœºå‘é€NACKä¿¡å·ä¸ºæ­¢ã€‚\n\n## 24C02æ—¶åº\n24C02 æ˜¯ä¸€ä¸ª 2K bit çš„ä¸²è¡Œ EEPROM å­˜å‚¨å™¨ï¼Œå†…éƒ¨å«æœ‰ 256 ä¸ªå­—èŠ‚ã€‚åœ¨ 24C02 é‡Œé¢è¿˜æœ‰ä¸€ä¸ª 8 å­—èŠ‚çš„é¡µå†™ç¼“å†²å™¨ã€‚è¯¥è®¾å¤‡çš„é€šä¿¡æ–¹å¼ä¸º IICï¼Œé€šè¿‡å…¶ SCL å’Œ SDA ä¸å…¶ä»–è®¾å¤‡é€šä¿¡ã€‚\n\n![24C02å¼•è„š](/images/arm/24c021.png)\n\nWPä¸ºå†™ä¿æŠ¤å¼•è„šï¼Œé«˜ç”µå¹³åªè¯»ï¼Œä½ç”µå¹³å¼€æ”¾è¯»å†™åŠŸèƒ½ã€‚24C02çš„è®¾å¤‡åœ°å€å…±8ä½ï¼ŒåŒ…å«ä¸å¯ç¼–ç¨‹éƒ¨åˆ†å’Œå¯ç¼–ç¨‹éƒ¨åˆ†ï¼Œå¯ç¼–ç¨‹éƒ¨åˆ†æ ¹æ®ç¡¬ä»¶Pin A0ã€A1ã€A2å†³å®šï¼›è®¾å¤‡åœ°å€æœ€åä¸€ä½ç”¨äºè®¾ç½®æ˜¯è¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œã€‚å…·ä½“ä¸ºï¼š\n\n![24C02è®¾å¤‡åœ°å€æ ¼å¼](/images/arm/24c022.png)\n\næœ¬æ–‡ä¸­A0ã€A1ã€A2å‡æ¥åœ°ï¼Œæ•…24C02è®¾å¤‡è¯»æ“ä½œåœ°å€ä¸º`0xA1`ï¼Œå†™æ“ä½œåœ°å€ä¸º`0xA0`ã€‚\n\n## 24C02è¯»å†™æ“ä½œ\n\n![24C02å†™æ—¶åº](/images/arm/24c023.png)\n\nä¸»æœºåœ¨ IIC æ€»çº¿å‘é€ç¬¬ 1 ä¸ªå­—èŠ‚çš„æ•°æ®ä¸º24C02çš„è®¾å¤‡åœ°å€`0xA0`ï¼Œç”¨äºå¯»æ‰¾æ€»çº¿ä¸Šçš„24C02ï¼Œåœ¨è·å¾—24C02çš„åº”ç­”ä¿¡å·ä¹‹åï¼Œç»§ç»­å‘é€ç¬¬ 2 ä¸ªå­—èŠ‚æ•°æ®ï¼Œè¯¥å­—èŠ‚æ•°æ®æ˜¯ 24C02 çš„å†…å­˜åœ°å€ï¼Œå†ç­‰åˆ° 24C02 çš„åº”ç­”ä¿¡å·ï¼Œä¸»æœºç»§ç»­å‘é€ç¬¬ 3 å­—èŠ‚æ•°æ®ï¼Œè¿™é‡Œçš„æ•°æ®å³æ˜¯å†™å…¥åœ¨ç¬¬ 2 å­—èŠ‚å†…å­˜åœ°å€çš„æ•°æ®ã€‚ä¸»æœºå®Œæˆå†™æ“ä½œåï¼Œå¯ä»¥å‘å‡ºåœæ­¢ä¿¡å·ï¼Œç»ˆæ­¢æ•°æ®ä¼ è¾“ã€‚è¿™ç§å†™æ“ä½œæ¯æ¬¡åªèƒ½å†™å…¥1å­—èŠ‚æ•°æ®ã€‚\n\n![24C02é¡µå†™æ—¶åº](/images/arm/24c024.png)\n\nå†™æ“ä½œæ—¶ï¼Œ24C02å¯ä»¥ä½¿ç”¨é¡µå†™æ—¶åºï¼Œå…¶å’Œæ™®é€šå†™æ—¶åºçš„åŒºåˆ«æ˜¯é¡µå†™æ—¶åºåªéœ€è¦å‘ŠçŸ¥ä¸€æ¬¡å†…å­˜åœ°å€1ï¼Œåé¢çš„æ•°æ®ä¼šæŒ‰ç…§å†™å…¥é¡ºåºå­˜å…¥å†…å­˜åœ°å€2ã€å†…å­˜åœ°å€3ç­‰ï¼ŒèŠ‚çœé€šä¿¡æ—¶é—´ã€‚\n\n![24C02è¯»æ—¶åº](/images/arm/24c025.png)\n\n24C02è¯»å–æ•°æ®çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¤åˆçš„æ—¶åºï¼Œå…¶ä¸­åŒ…å«å†™æ—¶åºå’Œè¯»æ—¶åºã€‚é€šå¸¸ç¬¬ä¸€ä¸ªé€šä¿¡è¿‡ç¨‹ä¸ºå†™æ—¶åºï¼Œèµ·å§‹ä¿¡å·äº§ç”Ÿåï¼Œä¸»æœºå‘é€24C02è®¾å¤‡åœ°å€`0xA0`ï¼Œè·å–ä»æœºåº”ç­”ä¿¡å·åï¼Œæ¥ç€å‘é€éœ€è¦è¯»å–çš„å†…å­˜åœ°å€ï¼›åœ¨éšåçš„è¯»æ—¶åºä¸­ï¼Œèµ·å§‹ä¿¡å·äº§ç”Ÿåï¼Œä¸»æœºå‘é€24C02è®¾å¤‡åœ°å€`0xA1`, è·å–ä»æœºåº”ç­”ä¿¡å·åï¼Œä»æœºè¿”å›åˆšåˆšåœ¨å†™æ—¶åºä¸­ä¼ é€’çš„å†…å­˜åœ°å€çš„æ•°æ®ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ä¼ è¾“åœ¨æ€»çº¿ä¸Šï¼Œå‡å¦‚ä¸»æœºè·å–æ•°æ®åè¿”å›çš„æ˜¯åº”ç­”ä¿¡å·ï¼Œé‚£ä¹ˆä»æœºä¼šä¸€ç›´ä¼ è¾“æ•°æ®ï¼Œå½“ä¸»æœºå‘å‡ºçš„æ˜¯éåº”ç­”ä¿¡å·å¹¶ä»¥åœæ­¢ä¿¡å·å‘å‡ºä¸ºç»“æŸï¼Œä»æœºç»“æŸä¼ è¾“ã€‚\n\n## è½¯ä»¶æ¨¡æ‹ŸI2C\nHALåº“è‡ªå¸¦çš„ç¡¬ä»¶I2Cå‡½æ•°æ¯”è¾ƒå¤æ‚ï¼Œå¤šé‡‡ç”¨è½¯ä»¶æ¨¡æ‹ŸI2Cçš„æ–¹å¼æ“ä½œGPIOä»¥è·å¾—I2Cæ—¶åºã€‚\n### custom_i2c.hï¼ˆå¤´æ–‡ä»¶ï¼‰\n```\n/**\n ****************************************************************************************************\n * @file        custom_i2c.h\n * @author      Aki\n * @version     V1.0\n * @date        2024-12-11\n * @brief       è½¯ä»¶IICå¤´æ–‡ä»¶\n ****************************************************************************************************\n */\n\n#ifndef __MYIIC_H\n#define __MYIIC_H\n\n#include \"sys.h\"\n\n\n/******************************************************************************************/\n/* å¼•è„šå®šä¹‰ */\n\n#define IIC_SCL_GPIO_PORT               GPIOH\n#define IIC_SCL_GPIO_PIN                GPIO_PIN_4\n#define IIC_SCL_GPIO_CLK_ENABLE()       do{ __HAL_RCC_GPIOH_CLK_ENABLE(); }while(0)   /* PHå£æ—¶é’Ÿä½¿èƒ½ */\n\n#define IIC_SDA_GPIO_PORT               GPIOH\n#define IIC_SDA_GPIO_PIN                GPIO_PIN_5\n#define IIC_SDA_GPIO_CLK_ENABLE()       do{ __HAL_RCC_GPIOH_CLK_ENABLE(); }while(0)   /* PHå£æ—¶é’Ÿä½¿èƒ½ */\n\n/******************************************************************************************/\n/* IOæ“ä½œ */\n\n#define IIC_SCL(x)        do{ x ? \\\n                              HAL_GPIO_WritePin(IIC_SCL_GPIO_PORT, IIC_SCL_GPIO_PIN, GPIO_PIN_SET) : \\\n                              HAL_GPIO_WritePin(IIC_SCL_GPIO_PORT, IIC_SCL_GPIO_PIN, GPIO_PIN_RESET); \\\n                          }while(0)       /* SCL */\n\n#define IIC_SDA(x)        do{ x ? \\\n                              HAL_GPIO_WritePin(IIC_SDA_GPIO_PORT, IIC_SDA_GPIO_PIN, GPIO_PIN_SET) : \\\n                              HAL_GPIO_WritePin(IIC_SDA_GPIO_PORT, IIC_SDA_GPIO_PIN, GPIO_PIN_RESET); \\\n                          }while(0)       /* SDA */\n\n#define IIC_READ_SDA     HAL_GPIO_ReadPin(IIC_SDA_GPIO_PORT, IIC_SDA_GPIO_PIN)        /* è¯»å–SDAç”µå¹³ */\n\n/******************************************************************************************/\n\nvoid iic_init(void);                        \nvoid iic_start(void);                       \nvoid iic_stop(void);                      \nvoid iic_ack(void);                        \nvoid iic_nack(void);                       \nuint8_t iic_wait_ack(void);                 \nvoid iic_send_byte(uint8_t data);          \nuint8_t iic_read_byte(unsigned char ack);   \n\n#endif\n```\nè¿™é‡Œå®å®šä¹‰åˆ©ç”¨äº†ä¸¤ä¸ªå°æŠ€å·§ï¼š\n- ä¸‰ç›®è¿ç®—ç¬¦ï¼šx ? ... : ... æ˜¯ä¸€ä¸ªæ¡ä»¶ï¼ˆä¸‰ç›®ï¼‰è¿ç®—ç¬¦ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼šæ ¹æ® x çš„å€¼ï¼ˆx æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼‰ï¼Œåˆ¤æ–­æ‰§è¡Œå“ªä¸€éƒ¨åˆ†ä»£ç ã€‚å¦‚æœ x ä¸º trueï¼ˆéé›¶ï¼‰ï¼Œæ‰§è¡Œå†’å·å‰çš„è¡¨è¾¾å¼ï¼›å¦‚æœ x ä¸º falseï¼ˆé›¶ï¼‰ï¼Œæ‰§è¡Œå†’å·åçš„è¡¨è¾¾å¼ã€‚\n- `do { ... } while(0)`ï¼šç¡®ä¿å®åªæ‰§è¡Œä¸€æ¬¡ä¸”ä¸ä¼šå¹²æ‰°å¤–éƒ¨ä»£ç ç»“æ„çš„æƒ¯ç”¨æ³•ã€‚è¿™æ ·åšå¯ä»¥ç¡®ä¿å®åœ¨ä½¿ç”¨æ—¶ï¼Œä»£ç ä¸ä¼šå› ç¼ºå°‘æ‹¬å·è€Œå¼•å‘è¯­æ³•é”™è¯¯ã€‚\n\n\n### custom_i2c.c\n#### åˆå§‹åŒ–\n```\n/** \n    @brief:IICåˆå§‹åŒ–\n    @param:NULL\n    @return:NULL\n**/\nvoid iic_init(void)\n{\n    GPIO_InitTypeDef gpio_init_struct;\n\n    IIC_SCL_GPIO_CLK_ENABLE();  /* SCLå¼•è„šæ—¶é’Ÿä½¿èƒ½ */\n    IIC_SDA_GPIO_CLK_ENABLE();  /* SDAå¼•è„šæ—¶é’Ÿä½¿èƒ½ */\n\n    /* SCL */\n    gpio_init_struct.Pin = IIC_SCL_GPIO_PIN;\n    gpio_init_struct.Mode = GPIO_MODE_OUTPUT_PP;    /* æ¨æŒ½è¾“å‡º */\n    gpio_init_struct.Pull = GPIO_PULLUP;            /* ä¸Šæ‹‰ */\n    gpio_init_struct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;\n    HAL_GPIO_Init(IIC_SCL_GPIO_PORT, &gpio_init_struct);\n\n    /* SDA */\n    gpio_init_struct.Pin = IIC_SDA_GPIO_PIN;\n    gpio_init_struct.Mode = GPIO_MODE_OUTPUT_OD;    /* å¼€æ¼è¾“å‡º */\n    HAL_GPIO_Init(IIC_SDA_GPIO_PORT, &gpio_init_struct);\n\n    iic_stop();     /* åœæ­¢æ€»çº¿ä¸Šæ‰€æœ‰è®¾å¤‡ */\n}\n```\nè¿™é‡ŒSDAçº¿ä½¿ç”¨å¼€æ¼è¾“å‡ºï¼Œè¿™æ„å‘³ç€å½“SDAå¼•è„šè¾“å‡ºä½ç”µå¹³æ—¶ï¼Œè®¾å¤‡ç›´æ¥å°†çº¿æ‹‰ä½ï¼ˆè¾“å‡ºä½ç”µå¹³ï¼‰ï¼›è€Œå½“è®¾å¤‡è¾“å‡ºé«˜ç”µå¹³æ—¶ï¼Œå®ƒå¹¶ä¸ç›´æ¥å°†çº¿æ‹‰é«˜ï¼Œè€Œæ˜¯å°†SDAå¼•è„šè®¾ç½®ä¸ºé«˜é˜»æ€ï¼ˆå³ä¸é©±åŠ¨è¯¥å¼•è„šã€‚å½“ä¸€ä¸ªè®¾å¤‡å¸Œæœ›å‘é€æ•°æ®æ—¶ï¼Œå¦‚æœå®ƒéœ€è¦è¾“å‡º0ï¼ˆä½ç”µå¹³ï¼‰ï¼Œå®ƒä¼šç›´æ¥å°†SDAå¼•è„šæ‹‰ä½ã€‚å½“å®ƒéœ€è¦å‘é€1ï¼ˆé«˜ç”µå¹³ï¼‰ï¼Œå®ƒä¸ä¼šç›´æ¥å°†SDAå¼•è„šæ‹‰é«˜ï¼Œè€Œæ˜¯è®©SDAå¼•è„šå¤„äºé«˜é˜»æ€ï¼Œè®©æ€»çº¿ä¸Šçš„å…¶ä»–è®¾å¤‡ï¼ˆå¦‚æœæœ‰ï¼‰é€šè¿‡æ‹‰é«˜SDAçº¿æ¥å®ç°é«˜ç”µå¹³ã€‚è¿™ä¹ˆåšå¯ä»¥æœ‰æ•ˆé¿å…è¿æ¥å¤šä¸ªä»æœºæ—¶å‘ç”Ÿç”µå¹³å†²çªã€‚STM32F429ä½¿ç”¨å¼€æ¼æ¨¡å¼æ—¶ï¼Œå¿…é¡»å¤–ç•Œä¸Šæ‹‰ç”µé˜»ã€‚\n\n#### å»¶æ—¶\n```\n/** \n    @brief:IICå»¶æ—¶å‡½æ•°\n    @param:NULL\n    @return:NULL\n**/\nstatic void iic_delay(void)\n{\n    delay_us(2);    /* è¯»å†™é€Ÿåº¦åœ¨250Khzä»¥å†… */\n}\n```\nä¸ºè·å¾—ç¨³å®šçš„è¯»å†™ç»“æœï¼Œéœ€é™åˆ¶è¯»å†™é€Ÿåº¦ï¼Œæ­¤å¤„é€šè¿‡å»¶æ—¶2usçš„å½¢å¼å®ç°ã€‚\n\n#### èµ·å§‹ä¿¡å·ä¸åœæ­¢ä¿¡å·\n```\n/** \n    @brief:IICèµ·å§‹ä¿¡å·\n    @param:NULL\n    @return:NULL\n**/\nvoid iic_start(void)\n{\n    IIC_SDA(1);\n    IIC_SCL(1);\n    iic_delay();\n    IIC_SDA(0);   /* STARTä¿¡å· */\n    iic_delay();\n    IIC_SCL(0);   /* é’³ä½æ€»çº¿ï¼Œå‡†å¤‡å‘é€æˆ–æ¥æ”¶æ•°æ®ï¼ˆSCLåªæœ‰ä½ç”µå¹³æœŸé—´å…è®¸æ”¹å˜SDAçŠ¶æ€ï¼‰ */\n    iic_delay();\n}\n\n\n/** \n    @brief:IICåœæ­¢ä¿¡å·\n    @param:NULL\n    @return:NULL\n**/\nvoid iic_stop(void)\n{\n    IIC_SDA(0);     /* STOPä¿¡å· */\n    iic_delay();\n    IIC_SCL(1);\n    iic_delay();\n    IIC_SDA(1);     /* æ€»çº¿ç»“æŸä¿¡å· */\n    iic_delay();\n}\n```\n![STARTå’ŒSTOPæ—¶åº](/images/arm/i2c4.png)\n\næ ¹æ®IICæ—¶åºå›¾ï¼Œèµ·å§‹ä¿¡å·å’Œåœæ­¢ä¿¡å·åˆ†åˆ«ä¸ºï¼š\n\n- STARTï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»1è·³å˜è‡³0\n- STOPï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»0è·³å˜è‡³1\n\nä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°å®ç°çš„å°±æ˜¯è¿™ä¸ªåŠŸèƒ½ï¼ŒåŒæ—¶åŠ å…¥äº†å»¶æ—¶æ¥ä¿è¯èƒ½å¾—åˆ°ç¨³å®šçš„ç”µå¹³ã€‚éœ€è¦æ³¨æ„ï¼Œåœæ­¢ä¿¡å·å‘å‡ºæ—¶ï¼ŒSCLéœ€è¦åœ¨SDAç”µå¹³å¼€å§‹è·³å˜å‰å°±ä¿æŒé«˜ç”µå¹³ã€‚\n\n#### å‘é€å­—èŠ‚\n```\n/** \n    @brief:IICå‘é€ä¸€ä¸ªå­—èŠ‚\n    @param:dataï¼šè¦å‘é€çš„æ•°æ®\n    @return:NULL\n**/\nvoid iic_send_byte(uint8_t data)\n{\n    uint8_t t;\n\n    for (t = 0; t < 8; t++)\n    {\n        IIC_SDA((data & 0x80) >> 7);    /* æå–é«˜ä½ */\n        iic_delay();\n        IIC_SCL(1);     /* æ‹‰é«˜SCLå¹¶ç»´æŒé«˜ç”µå¹³ï¼Œå¼€å§‹å‘é€ */\n        iic_delay();\n        IIC_SCL(0);     /* å‘é€ç»“æŸï¼Œæ‹‰ä½SCLï¼Œå‡†å¤‡ä¸‹ä¸€ä½æ•°æ® */\n        data <<= 1;     /* å·¦ç§»1ä½ï¼Œå¾ªç¯å‘é€ */\n    }\n    IIC_SDA(1);     /* å‘é€å®Œæˆï¼Œé‡Šæ”¾SDAçº¿ */\n}\n```\n![I2Cå‘é€æ—¶åº](/images/arm/i2c5.png)\n\nå‘é€å­—èŠ‚æ—¶ï¼Œç”±äºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…I2Cåªèƒ½å‘é€ä¸€ä½(bit)æ•°æ®ï¼Œå› æ­¤å‘é€éœ€è¦å¾ªç¯8æ¬¡ï¼Œæ¨¡æ‹Ÿ8ä¸ªæ—¶é’Ÿä¿¡å·ï¼Œæ‰èƒ½æŠŠå½¢å‚çš„8ä½æ•°æ®éƒ½å‘é€å‡ºå»ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦æå–å‡ºå½¢å‚çš„æ¯ä¸€ä½å¹¶å‘é€ã€‚è¿™é‡Œä½¿ç”¨äº†`(data & 0x80) >> 7`çš„æ–¹å¼ã€‚`(data & 0x80)`æ˜¯å°†å½¢å‚ä¸`0x80`ï¼Œä¹Ÿå°±æ˜¯`10000000`è¿›è¡Œä¸è¿ç®—ï¼Œç„¶åå³ç§»7ä½ï¼Œæå–å‡ºå½¢å‚çš„æœ€é«˜ä½ã€‚å¦‚æœæœ€é«˜ä½æ˜¯1ï¼Œé‚£ä¹ˆSDAå°±æ‹‰é«˜ï¼›åä¹‹SDAåˆ™æ‹‰ä½ã€‚æ¯ä¸ªå‘¨æœŸå®Œæˆåï¼Œdataå·¦ç§»1ä½ï¼Œå°†åŸå…ˆæ˜¯æ¬¡é«˜ä½çš„æ•°ç§»åˆ°æœ€é«˜ä½ï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹8æ¬¡ã€‚å…¨éƒ¨å‘é€å®Œæˆåï¼Œé‡Šæ”¾SDAçº¿ã€‚\n#### è¯»å–å­—èŠ‚\n```\n/** \n    @brief:IICè¯»å–ä¸€ä¸ªå­—èŠ‚\n    @param:ack: ack=1æ—¶ï¼Œå‘é€ack; ack=0æ—¶ï¼Œå‘é€nack\n    @return:æ¥æ”¶åˆ°çš„æ•°æ®\n**/\nuint8_t iic_read_byte(uint8_t ack)\n{\n    uint8_t i, receive = 0x00;\n\n    /* 1ä¸ªå­—èŠ‚å…±8ä½ï¼Œå•æ¬¡æ¥æ”¶1ä½ï¼Œå¾ªç¯8æ¬¡ */\n    for (i = 0; i < 8; i++)\n    {\n        receive <<= 1;      /* è¾“å‡ºæ—¶é«˜ä½å…ˆè¾“å‡ºï¼Œå› æ­¤æ¥æ”¶æ—¶å…ˆæ”¶åˆ°çš„æ•°æ®æ˜¯é«˜ä½ï¼Œè¦å·¦ç§» */\n        IIC_SCL(1);         /* æ‹‰é«˜SCLï¼ŒSDAå‡†å¤‡æ¥æ”¶ */\n        iic_delay();\n\n        if (IIC_READ_SDA)   /* å¦‚æœSDAä¸ºé«˜ç”µå¹³ */\n        {\n            receive++;      /* ç¬¬0ä½ï¼ˆä½ä½ï¼‰ç½®1 */\n        }\n\n        IIC_SCL(0);         /* æ¥æ”¶ç»“æŸï¼Œæ‹‰ä½SCL */\n        iic_delay();\n    }\n\n    if (!ack)\n    {\n        iic_nack();         /* å‘é€nACKä¿¡å· */\n    }\n    else\n    {\n        iic_ack();          /* å‘é€ACKä¿¡å· */\n    }\n\n    return receive;\n}\n```\nåœ¨æ—¶åºæ–¹é¢ï¼ŒI2Cè¯»å–å­—èŠ‚å’Œå†™å…¥å­—èŠ‚æ˜¯ä¸€è‡´çš„ã€‚\n\n#### åº”ç­”ä¿¡å·ï¼ˆACKï¼‰\n```\n/** \n    @brief:ç­‰å¾…åº”ç­”ä¿¡å·\n    @param:NULL\n    @return:1=å¤±è´¥ï¼›0=æˆåŠŸ\n**/\nuint8_t iic_wait_ack(void)\n{\n    uint8_t waittime = 0;\n    uint8_t rack = 0;\n\n    IIC_SDA(1);     /* ä¸»æœºé‡Šæ”¾SDAï¼ˆå¤–éƒ¨å™¨ä»¶æ­¤æ—¶å¯æ‹‰ä½SDAç”µå¹³ï¼‰ */\n    iic_delay();\n    IIC_SCL(1);     /* æ‹‰é«˜SCLï¼Œä»æœºæ­¤æ—¶å¯è¿”å›ACK */\n    iic_delay();\n\n    while (IIC_READ_SDA)    /* ç­‰å¾…åº”ç­” */\n    {\n        waittime++;\n\n        if (waittime > 250)\n        {\n            iic_stop();\n            rack = 1;\n            break;\n        }\n    }\n\n    IIC_SCL(0);     /* SCL=0ï¼Œç»“æŸACKæ£€æŸ¥ */\n    iic_delay();\n    return rack;\n}\n```\nç­‰å¾…åº”ç­”ä¿¡å·ä¸€èˆ¬ç”¨åœ¨å†™æ—¶åºä¸­ï¼Œåœ¨`iic_send_byte`åè°ƒç”¨ã€‚å½“è¯»å–åˆ°SDAä¸ºä½ç”µå¹³æ—¶ï¼Œè¡¨ç¤ºACKä¿¡å·ï¼›SDAä¸ºé«˜ç”µå¹³åˆ™ä¸ºNACKä¿¡å·ã€‚è‹¥ç­‰å¾…è¶…æ—¶ï¼Œåˆ™ä¸»æœºä¼šç›´æ¥å‘å‡ºåœæ­¢ä¿¡å·ã€‚è‹¥æ­£å¸¸æ¥æ”¶åˆ°ACKä¿¡å·ï¼Œä¸»æœºæ‹‰ä½SCLçº¿ï¼Œè¿”å›flagã€‚è¿™ä¸€æ®µå†…å®¹å¯¹åº”æ€»çº¿æ—¶åºå›¾ä¸­çš„çº¢åœˆ3ï¼Œä¹Ÿå°±æ˜¯è„‰å†²9ã€‚\n```\n/** \n    @brief:äº§ç”ŸACKåº”ç­”\n    @param:NULL\n    @return:NULL\n    @noteï¼šACKåº”ç­”æ—¶ï¼ŒSDAæ‹‰ä½ï¼ŒSCL=0->1->0\n**/\nvoid iic_ack(void)\n{\n    IIC_SDA(0);     \n    iic_delay();\n    IIC_SCL(1);     \n    iic_delay();\n    IIC_SCL(0);     \n    iic_delay();\n    IIC_SDA(1);     \n    iic_delay();\n}\n\n/** \n    @brief:ä¸äº§ç”ŸACKåº”ç­”ï¼ˆNACKï¼‰\n    @param:NULL\n    @return:NULL\n    @noteï¼šNACKåº”ç­”æ—¶ï¼ŒSDAæ‹‰é«˜ï¼ŒSCL=0->1->0\n**/\nvoid iic_nack(void)\n{\n    IIC_SDA(1);\n    iic_delay();\n    IIC_SCL(1);\n    iic_delay();\n    IIC_SCL(0);\n    iic_delay();\n}\n```\nä»¥ä¸Šä¸¤ä¸ªå‡½æ•°ç”¨äºä¸»æœºä½œä¸ºæ¥æ”¶ç«¯æ—¶ï¼Œåœ¨æ¥æ”¶å®Œæ•°æ®åå‘ä»æœºè¿”å›ACKæˆ–NACKä¿¡å·ã€‚äºŒè€…å¯¹åº”çš„ä¹Ÿæ˜¯çº¿æ—¶åºå›¾ä¸­çš„çº¢åœˆ3ï¼Œä¹Ÿå°±æ˜¯è„‰å†²9ã€‚\n\n## 24CXX EEPROM é©±åŠ¨\n### å†™æ“ä½œ\n```\n/**\n* @brief å‘ AT24CXX æŒ‡å®šåœ°å€å†™å…¥ä¸€ä¸ªæ•°æ®\n* @param addr: å†™å…¥æ•°æ®çš„ç›®çš„åœ°å€\n* @param data: è¦å†™å…¥çš„æ•°æ®\n* @retval æ— \n*/\nvoid at24cxx_write_one_byte(uint16_t addr, uint8_t data)\n{\n    iic_start();       /* IICèµ·å§‹ä¿¡å· */\n\n    if (EE_TYPE > AT24C16)  /* å®¹é‡å¤§äº24C16æ—¶åˆ†2ä¸ªå­—èŠ‚å‘é€ç›®æ ‡å†…å­˜åœ°å€ */\n    {\n        iic_send_byte(0xA0);    /* å‘é€å†™å‘½ä»¤ï¼Œä»æœºè®¾å¤‡åœ°å€ä¸º0xA0ï¼Œæœ€ä½ä½ä¸º0è¡¨ç¤ºå†™å…¥ */\n        iic_wait_ack();         /* å‘é€å®Œä¸€ä¸ªå­—èŠ‚åç­‰å¾…ACK */\n        iic_send_byte(addr >> 8);   /* å‘é€é«˜ä½å†…å­˜åœ°å€ */\n    }\n    else\n    {\n        iic_send_byte(0xA0 + ((addr >> 8) << 1));   /* å‘é€å™¨ä»¶0xA0 + é«˜ä½a8/a9/a10åœ°å€ï¼Œå†™æ•°æ® */\n    }\n\n    iic_wait_ack();\n    iic_send_byte(addr % 256);  /* å‘é€ä½ä½å†…å­˜åœ°å€ */\n    iic_wait_ack();\n\n    iic_send_byte(data);    /* å‘é€1ä¸ªå­—èŠ‚ */\n    iic_wait_ack();\n    iic_stop();\n    delay_ms(10);       /* EEPROMå†™å…¥é€Ÿåº¦æ…¢ï¼Œå¿…é¡»ç­‰å¾…å†™å…¥å®Œæˆå†å†™ä¸‹ä¸€ä¸ª */\n}\n```\n24CXXçš„å†™æ“ä½œä¸»è¦åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼šå†™å…¥è®¾å¤‡åœ°å€ï¼Œå†™å…¥ç›®æ ‡å†…å­˜åœ°å€ï¼Œå†™å…¥å¾…ä¼ è¾“æ•°æ®ã€‚è®¾å¤‡åœ°å€ä¹‹å‰å·²ç»ä»‹ç»è¿‡ï¼Œé«˜7ä½ä¸ºå›ºå®šåœ°å€ï¼Œä½1ä½ä¸º`'0'`æ—¶è¡¨ç¤ºå†™æ“ä½œã€‚\n- è‹¥EEPROMå®¹é‡å¤§äº24C16ï¼Œæ¯”å¦‚24C32å’Œ24C64ï¼ŒEEPROMæ€»çš„å­—èŠ‚æ•°åˆ†åˆ«ä¸º4096å’Œ8192ï¼Œå¯¹åº”å¯»å€çº¿ä¸º12æ ¹å’Œ13æ ¹ï¼Œå³å†…å­˜åœ°å€æ˜¯12ä½å’Œ13ä½çš„ï¼Œæ˜¾ç„¶å‘é€å†…å­˜åœ°å€æ—¶å°±éœ€è¦åˆ†é«˜å­—èŠ‚å’Œä½å­—èŠ‚ä¸¤æ¬¡å‘é€ã€‚\n- è‹¥EEPROMå®¹é‡å°äºæˆ–ç­‰äº24C16ï¼Œåˆ™å¯»å€çº¿æœ€å¤šä¸º11æ ¹ï¼Œå†…å­˜åœ°å€æœ€å¤šæ˜¯11ä½çš„ã€‚é€šè¿‡`iic_send_byte(0xA0 + ((addr >> 8) << 1))`ï¼Œå¯ä»¥è®©ä¸»æœºä¸‹å‘è¯»å†™å‘½ä»¤æ—¶è‡ªå¸¦3ä½é«˜åœ°å€ï¼Œå‰©ä¸‹çš„8ä½åœ°å€åªéœ€è¦åˆåœ¨ä¸€èµ·åœ¨ä½ä½å‘é€å³å¯ï¼Œä¹Ÿå°±æ˜¯`iic_send_byte(addr % 256)`ã€‚\n\nè¿™ç§è®¾å¤‡åœ°å€ä½ä½å’Œå†…å­˜åœ°å€é«˜ä½ç›¸ç»“åˆçš„è®¾è®¡å¯ä»¥çœ‹ä½œæ˜¯EEPROMå’Œç‹¬ç‰¹è®¾è®¡ï¼Œç”¨æ¥èŠ‚çœèµ„æºã€‚\n\n### è¯»æ“ä½œ\n```\n/**\n* @brief åœ¨ AT24CXX æŒ‡å®šåœ°å€å†™å…¥ä¸€ä¸ªæ•°æ®\n* @param addr: å†™å…¥æ•°æ®çš„ç›®çš„åœ°å€\n* @param data: è¦å†™å…¥çš„æ•°æ®\n* @retval æ— \n*/\nuint8_t at24cxx_read_one_byte(uint16_t addr)\n{\n    uint8_t temp = 0;\n    iic_start();\n\n    /* æ ¹æ®ä¸åŒçš„ 24CXX å‹å·, å‘é€é«˜ä½åœ°å€\n    * 1, 24C16 ä»¥ä¸Šçš„å‹å·, åˆ† 2 ä¸ªå­—èŠ‚å‘é€åœ°å€\n    * 2, 24C16 åŠä»¥ä¸‹çš„å‹å·, åˆ† 1 ä¸ªä½å­—èŠ‚åœ°å€ + å ç”¨å™¨ä»¶åœ°å€çš„ bit1 ~ bit3 ä½\n    * ç”¨äºè¡¨ç¤ºé«˜ä½åœ°å€, æœ€å¤š 11 ä½åœ°å€\n    * å¯¹äº 24C01/02, å…¶å™¨ä»¶åœ°å€æ ¼å¼(8bit)ä¸º: 1 0 1 0 A2 A1 A0 R/W\n    * å¯¹äº 24C04, å…¶å™¨ä»¶åœ°å€æ ¼å¼(8bit)ä¸º: 1 0 1 0 A2 A1 a8 R/W\n    * å¯¹äº 24C08, å…¶å™¨ä»¶åœ°å€æ ¼å¼(8bit)ä¸º: 1 0 1 0 A2 a9 a8 R/W\n    * å¯¹äº 24C16, å…¶å™¨ä»¶åœ°å€æ ¼å¼(8bit)ä¸º: 1 0 1 0 a10 a9 a8 R/W\n    * R/W : è¯»/å†™æ§åˆ¶ä½ 0,è¡¨ç¤ºå†™; 1,è¡¨ç¤ºè¯»;\n    * A0/A1/A2 : å¯¹åº”å™¨ä»¶çš„ 1,2,3 å¼•è„š(åªæœ‰ 24C01/02/04/8 æœ‰è¿™äº›è„š)\n    * a8/a9/a10: å¯¹åº”å­˜å‚¨æ•´åˆ—çš„é«˜ä½åœ°å€, 11bit åœ°å€æœ€å¤šå¯ä»¥è¡¨ç¤º 2048 ä¸ªä½ç½®,\n    * å¯ä»¥å¯»å€ 24C16 åŠä»¥å†…çš„å‹å·\n    */\n\n   if (EE_TYPE > AT24C16)       /* 24C16ä»¥ä¸Šå‹å·åˆ†2ä¸ªå­—èŠ‚å‘é€åœ°å€ */\n   {\n        iic_send_byte(0xA0);    /* æœ€ä½ä½ä¸º0ï¼Œè¡¨ç¤ºå†™å…¥*/\n        iic_wait_ack();         /* å‘é€å®Œä¸€ä¸ªå­—èŠ‚åç­‰å¾…ACKä¿¡å· */\n        iic_send_byte(addr >> 8);       /* å‘é€é«˜å­—èŠ‚åœ°å€ */\n   }\n   else\n   {\n        /* å‘é€å™¨ä»¶0xA0 + é«˜ä½a8/a9/a10åœ°å€ï¼Œå†™æ•°æ® */\n        iic_send_byte(0xA0 + ((addr >> 8) << 1));\n   }\n\n   iic_wait_ack();\n   iic_send_byte(addr % 256);       /* å‘é€ä½ä½åœ°å€*/\n   iic_wait_ack();\n\n   iic_start();                     /* é‡æ–°å‘é€èµ·å§‹ä¿¡å·*/\n   iic_send_byte(0xA1);             /* è¿›å…¥æ¥æ”¶æ¨¡å¼ï¼Œæœ€ä½ä½ä¸º1ï¼Œè¡¨ç¤ºè¯»å–*/\n   iic_wait_ack();\n   temp = iic_read_byte(0);         /* æ¥æ”¶ä¸€ä¸ªå­—èŠ‚æ•°æ® */\n   iic_stop();\n\n   return temp;\n}\n```\n`iic_send_byte(addr % 256)`ç”¨æ¥æå–å†…å­˜åœ°å€çš„ä½8ä½ã€‚ä¹Ÿå¯ä»¥ç”¨`addr &= 0x00FF`æ¥ä»£æ›¿ã€‚\n\n### æ£€æµ‹å·¥ä½œçŠ¶æ€\n```\n/**\n* @brief æ£€æŸ¥ AT24CXX æ˜¯å¦æ­£å¸¸\n* @note æ£€æµ‹åŸç†: åœ¨å™¨ä»¶çš„æœ«åœ°å€å†™å…¥ 0X55, ç„¶åå†è¯»å–, \n* å¦‚æœè¯»å–å€¼ä¸º 0X55 åˆ™è¡¨ç¤ºæ£€æµ‹æ­£å¸¸. å¦åˆ™,åˆ™è¡¨ç¤ºæ£€æµ‹å¤±è´¥.\n* @param æ— \n* @retval æ£€æµ‹ç»“æœ\n* 0: æ£€æµ‹æˆåŠŸ\n* 1: æ£€æµ‹å¤±è´¥\n*/\nuint8_t at24cxx_check(void)\n{\n    uint8_t temp;\n    uint16_t addr = EE_TYPE;                /* ç›®æ ‡å†…å­˜åœ°å€ä¸ºEEPROMæœ«åœ°å€ */\n    temp = at24cxx_read_one_byte(addr);     /* é¿å…æ¯æ¬¡å¼€æœºéƒ½å†™å…¥*/\n\n    if (temp == 0x55)                       /* è¯»å–æ•°æ®æ­£å¸¸ */\n    {\n        return 0;\n    }\n    else                                    /* ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶ */\n    {\n        at24cxx_write_one_byte(addr, 0x55); /* å…ˆå†™å…¥ */\n        temp = at24cxx_read_one_byte(255);  /* å†è¯»å– */\n        if (temp == 0x55) return 0;\n    }\n\n    return 1;\n}\n```\nè¿™ç§æ“ä½œå’ŒRTCå®éªŒå¾ˆç±»ä¼¼ï¼Œåˆ©ç”¨EEPROMæ‰ç”µåå†…å­˜ä¸ä¸¢å¤±çš„ç‰¹æ€§ï¼Œå›ºå®šåœ¨ç¬¬ä¸€æ¬¡å†™å…¥æ—¶äºå†…å­˜æœ«åœ°å€å†™å…¥`0x55`ï¼Œç„¶åå†å»è¯»ä¸€ä¸‹çœ‹çœ‹æ˜¯å¦å†™å…¥æˆåŠŸï¼Œä»¥æ­¤æ¥æ£€æµ‹èŠ¯ç‰‡æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\n\n## åº”ç”¨\nå®ç°ä¸€ä¸ªç®€å•çš„åº”ç”¨ï¼šæŒ‰ä¸‹KEY1ï¼Œå‘EEPROMçš„é¦–åœ°å€å†™å…¥å­—ç¬¦ä¸²ï¼Œå†™å…¥æˆåŠŸä¸²å£æ‰“å°â€œwrite okâ€ï¼›æŒ‰ä¸‹KEY0ï¼Œè¯»å–EEPROMé¦–åœ°å€å†…å®¹ï¼Œä¸²å£æ‰“å°è¯»å–ç»“æœ\n\n```\n/* USER CODE BEGIN 2 */\n  while (at24cxx_check())\n  {\n    led_red_toggle();\n    delay_ms(500);\n  }\n  /* USER CODE END 2 */\n\n/* USER CODE BEGIN WHILE */\n  while (1)\n  {\n    /* USER CODE END WHILE */\n\n    /* USER CODE BEGIN 3 */\n    uint8_t key;\n    uint8_t writeok[] = \"write ok\\n\";\n    uint8_t txbuf[] = \"mua\\n\";\n    uint8_t rxbuf[5];\n    uint8_t readok[15];\n\n    key = key_scan(0);\n\n    if (key == KEY1_pressed)    /* å¦‚æœKEY1è¢«æŒ‰ä¸‹ */\n    {\n      at24cxx_write(0, txbuf, sizeof(txbuf));\n      HAL_UART_Transmit_IT(&huart1, writeok, sizeof(writeok));\n      delay_ms(50);\n    }\n\n    if (key == KEY0_pressed)    /* å¦‚æœKEY0è¢«æŒ‰ä¸‹ */\n    {\n      at24cxx_read(0, rxbuf, sizeof(txbuf));\n      //sprintf(readok, \"result is %d\\n\", rxbuf[0]);\n      HAL_UART_Transmit_IT(&huart1, rxbuf, sizeof(rxbuf));\n    }\n\n    led_green(1);\n    delay_ms(10);\n  }\n  /* USER CODE END 3 */\n``` \n![ä¸²å£æ‰“å°ç»“æœ](/images/arm/24c026.png)\n\n[Githubé¡¹ç›®åœ°å€](https://github.com/AkiChen891/STM32F429-24C02-EEPROM-TEST)\n\n## å°ç»“\næ€»çš„æ¥è¯´ï¼Œé€šè¿‡I2Cæ“ä½œEEPROMæ—¶çš„è¦ç‚¹æœ‰ï¼š\n- å†™å…¥æ—¶ï¼šå…ˆå†™å…¥è®¾å¤‡åœ°å€+å†™æ“ä½œæŒ‡ç¤ºç¬¦ï¼Œç„¶åå†™å…¥ç›®æ ‡å†…å­˜åœ°å€ï¼Œæœ€åå†™å…¥å¾…å†™å…¥æ•°æ®\n- è¯»å‡ºæ—¶ï¼šèµ·å§‹ä¿¡å·ï¼Œå…ˆå†™å…¥è®¾å¤‡åœ°å€+å†™æ“ä½œæŒ‡ç¤ºç¬¦ï¼Œä»æœºACKåå†™å…¥ç›®æ ‡å†…å­˜åœ°å€ï¼›ç„¶åé‡æ–°å‘å‡ºèµ·å§‹ä¿¡å·ï¼ˆ**å› ä¸ºéœ€è¦ä»å†™æ¨¡å¼åˆ‡æ¢åˆ°è¯»æ¨¡å¼**ï¼‰ï¼Œå†™å…¥è®¾å¤‡åœ°å€+è¯»æ“ä½œæŒ‡ç¤ºç¬¦ï¼Œä»æœºACKåè¯»å‡ºå¾…è¯»æ•°æ®ã€‚è¯»å–å®Œæ¯•åï¼Œä¸»æœºå‘é€NACKï¼Œæç¤ºä»æœºè¯»å–ç»“æŸ","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"STM32F4 å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨ï¼ˆInternal Temperature Sensorï¼‰","url":"/2024/12/04/STM32å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨é‡‡é›†/","content":"STM32F4ç³»åˆ—MCUå†…ç½®æœ‰æ¸©åº¦ä¼ æ„Ÿå™¨ï¼Œç”¨äºé‡‡é›†ç‰‡å†…æ¸©åº¦ï¼Œå…¶ç»‘å®šåœ¨ADC1çš„IN18é€šé“ï¼ŒCubeMXä¸­æ˜¾ç¤ºä¸º\"Temperature sensor channel\"ã€‚\n\n## ADCé…ç½®\nADCçš„ç»“æ„ä½“`hadc1`é…ç½®å¦‚ä¸‹ï¼š\n```\n  hadc1.Instance = ADC1;\n  hadc1.Init.ClockPrescaler = ADC_CLOCK_SYNC_PCLK_DIV4;\n  hadc1.Init.Resolution = ADC_RESOLUTION_12B;\n  hadc1.Init.ScanConvMode = DISABLE;\n  hadc1.Init.ContinuousConvMode = DISABLE;\n  hadc1.Init.DiscontinuousConvMode = DISABLE;\n  hadc1.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;\n  hadc1.Init.ExternalTrigConv = ADC_SOFTWARE_START;\n  hadc1.Init.DataAlign = ADC_DATAALIGN_RIGHT;\n  hadc1.Init.NbrOfConversion = 1;\n  hadc1.Init.DMAContinuousRequests = DISABLE;\n  hadc1.Init.EOCSelection = ADC_EOC_SINGLE_CONV;\n```\n- `ClockPrescaler`ï¼šé¢„åˆ†é¢‘ç³»æ•°ï¼Œé»˜è®¤ä¸º`PCLK2 / 4`ï¼Œæ­¤ä¾‹ä¸º`90 / 4 = 22.5`MHz\n- `Resolution`ï¼šADCåˆ†è¾¨ç‡ï¼Œå¯é€‰æœ‰ 12 ä½ã€10 ä½ã€8 ä½å’Œ 6 ä½ã€‚åˆ†è¾¨ç‡è¶Šé«˜ï¼Œè½¬æ¢æ•°æ®ç²¾åº¦è¶Šé«˜ï¼Œè½¬æ¢æ—¶é—´ä¹Ÿè¶Šé•¿ï¼›åä¹‹åˆ†è¾¨ç‡è¶Šä½ï¼Œè½¬æ¢æ•°æ®ç²¾åº¦è¶Šä½ï¼Œè½¬æ¢æ—¶é—´ä¹Ÿè¶Š\nçŸ­ã€‚\n- `ScanConvMode`ï¼šæ˜¯å¦ä½¿ç”¨æ‰«æã€‚å¤šé€šé“å¯ç”¨ï¼Œå•é€šé“ç¦ç”¨ã€‚\n- `ContinuousConvMode`ï¼šå¯ç”¨ä¸ºè‡ªåŠ¨è¿ç»­è½¬æ¢ï¼Œç¦ç”¨ä¸ºå•æ¬¡è½¬æ¢ã€‚å¦‚æœè®¾ç½®ä¸ºå•æ¬¡è½¬æ¢ï¼Œé‚£ä¹ˆæ¯æ¬¡è½¬æ¢åéƒ½è¦äººå·¥ä»‹å…¥æ‰èƒ½å¼€å¯æ–°çš„è½¬æ¢\n- `DiscontinuousConvMode`ï¼šé…ç½®æ˜¯å¦ä½¿ç”¨ä¸è¿ç»­çš„é‡‡æ ·æ¨¡å¼ã€‚è¯¥å‚æ•°åªæœ‰åœ¨`ScanConvMode`å¯ç”¨ï¼Œä¸”`ContinuousConvMode`å…³é—­çš„æƒ…å†µä¸‹æ‰æœ‰æ•ˆ\n- `ExternalTrigConv`ï¼šå¤–éƒ¨è§¦å‘æ–¹å¼é€‰æ‹©ã€‚è‹¥ä¸ºè½¯ä»¶è§¦å‘åˆ™å¤–éƒ¨è§¦å‘ä¼šå…³é—­ã€‚\n- `ExternalTrigConvEdge`ï¼šå¤–éƒ¨è§¦å‘ææ€§é€‰æ‹©ï¼ˆç¦æ­¢è§¦å‘æ£€æµ‹ã€ä¸Šå‡æ²¿æ£€æµ‹ã€ä¸‹é™æ²¿æ£€æµ‹æˆ–å‡å¯ï¼‰\n- `DataAlign`ï¼šæ•°æ®å¯¹é½æ–¹å¼ï¼Œé»˜è®¤å³å¯¹é½\n- `NbrOfConversion`ï¼šå¸¸è§„è½¬æ¢é€šé“æ•°ç›®ï¼ŒèŒƒå›´1~16\n- `DMAContinuousRequests`ï¼šæŒ‡å®šDMAè¯·æ±‚æ˜¯å¦ä»¥ä¸€æ¬¡æ€§æ¨¡å¼æ‰§è¡Œï¼ˆè¾¾åˆ°è½¬æ¢æ¬¡æ•°æ—¶DMAä¼ è¾“åœæ­¢ï¼‰æˆ–åœ¨è¿ç»­æ¨¡å¼ä¸‹æ‰§è¡Œï¼ˆDMAä¼ è¾“æ— é™åˆ¶ï¼Œæ— è®ºè½¬æ¢æ•°é‡å¦‚ä½•ï¼‰ã€‚åœ¨è¿ç»­æ¨¡å¼ä¸‹æ‰§è¡Œæ—¶ï¼ŒDMAå¿…é¡»é…ç½®åœ¨å¾ªç¯ï¼ˆCircularï¼‰æ¨¡å¼ï¼Œå¦åˆ™DMAä¼ è¾“ç¼“å†²åŒºè¢«å¡«æ»¡æ—¶å°†å‘ç”Ÿæº¢å‡ºã€‚\n- `EOCSelection`ï¼šæŒ‡å®šè½¬æ¢ç»“æŸåæ˜¯å¦äº§ç”ŸEOSä¸­æ–­æˆ–äº‹ä»¶å‚æ•°\n\nSTM32F429çš„ADCæ€»è½¬æ¢æ—¶é—´å¯ä»¥é€šè¿‡ä¸‹å¼è®¡ç®—ï¼š\n\n$$\nT_{conversion} = T_{sampling} + 12 \\times T_{adc}\n$$\n\nå¯¹äºæ¯ä¸ªADCé€šé“ï¼Œé‡‡æ ·æ—¶é—´å¯ä»¥é€šè¿‡ADC_SMPR1ï¼ˆç”¨äºé€šé“10-18ï¼‰æˆ–ADC_SMPR2ï¼ˆç”¨äºé€šé“0-9ï¼‰å¯„å­˜å™¨çš„ç›¸åº”ä½æ¥é…ç½®ã€‚ä¾‹å¦‚ï¼Œé€šé“0çš„é‡‡æ ·æ—¶é—´æ˜¯é€šè¿‡ADC_SMPR2çš„SMPR2[2:0]ä½è®¾ç½®ã€‚é‡‡æ ·æ—¶é—´ä¹Ÿå¯åœ¨`adc.c`ä¸­ç”¨ä»£ç å®šä¹‰ï¼Œé€šå¸¸é»˜è®¤ä¸º3ä¸ªADCå‘¨æœŸï¼ˆSMP=000ï¼‰ï¼Œå¯è·å¾—æœ€å¿«çš„é‡‡æ ·é€Ÿåº¦ï¼š\n```\n /** Configure for the selected ADC regular channel its corresponding rank in the sequencer and its sample time.\n  */\n  sConfig.Channel = ADC_CHANNEL_TEMPSENSOR;\n  sConfig.Rank = 1;\n  sConfig.SamplingTime = ADC_SAMPLETIME_3CYCLES;\n```\n\n12ä¸ªå‘¨æœŸç”±ADCè¾“å…¥æ—¶é’ŸADC_CLKå†³å®šï¼Œå…¶ç”±APB2ï¼ˆ å³PCLK2ï¼‰åˆ†é¢‘äº§ç”Ÿï¼Œåœ¨`ClockPrescaler`ä¸­å¯ä¿®æ”¹ã€‚\n\nè‹¥é‡‡æ ·æ—¶é—´ä¸º3ä¸ªADCå‘¨æœŸï¼Œåˆ™ADCè½¬æ¢æ€»æ—¶é—´ä¸º15ä¸ªADCå‘¨æœŸï¼ŒAPB2æ—¶é’Ÿé¢‘ç‡ä¸º90MHzï¼ŒPCLK2/4åˆ†é¢‘åä¸º22.5MHzï¼Œé‚£ä¹ˆè½¬æ¢æ—¶é—´å°±æ˜¯0.6667usã€‚\n\n## DMAé…ç½®\nå¯ç”¨DMA2ï¼ŒADC1è½¬æ¢åçš„åŸå§‹æ•°æ®å­˜å‚¨åˆ°16ä½ç¼“å†²åŒºRx_Bufä¸­ã€‚ç”±äºADCåˆ†è¾¨ç‡ä¸º12ä½ï¼Œå³é‡‡å›çš„æ•°æ®ä¸º12ä½ï¼Œæ­£å¥½èƒ½å¤Ÿè¢«16ä½ç¼“å†²åŒºå­˜ä¸‹ï¼Œä¾¿äºåç»­è§‚å¯Ÿå’Œç®¡ç†å†…å­˜ä¸­çš„é‡‡æ ·å€¼ã€‚å¦‚æœç”¨32ä½ç¼“å†²åŒºï¼Œä¸€ä¸ªåŒºåŸŸä¼šå­˜ä¸¤ä¸ªé‡‡æ ·å€¼ï¼Œä¸æ–¹ä¾¿æŸ¥çœ‹å’Œåç»­çš„è½¬æ¢ã€‚\n\n## é‡‡æ ·\nADCç›´æ¥é‡‡æ ·ä¼šå­˜åœ¨è·³å˜æˆ–æŠ–åŠ¨ï¼Œé€šå¸¸éœ€è¦è¿›è¡Œä¸€å®šçš„è½¯ä»¶æ»¤æ³¢ï¼Œæœ€å¸¸è§çš„æ–¹æ³•æ˜¯ç®€å•å¹³å‡æ³•ã€‚\n```\n/*\n    @ brief:ADCé‡‡æ ·å¹¶å–å¹³å‡\n    @ param:times:å¹³å‡æ¬¡æ•°\n    @ return:è®¡ç®—å¾—åˆ°çš„å¹³å‡å€¼\n*/\nuint16_t adc1_get_average_value(uint8_t times)\n{\n  uint16_t temp_value = 0;\n  uint8_t t;\n\n  /* ADC é…ç½®åœ¨å•æ¬¡æ¨¡å¼ï¼Œæ¯æ¬¡é‡‡æ ·éƒ½éœ€è¦æ‰‹åŠ¨é‡å¯ADCæœåŠ¡ */\n  HAL_ADC_Start_DMA(&hadc1, (uint32_t *) Rx_Buf, Rx_Buf_Size);  //å¼ºåˆ¶è½¬æ¢Rx_Bufä¸º32ä½ä»¥æ»¡è¶³å½¢å‚é™åˆ¶\n\n  /* é‡‡æ ·å€¼å–å¹³å‡ */\n  for (t = 0; t < times; t++)\n  {\n    temp_value = temp_value + HAL_ADC_GetValue(&hadc1);\n    HAL_Delay(5);\n  }\n\n  /* è¿”å›å¹³å‡å€¼ */\n  return temp_value / times;\n}\n```\nå› åˆ†è¾¨ç‡ä¸º12ä½ï¼ŒADCæ¯æ¬¡é‡‡æ ·è¿”å›çš„æ•°å€¼å³ä¸º12ä½æ— ç¬¦å·æ•´å‹ï¼ˆåè¿›åˆ¶0~4095ï¼‰ã€‚DMAå°†ä¼šä¼ è¾“æ¯ä¸€æ¬¡çš„é‡‡æ ·å€¼è‡³ç¼“å†²åŒºï¼Œä¸ºäº†èƒ½å¤Ÿæ›´å¥½çš„æŸ¥çœ‹æ¯ä¸€æ¬¡è¿”å›çš„æ•°å€¼ï¼Œè¯¥ä¾‹ç¨‹äº‹å…ˆå°†ç¼“å†²åŒºå®šä¹‰æˆäº†uint16_tç±»å‹ï¼Œè¿™æ ·ç¼“å†²åŒºæ•°ç»„çš„æ¯ä¸€ä¸ªå•å…ƒæ­£å¥½èƒ½å¤Ÿå­˜ä¸‹ä¸€ä¸ªé‡‡æ ·å€¼ã€‚åœ¨è°ƒç”¨ADCé‡‡æ ·å‡½æ•°æ—¶ï¼Œåªéœ€è¦å°†å…¶å£°æ˜ä¸ºuint32_tç±»å‹æŒ‡é’ˆï¼Œè¿™æ ·DMAä¼šæŒ‰4ä¸ªå­—èŠ‚ï¼ˆ32ä½ï¼‰æ¥ä¼ è¾“æ•°æ®ã€‚DMAæœ¬èº«å¹¶ä¸å…³å¿ƒä¼ è¾“çš„é‡‡æ ·å€¼åˆ°åº•æ˜¯å‡ ä½çš„ï¼Œä»–åªä¼šè¯»å–4ä¸ªå­—èŠ‚çš„æ•°æ®ç„¶åä¼ é€’è‡³å†…å­˜ï¼Œå› æ­¤ï¼Œæ¯ä¸¤ä¸ª uint16_t æ•°æ®ï¼ˆå³ 2 ä¸ªé‡‡æ ·å€¼ï¼‰ä¼šåˆå¹¶æˆä¸€ä¸ª uint32_tï¼Œåœ¨å†…å­˜ä¸­å½¢æˆè¿ç»­çš„æ•°æ®å—ã€‚\n\nä»¥æ­¤ç±»æ¨ï¼Œå¦‚æœé‡‡æ ·å€¼ä¸º8ä½(uint8_t)ï¼Œé‚£ä¹ˆDMAæ¯æ¬¡å°†ä¼šæ‰“åŒ…4ä¸ªé‡‡æ ·å€¼ä¸ºä¸€ä¸ªuint32_tæ•°å€¼ä¼ å›åŒæ ·å®šä¹‰ä¸ºuint8_tçš„ç¼“å†²åŒºç„¶åè§£åŒ…ï¼Œç¼“å†²åŒºä¸­çš„æ¯ä¸ªå•å…ƒéƒ½æ˜¾ç¤ºä¸€ä¸ªé‡‡æ ·å€¼ã€‚\n\nç„¶åè¿›è¡Œæ¸©åº¦çš„è¯»å–ã€‚æ¸©åº¦ä¼ æ„Ÿå™¨æ¢ç®—å…¬å¼ä¸ºï¼ˆå•ä½ä¸ºæ‘„æ°åº¦ï¼‰ï¼š\n$$\nT = ((V_{sense}-V_{25})/AvgSlope) + 25\n$$\nå¼ä¸­å‚æ•°å–å…¸å‹å€¼ï¼Œæœ‰$V_{25}=0.76$ï¼Œ$AvgSlope = 2.5mv/â„ƒ$\né‡‡é›†æ¸©åº¦ï¼š\n```\n/*\n    @ brief:é‡‡é›†æ¸©åº¦\n    @ param:NULL\n    @ return:æ¸©åº¦å€¼ï¼ˆshortï¼‰\n*/\ndouble read_temperature(void)\n{\n  uint16_t adc_value;\n  double temperature; //è¿”å›æ¸©åº¦ä¸ºåŒç²¾åº¦å€¼\n\n  adc_value = adc1_get_average_value(10);\n\n  temperature = ((float)adc_value * 3.3 / 4096.0 - 0.76) / 0.0025 + 25.0;\n\n  return temperature;\n}\n```\n\n`main.c`ï¼š\n```\n  ic_temp = read_temperature();\n\n  uint8_t txbuf[15];\n  sprintf(txbuf, \"temp is: %.2f\\n\", ic_temp); //è½¬æ¢ä¸ºå­—ç¬¦ä¸²\n\n  HAL_UART_Transmit(&huart1, (uint8_t *)txbuf, strlen(txbuf), 0xFFFF);  //ä¸²å£è½®è¯¢å‘é€æ¸©åº¦å€¼\n```\n\n## ç»“æœ\n![ä¸Šä½æœºæ¥æ”¶](/images/arm/temp1.png)\n\n![å†…å­˜ç›‘è§†ç»“æœ](/images/arm/temp2.png)","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"STM32 UARTåœ¨å¾ªç¯DMAæ¨¡å¼ä¸‹æ¥æ”¶å¤§é‡ä¸å®šå­—é•¿æ•°æ®å¹¶è¿›è¡Œä¹’ä¹“ç¼“å­˜","url":"/2024/11/25/STM32 UARTæ¥æ”¶ä¸å›ºå®šå­—èŠ‚æ•°æ®/","content":"ä¸²å£(uart)æ˜¯ä¸€ç§ä½é€Ÿçš„ä¸²è¡Œå¼‚æ­¥é€šä¿¡ï¼Œé€‚ç”¨äºä½é€Ÿé€šä¿¡åœºæ™¯ï¼Œé€šå¸¸ä½¿ç”¨çš„æ³¢ç‰¹ç‡å°äºæˆ–ç­‰äº115200bpsã€‚\n\nå¯¹äºå°äºæˆ–è€…ç­‰äº115200bpsæ³¢ç‰¹ç‡çš„ï¼Œè€Œä¸”æ•°æ®é‡ä¸å¤§çš„é€šä¿¡åœºæ™¯ï¼Œä¸€èˆ¬æ²¡å¿…è¦ä½¿ç”¨DMAï¼Œæˆ–è€…è¯´ä½¿ç”¨DMAå¹¶æœªèƒ½å……åˆ†å‘æŒ¥å‡ºDMAçš„ä½œç”¨ã€‚\n\nå¯¹äºæ•°é‡å¤§ï¼Œæˆ–è€…æ³¢ç‰¹ç‡æé«˜æ—¶ï¼Œå¿…é¡»ä½¿ç”¨DMAä»¥é‡Šæ”¾CPUèµ„æºï¼Œå› ä¸ºé«˜æ³¢ç‰¹ç‡å¯èƒ½å¸¦æ¥è¿™æ ·çš„é—®é¢˜ï¼š\n\n+ å¯¹äºå‘é€ï¼Œä½¿ç”¨å¾ªç¯å‘é€ï¼Œå¯èƒ½é˜»å¡çº¿ç¨‹ï¼Œéœ€è¦æ¶ˆè€—å¤§é‡CPUèµ„æºâ€œæ¬è¿â€æ•°æ®ï¼Œæµªè´¹CPU\n\n+ å¯¹äºå‘é€ï¼Œä½¿ç”¨ä¸­æ–­å‘é€ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œä½†éœ€æµªè´¹å¤§é‡ä¸­æ–­èµ„æºï¼ŒCPUé¢‘ç¹å“åº”ä¸­æ–­ï¼›ä»¥115200bpsæ³¢ç‰¹ç‡ï¼Œ1sä¼ è¾“11520å­—èŠ‚ï¼Œå¤§çº¦69uséœ€å“åº”ä¸€æ¬¡ä¸­æ–­ï¼Œå¦‚æ³¢ç‰¹ç‡å†æé«˜ï¼Œå°†æ¶ˆè€—æ›´å¤šCPUèµ„æº\n\n+ å¯¹äºæ¥æ”¶ï¼Œå¦‚ä»é‡‡ç”¨ä¼ ç»Ÿçš„ä¸­æ–­æ¨¡å¼æ¥æ”¶ï¼ŒåŒæ ·ä¼šå› ä¸ºé¢‘ç¹ä¸­æ–­å¯¼è‡´æ¶ˆè€—å¤§é‡CPUèµ„æº\nå› æ­¤ï¼Œé«˜æ³¢ç‰¹ç‡åœºæ™¯ä¸‹ï¼Œä¸²å£éå¸¸æœ‰å¿…è¦ä½¿ç”¨DMAã€‚\n## ä¸­æ–­è½®è¯¢æ¨¡å¼(IT)\nä½¿ç”¨`HAL_UARTEx_ReceiveToIdle_IT`å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæŒç»­æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°ç¼“å†²åŒºæº¢å‡ºæˆ–è§¦å‘ç©ºé—²äº‹ä»¶ã€‚\n```\n/**\n  * @brief Receive an amount of data in interrupt mode till either the expected number of data is received or an IDLE event occurs.\n  * @note   Reception is initiated by this function call. Further progress of reception is achieved thanks\n  *         to UART interrupts raised by RXNE and IDLE events. Callback is called at end of reception indicating\n  *         number of received data elements.\n  * @note   When UART parity is not enabled (PCE = 0), and Word Length is configured to 9 bits (M = 01),\n  *         the received data is handled as a set of uint16_t. In this case, Size must indicate the number\n  *         of uint16_t available through pData.\n  * @param huart UART handle.\n  * @param pData Pointer to data buffer (uint8_t or uint16_t data elements).\n  * @param Size  Amount of data elements (uint8_t or uint16_t) to be received.\n  * @retval HAL status\n  */\nHAL_StatusTypeDef HAL_UARTEx_ReceiveToIdle_IT(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size)\n{\n  HAL_StatusTypeDef status;\n\n  /* æ£€æŸ¥æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„æ¥æ”¶è¿‡ç¨‹ */\n  if (huart->RxState == HAL_UART_STATE_READY)\n  {\n    if ((pData == NULL) || (Size == 0U))\n    {\n      return HAL_ERROR;\n    }\n\n    /* æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°ç©ºé—²äº‹ä»¶å‘ç”Ÿ*/\n    huart->ReceptionType = HAL_UART_RECEPTION_TOIDLE;\n    huart->RxEventType = HAL_UART_RXEVENT_TC;\n\n    status =  UART_Start_Receive_IT(huart, pData, Size);\n\n    /* æ£€æŸ¥æ¥æ”¶æ˜¯å¦æˆåŠŸå¼€å§‹ */\n    if (status == HAL_OK)\n    {\n      if (huart->ReceptionType == HAL_UART_RECEPTION_TOIDLE)\n      {\n        __HAL_UART_CLEAR_IDLEFLAG(huart);\n        ATOMIC_SET_BIT(huart->Instance->CR1, USART_CR1_IDLEIE);\n      }\n      else\n      {\n        /* å¦‚æœåœ¨å¼€å§‹æ¥æ”¶æ—¶å·²æœ‰é”™è¯¯å¾…å¤„ç†ï¼Œåˆ™å¯èƒ½å·²å¼•å‘ä¸­æ–­å¹¶å¯¼è‡´æ¥æ”¶ä¸­æ­¢ */\n        status = HAL_ERROR;\n      }\n    }\n\n    return status;\n  }\n  else\n  {\n    return HAL_BUSY;\n  }\n}\n```\n\n### main.c\n```\n  /* USER CODE BEGIN 2 */\n  HAL_UARTEx_ReceiveToIdle_IT(&huart1, (uint8_t *)RxBuffer, RX_BUFFER_SIZE);\n  \n  /* USER CODE END 2 */\n```\n\n### usart.c\næ¯æ¬¡æ¥æ”¶å®Œæ•°æ®ï¼ˆæŒ‡æº¢å‡ºæˆ–ç©ºé—²åï¼‰è¿›å…¥è¯¥å›è°ƒï¼Œå°†ç¼“å†²åŒºæ•°æ®ä¼ å›ä¸Šä½æœºï¼Œç„¶åé‡æ–°å‡†å¤‡ä¸‹ä¸€æ¬¡æ¥æ”¶\n```\n/* USER CODE BEGIN 1 */\nvoid HAL_UARTEx_RxEventCallback(UART_HandleTypeDef *huart, uint16_t Size)\n{\n  //uint16_t index = Size;\n  //HAL_UARTEx_ReceiveToIdle_IT(&huart1, (uint8_t *)RxBuffer, RX_BUFFER_SIZE);\n  HAL_UART_Transmit_IT(&huart1, (uint8_t *)RxBuffer, sizeof(RxBuffer));\n  HAL_UARTEx_ReceiveToIdle_IT(&huart1, (uint8_t *)RxBuffer, RX_BUFFER_SIZE);\n}\n/* USER CODE END 1 */\n```\n\n## DMAæ¨¡å¼ï¼ˆå°‘é‡æ•°æ®ï¼‰\nDMAç»•è¿‡CPUè¿›è¡Œæ•°æ®ä¼ è¾“ï¼ˆå¤–è®¾-å†…å­˜ï¼‰ï¼Œå› æ­¤å¯ä»¥èŠ‚çœCPUèµ„æºã€‚DMAåˆ†ä¸ºæ­£å¸¸ï¼ˆNormalï¼‰æ¨¡å¼å’Œå¾ªç¯(Circular)æ¨¡å¼ï¼Œä¸€èˆ¬å¤§è§„æ¨¡æ•°æ®ä¼ è¾“æ—¶ä½¿ç”¨å¾ªç¯æ¨¡å¼ã€‚\nä½¿ç”¨` HAL_UARTEx_ReceiveToIdle_DMA`å‡½æ•°ï¼Œä»…éœ€åœ¨æœ€å¼€å§‹è°ƒç”¨ä¸€æ¬¡ã€‚å½“æ¥æ”¶å®Œæˆï¼ˆè¾¾åˆ°æŒ‡å®šå­—èŠ‚æ•°ï¼‰æˆ–è§¦å‘Idleäº‹ä»¶æ—¶æ¥æ”¶åœæ­¢ã€‚æ¯æ¬¡æ¥æ”¶äº‹ä»¶å®Œæˆåè§¦å‘`HAL_UARTEx_RxEventCallback`ä¸­æ–­å›è°ƒã€‚\n\nåº”ç”¨è¦æ±‚ï¼šè¾“å…¥ä¸€æ®µæ–‡å­—ï¼Œè‹¥MCUæˆåŠŸæ¥æ”¶åˆ™å›å¤â€œWilcoâ€ã€‚\n### main.c \nåœ¨loopå‰è°ƒç”¨ä¸€æ¬¡ä»¥å¯åŠ¨æ¥æ”¶ï¼š\n```\nHAL_UARTEx_ReceiveToIdle_DMA(&huart1, (uint8_t *)RxBuffer, RX_BUFFER_SIZE);\n```\n### usart.c\n```\n/* USER CODE BEGIN 1 */\nint count = 0;  //æ¥æ”¶æ¬¡æ•°\nuint16_t index = 0; //æ¥æ”¶æ•°æ®é‡\nuint8_t Wilco[] = \"wilco\\n\";  //å‘é€ç¼“å†²åŒº\n\n/*\n  @name: UARTæ¥æ”¶ä¸­æ–­å›è°ƒå‡½æ•°\n*/\nvoid HAL_UARTEx_RxEventCallback(UART_HandleTypeDef *huart, uint16_t Size)\n{\n  index = Size;\n  count++;\n  HAL_UART_Transmit_IT(&huart1, (uint8_t *)Wilco, sizeof(Wilco));   //ä¸­æ–­è½®è¯¢å‘é€ä»¥å…DMAå†²çª\n/*   for (int i = 0; i < RX_BUFFER_SIZE; i++) \n  {\n    RxBuffer[i] = 0;  // æ¸…ç©ºæ¥æ”¶ç¼“å†²åŒºï¼ˆå¯é€‰ï¼‰\n  } */\n  HAL_UARTEx_ReceiveToIdle_DMA(&huart1, (uint8_t *)RxBuffer, RX_BUFFER_SIZE); //é‡æ–°å¼€å¯æ¥æ”¶\n}\n/* USER CODE END 1 */\n```\n![](/images/arm/dma1.png)\n\n## DMAæ¨¡å¼ï¼ˆå¤§é‡æ•°æ®ï¼‰ä¸ä¹’ä¹“ç¼“å­˜\n*å‚è€ƒæ–‡çŒ®*ï¼š\n\n[ä¸€ä¸ªä¸¥è°¨çš„STM32ä¸²å£DMAå‘é€&æ¥æ”¶ï¼ˆ1.5Mbpsæ³¢ç‰¹ç‡ï¼‰æœºåˆ¶](https://www.eet-china.com/mp/a28491.html)\n\n[STM32 HAL åº“å®ç°ä¹’ä¹“ç¼“å­˜åŠ ç©ºé—²ä¸­æ–­çš„ä¸²å£ DMA æ”¶å‘æœºåˆ¶ï¼Œè½»æ¾è·‘ä¸Š 2M æ³¢ç‰¹ç‡](https://openatomworkshop.csdn.net/6744016a3a01316874d7817c.html?dp_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6OTAzMTMsImV4cCI6MTczMzczMzA5MywiaWF0IjoxNzMzMTI4MjkzLCJ1c2VybmFtZSI6Im0wXzUxMTQ5NzUyIn0.iiWrRqQwXcnrR4HqKAlmtbAKIr9u0HJiBW-IMTE2tQ0&spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7Ebaidujs_baidulandingword%7Eactivity-1-131576165-blog-110628262.235%5Ev43%5Epc_blog_bottom_relevance_base1&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7Ebaidujs_baidulandingword%7Eactivity-1-131576165-blog-110628262.235%5Ev43%5Epc_blog_bottom_relevance_base1&utm_relevant_index=2)\n\n[MaJerla(Github)](https://github.com/MaJerle/stm32-usart-uart-dma-rx-tx)\n\nDMAåœ¨å¾ªç¯æ¨¡å¼ä¸‹å·¥ä½œæ—¶ï¼Œå¦‚æœåœ¨å¤§è§„æ¨¡ä¼ è¾“æ•°æ®æ—¶ä»æ—§ç©ºé—²ä¸­æ–­ï¼ˆæˆ–ä¼ è¾“å®Œæˆä¸­æ–­ï¼‰ä¼šæœ‰é£é™©ï¼Œå› ä¸ºå½“DMAä¼ è¾“æ•°æ®å®Œæˆï¼ŒCPUä»‹å…¥å¼€å§‹æ‹·è´DMAé€šé“ç¼“å†²åŒºæ•°æ®æ—¶ï¼Œå¦‚æœæ­¤æ—¶UARTç»§ç»­æœ‰æ•°æ®è¿›æ¥ï¼ŒDMAç»§ç»­æ¬è¿æ•°æ®åˆ°ç¼“å†²åŒºï¼Œå°±æœ‰å¯èƒ½å°†æ•°æ®è¦†ç›–ï¼Œå› ä¸ºDMAæ•°æ®æ¬è¿æ˜¯ä¸å—CPUæ§åˆ¶çš„ï¼Œå³ä½¿ä½ å…³é—­äº†CPUä¸­æ–­ã€‚\n\nå› æ­¤ä¸¥è°¨çš„åšæ³•éœ€è¦å»ºç«‹åŒbufferï¼ŒCPUå’ŒDMAå„è‡ªä½¿ç”¨ä¸€å—å†…å­˜äº¤æ›¿è®¿é—®ï¼Œå³**ä¹’ä¹“ç¼“å­˜**ï¼Œå¤„ç†æµç¨‹ä¸ºï¼š\n\n1. DMAå…ˆå°†æ•°æ®æ¬è¿åˆ°buf1ï¼Œæ¬è¿å®Œæˆé€šçŸ¥CPUæ¥æ‹·è´buf1æ•°æ®\n2. DMAå°†æ•°æ®æ¬è¿åˆ°buf2ï¼Œä¸CPUæ‹·è´buf1æ•°æ®ä¸ä¼šå†²çª\n3. buf2æ•°æ®æ¬è¿å®Œæˆï¼Œé€šçŸ¥CPUæ¥æ‹·è´buf2æ•°æ®\n4. DMAç»§ç»­å¼€å§‹æ‹·è´æ–°æ•°æ®\n\nSTM32å¤§å¤šæ•°å‹å·ä¸æä¾›ç°æˆçš„åŒç¼“å­˜æœºåˆ¶ï¼Œä½†æä¾›â€œåŠæ»¡ä¸­æ–­â€ï¼Œå³æ•°æ®æ¬è¿åˆ°bufå¤§å°çš„ä¸€åŠæ—¶ï¼Œå¯ä»¥äº§ç”Ÿä¸€ä¸ªä¸­æ–­ä¿¡å·ã€‚åŸºäºè¿™ä¸ªæœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åŒç¼“å­˜åŠŸèƒ½ï¼Œåªéœ€å°†bufç©ºé—´å¼€è¾Ÿå¤§ä¸€ç‚¹å³å¯ã€‚\n\n1. DMAå°†æ•°æ®æ¬è¿å®Œæˆbufçš„å‰ä¸€åŠæ—¶ï¼Œè§¦å‘â€œåŠæ»¡ä¸­æ–­â€äº‹ä»¶ï¼ŒCallbackä¸­é€šçŸ¥CPUæ¥æ‹·è´bufå‰åŠéƒ¨åˆ†æ•°æ®\n2. DMAç»§ç»­å°†æ•°æ®æ¬è¿åˆ°bufçš„ååŠéƒ¨åˆ†ï¼Œä¸CPUæ‹·è´bufå‰åŠéƒ¨æ•°æ®ä¸ä¼šå†²çª\n3. bufååŠéƒ¨åˆ†æ•°æ®æ¬è¿å®Œæˆï¼Œè§¦å‘â€œæº¢æ»¡ä¸­æ–­â€ï¼ŒCallbacké€šçŸ¥CPUæ¥æ‹·è´bufååŠéƒ¨åˆ†æ•°æ®\n4. DMAå¾ªç¯æ‹·è´æ–°æ•°æ®\n\nåŸºäºä¸Šè¿°æè¿°æœºåˆ¶ï¼ŒDMAæ–¹å¼æ¥æ”¶ä¸²å£æ•°æ®ï¼Œæœ‰ä¸‰ç§ä¸­æ–­åœºæ™¯éœ€è¦CPUå»å°†bufæ•°æ®æ‹·è´åˆ°finalä¸­ï¼Œåˆ†åˆ«æ˜¯ï¼š\n\n- DMAé€šé“bufæº¢æ»¡ï¼ˆä¼ è¾“å®Œæˆï¼‰åœºæ™¯ï¼Œè§¦å‘æ»¡æº¢ä¸­æ–­ï¼ˆ`HAL_UARTEx_RxEventCallback`ï¼‰\n- DMAé€šé“bufåŠæ»¡åœºæ™¯ï¼Œè§¦å‘åŠæ»¡ä¸­æ–­ï¼ˆ`HAL_UART_RxHalfCpltCallback`ï¼‰\n- ä¸²å£ç©ºé—²ä¸­æ–­åœºæ™¯ï¼Œè§¦å‘ç©ºé—²ä¸­æ–­ï¼ˆ`UART_FLAG_IDLE`ï¼‰\n\n![ä¸‰ç§ä¸­æ–­äº‹ä»¶åœºæ™¯](/images/arm/rxhalf.png)\n\n![æ•°æ®å¤„ç†æµç¨‹å›¾](/images/arm/rxhalf1.png)\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œä»£ç æ€»å…±éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š\n1. æ•°æ®é‡æœªè¾¾åˆ°åŠæ»¡ï¼Œè§¦å‘**ç©ºé—²ä¸­æ–­**\n2. æ•°æ®é‡è¾¾åˆ°åŠæ»¡ï¼Œæœªè¾¾åˆ°æ»¡æº¢ï¼Œå…ˆè§¦å‘**åŠæ»¡ä¸­æ–­**ï¼Œåè§¦å‘**ç©ºé—²ä¸­æ–­**\n3. æ•°æ®é‡åˆšå¥½è¾¾åˆ°æ»¡æº¢ï¼Œå…ˆè§¦å‘**åŠæ»¡ä¸­æ–­**ï¼Œåè§¦å‘**æ»¡æº¢ä¸­æ–­**\n4. æ•°æ®é‡å¤§äºç¼“å†²åŒºé•¿åº¦ï¼ŒDMAå¾ªç¯è¦†ç›–æº¢å‡ºçš„å­—èŠ‚\n\nå¯¹äºæƒ…å†µ1ï¼šåœ¨ç©ºé—²ä¸­æ–­ä¸­æ‹·è´å…¨éƒ¨æ•°æ®\n\nå¯¹äºæƒ…å†µ2ï¼šåœ¨åŠæ»¡ä¸­æ–­ä¸­é€šçŸ¥CPUæ‹·è´ä¸€åŠçš„æ•°æ®ï¼ŒDMAç»§ç»­æ¥æ”¶å‰©ä¸‹çš„æ•°æ®ï¼Œæœ€ååœ¨ç©ºé—²ä¸­æ–­ä¸­æ‹·è´å‰©ä¸‹çš„æ•°æ®\n\nå¯¹äºæƒ…å†µ3ï¼šåœ¨åŠæ»¡ä¸­æ–­ä¸­é€šçŸ¥CPUæ‹·è´ä¸€åŠçš„æ•°æ®ï¼ŒDMAç»§ç»­æ¥æ”¶å‰©ä¸‹çš„æ•°æ®ï¼Œæœ€ååœ¨æ»¡æº¢ä¸­æ–­ä¸­æ‹·è´å‰©ä¸‹çš„ä¸€åŠæ•°æ®\n\nå¯¹äºæƒ…å†µ4ï¼šç»¼åˆå¤„ç†\n\nä¸‹é¢è¿™ä¸ªä»£ç ç»è¿‡è¯•éªŒä¸å¤ªå¥½ä½¿ï¼Œç©ºé—²ä¸­æ–­å’Œæ»¡æº¢ä¸­æ–­ä¼¼ä¹æœ‰å†²çªï¼Œå¯¼è‡´æ¥æ”¶å®ŒæˆåMCUè¿›ä¸å»æ»¡æº¢ä¸­æ–­ã€‚\n```\n  /* USER CODE BEGIN USART1_IRQn 0 */\n  if (__HAL_UART_GET_FLAG(&huart1, UART_FLAG_IDLE))\n  {\n    __HAL_UART_CLEAR_FLAG(&huart1, UART_FLAG_IDLE);\n    HAL_UART_DMAStop(&huart1);\n    uint32_t temp = RX_BUFFER_SIZE - __HAL_DMA_GET_COUNTER(&hdma_usart1_rx);  //å·²æ¥æ”¶çš„æ•°æ®å¤§å°\n\n    if (temp != 0)\n    //å¦‚æœæ¥æ”¶åˆ°äº†æ•°æ®\n    {\n      uint8_t txbuffer[] = \"rx ok in idle IT\\n\";\n      HAL_UART_Transmit(&huart1, txbuffer, sizeof(txbuffer), 0xFFFF);\n\n      if (rx_half_flag == 0)\n      //å¦‚æœåŠæ»¡ä¸­æ–­å°šæœªè§¦å‘è¿‡ï¼ˆå‰åŠæ®µï¼‰\n      {\n        for (int i = 0; i < temp; i++)\n        {\n          RX_final[final_index] = Rx_buffer[i];\n          final_index++;\n          HAL_UART_Receive_DMA(&huart1, Rx_buffer, RX_BUFFER_SIZE - temp);\n        }\n      }\n      else if (rx_half_flag)\n      //å¦‚æœåŠæ»¡ä¸­æ–­å·²è§¦å‘è¿‡ï¼ˆååŠæ®µï¼‰\n      {\n        uint32_t temp_size = RX_BUFFER_SIZE - __HAL_DMA_GET_COUNTER(&hdma_usart1_rx) - RX_BUFFER_SIZE / 2;\n        for (int i = RX_BUFFER_SIZE / 2; i < RX_BUFFER_SIZE / 2 + temp_size; i++)\n        {\n          RX_final[final_index] = Rx_buffer[i];\n          final_index++;\n        }\n        HAL_UART_Receive_DMA(&huart1, Rx_buffer, RX_BUFFER_SIZE/2 - temp_size);\n      }\n    }\n    else if (temp == RX_BUFFER_SIZE)\n    {\n      HAL_UART_Receive_DMA(&huart1, Rx_buffer, RX_BUFFER_SIZE);\n    }\n  }\n  ```\n  ```\n  /* USER CODE BEGIN 1 */\nvoid HAL_UART_RxHalfCpltCallback(UART_HandleTypeDef *huart)\n{\n  if (huart->Instance == USART1)\n  {\n    rx_half_flag = 1;\n    \n    uint8_t sendbuffer[] = \"rxhalf IT\\n\";\n    HAL_UART_Transmit(&huart1, (uint8_t *)sendbuffer, sizeof(sendbuffer), 0xFFFF);\n\n    for (int i = 0; i < RX_BUFFER_SIZE / 2; i++)\n    {\n      RX_final[final_index] = Rx_buffer[i];\n      final_index++;\n    }\n\n    HAL_UART_Receive_DMA(&huart1, (uint8_t *) Rx_buffer, RX_BUFFER_SIZE / 2);\n  }\n}\n\nvoid HAL_UARTEx_RxEventCallback(UART_HandleTypeDef *huart, uint16_t Size)\n{\n  if (huart->Instance == USART1)\n  {\n    uint8_t sendbuffer[] = \"rx ok\\n\";\n    HAL_UART_Transmit(&huart1, (uint8_t *)sendbuffer, sizeof(sendbuffer), 0xFFFF);\n\n    for (int i = RX_BUFFER_SIZE / 2; i < RX_BUFFER_SIZE; i++)\n    {\n      RX_final[final_index] = Rx_buffer[i];\n      final_index++;\n    }\n\n    rx_half_flag = 0;\n  }\n  HAL_UART_Receive_DMA(&huart1, (uint8_t *) Rx_buffer, RX_BUFFER_SIZE);\n}\n/* USER CODE END 1 */\n```\nç»§ç»­è°ƒè¯•ï¼Œåˆ æ‰é™¤æ‰“å°æµ‹è¯•ä¿¡æ¯ä»¥å¤–çš„æ‰€æœ‰åŠŸèƒ½æ€§ä»£ç ï¼š\n```\n  /* USER CODE BEGIN USART1_IRQn 0 */\n  uint32_t temp_size = 0;\n  if (__HAL_UART_GET_FLAG(&huart1, UART_FLAG_IDLE))\n  {\n    __HAL_UART_CLEAR_IDLEFLAG(&huart1);\n    HAL_UART_DMAStop(&huart1);\n    temp_size = RX_BUFFER_SIZE - __HAL_DMA_GET_COUNTER(&hdma_usart1_rx);  //å·²æ¥æ”¶æ•°æ®é•¿åº¦\n\n    if (temp_size != 0)\n    {\n      uint8_t txbuf3[] = \"rxidle\\n\";\n      HAL_UART_Transmit(&huart1, txbuf3, sizeof(txbuf3), 0xFFFF);\n      \n    }\n  }\n  /* USER CODE END USART1_IRQn 0 */\n\n  /* USER CODE BEGIN 1 */\nvoid HAL_UART_RxHalfCpltCallback(UART_HandleTypeDef *huart)\n{\n  if (huart->Instance == USART1)\n  {\n    uint8_t txbuf1[] = \"rxhalf\\n\";\n    HAL_UART_Transmit(&huart1, txbuf1, sizeof(txbuf1), 0xFFFF);\n  }\n}\n\nvoid HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)\n{\n  if (huart->Instance == USART1)\n  {\n    uint8_t txbuf2[] = \"rxfull\\n\";\n    HAL_UART_Transmit(&huart1, txbuf2, sizeof(txbuf2), 0xFFFF);\n  }\n}\n/* USER CODE END 1 */\n\n```\næ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¥æ”¶ç¼“å†²åŒºå¤§å°ä¸º10ï¼Œå½“å‘é€â€œ12â€ï¼ˆå®é™…ä¸º\"12\\r\\nâ€œå››ä¸ªå­—èŠ‚ï¼‰æ—¶ï¼Œåº”åªè§¦å‘ç©ºé—²ä¸­æ–­ï¼›å‘é€â€œ123â€æ—¶ï¼Œè§¦å‘åŠæ»¡ä¸­æ–­å’Œç©ºé—²ä¸­æ–­ï¼›å‘é€â€œ12345678â€æ—¶ï¼Œè§¦å‘åŠæ»¡ä¸­æ–­å’Œæ»¡æº¢ä¸­æ–­ã€‚ä½†æµ‹è¯•å‘ç°ï¼Œå‘é€â€œ12345678â€å…±è®¡åä¸ªå­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯é¢„æœŸæ¥æ”¶æ•°æ®å¤§å°ç­‰äºç¼“å†²åŒºå¤§å°æ—¶ï¼Œåªèƒ½è§¦å‘ä¸€æ¬¡åŠæ»¡ä¸­æ–­ï¼Œæ»¡æº¢ä¸­æ–­æ— æ³•è§¦å‘ã€‚è‹¥ç¦ç”¨ç©ºé—²ä¸­æ–­ï¼Œå‘é€â€œ12345678â€æ—¶ï¼ŒåŠæ»¡ä¸­æ–­å’Œæº¢æ»¡ä¸­æ–­éƒ½èƒ½è§¦å‘ï¼Œåˆæ­¥åˆ¤æ–­æ˜¯ç©ºé—²ä¸­æ–­çš„é—®é¢˜ã€‚\n\nç”±äºDMAé…ç½®åœ¨å¾ªç¯æ¨¡å¼ï¼Œå½“æ¥æ”¶æ•°æ®å¤§å°ç­‰äºç¼“å†²åŒºå¤§å°æ—¶ï¼ŒRXæ€»çº¿ä»ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œå› ä¸ºå³å°†åˆ°æ¥çš„æ–°çš„æ•°æ®ä¼šè¦†ç›–æ‰ç¯å½¢é˜Ÿåˆ—çš„ç¬¬ä¸€é¡¹ï¼Œå› æ­¤å®é™…ä¸ŠNVICä¼šå…ˆè§¦å‘ç©ºé—²ä¸­æ–­ï¼Œè€Œç©ºé—²ä¸­æ–­ä¸­æœ‰è¿™ä¸€æ®µä»£ç ï¼š\n```\n    temp_size = RX_BUFFER_SIZE - __HAL_DMA_GET_COUNTER(&hdma_usart1_rx);  //å·²æ¥æ”¶æ•°æ®é•¿åº¦\n\n    if (temp_size != 0)\n    {\n      uint8_t txbuf3[] = \"rxidle\\n\";\n      HAL_UART_Transmit(&huart1, txbuf3, sizeof(txbuf3), 0xFFFF);\n    }\n```\nå½“æ¥æ”¶æ•°æ®å¤§å°ç­‰äºç¼“å†²åŒºå¤§å°æ—¶ï¼Œ`temp_size`å®é™…ä¸Šç­‰äº0ï¼Œå¯¼è‡´ç¨‹åºåœ¨ç©ºé—²ä¸­æ–­ä¸­ç›´æ¥è·³è¿‡äº†æ»¡æº¢åˆ¤æ–­ï¼Œå¼€å§‹ä¸‹ä¸€æ¬¡æ¥æ”¶ã€‚å› æ­¤éœ€è¦å•ç‹¬å¯¹`temp_size == 0`è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼š\n```\n  /* USER CODE BEGIN USART1_IRQn 0 */\n  uint32_t temp_size = 0;\n  if (__HAL_UART_GET_FLAG(&huart1, UART_FLAG_IDLE))\n  {\n    temp_size = RX_BUFFER_SIZE - __HAL_DMA_GET_COUNTER(&hdma_usart1_rx); \n    idle_flag = 1;\n    __HAL_UART_CLEAR_IDLEFLAG(&huart1);\n    if (temp_size == 0) //æ»¡æº¢\n    {\n       //æ»¡æº¢å›è°ƒ\n    }\n    else if (temp_size != 0)  //éæ»¡æº¢\n    {\n      HAL_UART_DMAStop(&huart1);\n      uint8_t txbuf3[] = \"rxidle\\n\";\n      HAL_UART_Transmit(&huart1, txbuf3, sizeof(txbuf3), 0xFFFF);\n      HAL_UART_Receive_DMA(&huart1, Rx_buffer, RX_BUFFER_SIZE);\n    }\n  }\n  /* USER CODE END USART1_IRQn 0 */\n```\nè¿™æ ·ï¼Œç©ºé—²ä¸­æ–­åœ¨æ•°æ®å¡«æ»¡ç¼“å†²åŒºæ—¶ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œè€Œç›´æ¥è·³å‡ºã€‚åªæœ‰å½“æ•°æ®æœªå¡«æ»¡ç¼“å†²åŒºæ—¶æ‰ä¼šè¿›è¡ŒåŸå…ˆçš„æ“ä½œï¼ˆä¸»è¦æ˜¯DMAStopè¿™ä¸€æ­¥ï¼‰ã€‚åˆ°è¿™é‡Œï¼Œä¸‰ä¸ªä¸­æ–­è§¦å‘çš„é€»è¾‘æ€»ç®—æ˜¯ç†é¡ºäº†ï¼Œæ¥ä¸‹æ¥åªéœ€è¦è¿›è¡Œæ¬è¿æ•°æ®çš„å¤„ç†å°±å¯ä»¥äº†ã€‚\n\n`usart.c`ï¼š\n```\n/* USER CODE BEGIN 1 */\nvoid HAL_UART_RxHalfCpltCallback(UART_HandleTypeDef *huart)\n{\n  if (huart->Instance == USART1)\n  {\n    Rx_half_flag = 1; //åŠæ»¡æ ‡è®°\n    uint8_t txbuf1[] = \"rxhalf\\n\";\n    HAL_UART_Transmit(&huart1, txbuf1, sizeof(txbuf1), 0xFFFF);\n\n    Rx_buffer_head = Rx_buffer_tail;\n    Rx_buffer_tail = RX_BUFFER_SIZE / 2 - 1;\n\n    for (int i = Rx_buffer_head; i <= Rx_buffer_tail; i++)\n    {\n      Rx_final[Rx_final_index] = Rx_buffer[i];\n      Rx_final_index++;\n    }\n    \n  }\n}\nvoid HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)\n{\n  if (huart->Instance == USART1)\n  {\n    Rx_half_flag = 0; //æ¸…é™¤åŠæ»¡æ ‡è®°\n\n    uint8_t txbuf2[] = \"rxfull\\n\";\n    HAL_UART_Transmit(&huart1, txbuf2, sizeof(txbuf2), 0xFFFF);\n\n    Rx_buffer_head = Rx_buffer_tail + 1;\n    Rx_buffer_tail = RX_BUFFER_SIZE - 1;\n\n    for (int i = Rx_buffer_head; i <= Rx_buffer_tail; i++)\n    {\n      Rx_final[Rx_final_index] = Rx_buffer[i];\n      Rx_final_index++;\n    }\n  }\n}\n/* USER CODE END 1 */\n```\n\nä¸­æ–­æœåŠ¡å‡½æ•°ï¼š\n```\n/* USER CODE BEGIN USART1_IRQn 0 */\n  uint32_t temp_size = 0;\n  if (__HAL_UART_GET_FLAG(&huart1, UART_FLAG_IDLE))\n  {\n    temp_size = RX_BUFFER_SIZE - __HAL_DMA_GET_COUNTER(&hdma_usart1_rx); //æœ¬æ¬¡æ¥æ”¶åˆ°çš„æ•°æ®å¤§å°\n    //idle_flag = 1;\n    __HAL_UART_CLEAR_IDLEFLAG(&huart1); //æ¸…é™¤Idleæ ‡è®°\n    if (temp_size == 0) //æ»¡æº¢\n    {\n       //æ»¡æº¢å›è°ƒ\n    }\n    else if (temp_size != 0)  //éæ»¡ ??\n    {\n      HAL_UART_DMAStop(&huart1);\n      \n      uint8_t txbuf3[] = \"rxidle\\n\";\n      HAL_UART_Transmit(&huart1, txbuf3, sizeof(txbuf3), 0xFFFF);\n\n      if (Rx_half_flag == 0)  //æœªåŠæ»¡ï¼Œå‰åŠæ®µè§¦å‘ç©ºé—²\n      {\n        Rx_buffer_head = Rx_buffer_tail;  \n        Rx_buffer_tail = Rx_buffer_tail + temp_size - 1; \n\n        //æ‹·è´æ•°æ®\n        for (int i = Rx_buffer_head; i <= Rx_buffer_tail; i++)\n        {\n          Rx_final[Rx_final_index] = Rx_buffer[i];\n          Rx_final_index++;\n        }  \n      }\n      else if (Rx_half_flag != 0) //å·²åŠæ»¡ï¼ŒååŠæ®µè§¦å‘ç©ºé—²\n      {\n        Rx_buffer_head = Rx_buffer_tail + 1;\n        Rx_buffer_tail = Rx_buffer_tail + temp_size - RX_BUFFER_SIZE / 2;\n\n        for (int i = Rx_buffer_head; i <= Rx_buffer_tail; i++)\n        {\n          Rx_final[Rx_final_index] = Rx_buffer[i];\n          Rx_final_index++;\n        }\n      }\n      temp_size = 0;\n      Rx_buffer_head = 0;\n      Rx_buffer_tail = 0;\n      Rx_half_flag = 0;\n      HAL_UART_Receive_DMA(&huart1,(uint8_t *) Rx_buffer, RX_BUFFER_SIZE);\n    }\n  }\n  /* USER CODE END USART1_IRQn 0 */\n```\n\nå†™åˆ°è¿™é‡Œåªå¤„ç†äº†å•æ¬¡æ¥æ”¶æ•°æ®å¤§å°å°äºç¼“å†²åŒºé•¿åº¦çš„æƒ…å†µï¼Œå¯ä»¥å‘ç°ä»£ç é‡è¿˜æ˜¯æŒºå¤§çš„ã€‚å°¤å…¶æ˜¯è¿™ä¹ˆå†™ä»£ç å­˜åœ¨ä¸€ä¸ªæ¯”è¾ƒéº»çƒ¦çš„é€»è¾‘ï¼šå½“DMAæ¥æ”¶çš„æ•°æ®é‡å¤§äºç¼“å†²åŒºå¤§å°`RX_BUFFER_SIZE`æ—¶ï¼Œç”±äºDMAå·¥ä½œåœ¨å¾ªç¯æ¨¡å¼ï¼Œé‚£ä¹ˆæº¢å‡ºçš„æ•°æ®ä¼šè¢«DMAé‡æ–°æ”¾åˆ°ç¼“å†²åŒºçš„å¼€å§‹éƒ¨åˆ†ï¼Œä»è€Œè¦†ç›–åŸæœ‰çš„æ•°æ®ã€‚è¦å¤„ç†è¿™éƒ¨åˆ†æ•°æ®åŠ¿å¿…è¦å¼•å…¥æ¯”è¾ƒå¤æ‚çš„åˆ¤æ–­æœºåˆ¶ï¼Œè¿˜è¦å®æ—¶æ›´æ–°é˜Ÿé¦–å’Œé˜Ÿå°¾çš„æŒ‡é’ˆï¼Œå¯¼è‡´æ•´ä¸ªç¨‹åºå˜å¾—æ¯”è¾ƒå¤æ‚ã€‚\n\nå¥½åœ¨HALåº“é™¤äº†æ™®é€šçš„`HAL_UART_Receive_DMA()`å’Œ`HAL_UART_RxCpltCallback()`å¤–ï¼ŒHALåº“è¿˜æä¾›äº†`HAL_UARTEx_RxEventCallback`å›è°ƒã€‚\n\n```\n/**\n  * @brief  Reception Event Callback (Rx event notification called after use of advanced reception service).\n  * @param  huart UART handle\n  * @param  Size  Number of data available in application reception buffer (indicates a position in\n  *               reception buffer until which, data are available)\n  * @retval None\n  */\n__weak void HAL_UARTEx_RxEventCallback(UART_HandleTypeDef *huart, uint16_t Size)\n{\n  /* Prevent unused argument(s) compilation warning */\n  UNUSED(huart);\n  UNUSED(Size);\n\n  /* NOTE : This function should not be modified, when the callback is needed,\n            the HAL_UARTEx_RxEventCallback can be implemented in the user file.\n   */\n}\n```\nè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨â€œadvanced reception serviceâ€äº‹ä»¶å‘ç”Ÿåè§¦å‘ï¼Œè¿™é‡Œçš„æ‰€è°“é«˜çº§æ¥æ”¶æœåŠ¡å°±åŒ…æ‹¬ä¹‹å‰éœ€è¦åˆ†å¼€åˆ¤æ–­çš„DMAåŠæ»¡ä¸­æ–­ã€DMAæ»¡æº¢ä¸­æ–­å’Œç©ºé—²ä¸­æ–­ï¼ˆå®é™…ä¸Šè¿˜æœ‰ä¸€ä¸ªé”™è¯¯ä¸­æ–­ï¼‰ã€‚è¿™ä¸‰ä¸ªä¸­æ–­è§¦å‘åéƒ½ä¼šå›è°ƒ`HAL_UARTEx_RxEventCallback()`å‡½æ•°ã€‚åœ¨æ‹·è´æ•°æ®æ—¶ï¼Œæ— éœ€å†å•ç‹¬è¿›è¡Œä¸­æ–­å›è°ƒç±»å‹çš„åˆ¤æ–­ã€‚ç”±äºDMAå·¥ä½œä¸ä¾èµ–CPUï¼Œå› æ­¤åœ¨è¯¥å‡½æ•°å†…è¦åšçš„å°±æ˜¯å°†ç¼“å†²åŒºå†…çš„æ•°æ®æ‹·è´è‡³ç›®æ ‡åœ°å€ã€‚æ³¨æ„è¿™é‡Œçš„å½¢å‚`Size`è¡¨ç¤ºç¼“å†²åŒºå¯ç”¨æ•°æ®é•¿åº¦ï¼ˆä»è¿™ä¸ªä½ç½®å¼€å§‹å¾€åçš„ä½ç½®éƒ½ä¸ºç©ºï¼‰ï¼Œè€Œä¸æ˜¯æœ¬æ¬¡å›è°ƒæ‰€æ¥æ”¶çš„æ•°æ®é•¿åº¦ã€‚\n\n![ä¸‰ç§ä¸­æ–­äº‹ä»¶åœºæ™¯](/images/arm/rxhalf.png)\n\nå†å¯¹ç…§ä¸€ä¸‹è¿™å¼ å›¾ï¼Œçº¢è‰²çš„éƒ¨åˆ†å°±æ˜¯`rx_size`ï¼Œå…¶å€¼ç­‰äº`Size`ï¼ˆç¼“å†²åŒºæ€»çš„æœ‰æ•ˆæ•°æ®é•¿åº¦ï¼‰å‡å»`rx_buf_head`ï¼ˆå¤´æŒ‡é’ˆï¼‰ã€‚å½“ç¼“å†²åŒºæº¢å‡ºå¹¶å¾ªç¯å­˜å‚¨æ–°æ•°æ®è‡³ç¼“å†²åŒºå¼€å¤´æ—¶ï¼Œ`Size`ä¼šåŒæ­¥æ›´æ–°ã€‚\n\nåŸå…ˆçš„ä¸‰ä¸ªä¸­æ–­ä¸­çš„ä»£ç å¯ä»¥åˆåˆ°ä¸€ä¸ªä¸­å®ç°ï¼š\n```\n/* USER CODE BEGIN 1 */\nvoid HAL_UARTEx_RxEventCallback(UART_HandleTypeDef *huart, uint16_t Size)\n{\n  uint8_t txbuf[] = \"rx done\\n\";\n  HAL_UART_Transmit_IT(&huart1, txbuf, sizeof(txbuf));\n\n  static uint8_t rx_buf_head = 0;\n  static uint8_t rx_size; //å¾…å¤„ç†æ•°æ®é•¿åº¦\n \n  rx_size = Size - rx_buf_head;\n\n  for (uint16_t i = 0; i < rx_size; i++)\n  {\n      RxFinal[final_index++] = RxBuf[(rx_buf_head + i) % RxBufSize]; // ç¯å½¢ç¼“å†²å¤„ç†\n      if (final_index >= RxFinalSize) final_index = 0; // é¿å… RxFinal æº¢å‡º\n  }\n\n  rx_buf_head = rx_buf_head + rx_size;\n\n  if (rx_buf_head >= RxBufSize) rx_buf_head = 0;\n}\n/* USER CODE END 1 */\n```\nè¿™ä¹ˆå†™å°±æ— éœ€åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸ªä¸­æ–­è§¦å‘çš„å›è°ƒï¼Œåªéœ€è¦é€šè¿‡`Size`å’Œå¤´æŒ‡é’ˆä½ç½®è®¡ç®—æœ¬æ¬¡æ¥æ”¶åˆ°çš„æ•°æ®é•¿åº¦ï¼Œç„¶åæŒ‰ç…§é˜Ÿåˆ—é€»è¾‘æŒ‰æ¬¡åºæ‹·è´å³å¯ï¼Œå› DMAå¾ªç¯è€Œå¼•èµ·çš„æº¢å‡ºå¯é€šè¿‡å–æ¨¡æ“ä½œæ¥å¤„ç†ã€‚\n\n\n\néªŒè¯ï¼š\n1. è¾“å…¥â€œ12345678\\r\\nâ€:![](/images/arm/test1.png)\n\n2. è¾“å…¥â€œ123456789abcdefghijklmnâ€ï¼š![](/images/arm/test2.png)\n\n3. å…ˆè¾“å…¥\"123\"ï¼Œå†è¾“å…¥\"1234567â€œï¼Œå†è¾“å…¥\"12\"ï¼Œå†è¾“å…¥\"123456789â€ï¼š![](/images/arm/test3.png)\n\néªŒè¯æˆåŠŸã€‚\n\n[Githubé¡¹ç›®åœ°å€](https://github.com/AkiChen891/STM32F429-UART-DMA-Ping-Pong-Cache)","categories":["åµŒå…¥å¼ï¼ˆè£¸æœºå¼€å‘ï¼‰"]},{"title":"çº¿æ€§ç³»ç»Ÿç†è®ºæœŸæœ«è€ƒç‚¹","url":"/2024/10/22/çº¿æ€§ç³»ç»Ÿç†è®ºæœŸæœ«è€ƒç‚¹/","content":"## ç¬¬ä¸ƒç«  æ•°å­¦åŸºç¡€\n- å•æ¨¡çŸ©é˜µä¸å•æ¨¡å˜æ¢\n- äº’è´¨æ€§ä¸äº’è´¨æ€§åˆ¤æ®ï¼ˆç§©åˆ¤æ®ï¼‰\n- æ—¢çº¦æ€§ä¸æ—¢çº¦æ€§åˆ¤æ®ï¼ˆè¡Œæ¬¡ç³»æ•°çŸ©é˜µæˆ–åˆ—æ¬¡ç³»æ•°çŸ©é˜µï¼‰\n- éæ—¢çº¦çŸ©é˜µçš„æ—¢çº¦åŒ–\n- Smithæ ‡å‡†å½¢\n\n## ç¬¬å…«ç«  çŸ©é˜µåˆ†å¼æè¿°ï¼ˆMFDï¼‰\n- å·¦MFDä¸å³MFDçš„æ±‚æ³•\n- çœŸä¸ä¸¥çœŸçš„æ€§è´¨ä¸åˆ¤æ®\n    + æœ‰ç†åˆ†å¼åˆ¤åˆ«æ³•ï¼ˆåˆ†å­æ¬¡æ•°å°äºç­‰äºä¸ºçœŸï¼Œå°äºåˆ†æ¯æ¬¡æ•°ä¸ºä¸¥çœŸï¼‰\n    + $G(s)$é˜µåˆ¤åˆ«æ³•ï¼ˆsè¶‹å‘æ— ç©·æ—¶$G(s)$ç­‰äºå¸¸é˜µä¸ºçœŸï¼Œç­‰äºé›¶ä¸ºä¸¥çœŸï¼‰\n    + **åˆ—æ—¢çº¦**å³MFDåˆ—æ¬¡ç³»æ•°åˆ¤åˆ«æ³•\n    + **è¡Œæ—¢çº¦**å·¦MFDè¡Œæ¬¡ç³»æ•°åˆ¤åˆ«æ³•\n- ä»éçœŸMFDå¯¼å‡ºä¸¥çœŸMFDï¼ˆå¤šé¡¹å¼é™¤æ³•å¯¼å‡ºæœ‰ç†åˆ†å¼éƒ¨åˆ†å¹¶æ±‚å‡ºæ–°çš„$R(s)$ä½œä¸º$N(s)$ï¼‰\n- ä¸å¯ç®€çº¦MFDçš„æ€§è´¨ä¸åˆ¤æ®ï¼ˆäº’è´¨æ€§åˆ¤æ®ï¼Œåˆ¤æ–­æœ‰æ— åŒæ—¶é™ç§©çš„$s$å€¼ï¼‰\n- ç”±å¯ç®€çº¦MFDæ±‚ä¸å¯ç®€çº¦MFDçš„ç®—æ³•ï¼ˆä»¥å³MFDä¸ºä¾‹ï¼‰\n    + æ±‚gcrdè¡¨ä¸º$R(s)$\n    + æ±‚$R(s)$çš„é€†ï¼Œè¡¨ä¸º$R^{-1}(s)$\n    + $D(s)$å’Œ$N(s)$åˆ†åˆ«å³ä¹˜$R^{-1}(s)$å¾—åˆ°æ–°çš„$D(s)$å’Œ$N(s)$\n    + ç»„åˆï¼Œè§£æ¯•\n\n## ç¬¬ä¹ç«   ä¼ é€’å‡½æ•°çŸ©é˜µçš„ç»“æ„ç‰¹æ€§\n- å²å¯†æ–¯-éº¦å…‹ç±³ä¼¦å½¢çš„å½¢å¼ä¸å¯¼å‡º\n    + æ±‚å‡ºæ‰€æœ‰å…ƒæœ‰ç†åˆ†å¼çš„æœ€å°å…¬åˆ†æ¯ï¼Œè¡¨ä¸º$d(s)$\n    + åˆ†å­çŸ©é˜µåŒ–ä¸ºSmithæ ‡å‡†å½¢\n    + æ¶ˆå»å…¬å› å­ï¼Œè§£æ¯•\n- M(s)çš„åŸºæœ¬ç‰¹æ€§\n    + å”¯ä¸€æ€§\n    + éä¿çœŸæ€§\n- æœ‰é™é›¶ç‚¹å’Œæœ‰é™æç‚¹\n    + *Rosenbrock*é›¶æç‚¹å®šä¹‰ï¼ˆåŸºäºM(s)çš„åˆ¤åˆ«æ³•ï¼Œåªé€‚ç”¨äºæœ‰é™å¤å¹³é¢ï¼‰\n    + æ¨è®ºæ€§å®šä¹‰\n        + åŸºäº**ä¸å¯ç®€çº¦**MFDï¼šæç‚¹ä»¤$detD(s)$ç­‰äº0ï¼Œé›¶ç‚¹ä»¤$N(s)$é™ç§©\n        + åŸºäºçŠ¶æ€ç©ºé—´æ–¹ç¨‹ï¼šæç‚¹ä»¤$det(sI-A)=0$ï¼Œé›¶ç‚¹ä»¤ç³»ç»ŸçŸ©é˜µé™ç§©\n    + é›¶ç‚¹ç›´è§‚è§£é‡Šä¸å…¶é˜»å¡å®šç†ï¼ˆä¹¦P479ï¼‰\n- ç»“æ„æŒ‡æ•°\n    + å®šä¹‰ï¼ˆä¹¦P480ï¼‰ï¼Œæ¥è‡ªäºé›¶æç‚¹é›†åˆï¼ŒåŸºäºS-Må½¢æ±‚è§£\n    + å«ä¹‰ï¼ˆä¹¦P481ï¼‰\n- æ— ç©·è¿œå¤„çš„é›¶ç‚¹å’Œæç‚¹\n    + æ€è·¯ï¼šå¼•å…¥$s=\\lambda^{-1}$ï¼ŒåŒ–ä¸ºä»¥$\\lambda$ä¸ºå˜é‡çš„æœ‰ç†åˆ†å¼çŸ©é˜µ$H(\\lambda)$ï¼Œæ±‚å‡ºå…¶S-Må½¢ï¼Œç„¶åæŒ‰ç…§æœ‰é™é›¶æç‚¹å®šä¹‰æ±‚è§£\n- è¯„ä»·å€¼\n    + æœ‰é™å¤å¹³é¢çš„è¯„ä»·å€¼æ±‚æ³•ï¼ˆä¹¦P486ï¼‰\n    + ç”±è¯„ä»·å€¼æ„é€ S-Må½¢ï¼ˆä¹¦P489ï¼‰\n    + æ— ç©·è¿œå¤„è¯„ä»·å€¼æ±‚æ³•ï¼ˆåˆ†æ¯æ¬¡æ•°-åˆ†å­æ¬¡æ•°ï¼Œä¹¦P490ï¼‰\n- S-Må½¢çš„åˆæˆè¡¨è¾¾å¼ï¼ˆä¹¦P492ï¼‰\n\n### æ˜“é”™è€ƒç‚¹\n- é›¶æç‚¹æ¨è®ºæ€§å®šä¹‰éƒ½åŸºäº**ä¸å¯ç®€çº¦MFD**ï¼Œå¦‚æœé¢˜ç›®ç»™å‡ºçš„æ˜¯å¯ç®€çº¦MFDï¼Œéœ€è¦è½¬åŒ–ä¸ºä¸å¯ç®€çº¦MFD\n- æ ¹æ®$G(s)$æ±‚è¯„ä»·å€¼æ—¶ï¼Œç›´æ¥æ±‚å„é˜¶å­å¼ï¼Œå­å¼ä¸­åŒ…å«çš„åˆ†å¼æ‰€å¯¹åº”çš„$s$å³ä¸ºæ‰€æ±‚çš„é›¶æç‚¹é›†åˆï¼Œä¸éœ€è¦æ±‚$M(s)$å†æ±‚é›¶æç‚¹\n- $M(s)$ä¸­å¯¹è§’çº¿å„å…ƒç´ å¿…é¡»æ»¡è¶³æ•´é™¤æ€§ï¼Œå…·ä½“ä¸ºåˆ†å­æ¬¡æ•°éšä½ç½®å¢åŠ è¶Šæ¥è¶Šå¤§ï¼Œåˆ†æ¯æ¬¡æ•°è¶Šæ¥è¶Šå°\n- æ±‚è§£$M(s)$è¿‡ç¨‹ä¸­å¯¼å‡º$N(s)$æ—¶ï¼Œåˆ†æ¯éœ€é¦–ä¸€åŒ–\n- æ ¹æ®é›¶ç‚¹é˜»å¡å®šç†æ±‚å¯¹åº”çš„$x_0$å’Œ$u(t)$æ—¶ï¼Œå…ˆç”±$Cx_0=0$ç¡®è®¤éé›¶åˆå§‹çŠ¶æ€$x_0$ï¼Œç„¶åç”±$(sI-A)x_0+Bu_0=0$æ±‚$u_0$\n- $s$åœ¨æ— ç©·è¿œå¤„çš„è¯„ä»·å€¼å³ä¸ºå¯¹åº”çš„æœ‰ç†åˆ†å¼çš„åˆ†æ¯æ¬¡æ•°å‡å»åˆ†å­æ¬¡æ•°\n- $s$åœ¨æ— ç©·è¿œå¤„çš„é›¶ç‚¹å’Œæç‚¹å³ä¸º$\\lambda=1/s$çŸ©é˜µåœ¨$\\lambda=0$å¤„çš„é›¶ç‚¹å’Œæç‚¹\n\n## ç¬¬åç«  ä¼ é€’å‡½æ•°çŸ©é˜µçš„çŠ¶æ€ç©ºé—´å®ç°\n- å®ç°çš„å®šä¹‰ä¸å±æ€§ï¼ˆå”¯ä¸€æ€§ã€ç»´æ•°ã€æœ€å°å®ç°ï¼‰\n    + $G(s)=C(sI-A)^{-1}B$\n    + å®ç°ç»´æ•°ï¼š$dim(A)$\n    + æœ€å°å®ç°ï¼šæ‰€æœ‰å®ç°ä¸­ç»´æ•°æœ€å°\n- æ ‡é‡ä¼ é€’å‡½æ•°/ä¼ å‡½çŸ©é˜µçš„æ ‡å‡†å®ç°ï¼ˆè¦æ±‚$G(s)$ä¸¥çœŸï¼‰\n    + èƒ½æ§æ ‡å‡†å½¢å®ç°ï¼ˆä¹¦P528ï¼‰\n        - å°†$G(s)$è¡¨ç¤ºä¸º$\\frac{P(s)}{d(s)}$çš„å½¢å¼ï¼Œå¹¶å…¨éƒ¨å±•å¼€\n        - $P(s)$æŒ‰$s^n$ç³»æ•°æ‹†å¼€ä¸º$P_0(s)$ã€$P_1(s)$...\n        - ç±»ä¼¼äºæ ‡é‡ä¼ é€’å‡½æ•°èƒ½æ§å½¢æ±‚è§£æ–¹å¼è¿›è¡Œç»„åˆ\n        - èƒ½æ§å½¢å®ç°ä¸€èˆ¬ä¸ä¿è¯èƒ½è§‚æ€§\n    + èƒ½è§‚æ ‡å‡†å½¢å®ç°ï¼ˆä¹¦P530ï¼‰\n- MFDçš„æ ‡å‡†å®ç°ï¼ˆè¦æ±‚MFDä¸¥çœŸï¼‰\n    + æ§åˆ¶å™¨å½¢å®ç°\n    + è§‚æµ‹å™¨å½¢å®ç°\n\n### æ˜“é”™è€ƒç‚¹\n- æ§åˆ¶å™¨å½¢å’Œè§‚æµ‹å™¨å½¢éƒ½è¦æ±‚MFDä¸º**ä¸¥çœŸ**ï¼Œå¦‚æœç»™å‡ºçš„MFDéä¸¥çœŸï¼Œåˆ™éœ€æ±‚å…¶ä¸¥çœŸéƒ¨åˆ†çš„MFDã€‚åœ¨åˆ†ç¦»å‡º$Q(s)$å’Œ$G_{sp}(s)$åï¼Œè€ƒè™‘$G_{sp}(s)=R(s)\\times D^{-1}(s)$ï¼Œæœ‰$R(s)=G_{sp}(s)\\times D(s)$\n- è‹¥MFDä¸ºä¸å¯ç®€çº¦ï¼Œåˆ™è¯¥MFDçš„å®ç°å¿…ä¸ºæœ€å°å®ç°\n- æœ€å°å®ç°çš„å½¢å¼ä¸å”¯ä¸€ä½†å¿…å®šä»£æ•°ç­‰ä»·\n- è‹¥é¢˜ç›®è¦æ±‚åˆ¤æ–­æ˜¯å¦ä¸ºå®ç°ï¼Œåˆ™é€šè¿‡$G(s)=C(sI-A)^{-1}B$åˆ¤æ–­\n- å¦‚æœè¦æ±‚åˆ¤æ–­æ˜¯å¦ä¸ºæœ€å°å®ç°\n    + è‹¥å·²çŸ¥çŠ¶æ€ç©ºé—´æ–¹ç¨‹ï¼Œåˆ¤æ–­å…¶æ˜¯å¦åŒæ—¶æ»¡è¶³èƒ½æ§ä¸”èƒ½è§‚\n    + è‹¥å·²çŸ¥MFDï¼Œåˆ¤æ–­å…¶æ˜¯å¦ä¸ºä¸å¯ç®€çº¦\n- ç»™å®šMFDçš„æ§åˆ¶å™¨å½¢å®ç°ï¼Œåˆ¤æ–­å®ç°ç»´æ•°æ—¶ï¼Œæ‰€æ±‚ç»´æ•°å³ä¸º$dim(A_c)=deg det D(s)$\n- æ§åˆ¶å™¨å½¢æ±‚è§£æ­¥éª¤\n    1. ç¡®è®¤MFDä¸ºå³ä¸¥çœŸMFDï¼Œå¦‚éä¸¥çœŸï¼Œå°†å…¶ä¸¥çœŸåŒ–\n    2. å†™å‡ºæ¯è¡Œçš„åˆ—æ¬¡æ•°\n    3. å†™å‡º$D_{hc}$ã€$D_{lc}$ã€$N_{lc}$\n    4. å†™å‡º$A^{0}_c$ã€$B^{0}_c$\n    5. ç”±$A_c=A^{0}_c-B^{0}_c\\times D^{-1}_{hc}\\times D_{lc}$ã€$B_c=B^{0}_c\\times D^{-1}_{hc}$ã€$C_c=N_{lc}$\n\n## ç¬¬åä¸€ç«  PMD\n- PMDçš„å½¢å¼\n    - åŒä¼ é€’å‡½æ•°çŸ©é˜µ$G(s)$çš„å…³ç³»\n        + $G(s)=R^{-1}(s)P(s)Q(s)+W(s)$\n    - åŒçŠ¶æ€ç©ºé—´æè¿°çš„å…³ç³»\n        + $P(s)=sI-A,Q(s)=B,R(s)=C$\n    - åŒ**ä¸¥çœŸ**MFDçš„å…³ç³»\n        + å³MFDï¼š$P(s)=D(s),Q(s)=I,R(s)=N(s)$\n        + å·¦MFDï¼š$P(s)=D_L(s),Q(s)=N_L(s),R(s)=I$\n- ä¸å¯ç®€çº¦PMD\n    - åˆ¤æ–­ä¸å¯ç®€çº¦æ¡ä»¶\n        + $P(s),Q(s)$å·¦äº’è´¨\n        + $P(s),R(s)$å³äº’è´¨\n    - ä¸å¯ç®€çº¦PMDçš„æ„é€ ï¼ˆä¸å¯ç®€çº¦MFDæ„é€ çš„ç»„åˆï¼‰\n- PMDçš„è§‚æµ‹å™¨å½¢å®ç°\n    1. ç”±PMDåŒ–å·¦MFD\n    2. åˆ¤æ–­å·¦MFDè¡Œæ—¢çº¦ï¼Œååˆ¤æ–­æ˜¯å¦ä¸¥çœŸ\n    3. æ„é€ å·¦MFDè§‚æµ‹å™¨å½¢å®ç°\n    4. è½¬åŒ–ä¸ºPMDè§‚æµ‹å™¨å½¢å®ç°ï¼ˆä¹¦P579ï¼‰\n    5. åˆ¤æ–­æ˜¯å¦ä¸ºæœ€å°å®ç°ï¼ˆPMDä¸å¯ç®€çº¦ï¼ŒMFDä¸å¯ç®€çº¦ï¼Œå®Œå…¨èƒ½æ§å’Œèƒ½è§‚ï¼‰\n- PMDçš„æç‚¹å’Œé›¶ç‚¹\n    - PMDçš„æç‚¹ï¼ˆ$detP(s)=0$ï¼‰\n    - PMDçš„ä¼ è¾“é›¶ç‚¹ï¼ˆç³»ç»ŸçŸ©é˜µé™ç§©ï¼‰\n    - è¾“å…¥è§£è€¦é›¶ç‚¹ï¼ˆPQè¡Œé™ç§©ï¼‰\n    - è¾“å‡ºè§£è€¦é›¶ç‚¹ï¼ˆPRåˆ—é™ç§©ï¼‰\n- ç³»ç»ŸçŸ©é˜µ\n\n## ç¬¬åäºŒç«  çº¿æ€§æ—¶ä¸å˜æ§åˆ¶ç³»ç»Ÿçš„å¤é¢‘åŸŸåˆ†æ\n- å¹¶è”ç³»ç»Ÿ\n    + å®Œå…¨èƒ½æ§ == $D_1(s)$å’Œ$D_2(s)$å·¦äº’è´¨\n    + å®Œå…¨èƒ½è§‚ == $D_{L1}(s)$å’Œ$D_{L2}(s)$å³äº’è´¨\n    + $G_1(s)$å’Œ$G_2(s)$æ— å…¬å…±æç‚¹å¯æ¨å‡º$S_P$å®Œå…¨èƒ½æ§å’Œå®Œå…¨èƒ½è§‚\n- ä¸²è”ç³»ç»Ÿ\n    + å®Œå…¨èƒ½æ§ == $D_2(s)$å’Œ$N_1(s)$å·¦äº’è´¨\n    + å®Œå…¨èƒ½è§‚ == $D_{L1}(s)$å’Œ$N_{L2}(s)$å³äº’è´¨\n- è¾“å‡ºåé¦ˆç³»ç»Ÿçš„èƒ½è§‚/èƒ½æ§æ€§ï¼ˆä¹¦P622ï¼‰\n    + å®Œå…¨èƒ½æ§ == $S_{12}$å®Œå…¨èƒ½æ§\n    + å®Œå…¨èƒ½è§‚ == $S_{21}$å®Œå…¨èƒ½è§‚\n    + è‹¥$S_2$ä¸ºå¸¸é˜µï¼Œåˆ™$S_1$èƒ½æ§èƒ½è§‚ç­‰ä»·äºæ•´ä¸ªç³»ç»Ÿèƒ½æ§èƒ½è§‚\n    + $G_F(s)=G_1(s)[I+G_2(s)G_1(s)]^{-1}=[I+G_1(s)G_2(s)]^{-1}G_2(s)$\n- ç›´æ¥è¾“å‡ºåé¦ˆç³»ç»Ÿçš„ç¨³å®šæ€§åˆ†æ\n    + ç³»ç»ŸBIBOç¨³å®š == ç³»ç»Ÿæ¸è¿›ç¨³å®š\n    + ç³»ç»Ÿä»¥æœ‰ç†åˆ†å¼çŸ©é˜µè¡¨å¾æ—¶\n        - ç³»ç»Ÿæ¸è¿›/BIBOç¨³å®š == $\\Delta_1(s)det[I+G_1(s)]=0$çš„æ ¹å…¨éƒ¨å…·æœ‰è´Ÿå®éƒ¨\n    + ç³»ç»Ÿä»¥ä¸å¯ç®€çº¦å³MFDè¡¨å¾æ—¶\n        - ç³»ç»Ÿæ¸è¿›/BIBOç¨³å®š == $\\Delta_1(s)det[D_1(s)+N_1(s)]=0$çš„æ ¹å…¨éƒ¨å…·æœ‰è´Ÿå®éƒ¨\n    + ç³»ç»Ÿä»¥ä¸å¯ç®€çº¦å·¦MFDè¡¨å¾æ—¶\n        - ç³»ç»Ÿæ¸è¿›/BIBOç¨³å®š == $\\Delta_1(s)det[D_{L1}(s)+N_{L1}(s)]=0$çš„æ ¹å…¨éƒ¨å…·æœ‰è´Ÿå®éƒ¨\n- å¸¦è¡¥å¿å™¨çš„è¾“å‡ºåé¦ˆç³»ç»Ÿçš„ç¨³å®šæ€§\n    + æ¸è¿›ç¨³å®šä¸BIBOç¨³å®šçš„ç­‰ä»·æ¡ä»¶\n        - è‹¥$S_{12}$èƒ½æ§ï¼Œ$S_{21}$èƒ½è§‚ï¼ŒäºŒè€…ç­‰ä»·\n        - è‹¥ä¸æ»¡è¶³ä¸Šä¸€ä¸ªæ¡ä»¶ï¼Œåªèƒ½é€šè¿‡æ¸è¿›ç¨³å®šæ¨å‡ºBIBOç¨³å®š\n    + $G_1(s)$å’Œ$G_2(s)$å‡ä»¥æœ‰ç†åˆ†å¼çŸ©é˜µè¡¨å¾\n        - æ¸è¿›ç¨³å®š == $\\Delta_1(s)\\Delta_2(s)det[I+G_1(s)G_2(s)]=0$çš„æ ¹å…¨éƒ¨å…·æœ‰è´Ÿå®éƒ¨\n    + $G_1(s)$å’Œ$G_2(s)$ä»¥ä¸å¯ç®€çº¦å·¦MFDå’Œå³MFDè¡¨å¾\n        - æ¸è¿›ç¨³å®š == $det[D_{L1}(s)D_2(s)+N_{L1}(s)N_2(s)]=0$çš„æ ¹å‡å…·æœ‰è´Ÿå®éƒ¨\n    + $G_1(s)$å’Œ$G_2(s)$ä»¥ä¸å¯ç®€çº¦å³MFDå’Œå·¦MFDè¡¨å¾\n        - æ¸è¿›ç¨³å®š == $det[D_{L2}(s)D_1(s)+N_{L2}(s)N_1(s)]=0$çš„æ ¹å‡å…·æœ‰è´Ÿå®éƒ¨\n    + ç‰¹æ®Šæƒ…å½¢\n        - è‹¥åé¦ˆé€šè·¯ä¸ºå¸¸é˜µï¼Œåˆ™ç³»ç»Ÿæ¸è¿‘ç¨³å®š==BIBOç¨³å®š\n    \n\n\n"},{"title":"ã€çŸ©é˜µè®ºã€‘çŸ©é˜µåˆ†è§£","url":"/2024/10/20/ã€çŸ©é˜µè®ºã€‘çŸ©é˜µåˆ†è§£/","content":"\n## æ»¡ç§©åˆ†è§£(Full Rank Factorization)\nå°†ä¸€ä¸ªçŸ©é˜µåˆ†è§£ä¸ºä¸¤ä¸ªè¾ƒå°çŸ©é˜µçš„ä¹˜ç§¯ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªçŸ©é˜µçš„ç§©ä¸åŸçŸ©é˜µç›¸åŒã€‚æ»¡ç§©åˆ†è§£çš„ç›®çš„æ˜¯æŠŠçŸ©é˜µè¡¨ç¤ºä¸ºä¸¤ä¸ªæ›´ç®€å•çŸ©é˜µçš„ä¹˜ç§¯ï¼ŒåŒæ—¶ä¿æŒåŸçŸ©é˜µçš„ç§©ã€‚\n### å‰ç½®å®šç†\n- ä»»ä½•éé›¶çŸ©é˜µéƒ½å­˜åœ¨æ»¡ç§©åˆ†è§£\n- æ»¡ç§©åˆ†è§£å¯åˆ†ä¸º**è¡Œæ»¡ç§©åˆ†è§£**å’Œ**åˆ—æ»¡ç§©åˆ†è§£**\n- æ»¡ç§©åˆ†è§£ä¸å”¯ä¸€\n### è¡Œæ»¡ç§©åˆ†è§£æ­¥éª¤\n1. å¯¹çŸ©é˜µ$A$è¿›è¡Œè¡Œå˜æ¢ï¼ŒåŒ–ä¸ºè¡Œæœ€ç®€å½¢$\\hat A$ï¼Œå³æ¯ä¸€è¡Œçš„ç¬¬ä¸€ä¸ªéé›¶å…ƒç´ ä¸º1ï¼Œå¹¶ä¸”æ˜¯å…¶æ‰€åœ¨çš„åˆ—çš„å”¯ä¸€ä¸€ä¸ªéé›¶å…ƒç´ \n2. æ ‡è®°æ¯ä¸€ä¸ªéé›¶è¡Œçš„ç¬¬ä¸€ä¸ªéé›¶å…ƒç´ æ‰€åœ¨çš„åˆ—ï¼Œæ­¤å¤„å‡è®¾ä¸º1ï¼Œ2ï¼Œ3\n3. $B$ä¸º$A$çš„ç¬¬1ï¼Œ2ï¼Œ3åˆ—ï¼Œ$C$ä¸º$\\hat A$çš„ç¬¬1ï¼Œ2ï¼Œ3è¡Œ\n4. $A=BC$å³ä¸ºè¡Œæ»¡ç§©åˆ†è§£\n### åˆ—æ»¡ç§©åˆ†è§£æ­¥éª¤\n1. å¯¹çŸ©é˜µ$A$è¿›è¡Œåˆ—å˜æ¢ï¼ŒåŒ–ä¸ºåˆ—æœ€ç®€å½¢$\\hat A$ï¼Œå³æ¯ä¸€åˆ—çš„ç¬¬ä¸€ä¸ªéé›¶å…ƒç´ ä¸º1ï¼Œå¹¶ä¸”æ˜¯å…¶æ‰€åœ¨çš„è¡Œçš„å”¯ä¸€ä¸€ä¸ªéé›¶å…ƒç´ \n2. æ ‡è®°æ¯ä¸€ä¸ªéé›¶åˆ—çš„ç¬¬ä¸€ä¸ªéé›¶å…ƒç´ æ‰€åœ¨çš„è¡Œï¼Œæ­¤å¤„å‡è®¾ä¸º1ï¼Œ2ï¼Œ3\n3. $C$ä¸º$A$çš„ç¬¬1ï¼Œ2ï¼Œ3è¡Œï¼Œ$B$ä¸º$\\hat A$çš„ç¬¬1ï¼Œ2ï¼Œ3åˆ—\n4. $A=BC$å³ä¸ºåˆ—æ»¡ç§©åˆ†è§£\n\n## URåˆ†è§£\nä¹Ÿè¢«ç§°ä¸ºQRåˆ†è§£æˆ–æ­£äº¤ä¸‰è§’åˆ†è§£ã€‚\n### å‰ç½®å®šç†\n- è‹¥$A$ä¸ºåˆ—æ»¡ç§©çŸ©é˜µï¼Œåˆ™$A$å¯ä»¥å”¯ä¸€åœ°è¢«åˆ†è§£ä¸º$A=UR$ï¼Œå…¶ä¸­$U$ä¸ºåˆ—æ»¡ç§©çŸ©é˜µï¼Œ$R$ä¸ºæ­£çº¿ä¸Šä¸‰è§’é˜µã€‚\n- URåˆ†è§£æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ»¡ç§©åˆ†è§£ã€‚\n### æ­¥éª¤\n1. ä»¤$A=[\\alpha_1,\\alpha_2,\\alpha_3]$\n2. å°†$[\\alpha_1,\\alpha_2,\\alpha_3]$æ­£äº¤åŒ–ã€å•ä½åŒ–ï¼Œé‡æ–°ç»„åˆï¼Œå³å¾—åˆ°$U$\n3. æ ¹æ®$A=UR$ï¼Œæœ‰$R=U^H A$ï¼Œæ±‚å‡º$R$\n4. URåˆ†è§£å³ä¸º$A=UR$\n\n## å¥‡å¼‚å€¼åˆ†è§£\nå¥‡å¼‚å€¼åˆ†è§£çš„å½¢å¼ä¸ºï¼š\n\n$$\nA=U\n\\begin{bmatrix}\n\\Delta & 0 \\\\\n0 & 0\\\n\\end{bmatrix}\nV^H\n$$\n\n### å‰ç½®å®šç†\n- $A^H A$å’Œ$AA^H$å‡ä¸ºåŠæ­£å®šï¼Œç‰¹å¾å€¼å‡ä¸ºéè´Ÿå®æ•°\n- $A^H A$å’Œ$AA^H$çš„éé›¶ç‰¹å¾å€¼ç›¸åŒ\n- å¥‡å¼‚å€¼åˆ†è§£é€šå¸¸ä¸å”¯ä¸€\n\n### æ­¥éª¤ï¼ˆæ–¹æ³•ä¸€ï¼‰\nè¯¥æ–¹æ³•ç”±$AA^H$æ±‚$U_1$ã€‚\n1. æ±‚å‡º$AA^H$çš„å…¨éƒ¨éé›¶ç‰¹å¾å€¼ï¼Œç”±å¤§åˆ°å°æ’åˆ—ï¼Œå¹¶ä»¥æ­¤ä¸ºåºå†™å‡ºå¥‡å¼‚å€¼çŸ©é˜µ$\\Delta$\n2. æ±‚å‡º$AA^H$çš„æ‰€æœ‰ç‰¹å¾å€¼å¯¹åº”çš„ç‰¹å¾å‘é‡ï¼Œæ­£äº¤åŒ–åŠ å•ä½åŒ–åç»„åˆï¼Œå¾—åˆ°çŸ©é˜µ$U$\n3. è®¾$AA^H$æœ‰$n$ä¸ªéé›¶å¥‡å¼‚å€¼ï¼Œåˆ™å–å‡º$U$çš„å‰$n$åˆ—ï¼Œç»„åˆå¾—åˆ°$U_1$\n4. ç”±$V_1=A^HU_1\\Delta^{-H}$ï¼Œæ±‚å¾—$V_1$\n5. æ‰©å±•$V_1$è‡³$V$ï¼Œå…¶ä¸­æ–°æ·»åŠ çš„åˆ—å‘é‡$V_2$åº”ä¸$V_1$æ­£äº¤åŒ–ã€å•ä½åŒ–\n6. è§£æ¯•\n\n### æ­¥éª¤ï¼ˆæ–¹æ³•äºŒï¼‰\nè¯¥æ–¹æ³•ç”±$A^HA$æ±‚$V_1$ã€‚\n1. æ±‚å‡º$A^HA$çš„å…¨éƒ¨éé›¶ç‰¹å¾å€¼ï¼Œç”±å¤§åˆ°å°æ’åˆ—ï¼Œå¹¶ä»¥æ­¤ä¸ºåºå†™å‡ºå¥‡å¼‚å€¼çŸ©é˜µ$\\Delta$\n2. æ±‚å‡º$A^HA$çš„æ‰€æœ‰ç‰¹å¾å€¼å¯¹åº”çš„ç‰¹å¾å‘é‡ï¼Œæ­£äº¤åŒ–åŠ å•ä½åŒ–åç»„åˆï¼Œå¾—åˆ°çŸ©é˜µ$V$\n3. è®¾$A^HA$æœ‰$n$ä¸ªéé›¶å¥‡å¼‚å€¼ï¼Œåˆ™å–å‡º$V$çš„å‰$n$åˆ—ï¼Œç»„åˆå¾—åˆ°$V_1$\n4. ç”±$U_1 = AV_1\\Delta^{-1}$ï¼Œæ±‚å¾—$U_1$\n5. æ‰©å±•$U_1$è‡³$U$ï¼Œå…¶ä¸­æ–°æ·»åŠ çš„åˆ—å‘é‡$U_2$åº”ä¸$U_1$æ­£äº¤åŒ–ã€å•ä½åŒ–\n6. è§£æ¯•\n\n## è°±åˆ†è§£\nè°±åˆ†è§£ä¸å”¯ä¸€ã€‚\n### æ­¥éª¤\n1. æ±‚ç‰¹å¾å€¼åŠå…¶æ‰€å¯¹åº”çš„ç‰¹å¾å‘é‡\n2. æ— éœ€è¿›è¡Œæ­£äº¤åŒ–æˆ–å•ä½åŒ–ï¼Œç»„åˆç‰¹å¾å‘é‡ï¼Œå¾—åˆ°çŸ©é˜µ$P$\n3. æ±‚$P^{-1}$\n\nè‹¥ç‰¹å¾å€¼æ— é‡æ ¹ï¼š\n\n4. æŒ‰ç…§ç‰¹å¾å€¼æ¬¡åº$i$ï¼Œä¾æ¬¡å–$P$çš„ç¬¬$i$åˆ—å’Œ$P^{-1}$çš„ç¬¬$i$åˆ—ï¼ŒäºŒè€…ç›¸ä¹˜ï¼Œå¾—åˆ°$H_i$\n\nè‹¥ç‰¹å¾å€¼æœ‰é‡æ ¹ï¼š\n\n4. æŒ‰ç…§ç‰¹å¾å€¼æ¬¡åº$i$ï¼Œè‹¥æŸç‰¹å¾å€¼æœ‰$n$é‡æ ¹ï¼Œåˆ™åœ¨å–åˆ—å’Œè¡Œæ—¶ä¸€æ¬¡æ€§å–$n$æ¬¡ï¼Œç„¶åäºŒè€…ç›¸ä¹˜ï¼Œå¾—åˆ°$H_i$\n\n5. ç»„åˆï¼Œè¯æ¯•\n"},{"title":"æ•°æ®ç»“æ„ç¬”è®°ã€2ã€‘","url":"/2024/10/11/æ•°æ®ç»“æ„ç¬”è®°ã€2ã€‘/","content":"## é“¾å¼å­˜å‚¨\n### çº¿æ€§è¡¨ä¹‹å•é“¾è¡¨\nå°†çº¿æ€§è¡¨çš„ä¸ªå…ƒç´ åˆ†å¸ƒåœ¨å­˜å‚¨å™¨çš„ä¸åŒå­˜å‚¨å—ï¼Œç§°ä¸ºç»“ç‚¹ï¼Œé€šè¿‡åœ°å€æˆ–æŒ‡é’ˆå»ºç«‹å…ƒç´ ä¹‹é—´çš„è”ç³»ã€‚\n\nç»“ç‚¹åˆ†ä¸ºdataåŸŸå’ŒnextåŸŸï¼ŒnextåŸŸæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘$a_i$çš„ç›´æ¥åç»§$a_{i+1}$çš„æ‰€åœ¨ç»“ç‚¹ã€‚nextä¸ºNULLæ—¶è¡¨æ˜è¯¥å…ƒç´ ä¸ºé“¾è¡¨æœ€åä¸€ä¸ªå…ƒç´ ã€‚\n\nå¤´ç»“ç‚¹ï¼šdataä¸é‡è¦ï¼Œä¸“é—¨ç”¨æ¥æ ‡è®°ç¬¬ä¸€ä¸ªå…ƒç´ çš„ç»“ç‚¹åœ°å€\n\nç»“ç‚¹ç±»å‹æè¿°:\n```\ntypedef struct node\n{\n    data_t data;    //æ•°æ®åŸŸ\n    struct node *next;  //ç»“ç‚¹çš„åç»§æŒ‡é’ˆåŸŸ\n}listnode, *linklist;   //linklist æ˜¯ä¸€ä¸ªæŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆç±»å‹ï¼Œç”¨äºæ“ä½œé“¾è¡¨çš„å¤´æŒ‡é’ˆ\n```\næ‰€ä»¥æœ‰\n```\nlistnode A; // å®šä¹‰ä¸€ä¸ªç»“ç‚¹\nlinklist p = &A;  // å®šä¹‰ä¸€ä¸ªé“¾è¡¨å¤´æŒ‡é’ˆï¼Œå¹¶æŒ‡å‘ A ç»“ç‚¹\n```\n- è·å–$a_i$:  p->data;\n\n- è·å–$a_{i+1}$:  p->next->data;\n\nè‹¥æŒ‡é’ˆpçš„å€¼ä¸ºNULLï¼Œåˆ™å…¶ä¸æŒ‡å‘ä»»ä½•ç»“ç‚¹ï¼Œæ­¤æ—¶å–p->dataæˆ–p->nextæ˜¯é”™è¯¯çš„\n\n#### å•é“¾è¡¨çš„éå†\nçº¿æ€§å­˜å‚¨ä¸­ï¼Œéå†åŸºäºè¡¨å°¾æ ‡è¯†ç¬¦lastå®Œæˆï¼Œç´¢å¼•$i$ä»0å¾ªç¯åˆ°lastè§†ä¸ºéå†ä¸€æ¬¡ã€‚\n\né“¾å¼å­˜å‚¨ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´ç”±nextè¿›è¡Œåç»§è¿æ¥ï¼Œæ‰€ä»¥éå†åº”å½“ä»å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œç”±`head = head->next`æ–¹å¼è¿›è¡Œç´¢å¼•ï¼ˆæŒ‡é’ˆï¼‰æ›´æ–°\n\nç¤ºä¾‹ï¼š\n\n```\n/*\n    * @brief: éå†é“¾è¡¨å¹¶æ‰“å°å…¶ä¸­çš„å…ƒç´ \n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @return: éå†æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_show(linklist H)\n{\n    linklist p;\n\n    if (H == NULL) // å¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å› NULL\n    {\n        printf(\"H is NULL\\n\");\n        return -1;\n    }\n\n    p = H->next; //p æŒ‡å‘å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ æ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯çº¿æ€§å­˜å‚¨ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œä¸èƒ½å†™æˆp=H+1\n    while (p != NULL)\n    {\n        printf(\"%d \",p->data);\n        p = p->next;  //pæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n    }\n\n    return 0;\n}\n```\n\n#### å•é“¾è¡¨è·å–æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹åœ°å€\nå¤´èŠ‚ç‚¹åªæœ‰NextåŸŸï¼Œæ²¡æœ‰dataåŸŸï¼›å°¾èŠ‚ç‚¹åªæœ‰dataåŸŸï¼ŒNextåŸŸä¸ºNULLã€‚\n\nlist_get()å‡½æ•°éå†åˆ°æŒ‡å®šé“¾è¡¨çš„posä½ç½®ï¼Œéå†åˆ°ä¹‹åè¿”å›æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚æ³¨æ„éå†å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼ï¼š\n- ä»å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œåˆå§‹åŒ–p = head,i = -1ï¼Œéå†åˆ°i < posæ—¶ç»“æŸï¼Œæ­¤æ—¶çš„posæ˜¯åŒ…å«å¤´èŠ‚ç‚¹åœ¨å†…çš„ä½ç½®ï¼Œæ¯”å¦‚é“¾è¡¨{1,2,6,3}ï¼Œå…ƒç´ 2çš„ä½ç½®æ˜¯2ï¼Œä¸æ˜¯1ï¼›\n- ä»å¤´èŠ‚ç‚¹ä¹‹åçš„ç¬¬ä¸€ä¸ªç»“ç‚¹å¼€å§‹ï¼Œåˆå§‹åŒ–p = head->next; i = 0ï¼Œéå†åˆ°i < posæ—¶ç»“æŸï¼Œæ­¤æ—¶çš„posæ˜¯ä¸åŒ…å«å¤´èŠ‚ç‚¹åœ¨å†…çš„ä½ç½®ï¼Œæ¯”å¦‚é“¾è¡¨{1,2,6,3}ï¼Œå…ƒç´ 2çš„ä½ç½®æ˜¯1ï¼›\n\n```\n/*\n    * @brief: è·å–é“¾è¡¨ä¸­æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹åœ°å€\n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @param: pos: æŒ‡å®šçš„ä½ç½®\n    * @return: æ’å…¥æˆåŠŸè¿”å›æ‰¾åˆ°çš„ç»“ç‚¹ï¼Œå¤±è´¥è¿”å›NULL\n*/\nlinklist list_get(linklist H, int pos)\n{\n    linklist p; // å£°æ˜ä¸€ä¸ªæŒ‡å‘é“¾è¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œç”¨äºéå†é“¾è¡¨\n    int i = -1; // ç”¨äºè®°å½•éå†ä½ç½®ï¼Œåˆå§‹åŒ–ä¸º-1ä»¥è€ƒè™‘å¤´ç»“ç‚¹\n\n    if (H == NULL) // å¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å› NULL\n    {\n        printf(\"H is NULL\\n\");\n        return NULL;\n    }\n\n    if (pos == -1) // å¦‚æœ pos == -1ï¼Œè¿”å›å¤´ç»“ç‚¹\n    {\n        return H;\n    }\n\n    p = H; // ä»å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹éå†\n    while (i < pos) // å½“ i å°äº pos æ—¶ç»§ç»­å¾ªç¯\n    {\n        p = p->next; // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n        if (p == NULL)  // å¦‚æœé“¾è¡¨åˆ°è¾¾äº†æœ«å°¾ï¼Œä¸”è¿˜æ²¡æ‰¾åˆ° posï¼Œè¿”å› NULL\n        {\n            printf(\"pos is invalid\\n\");\n            return NULL;\n        }\n        i++; // è®°å½•å½“å‰éå†åˆ°çš„èŠ‚ç‚¹ç¼–å·\n    }\n\n    return p; // è¿”å›æ‰¾åˆ°çš„èŠ‚ç‚¹\n}\n```\n#### å•é“¾è¡¨çš„å…¶ä»–æ“ä½œ\n```\n#include <stdio.h>\n#include <stdlib.h>\n#include \"linklist.h\"\n\n/*\n    * @brief: åˆ›å»ºä¸€ä¸ªç©ºçš„é“¾å¼çº¿æ€§è¡¨\n    * @param: æ— \n    * @return: è¿”å›é“¾è¡¨çš„å¤´æŒ‡é’ˆ\n*/\nlinklist list_create()\n{\n    linklist head = (linklist)malloc(sizeof(listnode));\n\n    if (head == NULL)\n    {\n        printf(\"memory allocation failed\\n\");\n        return NULL;\n    }\n    head->next = NULL;  // åˆå§‹åŒ–å¤´ç»“ç‚¹çš„æŒ‡é’ˆåŸŸä¸ºç©ºï¼Œè¡¨ç¤ºé“¾è¡¨ä¸ºç©º\n    return head;\n}\n\n/*\n    * @brief: æ’å…¥å…ƒç´ åˆ°é“¾è¡¨ä¸­\n    * @param: head: æŒ‡å‘é“¾è¡¨å¤´ç»“ç‚¹çš„æŒ‡é’ˆ\n    * @param: value: è¦æ’å…¥çš„å€¼\n    * @param: posï¼šæ’å…¥ä½ç½®ï¼Œæ–°çš„èŠ‚ç‚¹ä¼šæ”¾ç½®åœ¨è¯¥ä½ç½®ä¹‹å\n    * @return: æ’å…¥æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_insert(linklist head, data_t value, int pos)\n{\n    if (head == NULL) return -1;  // æ£€æŸ¥é“¾è¡¨æ˜¯å¦å­˜åœ¨\n\n    // å¦‚æœè¦åœ¨ç¬¬ 0 ä½æ’å…¥èŠ‚ç‚¹ï¼ˆå¤´ç»“ç‚¹ä¹‹åï¼‰\n    if (pos == 0)\n    {\n        linklist new_node = (linklist)malloc(sizeof(listnode));   //ä¸ºæ–°èŠ‚ç‚¹ç”³è¯·å†…å­˜ \n        if (new_node == NULL)\n        {\n            printf(\"memory allocation failed\\n\");\n            return -1;\n        }\n\n        new_node->data = value;   // æ–°èŠ‚ç‚¹çš„æ•°æ®åŸŸèµ‹å€¼\n        new_node->next = head->next;  // æ–°èŠ‚ç‚¹æŒ‡å‘å¤´ç»“ç‚¹åçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹\n        head->next = new_node;  // å¤´ç»“ç‚¹çš„nextæŒ‡å‘æ–°æ’å…¥çš„èŠ‚ç‚¹\n        return 0;\n    }\n\n    // å¦åˆ™æŸ¥æ‰¾ pos-1 ä½ç½®çš„å‰é©±èŠ‚ç‚¹\n    linklist prev_node = list_get(head, pos-1);\n    if (prev_node == NULL)\n    {\n        printf(\"Invalid position\\n\");\n        return -1;\n    }\n\n    // ä¸ºæ–°èŠ‚ç‚¹ç”³è¯·å†…å­˜\n    linklist new_node = (linklist)malloc(sizeof(listnode));   \n    if (new_node == NULL)\n    {\n        printf(\"memory allocation failed\\n\");\n        return -1;\n    }\n\n    new_node->data = value;  // è®¾ç½®æ–°èŠ‚ç‚¹çš„æ•°æ®\n    new_node->next = prev_node->next;  // æ–°èŠ‚ç‚¹æŒ‡å‘åŸé“¾è¡¨åœ¨æ’å…¥ä½ç½®åçš„èŠ‚ç‚¹\n    prev_node->next = new_node;  // å‰é©±èŠ‚ç‚¹æ›¿æ¢ä¸ºæ–°æ’å…¥çš„èŠ‚ç‚¹\n\n    return 0;\n}\n\n\n/*\n    * @brief: è·å–é“¾è¡¨ä¸­æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹åœ°å€\n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @param: pos: æŒ‡å®šçš„ä½ç½®\n    * @return: æ’å…¥æˆåŠŸè¿”å›æ‰¾åˆ°çš„ç»“ç‚¹ï¼Œå¤±è´¥è¿”å›NULL\n*/\nlinklist list_get(linklist H, int pos)\n{\n    linklist p; // å£°æ˜ä¸€ä¸ªæŒ‡å‘é“¾è¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œç”¨äºéå†é“¾è¡¨\n    int i = -1; // ç”¨äºè®°å½•éå†ä½ç½®ï¼Œåˆå§‹åŒ–ä¸º-1ä»¥è€ƒè™‘å¤´ç»“ç‚¹\n\n    if (H == NULL) // å¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å› NULL\n    {\n        printf(\"H is NULL\\n\");\n        return NULL;\n    }\n\n    if (pos == -1) // å¦‚æœ pos == -1ï¼Œè¿”å›å¤´ç»“ç‚¹\n    {\n        return H;\n    }\n\n    p = H; // ä»å¤´ç»“ç‚¹å¼€å§‹éå†\n    while (i < pos) // å½“ i å°äº pos æ—¶ç»§ç»­å¾ªç¯\n    {\n        p = p->next; // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n        if (p == NULL)  // å¦‚æœé“¾è¡¨åˆ°è¾¾äº†æœ«å°¾ï¼Œä¸”è¿˜æ²¡æ‰¾åˆ° posï¼Œè¿”å› NULL\n        {\n            printf(\"pos is invalid\\n\");\n            return NULL;\n        }\n        i++; // è®°å½•å½“å‰éå†åˆ°çš„èŠ‚ç‚¹ç¼–å·\n    }\n\n    return p; // è¿”å›æ‰¾åˆ°çš„èŠ‚ç‚¹\n}\n\n/*\n    * @brief: éå†é“¾è¡¨å¹¶æ‰“å°å…¶ä¸­çš„å…ƒç´ \n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @return: éå†æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_show(linklist H)\n{\n    linklist p;\n\n    if (H == NULL) // å¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å› NULL\n    {\n        printf(\"H is NULL\\n\");\n        return -1;\n    }\n\n    p = H->next; //p æŒ‡å‘å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ æ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯çº¿æ€§å­˜å‚¨ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œä¸èƒ½å†™æˆp=H+1\n    while (p != NULL)\n    {\n        printf(\"%d \",p->data);\n        p = p->next;  //pæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n    }\n\n    return 0;\n}\n\n/*\n    * @brief: éå†é“¾è¡¨å¹¶æŸ¥æ‰¾æŒ‡å®šçš„å€¼\n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @return: æŸ¥æ‰¾æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_search(linklist H, data_t value)\n{\n    if (H == NULL) // å¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å› NULL\n    {\n        printf(\"H is NULL\\n\");\n        return -1;\n    }\n\n    linklist p = H->next;\n    int i = 0; //åˆå§‹åŒ–èŠ‚ç‚¹ç´¢å¼•ä¸º-1\n\n    while (p != NULL)\n    {\n        if (p->data == value)\n        {\n            printf(\"search ok, pos is %d\\n\",i);\n        }\n        i++;\n        p = p->next;   //æ›´æ–°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n    }\n\n    return 0;\n}\n\n/*\n    * @brief: åˆå¹¶ä¸¤ä¸ªé“¾è¡¨ï¼Œç„¶åå­˜å‚¨åˆ°æ–°é“¾è¡¨ä¸­\n    * @param: H1: æŒ‡å‘é“¾è¡¨1çš„æŒ‡é’ˆ\n    * @param: H2: æŒ‡å‘é“¾è¡¨2çš„æŒ‡é’ˆ\n    * @return: è¿”å›è¡¨3\n*/\nlinklist list_merge(linklist H1, linklist H2)\n{\n    if (H1 == NULL || H2 == NULL) \n    {\n        printf(\"H1 or H2 is null\\n\");\n        return NULL;\n    }\n    \n    linklist H3 = list_create();    //åˆ›å»ºæ–°è¡¨\n\n    //æ‹·è´H1è‡³H3\n    linklist TempPtr1 = H1->next;   //å£°æ˜TempPtræŒ‡å‘H1çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè·³è¿‡å¤´èŠ‚ç‚¹\n    int count1 = 0;\n    while (TempPtr1 != NULL)\n    {\n        list_insert(H3, TempPtr1->data, count1);    //å‘H3æ’å…¥H1çš„data\n        TempPtr1 = TempPtr1->next;  //æ›´æ–°æŒ‡é’ˆ\n        count1++;   //æ›´æ–°è®¡æ•°å™¨\n    } \n\n    linklist TempPtr2 = H2->next;\n    int count2 = 0;\n    while (TempPtr2 != NULL)\n    {\n        list_insert(H3, TempPtr2->data, count1 + count2);\n        TempPtr2 = TempPtr2->next;\n        count2++;\n    }\n\n    return H3;\n}\n\n/*\n    * @brief: åˆ é™¤ä¸¤ä¸ªé“¾è¡¨ä¸­çš„é‡å¤éƒ¨åˆ†ï¼Œå°†å‰©ä½™å…ƒç´ å­˜åœ¨æ–°è¡¨ä¸­\n    * @param: H1: æŒ‡å‘é“¾è¡¨1çš„æŒ‡é’ˆ\n    * @param: H2: æŒ‡å‘é“¾è¡¨2çš„æŒ‡é’ˆ\n    * @return: è¿”å›è¡¨3\n    * @note: ä»…é€‚ç”¨äºå°é“¾è¡¨ï¼Œå¤§é“¾è¡¨å¯ä»¥ç”¨å“ˆå¸Œè¡¨\n*/\nlinklist list_purge(linklist H1, linklist H2)\n{\n    if (H1 == NULL || H2 == NULL) \n    {\n        printf(\"H1 or H2 is null\\n\");\n        return NULL;\n    }\n\n    linklist H3 = list_create();\n\n    int is_common = 0;  //åˆå§‹åŒ–æ ‡è®°ï¼Œ09ä¸ºä¸é‡å¤ï¼Œ1ä¸ºé‡å¤\n\n    linklist TempPtr1 = H1->next;   //åˆå§‹åŒ–Ptr1æŒ‡å‘H1çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹\n    while (TempPtr1 != NULL)\n    {\n        linklist TempPtr2 = H2->next;   // æ¯æ¬¡éå†TempPtr1æ—¶ï¼Œé‡ç½®TempPtr2ï¼Œå¦åˆ™TempPtr2ä¸€æ—¦éå†åˆ°NULLåä¸ä¼šè¿”å›\n        while (TempPtr2 != NULL)\n        {\n            if (TempPtr1->data == TempPtr2->data)\n            {\n                printf(\"common elements:%d\\n\",TempPtr2->data);\n                \n                is_common = 1;\n                list_insert(H3, TempPtr2->data, 0);\n            }\n            TempPtr2 = TempPtr2->next;  //æ›´æ–°TempPtr2\n        }\n\n        if (is_common == 0)  // å¦‚æœä¸æ˜¯é‡å¤å…ƒç´ ï¼Œæ’å…¥åˆ°H3ä¸­\n        {\n            list_insert(H3, TempPtr1->data, 0);\n        }\n        TempPtr1 = TempPtr1->next;  //æ›´æ–°TempPtr1\n    }\n\n    return H3;\n}\n\n/*\n    * @brief: åˆ é™¤æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹\n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @param: posï¼šå¾…åˆ é™¤ç»“ç‚¹çš„ä½ç½®\n    * @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_delete(linklist H, int pos)\n{\n    if (H == NULL) \n    {\n        printf(\"no such linklist\\n\");\n        return -1;\n    }\n\n    // å¦‚æœåˆ é™¤çš„ä½ç½®æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹\n    if (pos == 1)\n    {\n        linklist TempPtr = H->next; // ä¿å­˜ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n        free(H); // é‡Šæ”¾å¤´èŠ‚ç‚¹\n        H = TempPtr; // æ›´æ–°å¤´æŒ‡é’ˆ\n        return 0;\n    }\n\n    // è·å–å¾…åˆ é™¤èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹\n    linklist Prev_Node = list_get(H, pos - 1);\n    if (Prev_Node == NULL || Prev_Node->next == NULL)\n    {\n        printf(\"invalid position\\n\");\n        return -1;\n    }\n\n    // è·å–å¾…åˆ é™¤çš„èŠ‚ç‚¹\n    linklist TempPtr = Prev_Node->next;\n    Prev_Node->next = TempPtr->next; // è¿æ¥å‰åèŠ‚ç‚¹\n    free(TempPtr); // é‡Šæ”¾è¢«åˆ é™¤çš„èŠ‚ç‚¹\n\n    return 0;\n}\n\n/*\n    * @brief: åˆ é™¤æ•´ä¸ªé“¾è¡¨å¹¶é‡Šæ”¾å†…å­˜\n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_free(linklist H)\n{\n    if (H == NULL)\n    {\n        printf(\"no such linklist\\n\");\n        return -1;\n    }\n\n    linklist TempPtr = H;\n\n    while (H != NULL)\n    {\n        TempPtr = H;    // ä¿å­˜å½“å‰èŠ‚ç‚¹\n        H = H->next;    // æ›´æ–°é“¾è¡¨å¤´æŒ‡é’ˆä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n        free(TempPtr);  // é‡Šæ”¾å½“å‰èŠ‚ç‚¹\n    }\n\n    return 0;\n}\n\n/*\n    * @brief: å€’ç½®é“¾è¡¨\n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n    * @note: å°†èŠ‚ç‚¹æ‹¿å‡ºæ”¾åˆ°\n*/\nint list_reverse(linklist H)\n{\n    if (H == NULL)\n    {\n        printf(\"no such linklist\\n\");\n        return -1;\n    }\n\n    if (H->next == NULL)\n    {\n        printf(\"linklist is empty\\n\");\n        return -1;\n    }\n\n    //é“¾è¡¨ä¸€åˆ†ä¸ºäºŒ\n    linklist p = H->next->next;\n    H->next->next = NULL;\n\n    \n    while (p != NULL)\n    {\n        linklist q = p; // æš‚å­˜å½“å‰èŠ‚ç‚¹\n        p = p->next;    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n        q->next = H->next; // å°†å½“å‰èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨å¤´éƒ¨ï¼ˆå¤´æ’æ³•ï¼‰\n        H->next = q; // æ›´æ–°å¤´èŠ‚ç‚¹ä¸ºæ–°æ’å…¥çš„èŠ‚ç‚¹\n    }\n\n    return 0;\n}\n\n/*\n    * @brief: æ±‚é“¾è¡¨ç›¸é‚»ä¸¤èŠ‚ç‚¹dataå€¼ä¹‹å’Œä¸ºæœ€å¤§çš„ç¬¬ä¸€ç»“ç‚¹çš„æŒ‡é’ˆ\n    * @param: H: æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\n    * @return: æˆåŠŸè¿”å›æŒ‡é’ˆï¼Œå¤±è´¥è¿”å›NULL\n*/\nint list_getmax(linklist H)\n{\n    if (H == NULL)\n    {\n        printf(\"no such linklist\\n\");\n        return -1;\n    }\n\n    if (H->next == NULL)\n    {\n        printf(\"linklist is empty\\n\");\n        return -1;\n    }\n\n    int sum_new, max = 0;\n    linklist p = H->next;\n    linklist max_p = H->next;\n    int sum = p->data + p->next->data;\n\n    while (p != NULL && p->next != NULL)\n    {\n        sum_new = p->data + p->next->data;\n        \n        if (sum_new >= max)\n        {\n            max = sum_new;\n            max_p = p;\n        }\n\n        p = p->next;\n    }\n    //printf(\"max sum is %d\",max);\n    return max;\n}\n```\n\n## æ ˆ(Stack)\nå’Œå¾®æœºåŸç†ä¸­æ ˆçš„åŸç†ç›¸åŒ\n\næ³¨æ„ï¼š\n- å…ˆè¿›åå‡º\n- æ³¨æ„æ ˆé¡¶æŒ‡é’ˆçš„æ›´æ–°\n\næ ˆä¸»è¦ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\n- å‡½æ•°è°ƒç”¨ï¼šä½¿ç”¨æ ˆæ¥ä¿å­˜å½“å‰å‡½æ•°çš„å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚å½“å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œæ–°çš„å‡½æ•°ä¿¡æ¯è¢«å‹å…¥æ ˆä¸­ï¼Œå‡½æ•°æ‰§è¡Œå®Œæ¯•åä¼šä»æ ˆä¸­å¼¹å‡ºï¼Œè¿”å›ä¸Šä¸€ä¸ªå‡½æ•°ã€‚\n- æ’¤é”€æ“ä½œ\n- é€’å½’\n- äºŒå‰æ ‘éå†\n```\n#include <stdio.h>\n#include <stdlib.h>\n#include \"linear_stack.h\"\n#include <string.h>\n\n/*\n    @brief: åˆ›å»ºæ–°çš„æ ˆ\n    @param: len: æ ˆçš„é•¿åº¦\n    @return: æŒ‡å‘æ ˆçš„æŒ‡é’ˆ\n*/\nsqstack *stack_create(int len)\n{\n    if (len < 0)\n    {\n        printf(\"len is illegal\\n\");\n        return NULL;\n    }\n\n    sqstack *ss;\n\n    //ç”³è¯·ç”¨äºæ”¾ç½®ç»“æ„ä½“çš„å†…å­˜\n    ss = (sqstack *)malloc(sizeof(sqstack));   \n    if (ss == NULL) {\n        printf(\"Failed to allocate memory for stack.\\n\");\n        return NULL;\n    }\n\n    //ç”³è¯·ç”¨äºæ”¾ç½®æ ˆå†…æ•°æ®çš„å†…å­˜\n    ss->data = (data_t *)malloc(sizeof(data_t) * len);\n    if (ss->data == NULL) {\n        printf(\"Failed to allocate memory for stack data.\\n\");\n        free(ss);  \n        return NULL;\n    }\n\n    memset(ss->data, 0, len*sizeof(data_t));\n    ss->top = -1;\n    ss->maxlen = len;\n\n    return ss;\n}\n\n/*\n    @brief: å…¥æ ˆ\n    @param: sï¼šå¯¹åº”æ ˆæŒ‡é’ˆ valueï¼šå¾…å…¥æ ˆå€¼\n    @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint stack_push(sqstack *s, data_t value)\n{\n    if (s == NULL)\n    {\n        printf(\"no such stack\\n\");\n        return -1;\n    }\n    if (s->top == s->maxlen - 1)\n    {\n        printf(\"stack is full\\n\");\n        return -1;\n    }\n\n    s->top++;\n    s->data[s->top] = value;\n\n    printf(\"stack push ok\\n\");\n    return 0;\n}\n\n/*\n    @brief: åˆ¤æ–­æ ˆæ˜¯å¦ä¸ºç©º\n    @param: sï¼šå¯¹åº”æ ˆæŒ‡é’ˆ\n    @return: æ ˆä¸ºç©ºè¿”å›-1ï¼Œéç©ºè¿”å›0ï¼Œå‡½æ•°éæ³•è¿”å›-2\n*/\nint stack_empty(sqstack *s)\n{\n    if (s == NULL)\n    {\n        printf(\"no such stack\\n\");\n        return -2;\n    }\n\n    if (s->top == -1)\n    {\n        printf(\"stack is empty\\n\");\n        return -1;\n    }\n    else\n    {\n        return 0;\n    }\n}\n\n/*\n    @brief: åˆ¤æ–­æ ˆæ˜¯å¦ä¸ºæ»¡\n    @param: sï¼šå¯¹åº”æ ˆæŒ‡é’ˆ\n    @return: æ ˆä¸ºæ»¡è¿”å›-1ï¼Œéæ»¡è¿”å›0ï¼Œå‡½æ•°éæ³•è¿”å›-2\n*/\nint stack_full(sqstack *s)\n{\n    if (s == NULL)\n    {\n        printf(\"no such stack\\n\");\n        return -2;\n    }\n\n    if (s->top == s->maxlen - 1)\n    {\n        printf(\"stack is full\\n\");\n        return -1;\n    }\n    else\n    {\n        return 0;\n    }\n}\n\n/*\n    @brief: æ•°æ®å‡ºæ ˆ\n    @param: sï¼šå¯¹åº”æ ˆæŒ‡é’ˆ\n    @return: è¿”å›å‡ºæ ˆå€¼ï¼Œå¦‚æœæ ˆä¸ºç©ºæˆ–å‡ºé”™åˆ™è¿”å›-999\n*/\ndata_t stack_pop(sqstack *s)\n{\n    if (s == NULL)\n    {\n        printf(\"Stack not initialized\\n\");\n        return -999;  \n    }\n\n    if (s->top == -1)\n    {\n        printf(\"Stack is empty\\n\");\n        return -999;  \n    }\n     \n    data_t temp = s->data[s->top];\n    s->top--;\n    return temp;\n}\n\n/*\n    @brief: æ¸…é™¤æ ˆå†…æ‰€æœ‰å…ƒç´ \n    @param: sï¼šå¯¹åº”æ ˆæŒ‡é’ˆ\n    @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint stack_clear(sqstack *s)\n{\n    if (s == NULL)\n    {\n        printf(\"Stack not initialized\\n\");\n        return -1;  \n    }\n\n    if (s->top == -1)\n    {\n        return 0;  \n    }\n\n    //ä¸€èˆ¬çš„æ ˆæ¸…ç©ºæ“ä½œåªä¼šé‡ç½® topï¼Œä½†ä¸é‡Šæ”¾å†…å­˜\n    s->top = -1;\n    //free(s->data);\n    //s->data = NULL;\n\n    return 0;\n}\n\n/*\n    @brief: é‡Šæ”¾æ•´ä¸ªæ ˆçš„ç©ºé—´\n    @param: sï¼šå¯¹åº”æ ˆæŒ‡é’ˆ\n    @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint stack_free(sqstack *s)\n{\n    if (s == NULL)\n    {\n        printf(\"Stack not initialized\\n\");\n        return -1;  \n    }\n\n    free(s->data);\n    s->data = NULL;\n    free(s);\n\n    return 0;\n}\n```\n\n## é˜Ÿåˆ—(Queue)\n### åŸºäºæ•°ç»„çš„é˜Ÿåˆ—\nç­‰åŒäºç°å®ç”Ÿæ´»ä¸­çš„â€œæ’é˜Ÿâ€ï¼Œå…ƒç´ ä»åˆ—å°¾å­˜å…¥ï¼Œåˆ—é¦–å–å‡º\n\nåŒç«¯é˜Ÿåˆ—ï¼šåˆ—é¦–å’Œåˆ—å°¾éƒ½å¯ä»¥è¿›è¡Œå­˜å…¥å’Œå–å‡ºï¼›æˆ–è§£é‡Šä¸ºï¼šåŒä¸€ä¸ªé˜Ÿåˆ—å…±äº«åˆ—é¦–å’Œåˆ—å°¾\n\né˜Ÿåˆ—å¤šè¢«ç”¨äºï¼š\n- ä»»åŠ¡è°ƒåº¦\n- æ¶ˆæ¯é˜Ÿåˆ—\n- IOè¯·æ±‚ç®¡ç†ï¼ˆç¡®ä¿ç³»ç»Ÿèµ„æºçš„æœ‰åºè®¿é—®ï¼‰\n\né˜Ÿåˆ—ç»“æ„ä½“ä¸€èˆ¬ä¸º\n```\ntypedef int data_t;\n#define N 64\ntypedef struct \n{\n    data_t data[N];\n    int front, rear;    //rearä¸ºé˜Ÿå°¾åä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡\n}sequeue_t;\n```\n\nå…¶ä¸­`rear`ä¸€èˆ¬æŒ‡ç¤ºé˜Ÿå°¾å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªè¦å…¥é˜Ÿçš„å…ƒç´ ä½ç½®ã€‚ç”¨äºå¤„ç†é˜Ÿåˆ—ä¸ºç©ºæˆ–åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶çš„æƒ…å†µã€‚å¤´å°¾ä½ç½®é‡åˆæ—¶ï¼Œé˜Ÿåˆ—å³ä¸ºç©ºã€‚\nåˆå§‹`front, rear = 0;`\n- å‡ºé˜Ÿåˆ—ï¼š`x = sq[front++]`\n- å…¥é˜Ÿåˆ—ï¼š`sq[rear++] = x;`\n\nå½“é˜Ÿåˆ—ä¸­å‰å‡ ä¸ªå…ƒç´ å‡ºé˜Ÿæ—¶ï¼Œä¼šé€ æˆè¿™äº›ä½ç½®ä¸ºç©ºï¼Œä»è€Œæµªè´¹é˜Ÿåˆ—ä¸­çš„å¯å­˜å‚¨ç©ºé—´ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨**å¾ªç¯é˜Ÿåˆ—**ã€‚\nä¸ºåŒºåˆ«ç©ºé˜Ÿå’Œæ»¡é˜Ÿï¼Œæ»¡é˜Ÿå…ƒç´ ä¸ªæ•°æ¯”æ•°ç»„å…ƒç´ ä¸ªæ•°å°‘ä¸€ä¸ªã€‚\n\n```\n/*\n    @brief: åˆ›å»ºç©ºé˜Ÿåˆ—\n    @param: æ— \n    @return: æŒ‡å‘é˜Ÿåˆ—çš„æŒ‡é’ˆ\n*/\nsequeue queue_create()\n{\n    sequeue qq = (struct queue*)malloc(sizeof(struct queue));\n\n    if (qq == NULL)\n    {\n        printf(\"malloc failed\\n\");\n        return NULL;\n    }\n\n    qq->front = 0;\n    qq->rear = 0;\n\n    memset(qq->data, 0, sizeof(qq->data));\n\n    return qq;\n}\n\n/*\n    @brief: éå†å¹¶æ‰“å°é˜Ÿåˆ—\n    @param: qï¼šé˜Ÿåˆ—æŒ‡é’ˆ\n    @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint queue_print(sequeue q)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    if (q->front == q->rear)\n    {\n        printf(\"queue is empty\");\n        return -1;\n    }\n\n    for (int i = q->front; i < q->rear; i++)\n    {\n        printf(\"%d \", q->data[i]);\n    }\n\n    return 0;\n}\n\n/*\n    @brief: å…ƒç´ å…¥é˜Ÿ\n    @param: qï¼šé˜Ÿåˆ—æŒ‡é’ˆ dataï¼šå¾…å…¥é˜Ÿå…ƒç´ \n    @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint enqueue(sequeue q, data_t data)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    if ((q->rear + 1) % N == q->front)\n    {\n        printf(\"queue is full\\n\");\n        return -1;\n    }\n\n    q->data[q->rear] = data;\n    q->rear = (q->rear + 1) % N;    // rear æŒ‡é’ˆç§»åŠ¨åˆ°é˜Ÿåˆ—è¾¹ç•Œæ—¶ï¼Œé€šè¿‡å–ä½™ä½¿å…¶è¿”å›åˆ°æ•°ç»„å¼€å¤´ï¼Œå®ç°å¾ªç¯\n\n    return 0;\n}\n\n/*\n    @brief: å…ƒç´ å‡ºé˜Ÿ\n    @param: qï¼šé˜Ÿåˆ—æŒ‡é’ˆ\n    @return: æˆåŠŸè¿”å›å‡ºé˜Ÿå…ƒç´ ï¼Œå¤±è´¥è¿”å›-1\n    @note: å‡ºé˜Ÿå…ƒç´ ä¸ºé˜Ÿé¦–çš„ç¬¬ä¸€ä¸ªå…ƒç´ \n*/\nint dequeue(sequeue q)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    if (q->front == q->rear)\n    {\n        printf(\"queue is empty\");\n        return -1;\n    }\n\n    int temp = q->data[q->front];\n    q->front = (q->front + 1) % N;\n\n    return temp;\n}\n\n/*\n    @brief: æ¸…ç©ºé˜Ÿåˆ—å†…å…ƒç´ ï¼Œä½†ä¸é‡Šæ”¾å†…å­˜\n    @param: qï¼šé˜Ÿåˆ—æŒ‡é’ˆ\n    @return: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n    @note: \n*/\nint queue_clear(sequeue q)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    q->front = 0;\n    q->rear = 0;\n\n    return 0;\n}\n```\n### åŸºäºé“¾å¼å­˜å‚¨çš„é˜Ÿåˆ—\næ’å…¥æ“ä½œåœ¨é˜Ÿå°¾è¿›è¡Œï¼Œåˆ é™¤æ“ä½œåœ¨é˜Ÿé¦–è¿›è¡Œï¼Œç”±é˜Ÿé¦–æŒ‡é’ˆå’Œé˜Ÿå°¾æŒ‡é’ˆæ§åˆ¶é˜Ÿåˆ—æ“ä½œ\n\nç»“æ„ä½“éœ€è¦å®šä¹‰ä¸¤ä¸ªï¼šèŠ‚ç‚¹ç»“æ„ä½“ å’Œ é˜Ÿåˆ—ç»“æ„ä½“\n```\ntypedef int data_t;\n\ntypedef struct node\n{\n    data_t data;\n    struct node* next;\n}*linklist;\n\ntypedef struct queue\n{\n    linklist front;\n    linklist rear;\n};\n```\n- åˆå§‹åŒ–ï¼šåˆ›å»ºç©ºé˜Ÿåˆ—ï¼Œfrontå’ŒrearæŒ‡é’ˆéƒ½ä¸ºç©º\n- å…¥é˜Ÿï¼šåœ¨é˜Ÿå°¾æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ›´æ–°å½“å‰é˜Ÿå°¾èŠ‚ç‚¹çš„nextæŒ‡é’ˆ\n- å‡ºé˜Ÿï¼šæ›´æ–°frontæŒ‡é’ˆåˆ°å¾…å‡ºé˜ŸèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶ååˆ é™¤åŸæœ‰é˜Ÿé¦–èŠ‚ç‚¹\n\nä¸çº¿æ€§è¡¨ä¸åŒçš„æ˜¯ï¼Œé“¾å¼é˜Ÿåˆ—ä¸­rearæŒ‡é’ˆä¸€èˆ¬æŒ‡å‘æœ€åé˜Ÿåˆ—çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œéæœ€åä¸€ä¸ªèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚\n\nåˆ¤æ–­é“¾å¼é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºçš„æ¡ä»¶åªæœ‰ä¸€ä¸ªï¼š`front == NULL, rear == NULL`ï¼Œä¸èƒ½ä½¿ç”¨`front==rear`åˆ¤æ–­ï¼Œå› ä¸ºè¿™é‡Œ`front`å’Œ`rear`éƒ½æ˜¯æŒ‡é’ˆï¼Œå¹¶ä¸”`rear`æŒ‡å‘çš„æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œéçº¿æ€§é˜Ÿåˆ—ä¸­çš„æŒ‡å‘æœ€åä¸€ä¸ªä½ç½®çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼ˆå¾…æ’å…¥ä½ç½®ï¼‰ã€‚å‡è®¾é˜Ÿä¼ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ—¶å€™`front`å’Œ`rear`äºŒè€…ç›¸åŒï¼Œä½†é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚\n\n#### åˆ›å»ºæ–°çš„é“¾å¼é˜Ÿåˆ—\n```\n/*\n    @ briefï¼šåˆ›å»ºå¹¶åˆå§‹åŒ–æ–°çš„é“¾å¼é˜Ÿåˆ—\n    @paramï¼šæ— \n    @returnï¼šæˆåŠŸæŒ‡å‘æ–°é˜Ÿåˆ—çš„æŒ‡é’ˆï¼Œå¤±è´¥è¿”å›NULL\n*/\nstruct queue* queue_create()\n{\n    struct queue* q = (struct queue*)malloc(sizeof(struct queue));\n\n    if (q == NULL)\n    {\n        printf(\"malloc failed\\n\");\n        return NULL;\n    }\n\n    q->front = NULL;\n    q->rear = NULL;\n\n    return q;\n}\n```\n- ä¸ºé˜Ÿåˆ—ç”³è¯·å†…å­˜ï¼Œæš‚æ—¶å…ˆä¸ç”³è¯·èŠ‚ç‚¹çš„ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªç©ºé˜Ÿåˆ—ï¼Œç›®å‰è¿˜æ²¡æœ‰å…ƒç´ \n- å› ä¸ºé˜Ÿåˆ—ä¸­æ²¡æœ‰èŠ‚ç‚¹ï¼Œfrontå’ŒrearæŒ‡é’ˆéƒ½ä¸ºNULL\n\n#### éå†é˜Ÿåˆ—\n```\n/*\n    @ briefï¼šéå†é“¾å¼é˜Ÿåˆ—å¹¶æ‰“å°æ‰€æœ‰å…ƒç´ \n    @paramï¼šqï¼šé˜Ÿåˆ—æŒ‡é’ˆ\n    @returnï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint queue_print(struct queue* q)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    if (q->front == NULL)\n    {\n        printf(\"queue is empty\\n\");\n        return -1;\n    }\n\n    struct node* temp = q->front;\n\n    while (temp != NULL)\n    {\n        printf(\"%d\", temp->data);\n        temp = temp->next;\n    }\n\n    printf(\"\\n\");\n\n    return 0;\n}\n```\n- åœ¨éå†æ—¶è¦ç”¨ä¸´æ—¶æŒ‡é’ˆtempæ¥ä»£æ›¿frontï¼Œå¦‚æœç›´æ¥ç”¨frontæŒ‡é’ˆçš„è¯ï¼Œéå†ä¸€æ¬¡ä¹‹åfrontå°±å›ä¸å»äº†ï¼Œæ•´ä¸ªé˜Ÿåˆ—ä¼šè¢«ç ´å\n- å°½é‡ä¸è¦åœ¨éå†å‰ç”¨tempå­˜å‚¨frontæŒ‡é’ˆï¼Œç”¨frontæŒ‡é’ˆéå†å®Œä¹‹åå†front = tempè¿™ç§å½¢å¼è¿”å›å›å»çš„è¿™ç§æ–¹æ³•ï¼Œåœ¨å¤šçº¿ç¨‹çš„æ—¶å€™å¯èƒ½ä¼šæœ‰é—®é¢˜\n- éå†ç»“æŸçš„æ¡ä»¶æ˜¯å½“tempæŒ‡é’ˆèµ°åˆ°NULLä¹‹åï¼Œè¡¨æ˜ä»é˜Ÿé¦–èŠ‚ç‚¹åˆ°é˜Ÿå°¾èŠ‚ç‚¹å…¨éƒ½æ‰«æåˆ°äº†ï¼Œè€Œä¸æ˜¯`temp(front)=rear`æˆ–è€…`temp(front)=rear->next`ï¼Œå› ä¸ºé“¾å¼é˜Ÿåˆ—ä¸­rearæŒ‡é’ˆæŒ‡å‘çš„æ˜¯æœ€åä¸€ä¸ªï¼ˆé˜Ÿå°¾ï¼‰èŠ‚ç‚¹\n\n#### å…¶ä»–\n```\n/*\n    @ briefï¼šåˆ›å»ºå¹¶åˆå§‹åŒ–æ–°çš„é“¾å¼é˜Ÿåˆ—\n    @paramï¼šæ— \n    @returnï¼šæˆåŠŸæŒ‡å‘æ–°é˜Ÿåˆ—çš„æŒ‡é’ˆï¼Œå¤±è´¥è¿”å›NULL\n*/\nstruct queue* queue_create()\n{\n    struct queue* q = (struct queue*)malloc(sizeof(struct queue));\n\n    if (q == NULL)\n    {\n        printf(\"malloc failed\\n\");\n        return NULL;\n    }\n\n    q->front = NULL;\n    q->rear = NULL;\n\n    return q;\n}\n\n/*\n    @ briefï¼šéå†é“¾å¼é˜Ÿåˆ—å¹¶æ‰“å°æ‰€æœ‰å…ƒç´ \n    @paramï¼šqï¼šé˜Ÿåˆ—æŒ‡é’ˆ\n    @returnï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint queue_print(struct queue* q)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    if (q->front == NULL)\n    {\n        printf(\"queue is empty\\n\");\n        return -1;\n    }\n\n    struct node* temp = q->front;\n\n    while (temp != NULL)\n    {\n        printf(\"%d \", temp->data);\n        temp = temp->next;\n    }\n\n    printf(\"\\n\");\n\n    return 0;\n}\n\n\n/*\n    @ briefï¼šå…ƒç´ å…¥é˜Ÿ\n    @paramï¼šqï¼šé˜Ÿåˆ—æŒ‡é’ˆ valï¼šå¾…å…¥é˜Ÿå…ƒç´ å€¼\n    @returnï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint enqueue(struct queue* q, data_t val)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n    struct node* newnode = (struct node*)malloc(sizeof(struct node));\n\n    newnode->data = val;\n    newnode->next = NULL;\n\n    //åˆ¤æ–­åŸé˜Ÿåˆ—æ˜¯å¦ä¸ºç©º\n    if (q->rear == NULL)\n    {\n        q->front = newnode;\n        q->rear = newnode;\n    }\n    else\n    {  \n        q->rear->next = newnode;\n        q->rear = newnode;\n    }\n\n    return 0;\n}\n\n/*\n    @ briefï¼šå…ƒç´ å‡ºé˜Ÿ\n    @paramï¼šqï¼šé˜Ÿåˆ—æŒ‡é’ˆ\n    @returnï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint dequeue(struct queue* q)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    if (q->front == NULL)\n    {\n        printf(\"queue is empty\\n\");\n        return -1;\n    }\n\n    struct node* temp_node = q->front;\n    int temp = temp_node->data;\n    q->front = q->front->next;\n\n    // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™éœ€è¦æ›´æ–° rear ä¸º NULL\n    if (q->front == NULL)\n    {\n        q->rear = NULL;\n    }\n\n    free(temp_node);\n\n    return temp;\n}\n\n/*\n    @ briefï¼šæ¸…ç©ºé˜Ÿåˆ—å¹¶åˆ é™¤å¯¹åº”èŠ‚ç‚¹\n    @paramï¼šqï¼šé˜Ÿåˆ—æŒ‡é’ˆ\n    @returnï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint queue_clear(struct queue* q)\n{\n    if (q == NULL)\n    {\n        printf(\"no such queue\\n\");\n        return -1;\n    }\n\n    if (q->front == NULL)\n    {\n        return 0;\n    }\n\n    //ä¸´æ—¶èŠ‚ç‚¹ï¼Œç”¨äºå‚¨å­˜å¾…åˆ é™¤çš„èŠ‚ç‚¹è€Œä¸å½±å“åç»­èŠ‚ç‚¹çš„éå†\n    struct node* temp;  \n    \n    while (q->front != NULL)\n    {\n        temp = q->front;\n        q->front = q->front->next;\n        free(temp);\n    }\n\n    q->rear = NULL;\n\n    return 0;\n}\n```\n\n## çƒé’Ÿé—®é¢˜ï¼ˆé˜Ÿåˆ—å’Œæ ˆçš„åº”ç”¨ï¼‰\nçƒé’Ÿé—®é¢˜ï¼ˆBall Clock Problemï¼‰æ˜¯ä¸€ç§ç»å…¸çš„ç®—æ³•å’Œæ•°æ®ç»“æ„é¢˜ç›®ï¼Œä¸»è¦ç”¨äºè€ƒå¯Ÿé˜Ÿåˆ—å’Œæ ˆçš„ç»“åˆè¿ç”¨ã€‚é—®é¢˜çš„åŸºæœ¬æƒ…æ™¯æ˜¯ï¼š\nå‡è®¾æœ‰ä¸€ä¸ªçƒé’Ÿç³»ç»Ÿï¼Œå®ƒé€šè¿‡å°çƒæ¥è®¡æ—¶ã€‚ç³»ç»Ÿä¸­æœ‰ 3 ä¸ªè½¨é“ï¼Œæ¯ä¸ªè½¨é“å®¹é‡ä¸åŒï¼š\n- åˆ†é’Ÿè½¨é“ï¼ˆMin Trackï¼‰ï¼šæœ€å¤šå¯å®¹çº³ 4 ä¸ªå°çƒã€‚\n- äº”åˆ†é’Ÿè½¨é“ï¼ˆFive-Min Trackï¼‰ï¼šæœ€å¤šå¯å®¹çº³ 11 ä¸ªå°çƒã€‚\n- å°æ—¶è½¨é“ï¼ˆHour Trackï¼‰ï¼šæœ€å¤šå¯å®¹çº³ 11 ä¸ªå°çƒã€‚\n\nè¿ä½œæœºåˆ¶ï¼š\n- åˆå§‹çŠ¶æ€ä¸‹æœ‰ä¸€ç»„ç¼–å·ä¸º 1 åˆ° n çš„å°çƒï¼Œn æ˜¯çƒçš„æ€»æ•°ï¼Œè¿™äº›å°çƒä¾æ¬¡é€šè¿‡é˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚\n- æ¯åˆ†é’Ÿï¼Œç¬¬ä¸€ä¸ªå°çƒä»é˜Ÿåˆ—ä¸­å–å‡ºï¼Œæ”¾åˆ°åˆ†é’Ÿè½¨é“ä¸Šã€‚\n- å½“åˆ†é’Ÿè½¨é“æ»¡ï¼ˆå³æ”¾å…¥ç¬¬5ä¸ªå°çƒæ—¶ï¼‰ï¼Œè½¨é“ä¸­çš„ 4 ä¸ªå°çƒè¢«ä¾æ¬¡æ”¾å›é˜Ÿåˆ—ï¼Œä¿æŒåŸæ¥çš„é¡ºåºï¼Œè€Œç¬¬ 5 ä¸ªå°çƒåˆ™è¿›å…¥äº”åˆ†é’Ÿè½¨é“ã€‚\n- å½“äº”åˆ†é’Ÿè½¨é“æ»¡ï¼ˆå³æ”¾å…¥ç¬¬12ä¸ªå°çƒæ—¶ï¼‰ï¼Œè½¨é“ä¸­çš„ 11 ä¸ªå°çƒè¢«ä¾æ¬¡æ”¾å›é˜Ÿåˆ—ï¼Œç¬¬ 12 ä¸ªå°çƒè¿›å…¥å°æ—¶è½¨é“ã€‚\n- å½“å°æ—¶è½¨é“æ»¡ï¼ˆå³æ”¾å…¥ç¬¬12ä¸ªå°çƒæ—¶ï¼‰ï¼Œè½¨é“ä¸­çš„ 11 ä¸ªå°çƒè¢«ä¾æ¬¡æ”¾å›é˜Ÿåˆ—ï¼Œç¬¬ 12 ä¸ªå°çƒä¹Ÿå›åˆ°é˜Ÿåˆ—çš„æœ«å°¾ã€‚\n\né—®é¢˜çš„ä¸€ä¸ªå¸¸è§è€ƒç‚¹æ˜¯è®¡ç®—åœ¨ç»™å®šçš„åˆå§‹çŠ¶æ€ä¸‹ï¼Œç»è¿‡å¤šå°‘åˆ†é’Ÿåï¼Œå°çƒé˜Ÿåˆ—çš„é¡ºåºä¼šæ¢å¤åˆ°æœ€åˆçš„çŠ¶æ€ã€‚\n\n```\n#include <stdio.h>\n#include <stdlib.h>\n#include \"queue.h\"\n#include \"linear_stack.h\"\n\n#define N 27\n\nint main()\n{\n    struct queue* main_queue = queue_create();\n    struct stack* minute = stack_create(4);\n    struct stack* five_minute = stack_create(11);\n    struct stack* hour = stack_create(11);\n\n    int time = 0;\n\n    //åˆå§‹åŒ–ä¸»é˜Ÿåˆ—ä¸­çš„27ä¸ªå°çƒ\n    for (int i = 1; i <= N; i++)\n    {\n        enqueue(main_queue, i);\n    }\n\n    while (!stack_full(hour))   //å¦‚æœå°æ—¶è½¨é“æœªæ»¡ï¼Œç»§ç»­\n    {\n        while (!stack_full(five_minute))    //å¦‚æœäº”åˆ†é’Ÿè½¨é“æœªæ»¡ï¼Œç»§ç»­\n        {\n            while (!stack_full(minute))     //å¦‚æœåˆ†é’Ÿè½¨é“æœªæ»¡ï¼Œç»§ç»­\n            {\n                int ball = dequeue(main_queue);     //ä»ä¸»é˜Ÿåˆ—ä¸­è·å–å°çƒ\n                stack_push(minute, ball);           // æ”¾å…¥åˆ†é’Ÿæ ˆä¸­\n                time++;\n\n                if (stack_full(minute))             //å¦‚æœåˆ†é’Ÿæ ˆæ»¡äº†\n                {\n                    int count_min = 0;\n                    while (count_min < 4)    \n                    {\n                        int min_top_ball = stack_pop(minute);   //ä»åˆ†é’Ÿæ ˆä¸­å¼¹å‡ºä¸€ä¸ªå°çƒ\n                        enqueue(main_queue, min_top_ball);      //è¯¥å°çƒé€å…¥ä¸»é˜Ÿåˆ—\n                        count_min++;\n                    }\n\n                    stack_push(five_minute, ball);          //å°†ä¸€ä¸ªå°çƒæ¨å…¥äº”åˆ†é’Ÿæ ˆ\n                }\n            }\n            if (stack_full(five_minute))    //å¦‚æœäº”åˆ†é’Ÿæ ˆæ»¡äº†\n            {\n                int count_five_min = 0;\n                while (count_five_min < 11)  \n                {\n                    int five_min_top_ball = stack_pop(five_minute);     //ä»äº”åˆ†é’Ÿæ ˆä¸­å¼¹å‡ºä¸€ä¸ªå°çƒ\n                    enqueue(main_queue, five_min_top_ball);     //é€å›ä¸»é˜Ÿåˆ—\n                    count_five_min++;\n                }\n\n                stack_push(hour, dequeue(main_queue));\n            }\n        }\n\n        if (stack_full(hour))\n        {\n            int count_hour = 0;\n            while (count_hour < 11)\n            {\n                int hour_top_ball = stack_pop(hour);\n                enqueue(main_queue, hour_top_ball);\n                count_hour++;\n            }\n        }\n    }\n\n    printf(\"é’Ÿè¡¨æ¢å¤åˆ°åˆå§‹çŠ¶æ€æ‰€éœ€æ—¶é—´: %d åˆ†é’Ÿ\\n\", time);\n\n    return 0;\n}\n```","categories":["æ•°æ®ç»“æ„"]},{"title":"æ•°æ®ç»“æ„ç¬”è®°ã€1ã€‘","url":"/2024/10/10/æ•°æ®ç»“æ„ç¬”è®°ã€1ã€‘/","content":"### æ•°æ®çš„ä¸‰ç§ç»“æ„\n#### é€»è¾‘ç»“æ„\nåŒ…å«ï¼š\n- é›†åˆ\n- çº¿æ€§ç»“æ„ï¼ˆä¸€å¯¹ä¸€ï¼‰ï¼Œå¦‚çº¿æ€§è¡¨ã€æ ˆã€é˜Ÿåˆ—\n- æ ‘å½¢ç»“æ„ ä¸€ä¸ªå¯¹å¤šä¸ª\n- å›¾çŠ¶ç»“æ„ å¤šä¸ªå¯¹å¤šä¸ª\n\n#### å­˜å‚¨ç»“æ„\n- é¡ºåºå­˜å‚¨ï¼šæŒ‰ç…§é€»è¾‘é¡ºåºå­˜æ”¾äº**è¿ç»­**ç©ºé—´\n- é“¾å¼å­˜å‚¨ï¼ˆé‡ç‚¹ï¼‰ï¼šæ”¾åˆ°å­˜å‚¨åŒºçš„ä¸åŒä½ç½®ï¼Œç”¨åœ°å€ï¼ˆæŒ‡é’ˆï¼‰æ–¹å¼å»ºç«‹é€»è¾‘ä¸Šçš„è”ç³»\n- ç´¢å¼•å­˜å‚¨ï¼šå»ºç«‹é™„åŠ çš„ç´¢å¼•è¡¨ï¼ˆç”µè¯ç°¿ï¼‰\n- æ•£åˆ—å­˜å‚¨ï¼šä¾æ®æ•°æ®å…ƒç´ çš„ç‰¹æ®Šå­—æ®µï¼ˆå…³é”®å­—keyï¼‰è®¡ç®—å…ƒç´ çš„å­˜æ”¾åœ°å€ï¼Œç„¶åæŒ‰åœ°å€å­˜æ”¾\n\n### çº¿æ€§è¡¨\nçº¿æ€§è¡¨æ˜¯åŒ…å«è‹¥å¹²æ•°æ®å…ƒç´ çš„ä¸€ä¸ªçº¿æ€§åºåˆ—ï¼Œè®°ä¸º\n$$\nL=(a_0,...,a_{i-1},a_i,a_{i+1},...,a_{n-1})\n$$\n\n$L$ä¸ºè¡¨åï¼Œ$a_i$ä¸ºæ•°æ®å…ƒç´ ï¼Œ$n$ä¸ºè¡¨é•¿ï¼Œ$n>0$æ—¶è¡¨ä¸ºéç©ºè¡¨ï¼Œå¦åˆ™ä¸ºç©ºè¡¨\n\nçº¿æ€§è¡¨å¯ä»¥ç”¨äºŒå…ƒç»„å½¢å¼æè¿°\n$$\nL=(D,R)\n$$\nå³çº¿æ€§è¡¨$L$åŒ…å«æ•°æ®å…ƒç´ é›†åˆ$D$å’Œå…³ç³»é›†åˆ$R$\n\n- å…³ç³»ç¬¦<$a_i$,$a_{i+1}$>ä¸ºæœ‰åºå¯¹\n- è¡¨ç¤ºä»»æ„ä¸¤ä¸ªç›¸é‚»å…ƒç´ ä¹‹é—´çš„å…ˆåæ¬¡åº\n\n$E.g.$ æœ‰é¡ºåºè¡¨L={1,2,3,4,5,6}ï¼Œè‹¥ä½¿ç”¨$L=(D,R)$è¡¨ç¤ºï¼Œåˆ™$D={1,2,3,4,5,6}$,$R=<1,2>,<2,3>,...$\n\nçº¿æ€§è¡¨çš„ç‰¹å¾ï¼š\n\n- è¡¨å¤´æ— å‰é©±\n- è¡¨å°¾æ— åç»§\n- å…¶ä½™å…ƒç´ ä»…æœ‰ä¸€ä¸ªç›´æ¥å‰é©±å’Œç›´æ¥åç»§\n\né¡ºåºå­˜å‚¨ç»“æ„çš„ç‰¹ç‚¹ï¼š\n\n- é€»è¾‘ä¸Šç›¸é‚»ï¼Œåˆ™å­˜å‚¨ä½ç½®ä¹Ÿç›¸é‚»\n- å¯¹å…ƒç´ çš„å­˜å–ä¸ºéšæœºå­˜å–æˆ–æŒ‰åœ°å€å­˜å‚¨\n- å­˜å‚¨å¯†åº¦é«˜\n- å¯¹è¡¨çš„æ’å…¥å’Œåˆ é™¤ç­‰è¿ç®—çš„æ—¶é—´å¤æ‚åº¦é«˜\n\nCè¯­è¨€ä¸­ï¼Œå¯å€ŸåŠ©ä¸€ç»´æ•°ç»„ç±»å‹æ¥è¡¨è¿°çº¿æ€§è¡¨çš„é¡ºåºå­˜å‚¨ç»“æ„\n\n```\n/*\n    * @brief:åˆ›å»ºæ–°çº¿æ€§è¡¨\n    * @param:æ— \n    * @return:çº¿æ€§è¡¨æŒ‡é’ˆ(sqlinkç±»å‹)ï¼Œç”³è¯·å¤±è´¥è¿”å›NULL\n*/\nsqlink list_create()\n{\n    sqlink L;   //å£°æ˜sqlinkç±»å‹çš„è¡¨L\n    L = (sqlink)malloc(sizeof(sqlist));  // ä¸ºç©ºè¡¨ç”³è¯·å†…å­˜ï¼Œè¿”å›åˆ†é…çš„å†…å­˜åœ°å€\n    \n    //åˆ¤æ–­å†…å­˜æ˜¯å¦ç”³è¯·æˆåŠŸ\n    if (L == NULL)\n    {\n        printf(\"memory allocation failed\\n\");\n        return NULL;\n    }\n\n    memset(L, 0, sizeof(sqlist));   //LæŒ‡å‘çš„sqlistç»“æ„ä½“çš„å†…å­˜æ¸…é›¶\n    L->last = -1;   //è¡¨ç¤ºçº¿æ€§è¡¨ä¸ºç©º\n\n    return L;\n}\n\n/*\n    * @brief:æ¸…é™¤çº¿æ€§è¡¨å†…çš„å…ƒç´ ï¼Œå…¨éƒ¨ç½®ä¸ºé›¶\n    * @param: L:æŒ‡å‘è¡¨çš„æŒ‡é’ˆ\n    * @return:æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_clear(sqlink L)\n{\n    //åˆ¤æ–­æ˜¯å¦æ˜¯ç©ºè¡¨\n    if (L == NULL)\n    {\n        return -1;\n    }\n\n    memset(L, 0, sizeof(sqlist));   //LæŒ‡å‘çš„sqlistç»“æ„ä½“çš„å†…å­˜æ¸…é›¶\n    L->last = -1;   //lastç½®ä¸º-1ï¼Œè¡¨ç¤ºçº¿æ€§è¡¨ä¸ºç©º \n\n    return 0;\n}\n\n/*\n    * @brief:åˆ¤æ–­çº¿æ€§è¡¨æ˜¯å¦ä¸ºç©ºè¡¨\n    * @param: L:æŒ‡å‘çº¿æ€§è¡¨çš„æŒ‡é’ˆ\n    * @return:ç©ºè¡¨è¿”å›1ï¼Œéç©ºè¡¨è¿”å›0\n*/\nint list_empty(sqlink L)\n{\n    //åˆ¤æ–­æ˜¯å¦ä¸ºç©ºè¡¨\n    if (L->last == -1)\n    {\n        return 1;\n    }\n    else\n    {\n        return 0;\n    }\n}\n\n/*\n    * @brief:æ±‚çº¿æ€§è¡¨çš„é•¿åº¦(æœ‰æ•ˆå…ƒç´ ä¸ªæ•°)\n    * @param: L:æŒ‡å‘çº¿æ€§è¡¨çš„æŒ‡é’ˆ\n    * @return:è¡¨ä¸å­˜åœ¨è¿”å›-1ï¼Œå¦åˆ™è¿”å›é•¿åº¦\n*/\nint list_length(sqlink L)\n{\n    if (L == NULL)\n    {\n        return -1;\n    }\n    return (L->last + 1);   //é•¿åº¦ä¸ºè¡¨å°¾ä¸‹æ ‡åŠ 1\n}\n\n/*\n    * @brief:å‘çº¿æ€§è¡¨å†…æ’å…¥æ•°å€¼ï¼Œæ’å…¥ååŸä½ç½®å‘åçš„æ‰€æœ‰å…ƒç´ åç§»ä¸€ä½\n    * @param: L:æŒ‡å‘çº¿æ€§è¡¨çš„æŒ‡é’ˆ \n    * @param: value:å¾…æ’å…¥å€¼ \n    * @param: pos:æ’å…¥ä½ç½®\n    * @return:æ’å…¥æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_insert(sqlink L, data_t value, int pos)\n{\n    if (L == NULL) return -1;   //è¡¨ä¸å­˜åœ¨è¿”å›-1\n    //åˆ¤æ–­çº¿æ€§è¡¨æ˜¯å¦æ»¡\n    if (L->last == N - 1)\n    {\n        printf(\"table is full\\n\");\n        return -1;\n    }\n    //æ£€æŸ¥æ’å…¥ä½ç½®æ˜¯å¦æ­£ç¡®ï¼Œåº”å±äº[0,last]ï¼Œå¦‚æœæ˜¯ç©ºè¡¨åˆ™ä¸æ£€æŸ¥\n    if (pos < 0 || pos >= L->last + 1)\n    {\n        if (L->last != -1) \n        {\n            printf(\"pos is illegal\\n\");\n            return -1;\n        }\n\n    }\n    //å‘åç§»åŠ¨åŸæœ‰å…ƒç´ ï¼Œä»æœ€åä¸€ä¸ªå…ƒç´ å¼€å§‹\n    for (int i = L->last; i >= pos; i--)\n    {\n        L->data[i+1] = L->data[i];\n    }\n    //æ›´æ–°æ’å…¥å€¼å’Œlast\n    L->data[pos] = value;\n    L->last++;\n\n    return 0;    \n}\n\n/*\n    * @brief:éå†å¹¶æ‰“å°çº¿æ€§è¡¨å†…å…ƒç´ \n    * @param: L:æŒ‡å‘çº¿æ€§è¡¨çš„æŒ‡é’ˆ\n    * @return:æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_show(sqlink L)\n{\n    if (L == NULL) return -1;   //åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆè¡¨\n    if (L->last == -1) printf(\"table is empty\\n\");  //åˆ¤æ–­æ˜¯å¦ä¸ºç©ºè¡¨\n    //éå†å¹¶æ‰“å°\n    for (int i = 0; i <= L->last; i++)  //æ³¨æ„æ˜¯å°äºç­‰äºï¼Œä¸ç„¶ä¸æ˜¾ç¤ºè¡¨å°¾\n    {\n        printf(\"%d \",L->data[i]);\n    }\n\n    return 0;\n}\n\n/*\n    * @brief:åˆ é™¤å…¨è¡¨ï¼ŒåŒ…æ‹¬åˆ›å»ºè¡¨æ—¶æ‰€åˆ†é…çš„å†…å­˜\n    * @param: L:æŒ‡å‘çº¿æ€§è¡¨çš„æŒ‡é’ˆ\n    * @return:è¡¨ä¸å­˜åœ¨è¿”å›-1ï¼ŒæˆåŠŸè¿”å›0\n*/\nint list_delete(sqlink L)\n{\n    if (L == NULL) return -1;\n    free(L);    //é‡Šæ”¾ä¸ºè¡¨Lç”³è¯·çš„å†…å­˜\n    L = NULL;   //æ ‡è®°è¡¨Lä¸ºæ— æ•ˆè¡¨\n    return 0;\n}\n\n/*\n    * @brief:åˆ é™¤è¡¨ä¸­æŸä¸€ä½ç½®çš„å…ƒç´ \n    * @param: Lï¼šæŒ‡å‘çº¿æ€§è¡¨çš„æŒ‡é’ˆ\n    * @param: posï¼šå¾…åˆ é™¤å…ƒç´ ä½ç½®\n    * @return:åˆ é™¤æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_delete_single(sqlink L, int pos)\n{\n    if (L == NULL) return -1;   //åˆ¤æ–­æ˜¯å¦ä¸ºæ— æ•ˆè¡¨\n\n    //åˆ¤æ–­posæ˜¯å¦ä½äºæœ‰æ•ˆèŒƒå›´å†… åº”ä¸º[0,last]\n    if (pos < 0 || pos > L->last)\n    {\n        printf(\"pos is illegal\\n\");\n        return -1;\n    }\n\n    //[pos+1,last]åŒºé—´å†…å·²æœ‰å…ƒç´ å‰ç§»\n    for (int i = pos + 1; i < L->last + 1; i++)\n    {\n       L->data[i-1] = L->data[i];   //æ•°æ®å‰ç§»ï¼Œè‡ªåŠ¨è¦†ç›–\n    }\n\n    //æ›´æ–°last\n    L->last--;   \n\n    return 0;\n}\n\n/*\n    * @brief:åˆå¹¶ä¸¤ä¸ªçº¿æ€§è¡¨ï¼ŒL2å…¨è¡¨å…ƒç´ ç½®äºL1å…ƒç´ ä¹‹å\n    * @param: L1ï¼šæŒ‡å‘å¾…åˆå¹¶çº¿æ€§è¡¨L1çš„æŒ‡é’ˆ\n    * @param: L1ï¼šæŒ‡å‘å¾…åˆå¹¶çº¿æ€§è¡¨L2çš„æŒ‡é’ˆ\n    * @return:åˆå¹¶æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_merge(sqlink L1, sqlink L2)\n{\n    int count = 0;\n    if (L1 == NULL || L2 == NULL) return -1;\n\n    //åˆ¤æ–­åˆå¹¶åL1æ˜¯å¦è¶Šç•Œ\n    if (L1->last + 1 + L2->last + 1 > N) printf(\"table is too big\\n\");\n\n    //L2çš„ç¬¬iä½åŠ åˆ°L1çš„last+1+iä½ç½®ï¼Œæ€»å…±ä¼ é€’L2->lastä¸ªæ•°\n    for (int i = 0; i <= L2->last; i++)\n    {\n        L1->data[L1->last+1+i] = L2->data[i];\n        count++;    //è®¡æ•°\n    }\n\n    //æ›´æ–°L1->lastä¸ºåŸlastå€¼+ä¼ é€’å®Œæˆçš„å…ƒç´ ä¸ªæ•°\n    L1->last = L1->last + count;\n\n    return 0;\n}\n\n/*\n    * @brief:æŸ¥è¯¢çº¿æ€§è¡¨ä¸­æ˜¯å¦å­˜åœ¨æŸä¸€å…ƒç´ \n    * @param: Lï¼šæŒ‡å‘å¾…æŸ¥è¯¢çº¿æ€§è¡¨Lçš„æŒ‡é’ˆ\n    * @param: valueï¼šå¾…æŸ¥è¯¢å€¼\n    * @return:å€¼å¯¹åº”çš„å…ƒç´ å­˜åœ¨è¿”å›1ï¼Œä¸æˆåŠŸè¿”å›-1\n*/\nint list_locate(sqlink L, data_t value)\n{\n    int i = 0;\n\n    //æœç´¢Lä¸­æ˜¯å¦æœ‰å…ƒç´ ç­‰äºvalue\n    for (i = 0 ; i <=L->last; i++)\n    {\n        if (L->data[i] == value) return 1;\n    }\n\n    return -1;\n}\n\n/*\n    * @brief:æŸ¥æ‰¾L1å’ŒL2ä¸­æ˜¯å¦æœ‰ç›¸åŒçš„å…ƒç´ ï¼Œå°†ä¸åŒçš„å…ƒç´ å­˜äºæ–°è¡¨L3\n    * @param: L1ï¼šæŒ‡å‘å¾…åˆå¹¶çº¿æ€§è¡¨L1çš„æŒ‡é’ˆ\n    * @param: L2ï¼šæŒ‡å‘å¾…åˆå¹¶çº¿æ€§è¡¨L2çš„æŒ‡é’ˆ\n    * @return:åˆå¹¶æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nsqlink list_mergetonewtable(sqlink L1, sqlink L2)\n{\n    sqlink L3 = list_create();  //åˆ›å»ºæ–°è¡¨L3\n    int i = 0;\n    int ret;\n\n    if (L1 == NULL || L2 == NULL) \n    {\n        printf(\"no such table\");\n        return NULL;\n    }\n    //éå†L2å†…å…ƒç´ \n    while (i <= L2->last)\n    {\n        ret = list_locate(L1, L2->data[i]);   //æŸ¥æ‰¾L1ä¸­æ˜¯å¦æœ‰L2ä¸­çš„ç¬¬iä¸ªå…ƒç´ ï¼Œå³åˆ¤æ–­æ˜¯å¦é‡å¤\n        //æŸå…ƒç´ ä¸é‡å¤åˆ™å‘L3æ’å…¥\n        if (ret == -1)\n        {\n            list_insert(L3, L2->data[i], L3->last+1);   //æŒ‰é¡ºåºå‘L3æ’å…¥éé‡å¤å€¼\n        }\n        i++;    //æ›´æ–°ç´¢å¼•\n    }\n    return L3;\n}\n\n/*\n    * @brief:æ¸…é™¤çº¿æ€§è¡¨å†…çš„é‡å¤å…ƒç´ ï¼Œæ¸…é™¤åæ‰€æœ‰å…ƒç´ å‰ç§»è¡¥ç©º\n    * @param: Lï¼šæŒ‡å‘å¾…åˆå¹¶çº¿æ€§è¡¨L1çš„æŒ‡é’ˆ\n    * @return:æ“ä½œæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1\n*/\nint list_purge(sqlink L)\n{\n    if (L == NULL) return -1;\n\n    for (int i = 0; i <= L->last; i++)  //éå†çº¿æ€§è¡¨\n    {\n        for (int j = i + 1; j <= L->last; j++)  //ä»ç´¢å¼•i+1å¼€å§‹ï¼Œå¦‚æœi+1åŠä¹‹åçš„å…ƒç´ å’Œdata[i]ç›¸ç­‰ï¼Œåˆ¤æ–­ä¸ºé‡å¤\n        {\n            if (L->data[i] == L->data[j])\n            {\n                printf(\"The repeated elements are:%d\\n\",L->data[i]);\n                list_delete_single(L, j);   //åˆ é™¤é‡å¤çš„ç¬¬jä¸ªå…ƒç´ \n                j--;    //å›é€€ç´¢å¼•ï¼Œé˜²æ­¢è·³è¿‡æœªæ£€æŸ¥çš„å…ƒç´ \n            }\n        }\n    }\n    return 0;\n} \n```\n#### çº¿æ€§è¡¨çš„é¡ºåºå­˜å‚¨ç¼ºç‚¹\n- è¦æ±‚ç³»ç»Ÿæä¾›ä¸€å¤§ç‰‡è¿ç»­å­˜å‚¨ç©ºé—´\n- æ’å…¥ã€åˆ é™¤ç­‰è¿ç®—éœ€è¦éå†æ•´ä¸ªå†…å­˜ï¼Œè¿ç®—è€—æ—¶ï¼Œä¸”å…ƒç´ å¯èƒ½åœ¨å­˜å‚¨å™¨ä¸­æˆç‰‡ç§»åŠ¨\n","categories":["æ•°æ®ç»“æ„"]},{"title":"åä¹é˜¶åŒæ­¥å‘ç”µæœºç»„æ¨¡å‹é™é˜¶ç ”ç©¶","url":"/2024/09/14/åä¹é˜¶åŒæ­¥å‘ç”µæœºç»„æ¨¡å‹é™é˜¶ç ”ç©¶/","content":"## æ‘˜è¦\næœ¬æ–‡ä»‹ç»äº†ä¸€ä¸ªäºŒé˜¶åŒæ­¥ç”µæœºæ¨¡å‹åº“ï¼Œå¯ç”¨äºç”µåŠ›ç³»ç»ŸåŠ¨æ€æ€§èƒ½åˆ†æå’Œæ§åˆ¶è®¾è®¡ä»»åŠ¡ã€‚è¿™äº›æ¨¡å‹çš„ç»“æ„ä¸ç»å…¸æ¨¡å‹ç›¸ä¼¼ï¼Œå› ä¸ºå®ƒä»¬ç”±ä¸¤ä¸ªåŠ¨æ€çŠ¶æ€ç»„æˆï¼Œå³åŠŸç‡å¤¹è§’å’Œè§’é€Ÿåº¦ã€‚ç„¶è€Œï¼Œä¸ç»å…¸æ¨¡å‹ä¸åŒï¼Œè¿™äº›æ¨¡å‹çš„åº”ç”¨èŒƒå›´ä¸ä»…é™äºç¬¬ä¸€æ¬¡æ‘†åŠ¨ç¨³å®šæ€§åˆ†æï¼›ä¾‹å¦‚ï¼Œå®ƒä»¬è¿˜å¯ç”¨äºæš‚æ€ç¨³å®šæ€§ç ”ç©¶ã€‚è¿™äº›æ¨¡å‹æ˜¯é€šè¿‡ä½¿ç”¨å¥‡å¼‚æ‘„åŠ¨æŠ€æœ¯ç³»ç»Ÿåœ°ç®€åŒ–åä¹é˜¶åŒæ­¥å‘ç”µæœºç»„æ¨¡å‹è€Œå¼€å‘çš„ï¼Œå¹¶é€šè¿‡å°†å…¶ç”µå‹ã€é¢‘ç‡å’Œç›¸ä½æ›²çº¿ä¸é«˜é˜¶æ¨¡å‹å’Œç»å…¸æ¨¡å‹çš„ç”µå‹ã€é¢‘ç‡å’Œç›¸ä½æ›²çº¿è¿›è¡Œæ¯”è¾ƒæ¥éªŒè¯ã€‚\n\n## ä»‹ç»\nåŒæ­¥ç”µæœºçš„åŠ¨æ€æ¨¡å‹å¯ç”¨äºç”µåŠ›ç³»ç»Ÿåˆ†æã€æ§åˆ¶è®¾è®¡ä»»åŠ¡ï¼Œæ¯ç§åº”ç”¨éƒ½éœ€è¦èƒ½å¤Ÿæ•æ‰ä¸é¢„æœŸç”¨é€”ç›¸å…³çš„åŠ¨æ€ç°è±¡çš„æ¨¡å‹ã€‚è¿™å¯¼è‡´æ–‡çŒ®ä¸­åŒæ­¥ç”µæœºæ¨¡å‹çš„æ¿€å¢ï¼Œè¿™äº›æ¨¡å‹çš„å¤æ‚åº¦ã€è®¡ç®—æˆæœ¬å’ŒçŠ¶æ€ç©ºé—´ç»´åº¦å„ä¸ç›¸åŒã€‚å…¶ä¸­ä¸€ç§æ¨¡å‹æ˜¯ä¹‹å‰ç ”ç©¶æå€¡çš„æ‰€è°“ç»å…¸æ¨¡å‹ï¼Œè¿™æ˜¯ä¸€ç§äºŒé˜¶åŠ¨æ€æ¨¡å‹ï¼Œå¯ä»¥æ•æ‰ç”µæœºç›¸ä½å’Œè§’é€Ÿåº¦çš„åŠ¨æ€ã€‚\n\nä»åˆ†æä¸Šçœ‹ï¼Œç»å…¸æ¨¡å‹æ˜¯æœ€ç®€å•çš„åŒæ­¥æœºåŠ¨åŠ›å­¦æ¨¡å‹ï¼Œä½†å®ƒå…·æœ‰æŸäº›å±€é™æ€§ï¼Œé™åˆ¶äº†å…¶åº”ç”¨äºç¬¬ä¸€æ¬¡æ‘†åŠ¨ç¨³å®šæ€§åˆ†æï¼Œå³ç¬¬ä¸€ç§’çš„ç¨³å®šæ€§åˆ†æã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è€ƒè™‘åˆ°ç”µåŠ›ç³»ç»Ÿåœ¨ç¬¬ä¸€æ¬¡æ‘†åŠ¨æ—¶å¯èƒ½ç¨³å®šï¼Œä½†åœ¨åç»­æ‘†åŠ¨æ—¶ä¸ç¨³å®šï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œç»å…¸æ¨¡å‹è™½ç„¶ç®€å•ï¼Œä½†å¯¹äºè¶…è¿‡ä¸€ç§’æ—¶é—´é—´éš”çš„ç”µåŠ›ç³»ç»Ÿä»»åŠ¡æ¥è¯´å¹¶ä¸å¯é ã€‚ä¾‹å¦‚ï¼Œå‘ç”µæœºåŒæ­¥æ–¹æ¡ˆçš„è®¾è®¡éœ€è¦ä¸€ä¸ªæ¨¡å‹æ¥æ•æ‰æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…å‘ç”µæœºç›¸ä½ã€é¢‘ç‡å’Œç”µå‹å¹…åº¦çš„åŠ¨æ€ã€‚äºŒé˜¶æ¨¡å‹ï¼ˆå¦‚ç»å…¸æ¨¡å‹ï¼‰åº”è¯¥èƒ½å¤Ÿæ»¡è¶³è¦æ±‚ï¼Œä½†å¦‚æœåŒæ­¥å‘¨æœŸè¶…è¿‡ä¸€ç§’ï¼Œç¬¬ä¸€æ¬¡æ‘†åŠ¨ç¨³å®šæ€§çº¦æŸå¯èƒ½ä¼šä½¿å…¶ä¸é€‚ç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œè™½ç„¶ç°æœ‰çš„é«˜é˜¶æ¨¡å‹ï¼ˆå¦‚åŒè½´æ¨¡å‹å’Œå•è½´æ¨¡å‹ï¼‰æ˜¾ç„¶æ›´å‡†ç¡®ï¼Œå› æ­¤å¯¹ç”µåŠ›ç³»ç»Ÿä»¿çœŸéå¸¸æœ‰ç”¨ï¼Œä½†å®ƒä»¬ä¹Ÿæ›´åŠ å¤æ‚ä¸”è®¡ç®—æˆæœ¬é«˜æ˜‚ã€‚å› æ­¤ï¼Œé«˜é˜¶æ¨¡å‹é€šå¸¸éš¾ä»¥åˆ†ææ­¤ç±»æ§åˆ¶è®¾è®¡ä»»åŠ¡ã€‚å› æ­¤ï¼Œéœ€è¦å¼€å‘æ—¢å…·æœ‰ç»å…¸æ¨¡å‹çš„ç®€å•æ€§ï¼Œåˆå…·æœ‰ç»å…¸æ¨¡å‹æ‰€ç¼ºä¹çš„æ—¶é—´å¹¿åº¦çš„æ¨¡å‹ã€‚\n\næœ¬æ–‡çš„ä¸»è¦è´¡çŒ®æ˜¯å¼€å‘äº†äºŒé˜¶åŒæ­¥å‘ç”µæœºæ¨¡å‹ï¼Œä¸ç»å…¸æ¨¡å‹ç›¸æ¯”ï¼Œè¯¥æ¨¡å‹å…·æœ‰ç›¸åŒçš„çŠ¶æ€ç©ºé—´ç»´åº¦ï¼Œåœ¨é•¿æ—¶é—´é—´éš”å†…æ›´ç²¾ç¡®ï¼Œå¹¶ä¸”é€‚â€‹â€‹ç”¨äºæ›´å¹¿æ³›çš„åº”ç”¨ã€‚ä½¿ç”¨å¥‡å¼‚æ‘„åŠ¨åˆ†æä½œä¸ºä¸»è¦å·¥å…·ï¼Œæœ¬æ–‡æå‡ºçš„äºŒé˜¶æ¨¡å‹æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¨å¯¼å‡ºæ¥çš„ï¼š(i) è¯†åˆ«é«˜é˜¶æ¨¡å‹ä¸­æœ€å¿«çš„åŠ¨æ€çŠ¶æ€ï¼›(ii) ä¸ºå®ƒä»¬å¼€å‘è¿‘ä¼¼æµå½¢æ–¹ç¨‹ï¼ˆä»£æ•°æ–¹ç¨‹ï¼‰ï¼›(iii) ç”¨ä»£æ•°æ–¹ç¨‹æ›¿æ¢è¿™äº›çŠ¶æ€çš„å¾®åˆ†æ–¹ç¨‹ã€‚\n\næˆ‘ä»¬å¼€å‘æ‰€æå‡ºçš„æœºå™¨æ¨¡å‹çš„æ–¹æ³•æ˜¯åŸºäºä¸­çš„å¼€å‘ï¼Œå…¶ä¸­ä½¿ç”¨å¿«é€ŸåŠ¨æ€çŠ¶æ€çš„é›¶é˜¶å’Œä¸€é˜¶æµå½¢è¿‘ä¼¼æ¥å¼€å‘é™é˜¶æ¨¡å‹ã€‚\n\næœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†å®‰æ’å¦‚ä¸‹ã€‚åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªåŒæ­¥æœºå’Œä¸€ä¸ªé«˜é˜¶æ¨¡å‹ï¼Œè¯¥æ¨¡å‹è¢«ç”¨ä½œå¼€å‘é™é˜¶æ¨¡å‹çš„èµ·ç‚¹ï¼›æˆ‘ä»¬è¿˜è®¨è®ºäº†ç»å…¸æ¨¡å‹ã€‚åœ¨ç¬¬ä¸‰éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¥‡å¼‚æ‘„åŠ¨åˆ†æä»é«˜é˜¶æ¨¡å‹å¼€å‘äº†ä¸€ä¸ªäºŒé˜¶æ¨¡å‹åº“ã€‚æœ€åï¼Œåœ¨ç¬¬å››éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ•°å€¼ç¤ºä¾‹éªŒè¯äº†å¼€å‘çš„äºŒé˜¶æ¨¡å‹ï¼Œåœ¨ç¬¬äº”éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬è¯„è®ºäº†æ‰€ç»™å‡ºç»“æœçš„å«ä¹‰ã€‚\n\n## å‡†å¤‡å·¥ä½œ\næœ¬èŠ‚é¦–å…ˆä»‹ç»æœ¬æ–‡é‡‡ç”¨çš„åŒæ­¥ç”µæœºé«˜é˜¶æ¨¡å‹ã€‚æ­¤å¤–ï¼Œè¿˜è®¨è®ºäº†è¯¥æ¨¡å‹çš„æ—¶é—´å°ºåº¦ç‰¹æ€§ã€‚ä¹‹åï¼Œæˆ‘ä»¬ä»‹ç»æ‰€è°“çš„ç»å…¸æ¨¡å‹ï¼Œå¹¶æè¿°å¦‚ä½•ä»é«˜é˜¶æ¨¡å‹å¼€å‘å‡ºè¯¥æ¨¡å‹ã€‚\n\n### é«˜é˜¶åŒæ­¥å‘ç”µæœºæ¨¡å‹\næœ¬èŠ‚ä¸­ä»‹ç»çš„é«˜é˜¶åŒæ­¥æœºæ¨¡å‹åŸºäºå‚è€ƒæ–‡çŒ®ä¸­çš„å¼€å‘æˆæœã€‚æ¨¡å‹ä¸­åŒ…å«çš„ç»„ä»¶åŒ…æ‹¬ï¼š(i) ä¸‰ä¸ªé˜»å°¼ç»•ç»„ï¼Œ(ii) ç»•çº¿å¼è½¬å­ç»“æ„åŒæ­¥å‘ç”µæœºï¼Œ(iii) IEEE DC1A å‹åŠ±ç£ç³»ç»Ÿï¼Œä»¥åŠ (iv) ä¼å¾·æ²ƒå¾·æŸ´æ²¹è°ƒé€Ÿå™¨ (DEGOV1)ï¼Œä¸æŸ´æ²¹å‘åŠ¨æœºè€¦åˆï¼Œä½œä¸ºåŸåŠ¨æœºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æä¾›æè¿°è¿™äº›ç»„ä»¶åŠ¨æ€è¡Œä¸ºçš„æ•°å­¦è¡¨è¾¾å¼ã€‚ï¼ˆè¯·æ³¨æ„ï¼Œè¯¥æ¨¡å‹é‡‡ç”¨ Park å˜æ¢åçš„dq0åæ ‡ç³»å‘ˆç°ï¼Œæ‰€æœ‰å‚æ•°å’Œå˜é‡å‡ç»è¿‡ç¼©æ”¾ï¼Œå¹¶ä½¿ç”¨å•ä½ç³»ç»Ÿè¿›è¡Œå½’ä¸€åŒ–ï¼‰ã€‚\n\n#### é˜»å°¼ç»•ç»„æ¨¡å‹\nä»¤ $\\psi_{kq}$ å’Œ $\\psi_{fq}$ è¡¨ç¤ºäº¤è½´é˜»å°¼ç»•ç»„å’Œäº¤è½´ç¨³å®šç»•ç»„çš„ç£é“¾ï¼Œä»¤ $\\psi_{kd}$ å’Œ $\\psi_{fd}$ åˆ†åˆ«è¡¨ç¤ºç›´è½´é˜»å°¼ç»•ç»„å’ŒåŠ±ç£ç»•ç»„çš„ç£é“¾ï¼Œä»¤ A å’Œ B åˆ†åˆ«è¡¨ç¤ºå®šå­è¾“å‡ºç”µæµçš„ q è½´å’Œ d è½´åˆ†é‡ã€‚é‚£ä¹ˆï¼Œé˜»å°¼ç»•ç»„åŠ¨åŠ›å­¦å¯ä»¥æè¿°å¦‚ä¸‹ï¼š\n\n$$\nT_q'' p\\psi_{kq}=-\\psi_{kq}-(X_q'-X_k)I_q-E_d'\\\\\nT_d''p\\psi_{kd}=-\\psi_{kd}-(X_d'-X_k)I_d+E_q'(t)\n$$\nä»¥åŠ\n\n$$\nT_q'p\\psi_{fq}=-\\psi_{fq}+(X_q-X_q')(I_q-\\frac{X_q'-X_q''}{(X_q'-X_k)^2}(\\psi_{kq}+(X_q'-X_k)I_q-\\psi_{fq}))\n$$\n\nå¼ä¸­\n- $X_k$ï¼šç”µæœºæ¼ç”µæŠ—\n- $X_q$ï¼šç”µæœºå®šå­ç”µæŠ—\n- $X_q'$ï¼Œ$X_d'$ï¼šç”µæœºç¬æ€ç”µæŠ—\n- $X_q''$:ç”µæœºè¶…ç¬æ€ç”µæŠ—","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"åäºŒç›¸åŒæ­¥æ•´æµå‘ç”µæœºçš„æ•°å­¦æ¨¡å‹","url":"/2024/09/13/åäºŒç›¸æ•´æµå‘ç”µæœºçš„æ•°å­¦æ¨¡å‹/","content":"## å‡è®¾æ¡ä»¶ä¸æ­£æ–¹å‘\nä¸å¸¸è§„åŒæ­¥å‘ç”µæœºç›¸æ¯”ï¼Œå¤šç›¸æ•´æµå‘ç”µæœºé™¤äº†å®šå­ç»“æ„æœ‰å·®å¼‚ï¼Œå…¶è½¬å­ä¹Ÿä¼šæœ‰ä¸€å®šçš„åŒºåˆ«ã€‚ä¸ºäº†æ”¹å–„å…¶è¿è¡Œç¨³å®šæ€§,åœ¨å¸¸è§„åŒæ­¥å‘ç”µæœºè½¬å­è®¾ç½®çš„åŠ±ç£ç»•ç»„($fd$)ã€dè½´é˜»å°¼ç»•ç»„($kd$)å’Œqè½´é˜³é˜»å°¼ç»•ç»„($kq$)ä¸‰å¥—ç»•ç»„åŸºç¡€ä¸Šï¼Œè¿˜ä¼šå¸ƒç½®qè½´ç¨³å®šç»•ç»„($fq$)ã€‚ä¸ºäº†ç®€åŒ–åˆ†æè¿‡ç¨‹ï¼Œå¹¶ç¡®ä¿ä¸€å®šçš„åˆ†æç²¾åº¦ï¼Œå¯¹åäºŒç›¸å‘ç”µæœºçš„ç‰©ç†çŠ¶æ€ä½œå¦‚ä¸‹åŸºæœ¬å‡è®¾:\n\n- å¿½ç•¥é“å¿ƒææ–™çš„é¥±å’Œã€ç£æ»åŠæ¶¡æµå½±å“ï¼Œä¸è®¡å¯¼çº¿çš„é›†è‚¤æ•ˆåº”ï¼›\n- å¿½ç•¥ç©ºé—´è°æ³¢ç£åœºçš„å½±å“ï¼Œæ°”éš™ç£åœºæŒ‰æ­£å¼¦åˆ†å¸ƒï¼›\n- å¿½ç•¥å®šã€è½¬å­é½¿æ§½å½±å“ï¼Œè®¤ä¸ºå®šå­å’Œè½¬å­è¡¨é¢å…‰æ»‘ï¼›\n- å°†è½¬å­ä¸Šçš„é˜»å°¼å›è·¯çœ‹ä½œä¸¤ç»„ç­‰æ•ˆçš„é˜»å°¼ç»•ç»„ï¼Œå³$D$è½´é˜»å°¼ç»•ç»„å’Œ$Q$è½´é˜»å°¼ç»•ç»„ã€‚\n\næ­£æ–¹å‘è§„å®šå¦‚ä¸‹ï¼š\n- å®šå­ç»•ç»„ç”µè·¯é‡‡ç”¨å‘ç”µæœºæƒ¯ä¾‹ï¼Œè½¬å­ç»•ç»„ç”µè·¯é‡‡ç”¨ç”µåŠ¨æœºæƒ¯ä¾‹ï¼›\n- æ­£æ–¹å‘çš„å®šå­ç”µæµäº§ç”Ÿè´Ÿçš„ç£é“¾ï¼Œæ­£æ–¹å‘çš„è½¬å­ç”µæµäº§ç”Ÿæ­£çš„ç£é“¾ï¼›\n- è½¬å­æ—‹è½¬æ­£æ–¹å‘ä¸ºé€†æ—¶é’ˆæ–¹å‘ï¼Œ$q$è½´æ­£æ–¹å‘é¢†å…ˆ$d$è½´æ­£æ–¹å‘90Â°ç”µè§’åº¦ã€‚\n\n![](/images/12/4-1.png)\n\n![](/images/12/4-2.png)\n\n## abcåæ ‡ç³»ä¸‹çš„åŸºæœ¬æ–¹ç¨‹\nç£é“¾å‚æ•°çŸ©é˜µä¸ºï¼š\n\n$$\n\\Psi_{abc}=\n\\begin{bmatrix}\n\\Psi_{a1} & \\Psi_{b1} & \\Psi_{c1} & \\Psi_{a2} & \\Psi_{b2} & \\Psi_{c2} & \\Psi_{a3} & \\Psi_{b3} & \\Psi_{c3} & \\Psi_{a4} & \\Psi_{b4} & \\Psi_{c4} & \\Psi_{fd} & \\Psi_{kd} & \\Psi_{fq} & \\Psi_{kq}\n\\end{bmatrix}^T\n$$\nå¼ä¸­å‰12é¡¹ä¸‹æ ‡ä¸º12ä¸ªç›¸ä½çš„æ ‡å·ï¼Œåå››é¡¹ä¸­\n- $\\Psi_{fd}$ï¼šåŠ±ç£ç»•ç»„ç£é“¾\n- $\\Psi_{kd}$ï¼šç›´è½´é˜»å°¼ç»•ç»„ç£é“¾\n- $\\Psi_{fq}$ï¼šäº¤è½´ç¨³å®šç»•ç»„ç£é“¾\n- $\\Psi_{kq}$ï¼šäº¤è½´é˜»å°¼ç»•ç»„ç£é“¾\n\nç”µå‹å‚æ•°çŸ©é˜µä¸º\n$$\nu_{abc}=\n\\begin{bmatrix}\nu_{a1} & u_{b1} & u_{c1} & u_{a2} & u_{b2} & u_{c2} & u_{a3} & u_{b3} & u_{c3} & u_{a4} & u_{b4} & u_{c4} & u_{fd} & u_{kd} & u_{fq} & u_{kq}\n\\end{bmatrix}^T\n$$\n\nç”µæµå‚æ•°çŸ©é˜µä¸º\n$$\ni_{abc}=\n\\begin{bmatrix}\ni_{a1} & i_{b1} & i_{c1} & i_{a2} & i_{b2} & i_{c2} & i_{a3} & i_{b3} & i_{c3} & i_{a4} & i_{b4} & i_{c4} & i_{fd} & i_{kd} & i_{fq} & i_{kq}\n\\end{bmatrix}^T\n$$\n\nå› ç›´è½´é˜»å°¼ç»•ç»„ã€äº¤è½´é˜»å°¼ç»•ç»„å’Œäº¤è½´ç¨³å®šç»•ç»„å‡çŸ­æ¥ï¼Œæœ‰$u_{kd}=u_{kq}=u_{fq}=0$ã€‚\n\nç›¸åº”çš„ç£é“¾æ–¹ç¨‹å’Œç”µå‹æ–¹ç¨‹ä¸º\n$$\n\\Psi_{abc}=L_{abci}i_{abc} \\\\ \nu_{abc}=p\\Psi_{abc}-R_{abc}i_{abc}\n$$\nå¼ä¸­\n$$\nL_{abc}=\n\\begin{bmatrix}\nL_{11} & L_{12} & L_{13} & L_{14} & L_{1r} \\\\\nL_{21} & L_{22} & L_{23} & L_{24} & L_{2r} \\\\\nL_{31} & L_{32} & L_{33} & L_{34} & L_{3r} \\\\\nL_{41} & L_{42} & L_{43} & L_{44} & L_{4r} \\\\\n-L_{1r}^T & -L_{2r}^T & -L_{3r}^T & -L_{4r}^T & L_{rr} \\\\\n\\end{bmatrix}\n$$\nå¼ä¸­$L_{ij},i=1,2,3,4;i=1,2,3,4$ä¸ºåˆ†å—çŸ©é˜µï¼Œå…·ä½“ä¸º\n$$\nL_{ij}=\n\\begin{bmatrix}\n-L_{aiaj} & -L_{aibj} & -L_{aicj} \\\\\n-L_{biaj} & -L_{bibj} & -L_{bicj} \\\\\n-L_{ciaj} & -L_{cibj} & -L_{cicj} \\\\\n\\end{bmatrix}\n$$\nçŸ©é˜µä¸­$-L_{aiaj}$è¡¨ç¤º$ai$ç›¸ç”µæ¢ç»•ç»„ä¸$aj$ç›¸ç”µæ¢ç»•ç»„ä¹‹é—´çš„äº’æ„Ÿ/è‡ªæ„Ÿã€‚å› æ­£æ–¹å‘ä¸­è§„å®šæ­£æ–¹å‘çš„å®šå­ç”µæµäº§ç”Ÿè´Ÿçš„ç£é“¾ï¼Œæ‰€ä»¥æ‰€æœ‰ç”µæ„Ÿå‡å¸¦è´Ÿå·ã€‚\n\nåŒç†ï¼Œå¼ä¸­$L_{ir},i=1,2,3,4$ä¹Ÿä¸ºåˆ†å—çŸ©é˜µï¼Œå…·ä½“ä¸º\n$$\nL_{ir}=\n\\begin{bmatrix}\nL_{aifd} & L_{aikd} & L_{aifq} & L_{aikq} \\\\\nL_{bifd} & L_{bikd} & L_{bifq} & L_{bikq} \\\\\nL_{cifd} & L_{cikd} & L_{cifq} & L_{cikq} \\\\\n\\end{bmatrix}\n$$\nçŸ©é˜µä¸­$L_{aifd}$è¡¨ç¤ºç”µæ¢$ai$ç›¸ç»•ç»„ä¸è½¬å­åŠ±ç£ç»•ç»„çš„äº’æ„Ÿï¼Œå…¶ä½™åŒç†ã€‚å› æ­£æ–¹å‘ä¸­è§„å®šæ­£æ–¹å‘çš„è½¬å­ç”µæµäº§ç”Ÿæ­£çš„ç£é“¾ï¼Œæ‰€ä»¥æ‰€æœ‰ç”µæ„Ÿå‡ä¸ºæ­£ã€‚\n\nåŒç†ï¼Œå¼ä¸­$L_{rr}$è¡¨ç¤ºè½¬å­å„ç»•ç»„ä¹‹é—´çš„è‡ªæ„Ÿ/äº’æ„Ÿï¼Œå…·ä½“ä¸º\n$$\nL_{rr}=\n\\begin{bmatrix}\nL_{fd} & L_{fdkd} & 0 & 0 \\\\\nL_{fdkd} & L_{kd} & 0 & 0 \\\\\n0 & 0 & L_{fq} & L_{fqkq} \\\\\n0 & 0 & L_{fqkq} & L_{kq} \\\\\n\\end{bmatrix}\n$$\nçŸ©é˜µä¸­$L_{fd}$ä¸ºåŠ±ç£ç»•ç»„çš„è‡ªæ„Ÿï¼Œ$L_{fdkd}$ä¸ºåŠ±ç£ç»•ç»„ä¸ç›´è½´é˜»å°¼ç»•ç»„çš„äº’æ„Ÿï¼Œå…¶ä½™åŒç†ã€‚å› ä¸ºåŠ±ç£ç»•ç»„ä¸äº¤è½´é˜»å°¼ç»•ç»„ã€åŠ±ç£ç»•ç»„ä¸äº¤è½´ç¨³å®šç»•ç»„ã€ç›´è½´é˜»å°¼ç»•ç»„ä¸äº¤è½´é˜»å°¼ç»•ç»„ã€ç›´è½´é˜»å°¼ç»•ç»„ä¸äº¤è½´ç¨³å®šç»•ç»„çš„ç”µè§’åº¦å¤¹è§’å‡ä¸º90$\\degree$ï¼Œæ‰€ä»¥æœ‰$L_{fdkq}=L_{fdfq}=L_{kdkq}=L_{kdfq}=0$ã€‚\n\nç”µæ„ŸçŸ©é˜µä¸­å„é‡çš„è¯¦ç»†è¡¨è¾¾å¼ç•¥ã€‚\n\n## dq0åæ ‡ç³»ä¸‹çš„åŸºæœ¬æ–¹ç¨‹\n### å˜æ¢çŸ©é˜µ\nåº”ç”¨æ¨å¹¿çš„ä¸‰ç›¸ç”µæœºParkå˜æ¢ï¼Œå–å˜æ¢çŸ©é˜µä¸º\n$$\nC^{abc}_{dq0}(\\theta)=\n\\begin{bmatrix}\nC_{11} & & & & \\\\\n& C_{22} & & & \\\\\n& & C_{33} & & \\\\\n& & & C_{44} & \\\\\n& & & & I \\\\\n\\end{bmatrix}\n$$\nå¼ä¸­$I$ä¸º$4\\times 4$çš„å•ä½çŸ©é˜µï¼Œå…¶å¯¹åº”çš„å˜æ¢å¯¹è±¡ä¸ºè½¬å­éƒ¨åˆ†å‚æ•°ï¼Œæ˜¾ç„¶è¯¥éƒ¨åˆ†æ— éœ€è¿›è¡ŒParkå˜æ¢ã€‚\n\nå¼ä¸­ï¼Œ\n$$\nC_{ii}=\n\\frac{2}{3}\n\\begin{bmatrix}\n\\cos[\\theta-(i-1)15\\degree] & \\cos[\\theta-120\\degree-(i-1)15\\degree] & \\cos[\\theta+120\\degree-(i-1)15\\degree] \\\\\n-\\sin[\\theta-(i-1)15\\degree] & -\\sin[\\theta-120\\degree-(i-1)15\\degree] & -\\sin[\\theta+120\\degree-(i-1)15\\degree] \\\\\n\\frac{1}{2} & \\frac{1}{2} & \\frac{1}{2}\\\\\n\\end{bmatrix}\n$$\n\n### ç”µå‹æ–¹ç¨‹\nå±•å¼€dq0åæ ‡ç³»ä¸‹çš„**æœ‰åå€¼**ç”µå‹æ–¹ç¨‹å¼å¾—\n$$\n\\begin{bmatrix}\nu_{d1} \\\\\nu_{q1} \\\\\nu_{01} \\\\\nu_{d2} \\\\\nu_{q2} \\\\\nu_{02} \\\\\nu_{d3} \\\\\nu_{q3} \\\\\nu_{03} \\\\\nu_{d4} \\\\\nu_{q4} \\\\\nu_{04} \\\\\nu_{fd} \\\\\nu_{kd} \\\\\nu_{fq} \\\\\nu_{kq} \\\\\n\\end{bmatrix}\n=\np\n\\begin{bmatrix}\n\\Psi_{d1} \\\\\n\\Psi_{q1} \\\\\n\\Psi_{01} \\\\\n\\Psi_{d2} \\\\\n\\Psi_{q2} \\\\\n\\Psi_{02} \\\\\n\\Psi_{d3} \\\\\n\\Psi_{q3} \\\\\n\\Psi_{03} \\\\\n\\Psi_{d4} \\\\\n\\Psi_{q4} \\\\\n\\Psi_{04} \\\\\n\\Psi_{fd} \\\\\n\\Psi_{kd} \\\\\n\\Psi_{fq} \\\\\n\\Psi_{kq} \\\\\n\\end{bmatrix}\n+\n\\begin{bmatrix}\n-\\omega \\Psi_{q1} \\\\\n\\omega \\Psi_{d1} \\\\\n0 \\\\\n-\\omega \\Psi_{q2} \\\\\n\\omega \\Psi_{d2} \\\\\n0 \\\\\n-\\omega \\Psi_{q3} \\\\\n\\omega \\Psi_{d3} \\\\\n0 \\\\\n-\\omega \\Psi_{q4} \\\\\n\\omega \\Psi_{d4} \\\\\n0 \\\\\n0 \\\\\n0 \\\\\n0 \\\\\n0 \\\\\n\\end{bmatrix}\n+\n\\begin{bmatrix}\n- r_s i_{d1} \\\\\n-r_s i_{q1} \\\\\n-r_s i_{01} \\\\\n- r_s i_{d2} \\\\\n-r_s i_{q2} \\\\\n-r_s i_{02} \\\\\n- r_s i_{d3} \\\\\n-r_s i_{q3} \\\\\n-r_s i_{03} \\\\\n- r_s i_{d4} \\\\\n-r_s i_{q4} \\\\\n-r_s i_{04} \\\\\nr_{fd} i_{fd}\\\\\nr_{fq} i_{fq}\\\\\nr_{kd} i_{kd}\\\\\nr_{kq} i_{kq} \\\\\n\\end{bmatrix}\n$$\n\nè€ƒè™‘åŸºå€¼é€‰å–ä¸­æœ‰$\\omega_B$çš„å­˜åœ¨ï¼Œå°†ç”µå‹æ–¹ç¨‹å®šå­ä¾§çš„ç¬¬ä¸€ä¸ªçŸ©é˜µï¼ˆç£é“¾é˜µï¼‰é™¤ä»¥ä¹‹ï¼Œå¯å¾—$x_{ad}$åŸºå€¼ç³»ç»Ÿä¸‹çš„**æ ‡å¹ºå€¼**å®šå­ç”µå‹æ–¹ç¨‹ï¼š\n$$\n\n$$\n","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"æœºå™¨å­¦ä¹ åŸºç¡€","url":"/2024/09/09/æœºå™¨å­¦ä¹ åŸºç¡€/","content":"Machine Learning can be divided to :\n    - supervised learning\n    - unsupervised learning\n\n## Supervised learning\nNeeds data set with labels \n\nTO: predict unknown future output\n\n - **Classfication Problem (discrete)**: to predict a discrete output (say yes or no), e.g Cancer benign or malignant diagnosis\n\n - **Regression Problem (Continous)**: to predict a specific number, e.g Stock Price Prediction\n\n During a linear regression problem we have to solve a minimization problem, to minimize the difference between $x$ and $h(y)$.\n\n\n### Regression Problem\n\nTraining set + learning algorithm -> generate hypothesis function $h$\n\n$h$ takes input $x$ (e.g. size of house) and output $y$ (e.g. estimated selling price)\n\nCost Function: \n\n$$\nJ(\\theta_{0},\\theta_{1})=\\frac{1}{2m} \\Sigma (h_{\\theta}(x)-y)^2\n$$\n\nSigma from 1 to m (m equal to sample size)\n\n### Gradient Descent\nrepeat until convergence:\n$$\n\\theta_j  := \\theta_j -\\alpha\\frac{\\partial}{\\partial \\theta_j}J(\\theta_0 , \\theta_1)\n$$\n(for $j$ = 0 and $j$ = 1)\n:= means denote assignment\n$\\alpha$:learning rate, basically controls how big is a step when descent\n$\\theta_0$ and $\\theta_1$ have to be updated simultaneously\n\n### Linear Regression Algorithm\nTO: Apply gradient descent algorithm to minimize squared error cost function\n\n\"Batch\" gradient descent: each step of gradient descend uses all training examples\n\n### Multiple features (variables)\nHypothesis:$h_\\theta (x) = \\theta_T x = \\theta_0 x_0 + \\theta_1 x_1 ... + \\theta_n x_n$\nParameters:$\\theta_0,\\theta_1,...,\\theta_n$\nCost function:\n$$\nJ(\\theta_0,\\theta_1,...,\\theta_n) = \\frac{1}{2m}\\Sigma (h_\\theta(x^{(i)})-y^{(i)})^2\n$$\nSigma from i=1 to m\n\nGradient descent:\nrepeat fellow:\n$$\n\\theta_j  := \\theta_j -\\alpha\\frac{\\partial}{\\partial \\theta_j}J(\\theta_0 , \\theta_1)\n$$\n(simutaneously update for every $j$)\n\nAs a result new algorithm will be like fellow:\n\n$$\n\\theta_j := \\theta_j - \\alpha \\frac{1}{m} \\Sigma (h_\\theta(x^{(i)})-y^{(i)})^2 x_j^{(i)}\n$$\n(simultaneously update $\\theta_j$ for $j=0,1ï¼Œ...,n$)\nE.g from a data set with three features it may like follows:\n\n$$\n\\theta_0 := \\theta_0 - \\alpha \\frac{1}{m} \\Sigma (h_\\theta(x^{(i)})-y^{(i)})^2 x_0^{(i)}$$\n$$\n\\theta_1 := \\theta_1 - \\alpha \\frac{1}{m} \\Sigma (h_\\theta(x^{(i)})-y^{(i)})^2 x_1^{(i)}$$\n$$\n\\theta_2 := \\theta_2 - \\alpha \\frac{1}{m} \\Sigma (h_\\theta(x^{(i)})-y^{(i)})^2 x_2^{(i)}\n$$\n\n### Feature Scaling & Mean normalization\nIdea:make sure features are on a similiar scale.\n\nE.g. $x_1$ = size (0-2000 feet^2) while $x_2$ = number of bedrooms (1-5)\n\n\n### Learning rate\n- if $\\alpha$ is too small: slow convergence\n- if $\\alpha$ is too large: $J(\\theta)$ may not decrease on every iteration; may not converge\n\n\nMake sure gradient descent is working correctly.Final goal is converge the cost function.\n\n### Features and Polynomial Regression\nE.g. Housing prices prediction\n$$\nh_\\theta (x) = \\theta_0 + \\theta_1 \\times frontage + \\theta_2 \\times depth\n$$\nClearly frontage is the first feature $x_1$ and depth is the second feature $x_2$\n\nTo decide which feature is the most important factor to the housing price, thereafter a polynomial regression can be taken:\n$$\nh_\\theta (x) = \\theta_0 + \\theta_1 \\times frontage + \\theta_2 \\times depth^2\n$$\nthis formula can be written as:\n$$\nh_\\theta (x) = \\theta_0 + \\theta_1 \\times x_1 + \\theta_2 \\times x_2^2\n$$\nIn this case, feature scaling is becoming increasingly important to get them comparable.\n\n### Classification Problem (Discrete)\n\n#### Sigmoid Function\nWant outputs 0 or 1\n\n**Sigmoid Function(Logistic Function)**:\n$$\ng(z)= \\frac{1}{1+e^{-z}}\n$$ \n\n![](/images/ML/Sfunc.png)\n\nwhile $z$ can be written as vector($\\vec{w}$ is weights and $x$ is feature): \n$$\nz = \\vec{w}x + b\n$$\n\n#### Decision Boundary\n$$\nf_{\\vec{w},b}(x) = g(\\vec{w}x+b) = \\frac{1}{1+e^{-(\\vec{w}x+b)}}=P(y=1|x;\\vec{w},b)\n$$\n\nClearly the decision boundary is the threshold value of $f_{\\vec{w},b}(x)$.\n\n$x$ is also can be replaced by $\\vec{x}$ if there are multiple features.\n\nClearly the descision boundary is \n$$\n\\vec{w}x+b=0\n$$\n\n\n#### Cost Funciton\n\n![](/images/ML/logcost.png)\n\nSince MSE under logistic regression is a non-convex function, using MSE as cost function index may get \"stuck\" at the inflection point of the function, causing error.\n\nTarget:create or select a new cost function to make it convex.\n\nThe loss function of logistic regression uses the log-likelihood loss function, also known as the cross-entropy loss function, which is used to measure the difference between the model prediction and the true label. The loss function is defined as:\n\n$$\nL(\\theta) = - \\frac{1}{m} \\sum_{i=1}^{m} \\left[ y^{(i)} \\log h_{\\theta}(x^{(i)}) + (1 - y^{(i)}) \\log (1 - h_{\\theta}(x^{(i)})) \\right]\n$$\nwhile \n- $m$:sample amounts\n- $y^{(i)}$: true label (0 or 1) of sample $i$\n- $h_{\\theta}(x^{(i)})$: The model predicts the probability of sample $i$, i.e. $P(y=1|x^{(i)})$\n\nThe goal of this loss function is to minimize the gap between the predicted and actual labels.\n\n#### Training Logistic regression\nUse gradient descent to minimize the cost function $J(\\vec{w},b)$.\n\nwe have \n$$\n\\frac{\\partial}{\\partial w_j} J(\\vec{w},b) = \\frac{1}{m} \\sum_{i=1}^{m} \\left[ f_{\\vec{w},b}(\\vec{x}^{(i)}-y^{(i)})\\right]x_j^{(i)} \n$$\nand\n$$\n\\frac{\\partial}{\\partial b} J(\\vec{w},b) = \\frac{1}{m} \\sum_{i=1}^{m} \\left[ f_{\\vec{w},b}(\\vec{x}^{(i)}-y^{(i)})\\right]\n$$\nwhat we need to do is update them simultaneously.\n\n\n## Unsupervised learning\nNeeds data set without labels\n\nTO: Automatically discover the internal patterns or structures of data, such as dividing data into different clusters, revealing the inherent laws of data, or simplifying data representation.\n\n**Example** : Extracting vocals from audio\n\n## å†³ç­–æ ‘(Decision Tree)\nE.g.ï¼šåˆ¤æ–­åŠ¨ç‰©æ˜¯å¦ä¸ºçŒ«\n![](/images/ML/DT.png)\nå†³ç­–æ ‘è®­ç»ƒæ­¥éª¤\n- ç¡®è®¤ç¬¬ä¸€ä¸ªå†³ç­–èŠ‚ç‚¹(Node)åå¯¹æ ·æœ¬è¿›è¡Œåˆ†ç±» ä¾‹å¦‚ï¼šå¾…æ£€æµ‹åŠ¨ç‰©çš„è€³æœµæ˜¯åœ†çš„è¿˜æ˜¯å°–çš„\n- ç¡®è®¤å‰©ä¸‹çš„èŠ‚ç‚¹\n\néœ€è¦è§£å†³çš„é—®é¢˜\n- å¦‚ä½•ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹æ‰€ç”¨æ¥è¿›è¡Œåˆ†ç±»çš„ç‰¹å¾(Feature)ï¼Ÿå¦‚ï¼šæ˜¯æ ¹æ®è€³æœµç±»å‹è¿›è¡Œåˆ†ç±»è¿˜æ˜¯æ ¹æ®ä½“å‹è¿›è¡Œåˆ†ç±»\n- ä»€ä¹ˆæ—¶å€™åœæ­¢ç»§ç»­åˆ†ç±»ï¼ˆsplitï¼‰ï¼Ÿ\n  + æŸèŠ‚ç‚¹èƒ½å¤Ÿåšåˆ°100%çš„åˆ†ç±»æ—¶ï¼ˆå¦‚æœ‰çŒ«DNAçš„åŠ¨ç‰©ä¸€å®šæ˜¯çŒ«ï¼Œä¸å¯èƒ½æ˜¯å…¶ä»–ï¼‰\n  + æŸèŠ‚ç‚¹ä¹‹åå†³ç­–æ ‘æº¢å‡º\n- ç»§ç»­è¿›è¡Œå†³ç­–æ‰€å¸¦æ¥çš„æå‡ä½äºé˜ˆå€¼\n- èŠ‚ç‚¹ä¸­çš„æ ·æœ¬æ•°é‡è¿‡å°‘","categories":["æ·±åº¦å­¦ä¹ "]},{"title":"ä»¥TPS5430ä¸ºä¾‹è¿›è¡ŒDC-DCé€‰å‹ä¸è®¾è®¡","url":"/2024/08/19/ä»¥TPS5430ä¸ºä¾‹è¿›è¡ŒDC-DCé€‰å‹ä¸è®¾è®¡/","content":"*åŸæ–‡æ¥è‡ªå¾·å·ä»ªå™¨ï¼ˆTIï¼‰*ï¼š[TPS5430 Datasheet](https://www.ti.com.cn/product/cn/TPS5430?bm-verify=AAQAAAAJ_____9dYxHNK53iaDtVqyxPQxRcsrzMOM-c86S6ivd470tCxI7v2y_3iLaQxnR81kWkBePuyKvYKyC-Kf15mbkeVGi8nAGHJ0TZ3ENp-6GgUlTcvMy_qdx-euoFt1ZFv6JxkzW-Dd3OlaLFZQaxAsFpiD3EHrvgSZyrsjhPFZukuNU6g3lsGi53NSBPq24SEFjJVkxhff7hPbsSkYNRWKgMWat5cOPLkdhhwYkWjjWZCYxQ19lVbHzjbGrfD90mIptd-Xo2P9gBYm2ZBpeDhZ5g5dlGNhcbA7Z9fEjLipdCzrhXmW1HXWL3ZbWTD)\n\n\næœ¬æ–‡å°†ä»¥å¾·å·ä»ªå™¨ï¼ˆTIï¼‰TPS5430 é™å‹DC-DCè½¬æ¢å™¨ä¸ºä¾‹ï¼Œå‰–ææ‰‹å†Œä¸­çš„å‚æ•°ä¸æŠ€æœ¯æŒ‡æ ‡ï¼Œå¹¶è¿›è¡Œé€‰å‹æ–¹é¢çš„ä»‹ç»ï¼ŒåŒæ—¶ç®€è¦ä»‹ç»é«˜é¢‘DC-DCè®¾è®¡ç›¸å…³å†…å®¹ã€‚\n\n## ç‰¹æ€§\n- å®½è¾“å…¥ç”µå‹èŒƒå›´ï¼š\n  + TPS5430ï¼š5.5V è‡³ 36V\n  + TPS5431ï¼š5.5V è‡³ 23V\n\n- é«˜è¾¾ 3A çš„è¿ç»­ï¼ˆ4A å³°å€¼ï¼‰è¾“å‡ºç”µæµ\n- é€šè¿‡ 100mÎ© é›†æˆå¼ MOSFET å¼€å…³å®ç°é«˜è¾¾ 95%çš„é«˜æ•ˆç‡\n- å®½è¾“å‡ºç”µå‹èŒƒå›´ï¼šå¯è°ƒèŠ‚ä¸ºä½è‡³ 1.22Vï¼Œåˆå§‹ç²¾åº¦ä¸º 1.5%\n- å†…éƒ¨è¡¥å¿å¯æœ€å¤§é™åº¦å‡å°‘å¤–éƒ¨å™¨ä»¶æ•°é‡\n- é€‚ç”¨äºå°å‹æ»¤æ³¢å™¨å°ºå¯¸çš„å›ºå®š 500kHz å¼€å…³é¢‘ç‡\n- é€šè¿‡è¾“å…¥ç”µå‹å‰é¦ˆæ”¹è¿›çº¿è·¯è°ƒæ•´å’Œç¬æ€å“åº”\n- ç³»ç»Ÿå—è¿‡æµé™åˆ¶ã€è¿‡å‹ä¿æŠ¤å’Œçƒ­å…³æ–­çš„ä¿æŠ¤\n- â€“40Â°C è‡³ 125Â°C çš„å·¥ä½œç»“æ¸©èŒƒå›´\n- é‡‡ç”¨å°å‹çƒ­å¢å¼ºå‹ 8 å¼•è„š SO PowerPADâ„¢ é›†æˆç”µè·¯å°è£…\n- ä½¿ç”¨ TPS5430 å¹¶å€ŸåŠ© WEBENCHÂ® Power Designer åˆ›å»ºå®šåˆ¶è®¾è®¡\n\n## åº”ç”¨\n- æ¶ˆè´¹ç±»ï¼šæœºé¡¶ç›’ã€DVD æ˜¾ç¤ºå±ã€LCD æ˜¾ç¤ºå±\n- å·¥ä¸šç”¨å’Œè½¦è½½éŸ³é¢‘ç”µæº\n- ç”µæ± å……ç”µå™¨ã€å¤§åŠŸç‡ LED ç”µæº\n- 12V å’Œ 24V åˆ†å¸ƒå¼ç”µæºç³»ç»Ÿ\n\n## è¯´æ˜\nTPS543x æ˜¯ä¸€æ¬¾é«˜è¾“å‡ºç”µæµ PWM è½¬æ¢å™¨ï¼Œé›†æˆäº†ä½ç”µé˜»ã€é«˜ä¾§ N æ²Ÿé“ MOSFETã€‚å…·æœ‰æ‰€åˆ—çš„ç‰¹æ€§çš„åŸºæ¿ä¸Šè¿˜åŒ…æ‹¬é«˜æ€§èƒ½ç”µå‹è¯¯å·®æ”¾å¤§å™¨ï¼ˆå¯åœ¨ç¬æ€æ¡ä»¶ä¸‹æä¾›é«˜ç¨³å‹ç²¾åº¦ï¼‰ã€æ¬ å‹é”å®šç”µè·¯ï¼ˆç”¨äºé˜²æ­¢åœ¨è¾“å…¥ç”µå‹è¾¾åˆ° 5.5V å‰å¯åŠ¨ï¼‰ã€å†…éƒ¨è®¾ç½®çš„æ…¢å¯åŠ¨ç”µè·¯ï¼ˆç”¨äºé™åˆ¶æµªæ¶Œç”µæµï¼‰ä»¥åŠç”µå‹å‰é¦ˆç”µè·¯ï¼ˆç”¨äºæ”¹è¿›ç¬æ€å“åº”ï¼‰ã€‚é€šè¿‡ä½¿ç”¨ ENA å¼•è„šï¼Œå…³æ–­ç”µæºç”µæµé€šå¸¸å¯å‡å°‘åˆ°15Î¼Aã€‚å…¶ä»–ç‰¹æ€§åŒ…æ‹¬é«˜ç”µå¹³æœ‰æ•ˆä½¿èƒ½ç«¯ã€è¿‡æµé™åˆ¶ã€è¿‡å‹ä¿æŠ¤å’Œçƒ­å…³æ–­ã€‚ä¸ºé™ä½è®¾è®¡å¤æ‚æ€§å¹¶å‡å°‘å¤–éƒ¨å…ƒä»¶æ•°é‡ï¼Œå¯¹ TPS543x åé¦ˆç¯è·¯è¿›è¡Œå†…éƒ¨è¡¥å¿ã€‚TPS5431å¯é‡‡ç”¨é«˜è¾¾ 23V çš„ç”µæºè½¨è¿è¡Œã€‚TPS5430 å¯è°ƒèŠ‚å¤šç§ç”µæºï¼ŒåŒ…æ‹¬ 24V æ€»çº¿ã€‚\n\nTPS543x å™¨ä»¶é‡‡ç”¨çƒ­å¢å¼ºå‹ä¸”æ˜“äºä½¿ç”¨çš„ 8 å¼•è„š SOIC PowerPAD é›†æˆç”µè·¯å°è£…ã€‚TI æä¾›è¯„ä¼°æ¨¡å—å’ŒDesigner è½¯ä»¶å·¥å…·ï¼ŒååŠ©å¿«é€Ÿå®ç°é«˜æ€§èƒ½ç”µæºè®¾è®¡ï¼Œæ»¡è¶³è¿«åˆ‡çš„è®¾å¤‡å¼€å‘å‘¨æœŸè¦æ±‚ã€‚\n\n![ç®€åŒ–åŸç†å›¾ä¸æ•ˆç‡-è¾“å‡ºç”µæµå…³ç³»](/images/dcdc/1.png)\n\n> æœ‰å…³*æ•ˆç‡*ï¼šDC-DCè½¬æ¢å™¨çš„æ•ˆç‡ï¼ˆEfficiencyï¼‰è¡¨ç¤ºè¾“å…¥åŠŸç‡ä¸­æœ‰å¤šå°‘è¢«æˆåŠŸè½¬æ¢ä¸ºè¾“å‡ºåŠŸç‡ï¼Œè€Œéè¢«æŸè€—ã€‚å®ƒé€šå¸¸ä»¥ç™¾åˆ†æ¯”è¡¨ç¤ºã€‚æ•ˆç‡é«˜æ„å‘³ç€å¤§éƒ¨åˆ†èƒ½é‡éƒ½è¢«æœ‰æ•ˆè½¬æ¢ï¼Œåªæœ‰å°‘é‡èƒ½é‡å› å¼€å…³æŸè€—ã€å¯¼é€šæŸè€—ã€ç£æŸè€—ç­‰å½¢å¼è€Œè¢«æ¶ˆè€—ä¸ºçƒ­é‡ã€‚DC-DC è½¬æ¢å™¨çš„æ•ˆç‡é€šå¸¸ä¼šéšç€è¾“å…¥ç”µå‹ã€è¾“å‡ºç”µæµã€è´Ÿè½½æ¡ä»¶ç­‰å˜åŒ–è€Œæœ‰æ‰€ä¸åŒã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒDC-DC è½¬æ¢å™¨çš„æ•ˆç‡å¯ä»¥è¾¾åˆ° 85% è‡³ 95% ç”šè‡³æ›´é«˜ã€‚è¾ƒé«˜çš„æ•ˆç‡åœ¨ç”µæºè®¾è®¡ä¸­è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒç›´æ¥å½±å“ç³»ç»Ÿçš„åŠŸè€—å’Œçƒ­ç®¡ç†è®¾è®¡ã€‚\n\n## å¼•è„šé…ç½®å’ŒåŠŸèƒ½\n\n![å¼•è„šé…ç½®å’ŒåŠŸèƒ½](/images/dcdc/2.png)\n\n> *åº”å½“æ³¨æ„*ï¼š\n> - **VSENSE**ï¼šåé¦ˆå›è·¯å¯¹å™ªå£°æ•æ„Ÿï¼Œåº”å½“åœ¨PCBè®¾è®¡æ—¶è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚\n> - **ENA**ï¼šä¸å…¶ä»–å‹å·çš„ICä¸åŒï¼ŒTPS5430çš„ä½¿èƒ½åœ¨æ‚¬ç©ºï¼ˆFloatï¼‰æ—¶å¼€å¯ï¼Œä½äº0.5Vå³å¤–éƒ¨æ‹‰ä½æ—¶å…³é—­ã€‚ä¸è¿‡ç»éªŒè¡¨æ˜ENAè¢«å¤–éƒ¨ä¸Šæ‹‰æ—¶ä¹Ÿèƒ½å¤Ÿå¼€å¯ä½¿èƒ½ã€‚\n> - **PH**ï¼šå³è¾“å‡ºç«¯ã€‚ICå†…éƒ¨é›†æˆæœ‰N-MOSFETï¼Œå…¶æºæï¼ˆSï¼‰å³è¿æ¥è‡³PHå¼•è„šã€‚\n\n## è§„æ ¼\n### ç»å¯¹æœ€å¤§é¢å®šå€¼\n![ç»å¯¹æœ€å¤§é¢å®šå€¼](/images/dcdc/3.png)\n\n> *åº”å½“æ³¨æ„*ï¼š\n> - æ‰€æœ‰è¾“å…¥å¼•è„šç¦æ­¢åæ¥ï¼Œå³ä½¿è®¾è®¡æœ‰å¤–éƒ¨åæ¥ä¿æŠ¤ç”µè·¯ã€‚\n> - ENAå¼•è„šä¸Šæ‹‰åè¾“å…¥ä¸å¾—è¶…è¿‡7Vã€‚\n> - æ¥è¿‘ VIN å¼•è„šçš„ç»å¯¹æœ€å¤§é¢å®šå€¼å¯èƒ½ä¼šå¯¼è‡´ PH å¼•è„šä¸Šçš„ç”µå‹è¶…è¿‡ç»å¯¹æœ€å¤§é¢å®šå€¼ã€‚\n> - ICè¾“å‡ºç«¯å¯èƒ½ä¼šåœ¨ç¬æ€å‡ºç°è´Ÿç”µå‹è„‰å†²ï¼Œå…¶ä¸€èˆ¬ç”±é«˜di/dtä¸å¯„ç”Ÿç”µæ„Ÿå…±åŒä½œç”¨å¼•èµ·ã€‚å‚è§ï¼š[å¦‚ä½•è§£å†³è´Ÿå‹è„‰å†²](https://www.novosns.com/technical-articles-163)\n> - è¡¨ä¸­çš„â€œæ‹‰ç”µæµâ€åŸæ–‡ä¸ºâ€œSource Currentâ€ï¼Œé€šå¸¸æŒ‡çš„æ˜¯FETå‘è´Ÿè½½æä¾›ç”µæµçš„èƒ½åŠ›ã€‚åœ¨å¼€å…³æ¨¡å¼ä¸­ï¼ŒFETåœ¨å¯¼é€šæ—¶ä»ç”µæºâ€œæ‹‰â€ç”µæµå¹¶ä¼ è¾“åˆ°è´Ÿè½½ã€‚å½“MOSFETå¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒPH å¼•è„šä¼šå‘ˆç°é«˜é˜»æŠ—çŠ¶æ€ã€‚è¡¨ä¸­ PH æ¼ç”µæµæŒ‡çš„æ˜¯åœ¨è¿™ç§é«˜é˜»æŠ—çŠ¶æ€ä¸‹ï¼ŒPH å¼•è„šä»ç„¶æœ‰å°‘é‡çš„ç”µæµä»å¼•è„šæµå‡ºæˆ–æµå…¥ï¼ˆä¸€èˆ¬æ˜¯æµå‡ºï¼‰ã€‚æ‰‹å†Œä¸­æ ‡æ³¨çš„ 10 $\\mu A$ æ¼ç”µæµï¼Œè¡¨ç¤ºåœ¨å¼€å…³ç®¡å…³é—­æ—¶ï¼ŒPH å¼•è„šç”±äºæ¼ç”µæ•ˆåº”äº§ç”Ÿçš„å¾®å°ç”µæµã€‚è¿™ç§ç”µæµé€šå¸¸å¾ˆå°ï¼Œä¸ä¼šå¯¹ç³»ç»Ÿæ€§èƒ½é€ æˆæ˜¾è‘—å½±å“ï¼Œä½†åœ¨æŸäº›å¯¹ç²¾åº¦è¦æ±‚è¾ƒé«˜çš„åº”ç”¨ä¸­ï¼Œè¿™äº›å°ç”µæµå¯èƒ½éœ€è¦è€ƒè™‘ã€‚\n\n### ESD Ratings\né™ç”µæ”¾ç”µæµ‹è¯•é¡¹ï¼Œæ­¤å¤„ç•¥ã€‚\n\n\n","categories":["ç”µå­ä¸ç”µè·¯è®¾è®¡"]},{"title":"ç”µæœºé©±åŠ¨ç±»PCBå¸ƒå±€çš„æœ€ä½³å®è·µ","url":"/2024/08/14/ç”µæœºé©±åŠ¨ç±»PCBå¸ƒå±€çš„æœ€ä½³å®è·µ/","content":"*åŸæ–‡è½¬è‡ªå¾·å·ä»ªå™¨ï¼ˆTIï¼‰Application Note*\n# ç®€ä»‹\nç”µæœºé©±åŠ¨ç³»ç»Ÿçš„ PCB è®¾è®¡å¹¶éæ˜“äº‹ï¼Œéœ€è¦ç‰¹æ®Šçš„è€ƒè™‘å’ŒæŠ€æœ¯æ‰èƒ½å®ç°æœ€ä½³æ€§èƒ½ã€‚ç”µæºæ•ˆç‡ã€é«˜é€Ÿå¼€å…³é¢‘ç‡ã€ä½å™ªå£°æŠ–åŠ¨å’Œç´§å‡‘çš„ç”µè·¯æ¿è®¾è®¡æ˜¯è®¾è®¡äººå‘˜åœ¨å¸ƒå±€ç”µæœºé©±åŠ¨ç³»ç»Ÿæ—¶å¿…é¡»è€ƒè™‘çš„å‡ ä¸ªä¸»è¦å› ç´ ã€‚å¾·å·ä»ªå™¨çš„ DRV è®¾å¤‡éå¸¸é€‚åˆæ­¤ç±»ç³»ç»Ÿï¼Œå› ä¸ºå®ƒä»¬é«˜åº¦é›†æˆä¸”é…å¤‡äº†ä¿æŠ¤ç”µè·¯ã€‚æœ¬åº”ç”¨æŠ¥å‘Šçš„ç›®æ ‡æ˜¯å¼ºè°ƒä½¿ç”¨ DRV è®¾å¤‡æ—¶ç”µæœºé©±åŠ¨å¸ƒå±€çš„ä¸»è¦å› ç´ ï¼Œå¹¶ä¸ºé«˜æ€§èƒ½è§£å†³æ–¹æ¡ˆæä¾›æœ€ä½³å®è·µæŒ‡å—ï¼Œä»¥å‡å°‘çƒ­åº”åŠ›ã€ä¼˜åŒ–æ•ˆç‡å¹¶æœ€å¤§é™åº¦åœ°é™ä½ç”µæœºé©±åŠ¨åº”ç”¨ä¸­çš„å™ªéŸ³ã€‚\n\n# æ¥åœ°ä¼˜åŒ–\nä»»ä½•è‰¯å¥½çš„æ¥åœ°æ–¹æ¡ˆçš„ç›®æ ‡éƒ½æ˜¯ä¸º IC åŠå…¶å‘¨å›´ç”µè·¯æä¾›ç¨³å®šçš„å‚è€ƒï¼ˆReferenceï¼‰ï¼Œè€Œä¸å—å™ªå£°å’Œå…¶ä»–æŒ¯è¡çš„å½±å“ã€‚æœ¬èŠ‚ä»‹ç»ä¸åŒçš„æ¥åœ°æŠ€æœ¯ã€æ¥åœ°çš„å¸¸è§æŒ‘æˆ˜ã€ä½¿ç”¨æ¥åœ°å¹³é¢çš„æœ€ä½³æ–¹å¼ä»¥åŠåŒå±‚æ¿çš„æ¥åœ°æ³¨æ„äº‹é¡¹ã€‚\n## å¸¸ç”¨æœ¯è¯­/è¿æ¥æ–¹å¼\næœ¬èŠ‚ä¸­ä½¿ç”¨çš„æœ¯è¯­å®šä¹‰å¦‚ä¸‹ï¼š\n\n- **å•ç‚¹æ¥åœ°ï¼ˆSingle Pointï¼‰**ï¼šåœ¨å•ç‚¹åˆ†å¸ƒä¸­ï¼Œæ‰€æœ‰å‚è€ƒç‚¹éƒ½æºè‡ªåŒä¸€æºï¼Œä»è€Œç¡®ä¿æ¯ä¸ªè´Ÿè½½éƒ½æœ‰è‡ªå·±çš„ä¸é—´æ–­æ¥åœ°è·¯å¾„ï¼ˆè§å›¾ 1-1 å³ï¼‰ã€‚å»ºè®®å°†æ­¤è¿æ¥ç”¨äºç”µæºåˆ†å¸ƒçº¿ã€‚\n\n- **æ˜Ÿå½¢æ¥åœ°ï¼ˆStar Groundï¼‰**ï¼šåœ¨æ˜Ÿå½¢æ¥åœ°åˆ†å¸ƒä¸­ï¼Œæ‰€æœ‰å‚è€ƒç‚¹éƒ½ä½äºä¸­å¿ƒï¼›ä½†æ˜¯ï¼Œæºå¯èƒ½ä¸é›†ä¸­ã€‚æ­¤æ–¹æ³•å¹³è¡¡äº†æ‰€æœ‰èµ„æºä¹‹é—´çš„å…¬å…±é˜»æŠ—ï¼ˆå›¾ 1-1 å·¦ï¼‰ã€‚å»ºè®®å°†æ­¤è¿æ¥ç”¨äºä¿¡å·çº¿ã€‚\n\n![å›¾1-1 æ˜Ÿå½¢æ¥åœ°ä¸å•ç‚¹æ¥åœ°çš„åŠŸç‡åˆ†å¸ƒ](/images/siva/1-1.png)\n\n- **åˆ†åŒºï¼ˆPartitioningï¼‰**ï¼šåœ¨ä½¿ç”¨åˆ†åŒºæ¥åœ°æ–¹æ¡ˆçš„PCBä¸­ï¼Œæ•°å­—ã€æ¨¡æ‹Ÿå’Œé«˜åŠŸç‡ä¿¡å·æœ‰è‡ªå·±ç‹¬ç«‹çš„åŒºåŸŸï¼ˆè§å›¾ 1-2ï¼‰ã€‚è¿™ç§åˆ†ç¦»ä¸æ˜¯æ•°å­—å’Œæ¨¡æ‹Ÿæ¥åœ°çš„ç‰©ç†åˆ†åŒºã€‚\n\n- **ç½‘æ ¼åŒ–ï¼ˆGridï¼‰**ï¼šç½‘æ ¼åŒ–ä½¿æ•´ä¸ªç”µè·¯æ¿ä¸Šçš„æ¥åœ°è·¯å¾„è¿ç»­ï¼Œä»¥ç¡®ä¿æ¯ä¸ªä¿¡å·éƒ½æœ‰ä¸€æ¡è¿”å›æºçš„è·¯å¾„ï¼ˆè§å›¾ 1-3ï¼‰ã€‚è¿™ç§åšæ³•æ¶‰åŠå¯¹å…ƒä»¶æ”¾ç½®ã€æ¥åœ°å¡«å……ã€è¿‡å­”æ”¾ç½®å’Œèµ°çº¿è·¯å¾„è¿›è¡Œç»†å¾®æ›´æ”¹ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘è¿”å›åœ°é¢çš„è·¯å¾„ã€‚ç½‘æ ¼åŒ–æœ‰æ•ˆåœ°åˆ›å»ºäº†ä¸€ä¸ªæ›´åŠ äº’è¿çš„æ¥åœ°å¹³é¢ï¼Œå¯ä»¥é™ä½å™ªå£°å¹¶é™ä½ç”µæºå’Œè´Ÿè½½ä¹‹é—´çš„é˜»æŠ—ã€‚\n\n![å›¾1-2 æ•°å­—-æ¨¡æ‹Ÿåœ°åˆ†ç¦»ä¸åœ°å¹³é¢åˆ†åŒº](/images/siva/1-2.png)\n\nå›¾ 1-3 æ˜¾ç¤ºäº†ä½¿ç”¨æ¥åœ°ç½‘æ ¼å®ç°æœ‰æ•ˆæ¥åœ°å¹³é¢çš„ç¤ºä¾‹ã€‚åœ¨å¸ƒå±€ä¸­å®æ–½ç½‘æ ¼åŒ–æ‰€åšçš„æ›´æ”¹å¾ˆå°ï¼Œè¿™è¡¨æ˜å°çš„æ”¹åŠ¨å¯ä»¥äº§ç”Ÿå¤§å½±å“ã€‚\n\n![å›¾1-3 å°†åœ°é¢å¡«å……å’Œèµ°çº¿ç½‘æ ¼åŒ–ä»¥å½¢æˆæ¥åœ°å¹³é¢](/images/siva/1-3.png)\n\nåœ¨å›¾ 1-3 çš„ç¤ºä¾‹ä¸­ï¼Œå¸ƒå±€ A å’Œå¸ƒå±€ B æ˜¯é¡¶å±‚å’Œåº•å±‚ï¼Œåªç•™ä¸‹æ¥åœ°å¡«å……ã€æ¥åœ°èµ°çº¿å’Œå‰åå±‚ä¹‹é—´çš„è¿‡å­”ã€‚å›¾ 1-3 ä¸­çš„å¸ƒå±€ C æ˜¯ç”µè·¯æ¿æ¥åœ°å¸ƒçº¿çš„ç®€å•æ£’çŠ¶å›¾ã€‚æ¯æ ¹æ£’çŠ¶å›¾æˆ–è…¿ä»£è¡¨æ¥åœ°å¯¼ä½“çš„è·¯å¾„ã€‚å¤§å¤šæ•°èµ°çº¿ä»…åœ¨ä¸€ç«¯è¿æ¥ã€‚ç§»é™¤å¤§å¤šæ•°å•ç«¯èµ°çº¿åï¼Œå›¾ 1-3 ä¸­çš„å¸ƒå±€ D æ˜¾ç¤ºäº†æ•´ä¸ªç”µè·¯æ¿ä¸Šçš„æ¥åœ°å¸ƒçº¿æ–¹å¼ï¼›å¸ƒçº¿ä¸Šä»»æ„ä¸¤ç‚¹ä¹‹é—´åªæœ‰ä¸€æ¡è·¯å¾„ã€‚\n\nå›¾ 1-3 ä¸­çš„å¸ƒå±€ Eã€å¸ƒå±€ Fã€å¸ƒå±€ G å’Œå¸ƒå±€ H æ˜¾ç¤ºäº†ä¸ºå®ç°ç½‘æ ¼æ¥åœ°è€Œä¿®æ”¹çš„è®¾è®¡ã€‚åœ¨å›¾ 1-3 ä¸­çš„å¸ƒå±€ E å’Œå¸ƒå±€ F ä¸­æ·»åŠ äº†ä¸€äº›èµ°çº¿ï¼ˆä»¥å®å¿ƒé»‘è‰²æ˜¾ç¤ºï¼‰å¹¶ç§»åŠ¨äº†å‡ ä½•å›¾å½¢ï¼ˆç”±ç®­å¤´æŒ‡ç¤ºï¼‰ã€‚å›¾ 1-3 ä¸­çš„å¸ƒå±€ G æ˜¾ç¤ºäº†ä¿®æ”¹åçš„æ¥åœ°æ£’çŠ¶å›¾ã€‚ä¸¤ç«¯è¿æ¥çš„å®Œæ•´èµ°çº¿å½¢æˆæ›´å®Œæ•´çš„å¯¼ä½“ã€‚æ¯”è¾ƒå›¾ 1-3 ä¸­çš„å¸ƒå±€ H å’Œå¸ƒå±€ Dï¼Œç½‘æ ¼æ¥åœ°å·²åˆ›å»ºäº†å¹¿æ³›çš„äº’è¿ç½‘ç»œï¼Œä»è€Œåˆ›å»ºäº†æ‰€éœ€çš„ç½‘æ ¼ã€‚å…¶æ•ˆæœå‡ ä¹ä¸å®é™…æ¥åœ°å¹³é¢ä¸€æ ·æœ‰æ•ˆã€‚\n\n## ä½¿ç”¨åœ°å¹³é¢\nåœ¨ 4 å±‚æ¿æˆ–æ›´å¤§çš„ 2 å±‚æ¿è®¾è®¡ä¸­ï¼Œå»ºè®®ä½¿ç”¨æ¥åœ°å¹³é¢ã€‚å°† PCB çš„ä¸€å±‚ä½œä¸ºè¿ç»­æ¥åœ°å¹³é¢å¯ä½¿æ¯ä¸ªä¿¡å·å…·æœ‰æœ€çŸ­çš„è¿”å›è·¯å¾„ï¼Œå¹¶å‡å°‘è€¦åˆå’Œå¹²æ‰°ã€‚å»ºè®®é€šè¿‡ä»”ç»†å¸ƒçº¿ä¿¡å·çº¿æ¥å°½é‡å‡å°‘æ¥åœ°å¹³é¢çš„ä¸è¿ç»­æ€§ï¼Œå¹¶å°†è¿‡å­”å½¼æ­¤åˆ†å¼€ä»¥é˜²æ­¢å¹³é¢ä¸­æ–­ã€‚æœ‰å…³è¿‡å­”æ”¾ç½®çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ä¸‹æ–‡ã€‚\n\nå¤§å¤šæ•° DRV è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç”¨ä½œæ¥åœ°çš„å¯¼çƒ­ç„Šç›˜ï¼Œå¹¶ä½¿ç”¨æ¥åœ°é“œæ¥æ•£çƒ­ã€‚å›¾ 1-4 æ˜¾ç¤ºäº†å…¬å…±å’Œåˆ†ç¦»æ¥åœ°å¹³é¢çš„è‰¯å¥½å¸ƒå±€ç¤ºä¾‹ã€‚\n\n![å›¾1-4 å…¬å…±æ¥åœ°å¹³é¢ä¸åˆ†ç¦»æ¥åœ°å¹³é¢](/images/siva/1-4.png)\n\n*æ³¨æ„*ï¼šå¦‚æœè®¾è®¡æ˜¯ç©ºé—´å—é™çš„ 2 å±‚ç”µè·¯æ¿ï¼Œåˆ™æ¥åœ°å¹³é¢å¹¶ä¸æ€»æ˜¯å¯è¡Œçš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPCB å¸ƒå±€å˜å¾—æ›´åŠ é‡è¦ã€‚å¿…é¡»å°å¿ƒè°¨æ…ï¼Œç¡®ä¿é«˜ç”µæµè·¯å¾„è¿œç¦»æ•æ„Ÿä¿¡å·ã€‚PCB çš„å™ªå£°éƒ¨åˆ†ï¼ˆä¾‹å¦‚åŠŸç‡çº§ FETã€è‡ªä¸¾ç”µè·¯å’Œç”µè·æ³µï¼‰é€šå¸¸åŒ…å«é«˜å™ªå£°å’Œçº¹æ³¢ï¼Œåº”ä¸æ­¤ç±»ä¿¡å·éš”ç¦»ã€‚\n\n## å¸¸è§é—®é¢˜\n### ç”µå®¹å’Œç”µæ„Ÿè€¦åˆ\nå½“ä¸¤æ¡èµ°çº¿å¹³è¡Œå»¶ä¼¸æ—¶ï¼Œå³ä½¿è·ç¦»å¾ˆçŸ­ï¼Œä¹Ÿå¯èƒ½å‘ç”Ÿç”µå®¹æˆ–ç”µæ„Ÿè€¦åˆã€‚å½“ä¸€æ¡èµ°çº¿çš„ä¸Šå‡æ²¿å¯¼è‡´å¦ä¸€æ¡èµ°çº¿çš„ä¸Šå‡æ²¿æ—¶ï¼Œå°±ä¼šå‘ç”Ÿç”µå®¹è€¦åˆã€‚å½“ä¸€æ¡èµ°çº¿å…·æœ‰ä¸Šå‡æ²¿æˆ–ä¸‹é™æ²¿ï¼Œè€Œç¬¬äºŒæ¡èµ°çº¿å…·æœ‰è€¦åˆçš„ä¸‹é™æ²¿æˆ–ä¸Šå‡æ²¿æ—¶ï¼Œå°±ä¼šå‘ç”Ÿç”µæ„Ÿè€¦åˆã€‚ç”µå®¹è€¦åˆæ¯”ç”µæ„Ÿè€¦åˆæ›´é¢‘ç¹åœ°å‘ç”Ÿã€‚\n\nè€¦åˆçš„ä¸¥é‡ç¨‹åº¦å–å†³äºèµ°çº¿çš„é•¿åº¦ã€å¼€å…³é¢‘ç‡ã€ç”µå‹å˜åŒ–å’Œèµ°çº¿ä¹‹é—´çš„è·ç¦»ã€‚ä¸ºäº†å‡å°‘ç”µå®¹è€¦åˆï¼Œè¯·å°†å˜ˆæ‚çš„ä¿¡å·èµ°çº¿è¿œç¦»é‡è¦çš„æ•°å­—å’Œæ¨¡æ‹Ÿä¿¡å·ã€‚å°è¯•åœ¨æ¥åœ°å¹³é¢ä¸Šå¸ƒçº¿ã€‚\n\nåœ¨å¸¦æœ‰é¢„é©±åŠ¨å™¨çš„å¼€å…³åº”ç”¨ä¸­ï¼Œå¿…é¡»ç‰¹åˆ«æ³¨æ„ç¡®ä¿é¢„é©±åŠ¨å™¨çš„é«˜ç”µæµæ‰¿è½½æ¥åœ°å¹³é¢ä¸ IC å…¶ä½™éƒ¨åˆ†çš„æ¥åœ°å¹³é¢ç‰©ç†éš”ç¦»ã€‚è¿™ä¸¤ä¸ªåœ°å¯ä»¥åœ¨æ˜Ÿå½¢ç‚¹æˆ–å•ç‚¹æ¥åœ°ä½ç½®è¿æ¥ï¼Œå¦‚ä¸Šä¸€èŠ‚æ‰€è¿°ã€‚\n\n### å…±æ¨¡å™ªå£°å’Œå·®æ¨¡å™ªå£°\nå·®æ¨¡å™ªå£°æ²¿ç€è¿¹çº¿ä¼ æ’­åˆ°æ¥æ”¶è®¾å¤‡ï¼Œç„¶åé€šè¿‡è¿”å›è·¯å¾„è¿”å›åˆ°æºï¼Œä»è€Œå¯¼è‡´ä¸¤æ¡è¿¹çº¿ä¹‹é—´äº§ç”Ÿå·®åˆ†ç”µå‹ã€‚å½“ä¿¡å·å’Œè¿”å›è·¯å¾„ä¸Šéƒ½äº§ç”Ÿç”µå‹æ—¶ï¼Œå°±ä¼šå‘ç”Ÿå…±æ¨¡å™ªå£°ï¼Œè¿™æ˜¯ç”±äºå…±ç”¨é˜»æŠ—ä¸Šçš„ç”µå‹é™å¼•èµ·çš„ã€‚åœ°å¼¹å°±æ˜¯å…±æ¨¡å™ªå£°çš„ä¸€ä¸ªä¾‹å­ã€‚é€šè¿‡ç¡®ä¿æ‰€æœ‰è¿”å›æºçš„è·¯å¾„éƒ½æ˜¯å®½ã€çŸ­ä¸”é˜»æŠ—ä½çš„è¿¹çº¿ï¼Œå¯ä»¥å¤§å¤§é™ä½å‘ç”Ÿæ­¤é—®é¢˜çš„å¯èƒ½æ€§ã€‚\n\n![å›¾1-5 å·®æ¨¡å™ªå£°ä¸å…±æ¨¡å™ªå£°](/images/siva/1-5.png)\n\n### è€ƒè™‘EMC\nç”µç£å…¼å®¹æ€§ (EMC) ä¸»è¦å–å†³äºå¸ƒå±€å’Œç»„ä»¶ä¹‹é—´çš„ç”µæ°”è¿æ¥ã€‚\n\næ¯ä¸ªä¿¡å·çš„è¿”å›è·¯å¾„å¿…é¡»ä»èµ„æºæµå‘ä¿¡å·æºï¼Œä»è€Œäº§ç”Ÿç”µæµç¯è·¯ã€‚è¯¥çº¿è·¯ç¯è·¯ä¼šå½¢æˆä¸€ä¸ªå¤©çº¿ï¼Œå¯ä»¥è¾å°„ç”µç£èƒ½é‡ï¼Œè¯¥èƒ½é‡ç”±ç”µæµå¹…åº¦ã€ä¿¡å·çš„é‡å¤é¢‘ç‡å’Œç”µæµç¯è·¯çš„å‡ ä½•é¢ç§¯å†³å®šã€‚å»ºè®®å°½é‡å‡å°‘è¿™äº›ç”µæµç¯è·¯ä»¥è·å¾—æœ€ä½³ EMC æ€§èƒ½ï¼Œå›¾ 1-6 æ˜¾ç¤ºäº†å¸¸è§çš„ç”µæµç¯è·¯ç±»å‹ã€‚\n\n![å›¾1-6 ç³»ç»Ÿä¸­çš„ç”µæµè·¯å¾„](/images/siva/1-6.png)\n\nå›¾ 1-6 ä¸­çš„ç”µæºçº¿å½¢æˆç¯è·¯ Aâ€“Câ€“Dâ€“B å’Œ Aâ€“Eâ€“Fâ€“Bã€‚ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„èƒ½é‡ç”±è¿™äº›çº¿è·¯ä¼ å¯¼ã€‚\n\nç¯è·¯ L-M-F-Dã€N-Q-P-F å’Œ G-H-J-K ç”±ä¿¡å·å’Œæ§åˆ¶å½¢æˆã€‚å¦‚æœä¸è€ƒè™‘ç³»ç»Ÿå¤–éƒ¨çš„çº¿è·¯ï¼Œè¿™äº›çº¿è·¯æ‰€åŒ…å›´çš„é¢ç§¯é€šå¸¸å¾ˆå°ã€‚ä½†æ˜¯ï¼Œå¿…é¡»åœ¨é«˜é¢‘ä¸‹è€ƒè™‘è¿™äº›çº¿è·¯ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸ä¼šä¼ è¾“ä¼šå½±å“ EMC æ€§èƒ½çš„ä¿¡å·ã€‚\n\nå½“è¿æ¥å™¨ã€æ¥å¤´æˆ–å…¶ä»–ç»„ä»¶ç ´åæ¥åœ°å¹³é¢æ—¶ï¼Œä¹Ÿä¼šå½¢æˆç”µæµç¯è·¯ã€‚è¿™ä¼šå¯¼è‡´å¼€å…³ç”µæµçš„é«˜é¢‘åˆ†é‡åœ¨ç”µè·¯æ¿å‘¨å›´ä¼ æ’­å¾—æ›´è¿œï¼Œä»è€Œæœ‰æ•ˆåœ°å½¢æˆä¸€ä¸ªå¤§ç¯è·¯ã€‚è¿™ç§æƒ…å†µä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨è¿‡å­”ä¸­ã€‚\n\n# çƒ­æ•ˆåº”\nç”µæœºé©±åŠ¨å™¨å¹¶éç†æƒ³è®¾å¤‡ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œéƒ¨åˆ†åŠŸç‡ä¼šä»¥çƒ­é‡çš„å½¢å¼åœ¨å†…éƒ¨è€—æ•£ã€‚å¿…é¡»åœ¨é©±åŠ¨å™¨æŸåä¹‹å‰å¤„ç†è½¬æ¢ä¸ºçƒ­é‡çš„èƒ½é‡ã€‚æ­£ç¡®çš„ PCB è®¾è®¡å¯ä»¥æœ‰æ•ˆæ¶ˆé™¤æ•ˆç‡ä½ä¸‹äº§ç”Ÿçš„çƒ­é‡ï¼Œå¹¶ä½¿è®¾å¤‡ä¿æŒåœ¨æ¨èæ¸©åº¦ã€‚\n\n## PCB ä¼ å¯¼å’Œå¯¹æµ\nç”µæœºé©±åŠ¨å™¨çƒ­æ€§èƒ½çš„ä¸€ä¸ªé‡è¦è€ƒè™‘å› ç´ æ˜¯è®¾å¤‡å†…éƒ¨äº§ç”Ÿçš„çƒ­é‡å¯ä»¥æ¶ˆæ•£çš„è·¯å¾„ã€‚çƒ­é‡ä»èŠ¯ç‰‡ä¼ åˆ°è¾ƒä½æ¸©åº¦ç¯å¢ƒçš„ä¸»è¦è·¯å¾„æœ‰ä¸‰æ¡ï¼š\n- å°è£…ææ–™\n- é”®åˆçº¿\n- å¯¼çƒ­ Pad\n\nä»¥è¿™ä¸‰æ¡è·¯å¾„ä¸ºä¾‹ï¼Œå¯¼çƒ­ç„Šç›˜æ˜¯çƒ­é‡ä»è®¾å¤‡ä¼ å‡ºçš„æœ€æœ‰æ•ˆè·¯å¾„ï¼Œå…¶æ¬¡æ˜¯å°è£…ææ–™ï¼Œæœ€åæ˜¯é”®åˆçº¿ã€‚å¯¼çƒ­ç„Šç›˜é›†æˆç”µè·¯å°è£…ä¸­ä½¿ç”¨çš„æŠ€æœ¯ä»èŠ¯ç‰‡åˆ°å¤–éƒ¨é“œå¹³é¢åˆ›å»ºäº†ä¸€æ¡ä½çƒ­é˜»è·¯å¾„ã€‚å› æ­¤ï¼Œå¯¼çƒ­ç„Šç›˜å¯ä»¥æœ‰æ•ˆåœ°å°†å¤§é‡çƒ­é‡ä»èŠ¯ç‰‡ä¼ å¯¼å‡ºå»ã€‚é©±åŠ¨å™¨ä¸‹æ–¹çš„å¯¼çƒ­ç„Šç›˜åº”è¶³å¤Ÿå¤§ï¼Œä»¥è¦†ç›–å¯¼çƒ­ç„Šç›˜çš„æ•´ä¸ªåŒºåŸŸï¼Œå¹¶ä¸”ä»ç„¶åŒ…æ‹¬ PCB å…¶ä»–éƒ¨åˆ†çš„å¤§è¡¨é¢ç§¯ã€‚å¯¼çƒ­ç„Šç›˜è¿˜åº”ç´§å¯†ç»“åˆåˆ°åº•éƒ¨æ¥åœ°å¹³é¢ï¼Œå¹¶åœ¨å¯¼çƒ­ç„Šç›˜æ­£ä¸‹æ–¹æ”¾ç½®å‡ ä¸ªå¯¼çƒ­è¿‡å­”ã€‚å›¾ 2-1 æ˜¾ç¤ºäº†è®¾å¤‡èŠ¯ç‰‡ä¸­äº§ç”Ÿçš„çƒ­é‡ä½¿ç”¨çš„å‡ºå£è·¯å¾„ç¤ºä¾‹ã€‚\n\n![å›¾2-1 å¯¼çƒ­ç„Šç›˜å°è£…çš„æ¨ªæˆªé¢ä»¥åŠç”±æ­¤äº§ç”Ÿçš„çƒ­ä¼ é€’](/images/siva/2-1.png)\n\nå°†é¡¶éƒ¨å’Œåº•éƒ¨æ¥åœ°å¹³é¢è¿æ¥åˆ°é©±åŠ¨å™¨çš„å¯¼çƒ­ç„Šç›˜å¯æ˜¾è‘—æé«˜ PCB è®¾è®¡ä¸­çš„æ•£çƒ­é‡ã€‚å› æ­¤ï¼Œåœ¨å¸ƒå±€ä¸­åº”å°†è¿™äº›å¹³é¢åšå¾—å°½å¯èƒ½å¤§ã€‚\n\n## è¿ç»­Top-Layerå¯¼çƒ­ç„Šç›˜\nå°†å¯¼çƒ­ç„Šç›˜è¿æ¥åˆ°å®å¿ƒé“œå¹³é¢æ˜¯åˆ›å»ºé©±åŠ¨å™¨èŠ¯ç‰‡äº§ç”Ÿçš„çƒ­é‡å‡ºå£è·¯å¾„çš„é‡è¦è¦æ±‚ã€‚ä¸ºäº†ä½¿çƒ­é‡ä»è®¾å¤‡ä¸­æµå‡ºï¼Œé“œå¹³é¢å¿…é¡»ä»å¯¼çƒ­ç„Šç›˜è¿ç»­åˆ°ç”µè·¯æ¿ä¸Šçš„å…¶ä»–åŒºåŸŸã€‚æœ€ä½³åšæ³•æ˜¯åŒ…æ‹¬ä¸€æ¡ä»é©±åŠ¨å™¨ä¸‹æ–¹çš„é“œå¡«å……åˆ°å®½é˜”çš„é«˜è¡¨é¢ç§¯å¹³é¢çš„å®½å‡ºå£è·¯å¾„ã€‚å¦‚æœè¿™äº›å¹³é¢è¢«ä¸­æ–­ï¼Œçƒ­é‡çš„å‡ºå£è·¯å¾„å°±ä¼šæ”¶ç¼©ï¼Œä»è€Œå¢åŠ çƒ­é˜»ã€‚çƒ­é˜»çš„å¢åŠ ä¼šå¯¼è‡´å¯¼çƒ­ç„Šç›˜å’ŒåŒä¸€å¹³é¢ä¸Šæ›´å®½çš„è¡¨é¢ç§¯ä¹‹é—´çš„æ¸©å·®æ›´å¤§ã€‚å›¾ 2-2 æ˜¾ç¤ºäº†é©±åŠ¨å™¨ä¸‹æ–¹æ”¶ç¼©å’Œè¿ç»­æ¥åœ°æµ‡æ³¨å¼•èµ·çš„æ¸©å‡ç¤ºä¾‹ã€‚\n\n![å›¾2-2 ç ´ç¢åœ°ä¸è¿ç»­åœ°æµ‡æ³¨çƒ­å›¾](/images/siva/2-2.png)\n\nåœ¨é©±åŠ¨å™¨ä¸‹æ–¹æ”¾ç½®è¿ç»­çš„é“œå¯¼çƒ­ç„Šç›˜å¯¹äºè®¾å¤‡é«˜æ•ˆå†·å´éå¸¸é‡è¦ã€‚\nå°†å®½è·¯å¾„æ•´åˆåˆ°é«˜è¡¨é¢ç§¯å¹³é¢å¯ä½¿é©±åŠ¨å™¨å¯¼çƒ­ç„Šç›˜å’Œç¯å¢ƒç©ºæ°”æ¸©åº¦ä¹‹é—´çš„çƒ­é˜»ä¿æŒåœ¨æœ€ä½æ°´å¹³ã€‚\n\n## é“œåš ï¼ˆCopper Thicknessï¼‰\nè™½ç„¶è¿ç»­ã€å®½é˜”çš„å¹³é¢ä¼šé™ä½çƒ­é˜»ï¼Œä½†å¹³é¢ä¸Šçš„é“œåšåº¦ä¹Ÿæ˜¯ PCB çƒ­æ€§èƒ½çš„å…³é”®è€ƒè™‘å› ç´ ã€‚é€šè¿‡å¢åŠ  PCB ä¸Šçš„é“œé•€å±‚åšåº¦ï¼Œå¹³é¢çš„æœ‰æ•ˆçƒ­é˜»ä¼šé™ä½ã€‚ä¸‹å¼å¯è®¡ç®—é“œåšåº¦ä¸å¹³é¢é¢ç§¯ä¹‹é—´çš„å…³ç³»ï¼š\n\n$$\n\\theta_{cu}=(\\frac{1}{\\lambda_{cu}}\\times length ) / Area\n$$\n\nå‡è®¾é•¿åº¦å’Œå®½åº¦ä¸º 1 å˜ç±³ï¼Œé•€å±‚åšåº¦ä¸º 1 ç›å¸ (0.0035 å˜ç±³)ï¼Œåˆ™ä¸é©±åŠ¨å™¨æ¨ªå‘è¿æ¥çš„é“œå¹³é¢çš„è¿‘ä¼¼çƒ­é˜»å¯æŒ‰ç…§ä¸‹å¼è®¡ç®—ï¼š\n\n$$\n\\theta_{cu}=(\\frac{1}{\\lambda_{cu}}\\times length ) / Area = (25 â„ƒ \\quad cm/W \\times 1 cm) / 1 cm \\times 0.0035 cm =71.4 â„ƒ/W\n$$\n\nå¦‚æœé“œåšåº¦åŠ å€ï¼Œç›¸åŒå°ºå¯¸å¹³é¢çš„çƒ­é˜»å°±ä¼šå‡åŠã€‚è¿æ¥åˆ°é©±åŠ¨å™¨çš„æ¥åœ°å¹³é¢ä¸Šçš„é“œåšåº¦è¶Šåšï¼Œæœ‰åŠ©äºé«˜æ•ˆåœ°å°†çƒ­é‡ä»è®¾å¤‡ä¼ å¯¼åˆ°å‘¨å›´ç©ºæ°”ä¸­ï¼Œè€Œä¸ä¼šå¯¼è‡´ç”µè·¯æ¿ä¸Šå‡ºç°æ˜æ˜¾çš„æ¸©å·®ã€‚\n\n## æ•£çƒ­è¿‡å­”è¿æ¥æ–¹å¼ï¼ˆThermal via Connectionsï¼‰\næ•£çƒ­è¿‡å­”åº”å°†é¡¶å±‚å’Œåº•å±‚è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥ä¾¿çƒ­é‡å¯ä»¥ä» IC æ•£å‘åˆ°ä¸¤å±‚ã€‚æ•£çƒ­è¿‡å­”ä¸åº”ä½¿ç”¨*çƒ­é£ç„Šç›˜*ï¼ˆThermal Reliefï¼Œå³åå­—èŠ±ç„Šç›˜ï¼Œä¸ºäº†é˜²æ­¢å› æ•£çƒ­è¿‡å¿«è€Œå¯¼è‡´çš„è™šç„Šï¼Œåœ¨ç”µæºå’Œåœ°çš„è¿‡å­”é‡‡ç”¨åå­—èŠ±çš„å·¥è‰ºè¿æ¥ï¼Œå‡å°‘äº†æ¥è§¦é¢ç§¯ï¼Œé™ä½äº†æ•£çƒ­é€Ÿåº¦ï¼Œæ–¹ä¾¿ç„Šæ¥ï¼‰è¿æ¥ï¼Œå› ä¸ºçƒ­é‡ä»é¡¶å±‚é€šè¿‡é€šå­”æµåˆ°åº•å±‚çš„è·¯å¾„å—åˆ°é™åˆ¶ã€‚è¿™ç§çƒ­æµè·¯å¾„çš„æ”¶ç¼©å¯¼è‡´é€šå­”å‘¨å›´é¡¶å±‚å‰©ä½™éƒ¨åˆ†çš„æ¸©åº¦å‡é«˜ã€‚ç›´æ¥è¿æ¥é€šå­”å¯ä½¿é€šå­”å’Œé“œå±‚ä¹‹é—´çš„çƒ­é˜»å°½å¯èƒ½ä½ã€‚æ•£çƒ­é€šå­”åº”ä¸å†…éƒ¨æ¥åœ°å¹³é¢è¿æ¥ï¼Œå¹¶åœ¨é•€é€šå­”çš„æ•´ä¸ªåœ†å‘¨å‘¨å›´è¿›è¡Œå®Œæ•´è¿æ¥ã€‚ä¸è¦ç”¨ç„Šæ–™æ©æ¨¡è¦†ç›–é€šå­”ï¼Œå¦åˆ™ä¼šå¯¼è‡´è¿‡å¤šçš„ç©ºæ´ã€‚å›¾ 2-3 æ˜¾ç¤ºäº†æ•£çƒ­é€šå­”å’Œç›´æ¥è¿æ¥é€šå­”ä¹‹é—´çš„æ¸©å·®ã€‚\n\n*å‚è§*ï¼š[å¦‚ä½•ä½¿å¼•è„šæ¥åœ°ä¸ºåå­—ç„Šç›˜ï¼Œä½†è¿‡å­”ä¸ºå®Œå…¨æ¥åœ°?](https://ee.ofweek.com/2021-01/ART-11000-2800-30482578.html)\n\n![å›¾2-3 çƒ­é£ç„Šç›˜ï¼ˆå³ï¼‰ä¸ç›´æ¥è¿‡å­”è¿æ¥ï¼ˆå·¦ï¼‰çƒ­åŠ›å›¾](/images/siva/2-3.png)\n\næ•£çƒ­ç„Šç›˜æ¥å¤´å°†å¹³é¢ä¸è¿‡å­”æˆ–ç»„ä»¶ç”µè¿æ¥èµ·æ¥ï¼Œä½†å®ƒä»¬ä¼šå‡å°‘ç»„ä»¶æˆ–è¿‡å­”ä¸å¹³é¢ä¹‹é—´çš„çƒ­æµã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯è®©çƒ™é“æˆ–å›æµç‚‰åªåŠ çƒ­ç»„ä»¶å¹¶ç¡®ä¿å¯é çš„ç„Šæ¥è¿æ¥ã€‚è¿™ç§æ–¹æ³•å¯¹äºä¸éœ€è¦è¿‡å­”åœ¨å¹³é¢ä¹‹é—´è¿›è¡Œçƒ­ä¼ å¯¼çš„åº”ç”¨éå¸¸æœ‰æ•ˆã€‚ç„¶è€Œï¼Œç”µæºåº”ç”¨ï¼ˆä¾‹å¦‚ç”µæœºé©±åŠ¨å™¨ï¼‰è¦æ±‚å°†è¿™äº›è¿‡å­”ç›´æ¥ç²˜åˆåˆ°å¹³é¢ä¸Šï¼Œä»¥å®ç°å±‚é—´çš„æœ€ä½³çƒ­æ€§èƒ½ã€‚\n\n## æ•£çƒ­è¿‡å­”å®½åº¦ ï¼ˆThermal Via Widthï¼‰\nè™½ç„¶å¯¼çƒ­ç„Šç›˜åœ¨èŠ¯ç‰‡å’Œ PCB é¡¶éƒ¨æ¥åœ°å¹³é¢ä¹‹é—´æä¾›äº†ä½é˜»æŠ—çƒ­è·¯å¾„ï¼Œä½†åº”è€ƒè™‘è¿æ¥é¡¶éƒ¨å’Œåº•éƒ¨æ¥åœ°å¹³é¢çš„è¿‡å­”çš„çƒ­é˜»æŠ—ã€‚**å¾·å·ä»ªå™¨å»ºè®®åœ¨å¯¼çƒ­ç„Šç›˜æ­£ä¸‹æ–¹è®¾ç½®ç›´å¾„ä¸º 20 mil çš„å¯¼çƒ­è¿‡å­”ï¼Œå­”å¾„ä¸º 8 milã€‚**\n\nå‡å°æ•£çƒ­å­”çš„ç›´å¾„æˆ–å¢åŠ å­”çš„å°ºå¯¸ä¼šå¢åŠ çƒ­é˜»ã€‚å»ºè®®çš„ 8 mil å­”å°ºå¯¸å’Œ 20 mil ç›´å¾„éœ€è¦ä»æ•£çƒ­ç„Šç›˜åˆ°åº•å±‚çš„æœ€å°ç„Šæ–™èŠ¯å¸ï¼Œå¹¶å°†è¿‡å­”çš„çƒ­é˜»ä¿æŒåœ¨æœ€ä½æ°´å¹³ã€‚å›¾ 2-4 æ˜¾ç¤ºäº†æ¨èçš„è¿‡å­”æ”¾ç½®ä½ç½®ã€‚\n\n![å›¾2-4 æ•£çƒ­è¿‡å­”æ”¾ç½®](/images/siva/2-4.png)\n\n## PCBæ•£çƒ­è®¾è®¡å°ç»“\næ€»ç»“ä¸€ä¸‹çƒ­è®¾è®¡ï¼Œç”µæœºé©±åŠ¨å™¨ç³»ç»Ÿä¸­çƒ­è®¾è®¡çš„ä¸»è¦è€ƒè™‘å› ç´ å¦‚ä¸‹ï¼š\n- å¯¼çƒ­ç„Šç›˜ï¼ˆThermal Padï¼‰è¿æ¥æ˜¯å™¨ä»¶èŠ¯ç‰‡å¯¼çƒ­çš„æœ€æœ‰æ•ˆé€”å¾„\n- ä½¿ç”¨ä»å¯¼çƒ­ç„Šç›˜åˆ°æ¥åœ°å¹³é¢çš„è¿ç»­é¡¶å±‚çŒæ³¨\n- å°½å¯èƒ½ä½¿ç”¨ 1.5 æˆ– 2 ç›å¸é“œåš\n- ä½¿ç”¨ç›´æ¥è¿æ¥çƒ­é€šå­”\n- ä½¿ç”¨ 8 mil x 20 mil çš„å¯¼çƒ­è¿‡å­”ï¼ˆViaï¼‰å°ºå¯¸ï¼Œä»¥é¿å…è¿‡å¤šçš„ç„Šæ–™æ¸—å…¥\n- å°†çƒ­é€šå­”åˆ†ç»„ä¸ºé˜µåˆ—ï¼Œä»¥æœ€å°åŒ–å¹³é¢ä¹‹é—´çš„çƒ­é˜»\n\n# è¿‡å­”ï¼ˆViasï¼‰\nPCB ä¸Šçš„é€šå­”åœ¨ç”µè·¯æ¿çš„ä¸åŒå±‚ä¸Šå…·æœ‰ä¸¤ä¸ªä½äºç›¸åº”ä½ç½®çš„ç„Šç›˜ï¼Œå®ƒä»¬é€šè¿‡ç©¿è¿‡ç”µè·¯æ¿çš„å­”è¿›è¡Œç”µè¿æ¥ã€‚è¯¥å­”é€šè¿‡ç”µé•€åˆ¶æˆå¯¼ç”µçš„ã€‚æœ‰å‡ ç§ç±»å‹çš„é€šå­”ï¼Œä¾‹å¦‚ç›²å­”ã€åŸ‹å­”å’Œçƒ­å­”ã€‚å¯¹äºç”µæœºé©±åŠ¨å™¨ PCB è®¾è®¡ï¼Œé‡ç‚¹æ˜¯æ™®é€šé€šå­”å’Œçƒ­å­”ã€‚\n\né€šå­”ç»å¸¸ç”¨äºä¿¡å·è½¨é“å’Œç”µæºè½¨é“çš„ PCB å¸ƒçº¿ã€‚å¯¹äºä¿¡å·è¿æ¥ï¼Œç”µæµå¾ˆå°ï¼ˆå¾®å®‰åˆ°æ¯«å®‰ï¼‰ï¼Œä¸€ä¸ªæˆ–ä¸¤ä¸ªé€šå­”å¯èƒ½è¶³ä»¥å°†ä¿¡å·è·¯ç”±åˆ°å¦ä¸€å±‚ã€‚å¯¹äºç”µæºè¿æ¥ï¼Œå¯ä»¥åœ¨ç”µæºæˆ–æ¥åœ°è¿¹çº¿ä¸Šæ·»åŠ å¤šé€šå­”æˆ–â€œé€šå­”æ‹¼æ¥â€ï¼Œä»¥ç¡®ä¿å±‚é—´ä»¥åŠç”µæºå’Œæ¥åœ°å¹³é¢ä¹‹é—´çš„ä½é˜»æŠ—è¿æ¥ã€‚è¿˜å¯ä»¥æ·»åŠ å¤šé€šå­”ä»¥å°†è®¾å¤‡äº§ç”Ÿçš„çƒ­é‡æ•£å‘åˆ°å…¶ä»–ç”µè·¯æ¿å±‚ï¼Œå¦‚ç¬¬ä¸Šä¸€èŠ‚æ‰€è¿°ã€‚\n\n![å›¾3-1 åº•éƒ¨é“œå¹³é¢çš„è¿‡å­”è¿æ¥](/images/siva/3-1.png)\n\n## è¿‡å­”ç”µæµæ‰¿è½½é‡ï¼ˆVia Current Capacityï¼‰\nåœ¨ç”µæœºé©±åŠ¨å™¨ PCB è®¾è®¡ä¸­ï¼Œå¤šé€šå­”é€šå¸¸ç”¨äºå±‚é—´é«˜ç”µæµè¿æ¥ã€‚æä¾›é€‚å½“çš„é€šå­”å°ºå¯¸å’Œæ•°é‡ä»¥å®ç°ä½ç”µé˜»å’Œé•¿æœŸå¯é æ€§éå¸¸é‡è¦ã€‚é€šå¸¸ï¼Œé€šå­”çš„ç›´å¾„è‡³å°‘åº”ä¸ºèµ°çº¿çš„é•¿åº¦ã€‚åœ¨ä½¿ç”¨é“œå¹³é¢ä½œä¸ºèµ°çº¿çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªé€šå­”åº”ä½äºç”µæµè¿›å…¥æˆ–ç¦»å¼€å…ƒä»¶å¼•è„šçš„ä½ç½®é™„è¿‘ã€‚\n\nä¸‹è¡¨åˆ—å‡ºäº†æŒ‰ç…§ IPC-2152 æ ‡å‡†ï¼Œ1 ç›å¸ PCB åœ¨æ¸©åº¦å‡é«˜ 10Â°C æ—¶ä¸åŒé€šå­”ç›´å¾„çš„ç”µæµå®¹é‡ã€‚\n\n| Via \t Diameter \t| Current Capacity \t|\n|:-----------:\t|:---------------:\t|\n|  6  \t    mil   \t|   0.2       A    \t|\n|  8  \t   mil   \t|   0.55      A    \t|\n|  10 \t   mil   \t|   0.81      A    \t|\n|  12 \t    mil   \t|   0.84      A    \t|\n|  16 \t   mil   \t|   1.1       A    \t|\n\n## è¿‡å­”å¸ƒå±€å»ºè®®\n### å¤šè¿‡å­”å¸ƒå±€\nå¤šé€šå­”å¯¹äºä½å¯„ç”Ÿæ¥åœ°å’Œå¤§ç”µæµè¿æ¥éå¸¸æœ‰ç”¨ã€‚å›¾ 3-2ã€å›¾ 3-3 å’Œå›¾ 3-4 æ˜¾ç¤ºäº†å¤šé€šå­”æ”¾ç½®åœ¨ç”µè·¯æ¿è®¾è®¡çš„ä¸åŒä½ç½®çš„ç¤ºä¾‹ã€‚\n\n![å›¾3-2 ç”¨äºå»è€¦æ¥åœ°çš„å¤šé€šå­”](/images/siva/3-2.png)\n\n![å›¾3-3 ç”¨äºç”µæµæ£€æµ‹æ¥åœ°çš„å¤šé€šå­”](/images/siva/3-3.png)\n\n![å›¾3-4 ç”¨äºå¤§ç”µæµè¿æ¥çš„å¤šé€šå­”](/images/siva/3-4.png)\n\n### è¿‡å­”æ”¾ç½®\nå°½ç®¡è¿‡å­”å¾ˆå°ï¼Œä½†å®ƒä»¬ä¼šå ç”¨ PCB å’Œæ¥åœ°å¹³é¢ä¸Šçš„ç©ºé—´ã€‚å°†å¤šä¸ªè¿‡å­”å¸ƒçº¿åœ¨ä¸€èµ·ä¼šåœ¨å¹³é¢ä¸Šäº§ç”Ÿé—´éš™ï¼Œå¹¶å½±å“ç”µæµå’Œæ¥åœ°å›è·¯ã€‚è‰¯å¥½çš„è¿‡å­”å¸ƒå±€å¯ä¸ºæ‰€æœ‰ä¿¡å·åˆ›å»ºå……è¶³çš„è¿”å›è·¯å¾„ã€‚å›¾ 3-5 æ˜¾ç¤ºäº†å¦‚ä½•é¿å…è¿‡å­”é€ æˆä¸å¿…è¦çš„æ¥åœ°å¹³é¢åˆ†è£‚çš„ç¤ºä¾‹ã€‚\n\n![å›¾3-5 é¿å…è¿‡å­”åˆ†è£‚æ¥åœ°å¹³é¢](/images/siva/3-5.png)\n\n# é€šç”¨å¸ƒçº¿æŠ€å·§\nåœ¨è¿›è¡Œç”µæœºé©±åŠ¨å™¨ PCB è®¾è®¡æ—¶ï¼Œè¯·éµå¾ªä»¥ä¸‹é€šç”¨å¸ƒçº¿æŠ€æœ¯ï¼š\n\n- ä½¿æ …æé©±åŠ¨å™¨èµ°çº¿å°½å¯èƒ½å®½ä¸”é•¿åº¦å°½å¯èƒ½çŸ­ã€‚å¯¹äºè‡³å°‘ 1 ç›å¸é“œï¼Œä» 20 å¯†è€³çš„èµ°çº¿å®½åº¦å¼€å§‹ï¼Œå¦‚æœå¤§ç”µæµéœ€è¦ï¼Œåˆ™èµ°çº¿å®½åº¦å¯ä»¥æ›´å¤§ã€‚\n\n![å›¾4-1 DRV8323xEVM æ …æä¿¡å·çº¿](/images/siva/4-1.png)\n\n- é«˜ç«¯FETæ …æçš„ä¿¡å·èµ°çº¿åº”å½“å°½å¯èƒ½é è¿‘å¼€å…³èŠ‚ç‚¹èµ°çº¿ï¼Œä»¥å°½é‡å‡å°‘ç”µæ„Ÿã€ç¯è·¯é¢ç§¯ä»¥åŠ dv/dt å¼€å…³å¼•èµ·å™ªå£°çš„å¯èƒ½æ€§ã€‚\n\n![å›¾4-2 å¹³è¡Œæ …æä¿¡å·çº¿](/images/siva/4-2.png)\n\n- ä¸è¦ä½¿ç”¨ç›´è§’èµ°çº¿ã€‚èµ°çº¿ä¸­çš„ 90 åº¦å¼¯æ›²ä¼šèµ·åˆ°é˜»æŠ—çš„ä½œç”¨ï¼Œå¹¶å¯èƒ½å¯¼è‡´ç”µæµåå°„ã€‚å½“ç”µæœºçš„ç›¸ä½åˆ‡æ¢æ—¶ï¼Œæ€¥å¼¯å¯èƒ½ä¼šå¼•å‘ç”µç£å¹²æ‰° (EMI) é—®é¢˜ã€‚åœ†å½¢å¼¯æ›²æ˜¯ç†æƒ³çš„ï¼Œä½†åœ¨å®é™…è®¾è®¡ä¸­å¯èƒ½ä¸åˆ‡å®é™…ã€‚æ‹è§’å¸ƒçº¿çš„æœ€ä½³åšæ³•æ˜¯ä½¿ç”¨é’è§’ã€‚å›¾ 4-3 æ˜¾ç¤ºäº†èµ°çº¿ä¸­ä¸åŒè§’åº¦çš„ç¤ºä¾‹ã€‚\n\n![å›¾4-3 æ­£ç¡®çš„èµ°çº¿è§’åº¦](/images/siva/4-3.png)\n\n- å°†è¿‡å­”è¿‡æ¸¡åˆ°ç„Šç›˜ï¼Œç‰¹åˆ«æ˜¯å°†è¾“å‡ºå¼•è„šä¸Šçš„ç»†çº¿è¿‡æ¸¡åˆ°ç²—çº¿ã€‚æ³ªæ»´ï¼ˆTeardropï¼‰æŠ€æœ¯å¯é™ä½ä¿¡å·è½¬æ¢çš„çƒ­åº”åŠ›ã€‚è¯¥æŠ€æœ¯è¿˜å¯é¿å…çº¿çš„å¼€è£‚ï¼Œå¹¶ä½¿çº¿åœ¨æœºæ¢°ä¸Šæ›´åšå›ºã€‚æ³ªæ»´æŠ€æœ¯é€‚ç”¨äºä»å°ä¿¡å·è¿‡æ¸¡åˆ°é€šå­”ç„Šç›˜çš„æƒ…å†µã€‚\n\n![å›¾4-4 è¿‡å­”è‡³ç„Šç›˜çš„è¿‡æ¸¡](/images/siva/4-4.png)\n\n- ç»•ç‰©ä½“å¸ƒçº¿æ—¶ï¼Œåº”ä»¥å¹³è¡Œå¯¹çš„æ–¹å¼å¸ƒçº¿ï¼Œä»¥é¿å…å› åˆ†å‰å¸ƒçº¿è€Œå¯¼è‡´çš„å·®åˆ†é˜»æŠ—å’Œä¸è¿ç»­æ€§ã€‚è¿™ç§æ–¹æ³•å¯¹äºç”µæµæ£€æµ‹æ”¾å¤§å™¨çš„ä¿¡å·éå¸¸é‡è¦ã€‚\n\n![å›¾4-5 å¹³è¡Œèµ°çº¿](/images/siva/4-5.png)\n\n- å°†æ— æºå…ƒä»¶ï¼ˆä¾‹å¦‚æºåŒ¹é…ç”µé˜»æˆ–äº¤æµè€¦åˆç”µå®¹ï¼‰æ”¾ç½®åœ¨ä¿¡å·è·¯å¾„å†…ï¼Œå¹¶å°†å®ƒä»¬å¹¶æ’æ”¾ç½®ã€‚å¹³è¡Œæ”¾ç½®å…ƒä»¶å¯äº§ç”Ÿæ›´å®½çš„èµ°çº¿é—´è·ã€‚ä¸å»ºè®®äº¤é”™æ”¾ç½®å…ƒä»¶ï¼Œå› ä¸ºè¿™ä¼šé€ æˆç‹­çª„çš„åŒºåŸŸã€‚\n\n![å›¾4-6 æ¨èçš„å…ƒå™¨ä»¶æ”¾ç½®](/images/siva/4-6.png)\n\n- å°†ç”µè·¯çš„æ¨¡æ‹Ÿéƒ¨åˆ†å’Œæ•°å­—éƒ¨åˆ†åˆ†å¼€æ¥åœ°æ˜¯æŠ‘åˆ¶å™ªå£°çš„æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„æ–¹æ³•ä¹‹ä¸€ã€‚\n\n![å›¾4-7 æ•°å­—åœ°ä¸æ¨¡æ‹Ÿåœ°çš„éš”ç¦»](/images/siva/4-7.png)\n\n# Bulkç”µå®¹å’Œæ—è·¯ç”µå®¹çš„æ”¾ç½®\n## Bulkç”µå®¹æ”¾ç½®\nåœ¨ç”µæœºé©±åŠ¨ç³»ç»Ÿè®¾è®¡ä¸­ï¼ŒBulkç”µå®¹å™¨ï¼ˆå¤§å®¹é‡ç”µå®¹å™¨ï¼‰å¯æœ€å¤§é™åº¦åœ°å‡å°‘ä½é¢‘ç”µæµç¬å˜çš„å½±å“ï¼Œå¹¶å­˜å‚¨ç”µè·ä»¥æä¾›ç”µæœºé©±åŠ¨å™¨åˆ‡æ¢æ—¶æ‰€éœ€çš„å¤§ç”µæµã€‚é€‰æ‹©Bulkç”µå®¹å™¨æ—¶ï¼Œè¯·è€ƒè™‘ç”µæœºç³»ç»Ÿæ‰€éœ€çš„æœ€é«˜ç”µæµã€ç”µæºç”µå‹çº¹æ³¢å’Œç”µæœºç±»å‹ã€‚\n\nä½¿ç”¨Bulkç”µè§£ç”µå®¹å¸®åŠ©ä»é€šè¿‡ç”µæœºç»•ç»„é©±åŠ¨çš„ç”µæµä¸­è·å–ä½é¢‘ã€é«˜å€¼ç”µæµã€‚è¿™äº›ç”µå®¹å™¨é€šå¸¸å¤§äº 10 Î¼Fï¼Œå…·ä½“å–å†³äºåº”ç”¨è¦æ±‚ã€‚\n\nå°†æ‰€æœ‰Bulkç”µå®¹å™¨æ”¾ç½®åœ¨ç”µæºæ¨¡å—æˆ–ç”µè·¯æ¿çš„ç”µæºå…¥å£ç‚¹é™„è¿‘ã€‚TI å»ºè®®æ¯ä¸ªBulkç”µå®¹å™¨éƒ½æœ‰å¤šä¸ªé€šå­”å°†ç„Šç›˜è¿æ¥åˆ°ç›¸åº”çš„ç”µæºå±‚ã€‚TI è¿˜å»ºè®®æ‰€æœ‰Bulkç”µå®¹å™¨éƒ½å…·æœ‰ä½ç­‰æ•ˆä¸²è”ç”µé˜» (ESR)ã€‚\n\n![å›¾5-1 Bulkç”µå®¹å¤šè¿‡å­”æ”¾ç½®](/images/siva/5-1.png)\n\n![å›¾5-2 Bulkç”µå®¹å’Œæ—è·¯ç”µå®¹æ”¾ç½®](/images/siva/5-2.png)\n\n## ç”µè·æ³µç”µå®¹å™¨ï¼ˆCharge Pump Capacitorï¼‰å’Œè‡ªä¸¾ç”µå®¹\nTI çš„å¤§å¤šæ•°ç”µæœºé©±åŠ¨è®¾å¤‡ (DRVxx) éƒ½ä½¿ç”¨ç”µè·æ³µæˆ–è‡ªä¸¾ç”µå®¹å™¨æ¥å®Œå…¨åˆ‡æ¢é«˜ä¾§ N æ²Ÿé“ MOSFET çš„æ …æã€‚å°†è¿™äº›ç”µå®¹å™¨æ”¾ç½®åœ¨å°½å¯èƒ½é è¿‘ç”µæœºé©±åŠ¨è®¾å¤‡çš„ä½ç½®ã€‚åœ¨å›¾ 5-3 ä¸­ï¼ŒC4 ç”µå®¹å™¨æ˜¯ç”¨äºä» VM åˆ° VCP å¼•è„šçš„ç”µè·æ³µè¾“å‡ºçš„ç”µå®¹ï¼Œè€Œ C7 ç”µå®¹å™¨æ˜¯ç”¨äºç”µè·æ³µåˆ‡æ¢èŠ‚ç‚¹çš„ç”µå®¹ã€‚\n\n![å›¾5-3 ç”µè·æ³µç”µå®¹æ”¾ç½®](/images/siva/5-3.png)\n\n## æ—è·¯ï¼ˆBypassï¼‰/è§£è€¦ï¼ˆDecouplingï¼‰ç”µå®¹æ”¾ç½®\n### é è¿‘ç”µæº\næ—è·¯ç”µå®¹ç”¨äºå°†é«˜é¢‘å™ªå£°æœ€å°åŒ–ï¼Œä»¥å‡å°‘è¿›å…¥ DRV å™¨ä»¶ç”µæºå¼•è„šçš„å™ªå£°ã€‚TI å»ºè®®å°†ç”µå®¹å°½å¯èƒ½é è¿‘å™¨ä»¶çš„ç”µæºè¾“å…¥å¼•è„šå’Œæ¥åœ°å¼•è„šã€‚å¦‚æœæ—è·¯ç”µå®¹å’Œå™¨ä»¶ä¹‹é—´çš„èµ°çº¿é•¿åº¦æ²¡æœ‰æœ€å°åŒ–ï¼Œå®ƒä»¬å¯èƒ½ä¼šåœ¨æ—è·¯ç”µå®¹è¦è¿‡æ»¤çš„é«˜é¢‘ä¸‹äº§ç”Ÿç”µæ„Ÿã€‚èµ°çº¿ç”µæ„Ÿå¢åŠ çš„é˜»æŠ—å¯èƒ½å¯¼è‡´ç”µæºå¼•è„šå¤„çš„ç”µå‹æˆ–ç”µæµäº§ç”ŸæŒ¯é“ƒï¼Œä»è€Œå¯¼è‡´ EMI å¹¶å½±å“æ•°å­—æˆ–æ¨¡æ‹Ÿç”µè·¯çš„æ€§èƒ½ã€‚æœ€ä½³åšæ³•æ˜¯å°†å€¼è¾ƒå°çš„ç”µå®¹å°½å¯èƒ½é è¿‘å™¨ä»¶æ”¾ç½®ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘èµ°çº¿ç”µæ„Ÿçš„å½±å“ã€‚å°†å€¼è¾ƒå¤§çš„ç”µå®¹è¿æ¥åˆ°å€¼è¾ƒå°çš„ç”µå®¹ä¹‹åï¼Œå› ä¸ºéšç€ç”µå®¹å€¼çš„å¢åŠ ï¼Œç”µæ„Ÿå˜å¾—æ›´å°ã€‚\n\n![å›¾5-4 é è¿‘è®¾å¤‡çš„è§£è€¦ç”µå®¹](/images/siva/5-4.png)\n\nå¦‚ä¸Šæ–‡æ‰€ç¤ºï¼Œä½¿ç”¨çš„è¿‡å­”è¶Šå¤šï¼Œé˜»æŠ—è¶Šä½ã€‚TI å¼ºçƒˆå»ºè®®åœ¨ç”µæºå±‚å’Œæ¥åœ°å±‚ä½¿ç”¨å¤šä¸ªè¿‡å­”ã€‚å°†è¿‡å­”ç›´æ¥æ”¾ç½®åœ¨ç”µå®¹å™¨çš„å®‰è£…ç„Šç›˜ä¸Šæ˜¯ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘å¸ƒçº¿é¢ç§¯ï¼ŒåŒæ—¶ä»èƒ½å®ç°ç”µæµæµåŠ¨å¸ƒçº¿ã€‚è¯·éµå¾ªä»¥ä¸‹æ—è·¯ç”µå®¹å™¨æŒ‡å—ï¼š\n\n- ä¸è¦åœ¨æ—è·¯ç”µå®¹å™¨å’Œæœ‰æºå™¨ä»¶ä¹‹é—´ä½¿ç”¨è¿‡å­”ã€‚å¯è§†åŒ–é«˜é¢‘ç”µæµæµåŠ¨å¹¶å°½å¯èƒ½å‡å°‘é«˜é¢‘ç”µæµç¯è·¯ã€‚\n\n- ç¡®ä¿æ—è·¯ç”µå®¹å™¨ä¸æœ‰æºå…ƒä»¶ä½äºåŒä¸€å±‚ï¼Œä»¥è·å¾—æœ€ä½³æ•ˆæœã€‚ä¸è¦åœ¨æ—è·¯ç”µå®¹å™¨å¼•è„šå’Œ IC ç”µæºæˆ–æ¥åœ°å¼•è„šä¹‹é—´æ”¾ç½®è¿‡å­”ã€‚\n\n- å°†è¿‡å­”å¸ƒçº¿åˆ°æ—è·¯ç”µå®¹å™¨ä¸­ï¼Œç„¶åå†å¸ƒçº¿åˆ°æœ‰æºå…ƒä»¶ä¸­ã€‚\n\n- ä½¿ç”¨æœ€å¤šçš„è¿‡å­”å’Œæœ€å®½çš„èµ°çº¿ä»¥è·å¾—æœ€ä½³å¸ƒå±€ã€‚\n\n- æ—è·¯ç”µå®¹å™¨è¶Šè¿‘è¶Šå¥½ï¼ˆå°äº 0.5 å˜ç±³ï¼Œ0.2 è‹±å¯¸ï¼‰ã€‚\n\n- ä¸è¦ä½¿ç”¨å¤§äº 3:1 çš„é•¿å®½æ¯”ã€‚\n\n![å›¾5-5 æ—è·¯ç”µå®¹çš„æ”¾ç½®](/images/siva/5-5.png)\n\n### é è¿‘åŠŸç‡çº§ï¼ˆPower Stageï¼‰\nå¯¹äºåŠŸç‡çº§ä¸Šçš„æ—è·¯ç”µå®¹ï¼Œè¯·ä½¿ç”¨å°å‹é™¶ç“·ç”µå®¹å™¨æ¥è¡°å‡ç”± MOSFET å’Œå…¶ä»–å¯„ç”Ÿç”µå®¹åˆ‡æ¢å¼•èµ·çš„é«˜é¢‘ç”µæµã€‚è¿™äº›ç”µå®¹å™¨çš„ç”µå®¹å€¼é€šå¸¸å°äº 10 Î¼Fï¼Œå…·ä½“å–å†³äºåº”ç”¨è¦æ±‚ã€‚\n\n![å›¾5-6 è®¾ç½®æœ‰æ—è·¯ç”µå®¹çš„Hæ¡¥](/images/siva/5-6.png)\n\n### é è¿‘å¼€å…³ç”µæµæºï¼ˆSwitch Current Sourceï¼‰\næ­£ç¡®å¸ƒå±€å’Œæ”¾ç½®è¿™äº›ç”µå®¹å™¨å¯¹äºç¡®ä¿å…¶æœ‰æ•ˆæ€§è‡³å…³é‡è¦ã€‚ç”µå®¹å’Œå¼€å…³ç”µæµæºä¹‹é—´çš„ä»»ä½•é¢å¤–å¯„ç”Ÿç”µæ„Ÿéƒ½ä¼šé™ä½å…¶æ•ˆæœã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œå°†ç”µå®¹å™¨æ”¾ç½®åœ¨å°½å¯èƒ½é è¿‘å¼€å…³ç”µæµæºçš„ä½ç½®ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸ºç”µæœºå’Œ MOSFETã€‚å›¾ 5-7 æ˜¾ç¤ºäº†åŸºäºä¸Šä¸€ä¸ªåŸç†å›¾ç¤ºä¾‹çš„ç¤ºä¾‹å¸ƒå±€ã€‚\n\n![å›¾5-7 æ—è·¯ç”µå®¹çš„æ”¾ç½®](/images/siva/5-7.png)\n\n### é è¿‘ç”µæµæµ‹é‡è¿æ”¾\nå¯¹äºå¸¦æœ‰é›†æˆç”µæµæ£€æµ‹æ”¾å¤§å™¨ (CSA) çš„è®¾å¤‡ï¼ŒTI å»ºè®®å°†é¢å¤–çš„å»è€¦ç”µå®¹å°½å¯èƒ½é è¿‘æ£€æµ‹å¼•è„šæ”¾ç½®ï¼Œå¹¶ä½¿ç”¨å¤§çº¦ 1 nF çš„å€¼ã€‚å›¾ 5-8 æ˜¾ç¤ºäº†å»è€¦ç”µå®¹ C12ã€C13 å’Œ C17ã€‚\n\n![å›¾5-8 SNxå’ŒSPxå¸ƒå±€](/images/siva/5-8.png)\n\n### é è¿‘ç¨³å‹å™¨ï¼ˆVoltage Regulatorsï¼‰\nå¯¹äºå¸¦æœ‰ç¨³å‹å™¨çš„å™¨ä»¶ï¼Œè¯·å°†ç”µå®¹å™¨å°½å¯èƒ½é è¿‘å¼•è„šæ”¾ç½®ã€‚å°½é‡å‡å°‘æ¥åœ°å¼•è„šçš„æ¥åœ°å›è·¯ã€‚ä¾‹å¦‚ï¼Œå›¾ 5-9 æ˜¾ç¤º C18 ç”µå®¹å™¨å°½å¯èƒ½é è¿‘ DVDD ç¨³å‹å™¨ã€‚\n\n![å›¾5-9 DVDDçš„æ¥åœ°å›è·¯](/images/siva/5-9.png)\n\n# MOSFETçš„æ”¾ç½®ä¸åŠŸç‡çº§å¸ƒçº¿\næ …æé©±åŠ¨å™¨å’ŒåŠŸç‡ MOSFET çš„æ”¾ç½®å¯¹äºé¢„é©±åŠ¨å™¨ç”µæœºé©±åŠ¨è§£å†³æ–¹æ¡ˆçš„æ­£ç¡®åŠŸèƒ½å’Œæœ€ä½³æ€§èƒ½è‡³å…³é‡è¦ã€‚å¯¹äºå¸¦æœ‰é›†æˆ MOSFET çš„ç”µæœºé©±åŠ¨å™¨ï¼Œä¾‹å¦‚ DRV8870ã€DRV8313ã€DRV10987ã€DRV10983-Q1 å’Œ DRV8873-Q1ï¼Œæ­£ç¡®çš„å¸ƒçº¿å·²åœ¨å†…éƒ¨å®Œæˆã€‚å¯¹äºæ …æé©±åŠ¨å™¨ï¼Œä¾‹å¦‚ DRV8701ã€DRV8304ã€DRV8306ã€DRV8323ã€DRV8343-Q1 å’Œ DRV8353ï¼Œä»”ç»†è§„åˆ’ PCB çš„å¸ƒå±€å’ŒåŠŸç‡ MOSFET çš„æ”¾ç½®éå¸¸é‡è¦ã€‚ä»¥ä¸‹éƒ¨åˆ†ä»‹ç»äº†ä¸€äº›å¸¸è§çš„ MOSFET æ‹“æ‰‘ï¼Œå¹¶ä»‹ç»äº†ä½¿ç”¨å¸¸è§ç”µæœºé©±åŠ¨æ¶æ„çš„åŸºæœ¬å¸ƒå±€ç¤ºä¾‹ã€‚\n\n## å¸¸è§åŠŸç‡ MOSFET å°è£…\næœ¬èŠ‚ä»‹ç»ä¸€äº›å¸¸è§çš„ N æ²Ÿé“åŠŸç‡ MOSFET å°è£…ç±»å‹ã€‚å¤§å¤šæ•°\nåŠŸç‡ MOSFET éƒ½æœ‰è¿™å››ç§é€‰é¡¹ä¹‹ä¸€ã€‚é€šè¿‡äº†è§£å°è£…ç±»å‹ã€å°ºå¯¸å’Œå¼•è„šæ’åˆ—ï¼Œå¯ä»¥æ›´å¥½åœ°è®¾è®¡ PCB ä»¥è·å¾—æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚\n\nå›¾ 6-1 ä¸­çš„ç¬¦å·ä»£è¡¨ N æ²Ÿé“åŠŸç‡ MOSFETã€‚è™½ç„¶ MOSFET æ˜¯ä¸€ç§å››ç«¯å™¨ä»¶ï¼Œå…·æœ‰æºæã€æ …æã€æ¼æå’Œä½“æï¼Œä½†ä½“æé€šå¸¸ä½äºæºæç«¯å­ã€‚\n\n![å›¾6-1 N-MOSFETç¬¦å·](/images/siva/6-1.png)\n\nMOSFET å°è£…ä¸åŠŸç‡çº§å’Œæ•£çƒ­ç›´æ¥ç›¸å…³ã€‚ä¸åŒçš„å°è£…å…·æœ‰ä¸åŒçš„å¸ƒçº¿è§„åˆ™ã€‚\n\n### DPAK\nå›¾ 6-2 æ‰€ç¤ºçš„ DPAK (SOT-252) å°è£…æ˜¯ä¸šç•Œæœ€å¸¸ç”¨çš„å°è£…ä¹‹ä¸€ã€‚æ­¤å°è£…åœ¨å°ºå¯¸å’Œæ€§èƒ½ä¹‹é—´å®ç°äº†æŠ˜è¡·ã€‚DPAK å°è£…é€šå¸¸ç”¨äºé«˜åŠŸç‡ MOSFET å’Œç¨³å‹å™¨ã€‚\n\n![å›¾6-2 DPAKå°è£…](/images/siva/6-2.png)\n\n### D2PAK\nD2PAKï¼ˆSOT-252ï¼‰å°è£…ï¼ˆè§å›¾ 6-3ï¼‰æ˜¯ DPAK å°è£…çš„è¾ƒå¤§ç‰ˆæœ¬ï¼Œå¯ä»¥æä¾›æ›´å¥½çš„æ•£çƒ­æ•ˆæœã€‚\n\n![å›¾6-3 D2PAKå°è£…](/images/siva/6-3.png)\n\n### TO-220\nTO-220 å°è£…ï¼ˆè§å›¾ 6-4ï¼‰æ˜¯ä¸€ç§é€šå­” MOSFET å°è£…ã€‚ç›´ç«‹ç‰‡å¯ç”¨äºå®‰è£…æ•£çƒ­å™¨ã€‚ä½¿ç”¨è¿™ç§å°è£…çš„ç¼ºç‚¹æ˜¯å®ƒéœ€è¦æ›´å¤šç©ºé—´ï¼Œå¹¶ä¸”é€šå¸¸æ¯”è¡¨é¢è´´è£…å°è£…ï¼ˆä¾‹å¦‚ DPAK å’Œ D2PAK å°è£…ï¼‰æ›´é«˜ã€‚\n\n![å›¾6-4 TO-220å°è£…](/images/siva/6-4.png)\n\n### 8-Pin SON\n8 å¼•è„š SON å°è£…ï¼ˆè§å›¾ 6-5ï¼‰æ˜¯æœ€å¸¸è§çš„æ— å¼•çº¿å°è£…ã€‚æ­¤å°è£…æä¾›äº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå¯å®ç°æœ€å°çš„ç”µè·¯æ¿ç©ºé—´å’Œæœ€ä½³æ€§èƒ½ã€‚å¤§å¤šæ•°å¼•çº¿å°è£…å…·æœ‰ç›¸ä¼¼çš„å¼•è„šæ’åˆ—ã€‚8 å¼•è„š SON å°è£…çš„ç‹¬ç‰¹ä¹‹å¤„åœ¨äºï¼Œä¸å¼•çº¿å°è£…ï¼ˆTO-252 å’Œ TO-220ï¼‰ç›¸æ¯”ï¼Œæ …æå¼•è„šä½äºç›¸åçš„ä¸€ä¾§ã€‚\n\n![å›¾6-5 8-Pin SON å°è£…](/images/siva/6-5.png)\n\n## MOSFETå¸ƒå±€è®¾ç½®\nå›¾ 6-6 å’Œå›¾ 6-7 æ˜¾ç¤ºäº†ä¸¤ç§å…¸å‹é…ç½®çš„å¸¸è§ MOSFET ä½ç½®å’Œå¸ƒå±€ï¼›åˆ†åˆ«ä¸ºåŠæ¡¥å †å å’ŒåŠæ¡¥å¹¶æ’ï¼Œé€‚ç”¨äºæœ‰å¼•çº¿å’Œæ— å¼•çº¿å°è£…ã€‚\n\n![å›¾6-6 åŠæ¡¥å †å ](/images/siva/6-6.png)\n\n![å›¾6-7 åŠæ¡¥å¹¶æ’](/images/siva/6-7.png)\n\nè¿™äº›åŠæ¡¥å¸ƒå±€å¯ä»¥é‡å¤ç”¨äºå¤šä¸ªåŠæ¡¥æ‹“æ‰‘ï¼ŒåŒ…æ‹¬ H æ¡¥ï¼ˆä¸¤ä¸ªåŠæ¡¥ï¼‰ã€é€†å˜å™¨ï¼ˆä¸‰ä¸ªåŠæ¡¥ï¼‰å’ŒåŒ H æ¡¥ï¼ˆå››ä¸ªåŠæ¡¥ï¼‰ã€‚\n\n## åŠŸç‡çº§å¸ƒå±€è®¾è®¡\nåœ¨ä¸ºåŠŸç‡ MOSFET é€‰æ‹©æ­£ç¡®çš„ä½ç½®åï¼Œä¸‹ä¸€æ­¥æ˜¯ç¡®ä¿å¸ƒçº¿æ­£ç¡®ã€‚ç”±äº MOSFET ç”¨äºé«˜åŠŸç‡ã€ç”µæœºé©±åŠ¨å¼€å…³åº”ç”¨ï¼Œå› æ­¤è®¾è®¡å¯¹éç†æƒ³å¸ƒå±€å¼•å…¥çš„å¯„ç”Ÿæ•ˆåº”å¾ˆæ•æ„Ÿã€‚æœ¬èŠ‚ä»‹ç»äº†ä¸€äº›éœ€è¦å¸ƒçº¿çš„å…³é”®ä¿¡å·ä»¥åŠç®¡ç†è¿™äº›ä¿¡å·çš„æœ€ä½³å®è·µã€‚åŠŸç‡çº§å¦‚å›¾ 6-8 æ‰€ç¤ºã€‚\n\n![å›¾6-8 å¸¦å¼€å…³èŠ‚ç‚¹ï¼ˆçº¢åœˆï¼‰çš„åŠæ¡¥åŠŸç‡çº§](/images/siva/6-8.png)\n\n### å¼€å…³èŠ‚ç‚¹ï¼ˆSwitch Nodeï¼‰\nå¼€å…³èŠ‚ç‚¹æ˜¯é«˜ç«¯ MOSFET çš„æºæå¼•è„šå’Œä½ç«¯ MOSFET çš„æ¼æå¼•è„šä¹‹é—´çš„è¿æ¥ï¼Œå¦‚å›¾ 6-10 æ‰€ç¤ºã€‚æ­¤èŠ‚ç‚¹æ˜¯æœ€ç»ˆè¿æ¥åˆ°è´Ÿè½½ï¼ˆåœ¨æœ¬åº”ç”¨ä¸­ä¸ºç”µæœºï¼‰çš„ç½‘ç»œã€‚å¼€å…³èŠ‚ç‚¹æ˜¯åŠæ¡¥é…ç½®ä¸­è¦è·¯ç”±çš„æœ€å…³é”®ä¿¡å·ï¼Œå› ä¸ºæ­¤ç½‘ç»œä¸Šçš„ä¿¡å·å…·æœ‰é«˜é¢‘ã€å¤§ç”µæµç‰¹æ€§ã€‚å›¾ 6-8 æ‰€ç¤ºçš„ç”µè·¯å…·æœ‰ç”± PCB å’ŒåŠŸç‡ MOSFET å¼•èµ·çš„è®¸å¤šéç†æƒ³å¯„ç”Ÿæ•ˆåº”ã€‚å›¾ 6-9 æ˜¾ç¤ºäº†å…¶ä¸­ä¸€äº›ä¸»è¦å¯„ç”Ÿæ•ˆåº”ï¼Œå®ƒä»¬æ˜¯å¼€å…³èŠ‚ç‚¹æŒ¯é“ƒç°è±¡çš„ä¸»è¦åŸå› ã€‚\n\n![å›¾6-9 åŠæ¡¥å¯„ç”Ÿæ•ˆåº”](/images/siva/6-9.png)\n\nå¼€å…³èŠ‚ç‚¹æŒ¯é“ƒæ˜¯ç”±äº PCB å’ŒåŠŸç‡ MOSFET çš„å¯„ç”Ÿæ•ˆåº”å¯¼è‡´çš„å¼€å…³èŠ‚ç‚¹ä¸Šçš„ LC æŒ¯è¡ã€‚å¼€å…³èŠ‚ç‚¹æŒ¯é“ƒä¼šå¯¼è‡´ EMI å¹¶äº§ç”Ÿè¿‡å†²å’Œä¸‹å†²ç”µå‹ï¼Œè¿™å¯èƒ½ä¼šè¿å MOSFET æ¼æ-æºæç”µå‹å’Œæ …æé©±åŠ¨å™¨å¼•è„šçš„ç»å¯¹æœ€å¤§é¢å®šå€¼ã€‚å®ƒè¿˜ä¼šé™ä½åŠŸç‡çº§çš„æ•ˆç‡ã€‚\n\nå¯ä»¥é€šè¿‡å¤–éƒ¨æªæ–½å’Œç³»ç»Ÿè°ƒæ•´ï¼ˆé™ä½æ–œç‡ã€å¤–éƒ¨ç¼“å†²å™¨ç­‰ï¼‰æ¥è§£å†³å¼€å…³èŠ‚ç‚¹æŒ¯é“ƒé—®é¢˜ï¼Œä½†åŸºæœ¬åˆç†çš„å¸ƒå±€å¯ä»¥è§£å†³è®¸å¤šä¸»è¦é—®é¢˜ã€‚å›¾ 6-10 ä¸­çš„å¸ƒå±€ç¤ºä¾‹æ˜¾ç¤ºäº†æœ€å°åŒ–é«˜ç«¯ MOSFET æºæå’Œä½ç«¯ MOSFET æ¼æä¹‹é—´ç”µæ„Ÿçš„è®¾è®¡ã€‚æœ€ä½³åšæ³•æ˜¯æœ€å°åŒ–é“œå¹³é¢è¿æ¥çš„é•¿åº¦å¹¶æœ€å¤§åŒ–å…¶å®½åº¦ï¼Œå¹¶ä½¿ç”¨å…·æœ‰æœ€å°å¯„ç”Ÿç”µæ„Ÿçš„ MOSFET å°è£…ã€‚\n\n![å›¾6-10 å¼€å…³èŠ‚ç‚¹å¸ƒå±€æ ·ä¾‹](/images/siva/6-10.png)\n\n### å¤§ç”µæµå¾ªç¯è·¯å¾„ï¼ˆHigh-Current Loop Pathsï¼‰\nç”±äºç”µæœºåº”ç”¨ä¾èµ–äºé«˜å¼€å…³ç”µæµï¼Œå› æ­¤æœ€å°åŒ–é«˜ç”µæµè·¯å¾„çš„æ€»ç¯è·¯ç”µæ„Ÿè‡³å…³é‡è¦ã€‚æœ€å°åŒ–è¯¥ç”µæ„Ÿå¯æœ€å¤§ç¨‹åº¦åœ°å‡å°‘ç”µå‹çº¹æ³¢å’Œå™ªå£°ï¼Œå¹¶å¯å‡å°‘å¯¹é¢å¤–æ—è·¯ç”µå®¹çš„éœ€æ±‚ã€‚\n\nåœ¨ç”µæœºç³»ç»Ÿä¸­ï¼Œé«˜ç”µæµç¯è·¯ä»ç”µæºçš„æ­£æå¼€å§‹ï¼Œç»è¿‡é«˜ç«¯åŠŸç‡ MOSFETï¼Œç»è¿‡ç”µæœºç»•ç»„ï¼Œç»è¿‡ç›¸åçš„ä½ç«¯ MOSFETï¼Œå†å›åˆ°ç”µæºçš„è´Ÿæã€‚å›¾ 6-11 ä»¥ H æ¡¥ç¤ºä¾‹æ˜¾ç¤ºäº†æ­¤æµç¨‹ã€‚\n\n![å›¾6-11 å¤§ç”µæµå¾ªç¯è·¯å¾„æ ·ä¾‹](/images/siva/6-11.png)\n\nåº”é€šè¿‡ä»¥ä¸‹æ–¹å¼æœ€å°åŒ–é«˜ç”µæµç¯è·¯è·¯å¾„ï¼š\n\n- å¯¹æ•´ä¸ªé«˜ç”µæµç¯è·¯ä½¿ç”¨æ­£ç¡®çš„èµ°çº¿å®½åº¦ã€‚å¢åŠ èµ°çº¿å®½åº¦å¯é™ä½å¯„ç”Ÿç”µæ„Ÿã€‚\n\n- ä½¿ç”¨æ­£ç¡®çš„å¸ƒå±€æ¥æœ€å°åŒ–å…ƒä»¶ä¹‹é—´çš„è·ç¦»ã€‚å‡å°‘èµ°çº¿é•¿åº¦å¯é™ä½å¯„ç”Ÿç”µæ„Ÿã€‚\n\n- å°½é‡å‡å°‘é«˜ç”µæµè·¯å¾„ä¸­çš„å±‚è·³è½¬æ•°é‡ï¼Œå¹¶åœ¨ä½¿ç”¨é«˜ç”µæµèµ°çº¿è·³è½¬å±‚æ—¶ä½¿ç”¨æ­£ç¡®çš„é€šå­”å°ºå¯¸å’Œæ•°é‡ã€‚\n\nå›¾ 6-12 æ˜¾ç¤ºçš„æ˜¯ä¼˜åŒ–å¤§ç”µæµç¯è·¯çš„ç¤ºä¾‹å¸ƒå±€ã€‚\n\n![å›¾6-12 å¤§ç”µæµå¾ªç¯è·¯å¾„Layoutæ ·ä¾‹](/images/siva/6-12.png)\n\n### VDRAIN æ£€æµ‹å¼•è„š\nVDRAIN å¼•è„šç”¨äºæ„Ÿæµ‹é«˜ç«¯ MOSFET æ¼æç”µå‹ã€‚å…·æœ‰ VDRAIN å¼•è„šçš„ç”µæœºé©±åŠ¨è®¾å¤‡å¿…é¡»ç»è¿‡ä¸€å®šçš„å¸ƒçº¿æ‰èƒ½è·å¾—æœ€ä½³æ€§èƒ½ã€‚ç”±äºç”µå‹ä¾›åº”é¦–å…ˆåˆ°è¾¾é«˜ç«¯ MOSFET çš„æ¼æï¼Œå› æ­¤ VDRAIN å¼•è„šçš„å¸ƒçº¿å¯¹äºå¸ƒå±€è‡³å…³é‡è¦ã€‚VDRAIN\nå¼•è„šä¸ºç”µå‹ä¾›åº” (VM) æä¾› Kelvin è¿æ¥ï¼Œä»è€Œå¯ä»¥åœ¨å‘ç”Ÿè¿‡æµäº‹ä»¶æ—¶ç›‘æ§é«˜ç«¯ MOSFET çš„ VDS ç”µå‹ï¼ˆè§å›¾ 6-13ï¼‰ã€‚ç”±äºåŠŸç‡çº§ä¸­çš„ VM è¿æ¥é€šå¸¸ç”±å¤§é“œå¹³é¢å’Œå®½èµ°çº¿ç»„æˆä»¥æ”¯æŒæ‰€éœ€çš„ç”µæµï¼Œå› æ­¤å¹³é¢çš„é¢å¤–ç”µæ„Ÿå’Œå‹é™å¯èƒ½ä¼šå½±å“ VDS æµ‹é‡ç²¾åº¦ã€‚å› æ­¤ï¼Œå°† VDRAIN å¼•è„šé€šè¿‡ä¸€æ¡èµ°çº¿ç›´æ¥å¸ƒçº¿åˆ°å¤–éƒ¨åŠŸç‡ MOSFET çš„æ¼æã€‚TI å»ºè®®åœ¨æ¼æé™„è¿‘ä½¿ç”¨ Net Tie ä»¥å°½é‡å‡å°‘å¯èƒ½å¯¼è‡´é”™è¯¯ OCP æ•…éšœçš„é¢å¤–ç”µæ„Ÿï¼ˆè§å›¾ 6-14ï¼‰ã€‚\n\n![å›¾6-13 VDRAIN Kelvin è¿æ¥](/images/siva/6-13.png)\n\n![å›¾6-14 Net Tie é«˜ç«¯MOSFETçš„æ¼çº§](/images/siva/6-14.png)\n\n*æœ‰å…³ Kelvin è¿æ¥ï¼Œå‚è§*ï¼š[The basics of Kelvin connections](https://www.testandmeasurementtips.com/the-basics-of-kelvin-connections-faq/)\n\n*Net Tie æ˜¯ä¸€ç§åœ¨PCBè®¾è®¡ä¸­å°†ä¸¤ä¸ªæˆ–å¤šä¸ªä¸åŒçš„ç½‘ç»œåœ¨ç‰¹å®šä½ç½®è¿›è¡Œè¿æ¥çš„æŠ€æœ¯ï¼Œé€šå¸¸ç”¨äºç®¡ç†ä¸åŒç½‘ç»œä¹‹é—´çš„è¿æ¥å…³ç³»ã€‚å®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„å™¨ä»¶ï¼Œå½¢å¼ä¸Šå¯ä»¥è¡¨ç°ä¸ºä¸€å°æ®µè¿æ¥é“œçš®ã€è¿‡å­”æˆ–å…¶ä»–ç±»ä¼¼çš„ç»“æ„ã€‚æœ‰å…³æ›´å¤š ï¼Œå‚è§*ï¼š[Net Ties and How to Use Them](https://smtnet.com/library/files/upload/NetTies-and-How-to-Use-Them.pdf)\n\n# ç”µæµæ£€æµ‹æ”¾å¤§å™¨å¸ƒçº¿ï¼ˆCurrent Sense Amplifier Routingï¼‰\nTI çš„å„ç§ç”µæœºé©±åŠ¨å™¨éƒ½åŒ…å«å…·æœ‰å†…ç½®ç”µæµæ„Ÿåº”åŠŸèƒ½çš„å™¨ä»¶ï¼Œå…¶ä¸­å¤§å¤šæ•°ä½¿ç”¨å¤–éƒ¨åˆ†æµç”µé˜»ä½œä¸ºæµ‹é‡æºã€‚å°†ç”µæµæ„Ÿåº”æ”¾å¤§å™¨ä¸é©±åŠ¨å™¨ç»“åˆä½¿ç”¨ä¸ºç”µæœºæ¥å£æä¾›äº†ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆï¼Œå¹¶å…è®¸ä»¥æ›´ä½çš„æˆæœ¬å®ç°æ›´é«˜è´¨é‡çš„ç”µæµæ„Ÿåº”ã€‚å›¾ 7-1 æ˜¾ç¤ºäº†æ‰€æœ‰å¯ç”¨çš„ç”µæµæ„Ÿåº”æ‹“æ‰‘ã€‚\n\n![å›¾7-1 ç”µæµæ£€æµ‹æ‹“æ‰‘](/images/siva/7-1.png)\n\nè¿™äº›è®¾å¤‡å†…ç½®çš„é›†æˆç”µæµæ£€æµ‹æ”¾å¤§å™¨ (CSA) é€šå¸¸åˆ†ä¸ºä¸‰ç±»ï¼Œæ¯ç±»éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹ã€‚ä»¥ä¸‹å°†ä»‹ç»è¿™äº›ç±»åˆ«ã€‚\n\n## å•é«˜ç«¯ç”µæµåˆ†æµå™¨ï¼ˆSingle High-Side Current Shuntï¼‰\nå›¾ 7-2 æ˜¾ç¤ºäº†é«˜ç«¯ï¼ˆHigh-Sideï¼‰ç”µæµæ£€æµ‹ç”µè·¯ã€‚\n\n![å›¾7-2 é«˜ç«¯ç”µæµæ£€æµ‹](/images/siva/7-2.png)\n\nä½¿ç”¨é«˜ä¾§ç”µæµæ£€æµ‹çš„å¥½å¤„åŒ…æ‹¬ï¼š\n\n- ç›´æ¥æµ‹é‡ç”µæºç”µæµ\n\n- å¯ä»¥æ£€æµ‹è´Ÿè½½çŸ­è·¯\n\n- ä¸å—åœ°ï¼ˆGNDï¼‰å¹²æ‰°\n\nä½¿ç”¨é«˜ç«¯ç”µæµæ£€æµ‹çš„ç¼ºç‚¹æ˜¯å®ƒéœ€è¦æ›´å¤šçš„å…±æ¨¡ç”µå‹ã€‚\n\n## å•ä½ç«¯ç”µæµåˆ†æµå™¨ï¼ˆSingle Low-Side Current Shuntï¼‰\nå›¾ 7-3 æ˜¾ç¤ºäº†ä½ç«¯ç”µæµåˆ†æµç”µè·¯ã€‚\n\n![å›¾7-3 ä½ç«¯ç”µæµæ£€æµ‹](/images/siva/7-3.png)\n\nä½¿ç”¨ä½ä¾§ç”µæµåˆ†æµå™¨çš„å¥½å¤„æ˜¯å®ƒéœ€è¦çš„å…±æ¨¡ç”µå‹è¾ƒä½ã€‚\n\nä½¿ç”¨ä½ä¾§ç”µæµåˆ†æµå™¨çš„ç¼ºç‚¹æ˜¯å®ƒæ›´å®¹æ˜“å—åˆ°æ¥åœ°å™ªå£°çš„å½±å“ï¼Œå¹¶ä¸”æ— æ³•æ£€æµ‹æ¥åœ°çŸ­è·¯ã€‚\n\n## ä¸¤ç›¸å’Œä¸‰ç›¸ç”µæµåˆ†æµæ”¾å¤§å™¨ï¼ˆTwo-Phase and Three-Phase Current Shunt Amplifiersï¼‰\nå›¾ 7-4 æ˜¾ç¤ºäº†å…·æœ‰ä¸¤ç›¸å’Œä¸‰ç›¸ CSA çš„ç”µè·¯ã€‚\n\n![å›¾7-4 ä¸¤ç›¸å’Œä¸‰ç›¸ CSA ](/images/siva/7-4.png)\n\nä¸¤ç›¸å’Œä¸‰ç›¸ CSA å¯¹ç”µè·¯æ¿å¸ƒå±€æœ‰åˆ©ï¼Œå› ä¸ºå®ƒä»¬å¯¹å…±æ¨¡ç”µå‹çš„è¦æ±‚è¾ƒä½ã€‚å®ƒä»¬è¿˜å¯ä»¥å•ç‹¬æµ‹é‡æ¯ä¸ªé€šé“ï¼Œå› æ­¤å¯ç”¨äºæ›´å¤æ‚çš„æ§åˆ¶æ–¹æ¡ˆï¼Œä¾‹å¦‚ç£åœºå®šå‘æ§åˆ¶ã€‚\n\nåœ¨ç”µè·¯æ¿å¸ƒå±€ä¸­ä½¿ç”¨ä¸¤ç›¸å’Œä¸‰ç›¸ CSA çš„ç¼ºç‚¹åŒ…æ‹¬ï¼š\n\n- å¯¹æ¥åœ°å™ªå£°çš„æ•æ„Ÿæ€§æ›´é«˜\n- æ— æ³•æ£€æµ‹æ¥åœ°çŸ­è·¯\n- å¯èƒ½éœ€è¦æ›´å¤šè½¯ä»¶æ¥å®ç°æ€»ç³»ç»Ÿç”µæµ\n\n## å™¨ä»¶é€‰å‹\nåœ¨é€‰æ‹©æ£€æµ‹ç”µé˜»ï¼ˆç²¾å¯†ç”µé˜»ï¼‰æ—¶ï¼Œéœ€è¦åœ¨ç²¾åº¦å’ŒåŠŸè€—ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚ç”±äºåŠŸç‡çº§ä¸­çš„å¤§ç”µæµä¼šæµè¿‡æ£€æµ‹ç”µé˜»ï¼Œå› æ­¤æ‰€é€‰ç”µé˜»å€¼å¿…é¡»å¾ˆå°ï¼Œä»¥å°†åŠŸè€—ä¿æŒåœ¨æœ€ä½æ°´å¹³ã€‚å¯¹äºå¤§ç”µæµç³»ç»Ÿï¼Œç”µé˜»å€¼é€šå¸¸ä»¥ mÎ© ä¸ºå•ä½ã€‚ä¾‹å¦‚ï¼Œé©±åŠ¨ 20 A ç”µæµå¹¶ä½¿ç”¨ 1 mÎ© æ£€æµ‹ç”µé˜»çš„ç³»ç»Ÿå°†ä»è¯¥ç”µé˜»ä¸Šè€—æ•£ 400 mWã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCSA çš„è¾“å…¥ä»…æ¥æ”¶ 20 mV çš„ä¿¡å·ã€‚å¢åŠ ç”µé˜»å€¼å¯ä»¥æé«˜ä¿¡å™ªæ¯”ï¼Œä½†ä¹Ÿä¼šå¢åŠ åŠŸè€—ã€‚\n\nCSA çš„æ€§èƒ½å‚æ•°ä¹Ÿå¿…é¡»è€ƒè™‘ã€‚åœ¨é’ˆå¯¹ç³»ç»Ÿä¸­çš„æœ€åæƒ…å†µç”µæµè¿›è¡Œè®¾è®¡æ—¶ï¼Œæ‰€é€‰çš„åˆ†æµç”µé˜»åº”é˜²æ­¢ç”µæµæ£€æµ‹è¾“å…¥å¼•è„šä¸Šçš„ç”µå‹é«˜äº CSA çš„ç»å¯¹æœ€å¤§é¢å®šå€¼ã€‚åœ¨æ­£å¸¸è¿è¡ŒæœŸé—´ï¼Œæ­¤ç”µå‹å¿…é¡»ä¿æŒåœ¨å·®åˆ†ç”µå‹èŒƒå›´çš„æŒ‡å®šå‚æ•°èŒƒå›´å†…ã€‚è¦é€‰æ‹©æ£€æµ‹ç”µé˜»ï¼Œè¯·å‚é˜…å™¨ä»¶æ•°æ®è¡¨ã€‚\n\nå¯¹äºä½¿ç”¨å¤–éƒ¨å¢ç›Šç”µé˜»çš„å™¨ä»¶ï¼ˆä¾‹å¦‚ DRV3201-Q1ï¼‰ï¼Œè¯·é€‰æ‹©å…·æœ‰é«˜ç²¾åº¦çš„ç»„ä»¶ã€‚ç»„ä»¶ä¸åŒ¹é…ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„å…±æ¨¡å’Œå·®æ¨¡å¢ç›Šå‘ç”Ÿå¾ˆå¤§å˜åŒ–ã€‚\n\n## å™¨ä»¶æ”¾ç½®ï¼ˆPlacementï¼‰\næ£€æµ‹ç”µé˜»çš„æ”¾ç½®ä½ç½®åº”ä¸åŠŸç‡çº§çš„ç»„ä»¶ä¸€è‡´ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘èµ°çº¿é˜»æŠ—ã€‚åˆ†æµç”µé˜»ä¹Ÿåº”æ”¾ç½®åœ¨é è¿‘ CSA è¿æ¥çš„ä½ç½®ï¼Œä»¥é™ä½åœ¨ç”µè·¯æ¿ä¸Šå…¶ä»–èµ°çº¿ä¸Šè€¦åˆçš„å¯èƒ½æ€§ã€‚\n\nå¯¹äºé«˜ç«¯ç”µæµæ£€æµ‹ï¼Œåˆ†æµç”µé˜»åº”é è¿‘ç”µæºå’Œé«˜ç«¯ MOSFET æºæä¹‹é—´çš„æ˜Ÿç‚¹ã€‚å¯¹äºä½¿ç”¨å¤–éƒ¨å¢ç›Šç”µé˜»çš„é«˜ç«¯ç”µæµæ£€æµ‹è®¾å¤‡ï¼ˆä¾‹å¦‚ DRV3205-Q1ï¼‰ï¼Œåˆ†å‹å™¨ä¸­çš„ç¬¬ä¸€ä¸ªç”µé˜»åº”æ”¾ç½®åœ¨æœ€é è¿‘åˆ†æµç”µé˜»çš„ä½ç½®ã€‚å…¶ä½™ç»„ä»¶åº”æ”¾ç½®åœ¨æœ€é è¿‘è®¾å¤‡çš„ä½ç½®ã€‚\n\nå¯¹äºä½ç«¯ç”µæµæ£€æµ‹ï¼Œåˆ†æµç”µé˜»åº”ä½äºä½ç«¯ MOSFET çš„æºæå’ŒåŠŸç‡çº§çš„æ˜Ÿç‚¹æ¥åœ°è¿æ¥ä¹‹é—´ã€‚\n\nå¯¹äºåœ¨ä¸¤ä¸ªæˆ–ä¸‰ä¸ªå•ç‹¬ç›¸ä½ä¸Šå…·æœ‰åˆ†æµç”µé˜»çš„ç³»ç»Ÿï¼Œåˆ†æµç”µé˜»åº”æ”¾ç½®åœ¨ç›¸åº”ä½ç«¯ MOSFET çš„æºæå’Œæ˜Ÿç‚¹æ¥åœ°è¿æ¥ä¹‹é—´ã€‚\n\n## å¸ƒçº¿ï¼ˆRoutingï¼‰\n**å¿…é¡»ä½¿ç”¨å·®åˆ†å¯¹æ¥è·¯ç”±æ£€æµ‹ä¿¡å·**ã€‚åœ¨å·®åˆ†å¯¹ä¸­ï¼Œä¸¤ä¸ªä¿¡å·åœ¨å¸ƒå±€ä¸­ç´§å¯†è€¦åˆï¼Œå¹¶ä¸”èµ°çº¿å¿…é¡»ä»åˆ†æµå™¨æˆ–æ£€æµ‹ç”µé˜»å™¨å¹³è¡Œå»¶ä¼¸åˆ° IC è¾“å…¥ç«¯çš„ CSAã€‚\n\n![å›¾7-5 CSA å¸ƒçº¿ ](/images/siva/7-5.png)\n\n## å®ç”¨å·¥å…·ï¼ˆNet Tie å’Œ å·®åˆ†å¯¹ï¼‰\nè®¸å¤šç°ä»£ CAD å·¥å…·éƒ½å®ç°äº†å¯å¸®åŠ©å¸ƒå±€å·¥ç¨‹å¸ˆæ­£ç¡®å¸ƒçº¿ PCB çš„åŠŸèƒ½ã€‚æœ¬èŠ‚ä¸­ä»‹ç»çš„åŠŸèƒ½æ˜¯ Altium Designer å·¥å…·çš„ä¸€éƒ¨åˆ†ï¼›ä½†æ˜¯ï¼Œè®¸å¤šå…¶ä»–å·¥å…·ä¹Ÿå…·æœ‰ç±»ä¼¼çš„åŠŸèƒ½ã€‚\n\nåœ¨åˆå§‹é˜¶æ®µå¸ƒçº¿ PCB æ—¶ï¼Œæœ‰åŠ©äºæ˜¾ç¤ºå“ªäº›ç»„ä»¶å¸ƒçº¿åˆ°å“ªé‡Œçš„æŒ‡å—åœ¨æ£€æµ‹ç”µé˜»å¸ƒçº¿çš„æƒ…å†µä¸‹å¯èƒ½ä¼šäº§ç”Ÿè¯¯å¯¼ã€‚åœ¨ä½ä¾§åˆ†æµç”µé˜»çš„æƒ…å†µä¸‹ï¼Œè´Ÿè¾“å…¥å¯ä»¥ç›´æ¥æ¥åœ°ï¼Œè€Œæ­£è¾“å…¥å¯ä»¥ç›´æ¥è¿æ¥åˆ°ä½ä¾§æºæå¼•è„šã€‚ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œè¯·åœ¨è®¾å¤‡å’Œåˆ†æµç”µé˜»ä¹‹é—´æ”¾ç½®ä¸€ä¸ª Net Tieï¼Œä»¥ä¾¿è®¾è®¡äººå‘˜å¯ä»¥åœ¨æ”¾ç½®æœŸé—´è€Œä¸æ˜¯å¸ƒçº¿æœŸé—´æ”¾ç½®å¸ƒçº¿é™åˆ¶ã€‚å›¾ 7-6 æ˜¾ç¤ºäº† Net Tie æ”¾ç½®çš„ç¤ºä¾‹ã€‚\n\n![å›¾7-6 Net Tie æ”¾ç½®æ ·ä¾‹](/images/siva/7-6.png)\n\nä½¿ç”¨å·®åˆ†å¯¹çš„å¸ƒå±€æŠ€æœ¯é€šè¿‡å¹¶è¡Œå¸ƒçº¿ä¸¤ä¸ªç´§å¯†è€¦åˆçš„ä¿¡å·æ¥é™ä½å…±æ¨¡å™ªå£°ã€‚TI å»ºè®®ä½¿ç”¨å·®åˆ†å¯¹å°†ä¿¡å·ä»åˆ†æµç”µé˜»å¸ƒçº¿åˆ° CSAã€‚ä¸ºäº†è¿›ä¸€æ­¥é™ä½å™ªå£°è€¦åˆï¼Œè¯·å‹¿å°†å™ªå£°æ•æ„Ÿçš„èµ°çº¿ä¸å™ªå£°ï¼ˆå¼€å…³ï¼‰ä¿¡å·å¹¶è¡Œå¸ƒçº¿ã€‚\n\n## è¾“å…¥å’Œè¾“å‡ºè¿‡æ»¤ï¼ˆInput and Output Filtersï¼‰\næ„Ÿæµ‹æ”¾å¤§å™¨çš„è¾“å…¥å’Œè¾“å‡ºæ»¤æ³¢å™¨å°½å¯èƒ½é è¿‘æ„Ÿæµ‹æ”¾å¤§å™¨ã€‚è¿™ç§æ”¾ç½®æ–¹å¼å¯ç¡®ä¿è®¾å¤‡æ¥æ”¶åˆ°çš„ä¸éœ€è¦çš„å™ªå£°è¢«é™åˆ¶åœ¨æ»¤æ³¢å™¨å’Œæ„Ÿæµ‹æ”¾å¤§å™¨ä¹‹é—´ã€‚å›¾ 7-7 æ˜¾ç¤ºäº†è¾“å…¥æ»¤æ³¢å™¨ï¼ˆC40ã€R30 å’Œ R31ï¼‰çš„ç¤ºä¾‹å¸ƒå±€ã€‚\n\n![å›¾7-7 è¾“å…¥å’Œè¾“å‡ºè¿‡æ»¤åŸç†å›¾](/images/siva/7-7.png)\n\n![å›¾7-8 è¾“å…¥å’Œè¾“å‡ºè¿‡æ»¤Layout](/images/siva/7-8.png)\n\n## CSA å°ç»“\nè®¾è®¡ç”µæœºé©±åŠ¨å™¨çš„ç”µè·¯æ¿å¸ƒå±€æ—¶ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n- ä½¿ç”¨å¼€å°”æ–‡è¿æ¥\n- ä½¿å¸ƒå±€å¯¹ç§°\n- ä½¿ç”¨ Net Ties å’Œå·®åˆ†å¸ƒçº¿å·¥å…·\n\n\n","categories":["ç”µå­ä¸ç”µè·¯è®¾è®¡"]},{"title":"ç®€å•Hæ¡¥ç”µæœºé©±åŠ¨ç”µè·¯åˆ†æåŠå…¶éš”ç¦»è®¾è®¡","url":"/2024/08/12/ç®€å•Hæ¡¥ç”µæœºé©±åŠ¨ç”µè·¯åˆ†æåŠå…¶éš”ç¦»è®¾è®¡/","content":"# Hæ¡¥é©±åŠ¨ç”µè·¯ï¼ˆH-Bridge Circuitï¼‰\nHæ¡¥æ˜¯ä¸€ç§ç›¸å½“ç®€å•çš„ç”µè·¯ã€‚å®ƒåŒ…å«å››ä¸ªç‹¬ç«‹æ§åˆ¶çš„MOSFETï¼Œç”¨ä½œå¼•å¯¼ç”µæµæµè¿‡è´Ÿè½½ï¼ˆé€šå¸¸æ˜¯ç”µæ„Ÿè´Ÿè½½ï¼Œä¾‹å¦‚ç”µæœºï¼‰çš„å¼€å…³å…ƒä»¶ã€‚\n\n![Hæ¡¥ç”µè·¯æ‹“æ‰‘å›¾](/images/H/1.png)\n\nå…·ä½“çš„å·¥ä½œæ–¹å¼ä¸å†èµ˜è¿°ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æä¸€äº›æ¯”è¾ƒç»†èŠ‚çš„ç‚¹ã€‚\n\n## MOSFETä¸­çš„å¯„ç”ŸäºŒæç®¡ä¸å¤–éƒ¨ç»­æµäºŒæç®¡\nåœ¨Næ²Ÿé“MOSFETä¸­ï¼Œæºæå’Œæ¼æé€šå¸¸æ˜¯Nå‹åŒºåŸŸï¼Œè€ŒåŸºåŒºæ˜¯På‹ææ–™ã€‚è¿™äº›åŒºåŸŸä¹‹é—´å½¢æˆäº†ä¸¤ä¸ªPNç»“ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯åœ¨æºæä¸åŸºåŒºä¹‹é—´ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨æ¼æä¸åŸºåŒºä¹‹é—´ã€‚ç”±äºåœ¨MOSFETä¸­ï¼Œæºæå’ŒåŸºåŒºé€šå¸¸æ˜¯çŸ­æ¥çš„ï¼Œå› æ­¤æºæ-åŸºåŒºçš„PNç»“ä¸ä¼šèµ·ä½œç”¨ï¼Œè€Œæ¼æ-åŸºåŒºçš„PNç»“åˆ™å½¢æˆäº†å¯„ç”ŸäºŒæç®¡ã€‚è¯¥ç°è±¡åœ¨å¤§å¤šæ•°åŠŸç‡MOSFETä¸­éƒ½ä¼šå‡ºç°ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸€äº›ä»¿çœŸè½¯ä»¶ä¸­ï¼ŒMOSFETçš„æ‹“æ‰‘ç¬¦å·åä¼šæœ‰ä¸€ä¸ªåå‘å¹¶è”çš„äºŒæç®¡æ ‡è¯†ã€‚\n\n\nä½œä¸ºå…¸å‹çš„æ„Ÿæ€§è´Ÿè½½ï¼Œç”µæœºåœ¨ç”µæµå˜åŒ–æ—¶ä¼šäº§ç”Ÿåç”µåŠ¨åŠ¿ã€‚å½“Hæ¡¥ä¸­çš„MOSFETåˆ‡æ¢çŠ¶æ€æ—¶ï¼Œç”µæµçš„å˜åŒ–ä¼šå¯¼è‡´ç”µæ„Ÿè´Ÿè½½äº§ç”Ÿä¸€ä¸ªé«˜ç”µå‹å°–å³°ã€‚è¿™ç§ç”µå‹å°–å³°å¯èƒ½ä¼šåå‘æ–½åŠ åœ¨MOSFETä¸Šï¼Œå¯èƒ½å¯¼è‡´MOSFETæŸåæˆ–é€ æˆä¸ç¨³å®šçš„ç”µè·¯æ“ä½œã€‚\n\nä¸ºäº†ä¿æŠ¤MOSFETå’Œå…¶ä»–ç”µè·¯å…ƒä»¶ï¼Œåœ¨æ¯ä¸ªMOSFETçš„æ¼æå’Œæºæä¹‹é—´é€šå¸¸ä¼šå¹¶è”ä¸€ä¸ªç»­æµäºŒæç®¡ã€‚ç»­æµäºŒæç®¡çš„ä½œç”¨ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š\n\n- **æä¾›ç”µæµç»­æµè·¯å¾„**ï¼šå½“MOSFETå…³é—­æ—¶ï¼Œæ„Ÿæ€§è´Ÿè½½çš„ç”µæµæ— æ³•ç«‹å³åœæ­¢ï¼Œç»­æµäºŒæç®¡ä¸ºè¯¥ç”µæµæä¾›äº†ä¸€ä¸ªé€šè·¯ã€‚è¿™æ ·å¯ä»¥é¿å…å› ç”µæµä¸­æ–­å¯¼è‡´çš„é«˜ç”µå‹å°–å³°ï¼Œä»è€Œä¿æŠ¤MOSFETå’Œå…¶ä»–ç”µè·¯å…ƒä»¶ã€‚\n\n- **ä¿æŠ¤MOSFET**ï¼šç»­æµäºŒæç®¡å¯ä»¥é™åˆ¶æ„Ÿæ€§è´Ÿè½½äº§ç”Ÿçš„åç”µåŠ¨åŠ¿ï¼Œé¿å…è¿™äº›ç”µå‹å°–å³°ç›´æ¥åŠ åœ¨MOSFETä¸Šï¼Œé˜²æ­¢MOSFETå› è¿‡å‹è€ŒæŸåã€‚\n\n- **ç¨³å®šç”µè·¯æ“ä½œ**ï¼šåœ¨é«˜é¢‘å¼€å…³æ“ä½œä¸­ï¼Œç»­æµäºŒæç®¡å¯ä»¥å‡å°‘ç”µè·¯ä¸­çš„ç”µç£å¹²æ‰°ï¼ˆEMIï¼‰å’Œå™ªå£°ï¼Œæé«˜ç”µè·¯çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚\n\nMOSFETè‡ªå¸¦çš„å¯„ç”ŸäºŒæç®¡åœ¨ç”µè·¯ä¸­ç¡®å®å¯ä»¥åœ¨æŸäº›æƒ…å†µä¸‹èµ·åˆ°ç»­æµäºŒæç®¡çš„ä½œç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¼€å…³æ–­å¼€çš„ç¬é—´ï¼Œå®ƒå¯ä»¥ä¸ºç”µæ„Ÿæ€§è´Ÿè½½æä¾›ç”µæµç»­æµçš„è·¯å¾„ã€‚ç„¶è€Œï¼Œç”±äºå¯„ç”ŸäºŒæç®¡çš„ç‰¹æ€§ä¸å¦‚ä¸“é—¨è®¾è®¡çš„ç»­æµäºŒæç®¡ï¼ˆä¾‹å¦‚è‚–ç‰¹åŸºäºŒæç®¡ï¼‰ï¼Œå®ƒçš„å¯¼é€šç”µå‹è¾ƒé«˜ï¼Œåå‘æ¢å¤æ—¶é—´è¾ƒé•¿ï¼Œæ‰€ä»¥åœ¨å®é™…ç”µè·¯è®¾è®¡ä¸­ï¼Œå¯„ç”ŸäºŒæç®¡å¾€å¾€ä¸èƒ½å®Œå…¨æ›¿ä»£ç»­æµäºŒæç®¡ã€‚å› æ­¤ï¼Œå¦‚æœå¯¹ç»­æµäºŒæç®¡æœ‰ä¸¥æ ¼çš„è¦æ±‚ï¼Œé€šå¸¸ä¼šåœ¨ç”µè·¯ä¸­å¦å¤–å¹¶è”ä¸€ä¸ªæ€§èƒ½æ›´å¥½çš„äºŒæç®¡ã€‚\n\n![ä¸€ä¸ªHæ¡¥ä¸Šè‡‚MOSFETä¸¤ç«¯å¹¶è”çš„ç»­æµäºŒæç®¡](/images/H/2.png)\n\n## ç”µæµè¡°å‡æ¨¡å¼\nç”µæœºæ˜¯æ„Ÿæ€§è´Ÿè½½ï¼Œç”µæµä¸èƒ½çªå˜ã€‚è‹¥è¦ä½¿ç”µæœºå‡é€Ÿï¼Œåœ¨æ–­å¼€ç”µæœºä¸¤ç«¯æ‰€åŠ çš„ç”µå‹æ—¶ï¼Œç”µå‹ç”±å·¥ä½œå€¼ç¬é—´è¡°å‡è‡³é›¶ï¼Œæ ¹æ®ç”µç£æ„Ÿåº”å®šå¾‹ï¼Œç”µæœºä¼šæ ¹æ®ç”µå‹å˜åŒ–ç‡ï¼ˆ$du/dt$ï¼‰çš„å¤§å°è€Œäº§ç”Ÿåå‘ç”µåŠ¨åŠ¿ã€‚å½“ç”µå‹å˜åŒ–ç‡å¾ˆå¤§æ—¶ï¼Œè¿™ä¸ªåç”µåŠ¨åŠ¿å¾ˆæœ‰å¯èƒ½æŸåMOSFETã€‚å› æ­¤æƒ³è®©ç”µæœºåœä¸‹ï¼Œé™¤äº†æ–­å¼€ä¾›ç”µï¼Œè¿˜è¦å½¢æˆä¸€ä¸ªç»­æµçš„å›è·¯ï¼Œé‡Šæ”¾æ‰ç”µæœºä¸Šçš„èƒ½é‡ã€‚è¿™å°±æ˜¯åˆšåˆšæåˆ°è¿‡çš„ç»­æµäºŒæç®¡çš„ä½œç”¨ã€‚\n\nåœ¨å‡é€Ÿæ—¶çš„ç”µæµå†ç”Ÿè¿‡ç¨‹ä¸­ï¼ŒHæ¡¥é€šå¸¸å¯ä»¥å·¥ä½œåœ¨ä¸¤ä¸ªæ¨¡å¼ï¼š\n- å¿«é€Ÿè¡°å‡ï¼ˆFast Decay Modeï¼‰\n\n- æ…¢é€Ÿè¡°å‡ï¼ˆSlow Decay Modeï¼‰\n\n*æ³¨æ„*ï¼šâ€œè¡°å‡â€æŒ‡çš„æ˜¯æµè¿‡ç”µæœºçº¿åœˆï¼ˆç”µæ„Ÿå™¨ï¼‰çš„ç”µæµï¼Œä¸ç”µæœºçš„è¡Œä¸ºæ²¡æœ‰ç›´æ¥å…³ç³»ã€‚ä¸è¦è®¤ä¸ºå¿«é€Ÿè¡°å‡ä¼šä½¿ç”µæœºè¿…é€Ÿåœæ­¢ã€‚\n\n![ä¸åŒè¡°å‡æ¨¡å¼ä¸‹çš„ç”µæµå›è·¯ç¤ºæ„å›¾](/images/H/3.png)\n\n### å¿«é€Ÿè¡°å‡æ¨¡å¼ï¼ˆFast Decay Modeï¼‰\n\n![å¿«é€Ÿè¡°å‡æ¨¡å¼](/images/H/4.png)\n\nè¯¥æ¨¡å¼ä¸‹ï¼Œå››ä¸ªMOSFETå…¨éƒ¨å…³æ–­ï¼Œåç”µåŠ¨åŠ¿å¸¦æ¥çš„åå‘æ„Ÿåº”ç”µæµé€šè¿‡Q2ã€Q3çš„å¯„ç”ŸäºŒæç®¡ï¼ˆç»­æµäºŒæç®¡ï¼‰æµåŠ¨ï¼Œæ­¤æ—¶åç”µåŠ¨åŠ¿å¸¦æ¥çš„æ„Ÿåº”ç”µæµæ–¹å‘ä¸ç”µæºç”µå‹æ–¹å‘ç›¸åï¼Œçº¿åœˆç”µæµè¿…é€Ÿè¡°å‡ã€‚\n\nä¸ºé¿å…åŒä¸€ä¾§çš„ä¸Šä¸‹è‡‚MOSFETåŒæ—¶å¯¼é€šè€Œé€ æˆå‡»ç©¿ï¼Œåº”å½“é‡‡å–æœºåˆ¶ã€‚å…·ä½“ä¸ºï¼Œæ·»åŠ ä¸€ä¸ªä»¤æ‰€æœ‰FETå¼€å…³å‡å¤„äºå…³é—­çŠ¶æ€çš„æ—¶é—´æ®µï¼ˆè¢«ç§°ä¸º**æ­»åŒºæ—¶é—´**ï¼‰ã€‚åœ¨æ­¤æœŸé—´ï¼Œå…è®¸æ¿€åŠ±FETå¼€å…³åˆ‡æ¢åˆ°å…³é—­çŠ¶æ€ï¼Œå­˜åœ¨ç”µæ„Ÿè´Ÿè½½çš„ç”µæµç”±å¯„ç”ŸäºŒæç®¡æˆ–å¤–éƒ¨ç»­æµè‚–ç‰¹åŸºäºŒæç®¡æ‰¿è½½ã€‚\n\nå¿«é€Ÿè¡°å‡æ¨¡å¼ä¸‹ç”µæµè™½ç„¶èƒ½å¤Ÿè¿…é€Ÿé™ä½åˆ°é›¶ï¼Œä½†ç”µæœºé€Ÿåº¦ä¼šå› æƒ¯æ€§è€Œé€æ¸å‡å°ï¼Œå¯¹å¤–å‘ˆç°â€œæ»‘åŠ¨â€å¼çš„å‡é€Ÿã€‚\n\n### æ…¢è¡°å‡æ¨¡å¼ï¼ˆSlow Decay Modeï¼‰\n\n![æ…¢è¡°å‡æ¨¡å¼](/images/H/5.png)\n\nè¯¥æ¨¡å¼ä¸‹ï¼ŒQ1ã€Q3å…³æ–­ï¼ŒQ2ã€Q4å¯¼é€šï¼Œæ„Ÿåº”ç”µæµä»¥å¾ªç¯æ–¹å¼åœ¨æµç»Q2å’ŒQ4æ—¶é™è‡³é›¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”µæµåœ¨æµè¿‡ç”µæ„Ÿé˜»æŠ—å’Œä¸¤ä¸ªFETçš„å¯¼é€šé˜»æŠ—æ—¶ä»¥çƒ­é‡çš„å½¢å¼è€—æ•£ã€‚\n\n*æ³¨æ„*ï¼šè™½ç„¶æ…¢é€Ÿè¡°å‡é€šå¸¸æè¿°ä¸ºä¸¤ä¸ªä½ä¾§FETå¼€å…³æ‰“å¼€ã€ä¸¤ä¸ªé«˜ä¾§FETå¼€å…³å…³é—­ï¼Œä½†ç›¸åŒç°è±¡å¯é€šè¿‡å¯ç”¨ä¸¤ä¸ªé«˜ä¾§ FET å¼€å…³ã€åŒæ—¶ç¦ç”¨ä¸¤ä¸ªä½ä¾§FETå¼€å…³æ¥å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¡°å‡å›è·¯å¯ä»¥ä¸ºä¸Šè‡‚ï¼Œä¹Ÿå¯ä»¥ä¸ºä¸‹è‡‚ã€‚éƒ¨åˆ†ICæ”¯æŒé€šè¿‡ç›¸åº”çš„è¾“å…¥ä¿¡å·æ¥é…ç½®ã€‚\n\nåœ¨ç›´æµç”µæœºä¸Šï¼Œæ…¢é€Ÿè¡°å‡æ¨¡å¼ä¼šä»¤ç”µæœºç»•ç»„çŸ­è·¯ï¼Œè¿›è€Œå½¢æˆåç”µåŠ¨åŠ¿çŸ­è·¯ï¼Œä½¿å¾—è½¬å­ä»¥æå¿«é€Ÿåº¦åœæ­¢æ—‹è½¬ã€‚\n\n### æ··åˆè¡°å‡ï¼ˆMixed Decay Modeï¼‰\nåœ¨æ··åˆè¡°å‡å†å¾ªç¯æ¨¡å¼ä¸­ï¼Œç”µæµè¡°å‡è‡³é›¶çš„é€Ÿåº¦å¿«äºæ…¢é€Ÿè¡°å‡æ–¹æ³•ï¼Œä½†æ…¢äºå¿«é€Ÿè¡°å‡æ–¹æ³•ã€‚å®ç°æ­¤æŠ€æœ¯çš„æ–¹æ³•æ˜¯ï¼Œåè°ƒFETå¼€å…³çš„å¼€/å…³æ—¶é—´ï¼Œåœ¨å›ºå®šæ—¶é—´å†…å¤„äºå¿«é€Ÿè¡°å‡æ¨¡å¼ï¼Œç„¶ååœ¨å‰©ä½™æ—¶é—´å†…å¤„äºæ…¢é€Ÿè¡°å‡æ¨¡å¼ã€‚ç³»ç»Ÿä¿æŒåœ¨å¿«é€Ÿè¡°å‡æ¨¡å¼ä¸æ…¢é€Ÿè¡°å‡æ¨¡å¼ä¸­çš„æ—¶é—´æ¯”ä¾‹è¢«ç§°ä¸ºæ··åˆè¡°å‡ç™¾åˆ†æ¯”ã€‚\n\næ··åˆè¡°å‡å¯¹äºæ­¥è¿›ç”µæœºé©±åŠ¨å¾ˆæœ‰æ„ä¹‰ï¼Œä½†æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå¯¹å¾®æ­¥è¿›é©±åŠ¨ææœ‰æ„ä¹‰ã€‚åœ¨å¾®æ­¥è¿›æ—¶ï¼Œå°†ä¿æŒä¸€å®šæ³¢å½¢ä»¥è·å¾—å‡ºè‰²çš„è¿åŠ¨è´¨é‡ã€‚ä¾‹å¦‚ï¼Œé€šå¸¸ä¼šé€šè¿‡æ­£å¼¦æ³¢ï¼ˆç”µæµæ›²çº¿ï¼‰æ¥é©±åŠ¨æ­¥è¿›ç”µæœºç»•ç»„ã€‚ä¹Ÿå¯ä»¥åœ¨ç›¸åŒèŒƒå›´å†…ä½¿ç”¨ä¸‰è§’å½¢å’Œè±å½¢ã€‚\n\næœ‰å…³æ··åˆè¡°å‡çš„å†…å®¹å°†å¦ä½œä»‹ç»ã€‚\n\n## MOSFETé«˜ä½ç«¯é©±åŠ¨ä¸è‡ªä¸¾ç”µè·¯\nåœ¨Hæ¡¥ç”µè·¯ä¸­ï¼ŒMOSFETé€šå¸¸åˆ†ä¸ºé«˜ç«¯ï¼ˆHigh-Sideï¼‰å’Œä½ç«¯ï¼ˆLow-Sideï¼‰ä¸¤ä¸ªéƒ¨åˆ†ï¼š\n\n- **é«˜ç«¯MOSFETï¼ˆHigh-Side MOSFETï¼‰**ï¼š è¿æ¥åœ¨ç”µæºå’Œè´Ÿè½½ä¹‹é—´çš„MOSFETã€‚\n\n- **ä½ç«¯MOSFETï¼ˆLow-Side MOSFETï¼‰**ï¼š è¿æ¥åœ¨è´Ÿè½½å’Œåœ°ä¹‹é—´çš„MOSFETã€‚\n\nå·²çŸ¥MOSFETå¯¼é€šéœ€è¦æ»¡è¶³\n\n$$\nV_{GS}>V_{GS(th)}\n$$\n\nå¯¹äºä½ç«¯MOSFETï¼Œæºæé€šå¸¸æ¥åœ°ï¼Œå› æ­¤æé«˜é©±åŠ¨ç”µå‹ä½¿å¾—$V_{GS}>V_{GS(th)}$æ¯”è¾ƒå®¹æ˜“å®ç°ã€‚è€Œå¯¹äºé«˜ç«¯MOSFETï¼Œæºæä¸è´Ÿè½½ç›¸è¿ï¼Œä¸”æºæç”µä½é€šå¸¸é«˜äºåœ°ç”µä½ï¼Œå› æ­¤å¯¹æ …æç›´æ¥é©±åŠ¨éœ€è¦ä¸€ä¸ªæ¯”ç”µæºç”µå‹æ›´é«˜çš„ç”µå‹æ¥å¯¼é€šMOSFETã€‚è¿™å°±éœ€è¦ç‰¹æ®Šçš„é«˜ç«¯é©±åŠ¨ç”µè·¯æ¥ç”Ÿæˆè¿™ä¸ªè¾ƒé«˜çš„æ …æé©±åŠ¨ç”µå‹ã€‚\n\nè‡ªä¸¾ç”µè·¯æ˜¯å¸¸ç”¨çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œç”¨äºç”Ÿæˆé«˜ç«¯MOSFETæ‰€éœ€çš„é«˜ç”µå‹é©±åŠ¨ä¿¡å·ã€‚å®ƒé€šå¸¸åŒ…æ‹¬ä¸€ä¸ªäºŒæç®¡å’Œä¸€ä¸ªç”µå®¹å™¨ï¼ˆè‡ªä¸¾ç”µå®¹ï¼‰ï¼Œé…åˆé©±åŠ¨èŠ¯ç‰‡å·¥ä½œã€‚\n\nä»¥åŠæ¡¥ä¸ºä¾‹ï¼Œå½“Q2å¯¼é€šæ—¶ï¼ŒQ1çš„æºæè¢«æ‹‰åˆ°åœ°ç”µä½ï¼ˆä½ç”µå¹³ï¼‰ã€‚æ­¤æ—¶ï¼Œè‡ªä¸¾ç”µå®¹C1é€šè¿‡äºŒæç®¡å……ç”µï¼ˆæ­¤å¤„æ‰€åŠ ç”µå‹Vä¸€èˆ¬ç”±LDOæ¶æ„ç”µæºè¾“å‡ºï¼‰ã€‚æ­¤æ—¶ï¼Œè‡ªä¸¾ç”µå®¹çš„ç”µå‹æ¥è¿‘äºç”µæºç”µå‹Vã€‚\n\n![è‡ªä¸¾ç”µå®¹å……ç”µ](/images/H/6.png)\n\nå½“Q2æ–­å¼€æ—¶ï¼ŒSWä½ç½®ç”µä½ä¸å†ä¸ºåœ°ç”µä½ï¼Œè€Œè‡ªä¸¾ç”µå®¹C1ä¸¤ç«¯å‚¨å­˜äº†å¤§å°ä¸ºVçš„ç”µå‹ï¼ŒAç‚¹ç”µå‹å˜ä¸º$V_{SW}+V$ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å¤Ÿé©±åŠ¨é«˜ç«¯MOSFETã€‚æ­¤æ—¶ç”±C1æä¾›ä¸Šç®¡é©±åŠ¨é˜¶æ®µæ‰€éœ€çš„æ‰€æœ‰ç”µæµã€‚æ­¤æ—¶è‡ªä¸¾äºŒæç®¡ï¼ˆä¸€èˆ¬ä¸ºè‚–ç‰¹åŸºäºŒæç®¡ï¼‰å¤„äºåå‘æˆªæ­¢çŠ¶æ€ï¼Œå°†è‡ªä¸¾å‹é™é™åˆ¶åœ¨è‡ªä¸¾å›è·¯å†…ï¼Œé˜²æ­¢å…¶å›æµè‡³ä¸Šä¸€çº§ä»è€ŒæŸåç”µè·¯ã€‚\n\n![è‡ªä¸¾ç”µå®¹æ”¾ç”µ](/images/H/7.png)\n\nå‚è§ï¼š[Hæ¡¥è‡ªä¸¾ç”µè·¯åˆ†æ](https://blog.csdn.net/qq_44897194/article/details/107397079?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-107397079-blog-110673237.235^v43^pc_blog_bottom_relevance_base6&spm=1001.2101.3001.4242.1&utm_relevant_index=3)\n\nè‡ªä¸¾ç”µå®¹æŒç»­æ”¾ç”µå°†ä¼šå¯¼è‡´é«˜ç«¯MOSFETçš„æ …æå¯¹åœ°ç”µå‹æŒç»­å‡å°ï¼Œç›´è‡³å…¶ç­‰äºVã€‚å› æ­¤è¦è®©é«˜ç«¯MOSFETæŒç»­å¯¼é€šï¼Œéœ€è¦ä»¤è‡ªä¸¾ç”µå®¹ä¸æ–­å……æ”¾ç”µï¼Œæˆ–æ˜¯å¢åŠ è‡ªä¸¾ç”µå®¹å®¹é‡ã€æ›´æ¢ICæˆ–åœ¨è®¾è®¡ä¸­é¿å…æŒç»­å¯¼é€šéœ€æ±‚ã€‚ç”±äºMOSFETçš„ç‰¹æ€§ï¼Œè‡ªä¸¾ç”µè·¯åœ¨å¢åŠ æ …æºç”µå‹çš„åŒæ—¶ï¼Œè¿˜å¯ä»¤MOSFETçš„å¯¼é€šç”µé˜»å‡å°ï¼Œä»è€Œå‡å°‘å‘çƒ­æŸè€—ã€‚\n\n## Hæ¡¥é©±åŠ¨æ§åˆ¶\nå¯¹MOSFETæ …æå¼•å…¥PWMæ§åˆ¶ï¼Œå¯å®ç°å¯¹ç”µæœºè½¬åŠ¨æ–¹å‘å’Œé€Ÿåº¦çš„è°ƒèŠ‚ã€‚PWMçš„å ç©ºæ¯”å¯¹åº”ç”µæœºè½¬é€Ÿï¼Œå ç©ºæ¯”è¶Šå¤§ï¼Œå¹³å‡ç­‰æ•ˆè¾“å‡ºç”µå‹è¶Šå¤§ï¼Œè½¬é€Ÿè¶Šå¿«ã€‚é€šå¸¸çš„PWMé¢‘ç‡åœ¨10Khzè‡³20KHzä¹‹é—´ã€‚è‹¥é¢‘ç‡å¤ªä½ï¼Œç”µæœºè½¬é€Ÿä¼šè¿‡ä½ï¼ŒåŒæ—¶å®¹æ˜“å‡ºç°é«˜å™ªå£°æˆ–é«˜é¢‘æœºæ¢°æŒ¯åŠ¨ï¼›é¢‘ç‡å¤ªé«˜ï¼Œåˆ™MOSFETå¼€å…³æŸè€—å¸¦æ¥çš„å½±å“ä¼šå˜å¤§ï¼Œé™ä½ç³»ç»Ÿæ•ˆç‡ã€‚\n\næ ¹æ®ä¸åŒæ¡¥è‡‚çš„PWMæ§åˆ¶æ–¹å¼ï¼Œå¤§è‡´ä¸Šå¯åˆ†ä¸ºä¸‰ç§ï¼š\n\n- å—é™å•ææ¨¡å¼\n\n- å•ææ¨¡å¼\n\n- åŒææ¨¡å¼\n\n### å—é™å•ææ¨¡å¼\n\nè¯¥æ¨¡å¼ä¸‹ï¼Œç”µæœºç”µæ¢é©±åŠ¨ç”µå‹ææ€§æ˜¯å•ä¸€çš„ï¼Œä¼˜ç‚¹æ˜¯æ§åˆ¶ç”µè·¯è¾ƒä¸ºç®€å•ï¼Œç¼ºç‚¹æ˜¯ç”µæœºä¸èƒ½åˆ¹è½¦ï¼Œä¸èƒ½è¿›è¡Œèƒ½è€—åˆ¶åŠ¨ï¼Œåœ¨è´Ÿè½½è¶…è¿‡è®¾å®šé€Ÿåº¦æ—¶ä¸èƒ½æä¾›å‘åŠ›çŸ©ã€‚è°ƒé€Ÿé™å·®å¤§ï¼Œè°ƒé€Ÿæ€§èƒ½å¾ˆå·®ï¼Œç¨³å®šæ€§ä¹Ÿä¸å¥½ã€‚å½“PWMé«˜ç”µå¹³æ—¶ï¼Œç”µæœºä¸¤ç«¯åˆ†åˆ«ä¸ºVMå’ŒGNDï¼Œæœ‰ç”µæµæµè¿‡ï¼Œç”µæœºäº§ç”Ÿæ‰­çŸ©ï¼Œè¿›è¡Œè½¬åŠ¨ã€‚å½“PWMä½ç”µå¹³æ—¶ï¼Œç”µæœºä¸¤ç«¯æœªå¯¼é€šï¼Œä¸å½¢æˆé—­åˆå›è·¯ï¼Œæ²¡æœ‰ç”µæµæµè¿‡ï¼Œæ­¤æ—¶ç”µæœºçš„è½¬åŠ¨æ²¡æœ‰åŠ›æ¥ç»´æŒï¼Œéš¾ä»¥æ§åˆ¶ã€‚\n\n### å•ææ¨¡å¼\n\nå•ææ¨¡å¼å¼•å…¥äº’è¡¥PWMæ³¢ï¼ˆPWMNï¼‰ï¼Œå…¶ä¸€èˆ¬ç”±MCUé«˜çº§å®šæ—¶å™¨ç”Ÿæˆï¼Œå¦‚STM32F429çš„TIM1ã€TIM8ã€‚\n\n![PWMå•ææ¨¡å¼](/images/H/8.png)\n\nç›¸æ¯”å—é™å•ææ¨¡å¼ï¼Œå•ææ¨¡å¼æ§åˆ¶åœ¨Q1ä¿¡å·ä¸ºä½ç”µå¹³æ—¶ï¼Œç”±äº’è¡¥PWMæä¾›ï¼Œå¯¹Q2æ–½åŠ é«˜ç”µå¹³ä¿¡å·ï¼Œä»¤Q2æ‰“å¼€ã€‚æ­¤æ—¶Q2ã€ç”µæœºã€Q4å½¢æˆé—­åˆå›è·¯ã€‚ç”µæœºä¸­ä»ç„¶æœ‰ç”µæµæµè¿‡ï¼Œè™½ç„¶ç”µæµä¼šå‡å°ï¼Œä½†æ˜¯ä»ä¼šäº§ç”Ÿç£åœºï¼Œä»ä¼šäº§ç”ŸåŠ›çŸ©æ¥ç»§ç»­æ§åˆ¶ç”µæœºè½¬åŠ¨ã€‚è¯¥æ¨¡å¼ä¼˜ç‚¹æ˜¯å¯åŠ¨å¿«ï¼Œèƒ½åŠ é€Ÿã€åˆ¹è½¦ã€èƒ½è€—åˆ¶åŠ¨ã€èƒ½é‡åé¦ˆï¼Œè°ƒé€Ÿæ€§èƒ½è™½ç„¶ä¸å¦‚åŒææ¨¡å¼å¥½ï¼Œä½†æ˜¯ç›¸å·®ä¸å¤šï¼Œç”µæœºç‰¹æ€§ä¹Ÿè¾ƒå¥½ã€‚åœ¨è´Ÿè½½è¶…é€Ÿæ—¶ï¼Œä¹Ÿèƒ½æä¾›åå‘åŠ›çŸ©ã€‚\n\n### åŒææ¨¡å¼\n\nåŒææ¨¡å¼ä¸‹ç”µæ¢ç”µå‹ææ€§æ˜¯æ­£è´Ÿäº¤æ›¿çš„ã€‚\n\n![PWMåŒææ¨¡å¼](/images/H/9.png)\n\nå›¾ä¸­ï¼ŒPWM1ã€PWM2å‡ç”±å®šæ—¶å™¨è¾“å‡ºï¼ŒPW1Nã€PW2Nä¸ºä»–ä»¬çš„äº’è¡¥PWMé€šé“ã€‚PWM1å’ŒPWM2å‘¨æœŸç›¸åŒï¼Œå ç©ºæ¯”ç›¸åŒï¼Œææ€§ç›¸åï¼Œä½¿å¾—å¯¹è§’çº¿ä¸Šçš„ä¸¤ä¸ªMOSFETèƒ½å¤ŸåŒæ—¶å¯¼é€šï¼ŒåŒæ—¶å…³æ–­ã€‚æœ€ç»ˆç”µæœºçš„è½¬åŠ¨æ–¹å‘ç”±PWMå’ŒPWM1å…±åŒå†³å®šï¼Œè‹¥Açš„PWMå ç©ºæ¯”é«˜äº50%åˆ™ç”µæµä»å·¦è‡³å³ï¼Œè‹¥ä½äº50%åˆ™ä»å³è‡³å·¦ã€‚è¯¥æ¨¡å¼åœ¨ç»§æ‰¿å•ææ¨¡å¼ä¼˜ç‚¹çš„åŸºç¡€ä¸‹ï¼Œåœ¨é€Ÿåº¦å¿«è¦æ¥è¿‘äº0æ—¶ä¹Ÿå¯ä»¥æä¾›ä¸€å®šçš„åŠ›çŸ©ï¼ŒåŠ å‡é€Ÿæ€§èƒ½æ›´å¥½ï¼Œå› æ­¤æ­£åè½¬çš„æ€§èƒ½ä¼˜äºå•ææ¨¡å¼ã€‚æ§åˆ¶æ•ˆæœå¥½ã€‚ç¼ºç‚¹æ˜¯æ§åˆ¶æ›´å¤æ‚ï¼Œå·¥ä½œæ—¶4ä¸ªMOSéƒ½åœ¨å·¥ä½œï¼ŒåŠŸè€—å¤§ã€‚\n\n### æ­»åŒºæ—¶é—´\næ­»åŒºæ—¶é—´ï¼ˆDead Timeï¼‰æ˜¯æŒ‡åœ¨åˆ‡æ¢ä¸¤ä¸ªäº’è¡¥çš„MOSFETæ—¶ï¼Œä¸ºäº†é¿å…åŒæ—¶å¯¼é€šè€Œå¯¼è‡´çŸ­è·¯æˆ–ç›´é€šæ•…éšœï¼Œåœ¨å…³æ–­ä¸€ä¸ªMOSFETå’Œå¯¼é€šå¦ä¸€ä¸ªMOSFETä¹‹é—´æ’å…¥çš„å»¶è¿Ÿæ—¶é—´ã€‚æ­»åŒºæ—¶é—´æä¾›äº†ä¸€ä¸ªç¼“å†²ï¼Œç¡®ä¿ä¸€ä¸ªMOSFETå®Œå…¨å…³é—­åï¼Œå¦ä¸€ä¸ªæ‰å¼€å§‹å¯¼é€šï¼Œä»è€Œé¿å…ç›´é€šæ•…éšœã€‚\n\nMOSFETçš„å¯¼é€šå’Œå…³æ–­ä¸æ˜¯ç¬æ—¶çš„ï¼Œè€Œæ˜¯éœ€è¦ä¸€å®šçš„æ—¶é—´ã€‚è¿™åŒ…æ‹¬MOSFETæ …æå……ç”µå’Œæ”¾ç”µçš„æ—¶é—´ã€‚ä¸åŒç±»å‹çš„MOSFETå…·æœ‰ä¸åŒçš„å¼€å…³é€Ÿåº¦ï¼ˆå¼€é€šæ—¶é—´å’Œå…³æ–­æ—¶é—´ï¼‰ã€‚å¦‚æœæ­»åŒºæ—¶é—´è®¾ç½®å¾—å¤ªçŸ­ï¼Œå¯èƒ½ä¸è¶³ä»¥è¦†ç›–MOSFETçš„å¼€å…³æ—¶é—´ï¼Œå¯¼è‡´ç›´é€šæ•…éšœã€‚å¦‚æœæ­»åŒºæ—¶é—´è®¾ç½®å¾—å¤ªé•¿ï¼Œåˆ™ä¼šé™ä½ç”µè·¯çš„æ•ˆç‡ã€‚å› ä¸ºåœ¨æ­»åŒºæ—¶é—´å†…ï¼Œä¸¤å¯¹äº’è¡¥çš„MOSFETéƒ½å¤„äºå…³é—­çŠ¶æ€ï¼Œæ²¡æœ‰ç”µæµé€šè¿‡è´Ÿè½½ï¼Œå¯¼è‡´åŠŸç‡æŸå¤±å’Œç”µæœºæˆ–è´Ÿè½½çš„æ€§èƒ½ä¸‹é™ã€‚\n\nMOSFETçš„å¼€å…³é€Ÿåº¦ä¸æ …æç”µè·ï¼ˆQgsã€Qgdï¼‰å’Œæ …æé©±åŠ¨ç”µæµæœ‰å…³ã€‚æ­»åŒºæ—¶é—´åº”ä¸è¿™äº›å‚æ•°ç›¸åŒ¹é…ã€‚è¾ƒä½çš„æ …æç”µè·é€šå¸¸æ„å‘³ç€æ›´å¿«çš„å¼€å…³é€Ÿåº¦ï¼Œå¯ä»¥ä½¿ç”¨æ›´çŸ­çš„æ­»åŒºæ—¶é—´ã€‚å¦ä¸€æ–¹é¢ï¼Œé«˜ä¾§å’Œä½ä¾§MOSFETçš„ä¸åŒRds(on)å€¼ä¹Ÿä¼šå½±å“å¼€å…³é€Ÿåº¦ï¼Œå› æ­¤åœ¨è®¾è®¡æ­»åŒºæ—¶é—´æ—¶éœ€è¦è€ƒè™‘ã€‚ä¸€äº›é©±åŠ¨ICä¼šæ ¹æ®MOSFETçš„ç‰¹æ€§è‡ªåŠ¨è°ƒæ•´æ­»åŒºæ—¶é—´ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½å’Œä¿æŠ¤MOSFETã€‚\n### ç¨‹åºä»£ç ï¼ˆä»¥STM32 HALåº“ä¸ºä¾‹ï¼‰\nä»¥IRS21867Sæ–¹æ¡ˆä¸ºä¾‹ï¼š\n\n![IRS21867Sç¡¬ä»¶æ–¹æ¡ˆ](/images/H/10.png)\n\nMCUä¸ºSTM32F1ï¼ŒPWMç”±TIM1é€šé“3ç”Ÿæˆï¼ŒPWM-Nç”±TIM1é€šé“3çš„äº’è¡¥é€šé“ç”Ÿæˆï¼›PWM1ç”±TIM1é€šé“2ç”Ÿæˆï¼ŒPWM1-Nç”±TIM1é€šé“2çš„äº’è¡¥é€šé“ç”Ÿæˆã€‚PWMä¿¡å·ä»å¯¹åº”çš„å¤ç”¨GPIOç®¡è„šè¿æ¥è‡³é©±åŠ¨ICã€‚\n\n|         æ¨¡å¼        \t| Q1ï¼ˆå·¦ä¸Šï¼‰æ …æä¿¡å· \t| Q2ï¼ˆå³ä¸Šï¼‰æ …æä¿¡å· \t| Q3ï¼ˆå·¦ä¸‹ï¼‰æ …æä¿¡å· \t| Q4ï¼ˆå³ä¸‹ï¼‰æ …æä¿¡å· \t|\n|:-------------------:\t|:--------:\t|:---------:\t|:--------:\t|:---------:\t|\n| å—é™å•ææ¨¡å¼ (æ­£è½¬) \t|     PWM    \t|     OFF    \t|     OFF    \t|     ON     \t|\n| å—é™å•ææ¨¡å¼ (åè½¬) \t|     OFF    \t|     PWM     \t|     ON    \t|     OFF     \t|\n|   å•ææ¨¡å¼ï¼ˆæ­£è½¬ï¼‰  \t|     PWM    \t|     OFF     \t|     PWM-N    \t|     ON     \t|\n|   å•ææ¨¡å¼ï¼ˆåè½¬ï¼‰  \t|     OFF   \t|     PWM     \t|     ON   \t|     PWM-N      \t|\n|       åŒææ¨¡å¼      \t|     PWM1    \t|     PWM2     \t|     PWM1-N    \t|     PWM2-N     \t|\n\næ ¹æ®è¯¥çœŸå€¼è¡¨ï¼Œå³å¯é€šè¿‡ä¿®æ”¹å¯¹åº”çš„TIMé€šé“çš„PWMææ€§æ¥é…ç½®ç”µæœºå·¥ä½œæ¨¡å¼ã€‚\n\nä¸ºæ–¹ä¾¿ï¼Œå¯è‡ªå®šä¹‰å·¥ä½œæ¨¡å¼å‡½æ•°ã€‚\n\n*æ³¨æ„*ï¼šä¸‹é¢çš„Set_Motor_Mode()å‡½æ•°ä»…è®¾ç½®äº†å®šæ—¶å™¨çŠ¶æ€ã€‚åœ¨å—é™å•ææ¨¡å¼å’Œå•ææ¨¡å¼ä¸‹ï¼Œä¿®æ”¹Set_Motor_Mode()å‡½æ•°åï¼Œä¸€å®šè¦è®°å¾—æ ¹æ®ä¸Šè¡¨ä¿®æ”¹å¯¹åº”æ¡¥è‡‚MOSFETçš„æ …æä¿¡å·ä»¥ä¿è¯å…¶å¤„äºæ’å¯¼é€šçŠ¶æ€ï¼Œå¯¹ç”µæ¢ç”µæµæä¾›å›è·¯ã€‚\n\n```\n// ç”µæœºå·¥ä½œæ¨¡å¼è®¾ç½®ï¼ˆå®šæ—¶å™¨çŠ¶æ€ï¼‰\nvoid Set_Motor_Mode(uint8_t mode)\n{\n    switch (mode)\n    {\n    case 0: // å—é™å•ææ¨¡å¼ï¼ˆæ­£è½¬ï¼‰\n        HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_2);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_2);\n        HAL_TIM_PWM_Stop(&htim1, TIM_CHANNEL_3);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_3);\n        break;\n\n    case 1: // å—é™å•ææ¨¡å¼ï¼ˆåè½¬ï¼‰\n        HAL_TIM_PWM_Stop(&htim1, TIM_CHANNEL_2);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_2);\n        HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_3);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_3);\n        break;\n\n    case 2: // å•ææ¨¡å¼ï¼ˆæ­£è½¬ï¼‰\n        HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_2);\n        HAL_TIMEx_PWMN_Start(&htim1, TIM_CHANNEL_2);\n        HAL_TIM_PWM_Stop(&htim1, TIM_CHANNEL_3);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_3);\n        break;\n\n    case 3: // å•ææ¨¡å¼ï¼ˆåè½¬ï¼‰\n        HAL_TIM_PWM_Stop(&htim1, TIM_CHANNEL_2);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_2);\n        HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_3);\n        HAL_TIMEx_PWMN_Start(&htim1, TIM_CHANNEL_3);\n        break;\n\n    case 4: // åŒææ¨¡å¼\n        HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_2);\n        HAL_TIMEx_PWMN_Start(&htim1, TIM_CHANNEL_2);\n        HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_3);\n        HAL_TIMEx_PWMN_Start(&htim1, TIM_CHANNEL_3);\n        break;\n\n    case 5: // å…³é—­è¾“å‡º\n        HAL_TIM_PWM_Stop(&htim1, TIM_CHANNEL_2);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_2);\n        HAL_TIM_PWM_Stop(&htim1, TIM_CHANNEL_3);\n        HAL_TIMEx_PWMN_Stop(&htim1, TIM_CHANNEL_3);\n        break;            \n\n    default:\n        // å¤„ç†éæ³•æ¨¡å¼\n        break;\n    }\n}\n```\n\né…ç½®TIM1ï¼š\n```\nvoid MX_TIM1_Init(void)\n{\n    TIM_ClockConfigTypeDef sClockSourceConfig = {0};\n    TIM_OC_InitTypeDef sConfigOC = {0};\n    TIM_BreakDeadTimeConfigTypeDef sBreakDeadTimeConfig = {0};\n\n    htim1.Instance = TIM1;\n    htim1.Init.Prescaler = (uint32_t)((SystemCoreClock / 2) / 20000) - 1; //é¢„åˆ†é¢‘å¯„å­˜å™¨å†™å…¥\n    htim1.Init.CounterMode = TIM_COUNTERMODE_UP;\n    htim1.Init.Period = 1000 - 1; // è‡ªåŠ¨é‡è½½å¯„å­˜å™¨å†™å…¥\n    htim1.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;\n    htim1.Init.RepetitionCounter = 0;\n    htim1.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;\n    HAL_TIM_Base_Init(&htim1);\n\n    sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;\n    HAL_TIM_ConfigClockSource(&htim1, &sClockSourceConfig);\n\n    HAL_TIM_PWM_Init(&htim1);\n\n    sConfigOC.OCMode = TIM_OCMODE_PWM1;\n    sConfigOC.Pulse = 500; // åˆå§‹å ç©ºæ¯”50%\n    sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;\n    sConfigOC.OCNPolarity = TIM_OCNPOLARITY_HIGH;\n    sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;\n    sConfigOC.OCIdleState = TIM_OCIDLESTATE_RESET;\n    sConfigOC.OCNIdleState = TIM_OCNIDLESTATE_RESET;\n\n    HAL_TIM_PWM_ConfigChannel(&htim1, &sConfigOC, TIM_CHANNEL_2);\n    HAL_TIM_PWM_ConfigChannel(&htim1, &sConfigOC, TIM_CHANNEL_3);\n\n    //æ­»åŒºè®¾ç½®\n    sBreakDeadTimeConfig.OffStateRunMode = TIM_OSSR_DISABLE;\n    sBreakDeadTimeConfig.OffStateIDLEMode = TIM_OSSI_DISABLE;\n    sBreakDeadTimeConfig.LockLevel = TIM_LOCKLEVEL_OFF;\n    sBreakDeadTimeConfig.DeadTime = 100;\n    sBreakDeadTimeConfig.BreakState = TIM_BREAK_DISABLE;\n    sBreakDeadTimeConfig.BreakPolarity = TIM_BREAKPOLARITY_HIGH;\n    sBreakDeadTimeConfig.AutomaticOutput = TIM_AUTOMATICOUTPUT_DISABLE;\n    HAL_TIMEx_ConfigBreakDeadTime(&htim1, &sBreakDeadTimeConfig);\n}\n```\nå®šæ—¶å™¨è§¦å‘æ›´æ–°äº‹ä»¶æ—¶é—´é—´éš”ä¸º\n$$\nT_{out}=\\frac{(ARR+1)\\times(PSC+1)}{f_{clk}}\n$$\n\nå¯æŒ‰ç…§è¯¥å¼è‡ªå®šä¹‰PWMé¢‘ç‡ã€‚å¦‚è¦è°ƒæ•´åˆå§‹å ç©ºæ¯”ï¼Œå¯é€šè¿‡æ”¹å˜Pulseå‚æ•°å€¼ï¼ˆèŒƒå›´ä¸º0åˆ°Periodï¼‰æ¥å®ç°ã€‚\n\nPWMè¾“å‡ºå‡½æ•°ï¼ˆä»¥å•ææ¨¡å¼ä¸ºä¾‹ï¼‰ï¼š\n```\nvoid set_pwm(int speed)\n{\n    // å¤„ç†é€Ÿåº¦çš„æ­£è´Ÿï¼Œæ­£å€¼è¡¨ç¤ºæ­£è½¬ï¼Œè´Ÿå€¼è¡¨ç¤ºåè½¬\n    if (speed > 0)\n    {\n        Set_Motor_Mode(2);  // æ­£è½¬\n\n        *******æ­¤å¤„è¦è®°å¾—å°†Q4æ …æä¿¡å·æ‹‰é«˜*******\n\n    }\n    else if (speed < 0)\n    {\n        Set_Motor_Mode(3);  // åè½¬\n\n        *******æ­¤å¤„è¦è®°å¾—å°†Q3æ …æä¿¡å·æ‹‰é«˜*******\n\n        speed = -speed; // å°†é€Ÿåº¦å€¼å–ç»å¯¹å€¼\n    }\n    else\n    {\n        Set_Motor_Mode(5);  // åœæ­¢\n        return;\n    }\n\n    // é™åˆ¶æœ€ä½é€Ÿåº¦ï¼Œç¡®ä¿ç”µæœºèƒ½å¤Ÿå¯åŠ¨\n    int min_speed = 10; // å®šä¹‰æœ€ä½é€Ÿåº¦\n    if (speed < min_speed)\n    {\n        speed = min_speed;\n    }\n\n    // å°†é€Ÿåº¦å€¼æ˜ å°„åˆ°PWMå ç©ºæ¯”èŒƒå›´\n    speed = 700 - speed; // è¿™é‡Œ700æ˜¯åŸºå‡†å€¼ï¼Œè¶Šæ¥è¿‘700ï¼ŒPWMå ç©ºæ¯”è¶Šå°\n\n    TIM1->CCR2 = speed; // è®¾ç½®TIM1é€šé“2çš„PWMå ç©ºæ¯”\n    TIM1->CCR3 = speed; // è®¾ç½®TIM1é€šé“3çš„PWMå ç©ºæ¯”\n}\n```\n\nä¸»å‡½æ•°ï¼š\n```\nint main(void)\n{\n    HAL_Init();\n    SystemClock_Config();\n\n    // åˆå§‹åŒ–TIM1\n    MX_TIM1_Init();\n\n    // é€‰æ‹©ç”µæœºçš„å·¥ä½œæ¨¡å¼\n    Set_Motor_Mode(???); \n    \n    // ä¸»å¾ªç¯\n    while (1)\n    {\n        // åœ¨è¿™é‡Œå¯ä»¥é€šè¿‡ä¿®æ”¹å ç©ºæ¯”æ¥æ§åˆ¶ç”µæœºé€Ÿåº¦\n        set_pwm(???);\n    }\n}\n```\n\nä»¥ä¸Šæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„èƒ½è®©ç”µæœºåœ¨å¼€ç¯ä¸‹è½¬èµ·æ¥çš„ä»£ç ã€‚å¦‚æœè¦å®ç°åŠ¨æ€æ§åˆ¶ã€åŠ¨æ€è°ƒé€Ÿï¼Œéœ€è¦åŠ å…¥æ§åˆ¶ç¯èŠ‚ï¼Œå¦ä½œä»‹ç»ã€‚","categories":["ç”µå­ä¸ç”µè·¯è®¾è®¡"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘åŒæ­¥ç”µæœºçªç„¶ä¸‰ç›¸çŸ­è·¯åˆ†æ","url":"/2024/08/08/ã€ç”µæœºç¬æ€åˆ†æã€‘åŒæ­¥ç”µæœºçªç„¶ä¸‰ç›¸çŸ­è·¯åˆ†æ/","content":"## ç®€ä»‹\nåœ¨ç”µåŠ›ç³»ç»Ÿå®é™…å‘ç”Ÿçš„æ•…éšœä¸­ï¼Œä¸å¯¹ç§°çŸ­è·¯å çš„æ¯”ä¾‹è¾ƒå¤§ï¼Œå¯¹ç§°çŸ­è·¯çš„æ•…éšœæ‰€å æ¯”ä¾‹è™½è¾ƒå°ï¼Œä½†å…¶åæœæ¯”è¾ƒä¸¥é‡ã€‚æ ¹æ®å›½å®¶æ ‡å‡†è§„å®šï¼ŒåŒæ­¥å‘ç”µæœºå¿…é¡»èƒ½æ‰¿å—ç©ºè½½ç”µå‹ç­‰äº105%é¢å®šç”µå‹ä¸‹çš„çªç„¶ä¸‰ç›¸å¯¹ç§°çŸ­è·¯ã€‚æœ¬èŠ‚ç›´æ¥åˆ©ç”¨ä¹‹å‰å¯¼å‡ºçš„åŒæ­¥ç”µæœºåŠ¨æ€æ–¹ç¨‹å¼ï¼Œæ±‚è§£ç©ºè½½æ—¶çªç„¶ä¸‰ç›¸å¯¹ç§°çŸ­è·¯åçš„çŸ­è·¯ç”µæµå’Œç”µç£è½¬çŸ©ã€‚\n\nå‡å®šåœ¨çªç„¶çŸ­è·¯è¿‡ç¨‹ä¸­è½¬é€Ÿä¸ºåŒæ­¥è½¬é€Ÿï¼Œå³$\\omega=1$ã€‚è¿™ä¸ªå‡å®šåœ¨åˆ†ææœ€å¤§çªç„¶çŸ­è·¯ç”µæµå’Œæœ€å¤§çŸ­è·¯è½¬çŸ©æ—¶æ˜¯å¯ä»¥æ»¡è¶³å·¥ç¨‹è¦æ±‚çš„ã€‚ç”±äºè½¬é€Ÿæ’å®šè€Œä¸”å·²çŸ¥ï¼Œå› æ­¤ï¼Œåªéœ€æ±‚è§£åŠ¨æ€æ–¹ç¨‹å¼ä¸­çš„ç”µå‹æ–¹ç¨‹å¼ï¼Œæ— éœ€è€ƒè™‘è½¬çŸ©è¿‡æ¸¡æ—¶çš„è½¬å­è¿åŠ¨æ–¹ç¨‹å¼ã€‚æ­¤æ—¶ç”µå‹æ–¹ç¨‹å¼æ˜¯ä¸€ç»„çº¿æ€§å¸¸ç³»æ•°çš„å¾®åˆ†æ–¹ç¨‹å¼ï¼Œä¸ºäº†æ±‚è§£æ–¹ä¾¿ï¼Œå¯ä»¥åº”ç”¨å åŠ åŸç†å’Œæ‹‰æ°å˜æ¢çš„æ–¹æ³•ã€‚\n\næ ¹æ®å åŠ åŸç†ï¼Œå®é™…çªç„¶çŸ­è·¯å¯ä»¥çœ‹æˆæ˜¯ä¸‹é¢ä¸¤ç§å·¥å†µçš„å åŠ ï¼š\n\n- ç”µæœºçªç„¶çŸ­è·¯å‰çš„ç¨³å®šè¿è¡Œå·¥å†µ\n- åœ¨é›¶åˆå§‹çŠ¶æ€ä¸‹ç”µæ¢ç«¯çªç„¶åŠ ä¸Šä¸ç”µæœºçŸ­è·¯å‰å¤§å°ç›¸ç­‰ã€æ–¹å‘ç›¸åçš„ç”µå‹æ—¶çš„è¿è¡Œå·¥å†µ\n\nå®é™…çªç„¶çŸ­è·¯é—®é¢˜çš„æ±‚è§£å°±è½¬åŒ–æˆäº†çŸ­è·¯å‰çš„ç¨³æ€è¿è¡Œå·¥å†µå’Œé›¶åˆå§‹å€¼æ—¶ç”µæ¢ç«¯çªåŠ åå‘ç”µå‹çš„ç¬æ€é—®é¢˜çš„æ±‚è§£ï¼Œè¿™æ ·ï¼Œå°†ä½¿è®¡ç®—å¤§ä¸ºç®€åŒ–ã€‚ä¸‹é¢åˆ†åˆ«å°±ç”µæ¢çªç„¶çŸ­è·¯åçš„ç”µæ¢ç”µæµã€è½¬å­ç”µæµåŠç”µç£è½¬çŸ©è¿›è¡Œè®¨è®ºã€‚\n\n## ç©ºè½½çªç„¶çŸ­è·¯åçš„ç”µæ¢ç”µæµ\nå‡è®¾åŒæ­¥ç”µæœºåœ¨ä¸‰é¡¹çŸ­è·¯å‰ç©ºè½½è¿è¡Œï¼Œå…¶ç¨³å®šè¿è¡Œå·¥å†µä¹‹å‰å·²ç»æœ‰åˆ†æè¿‡ï¼Œå…¶ç«¯ç”µå‹ä¸º\n\n$$\nu_d=u_{d0}=0 \\\\\nu_q=u_{q0}=E_m\n$$\n\næ ¹æ®å åŠ åŸç†ï¼Œçªç„¶ä¸‰ç›¸çŸ­è·¯åçš„ç”µæ¢ç”µæµ$i_d$ã€$i_q$ï¼Œå°†ç”±åŸæ¥çš„ç¨³æ€ç”µæµ$i_{d0}$ã€$i_{q0}$å’Œçªç„¶åŠ ç”µå‹$-u_{d0}$å’Œ$-u_{q0}$å¼•èµ·çš„ç¬æ€ç”µæµ$i_d'$ã€$i_q'$ç›¸åŠ è€Œæˆï¼Œå³\n\n$$\ni_d=i_{d0}+i_d' \\\\\ni_q=i_{q0}+i_q' \n$$\n\nä¸‹é¢å°†åˆ†åˆ«æ±‚è§£ç”µæµ$i_{d0}$ã€$i_{q0}$ã€$i_d'$ã€$i_q'$å’Œ$i_d$ã€$i_q$ï¼Œå¹¶å°†å…¶è¿”å›è‡³abcåæ ‡ç³»ç»Ÿã€‚\n\n### çŸ­è·¯å‰çš„ç¨³æ€ç”µæµ$i_{d0}$ã€$i_{q0}$\nåŒæ­¥ç”µæœºè¿è¡Œåœ¨ç©ºè½½çŠ¶æ€ï¼Œç”µæ¢ç»•ç»„å¼€è·¯ï¼Œä¸‰ç›¸ç”µæ¢ç»•ç»„ç”µæµå‡ä¸ºé›¶ï¼Œå› è€Œ\n\n$$\ni_{d0}=i_{q0}=0\n$$\n\n### çªç„¶åŠ ä¸Š$-u_{d0}$ã€$-u_{q0}$æ—¶æ‰€äº§ç”Ÿçš„ç”µæµ$i_d$ã€$i_q$\nç”µæ¢dã€qç»•ç»„ç«¯åˆ†åˆ«çªç„¶åŠ ä¸Š$-u_{d0}$ã€$-u_{q0}$æ—¶ï¼Œç”µå‹æ–¹ç¨‹å¼ä¸º\n\n$$\n-u_{d0}=0=p\\psi_d'-\\psi_q'+r_si_d' \\\\\n-u_{q0}=-E_m=p\\psi_q'+\\psi_d'+r_si_q'\n$$\n\nä¸è®¡åŠ±ç£è°ƒèŠ‚ä½œç”¨ï¼Œåœ¨çªç„¶çŸ­è·¯æ—¶$u_f$ä¸ºæ’å®šå€¼ï¼Œè€Œè¯¥æ’å®šåŠ±ç£ç”µå‹çš„ä½œç”¨å·²ç»åœ¨ç¨³æ€è¿è¡Œåˆ†ææ—¶è€ƒè™‘è¿‡ã€‚å½“ç”µæ¢ç«¯çªåŠ ç”µå‹$-u_{d0}$ã€$-u_{q0}$æ—¶ï¼ŒåŠ±ç£ç»•ç»„ç›¸å½“äºçŸ­è·¯å›è·¯ï¼Œå³$u_f=0$ï¼Œå› è€Œç›¸åº”çš„ç”µæ¢ç£é“¾ä¸º\n\n$$\n\\psi_d'=x_d(p)i_d' \\\\\n\\psi_q'=x_q(p)i_q'\n$$\n\nå°†ç”µæ¢ç£é“¾å¼ä»£å…¥ç”µå‹æ–¹ç¨‹å¼ï¼Œå¾—åˆ°ç”µå‹ä¸é˜»æŠ—ã€ç”µæµçš„å…³ç³»å¼ã€‚å½“ç”µæ¢ç«¯çªåŠ ç”µå‹æ—¶ï¼Œå„ç»•ç»„çš„ç”µæµã€ç£é“¾åˆå€¼ä¸ºé›¶ï¼Œæ•…ç»ç”±$Laplace$å˜æ¢åï¼Œå…¶è¿ç®—æ–¹ç¨‹ä¸º\n\n$$\n0=[r_s+px_d(p)]I_d(p)-x_q(p)I_q(p) \\\\\n-\\frac{E_m}{p}=[r_s+px_q(p)]I_q(p)+x_d(p)I_d(p)\n$$\n\nè§£å‡ºç”µæµ$I_d(p)$å¦‚ä¸‹\n\n$$\nI_d(p)=-\\frac{E_m}{p}\\times\\frac{x_q(p)}{r_s^2+r_s[x_d(p)+x_q(p)]p+x_d(p)x_q(p)p^2+x_d(p)x_q(p)}\n$$\n\næˆ–\n\n$$\nI_d(p)=-\\frac{E_m}{p}\\times\\frac{1}{p^2+r_s[\\frac{1}{x_d(p)}+\\frac{1}{x_q(p)}]p+1+\\frac{r_s^2}{x_d(p)x_q(p)}}\\times\\frac{1}{x_d(p)}\n$$\n\nç•¥å»$r_s^2$é¡¹ï¼Œä¸­æ‹¬å·å†…æœ‰$x_d(p)$å’Œ$x_q(p)$çš„é¡¹ä¸­ï¼Œå°†è½¬å­ç”µé˜»$r_f$ã€$r_D$ã€$r_Q$ç•¥å»ï¼Œè¿™æ ·$x_d(p)$ã€$x_q(p)$å¯åˆ†åˆ«ç®€åŒ–ä¸ºç›´è½´ã€äº¤è½´æ¬¡æš‚æ€ï¼ˆè¶…ç¬å˜ï¼‰ç”µæŠ—$x_d''$ã€$x_q''$ï¼Œäºæ˜¯æœ‰\n\n$$\nI_d(p)=-\\frac{E_m}{p(p^2+2\\alpha p+1)x_d(p)}\n$$\n\nå¼ä¸­\n\n$$\n\\alpha = \\frac{r_s}{2}(\\frac{1}{x_d''}+\\frac{1}{x_q''})=\\frac{1}{T_a}\n$$\n\næ ¹æ®è¿ç®—ç”µæŠ—ç« èŠ‚ä¸­å¯¼å‡ºçš„$x_d(p)$çš„å€’æ•°å½¢å¼\n\n$$\n\\frac{1}{x_d(p)}=\\frac{1}{x_d}+(\\frac{1}{x_d'}-\\frac{1}{x_d})\\frac{T_d'p}{T_d'p+1}+(\\frac{1}{x_d''}-\\frac{1}{x_d'})\\frac{T_d''p}{T_d''p+1}\n$$\n\nä»£å…¥åŸå¼ï¼Œæœ‰\n\n$$\nI_d(p)=-\\frac{E_m}{p(p^2+2\\alpha p +1)}[\\frac{1}{x_d}+(\\frac{1}{x_d'}-\\frac{1}{x_d})\\frac{T_d'p}{T_d'p+1}+(\\frac{1}{x_d''}-\\frac{1}{x_d'})\\frac{T_d''p}{T_d''p+1}]\n$$\n\nåŒç†å¯è§£å‡ºè±¡å‡½æ•°$I_q(p)$ä¸º\n\n$$\\begin{aligned}I_{q}(p)&=- \\frac{E_{m}}{p}\\times\\frac{r_{s}+px_{d}(p)}{r_{s}^{2}+r_{s}[x_{d}(p)+x_{q}(p)]p+x_{d}(p)x_{q}(p)p^{2}+x_{d}(p)x_{q}(p)}\\\\&=- \\frac{E_{m}}{p}\\times\\frac{r_{s}+px_{d}(p)}{p^{2}+r_{s}\\Big[\\frac{1}{x_{d}(p)}+\\frac{1}{x_{q}(p)}\\Big]p+1+\\frac{r_{s}^{2}}{x_{d}(p)x_{q}(p)}}\\times\\frac{1}{x_{d}(p)x_{q}(p)}\\end{aligned}\n$$\n\nåˆ†æ¯ä¸­é‡‡ç”¨ä¸å¯¼å‡º$I_d(p)$æ—¶åŒæ ·çš„ç®€åŒ–æ–¹æ³•ï¼Œå¹¶æ ¹æ®è¿ç®—ç”µæŠ—ç« èŠ‚ä¸­å¯¼å‡ºçš„$x_q(p)$çš„å€’æ•°å½¢å¼\n\n$$\n\\frac{1}{x_q(p)}=\\frac{1}{x_q}+(\\frac{1}{x_q''}-\\frac{1}{x_q})\\frac{T_q''p}{1+T_q''p}\n$$\n\nä»£å…¥ï¼Œå¾—\n\n$$\nI_q(p)=-\\frac{E_m}{(p^2+2\\alpha p +1)}[\\frac{1}{x_q}+(\\frac{1}{x_q''}-\\frac{1}{x_q})\\frac{T_q''p}{1+T_q''p}]\n$$\n\nå°†è±¡å‡½æ•°$I_d(p)$å’Œ$I_q(p)$ä½¿ç”¨$Laplace$åå˜æ¢è‡³åŸå‡½æ•°$i_d'$å’Œ$i_q'$ã€‚ç”±äºåŒæ­¥ç”µæœºä¸­$\\frac{1}{T_d}$ã€$\\frac{1}{T_d'}$ã€$\\frac{1}{T_d''}$ã€$\\frac{1}{T_q''}$å‡è¿œå°äº1ï¼Œåå˜æ¢åçš„ç»“æœä¸º\n\n$$\ni_d'=-E_m[(\\frac{1}{x_d''}-\\frac{1}{x_d'})e^{-t/T_d''}+(\\frac{1}{x_d'}-\\frac{1}{x_d})e^{-t/T_d'}+\\frac{1}{x_d}]+\\frac{E_m}{x_d''}e^{-t\\cos t/T_a}\\\\\n$$\n\n$$\ni_q'=-\\frac{E_m}{x_q''}e^{-t \\sin t/T_a}\n$$\n\n### ç©ºè½½çªç„¶çŸ­è·¯åçš„å®é™…ç”µæµ$i_d$ã€$i_q$\næ ¹æ®ä¸Šé¢åˆ†æï¼Œå®é™…çš„ç©ºè½½çªç„¶ä¸‰ç›¸çŸ­è·¯ç”µæµå¯åº”ç”¨å åŠ åŸç†ï¼Œå°†ç©ºè½½ç¨³æ€è¿è¡Œæ—¶çš„ç”µæµä¸çªåŠ $-u_{d0}$ã€$-u_{q0}$æ—¶çš„ç”µæµç›¸åŠ ï¼Œç”±äºç©ºè½½æ—¶ç”µæ¢ç”µæµä¸ºé›¶ï¼Œæ‰€ä»¥çªç„¶çŸ­è·¯åçš„ç”µæµç”¨dq0åæ ‡ç³»ç»Ÿè¡¨ç¤ºä¸º\n\n$$\ni_d=i_{d0}+i_d'=i_d' \\\\\ni_q=i_{q0}+i_q'=i_q'\n$$\n\n### ç©ºè½½çªç„¶çŸ­è·¯åçš„ç”µæµ$i_a$ã€$i_b$ã€$i_c$\nå‡å®š$t=0$æ—¶ï¼Œdè½´å’Œqè½´å¾—å¤¹è§’ä¸º$\\theta_0$ï¼Œåˆ™$\\theta=t+\\theta_0$ã€‚å°†$i_d'$å’Œ$i_q'$äºŒå¼è¿”å›è‡³abcåæ ‡ç³»ç»Ÿï¼Œæœ‰\n\n$$\ni_a=-[(\\frac{1}{x_d''}-\\frac{1}{x_d'})e^{-t/T_d''}+(\\frac{1}{x_d'}-\\frac{1}{x_d})e^{-t/T_d'}+\\frac{1}{x_d}]E_m\\cos(t+\\theta_0)+\\frac{E_m}{2}e^{-1/T_a}[(\\frac{1}{x_d''}+\\frac{1}{x_q''})\\cos \\theta_0+(\\frac{1}{x_d''}-\\frac{1}{x_q''})\\cos (2t+\\theta_0)]\n$$\n\næŠŠä¸Šå¼ä¸­çš„$\\theta_0$åˆ†åˆ«ç”¨$(\\theta_0-120\\degree)$ã€$(\\theta_0+120\\degree)$æ›¿æ¢ï¼Œå³å¯å¾—åˆ°$i_b$ã€$i_c$çš„è¡¨è¾¾å¼ã€‚\n\n### å°ç»“\nä»¥ä¸Šæ˜¯ä»è§£æ–¹ç¨‹å¼å¾—åˆ°çš„çªç„¶ä¸‰ç›¸çŸ­è·¯åçš„å®é™…å®šå­ç»•ç»„ç”µæµã€‚ç”±$i_a$çš„è¡¨è¾¾å¼å¯çŸ¥ï¼Œçªç„¶ä¸‰ç›¸çŸ­è·¯åï¼Œå®šå­å„ç›¸çŸ­è·¯ç”µæµç”±ä¸¤å¤§éƒ¨åˆ†æ„æˆï¼Œå³åŸºé¢‘çš„å‘¨æœŸåˆ†é‡ã€éå‘¨æœŸåŠ2å€é¢‘åˆ†é‡ï¼Œä»ç‰©ç†æ„ä¹‰ä¸Šæ¥ç†è§£ï¼Œå½“å®šå­ç»•ç»„çªç„¶ä¸‰ç›¸çŸ­è·¯åï¼Œç”±äºè½¬å­ç£åœºçš„æ—‹è½¬åŠå®šå­ç»•ç»„ä¸­äº§ç”Ÿç›¸åº”çš„ä¸‰ç›¸ç¨³æ€åŸºé¢‘ç”µæµï¼Œå°†å¼•èµ·å®šå­åŠè½¬å­å„ç»„ä¸­çš„ç£é“¾çš„çªå˜ã€‚ä¸ºäº†ä¿æŒå„é—­åˆå›è·¯ä¸­çš„ç£é“¾ä¸å‘ç”Ÿçªå˜,å®šå­ç»•ç»„å’Œè½¬å­é˜»å°¼å’ŒåŠ±ç£ç»•ç»„ä¸­å°±äº§ç”Ÿäº†éå‘¨æœŸç”µæµã€‚ç”±äºè½¬å­ä»¥åŒæ­¥é€Ÿåº¦æ—‹è½¬ï¼Œè½¬å­é˜»å°¼å’ŒåŠ±ç£ç»•ç»„ä¸­çš„éå‘¨æœŸç”µæµä¼šåœ¨å®šå­ç»•ç»„ä¸­äº§ç”Ÿç›¸åº”çš„åŸºé¢‘å‘¨æœŸç”µæµåˆ†é‡ï¼Œå³è¶…ç¬å˜ï¼ˆæ¬¡æš‚æ€ï¼‰åˆ†é‡å’Œç¬å˜ï¼ˆæš‚æ€ï¼‰åˆ†é‡ã€‚ç”±äºè½¬å­ç»•ç»„ä¸­å­˜åœ¨ç”µé˜»ï¼Œçªç„¶çŸ­è·¯åœ¨è½¬å­ç»•ç»„ä¸­å¼•èµ·çš„éå‘¨æœŸç”µæµå°†é€æ­¥è¡°å‡è‡³é›¶ï¼Œå…¶é˜»å°¼ç»•ç»„å’ŒåŠ±ç£ç»•ç»„çš„è¡°å‡æ—¶é—´å¸¸æ•°åˆ†åˆ«ä¸º$T_d''$å’Œ$T_d'$ã€‚ç”±è½¬å­ç»•ç»„ä¸­çš„éå‘¨æœŸç”µæµåœ¨å®šå­ç»•ç»„ä¸­æ„Ÿç”Ÿçš„è¶…ç¬å˜åˆ†é‡å’Œç¬å˜åˆ†é‡ç”µæµäº¦æŒ‰åŒæ ·çš„æ—¶é—´å¸¸æ•°è¡°å‡ã€‚åŒæ ·åœ°ï¼Œå®šå­ç»•ç»„ä¸­çš„éå‘¨æœŸç”µæµä¼šåœ¨è½¬å­ç»•ç»„ä¸­äº§ç”Ÿç›¸åº”çš„åŸºé¢‘å‘¨æœŸåˆ†é‡ç”µæµï¼Œä½†ç”±äºè½¬å­ä¸å¯¹ç§°ï¼Œè¿™ä¸ªè½¬å­ç»•ç»„ä¸­çš„åŸºé¢‘ç”µæµæ‰€äº§ç”Ÿçš„ç£åœºç›¸å¯¹è½¬å­è€Œè¨€å¯åˆ†ä¸ºä¸¤ä¸ªè½¬å‘ç›¸åï¼Œè½¬é€Ÿå‡ä¸ºåŒæ­¥è½¬é€Ÿ$\\omega_1$çš„åˆ†é‡ï¼Œå…¶ä¸­ä¸è½¬å­è½¬å‘ç›¸åŒçš„æ—‹è½¬ç£åœºå¯¹å®šå­çš„è½¬é€Ÿä¸º$2\\omega_1$ï¼Œå®ƒå°†åœ¨å®šå­ç»•ç»„ä¸­å¼•èµ·å€é¢‘çš„å‘¨æœŸåˆ†é‡ã€‚ä»$i_a$çš„è¡¨è¾¾å¼ä¸­ä¹Ÿå¯çœ‹å‡ºï¼Œå½“è½¬å­çš„ç£è·¯å’Œç”µè·¯å®Œå…¨å¯¹ç§°ï¼Œå³$x_d''=x_q'$æ—¶ï¼Œè¿™ä¸ªå€é¢‘çš„å‘¨æœŸåˆ†é‡å°†ä¸å­˜åœ¨ã€‚ä¸è½¬å­è½¬å‘ç›¸åçš„æ—‹è½¬ç£åœºå¯¹å®šå­çš„è½¬é€Ÿä¸ºé›¶ï¼Œå¯¹å®šå­éå‘¨æœŸç”µæµäº§ç”Ÿçš„ç£åœºæ˜¯ä¸€ä¸ªå»ç£ä½œç”¨ã€‚\n\nç”±äºå®šå­ç»•ç»„å­˜åœ¨ç”µé˜»ï¼Œå®šå­ç»•ç»„ä¸­çš„éå‘¨æœŸç”µæµå’Œå€é¢‘ç”µæµå°†ä»¥å®šå­ç»•ç»„çš„æ—¶é—´å¸¸æ•°$T_a$è¡°å‡è‡³é›¶ã€‚\n\nä»ä¸Šé¢åˆ†æä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç”±äºç»•ç»„è½´çº¿é€‰å–çš„ä¸åŒï¼Œåœ¨dã€qã€0åæ ‡ç³»ç»Ÿä¸­ï¼Œç”µæµ$i_d$ã€$i_q$çš„éå‘¨æœŸåˆ†é‡ç›¸å½“äºaã€bã€cåæ ‡ç³»ç»Ÿä¸­ç”µæµ$i_a$ã€$i_b$ã€$i_c$çš„åŸºé¢‘å‘¨æœŸåˆ†é‡ï¼Œè€Œç”µæµ$i_d$åŠ$i_q$çš„åŸºé¢‘å‘¨æœŸåˆ†é‡ï¼Œåˆ™ç›¸å½“äºç”µæµ$i_a$ã€$i_b$ã€$i_c$çš„éå‘¨æœŸåˆ†é‡å’Œå€é¢‘çš„å‘¨æœŸåˆ†é‡ã€‚\n\n## ç©ºè½½çªç„¶çŸ­è·¯åçš„è½¬å­ç»•ç»„ç”µæµ\n\nçªç„¶ä¸‰ç›¸çŸ­è·¯åï¼Œç”µæœºè½¬å­ç»•ç»„ä¸­ç”µæµçš„è®¡ç®—æ–¹æ³•ä¸è®¡ç®—ç”µæ¢ç»•ç»„ç”µæµä¸€è‡´ï¼Œé‡‡ç”¨å åŠ åŸç†å°†å®é™…çš„çªç„¶çŸ­è·¯ç”µæµçœ‹æˆæ˜¯ä»¥ä¸‹ä¸¤ç§å·¥å†µçš„å åŠ ï¼š\n\n- ç”µæœºçªç„¶çŸ­è·¯å‰ç¨³å®šè¿è¡Œå·¥å†µçš„ç”µæµ\n- åœ¨é›¶åˆå§‹çŠ¶æ€ä¸‹ï¼Œç”µæ¢ç«¯çªç„¶åŠ ä¸Šä¸çŸ­è·¯å‰å¤§å°ç›¸ç­‰ã€æ–¹å‘ç›¸åçš„ç”µå‹æ—¶è¿è¡Œå·¥å†µçš„ç”µæµ\n\nå³ï¼š\n\n1. æ±‚åŸæ¥ç¨³æ€ä¸‰ç›¸å¯¹ç§°è¿è¡Œæ—¶çš„è½¬å­ç”µæµ$i_{f0}$ã€$i_{D0}$ã€$i_{Q0}$\n2. æ±‚çªç„¶åœ¨ç”µæ¢ç«¯åŠ ä¸Šç”µå‹$-u_{d0}$ã€$-u_{q0}$å¼•èµ·çš„è½¬å­ç”µæµ$i_f'$ã€$i_D'$ã€$i_Q'$\n3. çªç„¶ä¸‰ç›¸çŸ­è·¯åè½¬å­çš„å®é™…ç”µæµä¸ºï¼ˆ1ï¼‰ã€ï¼ˆ2ï¼‰æ‰€æ±‚ç”µæµçš„å åŠ ï¼Œå³\n$$\ni_f=i_{f0}+i_f'\\\\\ni_D=i_{D0}+i_D'\\\\\ni_Q=i_{Q0}+i_Q'\\\\\n$$\n\nä¸‹é¢åˆ†ä¸‰æ­¥æ±‚è§£è½¬å­ç”µæµï¼š\n\n### æ±‚ç¨³æ€ä¸‰ç›¸å¯¹ç§°è¿è¡Œæ—¶è½¬å­ç”µæµ\næ ¹æ®ç¬¬äºŒèŠ‚ç©ºè½½è¿è¡Œçš„åˆ†æå¯çŸ¥ï¼Œç¨³æ€è¿è¡Œæ—¶åŠ±ç£ç»•ç»„ç”µæµï¼Œç­‰äºå¤–åŠ åŠ±ç£ç”µå‹åœ¨åŠ±ç£ç»•ç»„ä¸­äº§ç”Ÿçš„ç¨³æ€ç›´æµç”µæµï¼Œå³\n\n$$\ni_{f0}=\\frac{u_f}{r_f}\n$$\n\nä¸”ç¨³æ€ä¸‰ç›¸å¯¹ç§°è¿è¡Œæ—¶é˜»å°¼ç»•ç»„å†…ç”µæµä¸ºé›¶ï¼Œå³\n\n$$\ni_{D0}=i_{Q0}=0\n$$\n\n### æ±‚çªç„¶åŠ ä¸Šç”µå‹$-u_{d0}$ã€$-u_{q0}$å¼•èµ·çš„è½¬å­ç”µæµ\n\n","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘å‡¸çº§åŒæ­¥ç”µæœºå¯¹ç§°ç¨³æ€è¿è¡Œåˆ†æ","url":"/2024/08/05/ã€ç”µæœºç¬æ€åˆ†æã€‘å‡¸çº§åŒæ­¥ç”µæœºå¯¹ç§°ç¨³æ€è¿è¡Œåˆ†æ/","content":"ç”µæœºå­¦ä¸­å·²ç»è¯¦ç»†è®¨è®ºäº†åŒæ­¥ç”µæœºå¯¹ç§°ç¨³æ€è¿è¡Œé—®é¢˜ï¼Œè¿™é‡Œç”¨ä¹‹å‰å¯¼å‡ºçš„dã€qã€0åæ ‡ç³»ç»Ÿçš„ç”µå‹æ–¹ç¨‹å¼ï¼Œå¯¹è¿™ä¸€è¿è¡Œæ–¹å¼è¿›è¡Œåˆ†æï¼Œå¾ˆå®¹æ˜“æ±‚å¾—ç¨³æ€è¿è¡Œæ—¶çš„æœ‰åŠŸåŠŸç‡ã€æ— åŠŸåŠŸç‡åŠç”µç£è½¬çŸ©ã€‚\n## ç©ºè½½è¿è¡Œ\nç©ºè½½ç¨³æ€è¿è¡Œæ—¶ï¼Œæ˜¾ç„¶åŒæ­¥ç”µæœºçš„è½¬é€Ÿåªèƒ½ä¸ºåŒæ­¥è½¬é€Ÿï¼Œå³è§’é€Ÿåº¦ï¼ˆæ ‡å¹ºå€¼ï¼‰$\\omega=1$ï¼›åŠ±ç£ç»•ç»„ç«¯å¤–åŠ ç›´æµç”µå‹ä¸º$u_f$ï¼Œç”µæ¢ç»•ç»„å¼€è·¯ï¼Œä¸‰ç›¸ç”µæ¢ç»•ç»„ç”µæµ$i_a$ã€$i_b$ã€$i_c$å‡ä¸ºé›¶ï¼Œè½¬æ¢ä¸ºdã€qã€0åæ ‡ç³»ç»Ÿåï¼Œ$i_d$ã€$i_q$ã€$i_0$äº¦éƒ½ä¸ºé›¶ã€‚ç”±äºè½¬é€Ÿæ’å®šï¼Œä¸å­˜åœ¨è½¬çŸ©è¿‡æ¸¡è¿‡ç¨‹ï¼Œæ•…è¯¥æƒ…å†µä¸‹æ— éœ€æ±‚è§£è½¬çŸ©æ–¹ç¨‹å¼ï¼Œåªéœ€æ±‚è§£ç”µå‹æ–¹ç¨‹å¼ï¼Œå³å¯æ±‚å¾—å‘ç”µæœºç©ºè½½è¿è¡Œæ—¶ç”±åŠ±ç£ç”µæµã€ç£é“¾åœ¨å‘ç”µæœºç”µæ¢ç»•ç»„ä¸­äº§ç”Ÿçš„ç©ºè½½ç”µå‹ã€‚\n\né¦–å…ˆï¼Œæ±‚å‡ºåŠ±ç£ç”µæµ$i_f$ã€‚æ ¹æ®æ ‡å¹ºå€¼å½¢å¼ä¸‹çš„åŒæ­¥ç”µæœºç”µå‹æ–¹ç¨‹å¼\n\n$$\nU^*=L^*pI^*+\\omega^*G^*I^*+R^*I^*\n$$\n\nå¼ä¸­\n$$\nU^*=[U_{dq0}^* \\quad U_{fDQ}^*]^T\\\\\n$$\n$$\nI^*=[I_{dq0}^* \\quad I_{fDQ}^*]^T\n$$\n$$\nR^*=\n\\begin{bmatrix}\nR_{abc}^* & 0\\\\\n0 & R_{fDQ}^*\n\\end{bmatrix}\n$$\n$$\n\\begin{array}{c}\nL^{*}=\\left[\\begin{array}{cccccc}\nx_{\\mathrm{d}}^* & 0 & 0 & x_{\\mathrm{ad}}^{*} & x_{\\mathrm{ad}}^{*} & 0 \\\\\n0 & x_{\\mathrm{q}}^{*} & 0 & 0 & 0 & x_{a q}^{*} \\\\\n0 & 0 & x_{0}^{*} & 0 & 0 & 0 \\\\\nx_{\\mathrm{ad}}^{*} & 0 & 0 & x_{\\mathrm{f}}^{*} & x_{a d}^{*} & 0 \\\\\nx_{a d}^{*} & 0 & 0 & x_{ad}^{*} & x_{\\mathrm{D}}^{*} & 0 \\\\\n0 & x_{\\mathrm{aq}}^{*} & 0 & 0 & 0 & x_{\\mathrm{Q}}^{*}\n\\end{array}\\right] \n\n\\\\\n\nG^{*}=\\left[\\begin{array}{cccccc}\n0 & -x_{\\mathrm{q}}^{*} & 0 & 0 & 0 & -x_{a q}^{*} \\\\\nx_{d}^{*} & 0 & 0 & x_{\\mathrm{ad}}^{*} & x_{\\mathrm{ad}}^{*} & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0\n\\end{array}\\right]\n\\end{array}\n$$\n\nè€ƒè™‘$i_d$ã€$i_q$ä¸ºé›¶ï¼Œå¯å¾—\n\n$$\nu_f=p(x_fi_f+x_{ad}i_D) + r_fi_f \\\\\n0=p(x_{ad}i_f+x_Di_D)+r_Di_D \\\\\n0=px_Qi_Q+r_Qi_Q\n$$\n\nåŠ±ç£ç»•ç»„å¤–åŠ ç”µæºä¸ºç›´æµç”µå‹ï¼Œä¸”ç°è®¨è®ºçš„æ˜¯ç¨³æ€è¿è¡Œé—®é¢˜ï¼Œæ‰€ä»¥åŠ±ç£ç»•ç»„ç”µæµä¸ºæ’å®šç›´æµï¼Œè½¬å­å„ç»•ç»„äº¤é“¾çš„ç£é“¾ä¹Ÿä¸ºæ’æŒ‡ï¼Œå˜å‹å™¨ç”µåŠ¨åŠ¿$p\\psi$ä¸ºé›¶ï¼Œè¿™æ—¶åŠ±ç£ç»•ç»„çš„ç”µå‹æ–¹ç¨‹å¼ä¸º\n\n$$\nu_f=r_fi_f\n$$\n\nåŠ±ç£ç»•ç»„çš„ç”µæµä¸º\n\n$$\ni_f = \\frac{u_f}{r_f}\n$$\n\né˜»å°¼ç»•ç»„ä¸ºçŸ­è·¯å›è·¯ï¼Œæ— ç«¯å£ç”µå‹ï¼Œæ­¤æ—¶ä¸é˜»å°¼ç»•ç»„äº¤é“¾çš„ç£é“¾ä¸ºæ’å€¼ï¼Œæ— å˜å‹å™¨ç”µåŠ¨åŠ¿ï¼Œæ˜¾ç„¶é˜»å°¼ç»•ç»„å†…ç”µæµä¸ºé›¶ï¼Œå³\n\n$$\ni_D=i_Q=0\n$$\n\nå…¶æ¬¡ï¼Œè§£å‡ºç©ºè½½æ—¶ç”µæ¢ç»•ç»„çš„ç«¯ç”µå‹$u_d$ã€$u_q$ï¼Œæ ¹æ®åŒæ­¥ç”µæœºç”µå‹æ–¹ç¨‹å¼ä¸­ç”µæ¢ç»•ç»„éƒ¨åˆ†ï¼Œæœ‰\n\n$$\nu_d=p\\psi_d-\\omega\\psi_q+r_ai_d\\\\\nu_q=p\\psi_q+\\omega\\psi_d+r_ai_q\n$$\n\nä¸Šå¼å³è¾¹ç¬¬ä¸€é¡¹$p\\psi_d$ã€$p\\psi_q$ä¸ºé›¶ï¼Œç”±äºç”µæ¢ç»•ç»„ç”µæµ$i_d$ã€$i_q$å’Œé˜»å°¼ç»•ç»„ç”µæµéƒ½ä¸ºé›¶ï¼Œæ•…$\\psi_d=x_{ad}i_f=$æ’å€¼ï¼Œ$\\psi_q=0$ï¼Œæ•…å…¶å˜åŒ–ç‡$p\\psi$ä¹Ÿä¸ºé›¶ï¼Œç¬¬ä¸‰é¡¹ç”µæ¢ç”µæµå¼•èµ·çš„ç”µé˜»å‹é™äº¦ä¸ºé›¶ã€‚è€ƒè™‘è½¬å­è§’é€Ÿåº¦$\\omega=1$ï¼Œå¯å°†ä¸Šå¼æ”¹å†™ä¸º\n\n$$\nu_d = 0 \\\\\nu_q = \\psi_d = x_{ad}i_f = x_{ad}\\frac{u_f}{i_f}=E_m\n$$\n\nå¼ä¸­ï¼Œ$E_m$ä¸ºç©ºè½½ç”µåŠ¨åŠ¿å¹…å€¼ã€‚$u_q =E_m$æ˜¯ä¸€ä¸ªé‡è¦çš„å…³ç³»ã€‚\n\næœ€åï¼Œå°†ç”µæ¢ç»•ç»„åœ¨dq0åæ ‡ç³»ç»Ÿä¸‹å¾—åˆ°çš„ç©ºè½½ç”µå‹$u_d$ã€$u_q$è¿”å›åˆ°abcåæ ‡ç³»ç»Ÿï¼Œç¨³æ€è¿è¡Œæ—¶ï¼Œå¯ä»»æ„é€‰æ‹©æ—¶é—´çš„èµ·å§‹ç‚¹ï¼Œä¸€èˆ¬å–dè½´å’Œaè½´é‡åˆçš„ç¬é—´ä½œä¸ºæ—¶é—´èµ·ç‚¹ï¼Œå³$\\theta_0=0$ï¼Œè¿™æ ·å°±æœ‰$\\theta=\\omega t + \\theta_0 = t$ï¼Œå°†$u_d$ã€$u_q$é€†å˜æ¢åå¯å¾—ä¸‰ç›¸ç©ºè½½ç”µå‹ä¸º\n\n$$\nu_a = u_d \\cos\\theta - u_q\\sin\\theta = -E_m\\sin t \\\\\nu_b = u_d \\cos (\\theta - 120 \\degree) - u_q \\sin (\\theta - 120 \\degree) = -E_m\\sin (t-120 \\degree)\\\\\nu_c = u_d \\cos (\\theta + 120 \\degree) - u_q \\sin (\\theta + 120 \\degree)=-E_m\\sin (t+120 \\degree)\n$$\n\nç»¼åˆä¸Šå¼å¯ä»¥çœ‹å‡ºï¼Œç¨³æ€è¿è¡Œæ—¶ï¼Œåœ¨abcåæ ‡ç³»ç»Ÿä¸­ï¼Œç”µæ¢ç»•ç»„çš„ç©ºè½½ç”µå‹ä¸ºæŒ‰é¢å®šé¢‘ç‡å˜æ¢çš„æ­£å¼¦é‡ï¼Œè€Œåœ¨dq0åæ ‡ç³»ç»Ÿä¸­åˆ™å˜ä¸ºæ’å®šçš„ç›´æµé‡ã€‚ç”±äºç»•ç»„è½´çº¿çš„å˜æ¢ï¼Œä½¿ç»•ç»„ç”µåŠ¨åŠ¿çš„é¢‘ç‡ä¹Ÿå‘ç”Ÿäº†å˜æ¢ï¼Œè¿™ä¹Ÿå¯ä»¥ä»ç”µæœºå˜æ¢å‰åçš„ç‰©ç†æ¨¡å‹ä¸­æ¸…æ¥šçš„çœ‹åˆ°ã€‚\n\n## è´Ÿè½½è¿è¡Œ\nåŒæ­¥ç”µæœºå¸¦è´Ÿè½½è¿è¡Œæ—¶ï¼Œç«¯ç”µå‹ä¸ç©ºè½½ç”µåŠ¨åŠ¿ä¹‹é—´ä¼šå½¢æˆä¸€å®šçš„ç›¸ä½å·®ã€‚å‡å®šç«¯ç”µå‹æ»åäºç©ºè½½ç”µåŠ¨åŠ¿çš„ç›¸è§’ä¸º$\\delta$ï¼Œå³ä¸º**åŠŸè§’**ã€‚åˆ™ç”µæœºç«¯ç”µå‹çš„ç¬æ—¶å€¼å¯å¯¼å‡ºä¸º\n\n$$\n\\begin{bmatrix}\nu_a \\\\ u_b \\\\ u_c\n\\end{bmatrix}=\n-U_m\n\\begin{bmatrix}\n\\sin (t - \\delta) \\\\\n\\sin (t - \\delta - 120 \\degree) \\\\\n\\sin (t - \\delta + 120 \\degree) \n\\end{bmatrix}\n$$\n\nå¼ä¸­ï¼Œ$U_m$ä¸ºåŒæ­¥ç”µæœºç«¯ç”µå‹å¹…å€¼ã€‚\n\nå°†abcåæ ‡ç³»ç»Ÿçš„ç”µæ¢ç»•ç»„ç”µå‹å˜æ¢è‡³dq0åæ ‡ç³»ç»Ÿï¼Œåˆ™$u_d$ã€$u_q$ã€$u_0$ä¸º\n\n$$\n\\begin{bmatrix}\nu_d \\\\ u_q \\\\ u_0\n\\end{bmatrix}=C\n\\begin{bmatrix}\nu_a \\\\ u_b \\\\ u_c\n\\end{bmatrix}=\n\\begin{bmatrix}\nU_m \\sin \\delta \\\\\nU_m \\cos \\delta \\\\\n0 \\\\\n\\end{bmatrix}\n$$\n\nç¨³æ€è¿è¡Œæ—¶ï¼Œç«¯ç”µå‹å¹…å€¼$U_m$åŠåŠŸè§’$\\delta$çš†ä¸ºæ’å€¼ï¼Œæ‰€ä»¥$u_d$å’Œ$u_q$äº¦ä¸ºæ’å€¼ã€‚åŒæ ·åœ°ï¼Œå¯¹ç§°ç¨³æ€è¿è¡Œæ—¶ï¼Œä¸‰ç›¸ç”µæµ$i_a$ã€$i_b$ã€$i_c$ä»¥åŠç”µæ¢ç»•ç»„ç”µæµ$i_d$ã€$i_q$éƒ½ä¸ºæ’å®šç›´æµä¸”é›¶åºç”µæµ$i_0$ä¸ºé›¶ã€‚æ ¹æ®åŒæ­¥ç”µæœºç£é“¾æ–¹ç¨‹å¼ï¼Œå¯æ±‚å¾—dã€qç»•ç»„çš„ç£é“¾ä¸º\n\n$$\n\\psi_d = x_di_d + x_{ad}i_f = x_di_d + x_{ad}\\frac{u_f}{r_f} = x_di_d + E_m \\\\\n\\psi_q = x_q i_q\n$$\n\næ ¹æ®ä¸Šå¼ï¼Œå½“ç”µæµ$i_d$ã€$i_q$ä¸ºæ’å€¼æ—¶ï¼Œç£é“¾äº¦ä¸ºæ’å€¼ã€‚å°†ä¸Šå¼ä»£å…¥ç”µå‹æ–¹ç¨‹å¼ï¼Œå¹¶è€ƒè™‘åŒæ­¥è½¬é€Ÿä¸‹$\\omega = 1$ï¼Œæœ‰\n\n$$\nu_d = -\\psi_q + r_ai_d = -x_qi_q + r_si_d \\\\\nu_q = \\psi_d + r_ai_q = E_m + x_di_d + r_si_q \\\\\n$$\n\næ­¤å¤„æœ‰$r_s=r_a$ã€‚ä¸‰ç›¸å¯¹ç§°ç»•ç»„ä¸­æ¯ä¸€ç›¸çš„ç”µé˜»éƒ½æ˜¯ä¸€è‡´çš„ï¼Œä¸ºè¡¨ç¤ºæ–¹ä¾¿ï¼Œä¸‹é¢å°†ç”¨$r_s$ä»£æ›¿å®šå­ç”µé˜»ã€‚\n\nå½“å·²çŸ¥ç”µå‹$u_d$ã€$u_q$ã€$u_f$åŠé˜»æŠ—å‚æ•°æ—¶ï¼Œå¯è§£å‡ºç”µæ¢ç»•ç»„ç”µæµ$i_d$ã€$i_q$å¦‚ä¸‹\n\n$$\ni_d = \\frac{r_su_d-x_q(E_m-u_q)}{r_s^2+x_dx_q}=\\frac{r_sU_m\\sin\\delta-x_q(E_m-U_m\\cos\\delta)}{r_s^2+x_dx_q} \\\\\ni_q = \\frac{-x_du_d-r_s(E_m-u_q)}{r_s^2+x_dx_q}=\\frac{-x_du_m\\sin\\delta-r_s(E_m-U_m\\cos\\delta)}{r_s^2+x_dx_q}\n$$\n\nå®é™…ä¸­ï¼ŒåŒæ­¥ç”µæœºå®šå­ç”µé˜»$r_s$çš„å€¼è¿œå°äºç”µæŠ—$x_d$å’Œ$x_q$çš„å€¼ã€‚å½“ç•¥å»å®šå­ç”µé˜»$r_s$æ—¶ï¼Œä¸Šå¼å¯åŒ–ç®€ä¸º\n\n$$\ni_d = -\\frac{E_m-u_q}{x_d}=-\\frac{E_m-U_m\\cos\\delta}{x_d} \\\\\ni_q = - \\frac{u_d}{x_q} = - \\frac{U_m\\sin\\delta}{x_q}\n$$\n\nä»ä¸Šé¢æ±‚è§£è¿‡ç¨‹ä¹Ÿå¯çœ‹å‡ºï¼Œå½“ä¸‰ç›¸å¯¹ç§°ç¨³æ€è¿è¡Œæ—¶ï¼Œå˜æ¢åˆ°dã€qã€0åæ ‡ç³»ç»Ÿä¸‹çš„ç”µæ¢ç»•ç»„ç”µå‹ã€ç”µæµå‡ä¸ºç›´æµã€‚å› æ­¤ï¼Œå°†åŸä¸‰ç›¸ç¨³æ€äº¤æµç”µè·¯çš„é—®é¢˜è½¬å˜æˆäº†ç¨³æ€ç›´æµç”µè·¯çš„é—®é¢˜ï¼Œå³å°†æ±‚è§£å¤ä»£æ•°æ–¹ç¨‹å¼è½¬å˜ä¸ºæ±‚è§£å®ä»£æ•°æ–¹ç¨‹å¼ï¼Œä½¿è®¡ç®—å¤§ä¸ºç®€åŒ–ï¼Œæ˜¾ç¤ºäº†dq0åæ ‡ç³»ç»Ÿåœ¨è§£ä¸‰ç›¸å¯¹ç§°ç¨³æ€è¿è¡Œé—®é¢˜æ—¶çš„ä¼˜è¶Šæ€§ã€‚\n\nåŒæ­¥ç”µæœºå¯¹ç§°ç¨³æ€è¿è¡Œæ—¶çš„ç£é“¾ã€ç”µæµã€ç”µå‹æ±‚å‡ºåï¼Œå°±å¯è¿›ä¸€æ­¥åˆ†æåŒæ­¥å‘ç”µæœºçš„æœ‰åŠŸåŠŸç‡ã€æ— åŠŸåŠŸç‡ä¸ç”µç£è½¬çŸ©ã€‚\n\n### æœ‰åŠŸåŠŸç‡\nåŒæ­¥å‘ç”µæœºç”µæ¢ç«¯çš„æœ‰åŠŸåŠŸç‡ï¼Œåªéœ€å°†ä¹‹å‰æ±‚å‡ºçš„ç”µå‹å’Œç”µæµä»£å…¥ä¸‰ç›¸åŠŸç‡æ ‡å¹ºå€¼å…¬å¼$P=u_di_d+u_qi_q+2u_0i_0$ä¸­å³å¯å¾—åˆ°ï¼Œæ­¤æ—¶è€ƒè™‘å®šå­ç”µé˜»$r_s$ï¼Œä¸º\n\n$$\nP=u_di_d+u_qi_q \\\\\n= U_m\\sin\\delta\\frac{r_sU_m\\sin\\delta-x_q(E_m-U_m\\cos\\delta)}{r_s^2+x_dx_q}+U_m\\cos\\delta\\frac{-x_dU_m\\sin\\delta-r_s(E_m-U_m\\cos\\delta)}{r_s^2+x_dx_q}\\\\\n= \\frac{-1}{r_s^2+x_dx_q}[-r_sU_m^2+E_mU_m(x_q\\sin\\delta+r_s\\cos\\delta)+\\frac{U_m^2}{2}(x_d-x_q)\\sin2\\delta]\n$$\n\nè‹¥ç•¥å»$r_s$ï¼Œåˆ™\n\n$$\nP=-[\\frac{E_mU_m}{x_d}\\sin\\delta+\\frac{U_m^2}{2}(\\frac{1}{x_q}-\\frac{1}{x_d})\\sin2\\delta]\n$$\n\nå¯¹äºéšçº§åŒæ­¥ç”µæœºï¼Œå› å…¶$x_d=x_q$ï¼Œåˆ™æœ‰\n\n$$\nP=-\\frac{E_mU_m}{x_d}\\sin\\delta\n$$\n\nä»ä¸Šé¢å…¬å¼å¯çœ‹å‡ºï¼Œæœ‰åŠŸåŠŸç‡å‰é¢å‡æœ‰è´Ÿå·ï¼Œè¿™æ˜¯ç”±äºæŒ‰ç”µåŠ¨æœºæƒ¯ä¾‹é€‰å–çš„æ­£æ–¹å‘ã€‚å› æ­¤ï¼Œè´ŸåŠŸç‡æ„å‘³ç€ç”µæ¢ç«¯ä¸æ˜¯è¾“å…¥è€Œæ˜¯è¾“å‡ºç”µåŠŸç‡ï¼Œå³è¿è¡Œåœ¨å‘ç”µæœºçŠ¶æ€ã€‚è¿™ä¹Ÿè¯´æ˜æ­£æ–¹å‘çš„å‡è®¾æ˜¯å¯ä»¥äººä¸ºé€‰å®šçš„ã€‚æŒ‰ç”µåŠ¨æœºæƒ¯ä¾‹é€‰å–æ­£æ–¹å‘ï¼ŒåŒæ ·å¯ä»¥åˆ†æå‘ç”µæœºçš„è¿è¡ŒçŠ¶æ€ã€‚æœ¬æ–‡ä¸­åŠŸç‡åŸºå€¼ä¸ºä¸‰ç›¸ç”µæœºçš„é¢å®šå®¹é‡ï¼Œå³$P_b=3U_NI_N$ï¼Œå› æ­¤ï¼Œç”¨æ ‡ä¹ˆå€¼è¡¨ç¤ºçš„åŠŸç‡åœ¨å½¢å¼ä¸Šä¸ç”µæœºå­¦ä¸­ä¸ä¸€è‡´ï¼Œä½†è¿”å›åˆ°æœ‰åå€¼åå°±æ— å·®åˆ«äº†ã€‚\n\n### æ— åŠŸåŠŸç‡\nç”µæœºçš„è§†åœ¨åŠŸç‡$S$ä¸æœ‰åŠŸåŠŸç‡$P$å’Œæ— åŠŸåŠŸç‡$Q$çš„å…³ç³»ä¸º\n\n$$\nQ= \\sqrt {S^2-P^2}\n$$\n\nå¼ä¸­$S$ä¸ºæ ‡å¹ºå€¼ã€‚\n\nä¸‰ç›¸è§†åœ¨åŠŸç‡çš„æœ‰åå€¼ä¸º$3UI$ï¼Œåˆ™æœ‰\n\n$$\nS=\\frac{3UI}{P_b}=\\frac{\\frac{3}{2}U_mI_m}{\\frac{3}{2}U_bI_b}=U_mI_m\n$$\n\nå¼ä¸­$U_m$å’Œ$I_m$åˆ†åˆ«ä¸ºç”¨æ ‡å¹ºå€¼è¡¨ç¤ºçš„ç”µæ¢ç»•ç»„ç«¯ç”µå‹å’Œç”µæµçš„å¹…å€¼ï¼Œå®ƒä»¬ä¸dã€qè½´ç”µæ¢ç»•ç»„çš„ç«¯ç”µå‹å’Œç”µæµçš„å…³ç³»åˆ†åˆ«ä¸º\n\n$$\nU_m=\\sqrt{u_d^2+u_q^2},I_m=\\sqrt{i_d^2+i_q^2}\n$$\n\nå°†è§†åœ¨åŠŸç‡$S$ä¸æœ‰åŠŸåŠŸç‡$P$ä»£å…¥ä¸Šå¼ï¼Œå¯å¾—æ— åŠŸåŠŸç‡$Q$çš„æ ‡å¹ºå€¼ä¸º\n\n$$\nQ=\\sqrt{(u_d^2+u_q^2)(i_d^2+i_q^2)-(u_di_d+u_qi_q)^2}=u_qi_d-u_di_q\n$$\n\nä»£å…¥ç”µå‹å’Œç”µæµï¼Œæœ‰\n\n$$\nQ=\\frac{-1}{r_s^2+x_dx_q}[E_mU_m(x_q\\cos\\delta-r_s\\sin\\delta)-\\frac{U_m^2}{2}(x_d+x_q)+\\frac{U_m^2}{2}(x_d-x_q)\\sin2\\delta]\n$$\n\nç•¥å»$r_s$æ—¶ï¼Œæœ‰\n\n$$\nQ=-[\\frac{E_mU_m}{x_d}\\cos\\delta-\\frac{U_m^2}{2}(\\frac{1}{x_q}+\\frac{1}{x_d})+\\frac{U_m^2}{2}(\\frac{1}{x_q}-\\frac{1}{x_d})\\sin2\\delta]\n$$\n\nè‹¥ä¸ºéšçº§åŒæ­¥ç”µæœºï¼Œå› $x_d=x_q$ï¼Œåˆ™\n\n$$\nQ=-(\\frac{E_mU_m}{x_d}\\cos\\delta-\\frac{U_m^2}{x_d})\n$$\n\n### ç”µç£è½¬çŸ©\nå°†ç£é“¾å¼å’Œç”µæµå¼ä»£å…¥ç”µç£è½¬çŸ©å…¬å¼ï¼Œæœ‰\n\n$$\nT_{em}=i_q\\psi_d-i_d\\psi_q=-\\frac{r_s(r_s^2+x_q^2)E_m^2}{(r_s^2+x_dx_q)^2}-\\frac{E_mU_m}{(r_s^2+x_dx_q)^2} \\\\\n\\times [(r_sx_d\\sin\\delta-x_q^2\\cos\\delta)2r_s+(x_dx_q-r_s^2)(r_s\\cos\\delta+x_q\\sin\\delta)] \\\\\n- \\frac{(x_d-x_q)U_m^2}{(r_s^2+x_dx_q)^2}[(x_d\\sin^2\\delta-x_q\\cos^2\\delta)r_s+\\frac{1}{2}(x_dx_q-r_s^2)\\sin2\\delta]\n$$\n\nä¸Šå¼ä¸­ï¼Œç­‰å·å·¦ä¾§ç”µç£è½¬çŸ©ç¬¦å·ä¸ºè´Ÿï¼Œè¯´æ˜è¯¥è½¬çŸ©æ–¹å‘ä¸å‡å®šæ­£æ–¹å‘ç›¸åï¼Œä¸ºåˆ¶åŠ¨è½¬çŸ©ã€‚\n\nä¸Šå¼ä¸­ç­‰å·å³ä¾§çš„ç¬¬ä¸€é¡¹ç§°ä¸ºçŸ­è·¯è½¬çŸ©ï¼Œä¸ºç”µæœºç¨³æ€çŸ­è·¯$(U_m=0)$æ—¶çš„è½¬çŸ©ã€‚çŸ­è·¯æ—¶ç”µæ¢ç”µæµ$i_{dk}$ã€$i_{qk}$ä¸º\n\n$$\ni_{dk}=-\\frac{x_qE_m}{r_s^2+x_dx_q},i_{qk}=-\\frac{r_sE_m}{r_s^2+x_dx_q}\n$$\n\nå› æ­¤ï¼Œç”µæ¢çŸ­è·¯ç”µæµæ‰€å¼•èµ·çš„ç”µæ¢ç”µé˜»æŸè€—ä¸º\n\n$$\ni_{dk}^2r_s+i_{qk}^2r_s=I_{km}^2r_s=\\frac{(r_s^2+x_q^2)E_m^2}{(r_s^2+x_dx_q)}r_s\n$$\n\nå› $r_s^2 << x_q^2$ï¼Œä¸”$r_s^2 << x_dx_q$ï¼Œå¯ç•¥å»$r_s$çš„äºŒæ¬¡é¡¹ï¼Œæ”¹å†™ä¸Šå¼ä¸º\n\n$$\nT_k=-\\frac{(r_s^2+x_q^2)E_m^2}{(r_s^2+x_dx_q)^2}r_s \\approx -(\\frac{E_m}{x_d})^2r_s=-I_{km}^2r_s\n$$\n\nå› æ­¤ï¼ŒçŸ­è·¯è½¬çŸ©$T_k$ä»…ä¸åŠ±ç£ç»•ç»„ç”µæµäº§ç”Ÿçš„ç©ºè½½ç”µåŠ¨åŠ¿$E_m$æœ‰å…³ï¼Œè€Œä¸ç«¯ç”µå‹$U_m$æ— å…³ã€‚å½“ç•¥å»ç”µæ¢ç»•ç»„ç”µé˜»$r_s$æ—¶ï¼Œè¯¥è½¬çŸ©ä¸ºé›¶ã€‚\n\nè½¬çŸ©å…¬å¼ä¸­ç­‰å·å³ä¾§çš„ç¬¬äºŒé¡¹ä¸ºåŒæ­¥è½¬çŸ©$T_s$ï¼Œå®ƒä¸ä»…ä¸åŠ±ç£ç”µæµäº§ç”Ÿçš„ç©ºè½½ç”µåŠ¨åŠ¿$E_m$æœ‰å…³ï¼Œè¿˜å’Œç”µæ¢ç»•ç»„çš„ç«¯ç”µå‹$U_m$æœ‰å…³ï¼Œå…¶å¯¹åº”åŸºæœ¬ç”µç£åŠŸç‡éƒ¨åˆ†ã€‚å½“ç•¥å»$r_s$æ—¶ï¼Œ$T_s$å˜ä¸º\n\n$$\nT_s = \\frac{E_mU_m}{x_d}\\sin\\delta\n$$\n\nè½¬çŸ©å…¬å¼ä¸­ç­‰å·å³ä¾§çš„ç¬¬ä¸‰é¡¹ä¸ºç£é˜»è½¬çŸ©$T_r$ï¼Œåªæœ‰å½“ç›´è½´å’Œäº¤è½´ç£é˜»ä¸ç­‰$(x_d \\neq x_q)$æ—¶ï¼Œè¯¥è½¬çŸ©æ‰å­˜åœ¨ï¼Œä¸”åªä¸$U_m$æœ‰å…³ã€‚å…¶å¯¹åº”ç”µç£åŠŸç‡ä¸­çš„ç£é˜»åŠŸç‡éƒ¨åˆ†ã€‚å½“ç•¥å»$r_s$æ—¶ï¼Œ$T_r$å˜ä¸º\n\n$$\nT_r = - \\frac{U_m^2}{2}(\\frac{1}{x_q}-\\frac{1}{x_d})\\sin2\\delta\n$$\n\nå½“ç•¥å»ç”µæ¢ç”µé˜»æ—¶ï¼Œç¨³æ€å¯¹ç§°æƒ…å†µä¸‹æ€»çš„ç”µç£è½¬çŸ©ä¸º\n\n$$\nT_{em}=-\\frac{E_mU_m}{x_d}\\sin\\delta-\\frac{U_m^2}{2}(\\frac{1}{x_q}-\\frac{1}{x_d})\\sin2\\delta\n$$\n\nå¯ä»¥çœ‹å‡ºï¼Œç•¥å»ç”µæ¢ç”µé˜»åï¼Œä¸”ç›´è½´å’Œäº¤è½´ç£é˜»ç›¸ç­‰æ—¶ï¼Œç”¨æ ‡å¹ºå€¼è¡¨ç¤ºçš„ç”µç£è½¬çŸ©å¼ï¼ˆä¸Šå¼ï¼‰ä¸ç”µæ¢ç«¯æœ‰åŠŸåŠŸç‡å¼å®Œå…¨ä¸€è‡´ã€‚ä¸ç”µç£è½¬çŸ©ç›¸å¯¹åº”çš„ç”µç£åŠŸç‡åœ¨ä¸è€ƒè™‘ç”µæ¢ç”µé˜»æŸè€—æ—¶ï¼Œå°±æ˜¯ç”µæ¢ç«¯çš„æœ‰åŠŸåŠŸç‡ã€‚\n","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºç»¼åˆåŠ¨æ€æ–¹ç¨‹å¼","url":"/2024/08/02/ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºç»¼åˆåŠ¨æ€æ–¹ç¨‹å¼/","content":"### ç®€ä»‹\nåœ¨å®é™…è¿è¡Œä¸­ï¼Œä¸è®ºç”µæœºå—åˆ°ç”µç£æ–¹é¢æˆ–æ˜¯æœºæ¢°æ–¹é¢çš„æ‰°åŠ¨ï¼Œéƒ½å¯ä»¥ä½¿ç”µæœºçš„è½¬çŸ©å¤±å»å¹³è¡¡ï¼Œå¯¼è‡´å‘ç”Ÿæœºç”µè¿‡æ¸¡è¿‡ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ—¢æœ‰ç”µæœºçš„ç”µæµã€ç£é“¾ã€ç”µç£è½¬çŸ©ç­‰ç”µç£é‡çš„å˜åŒ–ï¼Œåˆæœ‰ç”µæœºçš„è½¬é€Ÿã€æœºæ¢°è½¬çŸ©ç­‰æœºæ¢°é‡çš„å˜åŒ–ï¼Œä¸¤è€…æ˜¯ç›¸äº’å½±å“çš„ã€‚ä¹‹å‰å‡ ä¸ªå°èŠ‚æ‰€å¯¼å‡ºçš„ç”µå‹æ–¹ç¨‹å¼å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼ï¼Œæ­£ç¡®åœ°åæ˜ äº†ç”µæœºçš„ç”µç£ã€æœºæ¢°ç­‰é‡çš„å†…åœ¨è”ç³»å’Œç›¸äº’åˆ¶çº¦çš„å…³ç³»ã€‚å› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åº”è¯¥è”ç«‹æ±‚è§£ç”µå‹æ–¹ç¨‹å¼å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼ã€‚\n\nå½“è½¬é€Ÿä¸æ˜¯æ’å€¼è€Œæ˜¯å˜é‡æ—¶ï¼Œç”µå‹æ–¹ç¨‹å¼ä¸­çš„$\\omega \\psi$ä¸ºä¸¤ä¸ªå˜é‡çš„ä¹˜ç§¯ï¼Œè½¬çŸ©æ–¹ç¨‹å¼ä¸­ç”µç£è½¬çŸ©$T_{em}=i_q\\psi_d-i_d\\psi_q$ï¼Œäº¦æ˜¯ä¸¤ä¸ªå˜é‡çš„ä¹˜ç§¯ï¼Œå› æ­¤ï¼Œè½¬æ¢ä¸ºdã€qã€0åæ ‡ç³»ç»Ÿçš„åŒæ­¥ç”µæœºç”µå‹æ–¹ç¨‹å¼å’Œè½¬çŸ©æ–¹ç¨‹å¼ï¼Œå‡ä¸ºéçº¿æ€§å¾®åˆ†æ–¹ç¨‹å¼ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ— æ³•é‡‡ç”¨è§£ææ³•è€Œéœ€é‡‡ç”¨æ•°å€¼æ³•æ±‚è§£ã€‚\n\nå°†å‡¸æåŒæ­¥ç”µæœºçš„ç”µå‹æ–¹ç¨‹å¼å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼åˆå¹¶ï¼Œå¯å¾—å‡¸æåŒæ­¥ç”µæœºçš„åŠ¨æ€æ–¹ç¨‹å¼ã€‚ä»¥è¯¥æ–¹ç¨‹å¼ä¸ºåŸºç¡€ï¼Œæ ¹æ®éšæåŒæ­¥ç”µæœºå’Œæ„Ÿåº”ç”µæœºçš„å®é™…æƒ…å†µåšé€‚å½“ç®€åŒ–ï¼Œå¯åˆ†åˆ«å¾—åˆ°ä»–ä»¬å„è‡ªçš„åŠ¨æ€æ–¹ç¨‹å¼ã€‚\n\n### å‡¸çº§åŒæ­¥ç”µæœºåŠ¨æ€æ–¹ç¨‹å¼\nä»¤æœºæ¢°é˜»å°¼è½¬çŸ©ä¸º\n\n$$\nT_D=k_p\\frac{d\\theta}{dt}=k_D \\omega$$\nå¼ä¸­$k_D$ä¸ºæœºæ¢°é˜»å°¼ç³»æ•°ã€‚\n\nåˆ™è½¬å­è¿åŠ¨æ–¹ç¨‹å¼ä¸º\n$$\nH\\frac{d\\omega}{dt}=T_{em}-T_L-T_D=i_q\\psi_d-i_d\\psi_q-T_L-k_D\\omega\\\\\n=x_di_qi_d+x_{ad}i_qi_f+x_{ad}i_qi_D-x_qi_di_q-x_{aq}i_di_Q-T_L-k_D\\omega\n$$\nåˆå¹¶ç”µå‹æ–¹ç¨‹å¼å’Œä¸Šå¼ï¼ˆè½¬çŸ©æ–¹ç¨‹å¼ï¼‰ï¼Œå¯å¾—å‡¸çº§åŒæ­¥ç”µæœºçš„åŠ¨æ€æ–¹ç¨‹ä¸º\n$$\n\\begin{bmatrix}\nu_d \\\\ u_q \\\\ u_0 \\\\ u_f \\\\ 0 \\\\ 0 \\\\T_L \\\\ 0\n\\end{bmatrix}=\n\\begin{bmatrix}\nx_d & 0 & 0 & x_{ad} & x_{ad} & 0 & 0 & 0 \\\\\n0 & x_q & 0 & 0 & 0 & x_{aq} & 0 & 0 \\\\\n0 & 0 & x_0 & 0 & 0 & 0 & 0 & 0 \\\\\nx_{ad} & 0 & 0 & x_f & x_{ad} & 0 & 0 & 0\\\\\nx_{ad} & 0 & 0 & x_{ad} & x_D & 0 & 0 & 0\\\\\n0 & x_{aq} & 0 & 0 & 0 & x_Q & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 & -H & 0\\\\\n0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\\\\n\\end{bmatrix}p\n\\begin{bmatrix}\ni_d \\\\ i_q \\\\ i_0 \\\\ i_f \\\\ i_D\\\\ i_Q\\\\ \\omega\\\\\\theta\n\\end{bmatrix}\n+\n\\begin{bmatrix}\nr_s & -\\omega x_q & 0 & 0 & 0 & -\\omega x_{aq} & 0 & 0 \\\\\n\\omega x_d & r_s & 0 & \\omega x_{ad} & \\omega x_{ad} & 0 & 0 & 0 \\\\\n0 & 0 & r_s & 0 & 0 & 0 & 0 & 0\\\\\n0 & 0 & 0 & r_f & 0 & 0 & 0 & 0\\\\\n0 & 0 & 0 & 0 & r_D & 0 & 0 & 0\\\\\n0 & 0 & 0 & 0 & 0 & r_Q & 0 & 0\\\\\nx_di_q & -x_qi_d & 0 & x_{ad}i_q & x_{ad}i_q & -x_{aq}i_d & -k_D & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 & -1 & 0\\\\\n\\end{bmatrix}\n\\begin{bmatrix}\ni_d \\\\ i_q \\\\ i_0 \\\\ i_f \\\\ i_D\\\\ i_Q\\\\ \\omega\\\\\\theta\n\\end{bmatrix}\n$$\n\næ˜¾ç„¶è¿™æ˜¯ä¸€ç»„éçº¿æ€§å¾®åˆ†æ–¹ç¨‹ï¼Œç›´æ¥æ±‚è§£è¾ƒä¸ºå›°éš¾,æ±‚è§£å®é™…é—®é¢˜æ—¶ï¼Œå¯æ ¹æ®æ±‚è§£é—®é¢˜çš„æ¡ä»¶ï¼Œä»å·¥ç¨‹è§’åº¦å‡ºå‘ï¼Œåšä¸€äº›é€‚å½“çš„ç®€åŒ–ã€‚\n\nå½“è½¬å­è½¬é€Ÿ$\\omega$ä¸ºæ’å€¼ï¼Œä¸”å·±çŸ¥æ—¶ï¼Œå¯¹è¿™ç±»é—®é¢˜çš„æ±‚è§£å°±æ— éœ€æ±‚è§£è½¬å­è¿åŠ¨æ–¹ç¨‹å¼ï¼Œåªéœ€å•ç‹¬æ±‚è§£ç”µå‹æ–¹ç¨‹å¼ï¼Œè¿™æ—¶æ–¹ç¨‹å¼æ˜¯ä¸€ç»„çº¿æ€§å¸¸ç³»æ•°å¾®åˆ†æ–¹ç¨‹å¼ï¼Œå¯ç”¨è§£ææ³•æ±‚è§£ã€‚å¯¹äºå˜é€Ÿé—®é¢˜ï¼Œç”±äº$\\omega$æ˜¯å˜é‡ï¼Œå¿…é¡»è”ç«‹æ±‚è§£ç”µå‹æ–¹ç¨‹å¼å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼ï¼Œè¿™æ—¶æ–¹ç¨‹å¼æ˜¯ä¸€ç»„éçº¿æ€§å¾®åˆ†æ–¹ç¨‹å¼ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªèƒ½å°†ä¸Šå¼æ”¹å†™ä¸ºçŠ¶æ€æ–¹ç¨‹å¼ï¼Œé‡‡ç”¨æ•°å€¼æ³•æ±‚è¿‘ä¼¼è§£ã€‚\n\n### éšçº§åŒæ­¥ç”µæœºåŠ¨æ€æ–¹ç¨‹å¼\néšçº§åŒæ­¥ç”µæœºä¸ºæŸ±å½¢è½¬å­ï¼Œç›´è½´ä¸äº¤è½´ç£å¯¼ç›¸åŒï¼Œæ‰€ä»¥æœ‰\n$$\nx_{ad}=x_{aq},x_d=x_q\n$$\næŒ‰ç…§æ­¤å…³ç³»å¯¹å‡¸çº§åŒæ­¥ç”µæœºåŠ¨æ€æ–¹ç¨‹ä¸­çš„å‚æ•°ä½œä¿®æ”¹åå³å¯å¾—åˆ°éšçº§åŒæ­¥ç”µæœºçš„åŠ¨æ€æ–¹ç¨‹å¼ã€‚\n\n### æ„Ÿåº”ç”µæœºåŠ¨æ€æ–¹ç¨‹å¼\næ„Ÿåº”ç”µæœºä¸­å®šå­ä¸‰ç›¸ç»•ç»„ä¸ºå¯¹ç§°ï¼Œè½¬å­ä¸ºåœ†æŸ±å½¢ï¼Œä¸”æ— åŠ±ç£ç»•ç»„ï¼Œè€Œè½¬å­ä¸è®ºæ˜¯ç»•çº¿å‹è¿˜æ˜¯é¼ ç¬¼å‹éƒ½ä¸ºå¯¹ç§°ç»•ç»„ï¼Œæ‰€ä»¥æ„Ÿåº”ç”µæœºä¸­å®šå­ã€è½¬å­çš„ç£è·¯å’Œç”µè·¯å‡ä¸ºå¯¹ç§°ï¼Œå› è€Œç›´è½´å’Œäº¤è½´ç”µæ¢ååº”ç”µæŠ—ç›¸ç­‰ï¼Œå³$x_{ad}=x_{aq}=x_m$ã€‚ç”µæ¢ç»•ç»„ä¸­$x_d=x_q=x_{ss}=x_{sl}+x_m$ï¼ŒåŸè½¬å­ç»•ç»„ä¸­ç›´è½´å’Œäº¤è½´é˜»å°¼ç»•ç»„å‚æ•°åº”è¯¥ä¸ºç°è½¬å­ç»•ç»„çš„ç›¸åº”ç”µæŠ—$x_{rr}$å’Œç”µé˜»$r_r$ï¼Œå³\n$$\nx_D=x_Q=x_{rr}=x_{rl}+x_m,r_D=r_Q=r_r\n$$\nå°†å‚æ•°ä»£å…¥åŸå‡¸çº§åŒæ­¥ç”µæœºçš„åŠ¨æ€æ–¹ç¨‹å¼ï¼Œå¹¶å°†å¼ä¸­çš„ç¬¬å››è¡Œã€ç¬¬å››åˆ—å»æ‰ï¼Œè½¬å­ç›´è½´é˜»å°¼ç»•ç»„ç”µæµ$i_D$æ”¹ä¸ºè½¬å­ç›´è½´ç»•ç»„ç”µæµ$i_{dr}$ï¼Œäº¤è½´é˜»å°¼ç»•ç»„ç”µæµ$i_Q$æ”¹ä¸ºè½¬å­äº¤è½´ç»•ç»„ç”µæµ$i_{qr}$ï¼Œå³å¯å¾—åˆ°æ„Ÿåº”ç”µæœºåŠ¨æ€æ–¹ç¨‹å¼ã€‚\n\nç”±äºæ„Ÿåº”ç”µæœºå®šå­ã€è½¬å­ç£è·¯ã€ç”µè·¯å‡å¯¹ç§°ï¼Œè½¬å­ä½ç½®æ”¹å˜æ—¶ç£è·¯çš„ç£å¯¼ä¸å˜ï¼Œæ•…åæ ‡å˜æ¢æ—¶ï¼Œåªè¦ç»•ç»„è½´çº¿ç›¸å¯¹é™æ­¢ï¼Œå°±å¯ä»¥ä½¿ç”µæ„Ÿç³»æ•°å˜ä¸ºå¸¸ç³»æ•°ï¼Œè¿™æ ·ç»•ç»„è½´çº¿æ—¢å¯é€‰åœ¨å®šå­æ–¹é¢ä¹Ÿå¯é€‰åœ¨è½¬å­æ–¹é¢ã€‚\n\n","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"æ™¶æŒ¯åŠå…¶å…¸å‹åº”ç”¨ä¸è®¾è®¡å‚æ•°","url":"/2024/07/31/æ™¶æŒ¯åŠå…¶å…¸å‹åº”ç”¨ä¸è®¾è®¡å‚æ•°/","content":"\n### æœ‰æºæ™¶æŒ¯(Oscillator)å’Œæ— æºæ™¶æŒ¯(Crystal)\næ™¶æŒ¯å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š\n- æœ‰æºæ™¶æŒ¯(Oscillator)\n- æ— æºæ™¶æŒ¯(Crystal)\n\n#### æœ‰æºæ™¶æŒ¯(Oscillator)\n\nåˆè¢«ç§°ä¸ºçŸ³è‹±æ™¶ä½“æŒ¯è¡å™¨ï¼ˆç®€å†™OSCæˆ–XOï¼‰ã€‚\n\næœ‰æºæ™¶æŒ¯åŒ…å«*æ™¶ä½“æŒ¯è¡å™¨*å’Œ*å¤–å›´é›†æˆç”µè·¯*ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå·¥ç¨‹ä¸Šå¤šé›†æˆäºåŒä¸€å°è£…å†…ï¼Œä»¥4pinè´´ç‰‡å½¢å¼å‡ºç°ï¼Œä½“ç§¯è¾ƒå¤§ï¼Œå¼•è„šåˆ†åˆ«ä¸ºVCCã€GNDã€OUTå’ŒNCã€‚\n\næœ‰æºæ™¶æŒ¯ä¸éœ€è¦ä½¿ç”¨MCUçš„å†…éƒ¨æŒ¯è¡å™¨ï¼Œä¿¡å·ç¨³å®šï¼Œè´¨é‡è¾ƒå¥½ï¼Œè€Œä¸”è¿æ¥æ–¹å¼æ¯”è¾ƒç®€å•ï¼ˆä»éœ€è®¾ç½®ç”µæºæ»¤æ³¢ï¼Œé€šå¸¸ä½¿ç”¨ä¸€ä¸ªç”µå®¹å’Œç”µæ„Ÿæ„æˆæ»¤æ³¢ç½‘ç»œï¼Œè¾“å‡ºç«¯ç”¨ä¸€ä¸ªå°é˜»å€¼çš„ç”µé˜»è¿‡æ»¤ä¿¡å·ï¼‰ï¼Œä¸éœ€è¦å¤æ‚çš„é…ç½®ç”µè·¯ã€‚\n\né€‚ç”¨åœºæ™¯ï¼šæœ‰æˆæœ¬å’ŒåŠŸè€—è¦æ±‚ï¼Œæ—¶é’Ÿä¿¡å·ç²¾åº¦ã€ç¨³å®šæ€§è¦æ±‚ä¸é«˜ï¼ŒICå†…éƒ¨æœ‰æ™¶æŒ¯æ—¶é’Ÿç”µè·¯ã€‚\n\næœ‰æºæ™¶æŒ¯åŸå§‹è¾“å‡ºæ³¢å½¢ä¸€èˆ¬ä¸º**æ–¹æ³¢**ï¼ˆè‹¥å°è£…å†…å·²é›†æˆæ•´å½¢ç”µè·¯ï¼‰ã€‚å®é™…è§‚æµ‹æ—¶å› ç¤ºæ³¢å™¨å¸¦å®½é™åˆ¶å¯èƒ½æ— æ³•çœ‹åˆ°æ–¹æ³¢è€Œåªèƒ½çœ‹åˆ°æ­£å¼¦æ³¢ï¼Œå› æ–¹æ³¢çš„å‚…é‡Œå¶åˆ†è§£ç»“æœä¸ºåŸºé¢‘å’Œå¥‡æ•°æ¬¡è°æ³¢å åŠ ï¼Œè‹¥å¸¦å®½ä¸å¤Ÿï¼Œå¾ˆå®¹æ˜“åªèƒ½çœ‹åˆ°é«˜é¢‘æ–¹æ³¢çš„ä½é¢‘è°æ³¢åˆ†é‡ï¼Œå³åªæ˜¾ç¤ºæ­£å¼¦æ³¢ã€‚å‚è§ï¼š[æœ‰æºæ™¶æŒ¯å’Œæ— æºæ™¶æŒ¯çš„è¾“å‡ºæ³¢å½¢](https://blog.csdn.net/qq_29350001/article/details/50680676)\n\n![æœ‰æºæ™¶æŒ¯åŸå§‹è¾“å‡ºæ³¢å½¢](/images/crystal/1.png)\n\n#### æ— æºæ™¶æŒ¯(Crystal)\n\nåˆè¢«ç§°ä¸ºçŸ³è‹±æ™¶ä½“ï¼ˆXtalï¼‰ã€‚\n\næ— æºæ™¶æŒ¯æ˜¯æœ‰2ä¸ªå¼•è„šçš„æ— ææ€§å…ƒä»¶ï¼Œéœ€è¦å€ŸåŠ©äºæ—¶é’Ÿç”µè·¯æ‰èƒ½äº§ç”ŸæŒ¯è¡ä¿¡å·ï¼Œè‡ªèº«æ— æ³•èµ·æŒ¯ã€‚å…¶ä¿¡å·è´¨é‡è¾ƒå·®ï¼Œé€šå¸¸éœ€è¦ç²¾ç¡®åŒ¹é…å¤–å›´ç”µè·¯ï¼ˆç”¨äºä¿¡å·åŒ¹é…çš„RLCå…ƒä»¶ï¼‰ï¼Œæ›´æ¢ä¸åŒé¢‘ç‡çš„æ™¶ä½“æ—¶å‘¨è¾¹é…ç½®ç”µè·¯ä¹Ÿéœ€è¦åšç›¸åº”çš„è°ƒæ•´ã€‚\n\né€‚ç”¨åœºæ™¯ï¼šæ—¶é’Ÿè¦æ±‚é«˜ï¼ŒICå†…éƒ¨æ— æ™¶æŒ¯æ—¶é’Ÿç”µè·¯ã€‚\n\næ— æºæ™¶æŒ¯åŸå§‹è¾“å‡ºæ³¢å½¢ä¸º**æ­£å¼¦æ³¢**ã€‚\n\n![æ— æºæ™¶æŒ¯åŸå§‹è¾“å‡ºæ³¢å½¢](/images/crystal/2.png)\n\n### æ— æºæ™¶æŒ¯çš„åˆ†ææ¨¡å‹\n#### ç”µæ°”æ¨¡å‹\nåœ¨ç”µæ°”ç½‘ç»œä¸­ï¼ŒçŸ³è‹±æ™¶ä½“å¯ä»¥è½¬æ¢æˆä¸€ç»„RLCç­‰æ•ˆç”µè·¯ï¼Œä»¥åˆ©åˆ†æã€‚è¿™ä¸€ç”µè·¯æ¨¡å‹æœ‰ä¸¤ä¸ªé¢‘ç‡æ¥è¿‘ä½†ç‰¹æ€§ä¸åŒçš„å…±æŒ¯ç‚¹ï¼š**ä½é˜»æŠ—çš„ä¸²è”å…±æŒ¯ç‚¹**ä¸**é«˜é˜»æŠ—çš„å¹¶è”å…±æŒ¯ç‚¹**ã€‚\n\n![æ— æºæ™¶æŒ¯ç”µè·¯ç¬¦å·ä¸ç­‰æ•ˆç”µè·¯](/images/crystal/3.png)\n\n$Laplace$å˜æ¢åï¼Œè¯¥ç­‰æ•ˆç”µè·¯ç½‘ç»œçš„é˜»æŠ—å¯ä»¥å†™æˆä»¥ä¸‹å½¢å¼ï¼š\n$$\nZ(s)=(\\frac{1}{sC_1}+sL_1+R_1)//(\\frac{1}{sC_0})\n$$\næˆ–\n$$\nZ(s)=\\frac{s^2+s\\frac{r_1}{L_1}+\\omega_s^2}{(sC_0)[s^2+s\\frac{R_1}{L_1}+\\omega_p^2]}\n$$\n$$\n\\omega_s = 1/(\\sqrt{L_1C_1})\n$$\n$$\n\\omega_p = \\sqrt{\\frac{C_1+C_0}{L_1C_1C_0}}=\\omega_s \\sqrt{1+\\frac{C_1}{C_0}} \\approx \\omega_s(1+\\frac{C_1}{2C_0}) (C_0 >> C_1)\n$$\nå¼ä¸­$s=j\\omega$ï¼Œ$\\omega_s$ä¸ºä¸²è”å…±æŒ¯é¢‘ç‡ï¼Œ$\\omega_p$ä¸ºå¹¶è”å…±æŒ¯é¢‘ç‡ï¼Œå•ä½å‡ä¸º$rad/s$ã€‚\n\nåœ¨æ™¶ä½“ä¸¤ç«¯å¹¶è”ä¸Šé¢å¤–çš„å¹¶è”ç”µå®¹å™¨ä¼šä½¿å¹¶è”åçš„æ•´ä½“å…±æŒ¯é¢‘ç‡é™ä½ï¼Œå› æ­¤ï¼ŒçŸ³è‹±æ™¶ä½“å‚å•†åœ¨åˆ¶ä½œå¹¶æµ‹é‡çŸ³è‹±æ™¶ä½“çš„å¹¶è”å…±æŒ¯é¢‘ç‡æ—¶ï¼Œä¼šåœ¨ç‰¹å®šçš„å¹¶è”ç”µå®¹å€¼ï¼ˆç§°ä¸ºè´Ÿè½½ç”µå®¹ï¼‰ä¸‹è¿›è¡Œæµ‹è¯•ã€‚å¦‚ä½¿ç”¨è¾ƒå°çš„ç”µå®¹å€¼ï¼ŒæŒ¯è¡é¢‘ç‡ä¼šæ¯”è§„æ ¼é«˜ï¼Œåä¹‹æ¯”è§„æ ¼ä½ã€‚è¿™ä¸€ç‰¹æ€§ä¹Ÿå¯ä»¥ç”¨æ¥å¾®è°ƒæŒ¯è¡é¢‘ç‡ã€‚\n\n#### å…±æŒ¯æ¨¡å¼\nçŸ³è‹±æ™¶ä½“æä¾›äº†ä¸¤ç§å…±æŒ¯æ¨¡å¼ï¼Œç”±$C_1$ä¸$L_1$æ„æˆçš„ä¸²è”å…±æŒ¯ï¼Œä¸ç”±$C_0$ã€$C_1$ä¸$L_1$æ„æˆçš„å¹¶è”å…±æŒ¯ã€‚\n\nå¯¹äºä¸€èˆ¬çš„MHzçº§çŸ³è‹±æ™¶ä½“è€Œè¨€ï¼Œä¸²è”å…±æŒ¯é¢‘ç‡ä¸€èˆ¬ä¼šæ¯”å¹¶è”å…±æŒ¯é¢‘ç‡ä½è‹¥å¹²KHzã€‚é¢‘ç‡åœ¨30MHzä»¥ä¸‹çš„çŸ³è‹±æ™¶ä½“ï¼Œé€šå¸¸å·¥ä½œæ—¶çš„é¢‘ç‡å¤„äºä¸²è”å…±æŒ¯é¢‘ç‡ä¸å¹¶è”å…±æŒ¯é¢‘ç‡ä¹‹é—´ï¼Œæ­¤æ—¶çŸ³è‹±æ™¶ä½“å‘ˆç°ç”µæ„Ÿæ€§é˜»æŠ—ã€‚å› ä¸ºï¼Œå¤–éƒ¨ç”µè·¯ä¸Šçš„ç”µå®¹ä¼šæŠŠç”µè·¯çš„æŒ¯è¡é¢‘ç‡æ‹‰ä½ä¸€äº›ã€‚åœ¨è®¾è®¡çŸ³è‹±æ™¶ä½“æŒ¯è¡ç”µè·¯æ—¶ï¼Œä¹Ÿåº”ä»¤ç”µè·¯ä¸Šçš„æ‚æ•£ç”µå®¹ä¸å¤–åŠ ç”µå®¹åˆè®¡å€¤ä¸æ™¶ä½“å‚å•†ä½¿ç”¨çš„è´Ÿè½½ç”µå®¹å€¼ç›¸åŒï¼ŒæŒ¯è¡é¢‘ç‡æ‰ä¼šå‡†ç¡®ç¬¦åˆå‚å•†çš„è§„æ ¼ã€‚\n\né¢‘ç‡åœ¨30MHzä»¥ä¸Šï¼ˆåˆ°200MHzï¼‰çš„çŸ³è‹±æ™¶ä½“ï¼Œé€šå¸¸å·¥ä½œäºä¸²è”å…±æŒ¯æ¨¡å¼ï¼Œå·¥ä½œæ—¶çš„é˜»æŠ—å¤„äºæœ€ä½ç‚¹ï¼Œç›¸å½“äº$R_s$ã€‚æ­¤ç§æ™¶ä½“é€šå¸¸æ ‡ç¤ºä¸²è”ç”µé˜»ï¼ˆ< 100 $\\Omega$ï¼‰è€Œéå¹¶è”è´Ÿè½½ç”µå®¹ã€‚ä¸ºäº†è¾¾åˆ°é«˜çš„æŒ¯è¡é¢‘ç‡ï¼ŒçŸ³è‹±æ™¶ä½“ä¼šæŒ¯è¡åœ¨å®ƒçš„ä¸€ä¸ªè°æ³¢é¢‘ç‡ä¸Šï¼Œæ­¤è°æ³¢é¢‘ç‡æ˜¯åŸºé¢‘çš„æ•´æ•°å€ã€‚å› ä¸ºå¶æ•°æ¬¡è°æ³¢ä¼šä½¿å¾—æ™¶ä½“å†…ç”µåœºäº’ç›¸æŠµæ¶ˆï¼Œåªæœ‰å¥‡æ•°æ¬¡è°æ³¢å¯ä»¥åˆ©ç”¨ï¼Œä¾‹å¦‚3å€ã€5å€ã€ä¸7å€çš„æ³›éŸ³æ™¶ä½“ã€‚è¦è¾¾åˆ°æ‰€è¦çš„æŒ¯è¡é¢‘ç‡ï¼ŒæŒ¯è¡ç”µè·¯ä¸Šä¼šåŠ å…¥é¢å¤–çš„ç”µå®¹å™¨ä¸ç”µæ„Ÿå™¨ï¼Œä»¥é€‰æ‹©å‡ºæ‰€éœ€çš„é¢‘ç‡ã€‚\n\n#### æ¸©åº¦æ•ˆåº”\nçŸ³è‹±æ™¶ä½“çš„é¢‘ç‡ç‰¹æ€§å–å†³äºå½¢çŠ¶æˆ–åˆ‡å‰²æ–¹å¼ã€‚éŸ³å‰å‹æ™¶ä½“é€šå¸¸ä¼šåˆ‡å‰²æˆæ¸©åº¦ç‰¹æ€§æ˜¯ä»¥25â„ƒä¸ºä¸­å¿ƒçš„æŠ›ç‰©çº¿ã€‚è¿™æ„å‘³ç€ï¼ŒéŸ³å‰æ™¶ä½“æŒ¯è¡å™¨åœ¨å®¤æ¸©ä¸‹äº§ç”Ÿçš„å…±æŒ¯é¢‘ç‡æ¥è¿‘å…¶ç›®æ ‡é¢‘ç‡ï¼Œå½“æ¸©åº¦æˆ–å¢åŠ æˆ–å‡å°‘æ—¶é¢‘ç‡éƒ½ä¼šé™ä½ã€‚é¢‘ç‡-æ¸©åº¦æ›²çº¿ä¸ºæŠ›ç‰©çº¿çš„å¸¸è§32.768åƒèµ«éŸ³å‰æ™¶ä½“çš„æ¸©åº¦ç³»æ•°æ˜¯è´Ÿç™¾ä¸‡åˆ†ä¹‹0.04/æ‘„æ°åº¦Â²ã€‚\n$$\nf=f_0[1-0.04ppm(T-T_0)^2]\n$$\nä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚ä¸è€ƒè™‘åˆ¶ä½œè¯¯å·®ï¼Œä»¥è¿™ç§çŸ³è‹±æ™¶ä½“æ§åˆ¶é¢‘ç‡çš„æ—¶é’Ÿï¼Œå¦‚è¿ä½œåœ¨æ¯”å®¤æ¸©ä½10Â°Cçš„ç¯å¢ƒä¸‹ï¼Œæ¯å¹´ä¼šæ¯”è¿ä½œåœ¨å®¤æ¸©ä¸‹æ…¢2åˆ†é’Ÿï¼›å¦‚è¿ä½œåœ¨æ¯”å®¤æ¸©ä½æ‘„æ°20Â°Cçš„ç¯å¢ƒä¸‹ï¼Œåˆ™æ¯å¹´ä¼šæ¯”è¿ä½œåœ¨å®¤æ¸©ä¸‹æ…¢8åˆ†é’Ÿã€‚\n\n### æ— æºæ™¶æŒ¯å…¸å‹ç”µè·¯åŠå…¶å‚æ•°\n#### çš®å°”æ–¯æ™¶ä½“æŒ¯è¡å™¨ï¼ˆPierce Crystal Oscillatorï¼‰\n\n![Pierce Crystal Oscillator](/images/crystal/4.png)\n\næ­¤ç”µè·¯ä¸­æ™¶ä½“å†³å®šäº†æŒ¯è¡é¢‘ç‡ï¼Œå¹¶ä»¥ä¸²è”è°æŒ¯é¢‘ç‡å·¥ä½œï¼Œ$f_s$åœ¨è¾“å‡ºå’Œè¾“å…¥ä¹‹é—´æä¾›ä½é˜»æŠ—è·¯å¾„ã€‚è°æŒ¯æ—¶å­˜åœ¨180åº¦ç›¸ç§»ï¼Œå› è€Œåé¦ˆä¸ºæ­£ã€‚è¾“å‡ºæ­£å¼¦æ³¢çš„å¹…åº¦é™åˆ¶åœ¨MOSFETæ¼æç«¯å­çš„æœ€å¤§ç”µå‹èŒƒå›´å†…ã€‚ç”µé˜»å™¨$R_1$æ§åˆ¶åé¦ˆé‡å’Œæ™¶ä½“é©±åŠ¨é‡ï¼Œè€Œå°„é¢‘æ‰¼æµåœˆRFCä¸Šçš„ç”µå‹åœ¨æ¯ä¸ªå‘¨æœŸå†…åè½¬ã€‚\n\nå¤§å¤šæ•°æ•°å­—æ—¶é’Ÿã€æ‰‹è¡¨å’Œè®¡æ—¶å™¨éƒ½ä»¥æŸç§å½¢å¼ä½¿ç”¨çš®å°”æ–¯æŒ¯è¡å™¨ï¼Œå› ä¸ºå®ƒå¯ä»¥ä½¿ç”¨æœ€å°‘çš„ç»„ä»¶æ¥å®ç°ã€‚\n\n#### MCUæŒ¯è¡å™¨\n\nMCUç”µè·¯ä¸­ï¼Œçš®å°”æ–¯æŒ¯è¡å™¨å¸¸ä»¥å¦ä¸€ç§è¾ƒä¸ºç®€å•çš„æ–¹å¼å‡ºç°ã€‚\n\n![Pierce Crystal Oscillator (MCU)](/images/crystal/5.png)\n\nå…¶ä¸­åŒ…æ‹¬\n- $C_{L1}$ã€$C_{L2}$ï¼šå¤–éƒ¨è´Ÿè½½ç”µå®¹\n- $R_{EXT}$ï¼šé˜»å°¼ç”µé˜»ï¼Œç”¨äºè°ƒèŠ‚æ¿€åŠ±ç”µæµ\n- $R_F$ï¼šåç›¸å™¨åé¦ˆç”µé˜»ï¼Œå¼ºåˆ¶åç›¸å™¨å·¥ä½œåœ¨çº¿æ€§æ”¾å¤§åŒºï¼Œç”¨äºæ”¹å–„èµ·æŒ¯ã€‚å¤šæ•°MCUä¼šå†…ç½®è¯¥ç”µé˜»ã€‚\n\nMCUæŒ¯è¡å™¨è¿˜æœ‰å¦ä¸€ç§æ›´ç®€æ´çš„å½¢å¼ï¼š\n\n![External Oscillator (MCU)](/images/crystal/6.png)\n\nè¯¥ç”µè·¯ä¸­çœå»äº†$R_{EXT}$ã€‚\n\n#### è´Ÿè½½ç”µå®¹($C_L$)\nè´Ÿè½½ç”µå®¹çš„æ ‡ç§°å€¼é€šå¸¸ç”±æ™¶æŒ¯åˆ¶é€ å•†æä¾›ï¼Œæ ‡ç¤ºä¸º$C_L$ã€‚å®é™…ç”µè·¯ä¸­çš„è´Ÿè½½ç”µå®¹æ˜¯å¹¶è”åœ¨æ™¶æŒ¯ä¸¤ç«¯çš„ä¸¤ä¸ªç”µå®¹$C_{L1}$ã€$C_{L2}$ï¼Œä»¥åŠæ™¶æŒ¯å†…éƒ¨ç”µå®¹ä»¥åŠå¸ƒçº¿ç”µå®¹ï¼ˆå¯„ç”Ÿç”µå®¹ï¼‰å…±åŒä½œç”¨çš„ç»“æœï¼Œå…¶è®¡ç®—å…¬å¼ä¸º\n$$\nC_L=\\frac{C_1 \\times C_2}{C_1 + C_2}+C_{s}\n$$\n\nå¼ä¸­$C_{s}$æ˜¯ç”µè·¯ä¸­å…¶ä»–æ‚æ•£ç”µå®¹ï¼ˆåŒ…æ‹¬æ™¶æŒ¯å¼•è„šç”µå®¹å’Œ PCB å¸ƒçº¿ç”µå®¹ï¼‰ï¼Œå¤§å°é€šå¸¸åœ¨3-5$pF$ã€‚\n\nå®é™…åº”ç”¨ä¸­ï¼Œé€‰æ‹©è´Ÿè½½ç”µå®¹çš„æ­¥éª¤ä¸ºï¼š\n- æŸ¥é˜…æ‰‹å†Œï¼Œç¡®å®šæ™¶æŒ¯çš„æ ‡ç§°è´Ÿè½½ç”µå®¹ $C_L$ã€‚\n- æ ¹æ®ç»éªŒæˆ–è€…å®é™…æµ‹é‡ä¼°ç®—ç”µè·¯æ¿çš„æ‚æ•£ç”µå®¹ï¼Œä¸€èˆ¬ç»éªŒå€¼ä¸º3-10$pF$ã€‚\n- æ ¹æ®å…¬å¼é€‰æ‹©åˆé€‚çš„$C_{L1}$ã€$C_{L2}$ï¼Œä½¿å…¶æ»¡è¶³æ ‡ç§°è´Ÿè½½ç”µå®¹çš„è¦æ±‚ã€‚\n\n#### æŒ¯è¡é¢‘ç‡(Oscillation frequency)\næŒ¯åŠ¨é¢‘ç‡æ˜¯æŒ‡ä¸æ™¶ä½“è°æŒ¯å™¨ä¸€èµ·å·¥ä½œçš„æŒ¯è¡ç”µè·¯çš„å®é™…é¢‘ç‡ã€‚æŒ¯åŠ¨é¢‘ç‡ç”±æ™¶ä½“è°æŒ¯å™¨å†³å®šï¼Œå¹¶å—MCUã€å¤–éƒ¨è´Ÿè½½ç”µå®¹ã€PCBæ‚æ•£ç”µå®¹ç­‰çš„å½±å“ã€‚\n$$\nf_{osc}=f_{L}=f_{r}[\\frac{C_1}{2(C_0+C_s)}+1]\n$$\nå¼ä¸­$f_{L}$ä¸ºè´Ÿè½½å…±æŒ¯é¢‘ç‡ï¼Œ$f_{r}$ä¸ºå…±æŒ¯é¢‘ç‡ã€‚\n*æ³¨æ„*ï¼šä¸èƒ½ç”¨ç¤ºæ³¢å™¨æ¢å¤´ã€ä¸‡ç”¨è¡¨ç¬”ç­‰æµ‹è¯•å·¥å…·ç›´æ¥æ¢æµ‹æ™¶æŒ¯è¾“å…¥ã€è¾“å‡ºç«¯ï¼Œå› ä¸ºç¤ºæ³¢å™¨æ¢å¤´ã€ä¸‡ç”¨è¡¨ç¬”å‡å…·æœ‰å¯„ç”Ÿç”µå®¹ç‰¹æ€§ï¼Œæµ‹è¯•æ—¶å°†æ”¹å˜æ•´ä¸ªè´Ÿè½½ç”µå®¹çš„ç­‰æ•ˆå€¼ï¼Œæµ‹è¯•å‡ºçš„æ•°æ®ä¸å‡†ï¼ŒåŒæ—¶ä¹Ÿä¼šæ”¹å˜æ™¶ä½“çš„ESRï¼Œç”šè‡³ä¼šå‡ºç°æ™¶æŒ¯åœæŒ¯ç°è±¡ã€‚\n\nå‚è§ï¼š[å¦‚ä½•æµ‹é‡æŒ¯è¡é¢‘ç‡](https://www.murata.com.cn/zh-cn/products/timingdevice/crystalu/overview/basic/frequency)\n\n#### æ¿€åŠ±åŠŸç‡ (Drive Level)å’Œ$R_{EXT}$\næ¿€åŠ±åŠŸç‡æ˜¯æŒ‡æ–½åŠ åœ¨æ™¶æŒ¯ä¸Šçš„åŠŸç‡ï¼Œé€šå¸¸ä»¥å¾®ç“¦ ($\\mu W$) ä¸ºå•ä½ã€‚å®ƒè¡¨ç¤ºæ™¶æŒ¯åœ¨å·¥ä½œæ—¶æ‰€æ¶ˆè€—çš„èƒ½é‡ã€‚æ¿€åŠ±åŠŸç‡å¯¹äºæ™¶æŒ¯çš„å¯é æ€§å’Œå¯¿å‘½è‡³å…³é‡è¦ï¼Œè¿‡é«˜çš„æ¿€åŠ±åŠŸç‡å¯èƒ½ä¼šå¯¼è‡´æ™¶æŒ¯è¿‡çƒ­æˆ–æŸåï¼Œè¿‡ä½çš„æ¿€åŠ±åŠŸç‡åˆ™å¯èƒ½å¯¼è‡´æ™¶æŒ¯æ— æ³•æ­£å¸¸å¯åŠ¨æˆ–å·¥ä½œä¸ç¨³å®šã€‚ä¸€èˆ¬éƒ½æŒ‰æ‰‹å†Œè®¾è®¡ã€‚\n\næ¿€åŠ±åŠŸç‡çš„è§‚æµ‹å’Œè°ƒèŠ‚å¯åŸºäºä¸¤ç§æ–¹æ³•è¿›è¡Œï¼š\n\n##### ç”µæµæ³•\næ ¹æ®\n$$\nDL=I_{RMS}^2 \\times ESR\n$$\nå‚è§ï¼š[How to Measure the Drive Level](https://www.murata.com.cn/zh-cn/products/timingdevice/crystalu/overview/basic/drivelevel)\n##### ç”µå‹æ³•\næ­¤å¤„ç•¥ã€‚\n\n$R_{EXT}$ç”¨äºè°ƒèŠ‚æ¿€åŠ±åŠŸç‡ã€‚\n\n#### é™æ€ç”µå®¹ï¼ˆStatic Capacitanceï¼‰\né™æ€ç”µå®¹å³ä¸ºå¹¶è”ç”µå®¹ï¼ˆParallel Capacitance,$C_0$ï¼‰ï¼Œæ˜¯æŒ‡æ™¶æŒ¯åœ¨ä¸æŒ¯è¡æ—¶å…¶ä¸¤ç«¯çš„ç”µå®¹ã€‚è¿™ä¸€å‚æ•°æ˜¯æ™¶æŒ¯çš„å›ºæœ‰ç‰¹æ€§ä¹‹ä¸€ï¼Œé€šå¸¸ç”±åˆ¶é€ å•†åœ¨æ™¶æŒ¯çš„è§„æ ¼ä¹¦ä¸­ç»™å‡ºã€‚å…¶åœ¨ä¸æ–½åŠ ä»»ä½•ç”µå‹æˆ–ä¸è¿›è¡ŒæŒ¯è¡æ—¶æµ‹å¾—ã€‚å®ƒåæ˜ äº†æ™¶ä½“ææ–™å’Œç”µæç»“æ„çš„å›ºæœ‰ç‰¹æ€§ã€‚\n\n#### æ¸©æ¼‚\næ¸©æ¼‚æ˜¯æŒ‡æ™¶æŒ¯çš„æŒ¯è¡é¢‘ç‡éšæ¸©åº¦å˜åŒ–è€Œå‘ç”Ÿçš„åç§»ã€‚æ¸©æ¼‚é€šå¸¸ç”¨ ppm/Â°Cï¼ˆç™¾ä¸‡åˆ†ä¹‹å‡ æ¯æ‘„æ°åº¦ï¼‰æ¥è¡¨ç¤ºï¼Œå®ƒæ˜¯æ™¶æŒ¯é¢‘ç‡ç¨³å®šæ€§çš„é‡è¦æŒ‡æ ‡ä¹‹ä¸€ã€‚\n\næ¸©æ¼‚å—ä»¥ä¸‹å› ç´ å½±å“ï¼š\n- ææ–™ç‰¹æ€§ã€‚æ™¶ä½“ææ–™çš„æ¸©åº¦ç³»æ•°æ˜¯å½±å“æ¸©æ¼‚çš„ä¸»è¦å› ç´ ã€‚çŸ³è‹±æ™¶ä½“çš„æ¸©åº¦ç³»æ•°ç›¸å¯¹è¾ƒä½ï¼Œä½†ä»ä¼šéšæ¸©åº¦å˜åŒ–è€Œå¯¼è‡´é¢‘ç‡æ¼‚ç§»ã€‚\n- æ™¶ä½“åˆ‡å‰²æ–¹å¼ã€‚ä¸åŒçš„æ™¶ä½“åˆ‡å‰²æ–¹å¼ï¼ˆå¦‚ AT åˆ‡å‰²ã€BT åˆ‡å‰²ç­‰ï¼‰å¯¹æ¸©æ¼‚æœ‰ä¸åŒçš„å½±å“ã€‚AT åˆ‡å‰²çš„çŸ³è‹±æ™¶ä½“åœ¨å¸¸ç”¨æ¸©åº¦èŒƒå›´å†…å…·æœ‰è¾ƒå¥½çš„é¢‘ç‡ç¨³å®šæ€§ã€‚\n- ç”µè·¯è®¾è®¡ã€‚æ™¶æŒ¯ç”µè·¯ä¸­çš„å…ƒä»¶ï¼ˆå¦‚è´Ÿè½½ç”µå®¹ã€æ”¾å¤§å™¨ç­‰ï¼‰å¯¹æ¸©åº¦çš„æ•æ„Ÿåº¦ä¹Ÿä¼šå½±å“æ•´ä½“çš„é¢‘ç‡æ¸©æ¼‚ã€‚\n\nåº”å¯¹æ–¹æ³•ï¼š\n- é€‰ç”¨æ¸©è¡¥æ™¶æŒ¯ï¼ˆTCXOï¼‰ï¼Œé€šè¿‡å†…éƒ¨çš„æ¸©åº¦è¡¥å¿ç”µè·¯ï¼Œä¿®æ­£å› æ¸©åº¦å˜åŒ–å¼•èµ·çš„é¢‘ç‡æ¼‚ç§»ï¼Œä»è€Œæé«˜æ™¶æŒ¯çš„é¢‘ç‡ç¨³å®šæ€§ã€‚\n- é€‰ç”¨æ’æ¸©æ§åˆ¶æ™¶æŒ¯ï¼ˆOCXOï¼‰ï¼Œé€šè¿‡å†…ç½®çš„æ’æ¸©æ§åˆ¶ç³»ç»Ÿï¼Œå°†æ™¶æŒ¯ä¿æŒåœ¨æ’å®šæ¸©åº¦ä¸‹å·¥ä½œï¼Œæå¤§åœ°å‡å°‘æ¸©æ¼‚å½±å“ã€‚\n- åœ¨æ¸©åº¦ç›¸å¯¹ç¨³å®šçš„ç¯å¢ƒä¸­ä½¿ç”¨æ™¶æŒ¯ï¼Œå°½é‡é¿å…æç«¯æ¸©åº¦å˜åŒ–ã€‚\n\n#### å“è´¨å› æ•°ï¼ˆQuality Factorï¼ŒQå€¼ï¼‰\nå“è´¨å› æ•°$Q$æ˜¯æ— é‡çº²çš„å‚æ•°ï¼Œç”¨æ¥è¡¨ç¤ºæŒ¯è¡ç³»ç»Ÿçš„æŸè€—æƒ…å†µã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒæ˜¯å‚¨å­˜åœ¨æ™¶æŒ¯ä¸­çš„èƒ½é‡ä¸æ¯å‘¨æœŸæŸè€—èƒ½é‡çš„æ¯”å€¼ã€‚å¯¹äºæ™¶æŒ¯ï¼Œ$Q$å€¼è¶Šé«˜ï¼Œè¡¨ç¤ºå…¶èƒ½é‡æŸè€—è¶Šå°ï¼ŒæŒ¯è¡çš„ç¨³å®šæ€§å’Œçº¯åº¦è¶Šé«˜ã€‚\n$$\nQ=\\frac{f_0}{\\Delta f}\n$$\nå¼ä¸­$f_0$ä¸ºæ™¶æŒ¯è°æŒ¯é¢‘ç‡ï¼Œ$\\Delta f$ä¸ºé¢‘ç‡å“åº”çš„å¸¦å®½ï¼ˆå³æ™¶æŒ¯åœ¨å…¶è°æŒ¯é¢‘ç‡å¤„çš„å“åº”ä¸‹é™åˆ°å…¶æœ€å¤§å€¼çš„$1/\\sqrt 2$å¤„çš„é¢‘ç‡é—´éš”ï¼‰ã€‚\n\né«˜$Q$å€¼æ™¶æŒ¯èµ·æŒ¯åçš„é¢‘ç‡ç¨³å®šæ€§å’Œå™ªå£°å‡è¾ƒä½ï¼Œä½†å…¶éœ€è¦è¾ƒé•¿çš„èµ·æŒ¯æ—¶é—´ä»¥è¾¾åˆ°ç¨³å®šã€‚\n\n### å…¸å‹åº”ç”¨\nSTM32F429IRTxéœ€è¦åœ¨OSC_INå’ŒOSC_OUTå¼•è„šå¤–æ¥25MHzæ™¶æŒ¯ä»¥ä¾›ç³»ç»Ÿé«˜é€Ÿæ—¶é’ŸæºHSEï¼ŒåŒæ—¶é€šè¿‡å†…éƒ¨é”ç›¸ç¯ï¼ˆPLLï¼‰è¿›è¡Œå€é¢‘ã€‚\n\n![å¤–æ¥çš„25MHzé«˜é¢‘æ—¶é’Ÿæº](/images/crystal/7.png)\n\n![ä½¿ç”¨çš„YXC X322525MOB4SIå‹æ— æºè´´ç‰‡æ™¶æŒ¯](/images/crystal/8.png)\n\næ‰‹å†Œæ¨èè´Ÿè½½ç”µå®¹ä¸º10$pF$æˆ–20$pF$ï¼Œé€‰å–10$pF$ã€‚\n\næ ¹æ®å·¥ç¨‹è®¾è®¡ç»éªŒï¼Œä¸€èˆ¬å–æ‰‹å†Œå€¼-2æˆ–-3$pF$åï¼Œå†ä¹˜ä»¥2ï¼Œä½œä¸ºç›®æ ‡è´Ÿè½½ç”µå®¹å€¼ã€‚æ­¤å¤„å³ä¸º\n$$\nC_L'=(C_L-2)\\times2=(10-2)\\times2=16pF\n$$\næ ¹æ®\n$$\nC_L'=\\frac{C_1 \\times C_2}{C_1 + C_2}+C_{s}\n$$\n$C_s$ç»éªŒå€¼ä¸º5$pF$ï¼Œæ‰€ä»¥å¯è§£å¾—$C_1=C_2=22pF$ã€‚","categories":["ç”µå­ä¸ç”µè·¯è®¾è®¡"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºçš„è¿ç®—ç”µæŠ—ã€ç­‰æ•ˆç”µè·¯ã€ç”µç£è½¬çŸ©","url":"/2024/07/27/ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºçš„è¿ç®—ç”µæŠ—ã€ç­‰æ•ˆç”µè·¯ã€ç”µç£è½¬çŸ©/","content":"## åŒæ­¥ç”µæœºç­‰æ•ˆè¿ç®—ç”µè·¯\nåœ¨è¿›è¡Œç¬æ€åˆ†ææ—¶ï¼Œäº¦å¯æ ¹æ®å¯¼å‡ºçš„æ–¹ç¨‹å¼ç”»å‡ºç›¸åº”çš„ç­‰æ•ˆç”µè·¯ï¼Œè¿™æ ·æ¯”è¾ƒç›´è§‚ä¹Ÿä¾¿äºè®°å¿†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€å…³å¿ƒçš„æ˜¯ç”µæ¢ç»•ç»„å„é‡çš„å˜åŒ–ï¼Œå³ä»ç”µæ¢ç»•ç»„çš„ç«¯ç‚¹çœ‹ï¼Œèƒ½åæ˜ ç¬æ€æ–¹ç¨‹å¼çš„ç­‰æ•ˆç”µè·¯å’Œç­‰æ•ˆé˜»æŠ—ã€‚é€šè¿‡ä»aã€bã€cåæ ‡ç³»ç»Ÿåˆ°dã€qã€0åæ ‡ç³»ç»Ÿçš„å˜æ¢ï¼Œå°†ç”µæ„Ÿç³»æ•°ä»å˜ç³»æ•°å˜ä¸ºäº†å¸¸ç³»æ•°ï¼Œå¹¶é€šè¿‡å„åŸºå€¼çš„é€‰å–ï¼Œä½¿äº’æ„Ÿç³»æ•°çš„æ ‡ä¹ˆå€¼å¯é€†ï¼Œä¸”$L_{ad}=M_{af}=M_{aD}=x_{ad}$ï¼Œè¿™æ ·å°±åœ¨ç”µè·¯ä¸Šæ— è”ç³»çš„å‡ ä¸ªç»•ç»„å…·å¤‡äº†ç­‰æ•ˆä¸ºä¸€ä¸ªç”µè·¯çš„åŸºæœ¬æ¡ä»¶ã€‚å½“è½¬å­è½¬é€Ÿ$\\omega$=æ’å€¼æ—¶ï¼Œç”µå‹æ–¹ç¨‹å¼ä¸ºå¸¸ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹ç»„ï¼Œå¯é‡‡ç”¨æ‹‰æ°å˜æ¢å°†æ—¶åŸŸçš„å¾®åˆ†æ–¹ç¨‹è½¬æ¢ä¸ºå¤é¢‘åŸŸçš„ä»£æ•°æ–¹ç¨‹æ±‚è§£ã€‚\n\nä¸‹é¢å°±è½¬å­ä¸Šåªæœ‰åŠ±ç£ç»•ç»„å’ŒåŒæ—¶å­˜åœ¨åŠ±ç£å’Œé˜»å°¼ç»•ç»„ä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«å¯¹ç”µæ¢ç›´è½´é“¾å’Œäº¤è½´ç£é“¾çš„ç­‰æ•ˆè¿ç®—ç”µè·¯è¿›è¡Œè®¨è®ºã€‚\n\n### è½¬å­ä¸Šåªæœ‰åŠ±ç£ç»•ç»„æ—¶çš„ç­‰æ•ˆè¿ç®—ç”µè·¯\nè¯¥æƒ…å†µä¸‹ï¼Œæ ¹æ®ä¸Šç¯‡æ–‡ç« çš„å†…å®¹ï¼Œç”±æ ‡å¹ºå€¼ä¸‹äº¤æµç”µæœºæ–¹ç¨‹å¼æ¨å¯¼å¯å¾—ï¼ˆç£é“¾å…³ç³»ä»£å…¥ç”µå‹æ–¹ç¨‹å¼ï¼‰ï¼Œç›´è½´ç”µæ¢ç£é“¾æ–¹ç¨‹å’ŒåŠ±ç£ç»•ç»„ç”µå‹æ–¹ç¨‹ä¸º\n$$\n\\psi_d=x_di_d+x_{ad}i_f\n$$\n$$\nu_f=px_{ad}i_d+(r_f+px_f)i_f\n$$\nå¼ä¸­$p$ä¸ºæ—¶é—´å¾®åˆ†ç®—å­ã€‚å¯è§å„å˜é‡ä¸ºæ—¶é—´çš„å‡½æ•°ï¼Œç›¸åº”çš„æ–¹ç¨‹ä¸ºå¾®åˆ†æ–¹ç¨‹ã€‚å½“ç”µæµ$i_dã€i_f$çš„åˆå€¼ä¸ºé›¶æ—¶ï¼Œæ‹‰æ°å˜æ¢åæ–¹ç¨‹çš„å½¢å¼ä¸å˜ï¼Œä½†$p$ä¸ºä¸€ä»£æ•°å¤å˜é‡ï¼Œå„å˜é‡æ˜¯ä»¥$p$ä¸ºå˜é‡çš„å˜æ¢å‡½æ•°ï¼Œå¦‚å˜é‡$\\psiã€iã€u$ç»æ‹‰æ°å˜æ¢ååˆ†åˆ«ç”¨$\\psi(p)ã€I(p)ã€U(p)$è¡¨ç¤ºï¼Œä»¥ç¤ºåŒºåˆ«ã€‚å¦‚æ­¤æ”¹å†™åçš„ç£é“¾å’Œç”µå‹æ–¹ç¨‹å¼çš„å˜æ¢å‡½æ•°ä¸º\n$$\nu_d(p)=x_dI_d(p)+x_{ad}I_f(p)\n$$\n$$\nU_f(p)=px_{ad}I_d(p)+(r_f+px_f)I_f(p)\n$$\n*æ³¨æ„*ï¼šæ­¤å¤„çš„$p$åœ¨ä»£æ•°å­¦æ„ä¹‰ä¸Šå¯è§†ä¸ºæ‹‰æ™®æ‹‰æ–¯å˜æ¢ç®—å­$s$ã€‚$U(p)$å³ç­‰åŒäº$U(s)$ï¼Œä»$U(t)$ç»$Laplace$å˜æ¢è€Œæ¥ã€‚\n\nç”¨$p$é™¤ç­‰å¼$U_f(p)$ä¸¤ç«¯ï¼Œå¹¶è€ƒè™‘åˆ°$x_d=x_l+x_{ad}$ï¼Œ$x_f=x_{fl}+x_{ad}$ï¼Œæ•´ç†åå¯å¾—\n$$\n\\psi_d(p)=x_lI_d(p)+x_{ad}[I_d(p)+I_f(p)]\n$$\n$$\n\\frac{U_f(p)}{p}=x_{ad}[I_d(p)+I_f(p)]+(x_{fl}+\\frac{r_f}{p})I_f(p)\n$$\næ ¹æ®ä¸Šå¼å³å¯ç”»å‡ºç›¸åº”çš„ç›´è½´ç­‰æ•ˆè¿ç®—ç”µè·¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![](/images/1.2/dzhoudengxiao.png)\n\nåœ¨å¤šæ•°æƒ…å†µä¸‹åªéœ€ç ”ç©¶å®šå­ä¸Šçš„å„å˜é‡ï¼Œå› è€Œå¯ä»¥å°†ç­‰å¼ä¸­çš„è½¬å­ç”µæµé¡¹$I_f(p)$æ¶ˆå»ï¼Œä»¥è·å¾—æ›´åŠ ç®€æ˜çš„å…³ç³»å¼ã€‚åº”ç”¨æˆ´ç»´å—å®šç†ï¼Œæ ¹æ®å›¾(a)ï¼Œå¾—åˆ°å¼€è·¯ç”µå‹$G(p)U_f(p)$åŠçŸ­è·¯é˜»æŠ—$x_d(p)$ï¼Œå³\n$$\n\\psi_d(p)=G(p)U_f(p)+x_d(p)I_d(p)\n$$\nå¼ä¸­\n$$\nG_(p)=\\frac{x_{ad}}{r_f+x_fp}\n$$\n$$\nx_d(p)=x_l+\\frac{1}{\\frac{1}{x_{ad}+\\frac{1}{x_{fl}+\\frac{r_f}{p}}}}\n$$\nå¼ä¸­$G_(p)$ç§°ä¸ºåŠ±ç£ç”µå‹å¯¹ç›´è½´ç£é“¾çš„ä¼ é€’å‡½æ•°ï¼Œ$x_d(p)$ç§°ä¸ºç›´è½´è¿ç®—ç”µæŠ—ã€‚äºŒè€…éƒ½æ˜¯å…·æœ‰æ’ç³»æ•°çš„è¿ç®—å¼ï¼Œå’Œç”µæœºç¬æ—¶è½¬é€Ÿæ— å…³ï¼Œå› è€Œå¯ä»¥ç”¨æ¥ç ”ç©¶ä»»æ„è½¬é€Ÿä¸‹ç”µæœºçš„å„ç§è¿è¡Œå·¥å†µã€‚\n\n### è½¬å­ä¸Šæœ‰åŠ±ç£ç»•ç»„ã€Dè½´é˜»å°¼ç»•ç»„å’ŒQè½´é˜»å°¼ç»•ç»„\n#### ç›´è½´ç­‰æ•ˆè¿ç®—ç”µè·¯\nå½“è½¬å­ç›´è½´ä¸Šé™¤åŠ±ç£ç»•ç»„å¤–è¿˜è£…æœ‰çŸ­è·¯çš„é˜»å°¼ç»•ç»„ï¼Œä¸”å½“å„ç»•ç»„ç”µæµåˆå€¼ä¸ºé›¶æ—¶ï¼Œå¯å¾—åˆ°ç›´è½´ç”µæ¢ç»•ç»„ç£é“¾æ–¹ç¨‹å’ŒåŠ±ç£ç»•ç»„ã€ç›´è½´é˜»å°¼ç»•ç»„ç”µå‹æ–¹ç¨‹å¼çš„å˜æ¢å‡½æ•°æ–¹ç¨‹ä¸º\n$$\n\\psi_d(p)=x_dI_d(p)+x_{ad}I_f(p)+x_{ad}I_D(p)\n$$\n$$\nU_f(p)=px_{ad}I_d(p)+(r_f+px_f)I_f(p)+px_{ad}I_D(p)\n$$\n$$\n0=px_{ad}I_d(p)+px_{ad}I_f(p)+(r_D+px_D)I_D(p)\n$$\nç”¨$p$é™¤ä»¥ç­‰å¼ä¸¤ä¾§ï¼Œè€ƒè™‘$x_d=x_l+x_{ad}$ï¼Œ$x_f=x_{fl}+x_{ad}$ï¼Œ$x_D=x_{Dl}+x_{ad}$ï¼Œæ•´ç†åæœ‰\n$$\n\\psi_d(p)=x_lI_d(p)+x_{ad}[I_d(p)+I_f(p)+I_D(p)]\n$$\n$$\n\\frac{U_f(p)}{p}=x_{ad}[I_d(p)+I_f(p)+I_D(p)]+(x_{fl}+\\frac{r_f}{p})I_f(p)\n$$\n$$\n0=x_{ad}[I_d(p)+I_f(p)+I_D(p)]+(x_{Dl}+\\frac{r_D}{p})I_D(p)\n$$\næ ¹æ®ä¸Šå¼ï¼Œå¯¼å‡ºå¾—æœ‰é˜»å°¼ç»•ç»„æ—¶å¾—ç›´è½´ç­‰æ•ˆè¿ç®—ç”µè·¯\n\n![](/images/1.2/zunidzhoudengxiao.png)\n\næ ¹æ®æˆ´ç»´å—å®šç†ï¼Œå¯å¾—å¼€è·¯ç”µå‹$G(p)U_f(p)$åŠçŸ­è·¯é˜»æŠ—$x_d(p)$ï¼Œåˆ™$\\psi_d(p)$ä¸º\n$$\n\\psi_d(p)=G(p)U_f(p)+x_d(p)I_d(p)\n$$\nå…¶ä¸­\n$$\nG(p)=\\frac{(x_Dx_{ad}-x_{ad}^2)p+x_{ad}r_D}{(x_fx_D-x_{ad}^2)p^2+(x_fr_D+x_Dr_f)p+r_fr_D}\n$$\n$$\nx_d(p)=x_l+\\frac{1}{\\frac{1}{x_{ad}}+\\frac{1}{x_{fl}+\\frac{r_f}{p}}+\\frac{1}{x_{Dl}+\\frac{r_D}{p}}}\n$$\n\n#### äº¤è½´ç­‰æ•ˆè¿ç®—ç”µè·¯\nè½¬å­äº¤è½´ä¸Šæœ‰çŸ­è·¯çš„é˜»å°¼ç»•ç»„ï¼Œä¸”å„ç»•ç»„ç”µæµåˆå€¼ä¸ºé›¶æ—¶ï¼Œå¯å¾—åˆ°äº¤è½´ç”µæ¢ç»•ç»„ç£é“¾æ–¹ç¨‹å’Œäº¤è½´é˜»å°¼ç»•ç»„ç”µå‹æ–¹ç¨‹å¼çš„å˜æ¢å‡½æ•°ä¸º\n$$\n\\psi_q(p)=x_qI_q(p)+x_{aq}I_Q(p)\n$$\n$$\n0=x_{aq}I_q(p)+(x_Q+\\frac{r_Q}{p})I_Q(p)\n$$\nç±»ä¼¼äºç›´è½´æƒ…å†µï¼Œè€ƒè™‘$x_q=x_l+x_{aq}$ï¼Œ$x_Q=x_{Ql}+x_{aq}$ï¼Œæ¶ˆå»äº¤è½´é˜»å°¼ç»•ç»„ç”µæµåï¼Œæœ‰\n$$\n\\psi_q(p)=x_q(p)I_q(p)\n$$\nå…¶ä¸­\n$$\nx_q(p)=x_l+\\frac{1}{\\frac{1}{x_{aq}}+\\frac{1}{x_{Ql}+\\frac{r_Q}{p}}}\n$$\nå¼ä¸­$x_q(p)$ä¸ºäº¤è½´è¿ç®—ç”µæŠ—ã€‚äº¤è½´ç­‰æ•ˆè¿ç®—ç”µè·¯å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![](/images/1.2/zuniqzhoudengxiao.png)\n\n## è¿ç®—ç”µæŠ—ç‰¹æ€§\n### åŒæ­¥ç”µæŠ—ã€ç¬å˜ï¼ˆæš‚æ€ï¼‰ç”µæŠ—å’Œè¶…ç¬å˜ï¼ˆæ¬¡æš‚æ€ï¼‰ç”µæŠ—\n\næ ¹æ®ä¸ŠèŠ‚å†…å®¹ï¼Œç›´è½´ã€äº¤è½´è¿ç®—ç”µæŠ—çš„ç­‰æ•ˆç”µè·¯å¯å¯¼å‡ºä¸ºä¸‹å›¾ï¼ˆæœªæ¶ˆå»è½¬å­ç”µæµï¼‰ã€‚\n![](/images/1.2/tu25.png)\n\næ ¹æ®æ‹‰æ°å˜æ¢ç»ˆå€¼å®šç†ï¼Œ$p$è¶‹äºé›¶æ—¶ï¼Œ$t$è¶‹äºæ— ç©·å¤§ï¼Œå³åŒæ­¥ç”µæœºç¨³æ€è¿è¡Œæ‰€å‘ˆç°çš„åŒæ­¥ç”µæŠ—ã€‚å›¾ä¸­$p$è¶‹äºé›¶æ—¶ï¼Œå…¶å€¼ç›¸å½“äºè½¬å­å„ç»•ç»„å‡æ–­å¼€æ—¶çš„ç”µæŠ—å€¼ï¼Œå³\n$$\n\\lim_{p \\to 0}x_d(p)=x_l+x_{ad}=x_d\n$$\n$$\n\\lim_{p \\to 0}x_q(p)=x_l+x_{aq}=x_q\n$$\næ ¹æ®æ‹‰æ°å˜æ¢åˆå€¼å®šç†ï¼Œè‹¥è½¬å­ä¸Šæ— é˜»å°¼ç»•ç»„ï¼Œæ ¹æ®ç­‰æ•ˆç”µè·¯ï¼Œå¯å¾—\n$$\n\\lim_{p \\to \\infin}x_d(p)=x_l+\\frac{1}{\\frac{1}{x_{ad}}+\\frac{1}{x_{fl}}}=x'_{d}\n$$\n$x'_{d}$å³ä¸ºåŒæ­¥ç”µæœºçš„**ç›´è½´æš‚æ€ç”µæŠ—**ï¼Œç­‰æ•ˆç”µè·¯å¦‚å›¾2-6(a)æ‰€ç¤ºã€‚\n\nè‹¥è½¬å­ä¸Šæœ‰é˜»å°¼ç»•ç»„ï¼Œæ ¹æ®ç­‰æ•ˆç”µè·¯ï¼Œæœ‰\n$$\n\\lim_{p \\to \\infin}x_d(p)=x_l+\\frac{1}{\\frac{1}{x_{ad}}+\\frac{1}{x_{fl}}+\\frac{1}{x_{Dl}}}=x''_{d}\n$$\n\n$x''_{d}$å³ä¸ºåŒæ­¥ç”µæœºçš„**ç›´è½´æ¬¡æš‚æ€ç”µæŠ—**ï¼Œç­‰æ•ˆç”µè·¯å¦‚å›¾2-6(b)æ‰€ç¤ºã€‚\n\nåŒç†ï¼Œåœ¨äº¤è½´æ–¹å‘ï¼Œæ ¹æ®ç­‰æ•ˆç”µè·¯ï¼Œæœ‰\n$$\n\\lim_{p \\to \\infin}x_q(p)=x_l+\\frac{1}{\\frac{1}{x_{aq}}+\\frac{1}{x_{Ql}}}=x''_{q}\n$$\n$x''_{q}$å³ä¸ºåŒæ­¥ç”µæœºçš„**äº¤è½´æ¬¡æš‚æ€ç”µæŠ—**ï¼Œç­‰æ•ˆç”µè·¯å¦‚å›¾2-6(c)æ‰€ç¤ºã€‚\n\n![](/images/1.2/tu26.png)\n\nå¯è§ï¼Œæš‚æ€ç”µæŠ—å’Œæ¬¡æš‚æ€ç”µæŠ—åˆ†åˆ«æ˜¯æ— é˜»å°¼ç»•ç»„å’Œæœ‰é˜»å°¼ç»•ç»„åŒæ­¥ç”µæœºåœ¨ç¬æ€çš„åˆç¬é—´ï¼Œä»ç”µæ¢ç»•ç»„ç«¯çœ‹è¿›å»çš„ç”µæŠ—ã€‚è¯¥æ•°å€¼åœ¨ç ”ç©¶åŒæ­¥ç”µæœºè¿è¡Œæ—¶éå¸¸æœ‰ç”¨ã€‚\n\n### ä»¥æ—¶é—´å¸¸æ•°å½¢å¼æ¥è¡¨ç¤ºçš„è¿ç®—ç”µæŠ—\nå®é™…åº”ç”¨ä¸­ï¼Œè¿ç®—ç”µæŠ—$x_d(p)$å’Œ$x_q(p)$å¸¸ç”¨åŠ±ç£ç»•ç»„å’Œé˜»å°¼ç»•ç»„çš„æ—¶é—´å¸¸æ•°æ¥è¡¨ç¤ºã€‚\n\nå½“è½¬å­ä»…æœ‰åŠ±ç£ç»•ç»„è€Œæ— é˜»å°¼ç»•ç»„æ—¶ï¼Œæœ‰\n$$\nx_d(p)=x_d-\\frac{x_{ad}^2p}{r_f+x_fp}=x_d[\\frac{r_f+(x_f-x_{ad}^2/x_d)}{r_f+x_fp}]=x_d(\\frac{r_f+x_f'p}{r_f+x_fp})=x_d(\\frac{1+T_f'p}{1+T_fp})\n$$\nå¼ä¸­ï¼Œ$x_f'$ä¸ºç”µæ¢ç»•ç»„çŸ­è·¯æ—¶ä»åŠ±ç£ç»•ç»„ç«¯å£çœ‹è¿›å»çš„ç¬æ€ç”µæŠ—ï¼Œ$T_f'=x_f'/r_f$ä¸ºåŠ±ç£ç»•ç»„ç¬æ€æ—¶é—´å¸¸æ•°ã€‚$T_f=x_f/r_f$ä¸ºåŠ±ç£ç»•ç»„æ—¶é—´å¸¸æ•°ã€‚\n\nç”µæ¢ç»•ç»„çŸ­è·¯æ—¶ï¼Œä»åŠ±ç£ç»•ç»„ç«¯å£çœ‹è¿›å»çš„ç¬æ€ç”µæŠ—$x_f'$çš„ç­‰æ•ˆç”µè·¯å¦‚å›¾2-7æ‰€ç¤ºã€‚\n\n![](/images/1.2/tu27.png)\n\nå½“è½¬å­ä»…æœ‰åŠ±ç£ç»•ç»„æ—¶ï¼Œ**å…¶æ—¶é—´å¸¸æ•°$T_f'$å°±æ˜¯ç”µæ¢ç›´è½´ç¬å˜ç”µæµè¡°å‡çš„æ—¶é—´å¸¸æ•°$T_d'$**ï¼Œå³$T_f'=T_d'$ï¼Œä¸”$T_f=T_{d0}$ã€‚*æ³¨æ„*ï¼šæ­¤å¤„æ—¶é—´å¸¸æ•°å•ä½å‡ç”¨æ—¶é—´çš„æ ‡å¹ºå€¼è¡¨ç¤ºã€‚\n\næ±‚è§£ç¬å˜ç”µæµæ—¶å¸¸ä½¿ç”¨è¿ç®—ç”µæŠ—çš„å€’æ•°å½¢å¼ï¼Œæœ‰\n$$\n\\frac{1}{x_d(p)}=\\frac{1}{x_d} \\times \\frac{1+T_{d0}}{1+T_d'p}\n$$\nå°†è¯¥å¼å±•å¼€ä¸ºéƒ¨åˆ†åˆ†å¼ï¼Œå¹¶è€ƒè™‘åˆ°$x_d'=\\frac{T_d'}{T_{d0}}x_d$ï¼Œæœ‰\n$$\n\\frac{1}{x_d(p)}=\\frac{1}{x_d}+(\\frac{1}{x_d'}-\\frac{1}{x_d})\\frac{T_d'p}{1+T_d'p}\n$$\nè¯¥å½¢å¼åœ¨ç”±å¤æ•°åŸŸå‡½æ•°å˜æ¢è¿”å›æ—¶åŸŸçš„åŸå‡½æ•°æ—¶éå¸¸æ–¹ä¾¿ã€‚\n\nåŒç†å¯æ¨å¯¼ï¼Œè½¬å­ä¸Šé™¤åŠ±ç£ç»•ç»„å¤–ï¼Œç›´è½´ä¸Šè¿˜è£…æœ‰é˜»å°¼ç»•ç»„æ—¶çš„ç›´è½´è¿ç®—ç”µæŠ—$x_d(p)$çš„æ—¶é—´å¸¸æ•°è¡¨è¾¾å¼ä¸º\n\n$$\nx_d(p)=x_d[\\frac{\\sigma_{fD}' T_f' T_D' p^2+(T_f'T_D')p+1}{\\sigma_{fD}T_f T_Dp^2+(T_f+T_D)p+1}]\n$$\n\nå¼ä¸­ï¼Œ\n- $T_D$ä¸ºç›´è½´é˜»å°¼ç»•ç»„æœ¬èº«çš„æ—¶é—´å¸¸æ•°ã€‚$T_D=x_D/r_D$\n- $T_D'$ä¸ºåŠ±ç£ç»•ç»„å¼€è·¯ã€ç›´è½´ç”µæ¢ç»•ç»„çŸ­è·¯æ—¶ï¼Œç›´è½´é˜»å°¼ç»•ç»„çš„æ—¶é—´å¸¸æ•°ï¼ˆç¬æ€æ—¶é—´å¸¸æ•°ï¼‰ï¼Œ$T_D'=x_D'/r_D$ã€‚\n- $T_D'$è®¡ç®—å¼ä¸­$x_D'=x_{Dl}+\\frac{1}{\\frac{1}{x_l}+\\frac{1}{x_{ad}}}=x_{Dl}+x_{ad}'$ï¼Œä¸ºè¯¥æƒ…å†µä¸‹ç›´è½´ç»•ç»„çš„ç­‰æ•ˆç”µæŠ—ï¼Œ$x_D'$ç­‰æ•ˆç”µè·¯å¦‚å›¾2-8æ‰€ç¤ºã€‚\n\n![](/images/1.2/tu28.png)\n\n- $\\sigma_{fD}$ä¸ºç”µæ¢ç»•ç»„**å¼€è·¯**æ—¶ï¼ŒåŠ±ç£ç»•ç»„å’Œç›´è½´é˜»å°¼ç»•ç»„é—´çš„æ¼ç£ç³»æ•°ï¼Œ$\\sigma_{fD}=1-{x_{ad}^2}/{x_fx_D}$\n\n- $\\sigma_{fD}'$ä¸ºç”µæ¢ç»•ç»„**çŸ­è·¯**æ—¶ï¼ŒåŠ±ç£ç»•ç»„å’Œç›´è½´é˜»å°¼ç»•ç»„é—´çš„æ¼ç£ç³»æ•°ï¼Œ$\\sigma_{fD}'=1-{x_{ad}'^2}/{x_f'x_D'}$\n\næ¼ç£ç³»æ•°åæ˜ ç»•ç»„é—´ç”µç£è€¦åˆçš„æ¼ç£æƒ…å†µã€‚å½“å®Œå…¨è€¦åˆæ— æ¼ç£æ—¶ï¼Œä¸Šè¿°æ¼ç£ç³»æ•°ä¸ºé›¶ã€‚å®é™…ä¸Šæ¯ä¸ªç»•ç»„æ€»å­˜åœ¨ç€åªä¸å„è‡ªç»•ç»„äº¤é“¾çš„æ¼ç£é“¾å’Œç›¸åº”çš„æ¼ç”µæ„Ÿï¼Œå› æ­¤ï¼Œæ¼ç£ç³»æ•°ä¸ä¼šä¸ºé›¶ï¼Œå…¶å¤§å°åæ˜ äº†æ¼ç£çš„å¤§å°ã€‚\n\nè½¬å­ä¸Šé™¤åŠ±ç£ç»•ç»„å¤–ï¼Œç›´è½´ä¸Šè¿˜è£…æœ‰é˜»å°¼ç»•ç»„æ—¶çš„ç›´è½´è¿ç®—ç”µæŠ—$x_d(p)$çš„æ—¶é—´å¸¸æ•°è¡¨è¾¾å¼å¯ç»§ç»­åˆ†è§£ä¸º$p$çš„å› å¼å½¢å¼ï¼š\n$$\nx_d(p)=\\frac{(T_d'p+1)(T_d''p+1)}{(T_{d0}'p+1)(T_{d0}''p+1)}x_d\n$$\nè”ç«‹ï¼Œæ—¶é—´å¸¸æ•°ç”±ä¸‹åˆ—$p$çš„äºŒæ¬¡æ–¹ç¨‹å¼ç¡®å®šï¼š\n$$\n(T_{d0}'p+1)(T_{d0}''p+1)=\\sigma_{fD}T_fT_Dp^2+(T_f+T_D)p+1\n$$\n$$\n(T_d'p+1)(T_d''p+1)=\\sigma_{fD}'T_f'T_D'p^2+(T_f'+T_D')p+1\n$$\nå¼ä¸­\n$$\nT_{d0}'=\\frac{2\\sigma_{fD}T_fT_D}{(1-q)(T_f+T_D)}=\\frac{1}{2}(1+q)(T_f+T_D)\\approx T_f+T_D\n$$\n$$\nT_{d0}''=\\frac{2\\sigma_{fD}T_fT_D}{(1+q)(T_f+T_D)} \\approx  \\frac{\\sigma_{fD}T_fT_D}{(T_f+T_D)}\n$$\n$$\nT_d'=\\frac{2\\sigma_{fD}'T_f'T_D'}{(1-q')(T_f'+T_D')}=\\frac{1}{2}(1+q')(T_f'+T_D')\\approx T_f'+T_D'\n$$\n$$\nT_d''=\\frac{2\\sigma_{fD}'T_f'T_D'}{(1+q')(T_f'+T_D')} \\approx  \\frac{\\sigma_{fD}'T_f'T_D'}{(T_f'+T_D')}\n$$\nå¼ä¸­$q\\approx1$ï¼Œ$q'\\approx1$ã€‚\n\nä¸Šå¼ä¸­çš„$T_{d0}'$ã€$T_{d0}''$ã€$T_d'$ã€$T_d''$æ˜¯åŒæ­¥ç”µæœºä¸»è¦çš„å››ä¸ªæ—¶é—´å¸¸æ•°ï¼Œå…¶å‡†ç¡®å€¼è®¡ç®—ç”±ä¸Šå¼ç»™å‡ºã€‚ä½†ä»¥ä¸Šè®¡ç®—éå¸¸ç¹çï¼Œå·¥ç¨‹è®¡ç®—è§’åº¦å¯è¿›ä¸€æ­¥ç®€åŒ–ã€‚è€ƒè™‘é˜»å°¼ç»•ç»„ç”µé˜»$r_D$æ ‡å¹ºå€¼è¿œå¤§äºåŠ±ç£ç»•ç»„ç”µé˜»$r_f$çš„æ ‡å¹ºå€¼ï¼Œè€Œç›¸åº”çš„ç”µæŠ—$x_D$ã€$x_f$çš„æ ‡å¹ºå€¼ç›¸è¿‘ï¼Œ$x_D'$ã€$x_f'$çš„æ ‡å¹ºå€¼äº¦ç›¸è¿‘ï¼Œå› æ­¤åœ¨ç›´è½´é˜»å°¼ç»•ç»„å’ŒåŠ±ç£ç»•ç»„çš„æ—¶é—´å¸¸æ•°ä¸­ï¼Œ$T_D$è¿œå°äº$T_f$ï¼Œä¸”$T_D'$è¿œå°äº$T_f'$ã€‚å› è€Œä¹‹å‰çš„è®¡ç®—å¼å¯è¿›ä¸€æ­¥ç®€åŒ–ä¸º\n$$\nT_{d0}'=T_f+T_D \\approx T_f = T_{d0}\n$$\n$$\nT_{d0}'' \\approx \\frac{\\sigma_{fD}T_fT_D}{(T_f+T_D)} \\approx \\sigma_{fD}T_D\n$$\n$$\nT_d'=T_f'+T_D' \\approx T_f'\n$$\n$$\nT_d'' \\approx \\frac{\\sigma_{fD}'T_f'T_D'}{(T_f'+T_D')} \\approx \\sigma_{fD}'T_D'\n$$\nè¿›ä¸€æ­¥å¯å¯¼å‡º\n$$\nT_{d0}'' \\approx \\sigma_{fD}T_D=(1-\\frac{x_{ad}^2}{x_fx_D})\\frac{x_D}{r_D}=(x_{Dl}+\\frac{1}{\\frac{1}{x_{ad}}+\\frac{1}{x_{fl}}})\\frac{1}{r_D}\n$$\n$$\nT_d'' \\approx \\sigma_{fD}'T_D'=(1-\\frac{x_{ad}'^2}{x_f'x_D'})\\frac{x_D'}{r_D}=(x_D'-\\frac{x_{ad}'^2}{x_f'})\\frac{1}{r_D}=(x_{Dl}+\\frac{1}{\\frac{1}{x_{ad}}+\\frac{1}{x_l}+\\frac{1}{x_{fl}}})\\frac{1}{r_D}\n$$\nå½“ç›´è½´è®¾ç½®æœ‰é˜»å°¼ç»•ç»„æ—¶ï¼Œä»ä»¥ä¸Šå¯¹ç›´è½´è¿ç®—ç”µæŠ—$x_d(p)$å¯¼å‡ºçš„æ—¶é—´å¸¸æ•°çš„å‡†ç¡®è®¡ç®—å¼å¯çœ‹å‡ºï¼Œ$T_{d0}'$ã€$T_{d0}''$ã€$T_d'$ã€$T_d''$å››ä¸ªæ—¶é—´å¸¸æ•°å‡ä¸åŠ±ç£ç»•ç»„å’Œé˜»å°¼ç»•ç»„ä¸¤ä¸ªç»•ç»„çš„æ—¶é—´å¸¸æ•°æœ‰å…³ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªç»•ç»„å‡æ”¾ç½®åœ¨è½¬å­ç›´è½´ä¸Šï¼ŒäºŒè€…ä¹‹é—´å­˜åœ¨ç±»ä¼¼äºå˜å‹å™¨ä¸€ã€äºŒæ¬¡ç»•ç»„é—´çš„ç”µç£èƒ½é‡ä¼ é€’å…³ç³»ã€‚ä¸å˜å‹å™¨ä¸åŒï¼ŒåŒæ­¥ç”µæœºä¸­æ—¶é—´å¸¸æ•°$T_D$è¿œå°äº$T_f$ï¼Œä¸”$T_D'$è¿œå°äº$T_f'$ï¼Œå› è€Œå¯ç®€åŒ–ï¼Œç®€åŒ–åçš„ç­‰æ•ˆç”µè·¯è§å›¾2-9.\n\n![](/images/1.2/tu29.png)\n\nå…¶ä¸­ï¼Œ$T_{d0}'$ã€$T_d'$æ˜¯ç”µæ¢ç»•ç»„åˆ†åˆ«ä¸ºå¼€è·¯ã€çŸ­è·¯æ—¶åŠ±ç£ç»•ç»„çš„æ—¶é—´å¸¸æ•°ï¼ŒäºŒè€…ä¸é˜»å°¼ç»•ç»„æ— å…³ï¼›è€Œ$T_{d0}''$ã€$T_d''$æ˜¯åŠ±ç£ç»•ç»„çŸ­è·¯ï¼Œç”µæ¢ç»•ç»„åˆ†åˆ«ä¸ºå¼€è·¯ã€çŸ­è·¯æ—¶ç›´è½´é˜»å°¼ç»•ç»„çš„æ—¶é—´å¸¸æ•°ã€‚\n\nä¸ºæ–¹ä¾¿é€†å˜æ¢ï¼Œå¯å¯¼å‡º$x_d(p)$çš„å€’æ•°å½¢å¼ä¸º\n\n$$\n\\frac{1}{x_d(p)}=\\frac{1}{x_d}+(\\frac{1}{x_d'}-\\frac{1}{x_d})\\frac{T_d'p}{T_d'p+1}+(\\frac{1}{x_d''}-\\frac{1}{x_d'})\\frac{T_d''p}{T_d''p+1}\n$$\n\näº¤è½´è¿ç®—ç”µæŠ—$x_q(p)$çš„è¡¨è¾¾å¼äº¦å¯ç”¨æ—¶é—´å¸¸æ•°è¡¨ç¤ºä¸º\n$$\nx_q(p)=x_q-\\frac{x_{aq}^2p}{r_Q+x_Qp}=x_q(\\frac{T_q''p+1}{T_{q0}''p+1})\n$$\nå¼ä¸­\n- $T_{q0}''$ä¸ºäº¤è½´é˜»å°¼ç»•ç»„æœ¬èº«çš„æ—¶é—´å¸¸æ•°ï¼Œ$T_{q0}''=x_Q/r_Q$\n- $T_q''$ä¸ºè€ƒè™‘åˆ°äº¤è½´ç”µæ¢ç»•ç»„çŸ­è·¯æ—¶ï¼Œäº¤è½´é˜»å°¼ç»•ç»„çš„æ—¶é—´å¸¸æ•°ï¼Œ$T_q''=\\frac{1}{r_Q}(x_{Ql}+x_{aq}x_l/(x_{aq}+x_l))$\n\n$T_{q0}''$å’Œ$T_q''$æ‰€å¯¹åº”çš„ç­‰æ•ˆç”µè·¯å¦‚å›¾2-10æ‰€ç¤ºã€‚\n\n![](/images/1.2/tu210.png)\n\nä¸ºæ–¹ä¾¿é€†å˜æ¢ï¼Œå¯å¯¼å‡º$x_q(p)$çš„å€’æ•°å½¢å¼ä¸º\n\n$$\n\\frac{1}{x_q(p)}=\\frac{1}{x_q}+(\\frac{1}{x_q''}-\\frac{1}{x_q})\\frac{T_q''p}{1+T_q''p}\n$$\n\n## åŒæ­¥ç”µæœºçš„ç­‰æ•ˆç”µè·¯\nä¸Šæ–‡å·²ç»é€šè¿‡ç”µæ¢ç£é“¾$\\psi_d(p)$ã€$\\psi_q(p)$çš„è¿ç®—æ–¹ç¨‹å¼ï¼Œå¯¼å‡ºäº†ç­‰æ•ˆè¿ç®—ç”µè·¯åŠç›¸åº”çš„è¿ç®—ç”µæŠ—ï¼Œåœ¨æ—¶åŸŸä¸­ä¹Ÿå¯ç”»å‡ºç±»ä¼¼äºå˜å‹å™¨å’Œæ„Ÿåº”ç”µæœºçš„åŒæ­¥ç”µæœºç­‰æ•ˆç”µè·¯ã€‚ä¸ºè·å¾—ç›´è½´ä¸Šå„ç»•ç»„çš„ç­‰æ•ˆç”µè·¯ï¼Œå°†æ ‡å¹ºå€¼è¡¨ç¤ºçš„ç›´è½´ç£é“¾æ–¹ç¨‹å¼ä»£å…¥ç”µå‹æ–¹ç¨‹å¼ï¼Œæœ‰\n$$\n\\begin{bmatrix}\nu_d\\\\u_f\\\\0\n\\end{bmatrix}=p\n\\begin{bmatrix}\nx_d & x_{ad} & x_{ad} \\\\\nx_{ad} & x_f & x_{ad} \\\\\nx_{ad} & x_{ad} & x_D\n\\end{bmatrix}\n\\begin{bmatrix}\ni_d \\\\ i_f \\\\ i_D \n\\end{bmatrix}+\n\\begin{bmatrix}\nr_a & 0 & 0 \\\\\n0 & r_f & 0 \\\\\n0 & 0 & r_D \\\\\n\\end{bmatrix}\n\\begin{bmatrix}\ni_d \\\\ i_f \\\\ i_D \n\\end{bmatrix}+\n\\begin{bmatrix}\n-\\omega \\psi_q \\\\ 0 \\\\ 0\n\\end{bmatrix}\n$$\nç›¸åº”çš„ç›´è½´ç­‰æ•ˆç”µè·¯å¦‚å›¾2-11æ‰€ç¤ºã€‚\n\n![](/images/1.2/tu211.png)\n\nåŒç†å¯åˆ—å‡ºäº¤è½´ç”µå‹æ–¹ç¨‹å¼ä¸º\n$$\n\\begin{bmatrix}\nu_q \\\\ 0\n\\end{bmatrix}=p\n\\begin{bmatrix}\nx_q & x_{aq} \\\\\nx_{aq} & x_Q\n\\end{bmatrix}\n\\begin{bmatrix}\ni_q \\\\ i_Q\n\\end{bmatrix}+\n\\begin{bmatrix}\nr_a & 0 \\\\\n0 & r_Q \\\\\n\\end{bmatrix}\n\\begin{bmatrix}\ni_q \\\\ i_Q\n\\end{bmatrix}+\n\\begin{bmatrix}\n\\omega \\psi_d \\\\ 0\n\\end{bmatrix}\n$$\nç›¸åº”çš„äº¤è½´ç­‰æ•ˆç”µè·¯å¦‚å›¾2-12æ‰€ç¤ºã€‚\n\n![](/images/1.2/tu212.png)\n\næ˜¾ç„¶ï¼Œæ–¹ç¨‹å¼ä¸ç­‰æ•ˆç”µè·¯å›¾æ˜¯å¯¹åº”çš„ï¼Œä»æ–¹ç¨‹å¼å¯ç”»å‡ºç­‰æ•ˆç”µè·¯ï¼Œåè¿‡æ¥ï¼Œæ ¹æ®ç­‰æ•ˆç”µè·¯å›¾ï¼Œåˆ©ç”¨åŸºå°”éœå¤«ç”µå‹å®šå¾‹ä¹Ÿå¯å†™å‡ºå„ç»•ç»„å›è·¯çš„ç”µå‹æ–¹ç¨‹å¼ã€‚\n\næ ¹æ®å‰é¢åˆ†æçš„ç»“æœï¼Œåˆ†æéšæåŒæ­¥ç”µæœºæ—¶ï¼Œåªè¦ä»¤ä¸Šé¢ç­‰æ•ˆç”µè·¯ä¸­$x_{ad}=x_{aq}$ï¼Œå³å¯ä½¿ç”¨ï¼›åˆ†ææ„Ÿåº”ç”µæœºæ—¶ï¼Œå†å°†åŠ±ç£å›è·¯å–æ¶ˆå³å¯ã€‚\n\nä¸‹é¢å°±å›¾2-11ã€2-12æ‰€ç¤ºçš„åŒæ­¥ç”µæœºç­‰æ•ˆç”µè·¯å›¾ä¸é€šå¸¸ç”µæœºå­¦ä¸­æ„Ÿåº”ç”µæœºç­‰æ•ˆç”µè·¯å›¾çš„å¼‚åŒæ¯”è¾ƒå¦‚ä¸‹ï¼š\n\n- åŒæ­¥ç”µæœºç­‰æ•ˆç”µè·¯æ˜¯æ ¹æ®å„å˜é‡ç¬æ—¶å€¼å†™å‡ºçš„ç”µå‹æ–¹ç¨‹å¼ç”»å‡ºçš„ï¼Œå¯ä»¥ç ”ç©¶**ç¬æ€**å’Œ**ç¨³æ€**é—®é¢˜ã€‚é€šå¸¸ç”µæœºå­¦ä¸­æ„Ÿåº”ç”µæœºç­‰æ•ˆç”µè·¯æ˜¯æ ¹æ®æ±‚è§£æ­£å¼¦ç¨³æ€ç”µè·¯çš„ç›¸é‡æ–¹ç¨‹å¼ç”»å‡ºçš„ï¼Œåªèƒ½æ±‚è§£**æ­£å¼¦ç¨³æ€**é—®é¢˜ã€‚\n\n- åœ¨é¢‘ç‡æŠ˜ç®—ä¸Šï¼Œç¨³æ€æ„Ÿåº”ç”µæœºçš„ç­‰æ•ˆç”µè·¯æ˜¯å°†æ—‹è½¬çš„è½¬å­ç»•ç»„é€šè¿‡é¢‘ç‡æŠ˜ç®—,æŠŠå®é™…è½¬å­ç»•ç»„çš„é¢‘ç‡ç”±$f_2=sf_1$è½¬æ¢ä¸ºå®šå­ç»•ç»„é¢‘ç‡$f_1$ï¼Œè€ŒåŒæ­¥ç”µæœºçš„ç­‰æ•ˆç”µè·¯æ˜¯å°†é™æ­¢çš„å®šå­ç»•ç»„è½´çº¿é€šè¿‡åæ ‡å˜æ¢å˜ä¸ºä¸è½¬å­åŒæ­¥æ—‹è½¬çš„dã€qä¸¤ç›¸ç»•ç»„è½´çº¿ï¼Œäº¦å³å°†ç”µæ¢ç»•ç»„ä¸­é¢‘ç‡ä¸º$f_1$çš„äº¤æµé‡è½¬æ¢ä¸ºé¢‘ç‡ä¸ºé›¶çš„ç›´æµé‡ã€‚\n\n## åŒæ­¥ç”µæœºçš„åŠŸç‡åŠç”µç£è½¬çŸ©\næœ‰åå€¼è¡¨ç¤ºä¸‰ç›¸åŒæ­¥ç”µæœºç”µæ¢ç«¯çš„ç¬æ—¶è¾“å…¥åŠŸç‡ä¸º\n$$\nP=u_ai_a+u_bi_b+u_ci_c\n$$\næ ‡å¹ºå€¼ç³»ç»Ÿä¸­åŠŸç‡åŸºå€¼ä¸º\n$$\nP_b=3U_NI_N=\\frac{3}{2}U_bI_b\n$$\nå› æ­¤æ ‡å¹ºå€¼è¡¨ç¤ºæ—¶ç”µæœºç”µæ¢ç«¯ç¬æ—¶ä¸‰ç›¸è¾“å…¥åŠŸç‡ä¸º\n$$\nP^*=\\frac{2}{3}(u_a^*i_a^*+u_b^*i_b^*+u_c^*i_c^*)\n$$\nå¯¹ä¸Šå¼ä¸­å˜é‡è¿›è¡ŒParkå˜æ¢åï¼Œdq0åæ ‡ç³»ä¸­ä¸‰ç›¸è¾“å…¥åŠŸç‡çš„æ ‡å¹ºå€¼ä¸º\n$$\nP^*=u_d^*i_d^*+u_q^*i_q^*+2u_0^*i_0^*\n$$\ndq0åæ ‡ç³»ä¸‹å› å®šå­ç»•ç»„ç”±åŸå…ˆçš„â€œé™æ­¢ç»•ç»„â€è½¬åŒ–ä¸ºâ€œä¼ªé™æ­¢ç»•ç»„â€ï¼Œç»•ç»„ç”µæ„Ÿç³»æ•°ç”±æ—¶å˜ç³»æ•°è½¬ä¸ºå¸¸ç³»æ•°ï¼Œå› è€Œå…ˆå‰åœ¨ç›¸åæ ‡ç³»ç»Ÿä¸­å¯¼å‡ºçš„ç”µç£è½¬çŸ©å…¬å¼å·²ç»ä¸å†é€‚ç”¨ã€‚ä¸‹é¢ä»¥èƒ½é‡å®ˆæ’åŸç†ä¸ºåŸºç¡€é‡æ–°æ¨å¯¼é€‚ç”¨äºè¿™ç§ç»•ç»„çš„ç”µç£è½¬çŸ©è¡¨è¾¾å¼ã€‚\n\nç”±äºé›¶è½´ç”µæµæ‰€äº§ç”Ÿçš„æ°”éš™åˆæˆç£åœºä¸ºé›¶ï¼Œä»…äº§ç”Ÿä¸ç”µæ¢ç»•ç»„äº¤é“¾çš„æ¼ç£åœºï¼Œå› è€Œä¸å‚ä¸ç”µç£åŠŸç‡çš„è½¬æ¢ï¼Œæ•…åœ¨æ¨å¯¼ç”µç£è½¬çŸ©æ—¶å¯ä»¥ä¸è€ƒè™‘é›¶è½´åˆ†é‡ã€‚\n\nç”±dq0åæ ‡ç³»ä¸­ä¸‰ç›¸è¾“å…¥åŠŸç‡çš„æ ‡å¹ºå€¼å¯çŸ¥ï¼Œé›¶è½´å¯¹åº”çš„è¾“å…¥åŠŸç‡ä¸º$2u_0i_0$ï¼Œå½“ä¸è€ƒè™‘ç”µæ¢é›¶è½´åˆ†é‡æ—¶ï¼Œä»å„ç«¯ç‚¹è¾“å…¥çš„ç”µåŠŸç‡ç¬æ—¶å€¼çš„æ€»å’Œä¸º\n$$\nI'^TU'=u_di_d+u_qi_q+u_fi_f\n$$\nå¼ä¸­\n$$\nI'^T=\n\\begin{bmatrix}\ni_d & i_q & i_f & i_D & i_Q\n\\end{bmatrix}\n$$\n$$\nU'= \\begin{bmatrix}\nu_d & u_q & u_f & 0 & 0\n\\end{bmatrix}^T\n$$\næ ¹æ®æ ‡å¹ºå€¼ç³»ç»Ÿä¸‹ç”µå‹æ–¹ç¨‹å¼ï¼Œå¯å¯¼å‡ºä¸è€ƒè™‘ç”µæ¢é›¶è½´åˆ†é‡çš„ç”µå‹æ–¹ç¨‹å¼ä¸º\n$$\nU'=L'pI'+\\omega G'I'+R'I'\n$$\nå¼ä¸­'ä¸Šæ ‡è¡¨ç¤ºè¯¥çŸ©é˜µæœªè€ƒè™‘é›¶è½´åˆ†é‡ï¼Œå…¶å¯ä»¥åˆ†åˆ«ä»ç›¸åº”çš„åŸå§‹çŸ©é˜µä¸­é™¤å»é›¶è½´åˆ†é‡çš„ç¬¬ä¸‰è¡Œä»¥åŠç¬¬ä¸‰åˆ—å¾—åˆ°ã€‚å¦‚è¯¥çŸ©é˜µæ–¹ç¨‹å·¦ä¹˜ä»¥ç”µæµçš„è½¬ç½®çŸ©é˜µ$I'^T$ï¼Œåˆ™åŠŸç‡æ–¹ç¨‹ä¸º\n$$\nI'^TU'=I'^TL'pI'+I'^T\\omega G'I'+I'^TR'I'\n$$\næ–¹ç¨‹çš„å·¦è¾¹æ˜¯ä»å„ç«¯ç‚¹è¾“å…¥çš„æ€»ç”µåŠŸç‡ï¼Œå³è¾¹ç”±äºŒé¡¹ç»„æˆï¼šç¬¬ä¸€é¡¹ä¸ºç”µæµå’Œç£é“¾å˜åŒ–ç‡çš„ä¹˜ç§¯ï¼Œå³$I'^TL'pI'=I'^Tp\\Psi'$ï¼Œå…¶ä»£è¡¨äº†å®šã€è½¬å­ç»•ç»„å‚¨å­˜ç£åœºèƒ½é‡çš„å˜åŒ–ç‡ï¼›ç¬¬ä¸‰é¡¹$I'^TR'I'$ä»£è¡¨äº†å®šã€è½¬å­ç»•ç»„çš„ç”µé˜»æŸè€—ã€‚æ ¹æ®åŠŸå¹³è¡¡å…³ç³»å¯çŸ¥ï¼Œç¬¬äºŒé¡¹$I'^T\\omega G'I'$æ˜¯è·¨è¿‡æ°”éš™ç”±ç”µåŠŸç‡è½¬ä¸ºæœºæ¢°åŠŸç‡çš„ç”µç£åŠŸç‡ã€‚ç”¨è½¬é€Ÿ$\\omega$é™¤å®ƒï¼Œå³å¾—åˆ°ç”¨æ ‡ä¹ˆå€¼è¡¨ç¤ºçš„ç”µç£è½¬çŸ©ï¼Œå³\n$$\nT_{em}=\\frac{I'^T\\omega G'I'}{\\omega}=I'^T G'I'\n$$\nçŸ©é˜µ$G$ä¸­ç¬¬ä¸‰è¡Œå’Œç¬¬ä¸‰åˆ—å…ƒç´ å‡ä¸º0ï¼Œæ‰€ä»¥æœ‰\n$$\nI'^T G'I'=I^TGI\n$$\nå³\n$$\nT_{em}=I^TGI\n$$\nè¯¥å¼é€‚ç”¨äºâ€œä¼ªé™æ­¢ç»•ç»„â€ç”µæœºã€‚å°†ç”µæµçŸ©é˜µ$I$å’ŒçŸ©é˜µ$G$ä»£å…¥ä¸Šå¼ï¼Œå¯å¾—ä¸‰ç›¸åŒæ­¥ç”µæœºçš„ç”µç£è½¬çŸ©ä¸º\n$$\nT_{em}=i_q\\psi_d-i_d\\psi_q\n$$","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºåœ¨ç›¸åæ ‡ç³»ç»Ÿä¸­çš„çŠ¶æ€æ–¹ç¨‹å¼ã€ç”µç£è½¬çŸ©å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼","url":"/2024/07/24/ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºåœ¨ç›¸åæ ‡ç³»ç»Ÿä¸­çš„çŠ¶æ€æ–¹ç¨‹å¼ã€ç”µç£è½¬çŸ©å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼/","content":"### äº¤æµç”µæœºåœ¨ç›¸åæ ‡ç³»ç»Ÿä¸­çš„çŠ¶æ€æ–¹ç¨‹å¼\nå°†å…ˆå‰å¾—å‡ºçš„ç£é“¾æ–¹ç¨‹å¼ä»£å…¥ç”µå‹æ–¹ç¨‹å¼ï¼Œå³å¯å¾—åˆ°äº¤æµç”µæœºåœ¨ç›¸åæ ‡ç³»ç»Ÿä¸­çš„ç”µå‹æ–¹ç¨‹å¼ï¼š\n$$\n\\begin{bmatrix}\nu_a \\\\\nu_b \\\\\nu_c \\\\\nu_f \\\\\nu_D \\\\\nu_Q\n\\end{bmatrix}=\np\n\\begin{bmatrix}\nL_{aa} & M_{ab} & M_{ac} & M_{af} & M_{aD} & M_{aQ}\\\\\nM_{ba} & L_{bb} & M_{bc} & M_{bf} & M_{bD} & M_{bQ}\\\\\nM_{ca} & M_{cb} & L_{cc} & M_{cf} & M_{cD} & M_{cQ}\\\\\nM_{fa} & M_{fb} & M_{fc} & L_{f}  & M_{fD} & 0 \\\\\nM_{Da} & M_{Db} & M_{Dc} & M_{Df} & L_{D} & 0  \\\\\nM_{Qa} & M_{Qb} & M_{Qc} & 0 & 0 & L_{Q}\\\\\n\\end{bmatrix}\n\\begin{bmatrix}\ni_a\\\\\ni_b\\\\\ni_c\\\\\ni_f\\\\\ni_D\\\\\ni_Q\n\\end{bmatrix}+\n\\begin{bmatrix}\nr_a & & & & & \\\\\n & r_b & & & & \\\\\n & & r_c & & & \\\\\n & & & r_f & & \\\\\n & & & & r_D & \\\\\n & & & & & r_Q \\\\\n\\end{bmatrix}\n\\begin{bmatrix}\ni_a\\\\\ni_b\\\\\ni_c\\\\\ni_f\\\\\ni_D\\\\\ni_Q\n\\end{bmatrix}\n$$\nå³\n$$\nU=p(LI)+RI\n$$\nçŸ©é˜µä¸­å„ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°å’Œäº’æ„Ÿç³»æ•°åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å·²æœ‰æ¨å¯¼ã€‚\n\nè¿™æ˜¯ä¸€ç»„è¡¨è¿°ç”µæœºåŸºæœ¬ç”µç£å…³ç³»çš„*æ—¶å˜*ç³»æ•°çš„å¾®åˆ†æ–¹ç¨‹ç»„ï¼Œåœ¨å·²çŸ¥ç”µæ„Ÿç³»æ•°å’Œç”µé˜»çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨è¿™ç»„æ–¹ç¨‹å°±å¯ä»¥æ±‚è§£**æ’é€Ÿ**è¿è½¬æ—¶ç”µæœºçš„ç¬æ€å’Œç¨³æ€è¿è¡Œé—®é¢˜ã€‚ç”±äºå®šå­ç»•ç»„ç”µæ„Ÿç³»æ•°å’Œå®šã€è½¬å­ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°å‡ä¸ºä½ç½®è§’$\\theta$çš„å‡½æ•°ï¼Œå³ä¸ºæ—¶é—´çš„å‡½æ•°ï¼Œå› æ­¤ï¼Œåœ¨æ±‚è§£ä¸Šè¿°ç”µå‹æ–¹ç¨‹å¼æ—¶,ä¸èƒ½é‡‡ç”¨è§£ææ–¹æ³•,è€Œéœ€é‡‡ç”¨æ•°å€¼è§£æ³•ã€‚\n\nç”¨æ•°å€¼æ³•æ±‚è§£å¾®åˆ†æ–¹ç¨‹ç»„,å¯å°†å¼$U=p(LI)+RI$æ”¹å†™ä¸ºçŠ¶æ€æ–¹ç¨‹ç»„ã€‚çŠ¶æ€æ–¹ç¨‹æ˜¯ä¸€ç»„ä¸€é˜¶çš„å¾®åˆ†æ–¹ç¨‹å¼ã€‚åœ¨ç”µæœºåˆ†æä¸­åˆ©ç”¨çŠ¶æ€å˜é‡æ³•æ—¶ï¼Œä¸€èˆ¬å¯é€‰å–å„ç»•ç»„å›è·¯ä¸­çš„ç”µæµæˆ–ç£é“¾ä½œä¸ºçŠ¶æ€å˜é‡ï¼Œè¿™äº›å˜é‡éƒ½æ˜¯ä¸èƒ½çªå˜çš„é‡ã€‚*æ­¤å¤„çš„æ›´å¤šå†…å®¹è¯·å‚é˜…ã€Šçº¿æ€§æ§åˆ¶ç†è®ºã€‹ã€‚*\n\nè‹¥é€‰å–å®šå­ä¸‰ç›¸ç”µæµ$i_a$ã€$i_b$ã€$i_c$ï¼ŒåŠè½¬å­ç»•ç»„ç”µæµ$i_f$ã€$i_D$ã€$i_Q$ä¸ºçŠ¶æ€å˜é‡ï¼Œåˆ™ç”µå‹æ–¹ç¨‹å¼å¯æ”¹å†™ä¸ºï¼š\n$$\nU=pLI+RI=(pL)I+LpI+RI\n$$\nå¼ä¸­$pL$ä¸ºç”µæ„Ÿç³»æ•°çŸ©é˜µçš„ä¸€é˜¶å¯¼æ•°ã€‚\n\nç”¨çŠ¶æ€æ–¹ç¨‹ç»„çš„æ ‡å‡†å½¢å¼å°†ä¸Šå¼è¡¨ç¤ºå¦‚ä¸‹\n$$\n\\dot I = AI + BU\n$$\nå¼ä¸­\n$$\nA=-L^{-1}[D+R]\\\\\nD=pL\\\\\nB=L^{-1}\n$$\nå½“éœ€è¦è€ƒè™‘ç”µæ„Ÿç³»æ•°çš„é«˜æ¬¡è°æ³¢é¡¹æ—¶ï¼Œç”±äºå®šå­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°å’Œäº’æ„Ÿç³»æ•°ï¼ŒåŠå®šã€è½¬å­ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°å‡ä¸ºä½ç½®è§’$\\theta$çš„æ— ç©·ä¸‰è§’çº§æ•°ï¼Œç³»æ•°çŸ©é˜µ$L$åŠå…¶å¯¼æ•°$D$çš„è®¡ç®—å·¥ä½œé‡å¾ˆå¤§ï¼Œç”¨æ‰‹å·¥è®¡ç®—æ˜¯ä¸å¯èƒ½çš„ï¼Œå› è€Œéšç€è®¡ç®—æœºæŠ€æœ¯çš„å‘å±•å’Œå¹¿æ³›åº”ç”¨ï¼Œå¯åˆ©ç”¨è®¡ç®—æœºæ±‚è§£ä¸Šè¿°çŠ¶æ€æ–¹ç¨‹ç»„çš„æ•°å€¼è§£ã€‚\n\nç›¸åæ ‡ç³»ç»Ÿä¸‹å¯¼å‡ºçš„å‡¸æåŒæ­¥ç”µæœºçš„ç”µå‹æ–¹ç¨‹å¼ï¼Œåªè¦ä½œç›¸åº”çš„å˜åŒ–ï¼Œå°±å¯é€‚ç”¨äºéšæåŒæ­¥ç”µæœºå’Œæ„Ÿåº”ç”µæœºã€‚éšæåŒæ­¥ç”µæœºä¸å‡¸æåŒæ­¥ç”µæœºçš„å·®åˆ«æ˜¯éšæåŒæ­¥ç”µæœºçš„æ°”éš™ä¸ºå‡åŒ€çš„ã€‚æ„Ÿåº”ç”µæœºä¸éšæåŒæ­¥ç”µæœºç›¸æ¯”ï¼Œå®šå­ç»“æ„éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ°”éš™ä¹Ÿæ˜¯å‡åŒ€çš„ï¼Œåªæ˜¯æ„Ÿåº”ç”µæœºè½¬å­ç»•ç»„ä¸­æ²¡æœ‰åŠ±ç£ç»•ç»„ï¼Œæ„Ÿåº”ç”µæœºçš„çŸ­è·¯è½¬å­ç»•ç»„ç›¸å½“äºåŒæ­¥ç”µæœºçš„é˜»å°¼ç»•ç»„ã€‚æ‰€ä»¥ä»å‡¸æåŒæ­¥ç”µæœºå…¥æ‰‹æ¨å¯¼çš„æ–¹ç¨‹å¼ï¼Œåªéœ€ä½œå¾ˆå°çš„å˜åŠ¨ï¼Œå°±å¯ä»¥æ–¹ä¾¿åœ°ç”¨äºéšæåŒæ­¥ç”µæœºå’Œæ„Ÿåº”ç”µæœºã€‚\n\nç›¸åæ ‡ç³»ç»Ÿä¸‹äº¤æµç”µæœºçš„ç”µå‹æ–¹ç¨‹å¼çš„ç‰¹ç‚¹æ˜¯å¯ä»¥è€ƒè™‘ç©ºé—´æ°”éš™ç£åœºè°æ³¢ï¼Œé€‚ç”¨äºè®¡ç®—ç£åœºè°æ³¢å¾ˆå¼ºçš„ç”µæœºã€‚åˆ©ç”¨è¿™äº›æ–¹ç¨‹ï¼Œå¯æ±‚è§£**æ’é€Ÿ**è¿è½¬æ—¶çš„ç”µæœºç¬æ€å’Œç¨³æ€è¿è¡Œé—®é¢˜ã€‚å¦‚æœå†åŠ ä¸Šç”µæœºçš„ç”µç£è½¬çŸ©å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹ï¼Œç”µæœºå˜é€Ÿè¿è½¬æ—¶çš„æœºç”µè¿‡æ¸¡è¿‡ç¨‹ä¹Ÿå¯æ±‚è§£ã€‚ä¸‹èŠ‚å°†å¯¹ç”µæœºçš„ç”µç£è½¬çŸ©å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹åŠ ä»¥è®¨è®ºã€‚\n\n### äº¤æµç”µæœºç”µç£è½¬çŸ©å’Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼\nç”µç£è½¬çŸ©æ˜¯ç”µæœºè¿›è¡Œæœºç”µèƒ½é‡è½¬æ¢çš„å…³é”®é‡ï¼Œä¹Ÿæ˜¯è¡¨å¾ç”µæœºæ€§èƒ½çš„é‡è¦é‡ã€‚è€Œè½¬å­è¿åŠ¨æ–¹ç¨‹æ˜¯æ ¹æ®ç‰›é¡¿å®šå¾‹å†™å‡ºçš„ä½œç”¨åœ¨ç”µæœºè½¬å­ä¸Šçš„è½¬çŸ©ä¹‹é—´çš„å¹³è¡¡æ–¹ç¨‹å¼ï¼Œå½“è€ƒè™‘è½¬å­è½¬é€Ÿå˜åŒ–æ—¶ï¼Œé™¤ä¸Šè¿°ç”µå‹æ–¹ç¨‹å¼å¤–ï¼Œå°šéœ€å¢åŠ è½¬å­è¿åŠ¨æ–¹ç¨‹å¼è”ç«‹æ±‚è§£ã€‚ä¸‹é¢å…ˆè®¨è®ºäº¤æµç”µæœºçš„ç”µç£è½¬çŸ©ã€‚\n\nè®¾äº¤æµç”µæœºçš„å®šå­ç»•ç»„æœ‰$m$ä¸ªå›è·¯ï¼Œä»¥ä¸‹æ ‡\"$sm$\"è¡¨ç¤ºå®šå­ç¬¬$m$ä¸ªå›è·¯ï¼›è½¬å­ç»•ç»„æœ‰$n$ä¸ªå›è·¯ï¼Œä»¥ä¸‹æ ‡\"$rn$\"è¡¨ç¤ºå®šå­ç¬¬$n$ä¸ªå›è·¯ã€‚å‡è®¾ç£è·¯ä¸ºçº¿æ€§ï¼Œåˆ™ç”µæœºçš„æ€»ç£åœºèƒ½é‡ä¸º\n$$\nW_{m}=\\frac{1}{2}(\\psi_{s1}i_{s1}+\\psi_{s2}i_{s2}+...+\\psi_{sm}i_{sm}+\\psi_{r1}i_{r1}+\\psi_{r2}i_{r2}+...+\\psi_{rn}i_{rn})\n$$\nå¼ä¸­å„å›è·¯çš„ç£é“¾åˆ†åˆ«ä¸º\n$$\n\\psi_{s1}=L_{s1}i_{s1}+...+M_{s1sm}i_{sm}+M_{s1r1}i_{r1}+...+M_{s1rn}i_{rn}\\\\\n...\\\\\n\\psi_{sm}=M_{sms1}i_{s1}+...+L_{sm}i_{sm}+M_{smr1}i_{r1}+...+M_{smrn}i_{rn}\\\\\n\\psi_{r1}=M_{r1s1}i_{r1}+...+M_{r1sm}i_{sm}+L_{r1}i_{r1}+...+M_{r1rn}i_{rn}\\\\\n...\\\\\n\\psi_{rn}=M_{rns1}i_{s1}+...+M_{rnsm}i_{sm}+M_{rnr1}i_{r1}+...+L_{rn}i_{rn}\n$$\n\nè‹¥æ”¹å†™ä¸ºçŸ©é˜µå½¢å¼ï¼Œå¯è¡¨ç¤ºä¸º\n$$\nW_m=\\frac{1}{2}I^TLI\n$$\n\næ ¹æ®*è™šä½ç§»å®šç†*ï¼Œå½“å„å›è·¯ç”µæµä¿æŒä¸å˜æ—¶ï¼Œæœ‰\n$$\nf=\\frac{\\partial W_m}{\\partial g}|i=const\n$$\nå¼ä¸­$f$ä¸ºå¹¿ä¹‰åŠ›ï¼Œ$g$ä¸ºå¹¿ä¹‰ä½ç§»ã€‚\n\nè‹¥è§†å¹¿ä¹‰ä½ç§»ä¸ºè½¬å­ç»•ç»„å‚è€ƒè½´çº¿é¢†å…ˆäºå®šå­ç»•ç»„å‚è€ƒè½´çº¿çš„æœºæ¢°è§’åº¦$\\gamma$ï¼Œåˆ™å¹¿ä¹‰åŠ›å³ä¸ºç”µæœºçš„ç”µç£è½¬çŸ©$T_{em}$ï¼Œæœ‰\n$$\nT_{em}=\\frac{\\partial W_m}{\\partial \\gamma}=\\frac{\\partial (\\frac{1}{2}I^TLI)}{\\partial \\gamma}=\\frac{1}{2}I^T\\frac{\\partial L}{\\partial \\gamma}I\n$$\n\nç”µæœºæå¯¹æ•°ä¸º$p$ï¼Œ$\\theta$ä¸ºè½¬å­ç»•ç»„å‚è€ƒè½´çº¿é¢†å…ˆäºå®šå­ç»•ç»„å‚è€ƒè½´çº¿çš„ç”µè§’åº¦ï¼Œ$\\gamma$ä¸ºåŒæ­¥ç”µæœºdè½´é¢†å…ˆäºaè½´çš„ä½ç½®è§’ï¼ˆæœºæ¢°è§’åº¦ï¼‰ï¼Œåˆ™æœ‰\n$$\n\\gamma = \\theta / p\n$$\nç”µç£è½¬çŸ©å¯ç»§ç»­æ”¹å†™ä¸º\n$$\nT_{em}=\\frac{p}{2}I^T\\frac{\\partial L}{\\partial \\theta}I\n$$\nåœ¨å»ºç«‹è½¬å­è¿åŠ¨æ–¹ç¨‹æ—¶ï¼ŒæŒ‰ç”µåŠ¨æœºæƒ¯ä¾‹é€‰ç”¨ç”µç£è½¬çŸ©çš„æ­£æ–¹å‘ï¼Œå®ƒçš„æ­£æ–¹å‘ä¸è½¬å­æ­£å¸¸æ—‹è½¬æ–¹å‘ä¸€è‡´ã€‚å¦‚ä¸‹å›¾ï¼›\n\n![å»ºç«‹è½¬å­è¿åŠ¨æ–¹ç¨‹ç”¨å›¾](/images/1.2/zhuanzifangcheng.png)\n\n\nå…¶ä¸­$T_{em}$ä¸ºç”µåŠ¨æœºçš„ç”µç£è½¬çŸ©ï¼Œæ˜¯é©±åŠ¨è½¬çŸ©ï¼›$T_m$ä¸ºè´Ÿè½½çš„æœºæ¢°è½¬çŸ©ï¼Œæ˜¯åˆ¶åŠ¨è½¬çŸ©ï¼›å‰©ä½™è½¬çŸ©$T_{em}-T_m$åˆ™ä¸ºåŠ é€Ÿè½¬çŸ©ã€‚ç”±æ­¤å¯å¾—è½¬å­è¿åŠ¨æ–¹ç¨‹ä¸º\n$$\nJ\\frac{d\\Omega}{dt}=T_{em}-T_m\n$$\nå¼ä¸­$J$ä¸ºè½¬åŠ¨æƒ¯é‡($kgm^2$)ï¼Œ$\\Omega$ä¸ºè½¬å­æœºæ¢°è§’é€Ÿåº¦ï¼Œ$\\Omega=\\frac{d\\gamma}{dt}$ã€‚\n\nç”µæœºä¸­å¸¸ç”¨ç”µå¼§åº¦æ¥è¡¨ç¤ºè§’åº¦ï¼Œå°†ä¸Šå¼æ”¹å†™ä¸ºï¼š\n$$\nJ\\frac{1}{p} \\times \\frac{d\\omega}{dt}=J\\frac{1}{p} \\times \\frac{d^2\\theta}{dt^2}=T_{em}-T_m\n$$\nå¼ä¸­$\\omega$ä¸ºè½¬å­è½¬é€Ÿ($rad/s$)ï¼Œ$\\omega = \\frac{d\\theta}{dt}$ã€‚\n\næ ¹æ®ç”µåŠ›æ‹–åŠ¨å†…å®¹ï¼Œè‹¥è½¬åŠ¨éƒ¨åˆ†é£è½®è½¬çŸ©ä¸º$GD^2$ï¼Œå·¥ç¨‹å¸¸ç”¨å•ä½ä¸º$tÂ·m^2$ï¼Œåˆ™\n$$\nJ=\\frac{1}{4}GD^2 \\times 10^3 kgm^2\n$$\nè”ç«‹è½¬åŒ–ä¸ºçŠ¶æ€æ–¹ç¨‹ä¸º\n$$\n\\frac{d\\omega}{dt}=\\frac{p}{J}(T_{em}-T_m)\\\\\n\\frac{d\\theta}{dt}=\\omega\n$$\nå½“éœ€è¦æ±‚è§£ç”µæœºå˜é€Ÿé—®é¢˜ï¼Œå³$\\omega$ä¸ä¸ºå¸¸ç³»æ•°æ—¶ï¼Œéœ€é€šè¿‡è”ç«‹æ±‚è§£ä¸¤ä¸ªçŠ¶æ€æ–¹ç¨‹å¼ï¼ˆä¸ŠèŠ‚å’Œæœ¬èŠ‚ï¼‰å¾—åˆ°å„çŠ¶æ€å˜é‡ã€‚æ­¤æ—¶$\\theta \\neq \\omega t + \\theta_0$ï¼Œéœ€é€šè¿‡ä¸Šå¼ä¸­çš„ç¬¬äºŒå¼è§£å‡º$\\theta$ã€‚\n\n### è½¬å­è¿åŠ¨æ–¹ç¨‹å¼çš„æ ‡å¹ºå€¼å½¢å¼\n\nå·¥ç¨‹å®è·µä¸­ï¼Œè½¬å­è¿åŠ¨æ–¹ç¨‹å¼å¸¸ç”¨æ ‡å¹ºå€¼å½¢å¼ã€‚è½¬çŸ©çš„åŸºå€¼ä¸€èˆ¬é€‰ä¸º\n$$\nT_b=\\frac{S_N \\times 10^3}{\\frac{2\\pi n}{60}}\n$$\nå¼ä¸­$S_N$ä¸ºç”µæœºé¢å®šè§†åœ¨åŠŸç‡($kVA$)ï¼Œ$n$ä¸ºç”µæœºåŒæ­¥è½¬é€Ÿ($r/min$)ã€‚\n\næ—¶é—´åŸºå€¼ä¸€èˆ¬é€‰ä¸º$\\tau_b=\\frac{1}{2\\pi f}$ï¼Œå³ä¸ºç”µæœºè½¬è¿‡ä¸€ä¸ªç”µå¼§åº¦æ‰€éœ€çš„æ—¶é—´ã€‚ç”¨è½¬çŸ©åŸºå€¼é™¤åŸå¼çš„ä¸¤ä¾§ï¼Œå¯å¾—\n$$\nH\\frac{d^2\\theta}{dt^2}=H\\frac{d\\omega^*}{dt^*}=(T_{em}^*-T_m^*)\n$$\nå…¶ä¸­$H$è¢«ç§°ä¸ºæƒ¯æ€§å¸¸æ•°ï¼Œå¯å¯¼å‡ºä¸º\n$$\nH=\\frac{1}{p} \\times \\frac{GD^2}{S_N}2\\pi^3f^2(\\frac{n}{60})=2\\pi^3f\\times \\frac{GD^2}{S_N}(\\frac{n}{60})^2\n$$\n$H$å’Œæ—¶é—´æ ‡å¹ºå€¼ä¹‹é—´æœ‰ç®€å•çš„å…³ç³»ï¼š\n$$\ndt^*=\\frac{Hd\\omega^*}{T_{em}^*-T_m^*}\n$$\nå‡è®¾å‰©ä½™è½¬çŸ©$T_{em}^*-T_m^*=1$ï¼Œç”µæœºè½¬é€Ÿä»é›¶ä¸Šå‡è‡³åŒæ­¥è½¬é€Ÿ($\\omega^*=1$)æ‰€éœ€çš„æ—¶é—´ä¸º$\\tau$ï¼Œåˆ™\n$$\n\\tau = \\int_{0}^{\\tau}dt^*=\\int_{0}^{1}Hd\\omega^*=H\n$$\nå¯è§ï¼Œåœ¨åŸæ¥é™æ­¢çš„ç”µæœºè½¬å­ä¸ŠåŠ ä¸Šæ ‡å¹ºå€¼ä¸º1çš„å‰©ä½™è½¬çŸ©åï¼Œè½¬é€Ÿç”±é›¶ä¸Šå‡è‡³åŒæ­¥è½¬é€Ÿçš„æ—¶é—´æ ‡å¹ºå€¼ç­‰äº$H$ã€‚\n","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘åŒæ­¥ç”µæœºæ ‡å¹ºå€¼ç³»ç»Ÿ","url":"/2024/07/21/ã€ç”µæœºç¬æ€åˆ†æã€‘åŒæ­¥ç”µæœºæ ‡å¹ºå€¼ç³»ç»Ÿ/","content":"### æ ‡å¹ºå€¼ç³»ç»Ÿ\nç”µæ°”å·¥ç¨‹é¢†åŸŸä¸­ï¼Œå› é‡‡ç”¨æœ‰åå€¼æ—¶ä¸åŒå®¹é‡ç”µæœºå‚æ•°ä¹‹é—´ä¸ä¾¿äºæ¯”è¾ƒï¼Œæ•…é€šå¸¸çš„å·¥ç¨‹è®¡ç®—ä¸­å¤šé‡‡ç”¨æ ‡å¹ºå€¼ç³»ç»Ÿã€‚\n\næ ‡å¹ºå€¼çš„å®šä¹‰ä¸ºï¼šæ ‡å¹ºå€¼=æœ‰åå€¼/åŸºå€¼ã€‚å…¶ä¸­åŸºå€¼ä¸æœ‰åå€¼çš„å•ä½åº”å½“ç›¸åŒã€‚\n\nè¦é‡‡ç”¨æ ‡å¹ºå€¼ç³»ç»Ÿï¼Œåˆ™å¿…é¡»é¦–å…ˆè§£å†³åŸºå€¼çš„é€‰å–é—®é¢˜ã€‚ç”µæœºåˆ†ææœ€å¸¸ç”¨çš„ä¸€å¥—åŸºå€¼ç³»ç»Ÿé€‰å–åŸåˆ™ä¸ºï¼š\n- ä½¿é‡‡ç”¨æ ‡å¹ºå€¼åç”µæœºå„æ–¹ç¨‹å¼çš„å½¢å¼ä¸é‡‡ç”¨æœ‰åå€¼æ—¶çš„ç›¸åŒ\n- ç”¨æ ‡å¹ºå€¼è¡¨ç¤ºçš„ç”µæ¢ä¸è½¬å­ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°æ˜¯å¯é€†çš„\n\næ˜¾ç„¶ç”µæœºä¸­å„ç‰©ç†é‡çš„é‡çº²éƒ½å¯ä»¥è¡¨ç¤ºä¸ºç”µå‹ã€ç”µæµå’Œæ—¶é—´ä¸‰ä¸ªé‡çº²çš„ç»„åˆï¼Œå› æ­¤åªè¦ç¡®å®šè¿™ä¸‰ä¸ªå˜é‡çš„åŸºå€¼ï¼Œå°±å¯æ¨å¹¿ç¡®å®šç”µæœºè¿è¡Œä¸­æ‰€æœ‰å˜é‡çš„æ ‡å¹ºå€¼åŸºå€¼ã€‚\n\n### å®šå­å„å˜é‡åŸºå€¼çš„é€‰å–\nç¬æ€åˆ†ææ—¶å„å˜é‡å‡é‡‡ç”¨ç¬æ—¶å€¼å½¢å¼ï¼Œæ•…ç”µå‹ã€ç”µæµåŸºå€¼å¸¸é‡‡ç”¨å…¶é¢å®šå€¼çš„å¹…å€¼ï¼Œè€Œä¸ä½¿ç”¨å…¶æœ‰æ•ˆå€¼ã€‚\n\n- å®šå­ç”µæµåŸºå€¼$I_b$é€‰å–å®šå­ç›¸ç”µæµé¢å®šå€¼çš„å¹…å€¼\n- å®šå­ç”µå‹åŸºå€¼$U_b$é€‰å–å®šå­ç›¸ç”µå‹é¢å®šå€¼çš„å¹…å€¼\n- æ—¶é—´åŸºå€¼$\\tau_b=1/\\omega_N=1/2{(\\pi f_N)}(s)$ï¼Œå³åœ¨é¢å®šé¢‘ç‡$f_N$ä¸‹ç»è¿‡ä¸€ä¸ªç”µå¼§åº¦æ‰€éœ€çš„æ—¶é—´ã€‚\n\nä»¥ä¸Šä¸‰ä¸ªå˜é‡å‡ä¸ºç‹¬ç«‹åœ°é€‰å–å…¶åŸºå€¼ï¼Œä¸ºä¿è¯æ–¹ç¨‹å¼å½¢å¼åœ¨ä½¿ç”¨æ ‡å¹ºå€¼ç³»ç»Ÿæ—¶ä¿æŒä¸å˜ï¼Œä»¥ä¸‹å˜é‡çš„åŸºå€¼éœ€è¦æ ¹æ®é‡çº²å…³ç³»ï¼ŒåŸºäºä¸Šè¿°ä¸‰ä¸ªåŸºæœ¬å˜é‡çš„åŸºå€¼è¿›è¡Œå¯¼å‡ºã€‚\n\n- é˜»æŠ—åŸºå€¼ï¼š$Z_b=\\frac{U_b}{I_b}$  $(\\Omega=V/A)$\n- è§’é¢‘ç‡åŸºå€¼ $\\omega_b=\\frac{1}{\\tau_b}$ $(rad/s)$\n- ç”µæ„ŸåŸºå€¼ $L_b=\\frac{Z_b}{\\omega_b}=\\frac{U_b}{I_b}\\tau_b$ $(H=Vs/A)$\n- ç£é“¾åŸºå€¼ $\\psi_b=L_bI_b=U_b\\tau_b$ $(Wb=Vs)$\n\næ­¤å¤„ç”µæ„ŸåŸºå€¼çš„æ¨å¯¼åŸºäº$Z_L=j\\omega L$ã€‚\n\nä»¥ä¸‹åŸºå€¼æŒ‰æƒ¯ç”¨æ–¹æ³•é€‰å–ï¼šåŠŸç‡åŸºå€¼å–ä¸‰ç›¸**é¢å®š**è§†åœ¨åŠŸç‡ï¼Œå³\n- åŠŸç‡åŸºå€¼ $P_b=3U_NI_N=\\frac{3}{2}U_{Nm}I_{Nm}=\\frac{3}{2}U_bI_b$ $(VA)$ ï¼ˆæ³¨æ„$U_b$å’Œ$I_b$å‡ä¸ºå¹…å€¼è€Œéæœ‰æ•ˆå€¼ï¼Œæ‰€ä»¥ç­‰å¼ç¬¬ä¸‰é¡¹è¦é™¤ä»¥ä¸¤æ¬¡æ ¹å·2ï¼‰\n- è½¬çŸ©åŸºå€¼ $T_b = \\frac{P_b}{\\Omega_N}=\\frac{P_b}{\\omega_b}p$ $(Nm)$ å¼ä¸­$\\Omega_N$ä¸ºé¢å®šæœºæ¢°è§’é€Ÿåº¦ï¼Œå•ä½$rad/s$ï¼›$p$ä¸ºç£æå¯¹æ•°ã€‚\nï¼ˆæ³¨æ„æ­¤å¤„æœ‰$\\omega_b=p\\Omega_N$ï¼Œå³åŒæ­¥ç”µæœºç”µæ°”è§’é¢‘ç‡åŸºå€¼ç­‰äºç”µæœºé¢å®šæœºæ¢°è§’é€Ÿåº¦ä¹˜ä»¥æå¯¹æ•°ã€‚å¯¹äºå•æç”µæœºï¼Œé¢å®šæœºæ¢°è§’é€Ÿåº¦ç­‰äºç”µæ°”è§’é¢‘ç‡ï¼›å¯¹äºå¤šæç”µæœºï¼Œç”µæ°”è§’é¢‘ç‡ä¸€èˆ¬æ•°å€äºé¢å®šæœºæ¢°è§’é€Ÿåº¦ã€‚ï¼‰\n\n### è½¬å­å„é‡åŸºå€¼çš„é€‰å–\nè½¬å­çš„æ—¶é—´åŸºå€¼$\\tau_b$ä¸å®šå­ä¸€è‡´ï¼Œå…³é”®æ˜¯è¦ç¡®å®šè½¬å­å„ç»•ç»„ç”µå‹ã€ç”µæµåŸºå€¼ã€‚ä¸‹é¢è®¨è®ºå¸¸ç”¨çš„å¯é€†çš„äº’æ„Ÿç³»æ•°å’Œ$x_{ad}$åŸºå€¼ç³»ç»Ÿçš„è½¬å­åŸºå€¼é€‰å–æ–¹æ³•ã€‚\n\nå‡å®šï¼š\n- $I_{fb}$ã€$U_{fb}$ã€$\\psi_{fb}$ä¸ºåŠ±ç£ç»•ç»„çš„ç”µæµåŸºå€¼ã€ç”µå‹åŸºå€¼å’Œç£é“¾åŸºå€¼ï¼›\n\n- $I_{Db}$ã€$U_{Db}$ã€$\\psi_{Db}$ä¸ºç›´è½´é˜»å°¼ç»•ç»„çš„ç”µæµåŸºå€¼ã€ç”µå‹åŸºå€¼å’Œç£é“¾åŸºå€¼ï¼›\n\n- $I_{Qb}$ã€$U_{Qb}$ã€$\\psi_{Qb}$ä¸ºäº¤è½´é˜»å°¼ç»•ç»„çš„ç”µæµåŸºå€¼ã€ç”µå‹åŸºå€¼å’Œç£é“¾åŸºå€¼ã€‚\n\nä»¤å®šå­ç”µæµåŸºå€¼åŠç”µå‹åŸºå€¼ä¸è½¬å­ç»•ç»„ç›¸åº”é‡çš„åŸºå€¼çš„æ¯”å€¼ä¸º\n$$\nk_{if}=\\frac{I_b}{I_{fb}},k_{iD}=\\frac{I_b}{I_{Db}}.k_{iQ}=\\frac{I_b}{I_{Qb}}\\\\\nk_{uf}=\\frac{U_b}{U_{fb}},k_{uD}=\\frac{U_b}{U_{Db}}.k_{uQ}=\\frac{U_b}{U_{Qb}}\n$$\n\nç”±$\\psi=LI$å’Œ$L_b=\\frac{Z_b}{\\omega_b}=\\frac{U_b}{I_b}\\tau_b$ï¼Œå¯æ¨å¯¼å¾—$\\psi_b=U_b\\tau_b$ã€‚æ‰€ä»¥å®šå­ã€è½¬å­ç£é“¾åŸºå€¼æ¯”ä¸ç”µå‹åŸºå€¼æ¯”ç›¸åŒï¼Œå³ï¼š\n$$\nk_{uf}=\\frac{\\psi_b}{\\psi_{fb}},k_{uD}=\\frac{\\psi_b}{\\psi_{Db}},k_{uQ}=\\frac{\\psi_b}{\\psi_{Qb}}\n$$\nç”¨æ ‡å¹ºå€¼è¡¨ç¤ºçš„ç£é“¾æ–¹ç¨‹å¼å¯æ¨å¯¼ä¸ºï¼š\n$$\n\\left[\\begin{array}{l}\n\\psi_{d}^* \\\\\n\\psi_{f}^* \\\\\n\\psi_{D}^* \n\\end{array}\\right]=\\left[\\begin{array}{ccc}\nL_d^* & M_{af}^* & M_{aD}^*\\\\\nM_{fa}^* & L_f^* & M_{fD}^*\\\\\nM_{Da}^* & M_{Df}^* & L_D^*\n\\end{array}\\right]\\left[\\begin{array}{l}\ni_{d}^* \\\\\ni_{f}^* \\\\\ni_{D}^* \n\\end{array}\\right]\n$$\nä¸Šå¼ä¸­å„è‡ªæ„Ÿç³»æ•°å’Œäº’æ„Ÿç³»æ•°çš„æ ‡å¹ºå€¼å¯æ¨å¯¼å¦‚ä¸‹ï¼š\n$$\nM_{af}^*=\\frac{M_{af0}}{L_b}\\frac{1}{k_{if}}\\\\\nM_{fa}^*=\\frac{\\frac{3}{2}M_{af0}}{L_b}k_{uf}\\\\\nL_{d}^*=\\frac{L_d}{L_b}\\\\\nM_{aD}^*=\\frac{M_{aD0}}{L_b}\\frac{1}{k_{iD}}\\\\\nM_{Da}^*=\\frac{\\frac{3}{2}M_{aD0}}{L_b}k_{uD}\\\\\nL_f^*=\\frac{L_f}{L_b}\\frac{k_{uf}}{k_{if}}\\\\\nL_D^*=\\frac{L_D}{L_b}\\frac{k_{uD}}{k_{iD}}\\\\\nM_{fD}^*=\\frac{M_{fD}}{L_b}\\frac{k_{uf}}{k_{iD}}\\\\\nM_{Df}^*=\\frac{M_{Df}}{L_b}\\frac{k_{uD}}{k_{if}}\n$$\n\nè¦ä½¿ä»¥ä¸Šå„å¼ä¸­çš„äº’æ„Ÿç³»æ•°å¯é€†ï¼Œå³è¦æ±‚\n$$\nM_{af}^*=M_{fa}^*,M_{aD}^*=M_{Da}^*,M_{fD}^*=M_{Df}^*\n$$\næ˜¾ç„¶è¦ä»¤ä¸Šå¼æˆç«‹ï¼Œåˆ™å¿…é¡»åœ¨æ ‡å¹ºå€¼ç³»ç»Ÿä¸­é€‰å–åˆé€‚çš„è½¬å­ç”µæµåŸºå€¼å’Œç”µå‹åŸºå€¼ï¼Œå³ï¼š\n$$\nk_{uf}k_{if}=\\frac{2}{3},\nk_{uD}k_{iD}=\\frac{2}{3},\nk_{uQ}k_{iQ}=\\frac{2}{3}\n$$\nå› æ­¤ï¼Œè¦è·å¾—å¯é€†çš„äº’æ„Ÿç³»æ•°ï¼Œ**å®šã€è½¬å­å„ç»•ç»„çš„ç”µå‹åŸºå€¼æ¯”ä¸ç”µæµåŸºå€¼æ¯”çš„ä¹˜ç§¯éœ€ç­‰äº2/3**ã€‚\n\næ˜¾ç„¶è¿™ä¸ªæ¡ä»¶å¾ˆå®¹æ»¡è¶³ï¼Œè¿™è¯´æ˜åœ¨å®šå­å„é‡åŸºå€¼å·²ç»é€‰å®šå¹¶è¦æ±‚äº’æ„Ÿç³»æ•°å¯é€†çš„æ¡ä»¶ä¸‹ï¼Œè½¬å­æ–¹é¢çš„ç”µæµåŸºå€¼å’Œç”µå‹åŸºå€¼çš„é€‰å–æ–¹å¼ä»ç„¶å¾ˆå¤šï¼Œä½†$k_i$å’Œ$k_u$ä¸­åˆ™åªèƒ½è‡ªç”±é€‰å®šå…¶ä¸­ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªåˆ™ç”±2/3æ³•åˆ™ç¡®å®šã€‚\n\nå·¥ç¨‹ä¸Šå¸¸ç”¨$x_{ad}$åŸºå€¼ç³»ç»Ÿæ¥ç¡®å®šè½¬å­æ–¹é¢çš„å˜é‡åŸºå€¼ã€‚è¯¥ç³»ç»Ÿä¸­ï¼Œç”µæ¢dè½´ç»•ç»„è‡ªæ„Ÿä¸­å¯¹åº”ä¸»ç£åœºéƒ¨åˆ†ï¼ˆ$L_{ad}$ï¼‰çš„æ ‡å¹ºå€¼ã€ç”µæ¢dè½´ç»•ç»„ä¸åŠ±ç£ç»•ç»„äº’æ„Ÿç³»æ•°$M_{af}$çš„æ ‡å¹ºå€¼ä»¥åŠç”µæ¢dè½´ç»•ç»„ä¸ç›´è½´é˜»å°¼ç»•ç»„äº’æ„Ÿç³»æ•°$M_{aD}$çš„æ ‡å¹ºå€¼ç›¸ç­‰ï¼Œå³\n$$\nL_{ad}^*=M_{af}^*=M_{aD}^*\n$$\n\nå°†ç­‰å¼ä»£å…¥ï¼Œå¾ˆå®¹æ˜“å¾—åˆ°ï¼š\n$$\nL_{ad}I_b=M_{af0}I_{fb}\n$$\nå¯è§$x_{ad}$åŸºå€¼ç³»ç»Ÿä¸­åŠ±ç£ç”µæµåŸºå€¼é€‰å–çš„è§„åˆ™æ˜¯ï¼šåŠ±ç£ç”µæµåŸºå€¼æ‰€äº§ç”Ÿçš„é€šè¿‡æ°”éš™çš„ä¸»ç£åœºä¸ç”µæ¢dç»•ç»„çš„äº’æ„Ÿç£é“¾åº”ä¸ç”µæ¢dç»•ç»„é€šè¿‡åŸºå€¼å®šå­ç”µæµæ‰€äº§ç”Ÿçš„é€šè¿‡æ°”éš™çš„è‡ªæ„Ÿç£é“¾ç›¸ç­‰ã€‚\n\nåŠ±ç£ç”µæµåŸºå€¼$I_{fb}$ä¹Ÿå¯é€šè¿‡å®éªŒæ±‚å¾—ã€‚å°†ä¸Šå¼ä¸¤è¾¹åŒä¹˜ä»¥é¢å®šè§’é¢‘ç‡$\\omega_N$ï¼Œå¾—\n$$\n\\omega_N M_{af0} I_{fb}=\\omega_N L_{ad}I_b=x_{ad}I_{Nm}\n$$\nè¯¥å¼è¡¨æ˜åŸºå€¼åŠ±ç£ç”µæµåœ¨å®šå­å„ç›¸ç»•ç»„ä¸­å°†æ„Ÿç”Ÿå‡ºæœ‰åå€¼å¹…å€¼ä¸º$x_{ad}I_{Nm}$çš„ç©ºè½½ç”µåŠ¨åŠ¿ã€‚å› æ­¤ä»¥ä¸‹å®éªŒå¯ç¡®å®šåŠ±ç£ç”µæµåŸºå€¼ï¼šåŒæ­¥ç”µæœºä»¥é¢å®šåŒæ­¥è½¬é€Ÿæ—‹è½¬ï¼Œå®šå­å„ç»•ç»„å¼€è·¯ï¼ŒåŠ±ç£ç»•ç»„é€šä»¥ç”µæµï¼Œå„é¡¹ç»•ç»„ä¸­äº§ç”Ÿçš„åŸºæ³¢ç©ºè½½ï¼ˆä¸è®¡é¥±å’Œï¼‰ç”µå‹å¹…å€¼ä¸º$x_{ad}I_b=x_{ad}I_{Nm}$,æ­¤æ—¶çš„åŠ±ç£ç”µæµå€¼å³ä¸ºåŠ±ç£ç”µæµåŸºå€¼ã€‚\n\næŒ‰ç…§è¯¥ç§æ–¹æ³•é€‰å®šè½¬å­ç”µæµåŸºå€¼åï¼Œå¯ç¡®å®šè½¬å­ç”µå‹åŸºå€¼ã€‚åŸæ¥ä¸ç›¸ç­‰çš„ä¸€äº›ç”µæ„Ÿç³»æ•°è¿˜å¯ä»¥å˜ä¸ºç›¸ç­‰ï¼š\n$$\nL_{ad}^*=M_{af}^*=M_{fa}^*=M_{aD}^*=M_{Da}^*\\\\\nL_{aq}^*=M_{aQ}^*=M_{Qa}^*\\\\\nM_{fD}^*=M_{Df}^*=\\frac{M_{fD}}{L_b} \\times \\frac{2}{3}(\\frac{I_{fb}I_{Db}}{I_b^2})\\\\\nL_f^*=\\frac{L_f}{L_b} \\times \\frac{2}{3}(\\frac{I_{fb}}{I_b})^2\\\\\nL_D^*=\\frac{L_D}{L_b} \\times \\frac{2}{3}(\\frac{I_{Db}}{I_b})^2\\\\\nL_Q^*=\\frac{L_Q}{L_b} \\times \\frac{2}{3}(\\frac{I_{Qb}}{I_b})^2\n$$\n\nè½¬å­å˜é‡æ ‡å¹ºå€¼çš„æŠ˜ç®—ä¹Ÿå¯ä»¥ä½œä»¥ä¸‹ç†è§£ï¼Œå³å…ˆå°†è½¬å­æ–¹é¢çš„å‚æ•°æŠ˜åˆåˆ°å®šå­æ–¹é¢ï¼Œç„¶åå†é‡‡ç”¨å®šå­æ–¹é¢çš„åŸºå€¼æ±‚å…¶æ ‡å¹ºå€¼ï¼Œéå¸¸ç±»ä¼¼äºå˜å‹å™¨ä¸­é«˜ä½å‹ä¸¤ä¾§çš„æ ‡å¹ºå€¼æŠ˜ç®—æ–¹æ³•ã€‚å¦‚ï¼š\n$$\nL_f^*=\\frac{L_fk_{uf}}{L_bk_{if}}\n$$\nå¯ä»¥çœ‹ä½œæ˜¯åŠ±ç£ç»•ç»„è‡ªæ„Ÿ$L_f$ä¹˜ä»¥$k_{uf}/k_{if}$æŠ˜åˆåˆ°å®šå­æ–¹é¢ï¼Œå†é™¤ä»¥å®šå­ç”µæ„ŸåŸºå€¼$L_b$ã€‚\n\nåŠ±ç£ç»•ç»„ä¸ç›´è½´é˜»å°¼ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°æ ‡å¹ºå€¼$M_{Df}^*=M_{fD}^*$ï¼Œåœ¨ä¸è€ƒè™‘åªä¸å®ƒä»¬ä¸¤ä¸ªç»•ç»„å…±åŒäº¤é“¾çš„ä¸é€šè¿‡æ°”éš™çš„æ¼ç£é“¾æ—¶ï¼Œåˆ™æœ‰$M_{Df}^*=M_{fD}^*=L_{ad}^*$ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å·¥ç¨‹è®¡ç®—ä¸­éƒ½ä¼šä½œè¯¥ç®€åŒ–ï¼Œæ­¤æ—¶å¯¹ç”µæ¢ç”µæµè®¡ç®—å¸¦æ¥çš„è¯¯å·®å¯å¿½ç•¥ï¼Œå¯¹è½¬å­ç”µæµè®¡ç®—ä¼šå¸¦æ¥ä¸€å®šçš„è¯¯å·®ã€‚\n\nå°†$M_{Df}^*=M_{fD}^*=L_{ad}^*$ä»£å…¥ç£é“¾æ–¹ç¨‹å¼ä¸­ï¼Œå¹¶è€ƒè™‘ç”µæ„Ÿæ ‡å¹ºå€¼ä¸é¢å®šé¢‘ç‡ä¸‹ç›¸åº”ç”µæŠ—çš„æ ‡å¹ºå€¼åœ¨æ•°å€¼ä¸Šç›¸ç­‰ï¼Œå³$x^*=\\frac{\\omega_N L}{\\omega_b L_b}=L^*$ï¼Œå› æ­¤ç£é“¾æ–¹ç¨‹å¼å¯ä»¥æ”¹å†™ä¸ºï¼š\n$$\n\\begin{bmatrix}\n\\psi_d^* \\\\\n\\psi_f^* \\\\\n\\psi_D^*\n\\end{bmatrix}\n=\n\\begin{bmatrix}\nx_d^* & x_{ad}^* & x_{ad}^* \\\\\nx_{ad}^* & x_f^* & x_{ad}^* \\\\\nx_{ad}^* & x_{ad}^* & x_D^*\n\\end{bmatrix}\n\\begin{bmatrix}\ni_d^* \\\\\ni_f^* \\\\\ni_D^*\n\\end{bmatrix}\n$$\nåŒç†æœ‰\n$$\n\\begin{bmatrix}\n\\psi_q^* \\\\\n\\psi_Q^* \n\\end{bmatrix}\n=\n\\begin{bmatrix}\nx_q^* & x_{aq}^*  \\\\\nx_{aq}^* & x_Q^*  \\\\\n\\end{bmatrix}\n\\begin{bmatrix}\ni_q^* \\\\\ni_Q^*\n\\end{bmatrix}\n$$\nå…¶ä¸­\n$$\n\\begin{aligned}\nx_d^* &= x_l^* + x_{ad}^* \\\\\nx_q^* &= x_l^* + x_{aq}^* \\\\\nx_f^* &= x_{fl}^* + x_{ad}^* \\\\\nx_D^* &= x_{Dl}^* + x_{ad}^* \\\\\nx_Q^* &= x_{Ql}^* + x_{aq}^*\n\\end{aligned}\n$$\nåŠ±ç£ç»•ç»„ç”µå‹åŸºå€¼å¯ç”±ä»¥ä¸‹æ–¹å¼ç¡®å®šã€‚\n\nå› ä¸º\n$$\nk_{uf}k_{if}=\\frac{U_b}{U_{fb}}\\times \\frac{I_b}{I_{fb}}=\\frac{2}{3}\n$$\næ•…\n$$\nU_{fb}=\\frac{3}{2}\\times\\frac{I_b}{I_{fb}}U_b\n$$\n\nåŠ±ç£ç»•ç»„é˜»æŠ—åŸºå€¼çš„å–æ³•ä¸ç”µæ¢é˜»æŠ—ç›¸ä¼¼ï¼Œä¸ºåŠ±ç£ç»•ç»„ç”µå‹ã€ç”µæµåŸºå€¼çš„æ¯”ï¼Œå³\n$$\nZ_{fb}=\\frac{U_{fb}}{I_{fb}}=\\frac{3}{2}(\\frac{I_b}{I_{fb}})^2Z_b\n$$\nåŒæ ·æ–¹æ³•å¯æ±‚å‡ºç›´è½´ã€äº¤è½´é˜»å°¼ç»•ç»„çš„ç”µå‹åŸºå€¼å’Œé˜»æŠ—åŸºå€¼ã€‚\n### äº¤æµç”µæœºåŸºæœ¬æ–¹ç¨‹å¼çš„æ ‡å¹ºå€¼å½¢å¼\nç°åœ¨ï¼Œå°±å¯ä»¥æŠŠåŸæœ‰çš„dqåæ ‡ç³»ä¸‹çš„äº¤æµç”µæœºåŸºæœ¬æ–¹ç¨‹å¼æ”¹å†™ä¸ºåŸºäº$x_{ad}$åŸºå€¼ç³»ç»Ÿçš„æ ‡å¹ºå€¼å½¢å¼ã€‚\n\nå®šã€è½¬å­ç”µå‹æ–¹ç¨‹æ ‡å¹ºå€¼çš„å½¢å¼ä¸æœ‰åå€¼å½¢å¼ä¸‹çš„ç›¸åŒï¼Œå³\n$$\n\\begin{bmatrix}\nu_d^* \\\\\nu_q^* \\\\\nu_0^* \\\\\nu_f^* \\\\\nu_D^* \\\\\nu_Q^*\n\\end{bmatrix}\n=p\n\\begin{bmatrix}\n\\psi_d^* \\\\\n\\psi_q^* \\\\\n\\psi_0^* \\\\\n\\psi_f^* \\\\\n\\psi_D^* \\\\\n\\psi_Q^*\n\\end{bmatrix}\n+\n\\begin{bmatrix}\nr_a^* & 0 & 0 & 0 & 0 & 0 \\\\\n0 & r_a^* & 0 & 0 & 0 & 0 \\\\\n0 & 0 & r_a^* & 0 & 0 & 0 \\\\\n0 & 0 & 0 & r_f^* & 0 & 0 \\\\\n0 & 0 & 0 & 0 & r_D^* & 0 \\\\\n0 & 0 & 0 & 0 & 0 & r_Q^*\n\\end{bmatrix}\n\\begin{bmatrix}\ni_d^* \\\\\ni_q^* \\\\\ni_0^* \\\\\ni_f^* \\\\\ni_D^* \\\\\ni_Q^*\n\\end{bmatrix}\n+\n\\begin{bmatrix}\n-\\omega^* \\psi_q^* \\\\\n\\omega^* \\psi_d^* \\\\\n0 \\\\\n0 \\\\\n0 \\\\\n0\n\\end{bmatrix}\n$$\nå°†ç£é“¾æ–¹ç¨‹å¼ä»£å…¥ï¼Œæ•´ç†å¯å¾—\n$$\nU^*=L^*pI^*+\\omega^*G^*I^*+R^*I^*\n$$\nå¼ä¸­\n$$\nU^*=[U_{dq0}^* \\quad U_{fDQ}^*]^T\\\\\n$$\n$$\nI^*=[I_{dq0}^* \\quad I_{fDQ}^*]^T\n$$\n$$\nR^*=\n\\begin{bmatrix}\nR_{abc}^* & 0\\\\\n0 & R_{fDQ}^*\n\\end{bmatrix}\n$$\n$$\n\\begin{array}{c}\nL^{*}=\\left[\\begin{array}{cccccc}\nx_{\\mathrm{d}}^* & 0 & 0 & x_{\\mathrm{ad}}^{*} & x_{\\mathrm{ad}}^{*} & 0 \\\\\n0 & x_{\\mathrm{q}}^{*} & 0 & 0 & 0 & x_{a q}^{*} \\\\\n0 & 0 & x_{0}^{*} & 0 & 0 & 0 \\\\\nx_{\\mathrm{ad}}^{*} & 0 & 0 & x_{\\mathrm{f}}^{*} & x_{a d}^{*} & 0 \\\\\nx_{a d}^{*} & 0 & 0 & x_{ad}^{*} & x_{\\mathrm{D}}^{*} & 0 \\\\\n0 & x_{\\mathrm{aq}}^{*} & 0 & 0 & 0 & x_{\\mathrm{Q}}^{*}\n\\end{array}\\right] \n\n\\\\\n\nG^{*}=\\left[\\begin{array}{cccccc}\n0 & -x_{\\mathrm{q}}^{*} & 0 & 0 & 0 & -x_{a q}^{*} \\\\\nx_{d}^{*} & 0 & 0 & x_{\\mathrm{ad}}^{*} & x_{\\mathrm{ad}}^{*} & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & 0\n\\end{array}\\right]\n\\end{array}\n$$\n\nä»¥ä¸Š$G^*$ä¸ºç”µå‹æ–¹ç¨‹ä¸­è§’é€Ÿåº¦$\\omega^*$é¡¹çš„ç³»æ•°çŸ©é˜µï¼Œåæ˜ äº†æ—‹è½¬ç”µåŠ¨åŠ¿çš„é¡¹çš„ç³»æ•°å¤§å°ï¼Œä»…åœ¨ç”µæ¢ç”µå‹ã€$u_d^*$ã€$u_q^*$å¯¹åº”çš„è¡Œé‡Œæœ‰å…ƒç´ ã€‚\n\nå¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡çº¿æ€§å˜æ¢åï¼ŒåŸæ¥å®šå­ç»•ç»„aã€bã€cä¸‰ç›¸çš„å„å˜é‡å·²è¢«æ–°çš„dã€qã€0åæ ‡ç³»ç»Ÿä¸­å„å˜é‡æ‰€å–ä»£ã€‚aã€bã€cä¸‰ç›¸ç»•ç»„æ˜¯å®é™…å­˜åœ¨çš„ä¸‰ä¸ªå›è·¯ï¼Œå…¶ç»•ç»„è½´çº¿ä¸ºé™æ­¢çš„ï¼Œä¸”åœ¨ç©ºé—´ä¸Šäº’å·®$2\\pi/3$ç”µå¼§åº¦ã€‚å˜æ¢åçš„dã€qã€0åæ ‡ç³»ç»Ÿä¸­å„å˜é‡æ˜¯dã€qã€0ä¸‰ä¸ªç»•ç»„å›è·¯çš„å˜é‡ï¼Œå…¶ä¸­dã€qç»•ç»„çš„è½´çº¿ä¸è½¬å­ä¸€é“æ—‹è½¬ï¼Œä¸”dè½´ä¸è½¬å­ç›´è½´è½´çº¿(åŠ±ç£ç»•ç»„è½´çº¿)ç›¸é‡åˆï¼Œdã€qè½´åœ¨ç©ºé—´ä¸Šç›¸å·®$\\pi/2$ç”µå¼§åº¦ã€‚é›¶è½´ç»•ç»„åœ¨ç”µæ–¹é¢æ˜¯ç‹¬ç«‹çš„ï¼Œä¸å…¶ä»–ç»•ç»„æ— ç”µç£è€¦åˆå…³ç³»ã€‚\n\nä»è¿™ä»¥åï¼Œåœ¨ä¸€èˆ¬ä¸åŠ è¯´æ˜çš„æƒ…å†µä¸‹ï¼Œç”µæœºå„é‡å‡é‡‡ç”¨æ ‡ä¹ˆå€¼ï¼Œå¹¶å°†è¡¨ç¤ºæ ‡ä¹ˆå€¼çš„â€œ * â€ç¬¦å·çœå»ã€‚","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºæ–¹ç¨‹å¼ï¼ˆdq0åæ ‡ç³»ï¼‰","url":"/2024/07/14/ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºæ–¹ç¨‹å¼ï¼ˆdq0åæ ‡ç³»ï¼‰/","content":"### æ¦‚è¿°\nä¸Šä¸€ç¯‡æ–‡ç« å¯¹ä¸‰ç›¸å‡¸çº§åŒæ­¥ç”µæœºåœ¨aã€bã€cåæ ‡ç³»ä¸‹çš„ç”µå‹æ–¹ç¨‹å¼å’Œç£é“¾æ–¹ç¨‹å¼ï¼Œå¹¶ä¸”ç»™å‡ºäº†å®šå­å’Œè½¬å­ç»•ç»„ä¹‹é—´çš„ç”µæ„Ÿç³»æ•°ã€‚åœ¨éœ€è¦è€ƒè™‘æ°”éš™è°æ³¢ç£åœºæ—¶ï¼Œå®šå­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°ã€äº’æ„Ÿç³»æ•°ï¼Œä»¥åŠå®šå­ç»•ç»„å’Œè½¬å­ç»•ç»„ä¹‹é—´çš„äº’æ„Ÿç³»æ•°å‡æ˜¯å…³äºè½¬å­ä½ç½®è§’$\\theta$çš„æ— ç©·çº§æ•°ã€‚è™½ç„¶å·¥ç¨‹ä¸­å¯ä»¥å¿½ç•¥é«˜æ¬¡é¡¹è¿›è¡Œè¿‘ä¼¼è®¡ç®—ï¼Œä½†è®¡ç®—è¿‡ç¨‹ä»æ˜¯éå¸¸å¤æ‚çš„ã€‚\n\nåœ¨ä»…è€ƒè™‘æ°”éš™ç£åœºåŸºæ³¢æˆåˆ†çš„å‰æä¸‹ï¼Œé€šè¿‡Parkå˜æ¢ï¼Œç”¨dq0åæ ‡ç³»ä¸‹çš„æ–°å˜é‡æ›¿ä»£åŸabcç›¸åæ ‡ç³»ä¸‹çš„å˜é‡ï¼Œå¯ä½¿å®šå­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°å’Œäº’æ„Ÿç³»æ•°åˆæ—¶å˜ç³»æ•°å˜ä¸ºå¸¸ç³»æ•°ã€‚\n\n### äº¤æµç”µæœºåœ¨dq0åæ ‡ç³»ä¸­çš„ç”µå‹æ–¹ç¨‹å¼å’Œç£é“¾æ–¹ç¨‹å¼\n#### ç›¸åæ ‡ç³»è‡³dq0åæ ‡ç³»çš„å˜æ¢\nç”±çº¿æ€§ä»£æ•°çŸ¥è¯†ï¼Œå½“æ»¡ç§©çº¿æ€§å˜æ¢æ—¶ï¼Œæ–°å˜é‡ä¸åŸå˜é‡é—´å…·æœ‰å•å€¼çš„å¯¹åº”å…³ç³»ã€‚æ­¤æ—¶ï¼Œå˜æ¢çŸ©é˜µCï¼ˆä¸­é—´é‡ï¼‰åº”ä¸ºæ»¡ç§©ã€‚\n\n**æ»¡ç§©çŸ©é˜µçš„å……åˆ†å¿…è¦æ¡ä»¶æ˜¯å…¶è¡Œåˆ—å¼çš„å€¼ä¸ä¸º0ã€‚**\n\nåœ¨æ­¤å˜æ¢ä¸‹ï¼Œçº¿æ€§å˜æ¢å’Œçº¿æ€§åå˜æ¢å¼å¯å†™ä¸ºï¼š\n$$\nY = CX \\\\\nX = C^{-1}Y\n$$\nå…¶ä¸­$C^{-1}$æ˜¯$C$çš„é€†çŸ©é˜µã€‚\n\nç”µæœºå·¥ç¨‹ä¸­æœ€å¸¸ç”¨çš„åæ ‡ç³»å³ä¸ºdq0åæ ‡ç³»ï¼Œå³å°†åŸæ¥é™æ­¢çš„å®šå­ç»•ç»„aã€bã€cç»•ç»„å˜æ¢è‡³ä¸è½¬å­åŒè§’é€Ÿåº¦æ—‹è½¬çš„dã€qè½´çº¿åŠç‹¬ç«‹çš„é›¶è½´çº¿ä»£æ›¿ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![ç”µæœºç»•ç»„è½´çº¿ä½ç½®](/images/1.2/raozuzhouxian.png)\n\næ˜¾ç„¶åœ¨ä½¿ç”¨dq0åæ ‡ç³»æ—¶ï¼Œç”±äºdã€qè½´éšç€è½¬å­æ—‹è½¬è€Œä¸è½¬å­è½´çº¿å‘ˆç›¸å¯¹é™æ­¢ï¼Œç”µæ¢ç»•ç»„çš„è‡ªæ„Ÿå’Œäº’æ„Ÿç³»æ•°å˜ä¸ºå¸¸æ•°ã€‚é›¶è½´ç»•ç»„åœ¨ç”µç£æ–¹é¢ä¸ºç‹¬ç«‹è½´ï¼Œä¸å…¶ä»–ç»•ç»„æ— è€¦åˆå…³ç³»ã€‚\n\nä»¥ç”µæ¢ç”µæµä¸ºä¾‹ï¼Œå˜æ¢åçš„æ–°å˜é‡$i_d$ï¼Œ$i_q$ï¼Œ$i_0$ä¸åŸå˜é‡$i_a$ï¼Œ$i_b$ï¼Œ$i_c$å…³ç³»ä¸ºï¼š\n$$\n\\left[\\begin{array}{l}\ni_{d} \\\\\ni_{q} \\\\\ni_{0}\n\\end{array}\\right]=\\frac{2}{3}\\left[\\begin{array}{ccc}\n\\cos \\theta & \\cos \\left(\\theta-\\frac{2 \\pi}{3}\\right) & \\cos \\left(\\theta+\\frac{2 \\pi}{3}\\right) \\\\\n-\\sin \\theta & -\\sin \\left(\\theta-\\frac{2 \\pi}{3}\\right) & -\\sin \\left(\\theta+\\frac{2 \\pi}{3}\\right) \\\\\n\\frac{1}{2} & \\frac{1}{2} & \\frac{1}{2}\n\\end{array}\\right]\\left[\\begin{array}{l}\ni_{a} \\\\\ni_{b} \\\\\ni_{c}\n\\end{array}\\right]\n$$\nå¼ä¸­ç¬¬ä¸‰ä¸ªæ–°å˜é‡$i_0$ä¸$i_a$ï¼Œ$i_b$ï¼Œ$i_c$çš„å…³ç³»ä¸º\n$$\ni_0 = \\frac{1}{3}(i_a+i_b+i_c)\n$$\n$i_0$è¢«ç§°ä¸ºå®šå­ç»•ç»„ç”µæµçš„é›¶è½´åˆ†é‡ï¼Œä¸ºç¬æ—¶å€¼ã€‚\n\næ˜¾ç„¶$i_0$ä¸ç”µæœºå„é¡¹ç»•ç»„è¿æ¥æ–¹å¼æœ‰å…³ï¼š\n- æœ‰ä¸­çº¿è¿æ¥æ—¶ï¼Œ$i_0$å®é™…ä¸ºç”µæœºä¸­çº¿ç”µæµçš„1/3\n- æ— ä¸­çº¿è¿æ¥æ—¶ã€‚$i_0$ä¸ºé›¶\n\nåç»­åˆ†æåŒæ­¥ç”µæœºåŠå…¶ç³»ç»Ÿæ—¶ï¼Œè‹¥å°†ç”µæµåˆ†é‡å˜æ¢è‡³dq0åæ ‡ç³»ï¼Œä¸”åŸç›¸åæ ‡ç³»ä¸­çš„ç”µå‹ã€ç£é“¾ç­‰é‡ä¹Ÿè¦åŒæ­¥å˜æ¢è‡³dq0åæ ‡ç³»ï¼Œå…¶å˜æ¢çŸ©é˜µ$C$ä¸ç”µæµå˜é‡çš„å˜æ¢çŸ©é˜µç›¸åŒã€‚\n\n#### ç£é“¾æ–¹ç¨‹å¼ï¼ˆdq0åæ ‡ç³»ï¼‰\nå°†ç›¸åæ ‡ç³»ä¸­çš„ç£é“¾æ–¹ç¨‹å¼è½¬åŒ–ä¸ºdq0åæ ‡ç³»ä¸­çš„ç£é“¾æ–¹ç¨‹å¼ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š\n$$\n\\left[\\begin{array}{l}\n\\Psi_{dq0} \\\\\n\\Psi_{fDQ} \n\\end{array}\\right]=\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{l}\n\\Psi_{abc} \\\\\n\\Psi_{fDQ} \n\\end{array}\\right]=\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{cc}\nL_{ss} & L_{sr} \\\\\nL_{rs} & L_{rr}\n\\end{array}\\right]\\left[\\begin{array}{l}\nI_{abc} \\\\\nI_{fDQ}\n\\end{array}\\right]\n$$\nå¼ä¸­ï¼Œ$\\Psi_{dq0}$ä¸ºç”µæœºç”µæ¢dã€qã€0ä¸‰è½´ç»•ç»„çš„ç£é“¾çŸ©é˜µè¡¨è¾¾å¼ï¼Œ$\\Psi_{dq0}=[\\phi_d \\quad \\phi_q \\quad \\phi_0]^{T}$ï¼›$\\Psi_{fDQ}$ä¸ºç”µæœºç”µæ¢fã€Dã€Qä¸‰è½´ç»•ç»„çš„ç£é“¾çŸ©é˜µè¡¨è¾¾å¼ï¼Œ$\\Psi_{fDQ}=[\\phi_f \\quad \\phi_D \\quad \\phi_Q]^{T}$ï¼Œ$E$ä¸ºå•ä½çŸ©é˜µã€‚\n\nè”ç«‹ä¸Šè¿°å„å¼ï¼Œå¯å¾—è®¡ç®—åçš„ç»“æœä¸ºï¼š\n$$\n\\left[\\begin{array}{l}\n\\psi_{d} \\\\\n\\psi_{q} \\\\\n\\psi_{0} \\\\\n\\psi_{f} \\\\\n\\psi_{D} \\\\\n\\psi_{Q}\n\\end{array}\\right]=\\left[\\begin{array}{cccccc}\nL_d & 0 & 0 & M_{af0} & M_{aD0} & 0\\\\\n0 & L_q & 0 & 0 & 0 & M_{aQ0}\\\\\n0 & 0 & L_0 & 0 & 0 & 0\\\\\n\\frac{3}{2}M_{af0} & 0 & 0 & L_f & M_{fD} & 0\\\\\n\\frac{3}{2}M_{aD0} & 0 & 0 & M_{Df} & L_{D} & 0\\\\\n0 & \\frac{3}{2}M_{aQ0} & 0 & 0 & 0 & L_Q\n\\end{array}\\right]\\left[\\begin{array}{l}\ni_{d} \\\\\ni_{q} \\\\\ni_{0} \\\\\ni_{f} \\\\\ni_{D} \\\\\ni_{Q}\n\\end{array}\\right]\n$$\nå…¶ä¸­\n$$\nL_d = L_{aal}+M_{abl}+\\frac{3}{2}L_{mad}=L_{leak} + L_{ad} \\\\\nL_q = L_{aal}+M_{abl}+\\frac{3}{2}L_{maq}=L_{leak} + L_{aq} \\\\\nL_0 = L_{aal} - 2M_{abl}\n$$\nå¼ä¸­ï¼Œ$L_{aal}$ä¸ºç”µæ¢aç›¸ç»•ç»„è‡ªæ¼æ„Ÿç³»æ•°($l$æ„ä¸º$leak$)ï¼Œ$M_{abl}$ä¸ºç”µæ¢aç›¸å’Œbç›¸ç»•ç»„ä¹‹é—´çš„äº’æ¼æ„Ÿç³»æ•°ï¼Œ$L_{aad}$ä¸ºç”µæ¢aç›¸ç»•ç»„è‡ªæ„Ÿç³»æ•°åœ¨dè½´ä¸Šçš„åˆ†é‡ï¼Œ$L_{aaq}$ä¸ºç”µæ¢aç›¸ç»•ç»„è‡ªæ„Ÿç³»æ•°åœ¨qè½´ä¸Šçš„åˆ†é‡ã€‚$M_{af0}$ä¸ºå®šå­aè½´ä¸åŠ±ç£ç»•ç»„dè½´é‡åˆæ—¶æ‰€å…·æœ‰çš„æœ€å¤§äº’æ„Ÿç³»æ•°ï¼Œ$M_{aD0}$ä¸ºå®šå­aè½´ä¸é˜»å°¼ç»•ç»„Dè½´é‡åˆæ—¶æ‰€å…·æœ‰çš„æœ€å¤§äº’æ„Ÿç³»æ•°ï¼Œ$M_{aQ0}$ä¸ºå®šå­aè½´ä¸é˜»å°¼ç»•ç»„Qè½´é‡åˆæ—¶æ‰€å…·æœ‰çš„æœ€å¤§äº’æ„Ÿç³»æ•°ï¼Œä¸‹æ ‡ä¸­çš„â€œ0â€è¡¨ç¤ºè¯¥äº’æ„Ÿç³»æ•°è®¡ç®—æ—¶ä»…è€ƒè™‘äº†åŸºæ³¢åˆ†é‡ã€‚\n\nç”±ä¸Šå¼å¯çœ‹å‡ºï¼š\n\n- $L_d$å’Œ$L_q$åˆ†åˆ«æ˜¯å‡æƒ³çš„ç”µæ¢dè½´ç»•ç»„å’Œç”µæ¢qè½´ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°ã€‚å®ƒåŒ…æ‹¬ä¸é€šè¿‡æ°”éš™çš„æ¼ç£é“¾æ‰€å¯¹åº”çš„è‡ªæ¼æ„Ÿç³»æ•°$L_{leak}=L_{aal}+M_{abl}$ä»¥åŠé€šè¿‡æ°”éš™çš„ä¸»ç£åœºæ‰€å¯¹åº”çš„ç”µæ„Ÿç³»æ•°$L_{ad}=\\frac{3}{2}L_{aad}$ä»¥åŠ$L_{aq}=\\frac{3}{2}L_{aaq}$ã€‚\n\n- $L_0$æ˜¯å˜æ¢åå‡æƒ³çš„ç”µæ¢é›¶è½´ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°ï¼Œå…¶ä»…ç”±æ¼æ„Ÿç³»æ•°ç»„æˆã€‚\n\n- ç”µæ¢ç»•ç»„ä»abcç›¸ç»•ç»„è½´çº¿è½¬æ¢ä¸ºä¸è½¬å­åŒé€Ÿæ—‹è½¬çš„dã€qè½´ä»¥åŠç‹¬ç«‹çš„é›¶è½´åï¼Œç”µæ¢ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°åŠäº’æ„Ÿç³»æ•°å‡ç”±æ—¶å˜ç³»æ•°å˜ä¸ºä¸$\\theta$è§’æ— å…³çš„å¸¸æ•°ã€‚\n\n- åæ ‡å˜æ¢ä½¿å…·æœ‰ç›¸äº’ç”µç£è€¦åˆçš„abcç›¸ç»•ç»„å˜ä¸ºæ²¡æœ‰è€¦åˆå…³ç³»çš„å‡æƒ³çš„ç”µæ¢dè½´ã€qè½´ç»•ç»„ï¼Œè¾¾åˆ°äº†è§£è€¦çš„ç›®çš„ã€‚å¯¹äºç”µæœºæ§åˆ¶ç³»ç»Ÿï¼Œè¯¥æ“ä½œå¯è·å¾—æ›´è‰¯å¥½çš„æ§åˆ¶æ€§èƒ½ã€‚\n\n#### ç”µå‹æ–¹ç¨‹å¼ï¼ˆdq0åæ ‡ç³»ï¼‰\ndq0åæ ‡ç³»ä¸­çš„ç”µå‹æ–¹ç¨‹å¼å¯é‡‡ç”¨åŒæ ·çš„æ–¹å¼ä»ç›¸åæ ‡ç³»ç»Ÿä¸‹çš„ç”µå‹æ–¹ç¨‹å¼è½¬æ¢è€Œæ¥ï¼Œå³\n$$\n\\left[\\begin{array}{l}\nU_{dq0} \\\\\nU_{fDQ} \n\\end{array}\\right]=\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{l}\nU_{abc} \\\\\nU_{fDQ} \n\\end{array}\\right]=\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{l}\np\\Psi_{abc} \\\\\np\\Psi_{fDQ}\n\\end{array}\\right]+\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{cc}\nR_{abc} & 0 \\\\\n0 & R_{fDQ} \n\\end{array}\\right]\\left[\\begin{array}{l}\nI_{abc} \\\\\nI_{fDQ} \n\\end{array}\\right]\n$$\n\nå¼ä¸­ï¼Œ$U_{dq0}$ä¸ºç”µæ¢dã€qã€0ç»•ç»„è½´ç«¯çš„ç”µå‹çŸ©é˜µï¼Œ$U_{dq0}=[u_d \\quad u_q \\quad u_0]^{T}$ã€‚\n\nä¸Šå¼ä¸­ç­‰å¼å³ä¾§çš„ç¬¬ä¸€é¡¹ï¼š\n$$\n\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{l}\np\\Psi_{abc} \\\\\np\\Psi_{fDQ}\n\\end{array}\\right]=\\left[\\begin{array}{cc}\nC & (p \\quad \\Psi_{abc}) \\\\\np & \\Psi_{fDQ}\n\\end{array}\\right]\n$$\næ ¹æ®ç£é“¾çš„Parkå˜æ¢ï¼š\n$$\n\\Psi_{dq0} = C \\Psi_{abc}\n$$\næ•…æœ‰\n$$\np \\Psi_{dq0} = (pC)\\Psi_{abc}+C(p \\quad \\Psi_{abc})\n$$\nå¯å¾—\n$$\nC(p \\quad \\Psi_{abc}) = p\\Psi_{dq0} - (pC)\\Psi_{abc}\n$$\nå¯ä»¥è¯æ˜å…¶ä¸­\n$$\n-(pC)\\Psi_{abc} = -{pC}C^{-1}\\Psi_{dq0}=\\omega \\left[\\begin{array}{ccc}\n0 & -1 & 0 \\\\\n1 & 0 & 0 \\\\\n0 & 0 &0\n\\end{array}\\right]\\left[\\begin{array}{l}\n\\phi_d\\\\\n\\phi_q\\\\\n\\phi_0\n\\end{array}\\right]=\\left[\\begin{array}{c}\n-\\omega\\psi_q\\\\\n\\omega\\psi_d\\\\\n0\n\\end{array}\\right]\n$$\nå¼ä¸­$\\omega$ä¸ºè½¬å­çš„ç¬æ—¶è½¬é€Ÿï¼Œ$\\omega = p \\theta$ã€‚\n\nè½¬æ¢å¼ç­‰å¼å³ä¾§çš„ç¬¬äºŒé¡¹ï¼ˆå³ç”µé˜»å‹é™ï¼‰å¯ä»¥å†™æˆï¼š\n$$\n\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{cc}\nR_{abc} & 0 \\\\\n0 & R_{fDQ} \n\\end{array}\\right]\\left[\\begin{array}{c}\nI_{abc} \\\\\nI_{fDQ} \n\\end{array}\\right]=\n\\left[\\begin{array}{cc}\nC & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{cc}\nR_{abc} & 0 \\\\\n0 & R_{fDQ} \n\\end{array}\\right]\\left[\\begin{array}{cc}\nC^{-1} & 0 \\\\\n0 & E \n\\end{array}\\right]\\left[\\begin{array}{c}\nI_{dq0} \\\\\nI_{fDQ} \n\\end{array}\\right]\n=\n\\left[\\begin{array}{cc}\nR_{abc} & 0 \\\\\n0 & R_{fDQ} \n\\end{array}\\right]\\left[\\begin{array}{c}\nI_{dq0} \\\\\nI_{fDQ} \n\\end{array}\\right]\n$$\nè”ç«‹ä¸Šè¿°å„å¼ï¼Œå¯å¯¼å‡ºdq0åæ ‡ç³»ç»Ÿä¸‹çš„ç”µå‹æ–¹ç¨‹å¼ï¼š\n$$\n\\begin{bmatrix}\nu_d \\\\\nu_q \\\\\nu_0 \\\\\nu_f \\\\\nu_D \\\\\nu_Q\n\\end{bmatrix}\n=p\n\\begin{bmatrix}\n\\psi_d \\\\\n\\psi_q \\\\\n\\psi_0 \\\\\n\\psi_f \\\\\n\\psi_D \\\\\n\\psi_Q\n\\end{bmatrix}\n+\n\\begin{bmatrix}\nr_a & 0 & 0 & 0 & 0 & 0 \\\\\n0 & r_a & 0 & 0 & 0 & 0 \\\\\n0 & 0 & r_a & 0 & 0 & 0 \\\\\n0 & 0 & 0 & r_f & 0 & 0 \\\\\n0 & 0 & 0 & 0 & r_D & 0 \\\\\n0 & 0 & 0 & 0 & 0 & r_Q\n\\end{bmatrix}\n\\begin{bmatrix}\ni_d \\\\\ni_q \\\\\ni_0 \\\\\ni_f \\\\\ni_D \\\\\ni_Q\n\\end{bmatrix}\n+\n\\begin{bmatrix}\n-\\omega \\psi_q \\\\\n\\omega \\psi_d \\\\\n0 \\\\\n0 \\\\\n0 \\\\\n0\n\\end{bmatrix}\n$$\n\næ ¹æ®ä¸Šå¼ï¼Œæ˜¾ç„¶å‡æƒ³çš„ç”µæ¢dã€qè½´ç»•ç»„çš„ç”µå‹æ–¹ç¨‹ä¸­ï¼Œä¸aã€bã€cç»•ç»„çš„â€œé™æ­¢ç»•ç»„â€ç›¸æ¯”ï¼Œé™¤$p\\psi$ä»…è¡¨ç¤ºå˜å‹å™¨ç”µåŠ¨åŠ¿å¤–ï¼Œå¦æœ‰æ­£æ¯”äºè§’é€Ÿåº¦çš„è¿åŠ¨ç”µåŠ¨åŠ¿$\\omega\\psi$é¡¹å­˜åœ¨ã€‚\n\nåœ¨dq0åæ ‡ç³»ç»Ÿä¸­ï¼Œå› é‡æ–°é€‰å–äº†ç”µæ¢ç»•ç»„çš„è½´çº¿ï¼Œä½¿å¾—dã€qè½´çº¿ä»¥$\\omega$è½¬é€Ÿæ—‹è½¬ï¼Œè€Œæ„æˆdã€qç»•ç»„çš„çº¿åœˆå…ƒä»¶ä»ä¸ºé™æ­¢ï¼Œå› è€Œçº¿åœˆå…ƒä»¶ä¸ç£é“¾ä¹‹é—´å­˜åœ¨ç›¸å¯¹è¿åŠ¨ï¼Œäº§ç”Ÿäº†è¿åŠ¨ç”µåŠ¨åŠ¿$\\omega\\psi$ã€‚è¿™ç§ç»•ç»„è½´çº¿ä¸æ„æˆè¯¥ç»•ç»„çš„çº¿åœˆå…ƒä»¶é—´å­˜åœ¨ç›¸å¯¹è¿åŠ¨çš„ç»•ç»„ç§°ä¸ºâ€œä¼ªé™æ­¢ç»•ç»„â€ã€‚\n\n#### åŒæ­¥ç”µæœºçš„æ´¾å…‹ï¼ˆParkï¼‰æ–¹ç¨‹\n\næ´¾å…‹å˜æ¢(Park Transform)å®é™…æ˜¯ä»¥å…‹æ‹‰å…‹å˜æ¢(Clark Transformï¼Œé™æ­¢dqåæ ‡ç³»å˜æ¢)æ¨å¹¿è€Œæ¥ã€‚æ’å®šå¹…å€¼æ¡ä»¶ä¸‹çš„Clarkçº¿æ€§å˜æ¢çŸ©é˜µå³ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![æ’å®šå¹…å€¼Clarkå˜æ¢çŸ©é˜µ](/images/1.2/park1.png)\n\nå¼ä¸­ï¼ŒçŸ©é˜µå‰çš„å¸¸ç³»æ•°$\\frac{2}{3}$ç”¨äºä¿è¯åœ¨å˜æ¢åï¼Œå˜é‡çš„å¹…å€¼ä»ä¿æŒä¸å˜ã€‚\n\nè‹¥éœ€è¦è¿›è¡Œæ’åŠŸç‡Clarkå˜æ¢ï¼Œå˜æ¢çŸ©é˜µå¯è¢«æ›¿æ¢ä¸ºï¼š\n\n![æ’å®šåŠŸç‡Clarkå˜æ¢çŸ©é˜µ](/images/1.2/park2.png)\n\nå½“Clarkå˜æ¢è¢«æ¨å¹¿è‡³æ—‹è½¬dqåæ ‡ç³»ï¼ˆå³åŒ…å«è½¬å­ä½ç½®è§’$\\theta$ä½œä¸ºå˜é‡ï¼‰æ—¶ï¼Œç»“åˆä¸‰è§’æ’ç­‰å˜æ¢ï¼Œå¯å¯¼å‡ºParkå˜æ¢æ–¹ç¨‹ã€‚ç›¸å…³æ¨å¯¼å‚è§[ã€ŠClarkå˜æ¢ä¸Parkå˜æ¢çš„æ¨å¯¼ã€‹](https://blog.csdn.net/weixin_44462280/article/details/110290942)ã€‚\n\nParkæ–¹ç¨‹ä¸ºå®šå¸¸ç³»æ•°å¾®åˆ†æ–¹ç¨‹ï¼Œåœ¨åŒæ­¥ç”µæœºåˆ†æä¸­ä½¿ç”¨è¯¥æ–¹ç¨‹å¯ä»¥é€šè¿‡è§£ææ–¹æ³•æ±‚è§£**æ’é€Ÿ**è¿è½¬æ—¶ç”µæœºçš„ç¬æ€å’Œç¨³æ€è¿è¡Œé—®é¢˜ã€‚\n\nä¸Šè¿°æ–¹ç¨‹ä¸­å„å˜é‡éƒ½æ˜¯æœ‰åå€¼,ç”¨æœ‰åå€¼çš„å¥½å¤„æ˜¯ç‰©ç†å¿µæ˜ç¡®,å•ä½çš„é‡çº²æ¸…æ¥š,ä½†åœ¨å®é™…è®¡ç®—ä¸­å¾€å¾€æœ‰æ‰€ä¸ä¾¿,å› æ­¤ï¼Œåˆ†æè®¡ç®—ç”µæœºçš„è®¸å¤šé—®é¢˜æ—¶ï¼Œç»å¸¸é‡‡ç”¨æ ‡ä¹ˆå€¼ã€‚\n\n### dq0åæ ‡ç³»ç»Ÿä¸åŒååº”ç†è®º\nç”µæœºå­¦ä¸­å·²ç»ä»‹ç»è¿‡ï¼ŒåŒååº”ç†è®ºæ˜¯ç”±Andre Blondelæå‡ºçš„ä¸€ç§è§£é‡ŠåŒæ­¥ç”µæœºå†…éƒ¨ç£åœºåˆ†å¸ƒçš„æ–¹æ³•ã€‚è¯¥ç†è®ºå‡è®¾åŒæ­¥ç”µæœºçš„ç”µæ¢ç£åŠ¨åŠ¿ï¼ˆMMFï¼‰å¯ä»¥åˆ†è§£ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„åˆ†é‡ï¼š\n\n- dè½´ååº”ï¼šä¸è½¬å­ç£é“¾å¯¹é½çš„ç£åŠ¨åŠ¿åˆ†é‡ï¼Œä¸»è¦å½±å“ç”µæœºçš„åŠ±ç£ç”µæµã€‚\n\n- qè½´ååº”ï¼šä¸dè½´å‚ç›´çš„ç£åŠ¨åŠ¿åˆ†é‡ï¼Œä¸»è¦å½±å“ç”µæœºçš„è½¬çŸ©ç”µæµã€‚\n\nåŒååº”ç†è®ºè®¤ä¸ºè¿™ä¸¤ä¸ªååº”æ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”å¯ä»¥åˆ†åˆ«è®¡ç®—ï¼Œä»è€Œç®€åŒ–äº†ç”µæœºçš„åˆ†æã€‚\n\ndq0åæ ‡ç³»ç»Ÿä¸åŒååº”ç†è®ºåœ¨æ¦‚å¿µå’Œåº”ç”¨ä¸Šå…·æœ‰å¾ˆå¤§çš„ç»Ÿä¸€æ€§ã€‚å…·ä½“è¡¨ç°å¦‚ä¸‹ï¼š\n\n- åæ ‡å¯¹é½ï¼šåœ¨dq0åæ ‡ç³»ç»Ÿä¸­ï¼Œdè½´å’Œqè½´åˆ†åˆ«å¯¹åº”åŒååº”ç†è®ºä¸­çš„dè½´ååº”å’Œqè½´ååº”ã€‚è¿™ä½¿å¾—ç”µæœºçš„ç£åŠ¨åŠ¿å’Œç”µæµå¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªç‹¬ç«‹çš„åˆ†é‡æ¥è¡¨ç¤ºã€‚\n\n- æ•°å­¦ç®€åŒ–ï¼šä¸¤è€…éƒ½æ—¨åœ¨ç®€åŒ–ç”µæœºçš„æ•°å­¦åˆ†æã€‚dq0åæ ‡ç³»ç»Ÿå°†äº¤æµå˜é‡è½¬æ¢ä¸ºç›´æµå˜é‡ï¼Œè€ŒåŒååº”ç†è®ºå°†å¤æ‚çš„ä¸‰ç›¸ç³»ç»Ÿåˆ†è§£ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„è½´ã€‚è¿™ä¸¤ç§æ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥å¤§å¤§ç®€åŒ–ç”µæœºçš„åŠ¨æ€å»ºæ¨¡å’Œæ§åˆ¶è®¾è®¡ã€‚\n\n- ç‹¬ç«‹æ€§å‡è®¾ï¼šåŒååº”ç†è®ºå‡è®¾dè½´ååº”å’Œqè½´ååº”æ˜¯ç‹¬ç«‹çš„ï¼Œè¿™åœ¨dq0åæ ‡ç³»ç»Ÿä¸­ä¹Ÿå¾—åˆ°äº†ä½“ç°ã€‚dq0ç³»ç»Ÿä¸­çš„ç”µå‹å’Œç”µæµæ–¹ç¨‹å¯ä»¥åˆ†åˆ«åœ¨dè½´å’Œqè½´ä¸Šè¿›è¡Œè§£è€¦åˆ†æã€‚\n\nåŒæ­¥ç”µæœºçš„dq0åæ ‡ç³»ç»Ÿå’ŒåŒååº”ç†è®ºéƒ½ä¸ºç®€åŒ–å’Œæ·±å…¥ç†è§£ç”µæœºå†…éƒ¨çš„ç‰©ç†ç°è±¡æä¾›äº†å·¥å…·ã€‚dq0åæ ‡ç³»ç»Ÿé€šè¿‡æ•°å­¦å˜æ¢å°†ç”µæœºçš„æ—¶å˜é—®é¢˜è½¬æ¢ä¸ºé™æ€é—®é¢˜ï¼Œè€ŒåŒååº”ç†è®ºåˆ™é€šè¿‡ç‰©ç†è§£é‡Šå°†ç”µæœºçš„ç£åŠ¨åŠ¿åˆ†è§£ä¸ºä¸¤ä¸ªç‹¬ç«‹åˆ†é‡ã€‚ä¸¤è€…åœ¨æ¦‚å¿µå’Œå®é™…åº”ç”¨ä¸Šå…·æœ‰å¾ˆå¼ºçš„ç»Ÿä¸€æ€§ï¼Œç»“åˆä½¿ç”¨èƒ½å¤Ÿæ›´å¥½åœ°åˆ†æå’Œæ§åˆ¶åŒæ­¥ç”µæœºã€‚","categories":["ç”µæ°”å·¥ç¨‹"]},{"title":"å°†åŸºäºHexoçš„ä¸ªäººç½‘ç«™æäº¤è‡³Googleæ”¶å½•","url":"/2024/07/13/å°†åŸºäºHexoçš„ä¸ªäººç½‘ç«™æäº¤è‡³Googleæ”¶å½•/","content":"\n## ç®€ä»‹\nHexoåšå®¢ç”Ÿæˆå¹¶éƒ¨ç½²åï¼Œæ— è®ºæ˜¯éƒ¨ç½²è‡³ç¬¬ä¸‰æ–¹å¹³å°ï¼ˆå¦‚Github Pagesï¼‰ï¼Œè¿˜æ˜¯éƒ¨ç½²è‡³ç§æœ‰æœåŠ¡å™¨ç„¶åå®šå‘è‡³ä¸ªäººåŸŸåï¼Œéƒ½éœ€è¦äººå·¥å‘æœç´¢å¼•æ“æäº¤æ”¶å½•ã€‚ç®€å•æ¥è¯´è¿™ä¸€è¿‡ç¨‹å°±æ˜¯æŠŠè¯¥ç½‘ç«™çš„å†…å®¹å’Œåœ°å€â€œå‘Šè¯‰â€æœç´¢å¼•æ“ï¼Œè®©æœç´¢å¼•æ“â€œè®¤è¯†â€ä½ ã€‚è¿™æ ·å½“ä¸‹æ¬¡æœ‰äººåœ¨æœç´¢å¼•æ“ä¸­æœç´¢ä¸ä½ åšå®¢æœ‰å…³è”çš„å†…å®¹æ—¶ï¼Œæœç´¢å¼•æ“å°±èƒ½å¤Ÿå‘ç°ä½ äº†ã€‚\n\næˆ‘ä»¬ä»¥Googleä¸ºä¾‹ï¼Œè¦å®Œæˆè¿™ä¸ªè¿‡ç¨‹ï¼Œé€šå¸¸éœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š\n\n- ç¡®è®¤åšå®¢æ˜¯å¦è¢«æ”¶å½•\n- éªŒè¯ç½‘ç«™æ‰€æœ‰è€…\n- ç”Ÿæˆå¹¶æäº¤ç«™ç‚¹åœ°å›¾ï¼ˆsitemapï¼‰\n- ç­‰å¾…æ”¶å½•\n\n### ä¸€ã€ç¡®è®¤åšå®¢æ˜¯å¦è¢«æ”¶å½•\nä»¥æœ¬ç½‘ç«™ä¸ºä¾‹ï¼Œæ‰“å¼€Googleï¼Œè¾“å…¥`site:akichen891.github.io`\n![æœç´¢ç»“æœ](/images/sitemap/sousuo.png)\n\nå¦‚æœGoogleæç¤ºâ€œæ‰¾ä¸åˆ°ç›¸ç¬¦çš„å†…å®¹â€ï¼Œåˆ™è¯´æ˜ä½ çš„ç½‘ç«™å°šæœªè¢«Googleæ”¶å½•ã€‚å¦‚æœç½‘ç«™å·²ç»è¢«æ”¶å½•ï¼ŒGoogleä¼šè‡ªåŠ¨æŸ¥è¯¢å’Œç½‘ç«™æœ‰å…³çš„å†…å®¹ã€‚\n\n### äºŒã€éªŒè¯ç½‘ç«™æ‰€æœ‰è€…\nåªæœ‰å‘æœç´¢å¼•æ“æ·»åŠ å¹¶è®¤è¯ç½‘ç«™ï¼Œè¯æ˜è‡ªå·±æ˜¯è¯¥åŸŸåçš„æ‹¥æœ‰è€…å’Œç®¡ç†è€…åï¼Œæœç´¢å¼•æ“å¯ä»¥å¿«é€Ÿæ‰¹é‡æ·»åŠ è¯¥åŸŸåä¸‹çš„æ‰€æœ‰å­ç«™ç‚¹ï¼Œè€Œæ— éœ€ä¸€ä¸€éªŒè¯ã€‚è®¤è¯å®Œæˆåè¿˜å¯ä»¥ä½¿ç”¨Google ConsoleæŸ¥çœ‹å¹¶ç®¡ç†ç½‘ç«™çš„è®¿é—®ç»Ÿè®¡ç­‰ã€\n\nè¦è¿›è¡ŒéªŒè¯ï¼Œé¦–å…ˆå‰å¾€[Google Console](\nhttps://www.google.com/webmasters/tools/home?hl=zh-CN)ã€‚\n\nGoogle Consoleä¼šè¦æ±‚é€‰æ‹©èµ„æºç±»å‹ã€‚\n![é€‰æ‹©èµ„æºç±»å‹](/images/sitemap/tianjia.png)\n\né€‰æ‹©â€œç½‘å€å‰ç¼€â€ï¼Œåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å¸¦`http://`æˆ–`https://`å‰ç¼€çš„å®Œæ•´ä¸»åŸŸåï¼Œç„¶åç‚¹å‡»â€œç»§ç»­â€ã€‚\n\nGoogleæä¾›äº”ç§éªŒè¯æ–¹æ³•ï¼š\n- HTMLæ–‡ä»¶\n- HTMLæ ‡è®°\n- Google Analytics\n- Googleè·Ÿè¸ªä»£ç ç®¡ç†å™¨\n- åŸŸåæä¾›å•†\n\nè¿™å‡ ç§æ–¹æ³•ä¾æ¬¡ä¸ºä»ç®€åˆ°éš¾ã€‚è¿™é‡Œåªä»‹ç»å¤´ä¸¤ç§ã€‚\n#### HTMLæ–‡ä»¶éªŒè¯\nè¿™æ˜¯æœ€ç®€å•çš„ä¸€ç§éªŒè¯æ–¹æ³•ï¼Œå…·ä½“æ­¥éª¤Googleä¹Ÿå†™çš„å¾ˆæ¸…æ¥šã€‚\n\n![HTMLæ–‡ä»¶éªŒè¯](/images/sitemap/1.png)\n\nç‚¹å‡»ä¸‹è½½è¿™ä¸ª`.html`æ–‡ä»¶ï¼Œå¯¹äºHexoï¼Œå°†è¯¥æ–‡ä»¶æ”¾åœ¨Hexoæ ¹ç›®å½•ä¸‹`/source`æ–‡ä»¶ä¸­ã€‚ç„¶å`hexo g -d`ï¼Œç­‰å¾…éƒ¨ç½²ã€‚å½“ä½ èƒ½å¤Ÿåœ¨æµè§ˆå™¨ä¸­è¾“å…¥`https://example.blog/googleXXXXXXX.html`å¹¶æˆåŠŸè·³è½¬æ—¶ï¼Œè¯´æ˜è¯¥æ–‡ä»¶å·²ç»æ·»åŠ æˆåŠŸã€‚\n\nå›åˆ°Google Consoleï¼Œç‚¹å‡»éªŒè¯ï¼Œæ­£å¸¸æƒ…å†µä¸‹Google Consoleå¾ˆå¿«å°±ä¼šæç¤ºéªŒè¯æˆåŠŸã€‚\n\nå¦‚æœä½¿ç”¨è¯¥æ–¹æ³•å´ä¸€ç›´æç¤ºéªŒè¯å¤±è´¥ï¼Œå¯ä»¥ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚\n\n#### HTMLæ ‡è®°éªŒè¯\nè¿™ç§æ–¹æ³•å’Œç¬¬ä¸€ç§æ–¹æ³•éå¸¸ç±»ä¼¼ï¼Œåªä¸è¿‡å°†éªŒè¯æ–‡ä»¶å˜æˆäº†ä¸€ä¸ªhtmlå…ƒæ ‡è®°ã€‚\n![HTMLæ ‡è®°éªŒè¯](/images/sitemap/2.png)\n\næŒ‰ç…§è¦æ±‚ï¼Œå¤åˆ¶å…ƒæ ‡è®°ã€‚å¯¹äºHexoåšå®¢ï¼Œè¿™ä¸ªæ‰€è°“çš„â€œé¦–é¡µâ€æ–‡ä»¶çš„ä½ç½®å¯èƒ½æœ‰æ‰€ä¸åŒã€‚å¯¹äºFluidä¸»é¢˜ï¼Œè¯¥æ–‡ä»¶å³ä¸º`\\node_modules\\hexo-theme-fluid\\layout\\_partials`ç›®å½•ä¸‹çš„`head.ejs`.\n\næŒ‰ç…§Googleçš„è¦æ±‚ï¼Œåœ¨`<head>`ä¸­ç²˜è´´è¯¥å…ƒæ ‡è®°ã€‚\n![HTMLæ ‡è®°éªŒè¯](/images/sitemap/3.png)\n\nä¹‹åï¼Œ`hexo clean`ï¼Œç„¶å`hexo g -d`ï¼Œç­‰å¾…éƒ¨ç½²ã€‚éƒ¨ç½²å®Œæˆååœ¨Google Consoleä¸­ç‚¹å‡»éªŒè¯ã€‚\n\n## ä¸‰ã€ç«™ç‚¹åœ°å›¾(Sitemap)\n### ä»€ä¹ˆæ˜¯ç«™ç‚¹åœ°å›¾ï¼Ÿ\n> ç«™ç‚¹åœ°å›¾æ˜¯ç½‘ç«™ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥è®© Google çŸ¥é“åº”è¯¥äº†è§£ç½‘ç«™ä¸Šçš„å“ªäº›ç½‘é¡µã€‚å¦‚æœæ‚¨ä½¿ç”¨äº†ç½‘ç«™æ‰˜ç®¡æœåŠ¡ï¼ˆæ¯”å¦‚ Squarespace æˆ– Wixï¼‰ï¼Œè¿™äº›æœåŠ¡å¯èƒ½ä¼šä¸ºæ‚¨ç®¡ç†ç«™ç‚¹åœ°å›¾ï¼Œè¿™æ ·çš„è¯ï¼Œæ‚¨å°±æ— éœ€åˆ›å»ºè‡ªå·±çš„ç«™ç‚¹åœ°å›¾ï¼Œä¹Ÿæ— éœ€ä½¿ç”¨æ­¤æŠ¥å‘Šã€‚è‹¥æƒ³äº†è§£ç«™ç‚¹åœ°å›¾çš„ç›¸å…³ä¿¡æ¯ï¼Œè¯·æœç´¢æ‚¨çš„æ‰˜ç®¡æœåŠ¡æä¾›å•†ã€‚å¦‚æœæ‚¨çš„ç½‘ç«™è§„æ¨¡è¾ƒå°ï¼ˆå°‘äº 100 ä¸ªç½‘é¡µï¼‰ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥é€šè¿‡è¿½è¸ªé¦–é¡µä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªé“¾æ¥åˆ°è¾¾ç½‘ç«™ä¸Šçš„ä»»ä½•ç½‘é¡µï¼Œåˆ™å¯èƒ½æ— éœ€ä½¿ç”¨ç«™ç‚¹åœ°å›¾æˆ–æ­¤æŠ¥å‘Šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªéœ€è¯·æ±‚å°†æ‚¨çš„é¦–é¡µç¼–å…¥ç´¢å¼•å³å¯ï¼ˆé™¤éæ‚¨ä½¿ç”¨çš„æ˜¯ä¸Šè¿°ç½‘ç«™æ‰˜ç®¡æœåŠ¡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ‚¨æ— éœ€æ‰§è¡Œä»»ä½•æ“ä½œï¼‰ã€‚\n\n### ä¸ºHexoç”Ÿæˆç«™ç‚¹åœ°å›¾\nä¸ºå¯ç”¨ç«™ç‚¹åœ°å›¾ï¼Œé¦–å…ˆè¦åœ¨Hexoæ ¹ç›®å½•ä¸­Git Bashæ¥å®‰è£…æ’ä»¶ï¼š\n```\nnpm install hexo-generator-sitemap --save\n```\nåœ¨**ç«™ç‚¹é…ç½®æ–‡ä»¶**ï¼ˆä¸æ˜¯ä¸»é¢˜é…ç½®æ–‡ä»¶ï¼ï¼‰`_config.yml`ä¸­æ·»åŠ ï¼š\n```\n# Auto Generate sitemap\nsitemap:\npath: sitemap.xml\n```\nç„¶å`hexo g -d`ï¼Œè‹¥`/public`æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆäº†`sitemap.xml`ï¼Œå¹¶ä¸”æµè§ˆå™¨èƒ½å¤Ÿè®¿é—®`https://example.blog/sitemap.xml`ï¼Œè¯´æ˜åˆ›å»ºæˆåŠŸã€‚\n\n### å‘Googleæäº¤ç«™ç‚¹åœ°å›¾\nåœ¨Google Consoleä¸­ï¼Œå·¦ä¾§æ é€‰æ‹©â€œç«™ç‚¹åœ°å›¾â€ï¼Œåœ¨â€œæ·»åŠ æ–°çš„ç«™ç‚¹åœ°å›¾â€ä¸­ï¼Œè¾“å…¥ä½ çš„ç«™ç‚¹åœ°å›¾ç½‘å€ï¼Œæ¯”å¦‚`sitemap.xml`ã€‚\n\n![æ·»åŠ ç«™ç‚¹åœ°å›¾](/images/sitemap/4.png)\n\næäº¤æˆåŠŸåï¼ŒGoogleä¼šåœ¨â€œå·²æäº¤çš„ç«™ç‚¹åœ°å›¾â€ä¸­æ˜¾ç¤ºè¯¥sitemapã€‚\n![å·²æäº¤çš„ç«™ç‚¹åœ°å›¾](/images/sitemap/5.png)\n\nç´¢å¼•éœ€è¦ä¸€æ®µæ—¶é—´ç¼–åˆ¶å¹¶ç”Ÿæ•ˆã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œ48å°æ—¶å†…Googleå³å¯å®Œæˆæ”¶å½•ã€‚","categories":["å»ºç«™ç›¸å…³"]},{"title":"åœ¨Hexoä¸­å¯ç”¨æ–°Markdownè§£é‡Šå™¨å¹¶é…ç½®Katex","url":"/2024/07/11/åœ¨Hexoä¸­å¯ç”¨æ–°Markdownè§£é‡Šå™¨å¹¶é…ç½®Katex/","content":"## Markdownç¼–è¯‘å™¨\nåœ¨ Hexo ä¸­ï¼Œå¦‚æœé»˜è®¤çš„ Markdown ç¼–è¯‘å™¨æ— æ³•æ­£ç¡®æ¸²æŸ“ LaTeX å…¬å¼ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ”¯æŒ LaTeX å…¬å¼çš„ Markdown ç¼–è¯‘å™¨æ’ä»¶ã€‚å¸¸ç”¨çš„åŒ…æ‹¬ï¼š\n- hexo-renderer-pandoc\n- hexo-renderer-markdown-it\n- hexo-filter-mathjax\n- hexo-renderer-markdown-it-plus\n\næ¨èä½¿ç”¨[hexo-renderer-markdown-it-plus](https://github.com/CHENXCHEN/hexo-renderer-markdown-it-plus).\n\n## hexo-renderer-markdown-it-plus å®‰è£…ä¸é…ç½®\n\n- å¸è½½æ—§çš„æ¸²æŸ“å™¨ï¼š\n\n```\nnpm uninstall hexo-renderer-marked --save\n```\n\n- å®‰è£…`hexo-renderer-markdown-it-plus`ï¼š\n\nåœ¨Hexoæ ¹ç›®å½•ä¸­æ‰“å¼€Git Bashï¼Œç„¶åï¼š\n\n```\nnpm install hexo-renderer-markdown-it-plus --save\n```\n\n- é…ç½®`_config.yml`ï¼š\n\næ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n\n```\nmarkdown:\n  render:\n    engine: markdown-it-plus\n    options:\n      html: true\n      xhtmlOut: true\n      breaks: true\n      linkify: true\n      typographer: true\n      quotes: 'â€œâ€â€˜â€™'\n      plugins:\n        - plugin:\n            name: markdown-it-katex\n            options:\n              throwOnError: false\n              errorColor: '#cc0000'\n```\n## å¼•å…¥KaTeXçš„CSS\nä¸ºäº†é¿å…å…¬å¼é”™ä½é—®é¢˜ï¼Œéœ€è¦ç¡®ä¿æ­£ç¡®å¼•å…¥ KaTeX çš„ CSS æ–‡ä»¶ã€‚åœ¨ä¸»é¢˜å¸ƒå±€æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ themes/your-theme/layout/_partial/head.ejsï¼‰ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š\n\n```\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css\">\n```\n\n","categories":["å»ºç«™ç›¸å…³"]},{"title":"ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºæ–¹ç¨‹å¼ï¼ˆç›¸åæ ‡ï¼‰","url":"/2024/07/11/ã€ç”µæœºç¬æ€åˆ†æã€‘äº¤æµç”µæœºæ–¹ç¨‹å¼ï¼ˆç›¸åæ ‡ï¼‰/","content":"## å‡¸çº§åŒæ­¥ç”µæœºåœ¨ç›¸åæ ‡ç³»ç»Ÿä¸­çš„ç”µå‹æ–¹ç¨‹å¼\n### æ­£æ–¹å‘è§„å®šä¸­çš„ç”µåŠ¨æœºæƒ¯ä¾‹ä¸å‘ç”µæœºæƒ¯ä¾‹\n#### ç”µåŠ¨æœºæƒ¯ä¾‹\nç£é“¾å®šä¹‰å¼ä¸ºï¼š\n$$\n\\lambda = N \\phi\n$$\nå…¶ä¸­$N$ä¸ºçº¿åœˆåŒæ•°ã€‚\n\næ ¹æ®æƒ¯ä¾‹ï¼Œè®¤ä¸ºä¸€ä¸ªçº¿åœˆè½´çº¿çš„æ­£æ–¹å‘æä¸ºè¯¥çº¿åœˆäº§ç”Ÿç£åœºè½´çº¿çš„æ­£æ–¹å‘ã€‚è‹¥æŒ‰ç…§å³æ‰‹èºæ—‹å®šå¾‹æ¥ç¡®å®šç”µæµå’Œç”µå‹çš„æ­£æ–¹å‘ï¼Œå³è®¤ä¸ºäºŒè€…ç¬¦åˆç”µåŠ¨æœºæƒ¯ä¾‹ï¼Œåˆ™è¯¥å›è·¯ç£é“¾æ–¹ç¨‹å¼å¯åˆ—å†™ä¸ºï¼š\n$$\n\\psi_k = N \\phi = L_kI_k\n$$\nå…¶ä¸­$L$ä¸ºçº¿åœˆç”µæ„Ÿï¼Œ$I$ä¸ºçº¿åœˆä¸­çš„ç”µæµã€‚\n\næ ¹æ®ç”µç£æ„Ÿåº”å®šç†å’Œæ¥æ¬¡å®šç†ï¼Œå½“ç£é“¾$\\psi$æ­£å‘å¢é•¿æ—¶ï¼Œæ„Ÿç”Ÿç”µåŠ¨åŠ¿å¿…å®šæ˜¯é˜»æ­¢ç£é“¾å¢é•¿çš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åœ¨ç­‰æ•ˆç”µè·¯ä¸­ï¼Œç”µå‹æºç”µä½å‡é«˜çš„æ–¹å‘ä¸ç”µæµæ­£æ–¹å‘ç›¸åã€‚ç­‰æ•ˆå›è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![å›¾1 ç”µåŠ¨æœºæƒ¯ä¾‹ä¸‹å›è·¯å‹ã€æµæ­£æ–¹å‘](/images/1.1/Fig3.png)\n\næ ¹æ®åŸºå°”éœå¤«ç¬¬äºŒå®šå¾‹ï¼Œæ­¤æ—¶ç­‰æ•ˆå›è·¯çš„ç”µå‹æ–¹ç¨‹å¼ä¸ºï¼š\n$$\nu_k = p \\psi + i_k r_k\n$$\nå…¶ä¸­,$p$ä¸ºå¾®åˆ†ç®—å­ï¼Œå³$\\frac{d}{dt}$ã€‚$\\psi$ä¸ºä¸»ç£è·¯ç£é“¾ã€‚\n\nç®€å•æ¥è¯´ï¼Œç”µåŠ¨æœºæƒ¯ä¾‹ä¸‹ï¼Œç”µå‹ã€ç”µæµæ­£æ–¹å‘çš„è§„å®šåº”å½“åæ˜ å‡ºï¼š\n- ç”µæµä»ç”µæºæµå‘ç”µæœºå†…éƒ¨ã€‚å³å®šå­ç»•ç»„çš„ç”µæµæ–¹å‘æ˜¯ä»ç”µæºåˆ°ç”µæœºã€‚\n- ç”µæºå‘ç”µæœºä¼ é€’åŠŸç‡ï¼Œç”µæœºæ¶ˆè€—ç”µèƒ½è½¬æ¢ä¸ºæœºæ¢°èƒ½è¾“å‡ºã€‚\n- åœ¨ç”µåŠ¨æœºè¿è¡Œæ—¶ï¼Œç”µæµä»å®šå­ç»•ç»„æµå…¥ï¼Œç”µæ¢ç”µæµæ–¹å‘ä¸å®šå­ç£åœºæ–¹å‘ç›¸åŒæˆ–ç›¸è¿‘ï¼Œç”µåŠ¨æœºäº§ç”Ÿç”µç£è½¬çŸ©ï¼Œå¸¦åŠ¨æœºæ¢°è´Ÿè½½è¿è¡Œã€‚\n\n#### å‘ç”µæœºæƒ¯ä¾‹\n\nå¦‚æœä¿æŒç”µæµçš„æ­£æ–¹å‘è§„å®šè§„åˆ™ä¸å˜ï¼Œä»å°†äº§ç”Ÿæ­£å‘ç£é“¾çš„ç”µæµæ–¹å‘è§„å®šä¸ºç”µæµæ­£æ–¹å‘ï¼Œä»…æ”¹å˜ç”µå‹æ­£æ–¹å‘çš„è§„å®šï¼Œä»¤äºŒè€…ç¬¦åˆå‘ç”µæœºæƒ¯ä¾‹ï¼Œåˆ™å›è·¯ç”µå‹æ­£æ–¹å‘ä¸ç”µæµæ­£æ–¹å‘çš„å…³ç³»æ”¹ä¸ºä¸‹å›¾æ‰€ç¤ºï¼š\n\n![å›¾2 å‘ç”µæœºæƒ¯ä¾‹ä¸‹å›è·¯å‹ã€æµæ­£æ–¹å‘](/images/1.1/Fig1.png)\n\næ ¹æ®åŸºå°”éœå¤«ç¬¬äºŒå®šå¾‹ï¼Œå›è·¯ç”µå‹æ–¹ç¨‹å¼ä¸ºï¼š\n$$\nu_k = -p \\psi - i_k r_k\n$$\n\nç®€å•æ¥è¯´ï¼Œå‘ç”µæœºæƒ¯ä¾‹ä¸‹ï¼Œç”µå‹ã€ç”µæµæ­£æ–¹å‘çš„è§„å®šåº”å½“åæ˜ å‡ºï¼š\n- ç”µæµä»ç”µæœºå†…éƒ¨æµå‘ç”µæºã€‚å³å®šå­ç»•ç»„çš„ç”µæµæ–¹å‘æ˜¯ä»ç”µæœºåˆ°ç”µç½‘æˆ–è´Ÿè½½ã€‚\n- ç”µæœºå‘ç”µæºä¼ é€’åŠŸç‡ï¼Œç”µæœºå°†æœºæ¢°èƒ½è½¬æ¢ä¸ºç”µèƒ½è¾“å‡ºã€‚\n- åœ¨å‘ç”µæœºè¿è¡Œæ—¶ï¼Œå¤–éƒ¨æœºæ¢°åŠ›é©±åŠ¨è½¬å­æ—‹è½¬ï¼Œå®šå­ç»•ç»„ä¸­çš„ç”µæµæµå‡ºï¼Œå®šå­ç»•ç»„ä¸­çš„ç”µæµæ–¹å‘ä¸å®šå­ç£åœºæ–¹å‘ç›¸åæˆ–ç›¸å¯¹ï¼Œå‘ç”µæœºå°†æœºæ¢°èƒ½è½¬æ¢ä¸ºç”µèƒ½è¾“å‡ºåˆ°ç”µç½‘æˆ–è´Ÿè½½ã€‚\n\n### å‡¸çº§åŒæ­¥ç”µæœºçš„ç”µå‹æ–¹ç¨‹å¼\n\nåˆ†æå‡¸çº§åŒæ­¥ç”µæœºè¿è¡Œé—®é¢˜å‰ï¼Œä¸ºç®€åŒ–åˆ†æï¼Œä½œä»¥ä¸‹å‡å®šï¼š\n- ç”µæœºé“ç£éƒ¨åˆ†çš„ç£è·¯ä¸ºçº¿æ€§ï¼Œå³ä¸è®¡é¥±å’Œã€å‰©ç£ã€ç£æ»å’Œæ¶¡æµçš„å½±å“ï¼›\n- ç”µæœºçš„å®šã€è½¬å­é½¿æ§½æ•ˆåº”ç”¨æ°”è¸ªçš„å¡æ°ç³»æ•°è¡¨å¾ï¼Œå³è®¤ä¸ºå®šã€è½¬å­è¡¨é¢å…‰æ»‘ï¼Œåªæ˜¯æ°”éš™å¢å¤§äº†ä¸€äº›ï¼›\n- å®šå­ä¸‰ç›¸ç»•ç»„å¯¹ç§°ï¼Œè½¬å­ç»“æ„åˆ†åˆ«å¯¹ç›´è½´å’Œäº¤è½´å¯¹ç§°ã€‚\n\nç”±äºå‡å®šç£è·¯ä¸ºçº¿æ€§ï¼Œå¯åº”ç”¨å åŠ åŸç†ï¼Œå³æŸç»•ç»„äº¤é“¾çš„æ€»ç£é“¾ç­‰äºå„ç»•ç»„ç”µæµåˆ†åˆ«äº§ç”Ÿå¹¶ä¸ä¹‹äº¤é“¾çš„ç£é“¾çš„ä»£æ•°å’Œã€‚å®é™…ç”µæœºé¥±å’Œçš„å½±å“ï¼Œå¯æ ¹æ®ç”µæœºçš„è¿è¡Œæ¡ä»¶ï¼Œè¿‘ä¼¼åœ°é‡‡ç”¨é€‰æ‹©é€‚å½“å‚æ•°å€¼çš„æ–¹æ³•åŠ ä»¥ä¿®æ­£ã€‚\n\nå¼€å§‹åˆ†æå‰åº”å½“è§„å®šå„å˜é‡çš„æ­£æ–¹å‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![å›¾3 å‡¸çº§åŒæ­¥ç”µæœºå†…éƒ¨å˜é‡æ­£æ–¹å‘](/images/1.1/Fig2.png)\n\næ˜¾ç„¶å›¾ä¸­aã€bã€cè½´çº¿åˆ†åˆ«è¡¨ç¤ºå®šå­ä¸‰ç›¸ç»•ç»„å®é™…è½´çº¿çš„å¯¹åº”æ­£æ–¹å‘ï¼Œå³å„ç›¸ç»•ç»„ç£é“¾æ­£æ–¹å‘ã€‚ä»¥åŠä¸ºåŸºç¡€ï¼Œè§„å®šäº§ç”Ÿæ­£å‘ç£é“¾çš„ç”µæµæ–¹å‘ä¸ºç”µæµæ­£æ–¹å‘ã€‚ç”µå‹æ­£æ–¹å‘ä¸ç”µæµæ­£æ–¹å‘çš„å…³ç³»æŒ‰ç…§ç”µåŠ¨æœºæƒ¯ä¾‹ç¡®å®šã€‚\n\n#### å®šå­ç»•ç»„\næŒ‰ç…§ç”µåŠ¨æœºæƒ¯ä¾‹ï¼Œæ ¹æ®åŸºå°”éœå¤«ç¬¬äºŒå®šå¾‹ï¼Œå®šå­ä¸‰ç›¸ç»•ç»„çš„ç”µå‹æ–¹ç¨‹å¼å¯åˆ†åˆ«æ ¹æ®å®šå­ç»•ç»„å›è·¯åˆ—å†™ä¸ºï¼š\n$$\n\\left.\\begin{array}{l}\nu_{\\mathrm{a}}=p \\psi_{\\mathrm{a}}+r_{s} i_{\\mathrm{a}} \\\\\nu_{\\mathrm{b}}=p \\psi_{\\mathrm{b}}+r_{\\mathrm{s}} i_{\\mathrm{b}} \\\\\nu_{\\mathrm{c}}=p \\psi_{\\mathrm{c}}+r_{\\mathrm{s}} i_{\\mathrm{c}}\n\\end{array}\\right\\}\n$$\n\n#### åŠ±ç£ç»•ç»„\næ ¹æ®ç”µåŠ¨æœºæƒ¯ä¾‹ï¼ŒåŠ±ç£ç»•ç»„ç”µå‹æ–¹ç¨‹ä¸ºï¼š\n$$\nu_f = -p \\psi_f - i_f r_f\n$$\n\n#### é˜»å°¼ç»•ç»„\né˜»å°¼ç»•ç»„å¹¿æ³›åº”ç”¨äºç”µåŠ›ç³»ç»Ÿä¸­éœ€è¦é«˜ç¨³å®šæ€§çš„åŒæ­¥ç”µæœºï¼Œå¦‚å‘ç”µæœºå’Œå¤§å‹å·¥ä¸šç”µåŠ¨æœºã€‚å…¶ä¸»è¦ç›®çš„æ˜¯ä¿è¯ç”µæœºåœ¨å¯åŠ¨ã€åœæ­¢ä»¥åŠè´Ÿè½½å˜åŒ–æ—¶çš„å¹³ç¨³è¿è¡Œï¼Œé˜²æ­¢ç³»ç»Ÿå¤±æ­¥å’ŒæŒ¯è¡ã€‚\n\né˜»å°¼ç»•ç»„ä¸€èˆ¬ç”±å®‰è£…åœ¨ç£ææé´ä¸Šçš„é˜»å°¼æ¡å’Œé˜»å°¼ç¯ç»„æˆï¼Œé˜»å°¼æ¡ç”±é˜»å°¼ç¯éƒ¨åˆ†æˆ–å…¨éƒ¨çŸ­æ¥ï¼Œå…¶åˆ†å¸ƒå¯¹äºç›´è½´æˆ–äº¤è½´è€Œè¨€é€šå¸¸éƒ½æ˜¯å¯¹ç§°çš„ã€‚å…¶ç»“æ„ã€å®‰è£…ä½ç½®å’Œç®€å•ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚\n\n<p align=center>\n<img src=/images/1.1/zuniraozu.png width=50% title=é˜»å°¼ç»•ç»„å®‰è£…ä½ç½®>\n</p>\n\n![é˜»å°¼ç»•ç»„ç®€å•ç¤ºæ„å›¾](/images/1.1/zuniraozu2.png)\n\nå¯è§é˜»å°¼æ¡æ„æˆçš„å›è·¯æ˜¯ç½‘çŠ¶çš„ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œé€šå¸¸ç”µæµå›è·¯çš„é€‰å–å‡å¯¹ç§°äºç›´è½´æˆ–äº¤è½´ã€‚ä¸Šå›¾è¡¨ç¤ºæ¯ä¸ªç£ææœ‰å››æ ¹é˜»å°¼æ¡çš„é˜»å°¼ç»•ç»„ï¼Œå…¶ä¸­å›è·¯1dã€2då¯¹ç§°äºdè½´ï¼Œå›è·¯1qã€2qå¯¹ç§°äºqè½´ï¼Œé˜»å°¼æ¡ä¸­æµè¿‡çš„å®é™…ç”µæµå³ä¸ºç›¸åº”çš„dè½´å’Œqè½´å›è·¯ç”µæµçš„ä»£æ•°å’Œã€‚\n\nå½“åªè€ƒè™‘æ°”éš™ç£åœºï¼ˆå®šã€è½¬å­åˆæˆç£åœºï¼‰åŸºæ³¢æ—¶ï¼Œè‹¥åŸºäºä»¥ä¸Šè§„åˆ™åˆ’åˆ†é˜»å°¼ç»•ç»„ç”µæµå›è·¯ï¼Œåˆ™dè½´å›è·¯å’Œqè½´å›è·¯åœ¨ç©ºé—´ä¸­æ°å¥½ç›¸å·®90Â°çš„ç”µè§’åº¦ï¼Œè€Œè½¬å­ç»“æ„æ˜¾ç„¶ç›¸å¯¹äºdè½´æˆ–qè½´åˆæ˜¯å¯¹ç§°çš„ï¼Œå› æ­¤åœ¨dè½´å›è·¯å’Œqè½´å›è·¯ä¹‹é—´ä¸äº§ç”Ÿäº’æ„Ÿï¼Œè¿›è€Œå¯æŠŠå®é™…çš„é˜»å°¼ç»•ç»„çœ‹æˆæ˜¯ä¸¤ç»„å‡æƒ³çš„é˜»å°¼ç»•ç»„ï¼Œå³ç›´è½´é˜»å°¼ç»•ç»„å’Œäº¤è½´é˜»å°¼ç»•ç»„ã€‚\n\nè‹¥æŒ‰ç…§å®é™…æƒ…å†µå•ç‹¬è®¡ç®—æ¯ä¸€æ ¹é˜»å°¼æ¡çš„ç”µæµå’Œç£é“¾å…³ç³»ï¼Œå¯è¿›ä¸€æ­¥ç»™å‡ºæ¯ä¸€æ ¹é˜»å°¼æ¡çš„å®é™…ç”µæµï¼Œä½†æ˜¯è®¡ç®—é‡éå¸¸å¤§ã€‚åœ¨ä¸éœ€ç ”ç©¶é˜»å°¼ç»•ç»„å†…éƒ¨æƒ…å†µçš„æ¡ä»¶ä¸‹ï¼Œå¯å°†å®é™…çš„ç›´è½´åŠè½´çš„å¤šä¸ªå›è·¯çš„é˜»å°¼ç»•ç»„åˆ†åˆ«ç”¨ä¸€ä¸ªç›´è½´åŠäº¤è½´çš„ç­‰æ•ˆé˜»å°¼ç»Ÿç»„Då’ŒQæ¥ä»£æ›¿,ä»è€Œå¤§ä¸ºç®€åŒ–åˆ†æè®¡ç®—å·¥ä½œã€‚è¿™æ ·è™½ä¼šç»™è®¡ç®—å¸¦æ¥ä¸€äº›è¯¯å·®ï¼Œä½†åœ¨å·¥ç¨‹è®¡ç®—ä¸­æ˜¯å…è®¸çš„ï¼Œä¹Ÿæ˜¯å¸¸ç”¨çš„ä¸€ç§æ–¹æ³•ã€‚ç®€åŒ–çš„ç›´è½´åŠäº¤è½´ç­‰æ•ˆé˜»å°¼ç»•ç»„çš„ç”µå‹æ–¹ç¨‹å¼ä¸ºï¼š\n\n$$\n\\left.\\begin{array}{l}\n0 = p \\psi_D + r_D i_D \\\\\n0 = p \\psi_Q + r_Q i_Q\n\\end{array}\\right\\}\n$$\n\n#### è”ç«‹\nè”ç«‹å®šå­ç»•ç»„ã€åŠ±ç£ç»•ç»„å’Œé˜»å°¼ç»•ç»„çš„ç”µå‹æ–¹ç¨‹å¼ï¼Œç”¨çŸ©é˜µå½¢å¼è¡¨ç¤ºä¸ºï¼š\n$$\nU = p \\Psi + R I \n$$\nå¼ä¸­\n$$\nU = [u_a \\quad u_b \\quad u_c  \\quad u_f \\quad 0 \\quad 0]^{T}\n$$\n\n$$\nI = [i_a \\quad i_b \\quad i_c  \\quad i_f \\quad i_D \\quad i_Q]^{T}\n$$\n\n$$\n\\Psi = [\\psi_a \\quad \\psi_b \\quad \\psi_c  \\quad \\psi_f \\quad \\psi_D \\quad \\psi_Q]^{T}\n$$\n\n$$\nR =\n\\begin{bmatrix}\nr_a & & & & & \\\\\n& r_b & & & & \\\\\n& & r_c & & & \\\\\n& & & r_f & & \\\\\n& & & & r_D & \\\\\n& & & & & r_Q \\\\\n\\end{bmatrix}\n$$\n\nç”±ä¸Šå¼ï¼Œæ¯ä¸ªç”µå‹æ–¹ç¨‹å¼å‡ç”±ä¸¤é¡¹æ„æˆï¼š\n- ä¸ç»•ç»„äº¤é“¾çš„ä¸»ç£é“¾éšæ—¶é—´å˜åŒ–è€Œäº§ç”Ÿçš„æ„Ÿåº”ç”µåŠ¨åŠ¿$p\\psi$\n- ç”µæµé€šè¿‡ç»•ç»„ç”µé˜»äº§ç”Ÿçš„å‹é™$ri$\n\nåœ¨ä¸Šè¿°çš„åˆ†æä¸­ï¼Œæ— è®ºæ˜¯å®šå­ç»•ç»„ã€åŠ±ç£ç»•ç»„è¿˜æ˜¯é˜»å°¼ç»•ç»„ï¼Œä¸ç®¡å…¶æœ¬èº«æ˜¯æ—‹è½¬è¿˜æ˜¯åœæ­¢ï¼Œå…¶ç»•ç»„çš„è½´çº¿ä¸æ„æˆè¯¥ç»•ç»„çš„çº¿åœˆå…ƒä»¶ä¹‹é—´æ°¸è¿œä¿æŒç›¸å¯¹é™æ­¢ã€‚è¿™ç±»ç»•ç»„ä¹Ÿè¢«ç§°ä¸ºâ€œé™æ­¢ç»•ç»„â€ ã€‚\n\n## å‡¸çº§åŒæ­¥ç”µæœºåœ¨ç›¸åæ ‡ç³»ç»Ÿä¸­çš„ç£é“¾æ–¹ç¨‹å¼\nä¸Šæ–‡å¯¼å‡ºçš„ç”µå‹æ–¹ç¨‹å¼ä¸­ï¼Œä¸æ¯ä¸ªç»•ç»„äº¤é“¾çš„ä¸»ç£é“¾æ˜¯ä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†çš„ä»£æ•°å’Œï¼š\n- ç»•ç»„è‡ªèº«é€šè¿‡å˜åŒ–ç”µæµäº§ç”Ÿçš„ç£é€šï¼ˆè‡ªæ„Ÿï¼‰\n- ä¸è¯¥ç»•ç»„ç›¸äº¤é“¾çš„äº’æ„Ÿç£é“¾ï¼ˆäº’æ„Ÿï¼‰\n\nè¿™äº›ç£é“¾ä¸ç”µæµåŠç”µæ„Ÿç³»æ•°çš„å…³ç³»ç”¨çŸ©é˜µå½¢å¼è¡¨ç¤ºä¸ºï¼š\n$$\\begin{bmatrix}\\psi_\\mathrm{a}\\\\\\psi_\\mathrm{b}\\\\\\psi_\\mathrm{c}\\\\\\psi_\\mathrm{f}\\\\\\psi_\\mathrm{D}\\\\\\psi_\\mathrm{Q}\\end{bmatrix}=\\begin{bmatrix}L_\\mathrm{aa}&M_\\mathrm{ab}&M_\\mathrm{ac}&M_\\mathrm{af}&M_\\mathrm{aD}&M_\\mathrm{aQ}\\\\M_\\mathrm{ba}&L_\\mathrm{bb}&M_\\mathrm{bc}&M_\\mathrm{bf}&M_\\mathrm{bD}&M_\\mathrm{bQ}\\\\M_\\mathrm{ca}&M_\\mathrm{cb}&L_\\mathrm{cc}&M_d&M_\\mathrm{cD}&M_\\mathrm{cQ}\\\\M_\\mathrm{fa}&M_\\mathrm{fb}&M_\\mathrm{fc}&L_\\mathrm{f}&M_\\mathrm{fD}&0\\\\M_\\mathrm{Da}&M_\\mathrm{Db}&M_\\mathrm{Dc}&M_\\mathrm{Df}&L_\\mathrm{D}&0\\\\M_\\mathrm{Qa}&M_\\mathrm{Qb}&M_\\mathrm{Qc}&0&0&L_\\mathrm{Q}\\end{bmatrix}\\begin{bmatrix}i_\\mathrm{a}\\\\i_\\mathrm{b}\\\\i_\\mathrm{c}\\\\i_\\mathrm{f}\\\\i_\\mathrm{D}\\\\i_\\mathrm{Q}\\end{bmatrix}$$\n\n*æ³¨æ„*ï¼šçŸ©é˜µä¸­çš„å…¬å¼ä»å¯é€šè¿‡$\\lambda = LI$å¯¼å‡ºï¼Œè¿™é‡Œçš„$L$æ—¢å¯ä»¥æ˜¯è‡ªæ„Ÿç³»æ•°ä¹Ÿå¯ä»¥æ˜¯äº’æ„Ÿç³»æ•°ï¼Œå…¶è¡¨ç¤ºæ„ä¹‰å³ä¸ºè‡ªæ„Ÿç£é“¾æˆ–äº’æ„Ÿç£é“¾ã€‚è¯¥çŸ©é˜µä¸­çš„äº’æ„Ÿç³»æ•°ä¹Ÿæ˜¯å¯é€†çš„ã€‚\n\nä¸Šå¼å¯æ”¹å†™ä¸ºï¼š\n$$\n\\begin{bmatrix}\\Psi_{abc}\\\\\\Psi_{fDQ}\\end{bmatrix}=\\begin{bmatrix}L_{ss}&L_{sr}\\\\L_{rs} & L_{rr}\\end{bmatrix}\\begin{bmatrix}I_{abc}\\\\I_{fDQ}\\end{bmatrix}\n$$\n\nå…¶ä¸­ï¼Œ$L_{ss}ã€L_{sr}$ä¸ºå®šã€è½¬å­è‡ªæ„Ÿç³»æ•°çŸ©é˜µï¼Œ$L_{sr}ã€L_{rs}$ä¸ºå®šã€è½¬å­äº’æ„Ÿç³»æ•°çŸ©é˜µã€‚\n\næ˜¾ç„¶ï¼Œç”±äºäº¤è½´ç­‰æ•ˆé˜»å°¼ç»•ç»„Qä¸ç›´è½´ç­‰æ•ˆé˜»å°¼ç»•ç»„Dï¼Œè¿˜æœ‰åŠ±ç£ç»•ç»„$f$çš„è½´çº¿åœ¨ç©ºé—´ä¸­ç›¸å·®90Â°ç”µè§’åº¦ï¼Œå› æ­¤äºŒè€…äº’æ„Ÿç³»æ•°ä¸º0ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆçŸ©é˜µä¸­$M_{fQ}ã€M_{DQ}ã€M_{Qf}ã€M_{QD}$å››è€…å‡ç­‰äº0ã€‚\n\n## å‡¸çº§åŒæ­¥ç”µæœºçš„è‡ªæ„Ÿç³»æ•°ä¸äº’æ„Ÿç³»æ•°\n### ç£åŠ¨åŠ¿ã€ç£å¯¼ã€è‡ªæ„Ÿç³»æ•°ã€äº’æ„Ÿç³»æ•°\nå›é¡¾ä¸€ä¸‹ç£å¯¼çš„æ¦‚å¿µï¼š\n> ç£å¯¼ï¼ˆmagnetic conductance,$\\mu$ï¼‰æ˜¯è¡¡é‡ç£æ€§ææ–™å¯¹ç£åœºçº¿çš„å¯¼é€šèƒ½åŠ›çš„ç‰©ç†é‡ï¼Œå®ƒç±»ä¼¼äºç”µå¯¼åœ¨ç”µè·¯ä¸­çš„ä½œç”¨ã€‚ç£å¯¼è¶Šå¤§ï¼Œè¡¨ç¤ºææ–™å¯¹ç£åœºçº¿çš„å¯¼é€šèƒ½åŠ›è¶Šå¼ºã€‚å…·ä½“æ¥è¯´ï¼Œç£å¯¼æ˜¯ç£é€šé‡ä¸ç£åŠ¨åŠ¿çš„æ¯”å€¼ï¼Œåæ˜ äº†ææ–™åœ¨ç£åœºä¸­çš„å¯¼ç£æ€§èƒ½ã€‚ç£å¯¼è¶Šå¤§ï¼Œè¯´æ˜è¯¥éƒ¨åˆ†å¯¹ç£é€šé‡çš„é˜»ç¢è¶Šå°ï¼Œå³å¯¼ç£èƒ½åŠ›è¶Šå¼ºï¼Œç£é˜»ï¼ˆmagnetic reluctanceï¼‰è¶Šå°ã€‚\n\n> ç£è·¯ä¸­çš„ç£å¯¼å®šä¹‰ä¸ºï¼š$\\Lambda = \\frac{\\Phi}{F}$ï¼Œå…¶ä¸­$\\Lambda$ä¸ºç£å¯¼ï¼Œå•ä½å®‰åŸ¹æ¯éŸ¦ä¼¯ï¼ˆ$A/Wb$ï¼‰ï¼Œ$\\Phi$ä¸ºç£é€šé‡ï¼Œå•ä½éŸ¦ä¼¯ï¼ˆ$Wb$ï¼‰ï¼Œ$F$ä¸ºç£åŠ¨åŠ¿ï¼Œå•ä½å®‰åŸ¹($A$)ã€‚\n\nå·²ç»è‡ªæ„Ÿç³»æ•°å®šä¹‰ä¸ºï¼š\n$$\nL = \\frac{N\\Phi}{I}\n$$\nç£å¯¼å®šä¹‰ä¸ºï¼š\n$$\n\\Lambda = \\frac{\\Phi}{F} = \\frac{1}{R_m}\n$$\n\næ ¹æ®ç£è·¯æ¬§å§†å®šå¾‹ï¼š\n$$\nF = \\Phi R_m = NI\n$$\nå¼ä¸­$F$ä¸ºä½œç”¨äºè¯¥ç£è·¯ä¸Šçš„ç£åŠ¨åŠ¿ï¼Œ$\\Phi$ä¸ºç£è·¯å†…ç£é€šé‡ï¼Œ$R_m$ä¸ºç£é˜»ã€‚\n\nè”ç«‹ä»¥ä¸Šå¼å­ï¼Œå¯å¯¼å‡ºï¼š\n$$\nL = N^2 \\Lambda\n$$\n\nè¯¥æ–¹æ³•ä¹Ÿå¯è¢«æ¨å¹¿è‡³åˆ†æä¸¤ä¸ªçº¿åœˆé—´äº’æ„Ÿç³»æ•°çš„å…³ç³»ã€‚\n\nç”±ä»¥ä¸Šæ¨å¯¼å¯çŸ¥ï¼š\n- çº¿åœˆè‡ªæ„Ÿç³»æ•°ä¸ºçº¿åœˆå†…é€šè¿‡å•ä½ç”µæµæ‰€äº§ç”Ÿçš„è‡ªæ„Ÿç£é“¾ï¼Œå…¶å¤§å°ä¸è¯¥çº¿åœˆåŒæ•°çš„å¹³æ–¹ï¼ˆ$N^2$ï¼‰åŠè‡ªæ„Ÿç£é€šæ‰€ç»ç£è·¯ç£å¯¼($\\mu$)çš„ä¹˜ç§¯æˆæ­£æ¯”\n- çº¿åœˆ1å’Œçº¿åœˆ2é—´çš„äº’æ„Ÿç³»æ•°ä¸ºçº¿åœˆ1å†…é€šè¿‡å•ä½ç”µæµæ‰€äº§ç”Ÿçš„ä¸çº¿åœˆ2ç›¸äº¤é“¾çš„äº’æ„Ÿç£é“¾ï¼Œå…¶å¤§å°ä¸ä¸¤çº¿åœˆåŒæ•°çš„ä¹˜ç§¯ï¼ˆ$N_1N_2$ï¼‰æˆæ­£æ¯”ï¼Œå¹¶ä¸äº’æ„Ÿç£é€šæ‰€ç»ç£è·¯çš„ç£å¯¼($\\mu$)æˆæ­£æ¯”\n\nå‡¸çº§åŒæ­¥ç”µæœºåœ¨è½¬å­æ—‹è½¬æ—¶ï¼Œæ˜¾ç„¶éƒ¨åˆ†ç»•ç»„ä¹‹é—´çš„ç›¸å¯¹ç©ºé—´ä½ç½®ä»¥åŠæ‰€å¯¹åº”ç£è·¯çš„ç£å¯¼éšè½¬å­ä½ç½®å˜åŒ–è€Œå˜åŒ–ï¼Œå› æ­¤ç›¸åº”çš„è‡ªæ„Ÿç³»æ•°$L$æˆ–äº’æ„Ÿç³»æ•°$M$å°†æ˜¯è½¬å­ä½ç½®è§’$\\theta$çš„å‡½æ•°ï¼Œå³æ—¶å˜å‡½æ•°ã€‚\n### å®šå­ç»•ç»„è‡ªæ„Ÿç³»æ•°\né¦–å…ˆåˆ†æå®šå­aç›¸ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°$L_{aa}$ã€‚å½“ç»•ç»„åŒæ•°ç¡®å®šæ—¶ï¼Œ$L_{aa}$çš„å¤§å°ä¸»è¦å–å†³äºå¯¹åº”ç£è·¯ç£å¯¼çš„å¤§å°ã€‚å½“aç›¸ç»•ç»„ä¸­è½´çº¿ä¸ç£æç›´è½´ï¼ˆdè½´ï¼‰è½´çº¿é‡åˆï¼Œå³$\\theta=0$æ—¶ï¼Œaç›¸ç»•ç»„ç£åœºå¯¹åº”ç£è·¯çš„ç£å¯¼$\\Lambda$æœ€å¤§ï¼Œå› è€Œåœ¨æ­¤ä½ç½®è‡ªæ„Ÿç³»æ•°è¾¾åˆ°æœ€å¤§å€¼$L_{aad}$ï¼›å½“è½¬å­æ—‹è½¬è‡³$\\theta = \\pi /2$ç”µå¼§åº¦æ—¶ï¼Œaç›¸ç»•ç»„è½´çº¿ä¸è½¬å­qè½´é‡åˆï¼Œå¯¹åº”ç£è·¯çš„ç£å¯¼æœ€å°ï¼Œè‡ªæ„Ÿç³»æ•°ä¸ºæœ€å°å€¼$L_{aaq}$ã€‚å½“è½¬å­æ—‹è½¬è‡³$\\theta = \\pi$ç”µå¼§åº¦æ—¶ï¼Œå¯¹åº”ç£è·¯çš„ç£å¯¼$\\Lambda$å’Œè‡ªæ„Ÿç³»æ•°$L$åˆè¾¾åˆ°æœ€å¤§å€¼ã€‚\n\n![aç›¸ç»•ç»„è‡ªæ„Ÿç³»æ•°](/images/1.1/azigan.png)\n\næ˜¾ç„¶aç›¸ç»•ç»„è‡ªæ„Ÿç³»æ•°éš$\\theta$çš„è§’çš„å˜åŒ–å¯ä»¥ç”¨ä½™å¼¦çº§æ•°è¡¨ç¤ºä¸ºï¼š\n$$\nL_{aa}=L_{aa0}+L_{aa2}cos{2\\theta}+L_{aa4}cos{4\\theta}+...\n$$\n\nå¯è§ç”¨è¯¥ç§æ–¹å¼è®¡ç®—ç»•ç»„è‡ªæ„Ÿç³»æ•°éå¸¸å¤æ‚ã€‚å°±å·¥ç¨‹è®¾è®¡è€Œè¨€ï¼Œä¸€èˆ¬åªéœ€è€ƒè™‘æ°”éš™çš„åŸºæ³¢ç£åŠ¨åŠ¿å’Œæ°”éš™çš„åŸºæ³¢ç£åœºã€‚\n\nä»…è€ƒè™‘éš™çš„åŸºæ³¢ç£åŠ¨åŠ¿å’Œæ°”éš™çš„åŸºæ³¢ç£åœºæ—¶ï¼Œaç›¸ç»•ç»„è‡ªæ„Ÿç³»æ•°$L_{aa}$ç”±ä»¥ä¸‹äºŒè€…æ„æˆï¼š\n- ä¸é€šè¿‡æ°”éš™çš„æ¼ç£åœºæ‰€å¯¹åº”çš„æ¼ç”µæ„Ÿ$L_{aal}$\n- é€šè¿‡æ°”éš™çš„ä¸»åˆæˆç£åœºå¯¹åº”çš„ä¸»ç”µæ„Ÿ$L_{aam}$\n\næ¼ç”µæ„Ÿ$L_{aal}$ä¸€èˆ¬ä»…å’Œæ¼ç£åœºçš„åˆ†å¸ƒæƒ…å†µä»¥åŠç£è·¯æ€§è´¨æœ‰å…³ï¼Œä¸è½¬å­ç©ºé—´ä½ç½®æ— å…³ï¼Œä¸ºä¸€å¸¸æ•°ã€‚ä¸»ç”µæ„Ÿ$L_{aam}$æ˜¯å…³äºè½¬å­ä½ç½®è§’$\\theta$çš„å‡½æ•°ã€‚\n\nä»¤aç›¸ç»•ç»„æœ‰æ•ˆåŒæ•°ä¸º$W$ï¼Œç”±ç£åŠ¨åŠ¿å®šä¹‰å¼ï¼Œç»•ç»„çº¿åœˆé€šè¿‡å•ä½ç”µæµæ‰€äº§ç”Ÿçš„åŸºæ³¢ç£åŠ¨åŠ¿ä¸º$F_{am}=W$ï¼Œè½´çº¿ä¸ºaè½´ã€‚å°†è¯¥ç£åŠ¨åŠ¿åˆ†è§£è‡³ç£å¯¼$\\Lambda$ä¸ºæ’å€¼çš„dè½´å’Œqè½´ä¸Šï¼Œå³$F_{amd}=Wcos\\theta$, $F_{amq}=-Wsin\\theta$ã€‚ä»¤dè½´å’Œqè½´çš„ç£å¯¼åˆ†åˆ«ä¸º$\\Lambda_d$å’Œ$\\Lambda_q$ï¼Œåˆ™aç›¸ç£åŠ¨åŠ¿åœ¨dè½´å’Œqè½´äº§ç”Ÿçš„åŸºæ³¢ç£é€šå¤§å°åˆ†åˆ«ä¸ºï¼š\n$$\n\\phi_d=F_{amd}\\Lambda_d=W\\Lambda_d cos\\theta\\\\\n\\phi_q=F_{amq}\\Lambda_q=-W\\Lambda_q sin\\theta\n$$\n\näºŒè€…ä¸aç›¸ç»•ç»„äº¤é“¾çš„è‡ªæ„Ÿç£é“¾ç­‰äºç›¸ç»•ç»„çš„æœ‰æ•ˆåŒæ•°$W$ä¸dè½´ã€qè½´ç£é€šåœ¨aè½´ä¸Šçš„åˆ†é‡ä¹˜ç§¯çš„ä»£æ•°å’Œï¼š\n$$\n\\Psi_{aam}=W(\\phi_d cos\\theta-\\phi_q sin\\theta)=W^2\\Lambda_d cos^2{\\theta}+W^2\\Lambda_q sin^2{\\theta}\n$$\n\naç›¸ç»•ç»„é€šè¿‡å•ä½ç”µæµæ—¶äº§ç”Ÿçš„ä¸»ç”µæ„Ÿçš„è¡¨è¾¾å¼ä¸ºï¼š\n$$\nL_{aam}=L_{aad}cos^2{\\theta}+L_{aaq}sin^2{\\theta}=\\frac{1}{2}(L_{aad}+L_{aaq})+\\frac{1}{2}(L_{aad}-L_{aaq})cos{2\\theta}\n$$\n\naç›¸ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°$L_{aa}$ä¸ºä¸»ç”µæ„Ÿ$L_{aam}$å’Œæ¼ç”µæ„Ÿ$L_{aal}$çš„ä»£æ•°å’Œï¼Œå³\n$$\nL_{aa} = L_{aam} + L_{aal} = L_{aa0}+L_{aa2}cos{2\\theta}\n$$\nåŒç†\n$$\nL_{bb} = L_{aa0}+L_{aa2}cos{2(\\theta-\\frac{2\\pi}{3})}\\\\\nL_{cc} = L_{aa0}+L_{aa2}cos{2(\\theta+\\frac{2\\pi}{3})}\n$$\nå¼ä¸­\n$$\nL_{aa0} = L_{aal}+\\frac{1}{2}(L_{aad}+L_{aaq})\\\\\nL_{aa2} = \\frac{1}{2}(L_{aad}-L_{aaq})\n$$\n\næ˜¾ç„¶ï¼Œå½“åªè€ƒè™‘ç©ºé—´åŸºæ³¢ç£åœºæ—¶ï¼Œå‡¸çº§åŒæ­¥ç”µæœºä¸‰ç›¸å®šå­ç»•ç»„äºŒç‚¹è‡ªæ„Ÿç³»æ•°åªæœ‰å¸¸æ•°é¡¹å’Œè½¬å­ä½ç½®è§’$\\theta$çš„äºŒæ¬¡é¡¹ï¼Œå…¶ä»–é«˜æ¬¡è°æ³¢é¡¹ä¸å­˜åœ¨ï¼Œç»™è®¡ç®—å¸¦æ¥å¾ˆå¤§çš„æ–¹ä¾¿ã€‚\n\n*æ³¨æ„*ï¼šéšçº§åŒæ­¥ç”µæœºå’Œæ„Ÿåº”ç”µæœºç”±äºå…·æœ‰å‡åŒ€åˆ†å¸ƒçš„æ°”éš™ï¼Œæ•…å„é¡¹ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°ä¸è½¬å­ä½ç½®è§’$\\theta$æ— å…³ï¼Œä¸ºä¸€å¸¸æ•°ã€‚\n\n### å®šå­ä¸¤ç›¸ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°\n\nå®šå­ä¸‰ç›¸ç»•ç»„ç»“æ„ç›¸åŒï¼Œä½†ç»•ç»„è½´çº¿åœ¨ç©ºé—´ä¸Šäº’å·®$2\\pi/3$ç”µå¼§åº¦ã€‚aç›¸ç»•ç»„é€šè¿‡å•ä½ç”µæµæ‰€äº§ç”Ÿçš„ä¸bç›¸ç»•ç»„ç›¸äº¤é“¾çš„äº’æ„Ÿç£é“¾ï¼Œæ­¤ä¸ºaã€bç›¸çš„äº’æ„Ÿç³»æ•°$M_{ab}$ã€‚\n\näº’æ„Ÿç³»æ•°ä¹Ÿç”±ä¸¤éƒ¨åˆ†æ„æˆï¼š\n- ä¸ä¸é€šè¿‡æ°”éš™çš„æ¼ç£é€šå¯¹åº”çš„äº’æ¼æ„Ÿç³»æ•°$M_{abl}$\n- ä¸é€šè¿‡æ°”éš™çš„ä¸»ç£é€šå¯¹åº”çš„äº’æ„Ÿç³»æ•°$M_{abm}$\n\nä¸è‡ªæ„Ÿç³»æ•°ç±»ä¼¼ï¼Œäº’æ¼æ„Ÿç³»æ•°$M_{abl}$ä¸ºä¸€å¸¸å€¼ï¼Œäº’æ„Ÿç³»æ•°$M_{abm}$éšè½¬å­ä½ç½®å˜åŒ–è€Œå˜åŒ–ã€‚\n\nä¸Šæ–‡å·²ç»æ±‚å‡ºä»…è€ƒè™‘ç©ºé—´åŸºæ³¢ç£åœºåˆ†å¸ƒä¸‹aç›¸ç»•ç»„å•ä½ç”µæµäº§ç”Ÿçš„ç›´è½´ç£é€š$\\phi_d$å’Œäº¤è½´ç£é€š$\\phi_q$ã€‚å®ƒä»¬ä¸bç›¸ç»•ç»„ç›¸äº¤é“¾çš„äº’æ„Ÿç£é“¾ï¼Œç­‰äºç›¸ç»•ç»„æœ‰æ•ˆåŒæ•°$W$ä¸å®ƒä»¬åœ¨bè½´ä¸Šçš„ç£é€šé‡åˆ†é‡ä¹˜ç§¯çš„ä»£æ•°å’Œï¼š\n$$\n\\begin{aligned}\n\\psi_{\\mathrm{abm}} & =W\\left[\\phi_{d} \\cos \\left(\\theta-\\frac{2 \\pi}{3}\\right)\\right]-W\\left[\\phi_{q} \\sin \\left(\\theta-\\frac{2 \\pi}{3}\\right)\\right] \\\\\n& =W^{2} \\Lambda_{d} \\cos \\theta \\cos \\left(\\theta-\\frac{2 \\pi}{3}\\right)+W^{2} \\Lambda_{q} \\sin \\theta \\sin \\left(\\theta-\\frac{2 \\pi}{3}\\right)\n\\end{aligned}\n$$\n\næ‰€ä»¥aç›¸ç»•ç»„é€šè¿‡å•ä½ç”µè·¯æ—¶äº§ç”Ÿçš„é€šè¿‡æ°”éš™çš„ç£é€šä¸bè½´ç»•ç»„ç›¸äº¤é“¾çš„äº’æ„Ÿç£é“¾ï¼Œå³aã€bç›¸é—´çš„äº’æ„Ÿç³»æ•°ä¸ºï¼š\n$$\nM_{abm}=L_{aad}cos\\theta cos(\\theta-\\frac{2\\pi}{3})+L_{aaq}sin\\theta sin(\\theta-\\frac{2\\pi}{3})\\\\\n=-\\frac{L_{aad}+L_{aaq}}{4}+\\frac{L_{aad}-L_{aaq}}{2}cos(2\\theta-\\frac{2\\pi}{3})\n$$\n\naç›¸å’Œbç›¸é—´çš„äº’æ„Ÿç³»æ•°$M_{ab}$åº”ä¸ºäº’æ¼ç”µæ„Ÿç³»æ•°$-M_{abl}$å’Œäº’ç”µæ„Ÿç³»æ•°$M_{abm}$ä¹‹å’Œï¼Œå³\n$$\nM_{ab}=-M_{abl}-\\frac{L_{aad}+L_{aaq}}{4}+\\frac{L_{aad}-L_{aaq}}{2}cos(2\\theta-\\frac{2\\pi}{3})\\\\\n= - M_{ab0}+L_{aa2}cos{2(\\theta + \\frac{2\\pi}{3})}\n$$\n\nåŒç†\n\n$$\nM_{bc}=- M_{ab0}+L_{aa2}cos{2\\theta}\\\\\nM_{ca}=- M_{ab0}+L_{aa2}cos{2(\\theta-\\frac{2\\pi}{3})}\n$$\n\nå¼ä¸­$M_{ab0} = M_{abl}+\\frac{L_{aad}+L_{aaq}}{4}$\n\nç”±äºä¸‰ç›¸ç»•ç»„è½´çº¿é—´å¤¹è§’äº’ä¸º120Â°ç”µè§’åº¦ï¼Œå…¶å€¼å¤§äº90Â°ï¼Œå› æ­¤å…¶äº’æ„Ÿç³»æ•°å‡ä¸ºè´Ÿå€¼ã€‚å®šå­ç»•ç»„bç›¸å’Œcç›¸é—´çš„äº’æ„Ÿç³»æ•°$M_{bc}$éšè½¬å­ä½ç½®çš„å˜åŒ–æ›²çº¿å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![bã€cç›¸ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°](/images/1.1/bchugan.png)\n\nå¯è§ï¼Œ$\\theta = 0$æ—¶ï¼Œbç›¸å’Œcç›¸çš„äº’æ„Ÿç³»æ•°çš„ç»å¯¹å€¼æœ€å°ï¼›$\\theta = \\pi /2$æ—¶ï¼Œäº’æ„Ÿç³»æ•°ç»å¯¹å€¼æœ€å¤§ï¼Œè¿™ä¸è‡ªæ„Ÿç³»æ•°çš„å˜åŒ–è§„å¾‹æ˜¯ç›¸åçš„ã€‚\n\n### å®šå­ç»•ç»„å’Œè½¬å­ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°\n#### å®šå­ç»•ç»„å’ŒåŠ±ç£ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°\nåŠ±ç£ç»•ç»„é€šè¿‡å•ä½ç”µæµæ—¶æ‰€äº§ç”Ÿçš„ä¸å®šå­aç›¸ç»•ç»„äº¤é“¾çš„äº’æ„Ÿç£é“¾å³ä¸ºå®šå­ç»•ç»„ä¸åŠ±ç£ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°$M_{af}$ã€‚äº’æ„Ÿç£é“¾éµå¾ªä»¥ä¸‹è§„å¾‹ï¼š\n\n- å½“åŠ±ç£ç»•ç»„dè½´ä¸aç›¸ç»•ç»„è½´çº¿é‡åˆæ—¶ï¼Œäº’æ„Ÿç£é“¾ä¸ºæœ€å¤§ï¼›\n- è½¬å­dè½´æ—‹è½¬90Â°ç”µè§’åº¦åï¼Œä¸¤è½´çº¿æ­£äº¤ï¼Œäº’æ„Ÿç£é“¾ä¸º0ï¼›\n- å½“è½¬å­dè½´æ—‹è½¬180Â°ç”µè§’åº¦æ—¶ï¼Œäº’æ„Ÿç£é“¾ä¸ºè´Ÿçš„æœ€å¤§å€¼ï¼›\n- å½“è½¬å­dè½´æ—‹è½¬270Â°ç”µè§’åº¦æ—¶ï¼Œä¸¤è½´çº¿æ­£äº¤ï¼Œäº’æ„Ÿç£é“¾ä¸º0ï¼›\n\nå› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æœ‰ï¼š\n$$\nM_{af} = M_{fa} = M_{af0}cos\\theta + M_{af3}cos{3\\theta}+...\n$$\n\nåŒç†å¯æ¨å¹¿è‡³bç›¸å’Œcç›¸ï¼š\n$$\nM_{bf} = M_{fb} = M_{af0}cos(\\theta-\\frac{2\\pi}{3}) + M_{af3}cos(\\theta-\\frac{2\\pi}{3})+...\\\\\nM_{cf} = M_{fc} = M_{af0}cos(\\theta+\\frac{2\\pi}{3}) + M_{af3}cos(\\theta+\\frac{2\\pi}{3})+...\n$$\n\nä»…è€ƒè™‘åŸºæ³¢ç£é€šæ—¶ï¼Œæ˜¾ç„¶äº’æ„Ÿç³»æ•°åªæœ‰åŸºæ³¢åˆ†é‡ï¼Œå³ï¼š\n$$\nM_{af} = M_{fa} = M_{af0}cos\\theta \\\\\nM_{bf} = M_{fb} = M_{af0}cos(\\theta-\\frac{2\\pi}{3})\\\\\nM_{cf} = M_{fc} = M_{af0}cos(\\theta+\\frac{2\\pi}{3}) \n$$\nå¼ä¸­$M_{af0}$ä¸ºaè½´ä¸åŠ±ç£ç»•ç»„dè½´é‡åˆæ—¶æ‰€å…·æœ‰çš„æœ€å¤§äº’æ„Ÿç³»æ•°ã€‚ä¸‹æ ‡ä¸­çš„â€œ0â€è¡¨ç¤ºè¯¥äº’æ„Ÿç³»æ•°è®¡ç®—æ—¶ä»…è€ƒè™‘äº†åŸºæ³¢åˆ†é‡ã€‚\n\n$M_{af}$éš$\\theta$çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n![å®šå­aç›¸ç»•ç»„ä¸åŠ±ç£ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°](/images/1.1/maf.png)\n\n#### å®šå­ç»•ç»„ä¸ç›´è½´é˜»å°¼ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°\nç›´è½´é˜»å°¼ç»•ç»„ä¸åŠ±ç£ç»•ç»„è½´çº¿é‡åˆï¼Œæ•…å®šå­ç»•ç»„ä¸ç›´è½´é˜»å°¼ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°å˜åŒ–è§„å¾‹å¯ç”±å®šå­ç»•ç»„ä¸åŠ±ç£ç»•ç»„çš„äº’æ„Ÿç³»æ•°å˜åŒ–è§„å¾‹æ¨å¹¿å¾—æ¥ï¼ˆä»…è€ƒè™‘åŸºæ³¢åˆ†é‡ï¼‰ï¼š\n$$\nM_{aD} = M_{Da} = M_{aD0}cos\\theta \\\\\nM_{bD} = M_{Db} = M_{aD0}cos(\\theta-\\frac{2\\pi}{3})\\\\\nM_{cD} = M_{Dc} = M_{aD0}cos(\\theta+\\frac{2\\pi}{3}) \n$$\nå¼ä¸­$M_{aD0}$ä¸ºå®šå­ç»•ç»„aè½´ä¸ç›´è½´é˜»å°¼ç»•ç»„Dè½´é‡åˆæ—¶æ‰€å…·æœ‰çš„æœ€å¤§äº’æ„Ÿç³»æ•°ã€‚\n\n#### å®šå­ç»•ç»„ä¸äº¤è½´é˜»å°¼ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°\næ˜¾ç„¶äº¤è½´æå‰ç›´è½´90Â°ç”µè§’åº¦ï¼Œä»¥$\\theta + \\frac{\\pi}{2}$ä»£æ¢ä¸Šå°èŠ‚å…¬å¼ä¸­çš„$\\theta$è§’ï¼Œå¹¶è€ƒè™‘ç›´è½´å’Œäº¤è½´çš„ç£å¯¼ä¸åŒï¼Œæ¨å¯¼å¾—ï¼ˆä»…è€ƒè™‘åŸºæ³¢åˆ†é‡ï¼‰ï¼š\n$$\nM_{aQ} = M_{Qa} = M_{aQ0}cos\\theta \\\\\nM_{bQ} = M_{Qb} = M_{aQ0}cos(\\theta-\\frac{2\\pi}{3})\\\\\nM_{cQ} = M_{Qc} = M_{aQ0}cos(\\theta+\\frac{2\\pi}{3}) \n$$\nå¼ä¸­$M_{aQ0}$ä¸ºå®šå­ç»•ç»„aè½´ä¸äº¤è½´é˜»å°¼ç»•ç»„Qè½´é‡åˆæ—¶æ‰€å…·æœ‰çš„æœ€å¤§äº’æ„Ÿç³»æ•°ã€‚\n\n#### è½¬å­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°\nè½¬å­ç»•ç»„é€šè¿‡å•ä½ç”µæµæ—¶äº§ç”Ÿçš„è‡ªæ„Ÿç£é“¾å³ä¸ºè½¬å­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°ã€‚ç”±äºå®šå­é“å¿ƒä¸ºåœ†ç¯å½¢ï¼Œè½¬å­ä¸Šå„ç»•ç»„äº§ç”Ÿçš„è‡ªæ„Ÿç£é“¾å¤§å°ä¸è½¬å­ä½ç½®æ— å…³ï¼Œå‡ä¸ºæ’å€¼ã€‚\n\nåŠ±ç£ç»•ç»„è‡ªæ„Ÿç³»æ•°ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå³\n$$\nL_f = L_{fl} + L_{fm}\n$$\nå¼ä¸­ $L_{fl}$å¯¹åº”åŠ±ç£ç»•ç»„æ¼ç£é€šçš„æ¼ç”µæ„Ÿç³»æ•°ï¼Œ$L_{fm}$å¯¹åº”åŠ±ç£ç»•ç»„æ°”éš™ç£é€šçš„ä¸»ç”µæ„Ÿç³»æ•°ã€‚\n\nç›´è½´é˜»å°¼ç»•ç»„å’Œäº¤è½´é˜»å°¼ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°åˆ†åˆ«ä¸ºï¼š\n\n$$\nL_D = L_{Dl} + L_{Dm} \\\\\n\nL_Q = L_{Ql} + L_{Qm}\n$$\n\nå¼ä¸­ $L_{Dl}$å’Œ$L_{Ql}$å¯¹åº”äºDã€Qç»•ç»„æ¼ç£é€šçš„æ¼ç”µæ„Ÿç³»æ•°ï¼Œ$L_{Dm}$å’Œ$L_{Qm}$å¯¹åº”äºDã€Qç»•ç»„æ°”éš™ç£é€šçš„ä¸»ç”µæ„Ÿç³»æ•°ã€‚\n\n#### è½¬å­ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°\nå› è½¬å­åˆ†åˆ«å¯¹ç›´è½´å’Œäº¤è½´å¯¹ç§°ï¼Œä¸”ä¸¤è½´æ­£äº¤ï¼Œæ•…äº¤è½´é˜»å°¼ç»•ç»„Qä¸ç›´è½´é˜»å°¼ç»•ç»„Dã€åŠ±ç£ç»•ç»„$f$é—´çš„äº’æ„Ÿç³»æ•°ä¸º0.ç»•ç»„Dä¸ç»•ç»„$f$åŒåœ¨ç›´è½´ä¸Šä¸”å¼ä¸­ç›¸å¯¹é™æ­¢ï¼Œæœ‰\n$$\nM_{fD}=M_{Df}=M_{fDl}+M_{fDm}\n$$\n\n### å°ç»“\nä»¥ä¸Šè®¨è®ºçš„å‡¸æåŒæ­¥ç”µæœºç”µæ„Ÿç³»æ•°ï¼Œä»å˜åŒ–è§„å¾‹ä¸Šçœ‹ï¼Œå¯åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š\n- å®šå­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°å’Œäº’æ„Ÿç³»æ•°ã€‚å…¶å˜åŒ–å‘¨æœŸä¸º$\\pi$ã€‚å¼•èµ·è¿™ç±»ç”µæ„Ÿç³»æ•°å˜åŒ–çš„åŸå› æ˜¯è½¬å­ç›´è½´å’Œäº¤è½´çš„ç£å¯¼ä¸åŒ,å½“ç”µæœºè½¬å­ä¸ºåœ†æŸ±å½¢æ—¶,å¦‚éšæåŒæ­¥ç”µæœºåŠæ„Ÿåº”ç”µæœºï¼Œè½¬å­ç›´è½´å’Œäº¤è½´çš„ç£å¯¼ç›¸åŒï¼Œåˆ™ç”µæ„Ÿç³»æ•°$L_{aad}=L_{aaq}$ï¼Œå®šå­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°å’Œäº’æ„Ÿç³»æ•°å‡ä¸ºå¸¸æ•°ï¼Œä¸è½¬å­ä½ç½®è§’$\\theta$æ— å…³ã€‚\n\n- å®šå­ä¸è½¬å­ç»•ç»„é—´çš„äº’æ„Ÿç³»æ•°ã€‚å…¶å˜åŒ–å‘¨æœŸä¸º2$\\pi$ã€‚å¼•èµ·è¿™ç±»ç”µæ„Ÿç³»æ•°å˜åŒ–çš„åŸå› æ˜¯å®šå­ç»•ç»„è½´çº¿ä¸è½¬å­ç»•ç»„è½´çº¿é—´æœ‰ç›¸å¯¹è¿åŠ¨ï¼Œå¯¼è‡´äº’æ„Ÿç£é“¾å‘¨æœŸæ€§å˜åŒ–ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨éšæåŒæ­¥ç”µæœºå’Œæ„Ÿåº”ç”µæœºä¸­ï¼Œè¿™ç±»äº’æ„Ÿç³»æ•°ä»æ˜¯è½¬å­ä½ç½®è§’$\\theta$çš„å‡½æ•°ã€‚\n\n- è½¬å­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°ä¸äº’æ„Ÿç³»æ•°ã€‚ç”±äºå®šå­é“å¿ƒä¸ºåœ†ç¯å½¢ï¼Œå¯¹è½¬å­ç›´è½´æˆ–äº¤è½´è€Œè¨€ï¼Œç£å¯¼æ˜¯ä¸å˜çš„ï¼Œä¸”è½¬å­ç»•ç»„è½´çº¿é—´æ— ç›¸å¯¹è¿åŠ¨ã€‚ä¸Šè¿°å¼•èµ·ç”µæ„Ÿç³»æ•°å˜åŒ–çš„ä¸¤ä¸ªåŸå› å‡ä¸å­˜åœ¨ï¼Œæ•…è½¬å­ç»•ç»„çš„è‡ªæ„Ÿç³»æ•°ä¸äº’æ„Ÿç³»æ•°å‡ä¸ºå¸¸æ•°ã€‚\n","categories":["ç”µæ°”å·¥ç¨‹"]}]