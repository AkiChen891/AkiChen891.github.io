

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">

<head>
  <meta name="google-site-verification" content="Qd4BJop_tJyti_Gc8cDS3G09bPdOfn-O0if6QYHhtXY" />
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon.png">
  <link rel="icon" href="/images/favicon_mos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#233BA7">
  <meta name="author" content="Aki Chen">
  <meta name="keywords" content="">
  
    <meta name="description" content="官方U-Boot下载 Github 下载后拷贝tar.bz2至Linux，然后tar -vxjf  U-boot工程目录  除了文件夹之外，还有一些文件：   验证defconfig cd &#x2F;configs&#x2F;，确认存在有I.MX6ULL的配置文件：  新版本uboot中mx6ull_14x14_evk_defconfig用于传统的非安全启动（Non-Secure Boot）模式，而mx6ull_">
<meta property="og:type" content="article">
<meta property="og:title" content="NXP 官方u-boot移植和启动过程">
<meta property="og:url" content="http://akichen891.github.io/2025/03/07/uboot%E7%A7%BB%E6%A4%8D/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="官方U-Boot下载 Github 下载后拷贝tar.bz2至Linux，然后tar -vxjf  U-boot工程目录  除了文件夹之外，还有一些文件：   验证defconfig cd &#x2F;configs&#x2F;，确认存在有I.MX6ULL的配置文件：  新版本uboot中mx6ull_14x14_evk_defconfig用于传统的非安全启动（Non-Secure Boot）模式，而mx6ull_">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://akichen891.github.io/images/linux/uboot_7.png">
<meta property="og:image" content="http://akichen891.github.io/images/linux/uboot_8.png">
<meta property="og:image" content="http://akichen891.github.io/images/linux/uboot_1.png">
<meta property="og:image" content="http://akichen891.github.io/images/linux/uboot_5.png">
<meta property="og:image" content="http://akichen891.github.io/images/linux/uboot_6.png">
<meta property="og:image" content="http://akichen891.github.io/images/linux/uboot_9.png">
<meta property="article:published_time" content="2025-03-07T05:58:29.000Z">
<meta property="article:modified_time" content="2025-03-18T13:54:23.159Z">
<meta property="article:author" content="Aki Chen">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://akichen891.github.io/images/linux/uboot_7.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>NXP 官方u-boot移植和启动过程 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"akichen891.github.io","root":"/","version":"1.9.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Aki&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/images/Ringlan.JPG') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">NXP 官方u-boot移植和启动过程</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-07 13:58" pubdate>
          2025年3月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          34 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">NXP 官方u-boot移植和启动过程</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="官方u-boot下载"><a class="markdownIt-Anchor" href="#官方u-boot下载"></a> 官方U-Boot下载</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/nxp-imx/uboot-imx">Github</a><br>
下载后拷贝<code>tar.bz2</code>至Linux，然后<code>tar -vxjf</code></p>
<h2 id="u-boot工程目录"><a class="markdownIt-Anchor" href="#u-boot工程目录"></a> U-boot工程目录</h2>
<p><img src="/images/linux/uboot_7.png" srcset="/img/loading.gif" lazyload alt="编译后的uboot源码"><br>
除了文件夹之外，还有一些文件：<br>
<img src="/images/linux/uboot_8.png" srcset="/img/loading.gif" lazyload alt="编译后的uboot源码"></p>
<h2 id="验证defconfig"><a class="markdownIt-Anchor" href="#验证defconfig"></a> 验证defconfig</h2>
<p><code>cd /configs/</code>，确认存在有I.MX6ULL的配置文件：</p>
<p><img src="/images/linux/uboot_1.png" srcset="/img/loading.gif" lazyload alt="mx6ull配置文件"></p>
<p>新版本uboot中<code>mx6ull_14x14_evk_defconfig</code>用于传统的非安全启动（Non-Secure Boot）模式，而<code>mx6ull_14x14_evk_plugin_defconfig</code>支持安全启动（Secure Boot），允许 U-Boot 在 ROM 加载阶段执行自定义代码，通常用于 HAB 安全启动初始化（如 DRAM 训练）。通常使用前者即可。</p>
<h2 id="添加变量至顶层makefile"><a class="markdownIt-Anchor" href="#添加变量至顶层makefile"></a> 添加变量至顶层Makefile</h2>
<p>在uboot根目录下的顶层Makefile中添加：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ARCH</span>=arm<br><span class="hljs-attr">CROSS_COMPILE</span>=arm-linux-gnueabihf-<br></code></pre></td></tr></table></figure>
<h2 id="编写make用shell编译"><a class="markdownIt-Anchor" href="#编写make用shell编译"></a> 编写make用Shell，编译</h2>
<ol>
<li><code>touch mx6ull_14x14_evk.sh</code></li>
<li></li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/bash</span><br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- distclean<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- mx6ull_14x14_evk_emmc_defconfig<br>make <span class="hljs-attribute">V</span>=1 <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- -j16<br></code></pre></td></tr></table></figure>
<ol start="3">
<li><code>chmod 777 mx6ull_14x14_evk.sh</code></li>
<li><code>./mx6ull_14x14_evk.sh</code>，编译</li>
</ol>
<p>这里用的uboot是NXP最新的分支<code>v2022.04</code>，这个uboot版本比较新，如果用老版本的交叉编译器会报错，因为它不支持比较新的语法。这里使用的uboot、kernel和编译器的版本都为：</p>
<ul>
<li>uboot：<code>v2022.04</code></li>
<li>kernel：<code>if 6.6y</code></li>
<li>arm-linux-gnueabihf-gcc: <code>7.5.0</code></li>
</ul>
<p>编译完成后，<code>imxdownload</code>烧录至SD卡，设置开发板从SD卡启动。</p>
<p>此时Uboot启动之后，由于LCD未做配置，LCD上是不会显示NXP的Logo的。下一步是修改LCD驱动。</p>
<h2 id="修改lcd驱动"><a class="markdownIt-Anchor" href="#修改lcd驱动"></a> 修改LCD驱动</h2>
<p>IO部分不用修改，官方和开发板一致，仅需修改参数。较老版本的LCD参数在<code>board/freescale/mx6ull_aki/mx6ull_14x14_evk_emmc.c</code>的<code>display_info_t</code>结构体里。但是新版本uboot全部把诸如LCD之类的外设配置参数全部移到了设备树中。并且，imx6ull是由imx6ul这块板子拓展而来的，二者的设备树也呈非常明显的层次关系，即先读imx6ul的设备树，再读imx6ull的，所以很多外设节点都在<code>/arch/arm/dts/imx6ul-14x14-evk.dtsi</code>这个设备树文件中定义。</p>
<p>打开该设备树文件，找到：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-variable">&amp;lcdif</span> <span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">pinctrl-names</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">;</span><br>	pinctrl<span class="hljs-number">-0</span> = <span class="hljs-params">&lt;<span class="hljs-variable">&amp;pinctrl_lcdif_dat</span></span><br><span class="hljs-params">		     <span class="hljs-variable">&amp;pinctrl_lcdif_ctrl</span>&gt;</span><span class="hljs-punctuation">;</span><br><br>	<span class="hljs-attr">display</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-variable">&amp;display0</span>&gt;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;okay&quot;</span><span class="hljs-punctuation">;</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">	display0:</span> <span class="hljs-title class_">display@0</span> <span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">bits-per-pixel</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">24</span>&gt;</span><span class="hljs-punctuation">;</span><br>		<span class="hljs-attr">bus-width</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">24</span>&gt;</span><span class="hljs-punctuation">;</span><br><br>		<span class="hljs-title class_">display-timings</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">native-mode</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-variable">&amp;timing0</span>&gt;</span><span class="hljs-punctuation">;</span><br><span class="hljs-symbol">			timing0:</span> <span class="hljs-title class_">timing0</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">clock-frequency</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">51200000</span>&gt;</span><span class="hljs-punctuation">;</span>	<span class="hljs-comment">//像素时钟频率，Hz</span><br>			<span class="hljs-attr">hactive</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">1024</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//水平可见像素数（水平分辨率）</span><br>			<span class="hljs-attr">vactive</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">600</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//垂直可见像素数（垂直分辨率）</span><br>			<span class="hljs-attr">hfront-porch</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">160</span>&gt;</span><span class="hljs-punctuation">;</span>	<span class="hljs-comment">//水平前肩，HFP</span><br>			<span class="hljs-attr">hback-porch</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">140</span>&gt;</span><span class="hljs-punctuation">;</span>	<span class="hljs-comment">//水平后肩，HBP</span><br>			<span class="hljs-attr">hsync-len</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">20</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//水平同步脉冲，HSPW</span><br>			<span class="hljs-attr">vback-porch</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">20</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//水平后肩，VBP</span><br>			<span class="hljs-attr">vfront-porch</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">12</span>&gt;</span><span class="hljs-punctuation">;</span>	<span class="hljs-comment">//水平前肩，VFP</span><br>			<span class="hljs-attr">vsync-len</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">3</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//垂直同步脉冲，VSPW</span><br><br>			<span class="hljs-attr">hsync-active</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">0</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//水平同步信号极性</span><br>			<span class="hljs-attr">vsync-active</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">0</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//垂直同步信号极性</span><br>			<span class="hljs-attr">de-active</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">1</span>&gt;</span><span class="hljs-punctuation">;</span>		<span class="hljs-comment">//数据使能，高电平有效</span><br>			<span class="hljs-attr">pixelclk-active</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">0</span>&gt;</span><span class="hljs-punctuation">;</span>	<span class="hljs-comment">//下降沿采样</span><br>			<span class="hljs-punctuation">&#125;;</span><br>		<span class="hljs-punctuation">&#125;;</span><br>	<span class="hljs-punctuation">&#125;;</span><br><span class="hljs-punctuation">&#125;;</span><br></code></pre></td></tr></table></figure>
<p>按注释修改即可。新版设备树似乎没有定义LCD名字的地方，感觉不是那么在意设备名，毕竟都用设备树了。</p>
<h2 id="联网"><a class="markdownIt-Anchor" href="#联网"></a> 联网</h2>
<h3 id="主机部分"><a class="markdownIt-Anchor" href="#主机部分"></a> 主机部分</h3>
<p>物理部分：路由器WAN连接校园网，LAN1接电脑，LAN2接开发板ENET2（网卡1）。</p>
<p>VMware需开启桥接模式：<br>
<img src="/images/linux/uboot_5.png" srcset="/img/loading.gif" lazyload alt="桥接模式"></p>
<p>虚拟网络编辑器中一般会自动设置桥接网卡，不用手动设置。桥接模式下虚拟机和物理主机一样存在于局域网中，可以和主机相通，和互联网相通，和局域网中其它主机相通。</p>
<p>配置成桥接模式后虚拟机的IP、网关、DNS、netmask等全部会自动配置。在虚拟机中<code>ifconfig</code>：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ens33</span>: flags=<span class="hljs-number">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="hljs-number">1500</span><br>        <span class="hljs-attribute">inet</span> <span class="hljs-number">192.168.1.105</span>  netmask <span class="hljs-number">255.255.255.0</span>  broadcast <span class="hljs-number">192.168.1.255</span><br>        <span class="hljs-attribute">ether</span> <span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:<span class="hljs-number">0</span>d:<span class="hljs-number">4</span>a:<span class="hljs-number">09</span>  txqueuelen <span class="hljs-number">1000</span>  (以太网)<br>        <span class="hljs-attribute">RX</span> packets <span class="hljs-number">4642</span>  bytes <span class="hljs-number">4241810</span> (<span class="hljs-number">4</span>.<span class="hljs-number">2</span> MB)<br>        <span class="hljs-attribute">RX</span> errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span>  overruns <span class="hljs-number">0</span>  frame <span class="hljs-number">0</span><br>        <span class="hljs-attribute">TX</span> packets <span class="hljs-number">2980</span>  bytes <span class="hljs-number">400799</span> (<span class="hljs-number">400</span>.<span class="hljs-number">7</span> KB)<br>        <span class="hljs-attribute">TX</span> errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">5</span> overruns <span class="hljs-number">0</span>  carrier <span class="hljs-number">0</span>  collisions <span class="hljs-number">0</span><br><br><span class="hljs-attribute">lo</span>: flags=<span class="hljs-number">73</span>&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="hljs-number">65536</span><br>        <span class="hljs-attribute">inet</span> <span class="hljs-number">127.0.0.1</span>  netmask <span class="hljs-number">255.0.0.0</span><br>        <span class="hljs-attribute">inet6</span> ::<span class="hljs-number">1</span>  prefixlen <span class="hljs-number">128</span>  scopeid <span class="hljs-number">0</span>x10&lt;host&gt;<br>        <span class="hljs-attribute">loop</span>  txqueuelen <span class="hljs-number">1000</span>  (本地环回)<br>        <span class="hljs-attribute">RX</span> packets <span class="hljs-number">1298</span>  bytes <span class="hljs-number">110055</span> (<span class="hljs-number">110</span>.<span class="hljs-number">0</span> KB)<br>        <span class="hljs-attribute">RX</span> errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span>  overruns <span class="hljs-number">0</span>  frame <span class="hljs-number">0</span><br>        <span class="hljs-attribute">TX</span> packets <span class="hljs-number">1298</span>  bytes <span class="hljs-number">110055</span> (<span class="hljs-number">110</span>.<span class="hljs-number">0</span> KB)<br>        <span class="hljs-attribute">TX</span> errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span> overruns <span class="hljs-number">0</span>  carrier <span class="hljs-number">0</span>  collisions <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>此时主机的IPv4地址为192.168.1.100，可以看到桥接模式已经生效，主机和虚拟机处于同一个网段下。</p>
<h3 id="板级部分"><a class="markdownIt-Anchor" href="#板级部分"></a> 板级部分</h3>
<p>官方的NXP IMX6ULL EVK开发板使用的不是LAN8720A这个IC，因此需要修改一系列设置。好在官方的板子和正点原子阿尔法开发板的PHY物理地址是一致的，这点从设备树里可以看到：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">&amp;fec1 &#123;<br>	pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;<br>	pinctrl-0 = <span class="hljs-variable">&lt;&amp;pinctrl_enet1&gt;</span>;<br>	phy-mode = <span class="hljs-string">&quot;rmii&quot;</span>;<br>	phy-handle = <span class="hljs-variable">&lt;&amp;ethphy0&gt;</span>;<br>  phy-reset-gpios = <span class="hljs-variable">&lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;</span>;<br>  phy-reset-duration = <span class="hljs-variable">&lt;100&gt;</span>;<br>  phy-reset-post-delay = <span class="hljs-variable">&lt;100&gt;</span>;<br>	status = <span class="hljs-string">&quot;disable&quot;</span>;<br>&#125;;<br><br>&amp;fec2 &#123;<br>	pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;<br>	pinctrl-0 = <span class="hljs-variable">&lt;&amp;pinctrl_enet2&gt;</span>;<br>	phy-mode = <span class="hljs-string">&quot;rmii&quot;</span>;<br>	phy-handle = <span class="hljs-variable">&lt;&amp;ethphy1&gt;</span>;<br>  phy-reset-gpios = <span class="hljs-variable">&lt;&amp;gpio5 8 GPIO_ACTIVE_LOW&gt;</span>;<br>  phy-reset-duration = <span class="hljs-variable">&lt;100&gt;</span>;<br>  phy-reset-post-delay = <span class="hljs-variable">&lt;100&gt;</span>;<br>	status = <span class="hljs-string">&quot;okay&quot;</span>;<br><br>	mdio &#123;<br>		<span class="hljs-comment">#address-cells = &lt;1&gt;;</span><br>		<span class="hljs-comment">#size-cells = &lt;0&gt;;</span><br><br>		ethphy0: ethernet-phy<span class="hljs-meta">@2</span> &#123;<br>			reg = <span class="hljs-variable">&lt;2&gt;</span>;	//PHY0物理地址为2<br>			micrel,led-mode = <span class="hljs-variable">&lt;1&gt;</span>;<br>			clocks = <span class="hljs-variable">&lt;&amp;clks IMX6UL_CLK_ENET_REF&gt;</span>;<br>			clock-names = <span class="hljs-string">&quot;rmii-ref&quot;</span>;<br>		&#125;;<br><br>		ethphy1: ethernet-phy<span class="hljs-meta">@1</span> &#123;<br>			reg = <span class="hljs-variable">&lt;1&gt;</span>;	//PHY1物理地址为1<br>			micrel,led-mode = <span class="hljs-variable">&lt;1&gt;</span>;<br>			clocks = <span class="hljs-variable">&lt;&amp;clks IMX6UL_CLK_ENET2_REF&gt;</span>;<br>			clock-names = <span class="hljs-string">&quot;rmii-ref&quot;</span>;<br>		&#125;;<br>	&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h3 id="初始化检查"><a class="markdownIt-Anchor" href="#初始化检查"></a> 初始化检查</h3>
<p>检查<code>/common/board_r.c</code>，其中从网络初始化入口<code>initr_net</code>开始Uboot会进行网络设置，其中<code>initr_net</code>会调用<code>eth_initialize()</code>进行网络初始化，然后调用<code>reset_phy()</code>对PHY进行复位，而<code>phy_init()</code>中有以下条件宏语句：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">phy_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>...<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PHY_MICREL_KSZ8XXX</span><br>    <span class="hljs-built_in">phy_micrel_ksz8xxx_init</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PHY_MICREL_KSZ90X1</span><br>    <span class="hljs-built_in">phy_micrel_ksz90x1_init</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PHY_SMSC</span><br>    <span class="hljs-built_in">phy_smsc_init</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>...<br>    <span class="hljs-built_in">genphy_init</span>();<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>显然这是根据<code>defconfig</code>里的键值来对应不同的PHY初始化函数。阿尔法开发板上的LAN8720A是SMSC公司生产的，因此根据<code>phy_init</code>，<code>defconfig</code>里要设置<code>CONFIG_PHY_SMSC=y</code>才会触发<code>phy_smsc_init()</code>这个函数。</p>
<p>打开<code>/configs/imx6ull_14x14_evk_emmc_defconfig</code>，删除或屏蔽：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_PHY_MICREL</span>=y<br><span class="hljs-attr">CONFIG_PHY_MICREL_KSZ8XXX</span>=y<br></code></pre></td></tr></table></figure>
<p>添加：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_PHY_SMSC</span>=y<br></code></pre></td></tr></table></figure>
<h3 id="配置fec复位管脚"><a class="markdownIt-Anchor" href="#配置fec复位管脚"></a> 配置fec复位管脚</h3>
<p><code>fecmxc_probe</code>函数中还调用了<code>fec_gpio_reset()</code>来复位fec网卡：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xl">#<span class="hljs-keyword">if</span> CONFIG_IS_ENABLED(DM_GPIO)<br>	fec_gpio_reset(priv);<br>#endif<br>	<span class="hljs-comment">/* Reset chip. */</span><br>	<span class="hljs-function"><span class="hljs-title">writel</span>(readl(&amp;priv-&gt;</span><span class="hljs-function"><span class="hljs-title">eth</span>-&gt;</span>ecntrl) | FEC_ECNTRL_RESET,<br>	       &amp;<span class="hljs-function"><span class="hljs-title">priv</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">eth</span>-&gt;</span>ecntrl);<br>	start = get_timer(<span class="hljs-number">0</span>);<br>	<span class="hljs-function"><span class="hljs-title">while</span> (readl(&amp;priv-&gt;</span><span class="hljs-function"><span class="hljs-title">eth</span>-&gt;</span>ecntrl) &amp; FEC_ECNTRL_RESET) &#123;<br>		<span class="hljs-keyword">if</span> (get_timer(start) &gt; (CONFIG_SYS_HZ * <span class="hljs-number">5</span>)) &#123;<br>			printf(<span class="hljs-string">&quot;FEC MXC: Timeout resetting chip\n&quot;</span>);<br>			goto err_timeout;<br>		&#125;<br>		udelay(<span class="hljs-number">10</span>);<br>	&#125;<br></code></pre></td></tr></table></figure>
<p>而这里设备树会使用<code>fecmxc_of_to_plat</code>这个OF函数来读取节点信息到驱动，该函数中有：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs rust">#<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">CONFIG_IS_ENABLED</span>(DM_GPIO)<br>	ret = <span class="hljs-title function_ invoke__">gpio_request_by_name</span>(dev, <span class="hljs-string">&quot;phy-reset-gpios&quot;</span>, <span class="hljs-number">0</span>,<br>				   &amp;<span class="hljs-keyword">priv</span><span class="hljs-punctuation">-&gt;</span>phy_reset_gpio, GPIOD_IS_OUT);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* property is optional, don&#x27;t return error! */</span><br><br>	<span class="hljs-keyword">priv</span><span class="hljs-punctuation">-&gt;</span>reset_delay = <span class="hljs-title function_ invoke__">dev_read_u32_default</span>(dev, <span class="hljs-string">&quot;phy-reset-duration&quot;</span>, <span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">priv</span><span class="hljs-punctuation">-&gt;</span>reset_delay &gt; <span class="hljs-number">1000</span>) &#123;<br>		<span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;FEC MXC: phy reset duration should be &lt;= 1000ms\n&quot;</span>);<br>		<span class="hljs-comment">/* property value wrong, use default value */</span><br>		<span class="hljs-keyword">priv</span><span class="hljs-punctuation">-&gt;</span>reset_delay = <span class="hljs-number">1</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">priv</span><span class="hljs-punctuation">-&gt;</span>reset_post_delay = <span class="hljs-title function_ invoke__">dev_read_u32_default</span>(dev,<br>						      <span class="hljs-string">&quot;phy-reset-post-delay&quot;</span>,<br>						      <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">priv</span><span class="hljs-punctuation">-&gt;</span>reset_post_delay &gt; <span class="hljs-number">1000</span>) &#123;<br>		<span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;FEC MXC: phy reset post delay should be &lt;= 1000ms\n&quot;</span>);<br>		<span class="hljs-comment">/* property value wrong, use default value */</span><br>		<span class="hljs-keyword">priv</span><span class="hljs-punctuation">-&gt;</span>reset_post_delay = <span class="hljs-number">0</span>;<br>	&#125;<br>#endif<br></code></pre></td></tr></table></figure>
<p>可以看到这里依赖节点的三个用于描述复位的值：</p>
<ul>
<li><code>phy-reset-gpios</code></li>
<li><code>phy-reset-duration</code></li>
<li><code>phy-reset-post-delay</code></li>
</ul>
<p>回到设备树，将这三个属性加进节点：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">&amp;fec1 &#123;<br>	pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;<br>	pinctrl-0 = <span class="hljs-variable">&lt;&amp;pinctrl_enet1&gt;</span>;<br>	phy-mode = <span class="hljs-string">&quot;rmii&quot;</span>;<br>	phy-handle = <span class="hljs-variable">&lt;&amp;ethphy0&gt;</span>;<br>    phy-reset-gpios = <span class="hljs-variable">&lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;</span>;<br>    phy-reset-duration = <span class="hljs-variable">&lt;100&gt;</span>;<br>    phy-reset-post-delay = <span class="hljs-variable">&lt;100&gt;</span>;<br>	status = <span class="hljs-string">&quot;disable&quot;</span>;<br>&#125;;<br><br>&amp;fec2 &#123;<br>	pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;<br>	pinctrl-0 = <span class="hljs-variable">&lt;&amp;pinctrl_enet2&gt;</span>;<br>	phy-mode = <span class="hljs-string">&quot;rmii&quot;</span>;<br>	phy-handle = <span class="hljs-variable">&lt;&amp;ethphy1&gt;</span>;<br>    phy-reset-gpios = <span class="hljs-variable">&lt;&amp;gpio5 8 GPIO_ACTIVE_LOW&gt;</span>;<br>    phy-reset-duration = <span class="hljs-variable">&lt;100&gt;</span>;<br>    phy-reset-post-delay = <span class="hljs-variable">&lt;100&gt;</span>;<br>	status = <span class="hljs-string">&quot;okay&quot;</span>;<br><br>	mdio &#123;<br>		<span class="hljs-comment">#address-cells = &lt;1&gt;;</span><br>		<span class="hljs-comment">#size-cells = &lt;0&gt;;</span><br><br>		ethphy0: ethernet-phy<span class="hljs-meta">@2</span> &#123;<br>			reg = <span class="hljs-variable">&lt;2&gt;</span>;<br>			micrel,led-mode = <span class="hljs-variable">&lt;1&gt;</span>;<br>			clocks = <span class="hljs-variable">&lt;&amp;clks IMX6UL_CLK_ENET_REF&gt;</span>;<br>			clock-names = <span class="hljs-string">&quot;rmii-ref&quot;</span>;<br>		&#125;;<br><br>		ethphy1: ethernet-phy<span class="hljs-meta">@1</span> &#123;<br>			reg = <span class="hljs-variable">&lt;1&gt;</span>;<br>			micrel,led-mode = <span class="hljs-variable">&lt;1&gt;</span>;<br>			clocks = <span class="hljs-variable">&lt;&amp;clks IMX6UL_CLK_ENET2_REF&gt;</span>;<br>			clock-names = <span class="hljs-string">&quot;rmii-ref&quot;</span>;<br>		&#125;;<br>	&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><code>GPIO5_IO07</code>和<code>GPIO5_IO08</code>会跟SPI4的两个IO冲突，这里直接把spi4 disable掉即可。通常uboot会自动加载fec2，为了方便起见，我把fec1也disable了。</p>
<p>最后，还需要在<code>/drviers/net/phy</code>中，找到<code>genphy_config_aneg</code>函数，这个函数负责PHY自协商的完整配置，在初始化PHY时会调用（通过操作<code>BMCR_RESET</code>位）。在函数中加入：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scss">int <span class="hljs-built_in">genphy_config_aneg</span>(struct phy_device *phydev)<br>&#123;<br>	int result;<br>  <br>  <span class="hljs-comment">/* Soft reset */</span><br>  <span class="hljs-built_in">phy_reset</span>(phydev);<br>  <span class="hljs-built_in">mdelay</span>(<span class="hljs-number">150</span>);	<span class="hljs-comment">//IC要求复位后延时150ms</span><br><br>  ......<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="uboot设置"><a class="markdownIt-Anchor" href="#uboot设置"></a> uboot设置</h3>
<p>在uboot内设置开发板网络配置：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> ipaddr <span class="hljs-number">192.168.1.55</span><br><span class="hljs-attribute">setenv</span> ethaddr b8:ae:<span class="hljs-number">1</span>d:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span><br><span class="hljs-attribute">setenv</span> gatewayip <span class="hljs-number">192.168.1.1</span><br><span class="hljs-attribute">setenv</span> netmask <span class="hljs-number">255.255.255.0</span><br><span class="hljs-attribute">setenv</span> serverip <span class="hljs-number">192.168.1.105</span>   # Ubuntu IP<br></code></pre></td></tr></table></figure>
<p>然后<code>saveenv</code>，保存变量。</p>
<p>uboot支持自动配置物理地址，只需要在defconfig中加入：<code>CONFIG_NET_RANDOM_ETHADDR=y</code></p>
<p>如果对静态IP没有要求，或者想要简单一点，可以直接在Uboot内使用<code>DHCP</code>命令。DHCP会自动申请可用IP，自动配置网关、DNS、子网掩码等。</p>
<p>此时在Uboot内ping 虚拟机地址<code>192.168.1.105</code>，应当是能Ping通的。为防止IP被复用，关闭虚拟机，再Ping一次虚拟机，如果无法Ping通，说明配置正确：<br>
<img src="/images/linux/uboot_6.png" srcset="/img/loading.gif" lazyload alt="Ping测试"></p>
<p>反过来，从虚拟机Ping开发板，肯定是Ping不通的（Ping通了说明有问题，这个IP被其他的什么东西复用了），因为此时Linux内核还未启动，网口不会被使能。</p>
<p>此时，三台机器的IP地址分别为：</p>
<ul>
<li>主机：192.168.1.100</li>
<li>虚拟机：192.168.1.105</li>
<li>开发板：192.168.1.101(DHCP获取)</li>
</ul>
<h2 id="uboot启动流程"><a class="markdownIt-Anchor" href="#uboot启动流程"></a> uboot启动流程</h2>
<h3 id="reset函数"><a class="markdownIt-Anchor" href="#reset函数"></a> reset函数</h3>
<p>uboot编译后会在根目录下生成链接脚本<code>u-boot.lds</code>。其内容的前几行里有：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">OUTPUT_FORMAT</span><span class="hljs-params">(<span class="hljs-string">&quot;elf32-littlearm&quot;</span>, <span class="hljs-string">&quot;elf32-littlearm&quot;</span>, <span class="hljs-string">&quot;elf32-littlearm&quot;</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">OUTPUT_ARCH</span><span class="hljs-params">(arm)</span></span><br><span class="hljs-function"><span class="hljs-title">ENTRY</span><span class="hljs-params">(_start)</span></span><br>SECTIONS<br>&#123;<br>    ........<br></code></pre></td></tr></table></figure>
<p>很显然第3行的<code>ENTRY(_start)</code>中的<code>_start</code>是代码入口点，在<code>arch/arm/lib/vectors.S</code>中定义：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/*<br><span class="hljs-bullet"> *</span>  vectors - Generic ARM exception table code<br><span class="hljs-bullet"> *</span><br> *  Copyright (c) 1998	Dan Malek <span class="language-xml">&lt;dmalek@jlc.net&gt;</span><br><span class="hljs-bullet"> *</span>  Copyright (c) 1999	Magnus Damm <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">kieraypc01.p.y.kie.era.ericsson.se</span>&gt;</span></span><br><span class="hljs-bullet"> *</span>  Copyright (c) 2000	Wolfgang Denk <span class="language-xml">&lt;wd@denx.de&gt;</span><br><span class="hljs-bullet"> *</span>  Copyright (c) 2001	Alex Züpke <span class="language-xml">&lt;azu@sysgo.de&gt;</span><br><span class="hljs-bullet"> *</span>  Copyright (c) 2001	Marius Gröger <span class="language-xml">&lt;mag@sysgo.de&gt;</span><br><span class="hljs-bullet"> *</span>  Copyright (c) 2002	Alex Züpke <span class="language-xml">&lt;azu@sysgo.de&gt;</span><br><span class="hljs-bullet"> *</span>  Copyright (c) 2002	Gary Jennejohn <span class="language-xml">&lt;garyj@denx.de&gt;</span><br><span class="hljs-bullet"> *</span>  Copyright (c) 2002	Kyle Harris <span class="language-xml">&lt;kharris@nexus-tech.net&gt;</span><br><span class="hljs-bullet"> *</span><br> * SPDX-License-Identifier:	GPL-2.0+<br> <span class="hljs-emphasis">*/</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">#include <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">config.h</span>&gt;</span></span></span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">/*</span><br> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*<br><span class="hljs-bullet"> *</span><br> * Symbol <span class="hljs-emphasis">_start is referenced elsewhere, so make it global</span><br><span class="hljs-emphasis"> *</span><br><span class="hljs-emphasis"> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis"> */</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">.globl _</span>start<br><br>/*<br> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*<br><span class="hljs-bullet"> *</span><br> * Vectors have their own section so linker script can map them easily<br><span class="hljs-bullet"> *</span><br> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*<br> <span class="hljs-emphasis">*/</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">	.section &quot;.vectors&quot;, &quot;ax&quot;</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">/*</span><br> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*<br><span class="hljs-bullet"> *</span><br> * Exception vectors as described in ARM reference manuals<br><span class="hljs-bullet"> *</span><br> * Uses indirect branch to allow reaching handlers anywhere in memory.<br><span class="hljs-bullet"> *</span><br> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*<br> <span class="hljs-emphasis">*/</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">_start:</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">#ifdef CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="hljs-emphasis">	.word	CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="hljs-emphasis">#endif</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">	b	reset</span><br><span class="hljs-emphasis">	ldr	pc, _undefined_instruction</span><br><span class="hljs-emphasis">	ldr	pc, _software_interrupt</span><br><span class="hljs-emphasis">	ldr	pc, _prefetch_abort</span><br><span class="hljs-emphasis">	ldr	pc, _data_abort</span><br><span class="hljs-emphasis">	ldr	pc, _not_used</span><br><span class="hljs-emphasis">	ldr	pc, _irq</span><br><span class="hljs-emphasis">	ldr	pc, _fiq</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">.................</span><br><span class="hljs-emphasis"></span><br></code></pre></td></tr></table></figure>
<p>显然<code>_start</code>后面就是中断向量表，<code>.section &quot;.vectors&quot;, &quot;ax&quot;</code>表明此代码存放在<code>vectors</code>里面，具体的地址可以在<code>u-boot.map</code>中查询。<code>b reset</code>跳转至reset函数内，该函数在<code>arch/arm/cpu/armv7/start.S</code>里：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">reset:</span><br> <span class="hljs-comment">/* Allow the board to save important registers */</span><br> <span class="hljs-keyword">b</span> save_boot_params<br></code></pre></td></tr></table></figure>
<p><code>reset</code>函数紧接着又跳转到了<code>save_boot_params</code>函数，该函数同样定义在<code>start.S</code>里：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">ENTRY</span><span class="hljs-params">(save_boot_params)</span></span><br> <span class="hljs-selector-tag">b</span> save_boot_params_ret @ back to my caller<br></code></pre></td></tr></table></figure>
<p>这个函数又直接跳转到了<code>save_boot_params_ret</code>函数：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">save_boot_params_ret:</span><br> <span class="hljs-comment">/*</span><br><span class="hljs-comment"> * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 </span><br><span class="hljs-comment"> * mode, except if in HYP mode already</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span>       <span class="hljs-comment">@ 读取CPSR</span><br> <span class="hljs-keyword">and</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x1f</span>  <span class="hljs-comment">@ 提取bit0 - bit4，用于设置Cortex-A7工作模式</span><br> <span class="hljs-keyword">teq</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0x1a</span>      <span class="hljs-comment">@ 判断处理器是否处于HYP模式</span><br> <span class="hljs-keyword">bicne</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x1f</span> <span class="hljs-comment">@ 若不处于HYP模式，清除模式位</span><br> <span class="hljs-keyword">orrne</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x13</span> <span class="hljs-comment">@ 进入SVC模式（特权）</span><br> <span class="hljs-keyword">orr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0xc0</span>   <span class="hljs-comment">@ 关闭FIQ和IRQ</span><br> <span class="hljs-keyword">msr</span> cpsr,<span class="hljs-built_in">r0</span>         <span class="hljs-comment">@ 恢复CPSR</span><br></code></pre></td></tr></table></figure>
<p>然后，继续执行：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/*</span><br><span class="hljs-comment">* Setup vector:</span><br><span class="hljs-comment">* (OMAP4 spl TEXT_BASE is not 32 byte aligned.</span><br><span class="hljs-comment">* Continue to use ROM code vector only in OMAP4 spl)</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">#if !(defined(CONFIG_OMAP44XX) &amp;&amp; defined(CONFIG_SPL_BUILD))       </span><br><span class="hljs-comment">/* Set V=0 in CP15 SCTLR register - for VBAR to point to vector */</span><br><span class="hljs-keyword">mrc</span> <span class="hljs-built_in">p15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">c1</span>, <span class="hljs-built_in">c0</span>, <span class="hljs-number">0</span> <span class="hljs-comment">@ 读取 CP15 SCTLR 寄存器</span><br><span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">#CR_V</span> <span class="hljs-comment">@ V = 0</span><br><span class="hljs-symbol">mcr</span> <span class="hljs-built_in">p15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">c1</span>, <span class="hljs-built_in">c0</span>, <span class="hljs-number">0</span> <span class="hljs-comment">@ 写 CP15 SCTLR 寄存器，V清零，准备重定位向量表</span><br><br><span class="hljs-comment">/* CP15 VBAR 寄存器中设置向量表地址 */</span><br><span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=_start</span><br><span class="hljs-symbol">mcr</span> <span class="hljs-built_in">p15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">c12</span>, <span class="hljs-built_in">c0</span>, <span class="hljs-number">0</span> <span class="hljs-comment">@Set VBAR</span><br><span class="hljs-comment">#endif</span><br></code></pre></td></tr></table></figure>
<p>继续执行：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">/* the mask ROM code should have PLL and others stable */</span><br> <span class="hljs-comment">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br> <span class="hljs-keyword">bl </span>cpu_init_cp15       @ 设置CP15相关内容<br> <span class="hljs-keyword">bl </span>cpu_init_crit       <br> <span class="hljs-comment">#endif</span><br><br> <span class="hljs-keyword">bl </span>_main<br></code></pre></td></tr></table></figure>
<p>这已经是跳转至main的最后一步。<code>cpu_init_crit</code>定义如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">ENTRY</span><span class="hljs-params">(cpu_init_crit)</span></span><br> <span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Jump to board specific initialization...</span><br><span class="hljs-comment"> * The Mask ROM will have already initialized</span><br><span class="hljs-comment"> * basic memory. Go here to bump up clock rate and handle</span><br><span class="hljs-comment"> * wake up conditions.</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-selector-tag">b</span> lowlevel_init @ go setup pll,mux,memory<br> <span class="hljs-built_in">ENDPROC</span>(cpu_init_crit)<br></code></pre></td></tr></table></figure>
<p>注释已经写了，该函数即将要跳转到的<code>lowlevel_init</code>会设置PLL、MUX和内存。</p>
<h3 id="lowlevel_init"><a class="markdownIt-Anchor" href="#lowlevel_init"></a> lowlevel_init</h3>
<p>函数在<code>arch/arm/cpu/armv7/lowlevel_init.S</code>中定义：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * A lowlevel_init function that sets up the stack to call a C function to</span><br><span class="hljs-comment"> * perform further init.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (C) Copyright 2010</span><br><span class="hljs-comment"> * Texas Instruments, &lt;www.ti.com&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Author :</span><br><span class="hljs-comment"> *	Aneesh V	&lt;aneesh@ti.com&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * SPDX-License-Identifier:	GPL-2.0+</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">#include &lt;asm-offsets.h&gt;</span><br><span class="hljs-comment">#include &lt;config.h&gt;</span><br><span class="hljs-comment">#include &lt;linux/linkage.h&gt;</span><br><br><span class="hljs-symbol">ENTRY</span>(lowlevel_init)<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Setup a temporary stack. Global data is not available yet.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">ldr</span>	<span class="hljs-built_in">sp</span>, <span class="hljs-symbol">=CONFIG_SYS_INIT_SP_ADDR</span><br>	<span class="hljs-keyword">bic</span>	<span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#7</span> <span class="hljs-comment">/* 8-byte alignment for ABI compliance */</span><br><span class="hljs-comment">#ifdef CONFIG_SPL_DM</span><br>	<span class="hljs-keyword">mov</span>	<span class="hljs-built_in">r9</span>, <span class="hljs-number">#0</span><br><span class="hljs-comment">#else</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Set up global data for boards that still need it. This will be</span><br><span class="hljs-comment">	 * removed soon.</span><br><span class="hljs-comment">	 */</span><br><span class="hljs-comment">#ifdef CONFIG_SPL_BUILD</span><br>	<span class="hljs-keyword">ldr</span>	<span class="hljs-built_in">r9</span>, <span class="hljs-symbol">=gdata</span><br><span class="hljs-comment">#else</span><br>	<span class="hljs-keyword">sub</span>	<span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-symbol">#GD_SIZE</span><br>	<span class="hljs-keyword">bic</span>	<span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#7</span><br>	<span class="hljs-keyword">mov</span>	<span class="hljs-built_in">r9</span>, <span class="hljs-built_in">sp</span><br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">#endif</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Save the old lr(passed in ip) and the current lr to stack</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">push</span>	&#123;<span class="hljs-built_in">ip</span>, <span class="hljs-built_in">lr</span>&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Call the very early init function. This should do only the</span><br><span class="hljs-comment">	 * absolute bare minimum to get started. It should not:</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * - set up DRAM</span><br><span class="hljs-comment">	 * - use global_data</span><br><span class="hljs-comment">	 * - clear BSS</span><br><span class="hljs-comment">	 * - try to start a console</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * For boards with SPL this should be empty since SPL can do all of</span><br><span class="hljs-comment">	 * this init in the SPL board_init_f() function which is called</span><br><span class="hljs-comment">	 * immediately after this.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">bl</span>	s_init<br>	<span class="hljs-keyword">pop</span>	&#123;<span class="hljs-built_in">ip</span>, <span class="hljs-built_in">pc</span>&#125;<br><span class="hljs-symbol">ENDPROC</span>(lowlevel_init)<br></code></pre></td></tr></table></figure>
<p>第22行<code>ldr	sp, =CONFIG_SYS_INIT_SP_ADDR</code>，将栈指针指向<code>CONFIG_SYS_INIT_SP_ADDR</code>，这个宏在<code>include/configs/mx6ullevk.h</code>里定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_SYS_INIT_RAM_ADDR IRAM_BASE_ADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_SYS_INIT_RAM_SIZE IRAM_SIZE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_SYS_INIT_SP_OFFSET \</span><br><span class="hljs-meta">(CONFIG_SYS_INIT_RAM_SIZE - GENERATED_GBL_DATA_SIZE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_SYS_INIT_SP_ADDR \</span><br><span class="hljs-meta">(CONFIG_SYS_INIT_RAM_ADDR + CONFIG_SYS_INIT_SP_OFFSET)</span><br></code></pre></td></tr></table></figure>
<p><code>IRAM_BASE_ADDR</code>和<code>IRAM_SIZE</code>在<code>arch/arm/include/asm/arch-mx6/imx-regs.h</code>中定义，实际上就是MX6ULL内部OCRAM的首地址和大小。这里<code>CONFIG_SYS_INIT_RAM_ADDR = IRAM_BASE_ADDR = 0x00900000</code>，<code>CONFIG_SYS_INIT_RAM_SIZE = 0x00020000 =128KB</code>。</p>
<p>根据这两行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_SYS_INIT_SP_OFFSET \</span><br><span class="hljs-meta">(CONFIG_SYS_INIT_RAM_SIZE - GENERATED_GBL_DATA_SIZE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_SYS_INIT_SP_ADDR \</span><br><span class="hljs-meta">(CONFIG_SYS_INIT_RAM_ADDR + CONFIG_SYS_INIT_SP_OFFSET)</span><br></code></pre></td></tr></table></figure>
<p>显然还需要知道<code>GENERATED_GBL_DATA_SIZE</code>的值，在<code>include/generated/generic-asm-offsets.h</code>中定义，大小为256.那么综上，<code>CONFIG_SYS_INIT_SP_ADDR</code>的值如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">CONFIG_SYS_INIT_SP_OFFSET</span> = <span class="hljs-number">0</span>x00020000 - <span class="hljs-number">256</span> = <span class="hljs-number">0</span>x1FF00<br><span class="hljs-attribute">CONFIG_SYS_INIT_SP_ADDR</span> = <span class="hljs-number">0</span>x00900000 + <span class="hljs-number">0</span>x1FF00 = <span class="hljs-number">0</span>x0091FF00<br></code></pre></td></tr></table></figure>
<p>此时栈指针SP指向0x0091FF00，这属于IMX6ULL的内部RAM。</p>
<p>回到lowlevel_init.S，<code>bic	sp, sp, #7</code>对栈指针作8字节对齐处理。第34行<code>sub	sp, sp, #GD_SIZE</code>用栈指针减去<code>GD_SIZE</code>，这个变量在<code>generic-asm-offsets.h</code>中定义，大小为248；第35行<code>bic	sp, sp, #7</code>，8字节对齐SP，此时<code>SP=0x0091FF00 - 248 = 0x0091FE08</code>。第36行将SP保存至R9，第42行将ip和lr入栈，57行调用s_init函数，然后58行出栈ip和lr，并将lr赋给pc。</p>
<h3 id="s_init"><a class="markdownIt-Anchor" href="#s_init"></a> s_init</h3>
<p>lowlevel_init在最后回调用s_init，定义在<code>arch/arm/cpu/armv7/mx6/soc.c</code>中。对于MX6ULL而言，s_init()是个空函数（不满足触发要求）。至此lowlevel_init结束，返回cpu_init_crit，该函数也结束，最后返回save_boot_params_ret，紧接着就会执行_main函数。</p>
<h3 id="_main"><a class="markdownIt-Anchor" href="#_main"></a> _main</h3>
<p>定义在<code>arch/arm/lib/crt0.S</code>。总体而言非常长，总共调用了4个函数：<code>board_init_f</code>、<code>relocate_code</code>、<code>relocate_vectors</code>、<code>board_init_r</code>。</p>
<h4 id="board_init_f"><a class="markdownIt-Anchor" href="#board_init_f"></a> board_init_f</h4>
<p>在<code>common/board_f.c</code>中定义，该函数的工作：</p>
<ul>
<li>初始化外设，包括串口、定时器等，并打印一些消息</li>
<li>初始化 gd 的各个成员变量，uboot 会将自己重定位到 DRAM 最后面的地址区域，也就是将自己拷贝到 DRAM 最后面的内存区域中。这么做的目的是给 Linux 腾出空间，防止 Linux kernel 覆盖掉 uboot，将 DRAM 前面的区域完整的空出来。在拷贝之前肯定要给 uboot 各部分分配好内存位置和大小，比如 gd 应该存放到哪个位置，malloc 内存池应该存放到哪个位置等等。这些信息都保存在 gd 的成员变量中，因此要对 gd 的这些成员变量做初始化。最终形成一个完整的内存map，在后面重定位 uboot 的时候就会用到这个内存map。</li>
</ul>
<p>该函数中包括非常关键的一行：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable"><span class="hljs-keyword">if</span></span> (<span class="hljs-function"><span class="hljs-title">initcall_run_list</span>(<span class="hljs-variable">init_sequence_f</span>))</span><br><span class="hljs-function"><span class="hljs-title">hang</span>();</span><br></code></pre></td></tr></table></figure>
<p><code>initcall_run_list</code>会初始化一系列外设：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs xl">static init_fnc_t init_sequence_f[] = &#123;<br>setup_mon_len,       <span class="hljs-comment">//设置代码长度</span><br>initf_malloc,        <span class="hljs-comment">//初始化malloc相关的成员变量</span><br>initf_console_record,   <span class="hljs-comment">//无效，返回0</span><br>arch_cpu_init,          <span class="hljs-comment">//基本的arch cpu依赖项初始化</span><br>initf_dm, <br>arch_cpu_init_dm, <br>mark_bootstage, <br>board_early_init_f,     <span class="hljs-comment">//初始化串口IO配置</span><br>timer_init,         <span class="hljs-comment">//初始化Cortex-A7内核定时器，为Uboot提供时间(类似systick)</span><br>board_postclk_init,     <span class="hljs-comment">//设置VDDSOC电压</span><br>get_clocks,             <span class="hljs-comment">//获取SD卡外设时钟</span><br>env_init,               <span class="hljs-comment">//初始化环境变量</span><br>init_baud_rate,         <span class="hljs-comment">//初始化波特率</span><br>serial_init,            <span class="hljs-comment">//初始化串口</span><br>console_init_f, <br>display_options,        <span class="hljs-comment">//串口打印信息</span><br>display_text_info,      <span class="hljs-comment">//打印调试信息</span><br>print_cpuinfo,          <span class="hljs-comment">//打印CPU信息</span><br>show_board_info,        <span class="hljs-comment">//打印板子信息，调用checkboard()</span><br>INIT_FUNC_WATCHDOG_INIT     <span class="hljs-comment">//无效</span><br>INIT_FUNC_WATCHDOG_RESET    <span class="hljs-comment">//无效</span><br>init_func_i2c,          <span class="hljs-comment">//初始化I2C</span><br>announce_dram_init,     <br><span class="hljs-function"><span class="hljs-title">dram_init</span>,              //设置gd-&gt;</span>ram_size<br>post_init_f,            <span class="hljs-comment">//测试函数</span><br>INIT_FUNC_WATCHDOG_RESET<br>testdram,               <span class="hljs-comment">//无效</span><br>INIT_FUNC_WATCHDOG_RESET<br>INIT_FUNC_WATCHDOG_RESET<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">* Now that we have DRAM mapped and working, we can</span><br><span class="hljs-comment">* relocate the code and continue running from DRAM.</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* Reserve memory at end of RAM for (top down in that order):</span><br><span class="hljs-comment">* - area that won&#x27;t get touched by U-Boot and Linux (optional)</span><br><span class="hljs-comment">* - kernel log buffer</span><br><span class="hljs-comment">* - protected RAM</span><br><span class="hljs-comment">* - LCD framebuffer</span><br><span class="hljs-comment">* - monitor code</span><br><span class="hljs-comment">* - board info struct</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-title">setup_dest_addr</span>,        //设置gd-&gt;</span><span class="hljs-function"><span class="hljs-title">ram_size</span>(ram大小)，gd-&gt;</span><span class="hljs-function"><span class="hljs-title">ram_top</span>(ram最高地址)和gd-&gt;</span>relocaddr(重定位后最高地址)<br><span class="hljs-function"><span class="hljs-title">reserve_round_4k</span>,       //gd-&gt;</span>relocaddr <span class="hljs-number">4</span>字节对齐<br>reserve_mmu,            <span class="hljs-comment">//留出MMU的TLB表位置</span><br>reserve_trace, <br><span class="hljs-function"><span class="hljs-title">reserve_uboot</span>,          //留出重定位后uboot所占内存区域，大小由gd-&gt;</span><span class="hljs-function"><span class="hljs-title">monlen</span>指定，留出的空间需4KB对齐并设置gd-&gt;</span>start_addr_sp<br>reserve_malloc,         <span class="hljs-comment">//留出malloc区域，由宏TOTAL_MALLOC_LEN定义(默认16MB)</span><br>reserve_board,          <span class="hljs-comment">//留出bd_t内存区</span><br>setup_machine,          <span class="hljs-comment">//无效</span><br>reserve_global_data,    <span class="hljs-comment">//留出gd_t内存区域</span><br>reserve_fdt,            <span class="hljs-comment">//无效</span><br>reserve_arch,           <span class="hljs-comment">//空</span><br>reserve_stacks,         <span class="hljs-comment">//留出栈空间，如果使能IRQ还需要留出IRQ相应的内存</span><br>setup_dram_config,      <span class="hljs-comment">//设置DRAM，告知linux DRAM起始地址和大小</span><br>show_dram_config, <br>display_new_sp,         <span class="hljs-comment">//显示新的sp位置</span><br>INIT_FUNC_WATCHDOG_RESET<br>reloc_fdt,              <span class="hljs-comment">//无效</span><br>setup_reloc,            <span class="hljs-comment">//设置gd的其他成员变量</span><br>NULL,<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>至此，<code>board_init_f</code>执行完成，最终的内存分配：<br>
<img src="/images/linux/uboot_9.png" srcset="/img/loading.gif" lazyload alt="内存分配"></p>
<h4 id="relocate_code-relocate_vectors"><a class="markdownIt-Anchor" href="#relocate_code-relocate_vectors"></a> relocate_code / relocate_vectors</h4>
<p>用于拷贝代码和重定位向量表。</p>
<h4 id="board_init_r"><a class="markdownIt-Anchor" href="#board_init_r"></a> board_init_r</h4>
<p>用于初始化高级外设，包括EMMC、LCD、BSP芯片、网络等。</p>
<h3 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h3>
<p>总的来说，uboot的汇编启动阶段包括：</p>
<ol>
<li>入口点：<code>_start</code>(<code>arch/arm/lib/vectors.S</code>)设置异常向量表</li>
<li>CPU模式切换：进入SVC模式，禁用IRQ/FIQ</li>
<li>关闭MMU/Cache，确保直接访问物理地址</li>
<li>初始化栈指针</li>
<li>lowlevel_init（板级特定）：
<ul>
<li>配置系统时钟</li>
<li>DDR控制器初始化</li>
</ul>
</li>
<li>代码重定位：将U-Boot从加载地址（如SRAM）拷贝到DDR目标地址</li>
</ol>
<p>C语言初始化阶段(<code>board_init_f</code>)包括：</p>
<ol>
<li>全局数据结构初始化：<code>gd_t</code>和<code>bd_t</code></li>
<li>低级驱动初始化：
<ul>
<li>串口、GPIO、MMU、内核定时器</li>
<li>DDR</li>
</ul>
</li>
<li>重定位准备
<ul>
<li>计算uboot在DDR中的最终位置，预留内核、DTB、initrd、代码空间</li>
<li>执行重定位，更新代码地址相关引用(如全局变量指针)</li>
</ul>
</li>
<li>设备树预解析：若使用DTS，加载并校验DTB</li>
</ol>
<p>重定位后主流程(<code>board_init_r</code>)包括：</p>
<ol>
<li>高级外设初始化：
<ul>
<li>以太网、SD、USB、EEPROM等</li>
<li>展开DTB，匹配驱动，设置硬件参数</li>
</ul>
</li>
<li>环境变量加载：从存储介质读取<code>uEnv.txt</code>或环境分区</li>
<li>用户交互
<ul>
<li>检测输入</li>
<li>加载zImage、设备树、initrd到指定内存地址</li>
<li>准备加载内核</li>
</ul>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F-Linux%E5%BC%80%E5%8F%91/" class="category-chain-item">嵌入式(Linux开发)</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NXP 官方u-boot移植和启动过程</div>
      <div>http://akichen891.github.io/2025/03/07/uboot移植/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Aki Chen</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月7日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025年3月18日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/11/Linux%E5%86%85%E6%A0%B8%E7%A7%BB%E6%A4%8D/" title="IMX6ULL Linux内核移植">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">IMX6ULL Linux内核移植</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/05/DDR3%E9%85%8D%E7%BD%AE/" title="IMX6UL DDR3配置">
                        <span class="hidden-mobile">IMX6UL DDR3配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
