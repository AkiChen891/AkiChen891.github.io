

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">

<head>
  <meta name="google-site-verification" content="Qd4BJop_tJyti_Gc8cDS3G09bPdOfn-O0if6QYHhtXY" />
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon.png">
  <link rel="icon" href="/images/favicon_mos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#F0E68C">
  <meta name="author" content="Aki">
  <meta name="keywords" content="">
  
    <meta name="description" content="Cortex-A7中断系统  中断向量表 Cortex-A7的中断向量表共有8个异常中断，其中一个未使用，有效中断为7个：    向量地址 中断类型 中断模式     0X00 复位中断(Rest) 特权模式(SVC)   0X04 未定义指令中断(Undefined Instruction) 未定义指令中止模式(Undef)   0X08 软中断(Software Interrupt,SWI)">
<meta property="og:type" content="article">
<meta property="og:title" content="IMX6ULL外部中断配置">
<meta property="og:url" content="http://akichen891.github.io/2025/03/04/IMX6ULL%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="Aki&#39;s Blog">
<meta property="og:description" content="Cortex-A7中断系统  中断向量表 Cortex-A7的中断向量表共有8个异常中断，其中一个未使用，有效中断为7个：    向量地址 中断类型 中断模式     0X00 复位中断(Rest) 特权模式(SVC)   0X04 未定义指令中断(Undefined Instruction) 未定义指令中止模式(Undef)   0X08 软中断(Software Interrupt,SWI)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://akichen891.github.io/images/linux/GIC_1.png">
<meta property="og:image" content="http://akichen891.github.io/images/linux/GIC_2.png">
<meta property="og:image" content="http://akichen891.github.io/images/linux/GIC_3.png">
<meta property="article:published_time" content="2025-03-04T04:51:55.000Z">
<meta property="article:modified_time" content="2025-03-05T13:25:35.204Z">
<meta property="article:author" content="Aki">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://akichen891.github.io/images/linux/GIC_1.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>IMX6ULL外部中断配置 - Aki&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"akichen891.github.io","root":"/","version":"1.9.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"C"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Aki&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/images/Ringlan.JPG') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">IMX6ULL外部中断配置</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-04 12:51" pubdate>
          2025年3月4日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          46 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">IMX6ULL外部中断配置</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="cortex-a7中断系统"><a class="markdownIt-Anchor" href="#cortex-a7中断系统"></a> Cortex-A7中断系统</h2>
<h3 id="中断向量表"><a class="markdownIt-Anchor" href="#中断向量表"></a> 中断向量表</h3>
<p>Cortex-A7的中断向量表共有8个异常中断，其中一个未使用，有效中断为7个：</p>
<table>
<thead>
<tr>
<th>向量地址</th>
<th>中断类型</th>
<th>中断模式</th>
</tr>
</thead>
<tbody>
<tr>
<td>0X00</td>
<td>复位中断(Rest)</td>
<td>特权模式(SVC)</td>
</tr>
<tr>
<td>0X04</td>
<td>未定义指令中断(Undefined Instruction)</td>
<td>未定义指令中止模式(Undef)</td>
</tr>
<tr>
<td>0X08</td>
<td>软中断(Software Interrupt,SWI)</td>
<td>特权模式(SVC)</td>
</tr>
<tr>
<td>0X0C</td>
<td>指令预取中止中断(Prefetch Abort)</td>
<td>中止模式</td>
</tr>
<tr>
<td>0X10</td>
<td>数据访问中止中断(Data Abort)</td>
<td>中止模式</td>
</tr>
<tr>
<td>0X14</td>
<td>未使用(Not Used)</td>
<td>未使用</td>
</tr>
<tr>
<td>0X18</td>
<td>IRQ 中断(IRQ Interrupt)</td>
<td>外部中断模式(IRQ)</td>
</tr>
<tr>
<td>0X1C</td>
<td>FIQ 中断(FIQ Interrupt)</td>
<td>快速中断模式(FIQ)</td>
</tr>
</tbody>
</table>
<p>不同于Cortex-M在中断向量表中列出了所有的中断向量，Cortex-A将所有属于内核CPU的外部中断放在0x18的IRQ中断中，任意外部中断都会触发IRQ中断，然后在IRQ中断中通过读取寄存器的方式来判断具体的中断类型，然后做出相应处理。</p>
<h3 id="汇编代码启动文件starts"><a class="markdownIt-Anchor" href="#汇编代码启动文件starts"></a> 汇编代码(启动文件<code>start.S</code>)</h3>
<h4 id="中断向量表-2"><a class="markdownIt-Anchor" href="#中断向量表-2"></a> 中断向量表</h4>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">.global</span> _start  				<span class="hljs-comment">/* 全局标号 */</span><br><br><span class="hljs-symbol">_start:</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=Reset_Handler</span>		<span class="hljs-comment">/* 复位中断 					*/</span>	<br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=Undefined_Handler</span>	<span class="hljs-comment">/* 未定义中断 					*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=SVC_Handler</span>		<span class="hljs-comment">/* SVC(Supervisor)中断 		*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=PrefAbort_Handler</span>	<span class="hljs-comment">/* 预取终止中断 					*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=DataAbort_Handler</span>	<span class="hljs-comment">/* 数据终止中断 					*/</span><br>	<span class="hljs-keyword">ldr</span>	<span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=NotUsed_Handler</span>	<span class="hljs-comment">/* 未使用中断					*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=IRQ_Handler</span>		<span class="hljs-comment">/* IRQ中断 					*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=FIQ_Handler</span>		<span class="hljs-comment">/* FIQ(快速中断)未定义中断 			*/</span><br></code></pre></td></tr></table></figure>
<p>指定中断发生后调用对应的中断复位函数。<code>pc</code>为程序计数器，用来指出下一条指令在主存储器中的地址。中断发生后，主程序的下一条指令地址会自动更新为中断服务函数的地址。</p>
<h3 id="gic控制器"><a class="markdownIt-Anchor" href="#gic控制器"></a> GIC控制器</h3>
<p><img src="/images/linux/GIC_1.png" srcset="/img/loading.gif" lazyload alt="GIC v2框图"></p>
<p>类似于STM32的NVIC，Cortex-A的中断控制器名字叫GIC，GIC负责处理输入的所有中断，然后生成一个IRQ信号上报给ARM内核。GIC将众多的中断源分为三类：</p>
<ul>
<li>SPI，共享中断，常见外部中断均属于SPI中断</li>
<li>PPI，私有中断，指定核心处理</li>
<li>SGI，软件中断，通过向寄存器<code>GICR_SGIR</code>写入数据触发，常用于多核通信</li>
</ul>
<h3 id="中断id"><a class="markdownIt-Anchor" href="#中断id"></a> 中断ID</h3>
<p>I.MX6UL的1020个中断ID分配如下：</p>
<ul>
<li>ID0 - ID15：分配至SGI</li>
<li>ID16 - ID31：分配至PPI</li>
<li>ID32 - ID1019：分配至SPI</li>
</ul>
<p>I.MX6U的中断源由官方SDK在<code>MCIMX6Y2.h</code>中给出，共有160个，每个中断源有独属的中断ID。</p>
<h3 id="gic逻辑分块"><a class="markdownIt-Anchor" href="#gic逻辑分块"></a> GIC逻辑分块</h3>
<p>GIC架构分为两个逻辑块：</p>
<ul>
<li>Distributor：分发器端，负责处理中断事件分发问题（中断事件该发送到哪个CPU Interface上去）。分发器收集所有的中断源，可控制每个中断的优先级，具体功能有：
<ol>
<li>全局中断使能控制</li>
<li>控制每个中断的使能或关闭</li>
<li>设置中断优先级</li>
<li>设置每个中断的目标处理器列表</li>
<li>设置每个外部中断的触发模式：电平触发或边沿触发</li>
<li>设置每个中断属于组 0 还是组 1</li>
</ol>
</li>
<li>CPU Interface：CPU接口端，具体功能有：
<ol>
<li>使能或者关闭发送到 CPU Core 的中断请求信号</li>
<li>应答中断</li>
<li>通知中断处理完成</li>
<li>设置优先级掩码，通过掩码来设置哪些中断不需要上报给 CPU Core</li>
<li>定义抢占策略</li>
<li>当多个中断到来的时候，选择优先级最高的中断通知给 CPU Core</li>
</ol>
</li>
</ul>
<p>GIC控制器的所有寄存器在<code>core_ca7.h</code>中声明：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * GIC寄存器描述结构体，</span><br><span class="hljs-comment"> * GIC分为分发器端和CPU接口端</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span><br>&#123;<br>        <span class="hljs-type">uint32_t</span> RESERVED0[<span class="hljs-number">1024</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_CTLR;                 <span class="hljs-comment">/*!&lt; Offset: 0x1000 (R/W) Distributor Control Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_TYPER;                <span class="hljs-comment">/*!&lt; Offset: 0x1004 (R/ )  Interrupt Controller Type Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_IIDR;                 <span class="hljs-comment">/*!&lt; Offset: 0x1008 (R/ )  Distributor Implementer Identification Register */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED1[<span class="hljs-number">29</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_IGROUPR[<span class="hljs-number">16</span>];          <span class="hljs-comment">/*!&lt; Offset: 0x1080 - 0x0BC (R/W) Interrupt Group Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED2[<span class="hljs-number">16</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_ISENABLER[<span class="hljs-number">16</span>];        <span class="hljs-comment">/*!&lt; Offset: 0x1100 - 0x13C (R/W) Interrupt Set-Enable Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED3[<span class="hljs-number">16</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_ICENABLER[<span class="hljs-number">16</span>];        <span class="hljs-comment">/*!&lt; Offset: 0x1180 - 0x1BC (R/W) Interrupt Clear-Enable Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED4[<span class="hljs-number">16</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_ISPENDR[<span class="hljs-number">16</span>];          <span class="hljs-comment">/*!&lt; Offset: 0x1200 - 0x23C (R/W) Interrupt Set-Pending Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED5[<span class="hljs-number">16</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_ICPENDR[<span class="hljs-number">16</span>];          <span class="hljs-comment">/*!&lt; Offset: 0x1280 - 0x2BC (R/W) Interrupt Clear-Pending Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED6[<span class="hljs-number">16</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_ISACTIVER[<span class="hljs-number">16</span>];        <span class="hljs-comment">/*!&lt; Offset: 0x1300 - 0x33C (R/W) Interrupt Set-Active Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED7[<span class="hljs-number">16</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_ICACTIVER[<span class="hljs-number">16</span>];        <span class="hljs-comment">/*!&lt; Offset: 0x1380 - 0x3BC (R/W) Interrupt Clear-Active Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED8[<span class="hljs-number">16</span>];<br>  __IOM <span class="hljs-type">uint8_t</span>  D_IPRIORITYR[<span class="hljs-number">512</span>];      <span class="hljs-comment">/*!&lt; Offset: 0x1400 - 0x5FC (R/W) Interrupt Priority Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED9[<span class="hljs-number">128</span>];<br>  __IOM <span class="hljs-type">uint8_t</span>  D_ITARGETSR[<span class="hljs-number">512</span>];       <span class="hljs-comment">/*!&lt; Offset: 0x1800 - 0x9FC (R/W) Interrupt Targets Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED10[<span class="hljs-number">128</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> D_ICFGR[<span class="hljs-number">32</span>];            <span class="hljs-comment">/*!&lt; Offset: 0x1C00 - 0xC7C (R/W) Interrupt configuration registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED11[<span class="hljs-number">32</span>];<br>  __IM  <span class="hljs-type">uint32_t</span> D_PPISR;                <span class="hljs-comment">/*!&lt; Offset: 0x1D00 (R/ ) Private Peripheral Interrupt Status Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_SPISR[<span class="hljs-number">15</span>];            <span class="hljs-comment">/*!&lt; Offset: 0x1D04 - 0xD3C (R/ ) Shared Peripheral Interrupt Status Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED12[<span class="hljs-number">112</span>];<br>  __OM  <span class="hljs-type">uint32_t</span> D_SGIR;                 <span class="hljs-comment">/*!&lt; Offset: 0x1F00 ( /W) Software Generated Interrupt Register */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED13[<span class="hljs-number">3</span>];<br>  __IOM <span class="hljs-type">uint8_t</span>  D_CPENDSGIR[<span class="hljs-number">16</span>];        <span class="hljs-comment">/*!&lt; Offset: 0x1F10 - 0xF1C (R/W) SGI Clear-Pending Registers */</span><br>  __IOM <span class="hljs-type">uint8_t</span>  D_SPENDSGIR[<span class="hljs-number">16</span>];        <span class="hljs-comment">/*!&lt; Offset: 0x1F20 - 0xF2C (R/W) SGI Set-Pending Registers */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED14[<span class="hljs-number">40</span>];<br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR4;                <span class="hljs-comment">/*!&lt; Offset: 0x1FD0 (R/ ) Peripheral ID4 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR5;                <span class="hljs-comment">/*!&lt; Offset: 0x1FD4 (R/ ) Peripheral ID5 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR6;                <span class="hljs-comment">/*!&lt; Offset: 0x1FD8 (R/ ) Peripheral ID6 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR7;                <span class="hljs-comment">/*!&lt; Offset: 0x1FDC (R/ ) Peripheral ID7 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR0;                <span class="hljs-comment">/*!&lt; Offset: 0x1FE0 (R/ ) Peripheral ID0 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR1;                <span class="hljs-comment">/*!&lt; Offset: 0x1FE4 (R/ ) Peripheral ID1 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR2;                <span class="hljs-comment">/*!&lt; Offset: 0x1FE8 (R/ ) Peripheral ID2 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_PIDR3;                <span class="hljs-comment">/*!&lt; Offset: 0x1FEC (R/ ) Peripheral ID3 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_CIDR0;                <span class="hljs-comment">/*!&lt; Offset: 0x1FF0 (R/ ) Component ID0 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_CIDR1;                <span class="hljs-comment">/*!&lt; Offset: 0x1FF4 (R/ ) Component ID1 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_CIDR2;                <span class="hljs-comment">/*!&lt; Offset: 0x1FF8 (R/ ) Component ID2 Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> D_CIDR3;                <span class="hljs-comment">/*!&lt; Offset: 0x1FFC (R/ ) Component ID3 Register */</span><br><br>  __IOM <span class="hljs-type">uint32_t</span> C_CTLR;                 <span class="hljs-comment">/*!&lt; Offset: 0x2000 (R/W) CPU Interface Control Register */</span><br>  __IOM <span class="hljs-type">uint32_t</span> C_PMR;                  <span class="hljs-comment">/*!&lt; Offset: 0x2004 (R/W) Interrupt Priority Mask Register */</span><br>  __IOM <span class="hljs-type">uint32_t</span> C_BPR;                  <span class="hljs-comment">/*!&lt; Offset: 0x2008 (R/W) Binary Point Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> C_IAR;                  <span class="hljs-comment">/*!&lt; Offset: 0x200C (R/ ) Interrupt Acknowledge Register */</span><br>  __OM  <span class="hljs-type">uint32_t</span> C_EOIR;                 <span class="hljs-comment">/*!&lt; Offset: 0x2010 ( /W) End Of Interrupt Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> C_RPR;                  <span class="hljs-comment">/*!&lt; Offset: 0x2014 (R/ ) Running Priority Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> C_HPPIR;                <span class="hljs-comment">/*!&lt; Offset: 0x2018 (R/ ) Highest Priority Pending Interrupt Register */</span><br>  __IOM <span class="hljs-type">uint32_t</span> C_ABPR;                 <span class="hljs-comment">/*!&lt; Offset: 0x201C (R/W) Aliased Binary Point Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> C_AIAR;                 <span class="hljs-comment">/*!&lt; Offset: 0x2020 (R/ ) Aliased Interrupt Acknowledge Register */</span><br>  __OM  <span class="hljs-type">uint32_t</span> C_AEOIR;                <span class="hljs-comment">/*!&lt; Offset: 0x2024 ( /W) Aliased End Of Interrupt Register */</span><br>  __IM  <span class="hljs-type">uint32_t</span> C_AHPPIR;               <span class="hljs-comment">/*!&lt; Offset: 0x2028 (R/ ) Aliased Highest Priority Pending Interrupt Register */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED15[<span class="hljs-number">41</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> C_APR0;                 <span class="hljs-comment">/*!&lt; Offset: 0x20D0 (R/W) Active Priority Register */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED16[<span class="hljs-number">3</span>];<br>  __IOM <span class="hljs-type">uint32_t</span> C_NSAPR0;               <span class="hljs-comment">/*!&lt; Offset: 0x20E0 (R/W) Non-secure Active Priority Register */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED17[<span class="hljs-number">6</span>];<br>  __IM  <span class="hljs-type">uint32_t</span> C_IIDR;                 <span class="hljs-comment">/*!&lt; Offset: 0x20FC (R/ ) CPU Interface Identification Register */</span><br>        <span class="hljs-type">uint32_t</span> RESERVED18[<span class="hljs-number">960</span>];<br>  __OM  <span class="hljs-type">uint32_t</span> C_DIR;                  <span class="hljs-comment">/*!&lt; Offset: 0x3000 ( /W) Deactivate Interrupt Register */</span><br>&#125; GIC_Type;<br></code></pre></td></tr></table></figure>
<p>不过，这里只给出了GIC各寄存器的偏移地址，基地址需要通过CP15协处理器获取。</p>
<h3 id="cp15协处理器"><a class="markdownIt-Anchor" href="#cp15协处理器"></a> CP15协处理器</h3>
<p>CP15协处理器共有16个32位寄存器。对CP15协处理器的访问可通过下列指令完成：</p>
<ul>
<li><strong>MRC</strong>：将CP15的寄存器数据读取到ARM寄存器中</li>
<li><strong>MCR</strong>：将ARM寄存器数据写入到CP15寄存器中。格式：<code>MCR&#123;cond&#125; p15, &lt;opc1&gt;, &lt;Rt&gt;, &lt;CRn&gt;, &lt;CRm&gt;, &lt;opc2&gt;</code>
<ul>
<li>cond：指令执行的条件码。若忽略，表示无条件执行</li>
<li>opc1：CP15要执行的操作码</li>
<li>Rt：ARM源寄存器</li>
<li>CRn：CP15的目标寄存器</li>
<li>CRm：CP15中附加的目标寄存器或源操作数寄存器。如不需要附加信息，该位应设置为<code>c0</code></li>
<li>opc2：可选的CP15特定操作码，不需要时设置为0</li>
</ul>
</li>
</ul>
<p>CP15的16个寄存器在被MRC和MCR指令访问时，指令中的参数搭配若不同，得到的寄存器含义也不同。以c0寄存器为例：</p>
<p><img src="/images/linux/GIC_2.png" srcset="/img/loading.gif" lazyload alt="CP15 c0寄存器参数搭配"></p>
<p>例如，当<code>opc1 = 0</code>, <code>CRm = c0</code>, <code>opc2 = 0</code>时，此时c0是MIDR寄存器，即主ID寄存器，包含厂商编号、主版本号、架构代码等信息。</p>
<p>对于c15寄存器:<br>
<img src="/images/linux/GIC_3.png" srcset="/img/loading.gif" lazyload alt="CP15 c15寄存器参数搭配"></p>
<p>可见GIC基地址保存在CBAR中，因此可通过<code>MRC p15, 4, r1, c15, c0, 0</code>指令获取GIC基地址至r1中。现在就可以设置GIC的寄存器了，比如：读取当前中断ID，将ID保存在<code>GICC_IAR</code>中，SDK中已经给出<code>GICC_IAR</code>的偏移地址<code>__IM  uint32_t C_IAR;                  /*!&lt; Offset: 0x200C (R/ ) Interrupt Acknowledge Register */</code>为<code>0x200C</code>，因此获取当前中断ID的汇编代码为：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">MRC</span> <span class="hljs-built_in">p15</span>, <span class="hljs-number">5</span>, <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">c15</span>, <span class="hljs-built_in">c0</span> ,<span class="hljs-number">0</span>  <span class="hljs-comment">;获取GIC基地址</span><br><span class="hljs-keyword">ADD</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0x2000</span>         <span class="hljs-comment">;基地址+0x2000得到CPU接口端寄存器起始地址</span><br><span class="hljs-keyword">LDR</span> <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>, <span class="hljs-number">#0xC</span>]          <span class="hljs-comment">;读取GIC_IAR的值</span><br></code></pre></td></tr></table></figure>
<p>总结：</p>
<ul>
<li>c0寄存器可获取到处理器内核信息</li>
<li>c1寄存器可使能或禁止MMU、I/D Cache</li>
<li>c12寄存器可设置中断向量偏移</li>
<li>c15可获取GIC基地址</li>
</ul>
<h3 id="中断使能"><a class="markdownIt-Anchor" href="#中断使能"></a> 中断使能</h3>
<h4 id="irq和fiq总中断使能"><a class="markdownIt-Anchor" href="#irq和fiq总中断使能"></a> IRQ和FIQ总中断使能</h4>
<p>汇编下支持以下快捷指令：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpsid i</td>
<td>禁止IRQ中断</td>
</tr>
<tr>
<td>cpsie i</td>
<td>使能IRQ中断</td>
</tr>
<tr>
<td>cpsid f</td>
<td>禁止FIQ中断</td>
</tr>
<tr>
<td>cpsie f</td>
<td>使能FIQ中断</td>
</tr>
</tbody>
</table>
<h4 id="id0-id1019-中断使能和禁止"><a class="markdownIt-Anchor" href="#id0-id1019-中断使能和禁止"></a> ID0 - ID1019 中断使能和禁止</h4>
<p>由以下寄存器完成：</p>
<ul>
<li><code>GICD_ISENABLERn</code>：<code>GICD_ISENABLER0</code>的bit[15:0]对应ID15 - 0的SGI中断，bit[31:16]对应ID31 - 16的PPI中断</li>
<li><code>GICD_ICENABLERn</code>：<code>GICD_ISENABLER1</code> - <code>GICD_ISENABLER15</code>控制SPI中断</li>
</ul>
<h3 id="中断优先级"><a class="markdownIt-Anchor" href="#中断优先级"></a> 中断优先级</h3>
<h4 id="优先级数量配置"><a class="markdownIt-Anchor" href="#优先级数量配置"></a> 优先级数量配置</h4>
<p><code>GICC_PMR</code>寄存器用于配置优先级数量，寄存器低8位有效。I.MX6U是Cortex-A7内核，支持32个优先级，因此<code>GICC_PMR</code>设置为<code>0b11111000</code>.</p>
<h4 id="抢占优先级和子优先级位数配置"><a class="markdownIt-Anchor" href="#抢占优先级和子优先级位数配置"></a> 抢占优先级和子优先级位数配置</h4>
<p>抢占优先级和子优先级各占多少位由寄存器<code>GICC_BPR</code>决定，低3位有效，配置如下所示：</p>
<table>
<thead>
<tr>
<th>Binary Point</th>
<th>抢占优先级域</th>
<th>子优先级域</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>[7:1]</td>
<td>[0]</td>
<td>7 级抢占优先级，1 级子优先级。</td>
</tr>
<tr>
<td>1</td>
<td>[7:2]</td>
<td>[1:0]</td>
<td>6 级抢占优先级，2 级子优先级。</td>
</tr>
<tr>
<td>2</td>
<td>[7:3]</td>
<td>[2:0]</td>
<td>5 级抢占优先级，3 级子优先级。</td>
</tr>
<tr>
<td>3</td>
<td>[7:4]</td>
<td>[3:0]</td>
<td>4 级抢占优先级，4 级子优先级。</td>
</tr>
<tr>
<td>4</td>
<td>[7:5]</td>
<td>[4:0]</td>
<td>3 级抢占优先级，5 级子优先级。</td>
</tr>
<tr>
<td>5</td>
<td>[7:6]</td>
<td>[5:0]</td>
<td>2 级抢占优先级，6 级子优先级。</td>
</tr>
<tr>
<td>6</td>
<td>[7:7]</td>
<td>[6:0]</td>
<td>1 级抢占优先级，7 级子优先级。</td>
</tr>
<tr>
<td>7</td>
<td>无</td>
<td>[7:0]</td>
<td>0 级抢占优先级，8 级子优先级。</td>
</tr>
</tbody>
</table>
<p>一般而言所有的中断优先级位都配置为抢占优先级。如IMX6U的优先级位数为5（32个优先级），可设置Binary point为2，表示5个优先级位全部为抢占优先级。</p>
<h4 id="优先级设置"><a class="markdownIt-Anchor" href="#优先级设置"></a> 优先级设置</h4>
<p>某个中断ID的中断优先级设置由寄存器<code>GICD_IPRIORITYR</code>完成，每个中断ID配有一个该寄存器，共512个。如果优先级个数为32，即使用<code>GICD_IPRIORITYR</code>的bit[7:4]来设置优先级（实际优先级左移3位）。例如，要设置ID == 40中断优先级为5：<code>GICD_IPRIORITYR[40] = 5 &lt;&lt; 3</code></p>
<p>总结一下，中断优先级设置分三部分：</p>
<ol>
<li>设置<code>GICC_PMR</code>，配置优先级个数，IMX6U为32级</li>
<li>设置抢占优先级和子优先级位数，一般默认所有位数都为抢占优先级</li>
<li>设置指定中断ID的优先级</li>
</ol>
<h3 id="复位中断服务函数"><a class="markdownIt-Anchor" href="#复位中断服务函数"></a> 复位中断服务函数</h3>
<p>整个启动文件在设置完中断向量表后，要进行复位中断的设置，其分为以下步骤：</p>
<ol>
<li>设置复位中断：关闭IRQ，然后关闭I/D Cache、MMU、对齐检测和分支预测</li>
<li>进行中断向量表重映射</li>
<li>设置IRQ模式、SYS模式和SVC模式下的栈指针，栈大小均为2MB</li>
<li>打开IRQ中断</li>
<li>跳转至main函数</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/* 复位中断 */</span>	<br><span class="hljs-symbol">Reset_Handler:</span><br><br>	<span class="hljs-keyword">cpsid</span> i						<span class="hljs-comment">/* 关闭全局中断 */</span><br><br>	<span class="hljs-comment">/* 关闭I,DCache和MMU </span><br><span class="hljs-comment">	 * 采取读-改-写的方式。</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">mrc</span>     <span class="hljs-built_in">p15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">c1</span>, <span class="hljs-built_in">c0</span>, <span class="hljs-number">0</span>     <span class="hljs-comment">/* 读取CP15的C1寄存器到R0中       		        	*/</span><br>    <span class="hljs-keyword">bic</span>     <span class="hljs-built_in">r0</span>,  <span class="hljs-built_in">r0</span>, #(<span class="hljs-number">0x1</span> &lt;&lt; <span class="hljs-number">12</span>)     <span class="hljs-comment">/* 清除C1寄存器的bit12位(I位)，关闭I Cache            	*/</span><br>    <span class="hljs-keyword">bic</span>     <span class="hljs-built_in">r0</span>,  <span class="hljs-built_in">r0</span>, #(<span class="hljs-number">0x1</span> &lt;&lt;  <span class="hljs-number">2</span>)     <span class="hljs-comment">/* 清除C1寄存器的bit2(C位)，关闭D Cache    				*/</span><br>    <span class="hljs-keyword">bic</span>     <span class="hljs-built_in">r0</span>,  <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x2</span>             <span class="hljs-comment">/* 清除C1寄存器的bit1(A位)，关闭对齐						*/</span><br>    <span class="hljs-keyword">bic</span>     <span class="hljs-built_in">r0</span>,  <span class="hljs-built_in">r0</span>, #(<span class="hljs-number">0x1</span> &lt;&lt; <span class="hljs-number">11</span>)     <span class="hljs-comment">/* 清除C1寄存器的bit11(Z位)，关闭分支预测					*/</span><br>    <span class="hljs-keyword">bic</span>     <span class="hljs-built_in">r0</span>,  <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x1</span>             <span class="hljs-comment">/* 清除C1寄存器的bit0(M位)，关闭MMU				       	*/</span><br>    mcr     <span class="hljs-built_in">p15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">c1</span>, <span class="hljs-built_in">c0</span>, <span class="hljs-number">0</span>     <span class="hljs-comment">/* 将r0寄存器中的值写入到CP15的C1寄存器中	 				*/</span><br><br><span class="hljs-comment">#if 0</span><br>	<span class="hljs-comment">/* 汇编版本设置中断向量表偏移 */</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0X87800000</span><br><br>	<span class="hljs-keyword">dsb</span><br>	<span class="hljs-keyword">isb</span><br>	mcr <span class="hljs-built_in">p15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">c12</span>, <span class="hljs-built_in">c0</span>, <span class="hljs-number">0</span><br>	<span class="hljs-keyword">dsb</span><br>	<span class="hljs-keyword">isb</span><br><span class="hljs-comment">#endif</span><br>    <br>	<span class="hljs-comment">/* 设置各个模式下的栈指针，</span><br><span class="hljs-comment">	 * 注意：IMX6UL的堆栈是向下增长的！</span><br><span class="hljs-comment">	 * 堆栈指针地址一定要是4字节地址对齐的！！！</span><br><span class="hljs-comment">	 * DDR范围:0X80000000~0X9FFFFFFF</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-comment">/* 进入IRQ模式 */</span><br>	<span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span><br>	<span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x1f</span> 	<span class="hljs-comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span><br>	<span class="hljs-keyword">orr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x12</span> 	<span class="hljs-comment">/* r0或上0x13,表示使用IRQ模式					*/</span><br>	<span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span>		<span class="hljs-comment">/* 将r0 的数据写入到cpsr_c中 					*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x80600000</span>	<span class="hljs-comment">/* 设置IRQ模式下的栈首地址为0X80600000,大小为2MB */</span><br><br>	<span class="hljs-comment">/* 进入SYS模式 */</span><br>	<span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span><br>	<span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x1f</span> 	<span class="hljs-comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span><br>	<span class="hljs-keyword">orr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x1f</span> 	<span class="hljs-comment">/* r0或上0x13,表示使用SYS模式					*/</span><br>	<span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span>		<span class="hljs-comment">/* 将r0 的数据写入到cpsr_c中 					*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x80400000</span>	<span class="hljs-comment">/* 设置SYS模式下的栈首地址为0X80400000,大小为2MB */</span><br><br>	<span class="hljs-comment">/* 进入SVC模式 */</span><br>	<span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span><br>	<span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x1f</span> 	<span class="hljs-comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span><br>	<span class="hljs-keyword">orr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x13</span> 	<span class="hljs-comment">/* r0或上0x13,表示使用SVC模式					*/</span><br>	<span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span>		<span class="hljs-comment">/* 将r0 的数据写入到cpsr_c中 					*/</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0X80200000</span>	<span class="hljs-comment">/* 设置SVC模式下的栈首地址为0X80200000,大小为2MB */</span><br><br>	<span class="hljs-keyword">cpsie</span> i				<span class="hljs-comment">/* 打开全局中断 */</span><br><span class="hljs-comment">#if 0</span><br>	<span class="hljs-comment">/* 使能IRQ中断 */</span><br>	<span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span>		<span class="hljs-comment">/* 读取cpsr寄存器值到r0中 			*/</span><br>	<span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0x80</span>	<span class="hljs-comment">/* 将r0寄存器中bit7清零，也就是CPSR中的I位清零，表示允许IRQ中断 */</span><br>	<span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span>		<span class="hljs-comment">/* 将r0重新写入到cpsr中 			*/</span><br><span class="hljs-comment">#endif</span><br><br>	<span class="hljs-keyword">b</span> main				<span class="hljs-comment">/* 跳转到main函数 			 	*/</span><br></code></pre></td></tr></table></figure>
<h3 id="其他中断"><a class="markdownIt-Anchor" href="#其他中断"></a> 其他中断</h3>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/* 未定义中断 */</span><br><span class="hljs-symbol">Undefined_Handler:</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=Undefined_Handler</span><br>	<span class="hljs-keyword">bx</span> <span class="hljs-built_in">r0</span><br><br><span class="hljs-comment">/* SVC中断 */</span><br><span class="hljs-symbol">SVC_Handler:</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=SVC_Handler</span><br>	<span class="hljs-keyword">bx</span> <span class="hljs-built_in">r0</span><br><br><span class="hljs-comment">/* 预取终止中断 */</span><br><span class="hljs-symbol">PrefAbort_Handler:</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=PrefAbort_Handler</span>	<br>	<span class="hljs-keyword">bx</span> <span class="hljs-built_in">r0</span><br><br><span class="hljs-comment">/* 数据终止中断 */</span><br><span class="hljs-symbol">DataAbort_Handler:</span><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=DataAbort_Handler</span><br>	<span class="hljs-keyword">bx</span> <span class="hljs-built_in">r0</span><br><br><span class="hljs-comment">/* 未使用的中断 */</span><br><span class="hljs-symbol">NotUsed_Handler:</span><br><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=NotUsed_Handler</span><br>	<span class="hljs-keyword">bx</span> <span class="hljs-built_in">r0</span><br><br>    <span class="hljs-comment">/* FIQ中断 */</span><br><span class="hljs-symbol">FIQ_Handler:</span><br><br>	<span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=FIQ_Handler</span>	<br>	<span class="hljs-keyword">bx</span> <span class="hljs-built_in">r0</span>	<br></code></pre></td></tr></table></figure>
<h3 id="irq中断服务函数"><a class="markdownIt-Anchor" href="#irq中断服务函数"></a> IRQ中断服务函数</h3>
<p>所有的外部中断都会触发IRQ中断，因此IRQ中断服务函数的工作就是获取当前发生的中断ID以确定中断来源，然后根据不同的外部中断来进行不同的处理。这里会涉及到几个ARM中常用的寄存器：</p>
<ul>
<li>IP寄存器：内部程序调用暂存寄存器，子程序的连接text段中常使用该规则</li>
<li>SP寄存器：栈指针寄存器，用于存储当前栈顶地址。程序执行过程中，栈是用来存储临时变量、函数调用返回地址等数据的重要数据结构，SP寄存器的值会随着栈的变化而变化</li>
<li>LR寄存器：连接寄存器，程序跳转（子程序调用，中断跳转）后，arm自动在该寄存器中存入原程序（未跳转）的下一条指令的地址，也叫函数调用返回地址。当一个函数被调用时，LR寄存器会存储调用该函数的下一条指令的地址，当函数执行完毕后，程序会跳转到LR寄存器中存储的地址继续执行。</li>
<li>PC寄存器：程序计数器，保存的是当前正在取指的指令的地址（arm采用2级流水线，因此是当前正在执行指令的地址+8）。PC寄存器是ARM中的程序计数器，用于存储下一条将要执行的指令的地址。</li>
</ul>
<p>此外，还有两个比较重要的状态寄存器：</p>
<ul>
<li>CPSR：程序状态寄存器，在任何处理器模式下被访问。它包含了条件标志位、中断禁止位、当前处理器模式标志以及其他的一些控制和状态位。CPSR在用户级编程时用于存储条件码。</li>
<li>SPSR：程序状态保存寄存器，每一种处理器模式下都有一个状态寄存器SPSR,SPSR用于保存CPSR的状态，以便异常返回后恢复异常发生时的工作状态。当特定的异常中断发生时，这个寄存器用于存放当前程序状态寄存器的内容。在异常中断退出时，可以用SPSR来恢复CPSR。由于用户模式和系统模式不是异常中断模式，所以他没有SPSR。当用户在用户模式或系统模式访问SPSR，将产生不可预知的后果。</li>
</ul>
<p>二者常用于MRS或MSR指令,用于spsr中的值转移到寄存器或把寄存器的内容加载到spsr中，如:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, spsr                <span class="hljs-comment">/* 读取spsr寄存器 */</span><br><span class="hljs-keyword">msr</span> <span class="hljs-built_in">spsr_cxsf</span>, <span class="hljs-built_in">r0</span>            <span class="hljs-comment">/* 恢复spsr */</span><br></code></pre></td></tr></table></figure>
<p>IRQ中断服务函数的编写大致分为以下步骤：</p>
<ol>
<li>进入IRQ模式，保存上下文。ARM在进入IRQ模式会自动切换LR和SPSR，但不会自动保存其他寄存器，因此需手动保存r0-r3和r12寄存器（后续操作可能修改）。自动切换时，LR保存被中断指令的下一条指令<code>-4</code>。</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/* IRQ中断 */</span><br><span class="hljs-symbol">IRQ_Handler:</span><br>	<span class="hljs-keyword">push</span> &#123;<span class="hljs-built_in">lr</span>&#125;					<span class="hljs-comment">/* 保存lr地址 */</span><br>	<span class="hljs-keyword">push</span> &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r3</span>, <span class="hljs-built_in">r12</span>&#125;			<span class="hljs-comment">/* 保存r0-r3，r12寄存器 */</span><br></code></pre></td></tr></table></figure>
<ol start="2">
<li>保存现场。SPSR存储被中断前CPU的模式状态，必须保存SPSR以正确恢复中断前的执行环境。</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, spsr				<span class="hljs-comment">/* 读取spsr寄存器 */</span><br><span class="hljs-keyword">push</span> &#123;<span class="hljs-built_in">r0</span>&#125;					<span class="hljs-comment">/* 保存spsr寄存器 */</span><br></code></pre></td></tr></table></figure>
<ol start="3">
<li>获取GIC中断号。通过MRC向cp15读取寄存器以获取GIC基址，从而计算GICC_IAR地址并读取，读取后自动标记该中断为active状态，获取到的中断号<code>r0</code>作为参数传递给C语言ISR。</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">mrc</span> <span class="hljs-built_in">p15</span>, <span class="hljs-number">4</span>, <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">c15</span>, <span class="hljs-built_in">c0</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/* 读取CP15的C0寄存器内的值到R1寄存器中</span><br><span class="hljs-comment">							* 参考文档ARM Cortex-A(armV7)编程手册V4.0.pdf P49</span><br><span class="hljs-comment">							* Cortex-A7 Technical ReferenceManua.pdf P68 P138</span><br><span class="hljs-comment">							*/</span>							<br><span class="hljs-keyword">add</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0X2000</span>			<span class="hljs-comment">/* GIC基地址加0X2000，也就是GIC的CPU接口端基地址 */</span><br><span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>, <span class="hljs-number">#0XC</span>]			<span class="hljs-comment">/* GIC的CPU接口端基地址加0X0C就是GICC_IAR寄存器，</span><br><span class="hljs-comment">							 * GICC_IAR寄存器保存这当前发生中断的中断号，我们要根据</span><br><span class="hljs-comment">							 * 这个中断号来绝对调用哪个中断服务函数</span><br><span class="hljs-comment">							 */</span><br><span class="hljs-keyword">push</span> &#123;<span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r1</span>&#125;				<span class="hljs-comment">/* 保存r0,r1 */</span><br></code></pre></td></tr></table></figure>
<ol start="4">
<li>切换至SVC模式并调用C函数。IAR模式栈空间有限，切换至SVC模式（特权模式）以获得更大的栈空间，并允许C函数处理更复杂的逻辑，如中断嵌套。</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">cps</span> <span class="hljs-number">#0x13</span>					<span class="hljs-comment">/* 进入SVC模式，允许其他中断再次进去 */</span><br><br><span class="hljs-keyword">push</span> &#123;<span class="hljs-built_in">lr</span>&#125;					<span class="hljs-comment">/* 保存SVC模式的lr寄存器 */</span><br><span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r2</span>, <span class="hljs-symbol">=system_irqhandler</span>	<span class="hljs-comment">/* 加载C语言中断处理函数到r2寄存器中*/</span><br><span class="hljs-keyword">blx</span> <span class="hljs-built_in">r2</span>						<span class="hljs-comment">/* 运行C语言中断处理函数，带有中断号参数，保存在R0寄存器中 */</span><br></code></pre></td></tr></table></figure>
<ol start="5">
<li>恢复模式并发送中断结束信号。向向GIC的End of Interrupt Register (GICC_EOIR) 写入中断号，告知中断控制器该中断已处理完毕。</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">pop</span> &#123;<span class="hljs-built_in">lr</span>&#125;					<span class="hljs-comment">/* 执行完C语言中断服务函数，lr出栈 */</span><br><span class="hljs-keyword">cps</span> <span class="hljs-number">#0x12</span>					<span class="hljs-comment">/* 进入IRQ模式 */</span><br><span class="hljs-keyword">pop</span> &#123;<span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r1</span>&#125;				<br><span class="hljs-keyword">str</span> <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>, <span class="hljs-number">#0X10</span>]			<span class="hljs-comment">/* 中断执行完成，写EOIR */</span><br></code></pre></td></tr></table></figure>
<ol start="6">
<li>恢复中断前状态并返回。</li>
</ol>
<p>这里是一个很容易搞错的点。ARM使用三级流水线机制：取指-&gt;译指-&gt;执行，而我们总以执行位置作为参考点，因此PC永远是当前执行位置<code>+8</code>；LR存放函数调用结束后返回继续执行的地址，也就是当前执行指令的下一条(<code>+4</code>)。进入IRQ中断时，中断总是在执行一条指令后再进入，此时PC更新为<code>+12</code>，相应的LR变为<code>+8</code>，然后LR被入栈保存。如果中断结束后，直接将LR出栈，程序会从<code>+8</code>处开始运行，那么<code>+4</code>处的指令就直接被跳过了。因此，中断结束后将LR出栈时，要将LR<code>-4</code>。</p>
<p>用表格可以解释为：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th>状态A：中断前</th>
<th>状态B：进入中断后</th>
<th>状态C：中断恢复</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>MOV R1, R0</td>
<td>准备执行</td>
<td>已执行</td>
<td></td>
</tr>
<tr>
<td>0x04</td>
<td>MOV R2, R1</td>
<td>LR</td>
<td></td>
<td>LR（恢复为状态A时的PC值-4）</td>
</tr>
<tr>
<td>0x08</td>
<td>MOV R3, R2</td>
<td>PC</td>
<td>LR（已入栈）</td>
<td></td>
</tr>
<tr>
<td>0x0c</td>
<td>MOV R4 ,R3</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>PC值</td>
<td>0x08</td>
<td>0x12</td>
<td>由LR值决定</td>
</tr>
<tr>
<td></td>
<td>LR值</td>
<td>0x04</td>
<td>0x08</td>
<td>0x04</td>
</tr>
</tbody>
</table>
<p>再通俗一点：PC始终指向当前执行指令+8，发生中断时，入栈保存的LR实际上是PC的地址，如果返回时将LR直接赋给PC，中间就跳过了一个指令，因此LR出栈后要<code>-4</code>才能赋给PC。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">pop</span> &#123;<span class="hljs-built_in">r0</span>&#125;						<br><span class="hljs-keyword">msr</span> <span class="hljs-built_in">spsr_cxsf</span>, <span class="hljs-built_in">r0</span>			<span class="hljs-comment">/* 恢复spsr */</span><br><br><span class="hljs-keyword">pop</span> &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r3</span>, <span class="hljs-built_in">r12</span>&#125;			<span class="hljs-comment">/* r0-r3,r12出栈 */</span><br><span class="hljs-keyword">pop</span> &#123;<span class="hljs-built_in">lr</span>&#125;					<span class="hljs-comment">/* lr出栈 */</span><br><span class="hljs-keyword">subs</span> <span class="hljs-built_in">pc</span>, <span class="hljs-built_in">lr</span>, <span class="hljs-number">#4</span>				<span class="hljs-comment">/* 将计算后的地址（lr-4）赋给pc */</span>	<br></code></pre></td></tr></table></figure>
<h3 id="中断驱动文件c函数"><a class="markdownIt-Anchor" href="#中断驱动文件c函数"></a> 中断驱动文件（C函数）</h3>
<ol>
<li>中断初始化函数。向量表基地址设置为程序存放开始地址。</li>
</ol>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">void <span class="hljs-built_in">int_init</span>(void) &#123;<br>    <span class="hljs-built_in">GIC_Init</span>();                        <span class="hljs-comment">// 初始化通用中断控制器，该函数由SDK提供</span><br>    <span class="hljs-built_in">system_irqtable_init</span>();            <span class="hljs-comment">// 初始化中断函数表</span><br>    <span class="hljs-built_in">__set_VBAR</span>((uint32_t)<span class="hljs-number">0</span>x87800000);  <span class="hljs-comment">// 设置向量表基地址</span><br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="2">
<li>中断向量表初始化。将所有中断初始化为default_irqhandler（死循环），强制开发者显式注册有效ISR，避免未处理中断导致不可控行为。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">system_irqtable_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    irqNesting = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 重置嵌套计数器</span><br>    <br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NUMBER_OF_INT_VECTORS; i++) &#123;<br>        <span class="hljs-built_in">system_register_irqhandler</span>((IRQn_Type)i, default_irqhandler, <span class="hljs-literal">NULL</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="3">
<li>中断注册函数。用于绑定中断服务函数和中断源。</li>
</ol>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">system_register_irqhandler</span><span class="hljs-params">(IRQn_Type irq, system_irq_handler_t <span class="hljs-keyword">handler</span>, <span class="hljs-keyword">void</span> *userParam)</span> </span>&#123;<br>    irqTable[irq].irqHandler = <span class="hljs-keyword">handler</span>;   <span class="hljs-comment">// 注册处理函数</span><br>    irqTable[irq].userParam = userParam;  <span class="hljs-comment">// 绑定用户参数</span><br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="4">
<li>中断分发器。默认允许中断嵌套。</li>
</ol>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-built_in">void</span> system_irqhandler(unsigned <span class="hljs-built_in">int</span> giccIar) &#123;<br>    <span class="hljs-built_in">uint32</span>_t <span class="hljs-built_in">int</span>Num = giccIar &amp; <span class="hljs-number">0x3FF</span>UL;  <span class="hljs-comment">// 提取中断号</span><br>    <br>    <span class="hljs-comment">/* 校验中断号有效性 */</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">int</span>Num == <span class="hljs-number">1023</span>) || (<span class="hljs-built_in">int</span>Num &gt;= NUMBER_OF_INT_VECTORS)) &#123;<br>        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 非法中断号（1023伪中断或中断号不在表内）直接返回</span><br>    &#125;<br> <br>    irqNesting++;  <span class="hljs-comment">// 嵌套计数增加</span><br>    <br>    <span class="hljs-comment">/* 调用注册的ISR */</span><br>    irqTable[<span class="hljs-built_in">int</span>Num].irqHandler(<span class="hljs-built_in">int</span>Num, irqTable[<span class="hljs-built_in">int</span>Num].userParam);<br> <br>    irqNesting--;  <span class="hljs-comment">// 嵌套计数减少</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="中断处理全流程"><a class="markdownIt-Anchor" href="#中断处理全流程"></a> 中断处理全流程</h3>
<ol>
<li>硬件触发：外设触发中断，GIC将中断请求发送至CPU。</li>
<li>汇编入口：CPU跳转至IRQ_Handler，保存上下文并调用system_irqhandler(giccIar)。</li>
<li>中断分发：
<ul>
<li>解析giccIar获取有效中断号</li>
<li>查表irqTable[intNum]获取处理函数和参数</li>
</ul>
</li>
<li>ISR执行：执行用户注册的函数（如uart_isr），处理具体中断任务。</li>
<li>中断结束：汇编代码写GICC_EOIR通知GIC处理完成。</li>
</ol>
<h2 id="示例定时器按键消抖"><a class="markdownIt-Anchor" href="#示例定时器按键消抖"></a> 示例（定时器按键消抖）</h2>
<p>实现功能：</p>
<ol>
<li>按下按键，进入外部中断，在中断中开启定时器</li>
<li>定时器中断中完成消抖延时，中断周期即为延时时间。如果定时中断触发，表示消抖完成，执行按键处理函数</li>
</ol>
<h3 id="按键初始化"><a class="markdownIt-Anchor" href="#按键初始化"></a> 按键初始化</h3>
<ol>
<li>设置GPIO复用和Config</li>
<li>填充gpio结构体，初始化gpio</li>
<li>使能中断，注册ISR（绑定中断源和对应的ISR）</li>
<li>初始化定时器</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">filterkey_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;	<br>	<span class="hljs-type">gpio_pin_config_t</span> key_config;<br>	<br>	<span class="hljs-comment">/* 1、初始化IO复用 */</span><br>	<span class="hljs-built_in">IOMUXC_SetPinMux</span>(IOMUXC_UART1_CTS_B_GPIO1_IO18,<span class="hljs-number">0</span>);	<span class="hljs-comment">/* 复用为GPIO1_IO18 */</span><br><br>	<span class="hljs-comment">/* 2、、配置GPIO1_IO18的IO属性	</span><br><span class="hljs-comment">	 *bit 16:0 HYS关闭</span><br><span class="hljs-comment">	 *bit [15:14]: 11 默认22K上拉</span><br><span class="hljs-comment">	 *bit [13]: 1 pull功能</span><br><span class="hljs-comment">	 *bit [12]: 1 pull/keeper使能</span><br><span class="hljs-comment">	 *bit [11]: 0 关闭开路输出</span><br><span class="hljs-comment">	 *bit [7:6]: 10 速度100Mhz</span><br><span class="hljs-comment">	 *bit [5:3]: 000 关闭输出</span><br><span class="hljs-comment">	 *bit [0]: 0 低转换率</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-built_in">IOMUXC_SetPinConfig</span>(IOMUXC_UART1_CTS_B_GPIO1_IO18,<span class="hljs-number">0xF080</span>);<br>	<br>	<span class="hljs-comment">/* 3、初始化GPIO为中断 */</span><br>	key_config.direction = kGPIO_DigitalInput;          <span class="hljs-comment">/* 输入 */</span><br>	key_config.interruptMode = kGPIO_IntFallingEdge;    <span class="hljs-comment">/* 下降沿触发 */</span><br>	key_config.outputLogic = <span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">gpio_init</span>(GPIO1, <span class="hljs-number">18</span>, &amp;key_config);<br><br>	<span class="hljs-built_in">GIC_EnableIRQ</span>(GPIO1_Combined_16_31_IRQn); <span class="hljs-comment">/* 使能GIC中对应的中断 */</span><br>	<br>	<span class="hljs-comment">/* 注册中断服务函数 */</span><br>	<span class="hljs-built_in">system_register_irqhandler</span>(GPIO1_Combined_16_31_IRQn, <br>							   (<span class="hljs-type">system_irq_handler_t</span>)gpio1_16_31_irqhandler, <br>							   <span class="hljs-literal">NULL</span>);<br>	<br>	<span class="hljs-built_in">gpio_enableint</span>(GPIO1, <span class="hljs-number">18</span>);		<span class="hljs-comment">/* 使能GPIO1_IO18的中断功能 */</span><br><br>	<span class="hljs-built_in">filtertimer_init</span>(<span class="hljs-number">66000000</span>/<span class="hljs-number">100</span>);	<span class="hljs-comment">/* 初始化定时器,10ms */</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="定时器初始化"><a class="markdownIt-Anchor" href="#定时器初始化"></a> 定时器初始化</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">filtertimer_init</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value)</span></span><br><span class="hljs-function"></span>&#123;<br>	EPIT1-&gt;CR = <span class="hljs-number">0</span>;	<span class="hljs-comment">//先清零</span><br>	<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">     * CR寄存器:</span><br><span class="hljs-comment">     * bit25:24 01 时钟源选择Peripheral clock=66MHz</span><br><span class="hljs-comment">     * bit15:4  0  1分频</span><br><span class="hljs-comment">     * bit3:	1  当计数器到0的话从LR重新加载数值</span><br><span class="hljs-comment">     * bit2:	1  比较中断使能</span><br><span class="hljs-comment">     * bit1:    1  初始计数值来源于LR寄存器值</span><br><span class="hljs-comment">     * bit0:    0  先关闭EPIT1</span><br><span class="hljs-comment">     */</span><br>	EPIT1-&gt;CR = (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">24</span> | <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span> | <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">2</span> | <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);<br><br>	<span class="hljs-comment">/* 计数值 */</span><br>	EPIT1-&gt;LR = value;<br>	<br>	<span class="hljs-comment">/* 比较寄存器，当计数器值和此寄存器值相等的话就会产生中断 */</span><br>	EPIT1-&gt;CMPR	= <span class="hljs-number">0</span>;	<br>	<br>	<span class="hljs-built_in">GIC_EnableIRQ</span>(EPIT1_IRQn);	<span class="hljs-comment">/* 使能GIC中对应的中断 */</span><br>	<br>	<span class="hljs-comment">/* 注册中断服务函数		    */</span><br>	<span class="hljs-built_in">system_register_irqhandler</span>(EPIT1_IRQn, (<span class="hljs-type">system_irq_handler_t</span>)filtertimer_irqhandler, <span class="hljs-literal">NULL</span>);	<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="gpio-isr函数"><a class="markdownIt-Anchor" href="#gpio-isr函数"></a> GPIO ISR函数</h3>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss">void <span class="hljs-built_in">gpio1_16_31_irqhandler</span>(void)<br>&#123; <br>	<span class="hljs-comment">/* 开启定时器 */</span><br>	<span class="hljs-built_in">filtertimer_restart</span>(<span class="hljs-number">66000000</span>/<span class="hljs-number">100</span>);<br><br>	<span class="hljs-comment">/* 清除中断标志位 */</span><br>	<span class="hljs-built_in">gpio_clearintflags</span>(GPIO1, <span class="hljs-number">18</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="定时器-isr函数"><a class="markdownIt-Anchor" href="#定时器-isr函数"></a> 定时器 ISR函数</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">filtertimer_irqhandler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123; <br>	<span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> state = OFF;<br><br>	<span class="hljs-keyword">if</span>(EPIT1-&gt;SR &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>)) 					<span class="hljs-comment">/* 判断比较事件是否发生			*/</span><br>	&#123;<br>		<span class="hljs-built_in">filtertimer_stop</span>();					<span class="hljs-comment">/* 关闭定时器 				*/</span><br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">gpio_pinread</span>(GPIO1, <span class="hljs-number">18</span>) == <span class="hljs-number">0</span>)	<span class="hljs-comment">/* KEY0 				*/</span><br>		&#123;<br>			state = !state;<br>			<span class="hljs-built_in">beep_switch</span>(state);				<span class="hljs-comment">/* 反转蜂鸣器 				*/</span><br>		&#125;<br>	&#125;<br>		<br>	EPIT1-&gt;SR |= <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>; 						<span class="hljs-comment">/* 清除中断标志位 				*/</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="辅助函数"><a class="markdownIt-Anchor" href="#辅助函数"></a> 辅助函数</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">filtertimer_stop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>	EPIT1-&gt;CR &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);	<span class="hljs-comment">/* 关闭定时器 */</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">filtertimer_restart</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value)</span></span><br><span class="hljs-function"></span>&#123;<br>	EPIT1-&gt;CR &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);	<span class="hljs-comment">/* 先关闭定时器 */</span><br>	EPIT1-&gt;LR = value;		<span class="hljs-comment">/* 计数值 			*/</span><br>	EPIT1-&gt;CR |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);	<span class="hljs-comment">/* 打开定时器 		*/</span><br>&#125;<br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F-Linux%E5%BC%80%E5%8F%91/" class="category-chain-item">嵌入式(Linux开发)</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>IMX6ULL外部中断配置</div>
      <div>http://akichen891.github.io/2025/03/04/IMX6ULL外部中断配置/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Aki</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月4日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025年3月5日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/05/DDR3%E9%85%8D%E7%BD%AE/" title="IMX6UL DDR3配置">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">IMX6UL DDR3配置</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/03/%E6%97%B6%E9%92%9F%E9%85%8D%E7%BD%AE/" title="I.MX6ULL 时钟配置">
                        <span class="hidden-mobile">I.MX6ULL 时钟配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
