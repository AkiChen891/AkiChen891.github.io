

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">

<head>
  <meta name="google-site-verification" content="Qd4BJop_tJyti_Gc8cDS3G09bPdOfn-O0if6QYHhtXY" />
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon.png">
  <link rel="icon" href="/images/favicon_mos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#233BA7">
  <meta name="author" content="Aki Chen">
  <meta name="keywords" content="">
  
    <meta name="description" content="I2C简介 I2C是由数据线SDA和时钟线SCL构成的串行总线，用于发送或接收数据。其中SDA用于传输数据。SCL用于同步时钟信号。I2C还有以下特征：  主从架构  主机（Master）：控制通信过程，生成时钟信号并启动通信 从机（Slave）：响应主机指令，按地址匹配参与通信   地址：每个从设备具有唯一的7位或10位地址，用于识别通信目标。主设备在通信开始时发送从设备地址，从设备响应后开始">
<meta property="og:type" content="article">
<meta property="og:title" content="STM32中的I2C通信">
<meta property="og:url" content="http://akichen891.github.io/2024/12/07/STM32%E4%B8%AD%E7%9A%84I2C%E9%80%9A%E4%BF%A1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="I2C简介 I2C是由数据线SDA和时钟线SCL构成的串行总线，用于发送或接收数据。其中SDA用于传输数据。SCL用于同步时钟信号。I2C还有以下特征：  主从架构  主机（Master）：控制通信过程，生成时钟信号并启动通信 从机（Slave）：响应主机指令，按地址匹配参与通信   地址：每个从设备具有唯一的7位或10位地址，用于识别通信目标。主设备在通信开始时发送从设备地址，从设备响应后开始">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://akichen891.github.io/images/arm/i2c1.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/i2c2.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/i2c3.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/24c021.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/24c022.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/24c023.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/24c024.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/24c025.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/i2c4.png">
<meta property="og:image" content="http://akichen891.github.io/images/arm/i2c5.png">
<meta property="article:published_time" content="2024-12-07T12:41:46.000Z">
<meta property="article:modified_time" content="2024-12-12T14:25:25.319Z">
<meta property="article:author" content="Aki Chen">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://akichen891.github.io/images/arm/i2c1.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>STM32中的I2C通信 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"akichen891.github.io","root":"/","version":"1.9.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Aki&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/images/Ringlan.JPG') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">STM32中的I2C通信</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-07 20:41" pubdate>
          2024年12月7日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          34 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">STM32中的I2C通信</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="i2c简介"><a class="markdownIt-Anchor" href="#i2c简介"></a> I2C简介</h2>
<p>I2C是由数据线SDA和时钟线SCL构成的串行总线，用于发送或接收数据。其中SDA用于传输数据。SCL用于同步时钟信号。I2C还有以下特征：</p>
<ol>
<li>主从架构
<ul>
<li>主机（Master）：控制通信过程，生成时钟信号并启动通信</li>
<li>从机（Slave）：响应主机指令，按地址匹配参与通信</li>
</ul>
</li>
<li>地址：每个从设备具有唯一的7位或10位地址，用于识别通信目标。主设备在通信开始时发送从设备地址，从设备响应后开始数据传输</li>
<li>半双工通信： 数据线支持双向通信，但同一时刻只允许数据单向传输</li>
<li>数据速率：
<ul>
<li>标准模式（Standard Mode）：最大速率100 kbps</li>
<li>快速模式（Fast Mode）：最大速率400 kbps</li>
<li>高速模式（High-Speed Mode）：最大速率3.4 Mbps</li>
</ul>
</li>
<li>开漏设计：信号线通常采用开漏驱动，需要外部上拉电阻将信号线拉高到逻辑高电平。因此总线空闲时，SDA和DCL都为高电平。</li>
<li>多设备连接：可以有多个具备 IIC 通信能力的设备挂载在上面，同时支持多个主机和多个从机，连接到总线的接口数量只由总线电容 400pF 的限制决定。</li>
</ol>
<h2 id="i2c时序和读写操作"><a class="markdownIt-Anchor" href="#i2c时序和读写操作"></a> I2C时序和读写操作</h2>
<h3 id="时序信号"><a class="markdownIt-Anchor" href="#时序信号"></a> 时序信号</h3>
<p><img src="/images/arm/i2c1.png" srcset="/img/loading.gif" lazyload alt="I2C总线时序图"></p>
<ol>
<li>起始信号：主机发出，为电平跳变信号而非恒电平信号。SCL为高电平期间，SDA由高电平跳变至低电平，总线被占用，准备数据传输</li>
<li>停止信号：主机发出，为电平跳变信号而非恒电平信号。SCL为高电平期间，SDA由低电平跳变至高电平，总线空闲</li>
<li>应答信号：发送器每发送一个字节，就在时钟脉冲 9 期间释放数据线，由接收器反馈一个应答信号。应答信号为低电平时，规定为有效应答位（ACK 简称应答位），表示接收器已经成功地接收了该字节。应答信号为高电平时，规定为非应答位（NACK），一般表示接收器接收该字节没有成功</li>
<li>数据有效性：总线进行数据传送时，时钟信号为高电平期间，数据线上的数据必须保持稳定，只有在时钟线上的信号为低电平期间，数据线上的高电平或低电平状态才允许变化。数据在 SCL 的上升沿到来之前就需准备好。并在下降沿到来之前必须稳定</li>
<li>数据传输：总线上传送的每一位数据都有一个时钟脉冲相对应（或同步控制），即在 SCL 串行时钟的配合下，在 SDA 上逐位地串行传送每一位数据。数据位的传输是边沿触发</li>
<li>空闲状态：SDA 和 SCL两条信号线同时处于高电平时，规定为总线的空闲状态。此时各个器件的输出级场效应管均处在截止状态，即释放总线，由两条信号线各自的上拉电阻把电平拉高</li>
</ol>
<h3 id="写操作"><a class="markdownIt-Anchor" href="#写操作"></a> 写操作</h3>
<p><img src="/images/arm/i2c2.png" srcset="/img/loading.gif" lazyload alt="I2C写操作通讯"></p>
<ol>
<li>主机发送起始信号，令总线上的所有从机等待接收数据</li>
<li>主机发送从机地址+‘0’（写操作）组成的8位数据。从机接收到地址后，比对该地址是否为本机地址。若为本机地址，从机发送应答信号</li>
<li>主机向从机发送数据</li>
</ol>
<h3 id="读操作"><a class="markdownIt-Anchor" href="#读操作"></a> 读操作</h3>
<p><img src="/images/arm/i2c3.png" srcset="/img/loading.gif" lazyload alt="I2C读操作通讯"></p>
<ol>
<li>主机发送起始信号，令总线上的所有从机等待接收数据</li>
<li>主机发送从机地址+‘1’（读操作）组成的8位数据。从机接收到地址后，比对该地址是否为本机地址。若为本机地址，从机发送应答信号</li>
<li>从机向主机发送数据</li>
</ol>
<p>若主机一直返回应答信号，那么从机可以一直发送数据，直到主机发送NACK信号为止。</p>
<h2 id="24c02时序"><a class="markdownIt-Anchor" href="#24c02时序"></a> 24C02时序</h2>
<p>24C02 是一个 2K bit 的串行 EEPROM 存储器，内部含有 256 个字节。在 24C02 里面还有一个 8 字节的页写缓冲器。该设备的通信方式为 IIC，通过其 SCL 和 SDA 与其他设备通信。</p>
<p><img src="/images/arm/24c021.png" srcset="/img/loading.gif" lazyload alt="24C02引脚"></p>
<p>WP为写保护引脚，高电平只读，低电平开放读写功能。24C02的设备地址共8位，包含不可编程部分和可编程部分，可编程部分根据硬件Pin A0、A1、A2决定；设备地址最后一位用于设置是读操作还是写操作。具体为：</p>
<p><img src="/images/arm/24c022.png" srcset="/img/loading.gif" lazyload alt="24C02设备地址格式"></p>
<p>本文中A0、A1、A2均接地，故24C02设备读操作地址为<code>0xA1</code>，写操作地址为<code>0xA0</code>。</p>
<h2 id="24c02读写操作"><a class="markdownIt-Anchor" href="#24c02读写操作"></a> 24C02读写操作</h2>
<p><img src="/images/arm/24c023.png" srcset="/img/loading.gif" lazyload alt="24C02写时序"></p>
<p>主机在 IIC 总线发送第 1 个字节的数据为24C02的设备地址<code>0xA0</code>，用于寻找总线上的24C02，在获得24C02的应答信号之后，继续发送第 2 个字节数据，该字节数据是 24C02 的内存地址，再等到 24C02 的应答信号，主机继续发送第 3 字节数据，这里的数据即是写入在第 2 字节内存地址的数据。主机完成写操作后，可以发出停止信号，终止数据传输。这种写操作每次只能写入1字节数据。</p>
<p><img src="/images/arm/24c024.png" srcset="/img/loading.gif" lazyload alt="24C02页写时序"></p>
<p>写操作时，24C02可以使用页写时序，其和普通写时序的区别是页写时序只需要告知一次内存地址1，后面的数据会按照写入顺序存入内存地址2、内存地址3等，节省通信时间。</p>
<p><img src="/images/arm/24c025.png" srcset="/img/loading.gif" lazyload alt="24C02读时序"></p>
<p>24C02读取数据的过程是一个复合的时序，其中包含写时序和读时序。通常第一个通信过程为写时序，起始信号产生后，主机发送24C02设备地址<code>0xA0</code>，获取从机应答信号后，接着发送需要读取的内存地址；在随后的读时序中，起始信号产生后，主机发送24C02设备地址<code>0xA1</code>, 获取从机应答信号后，从机返回刚刚在写时序中传递的内存地址的数据，以字节为单位传输在总线上，假如主机获取数据后返回的是应答信号，那么从机会一直传输数据，当主机发出的是非应答信号并以停止信号发出为结束，从机结束传输。</p>
<h2 id="软件模拟i2c"><a class="markdownIt-Anchor" href="#软件模拟i2c"></a> 软件模拟I2C</h2>
<p>HAL库自带的硬件I2C函数比较复杂，多采用软件模拟I2C的方式操作GPIO以获得I2C时序。</p>
<h3 id="custom_i2ch头文件"><a class="markdownIt-Anchor" href="#custom_i2ch头文件"></a> custom_i2c.h（头文件）</h3>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/**<br> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><br><span class="hljs-bullet"> *</span> @file        custom<span class="hljs-emphasis">_i2c.h</span><br><span class="hljs-emphasis"> * @author      Aki</span><br><span class="hljs-emphasis"> * @version     V1.0</span><br><span class="hljs-emphasis"> * @date        2024-12-11</span><br><span class="hljs-emphasis"> * @brief       软件IIC头文件</span><br><span class="hljs-emphasis"> <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis"> */</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">#ifndef <span class="hljs-strong">__MYIIC_H</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">#define __</span>MYIIC_</span>H<br><br><span class="hljs-section">#include &quot;sys.h&quot;</span><br><br><br>/<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**/</span><br><span class="hljs-strong">/* 引脚定义 <span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SCL_GPIO_PORT               GPIOH</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SCL_GPIO_PIN                GPIO_PIN_4</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SCL_GPIO_CLK_ENABLE()       do&#123; __HAL_RCC_GPIOH_CLK_ENABLE(); &#125;while(0)   /*</span> PH口时钟使能 <span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SDA_GPIO_PORT               GPIOH</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SDA_GPIO_PIN                GPIO_PIN_5</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SDA_GPIO_CLK_ENABLE()       do&#123; __HAL_RCC_GPIOH_CLK_ENABLE(); &#125;while(0)   /*</span> PH口时钟使能 <span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">/*</span>**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">/*</span> IO操作 <span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SCL(x)        do&#123; x ? \</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">                              HAL_GPIO_WritePin(IIC_SCL_GPIO_PORT, IIC_SCL_GPIO_PIN, GPIO_PIN_SET) : \</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">                              HAL_GPIO_WritePin(IIC_SCL_GPIO_PORT, IIC_SCL_GPIO_PIN, GPIO_PIN_RESET); \</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">                          &#125;while(0)       /*</span> SCL <span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_SDA(x)        do&#123; x ? \</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">                              HAL_GPIO_WritePin(IIC_SDA_GPIO_PORT, IIC_SDA_GPIO_PIN, GPIO_PIN_SET) : \</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">                              HAL_GPIO_WritePin(IIC_SDA_GPIO_PORT, IIC_SDA_GPIO_PIN, GPIO_PIN_RESET); \</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">                          &#125;while(0)       /*</span> SDA <span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#define IIC_READ_SDA     HAL_GPIO_ReadPin(IIC_SDA_GPIO_PORT, IIC_SDA_GPIO_PIN)        /*</span> 读取SDA电平 <span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">/*</span>**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*/</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">void iic_init(void);                        </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">void iic_start(void);                       </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">void iic_stop(void);                      </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">void iic_ack(void);                        </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">void iic_nack(void);                       </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">uint8_t iic_wait_ack(void);                 </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">void iic_send_byte(uint8_t data);          </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">uint8_t iic_read_byte(unsigned char ack);   </span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">#endif</span></span><br></code></pre></td></tr></table></figure>
<p>这里宏定义利用了两个小技巧：</p>
<ul>
<li>三目运算符：x ? … : … 是一个条件（三目）运算符。它的工作原理是：根据 x 的值（x 是一个表达式），判断执行哪一部分代码。如果 x 为 true（非零），执行冒号前的表达式；如果 x 为 false（零），执行冒号后的表达式。</li>
<li><code>do &#123; ... &#125; while(0)</code>：确保宏只执行一次且不会干扰外部代码结构的惯用法。这样做可以确保宏在使用时，代码不会因缺少括号而引发语法错误。</li>
</ul>
<h3 id="custom_i2cc"><a class="markdownIt-Anchor" href="#custom_i2cc"></a> custom_i2c.c</h3>
<h4 id="初始化"><a class="markdownIt-Anchor" href="#初始化"></a> 初始化</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/** </span><br><span class="hljs-comment">    <span class="hljs-doctag">@brief</span>:IIC初始化</span><br><span class="hljs-comment">    <span class="hljs-doctag">@param</span>:NULL</span><br><span class="hljs-comment">    <span class="hljs-doctag">@return</span>:NULL</span><br><span class="hljs-comment">**/</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">iic_init</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>    GPIO_InitTypeDef gpio_init_struct;<br><br>    <span class="hljs-title function_">IIC_SCL_GPIO_CLK_ENABLE</span>();  <span class="hljs-comment">/* SCL引脚时钟使能 */</span><br>    <span class="hljs-title function_">IIC_SDA_GPIO_CLK_ENABLE</span>();  <span class="hljs-comment">/* SDA引脚时钟使能 */</span><br><br>    <span class="hljs-comment">/* SCL */</span><br>    gpio_init_struct.<span class="hljs-property">Pin</span> = <span class="hljs-variable constant_">IIC_SCL_GPIO_PIN</span>;<br>    gpio_init_struct.<span class="hljs-property">Mode</span> = <span class="hljs-variable constant_">GPIO_MODE_OUTPUT_PP</span>;    <span class="hljs-comment">/* 推挽输出 */</span><br>    gpio_init_struct.<span class="hljs-property">Pull</span> = <span class="hljs-variable constant_">GPIO_PULLUP</span>;            <span class="hljs-comment">/* 上拉 */</span><br>    gpio_init_struct.<span class="hljs-property">Speed</span> = <span class="hljs-variable constant_">GPIO_SPEED_FREQ_VERY_HIGH</span>;<br>    <span class="hljs-title function_">HAL_GPIO_Init</span>(<span class="hljs-variable constant_">IIC_SCL_GPIO_PORT</span>, &amp;gpio_init_struct);<br><br>    <span class="hljs-comment">/* SDA */</span><br>    gpio_init_struct.<span class="hljs-property">Pin</span> = <span class="hljs-variable constant_">IIC_SDA_GPIO_PIN</span>;<br>    gpio_init_struct.<span class="hljs-property">Mode</span> = <span class="hljs-variable constant_">GPIO_MODE_OUTPUT_OD</span>;    <span class="hljs-comment">/* 开漏输出 */</span><br>    <span class="hljs-title function_">HAL_GPIO_Init</span>(<span class="hljs-variable constant_">IIC_SDA_GPIO_PORT</span>, &amp;gpio_init_struct);<br><br>    <span class="hljs-title function_">iic_stop</span>();     <span class="hljs-comment">/* 停止总线上所有设备 */</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里SDA线使用开漏输出，这意味着当SDA引脚输出低电平时，设备直接将线拉低（输出低电平）；而当设备输出高电平时，它并不直接将线拉高，而是将SDA引脚设置为高阻态（即不驱动该引脚。当一个设备希望发送数据时，如果它需要输出0（低电平），它会直接将SDA引脚拉低。当它需要发送1（高电平），它不会直接将SDA引脚拉高，而是让SDA引脚处于高阻态，让总线上的其他设备（如果有）通过拉高SDA线来实现高电平。这么做可以有效避免连接多个从机时发生电平冲突。STM32F429使用开漏模式时，必须外界上拉电阻。</p>
<h4 id="延时"><a class="markdownIt-Anchor" href="#延时"></a> 延时</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/** </span><br><span class="hljs-comment">    <span class="hljs-doctag">@brief</span>:IIC延时函数</span><br><span class="hljs-comment">    <span class="hljs-doctag">@param</span>:NULL</span><br><span class="hljs-comment">    <span class="hljs-doctag">@return</span>:NULL</span><br><span class="hljs-comment">**/</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">iic_delay</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>    <span class="hljs-title function_">delay_us</span>(<span class="hljs-number">2</span>);    <span class="hljs-comment">/* 读写速度在250Khz以内 */</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>为获得稳定的读写结果，需限制读写速度，此处通过延时2us的形式实现。</p>
<h4 id="起始信号与停止信号"><a class="markdownIt-Anchor" href="#起始信号与停止信号"></a> 起始信号与停止信号</h4>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/** </span><br><span class="hljs-comment">    @brief:IIC起始信号</span><br><span class="hljs-comment">    @param:NULL</span><br><span class="hljs-comment">    @return:NULL</span><br><span class="hljs-comment">**/</span><br>void <span class="hljs-built_in">iic_start</span>(void)<br>&#123;<br>    <span class="hljs-built_in">IIC_SDA</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">IIC_SCL</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SDA</span>(<span class="hljs-number">0</span>);   <span class="hljs-comment">/* START信号 */</span><br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SCL</span>(<span class="hljs-number">0</span>);   <span class="hljs-comment">/* 钳住总线，准备发送或接收数据（SCL只有低电平期间允许改变SDA状态） */</span><br>    <span class="hljs-built_in">iic_delay</span>();<br>&#125;<br><br><br><span class="hljs-comment">/** </span><br><span class="hljs-comment">    @brief:IIC停止信号</span><br><span class="hljs-comment">    @param:NULL</span><br><span class="hljs-comment">    @return:NULL</span><br><span class="hljs-comment">**/</span><br>void <span class="hljs-built_in">iic_stop</span>(void)<br>&#123;<br>    <span class="hljs-built_in">IIC_SDA</span>(<span class="hljs-number">0</span>);     <span class="hljs-comment">/* STOP信号 */</span><br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SCL</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SDA</span>(<span class="hljs-number">1</span>);     <span class="hljs-comment">/* 总线结束信号 */</span><br>    <span class="hljs-built_in">iic_delay</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="/images/arm/i2c4.png" srcset="/img/loading.gif" lazyload alt="START和STOP时序"></p>
<p>根据IIC时序图，起始信号和停止信号分别为：</p>
<ul>
<li>START：SCL高电平，SDA从1跳变至0</li>
<li>STOP：SCL高电平，SDA从0跳变至1</li>
</ul>
<p>上面的两个函数实现的就是这个功能，同时加入了延时来保证能得到稳定的电平。需要注意，停止信号发出时，SCL需要在SDA电平开始跳变前就保持高电平。</p>
<h4 id="发送字节"><a class="markdownIt-Anchor" href="#发送字节"></a> 发送字节</h4>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-comment">/** </span><br><span class="hljs-comment">    <span class="hljs-doctag">@brief</span>:IIC发送一个字节</span><br><span class="hljs-comment">    <span class="hljs-doctag">@param</span>:data：要发送的数据</span><br><span class="hljs-comment">    <span class="hljs-doctag">@return</span>:NULL</span><br><span class="hljs-comment">**/</span><br><span class="hljs-variable">void</span> <span class="hljs-title function_">iic_send_byte</span>(<span class="hljs-params">uint8_t</span> <span class="hljs-params">data</span>)<br>&#123;<br>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">t</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-variable">t</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">8</span>; <span class="hljs-variable">t</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>)<br>    &#123;<br>        <span class="hljs-title function_">IIC_SDA</span>((<span class="hljs-variable">data</span> <span class="hljs-operator">&amp;</span> <span class="hljs-number">0x80</span>) <span class="hljs-operator">&gt;&gt;</span> <span class="hljs-number">7</span>);    <span class="hljs-comment">/* 提取高位 */</span><br>        <span class="hljs-title function_">iic_delay</span>();<br>        <span class="hljs-title function_">IIC_SCL</span>(<span class="hljs-number">1</span>);     <span class="hljs-comment">/* 拉高SCL并维持高电平，开始发送 */</span><br>        <span class="hljs-title function_">iic_delay</span>();<br>        <span class="hljs-title function_">IIC_SCL</span>(<span class="hljs-number">0</span>);     <span class="hljs-comment">/* 发送结束，拉低SCL，准备下一位数据 */</span><br>        <span class="hljs-variable">data</span> <span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span>;     <span class="hljs-comment">/* 左移1位，循环发送 */</span><br>    &#125;<br>    <span class="hljs-title function_">IIC_SDA</span>(<span class="hljs-number">1</span>);     <span class="hljs-comment">/* 发送完成，释放SDA线 */</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="/images/arm/i2c5.png" srcset="/img/loading.gif" lazyload alt="I2C发送时序"></p>
<p>发送字节时，由于一个时钟周期内I2C只能发送一位(bit)数据，因此发送需要循环8次，模拟8个时钟信号，才能把形参的8位数据都发送出去。也就是我们需要提取出形参的每一位并发送。这里使用了<code>(data &amp; 0x80) &gt;&gt; 7</code>的方式。<code>(data &amp; 0x80)</code>是将形参与<code>0x80</code>，也就是<code>10000000</code>进行与运算，然后右移7位，提取出形参的最高位。如果最高位是1，那么SDA就拉高；反之SDA则拉低。每个周期完成后，data左移1位，将原先是次高位的数移到最高位，重复这个过程8次。全部发送完成后，释放SDA线。</p>
<h4 id="读取字节"><a class="markdownIt-Anchor" href="#读取字节"></a> 读取字节</h4>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-comment">/** </span><br><span class="hljs-comment">    <span class="hljs-doctag">@brief</span>:IIC读取一个字节</span><br><span class="hljs-comment">    <span class="hljs-doctag">@param</span>:ack: ack=1时，发送ack; ack=0时，发送nack</span><br><span class="hljs-comment">    <span class="hljs-doctag">@return</span>:接收到的数据</span><br><span class="hljs-comment">**/</span><br><span class="hljs-variable">uint8_t</span> <span class="hljs-title function_">iic_read_byte</span>(<span class="hljs-params">uint8_t</span> <span class="hljs-params">ack</span>)<br>&#123;<br>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">i</span>, <span class="hljs-variable">receive</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x00</span>;<br><br>    <span class="hljs-comment">/* 1个字节共8位，单次接收1位，循环8次 */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">8</span>; <span class="hljs-variable">i</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>)<br>    &#123;<br>        <span class="hljs-variable">receive</span> <span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span>;      <span class="hljs-comment">/* 输出时高位先输出，因此接收时先收到的数据是高位，要左移 */</span><br>        <span class="hljs-title function_">IIC_SCL</span>(<span class="hljs-number">1</span>);         <span class="hljs-comment">/* 拉高SCL，SDA准备接收 */</span><br>        <span class="hljs-title function_">iic_delay</span>();<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">IIC_READ_SDA</span>)   <span class="hljs-comment">/* 如果SDA为高电平 */</span><br>        &#123;<br>            <span class="hljs-variable">receive</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>;      <span class="hljs-comment">/* 第0位（低位）置1 */</span><br>        &#125;<br><br>        <span class="hljs-title function_">IIC_SCL</span>(<span class="hljs-number">0</span>);         <span class="hljs-comment">/* 接收结束，拉低SCL */</span><br>        <span class="hljs-title function_">iic_delay</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span><span class="hljs-variable">ack</span>)<br>    &#123;<br>        <span class="hljs-title function_">iic_nack</span>();         <span class="hljs-comment">/* 发送nACK信号 */</span><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-title function_">iic_ack</span>();          <span class="hljs-comment">/* 发送ACK信号 */</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">receive</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在时序方面，I2C读取字节和写入字节是一致的。</p>
<h4 id="应答信号ack"><a class="markdownIt-Anchor" href="#应答信号ack"></a> 应答信号（ACK）</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/** </span><br><span class="hljs-comment">    <span class="hljs-doctag">@brief</span>:等待应答信号</span><br><span class="hljs-comment">    <span class="hljs-doctag">@param</span>:NULL</span><br><span class="hljs-comment">    <span class="hljs-doctag">@return</span>:1=失败；0=成功</span><br><span class="hljs-comment">**/</span><br>uint8_t <span class="hljs-title function_">iic_wait_ack</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span><br>&#123;<br>    <span class="hljs-type">uint8_t</span> <span class="hljs-variable">waittime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint8_t</span> <span class="hljs-variable">rack</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    IIC_SDA(<span class="hljs-number">1</span>);     <span class="hljs-comment">/* 主机释放SDA（外部器件此时可拉低SDA电平） */</span><br>    iic_delay();<br>    IIC_SCL(<span class="hljs-number">1</span>);     <span class="hljs-comment">/* 拉高SCL，从机此时可返回ACK */</span><br>    iic_delay();<br><br>    <span class="hljs-keyword">while</span> (IIC_READ_SDA)    <span class="hljs-comment">/* 等待应答 */</span><br>    &#123;<br>        waittime++;<br><br>        <span class="hljs-keyword">if</span> (waittime &gt; <span class="hljs-number">250</span>)<br>        &#123;<br>            iic_stop();<br>            rack = <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    IIC_SCL(<span class="hljs-number">0</span>);     <span class="hljs-comment">/* SCL=0，结束ACK检查 */</span><br>    iic_delay();<br>    <span class="hljs-keyword">return</span> rack;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>等待应答信号一般用在写时序中，在<code>iic_send_byte</code>后调用。当读取到SDA为低电平时，表示ACK信号；SDA为高电平则为NACK信号。若等待超时，则主机会直接发出停止信号。若正常接收到ACK信号，主机拉低SCL线，返回flag。这一段内容对应总线时序图中的红圈3，也就是脉冲9。</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/** </span><br><span class="hljs-comment">    @brief:产生ACK应答</span><br><span class="hljs-comment">    @param:NULL</span><br><span class="hljs-comment">    @return:NULL</span><br><span class="hljs-comment">    @note：ACK应答时，SDA拉低，SCL=0-&gt;1-&gt;0</span><br><span class="hljs-comment">**/</span><br>void <span class="hljs-built_in">iic_ack</span>(void)<br>&#123;<br>    <span class="hljs-built_in">IIC_SDA</span>(<span class="hljs-number">0</span>);     <br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SCL</span>(<span class="hljs-number">1</span>);     <br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SCL</span>(<span class="hljs-number">0</span>);     <br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SDA</span>(<span class="hljs-number">1</span>);     <br>    <span class="hljs-built_in">iic_delay</span>();<br>&#125;<br><br><span class="hljs-comment">/** </span><br><span class="hljs-comment">    @brief:不产生ACK应答（NACK）</span><br><span class="hljs-comment">    @param:NULL</span><br><span class="hljs-comment">    @return:NULL</span><br><span class="hljs-comment">    @note：NACK应答时，SDA拉高，SCL=0-&gt;1-&gt;0</span><br><span class="hljs-comment">**/</span><br>void <span class="hljs-built_in">iic_nack</span>(void)<br>&#123;<br>    <span class="hljs-built_in">IIC_SDA</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SCL</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">iic_delay</span>();<br>    <span class="hljs-built_in">IIC_SCL</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">iic_delay</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>以上两个函数用于主机作为接收端时，在接收完数据后向从机返回ACK或NACK信号。二者对应的也是线时序图中的红圈3，也就是脉冲9。</p>
<h2 id="24cxx-eeprom-驱动"><a class="markdownIt-Anchor" href="#24cxx-eeprom-驱动"></a> 24CXX EEPROM 驱动</h2>
<h3 id="写操作-2"><a class="markdownIt-Anchor" href="#写操作-2"></a> 写操作</h3>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* @brief 向 AT24CXX 指定地址写入一个数据</span><br><span class="hljs-comment">* @param addr: 写入数据的目的地址</span><br><span class="hljs-comment">* @param data: 要写入的数据</span><br><span class="hljs-comment">* @retval 无</span><br><span class="hljs-comment">*/</span><br>void <span class="hljs-built_in">at24cxx_write_one_byte</span>(uint16_t addr, uint8_t data)<br>&#123;<br>    <span class="hljs-built_in">iic_start</span>();       <span class="hljs-comment">/* IIC起始信号 */</span><br><br>    if (EE_TYPE &gt; AT24C16)  <span class="hljs-comment">/* 容量大于24C16时分2个字节发送目标内存地址 */</span><br>    &#123;<br>        <span class="hljs-built_in">iic_send_byte</span>(<span class="hljs-number">0</span>xA0);    <span class="hljs-comment">/* 发送写命令，从机设备地址为0xA0，最低位为0表示写入 */</span><br>        <span class="hljs-built_in">iic_wait_ack</span>();         <span class="hljs-comment">/* 发送完一个字节后等待ACK */</span><br>        <span class="hljs-built_in">iic_send_byte</span>(addr &gt;&gt; <span class="hljs-number">8</span>);   <span class="hljs-comment">/* 发送高位内存地址 */</span><br>    &#125;<br>    else<br>    &#123;<br>        <span class="hljs-built_in">iic_send_byte</span>(<span class="hljs-number">0</span>xA0 + ((addr &gt;&gt; <span class="hljs-number">8</span>) &lt;&lt; <span class="hljs-number">1</span>));   <span class="hljs-comment">/* 发送器件0xA0 + 高位a8/a9/a10地址，写数据 */</span><br>    &#125;<br><br>    <span class="hljs-built_in">iic_wait_ack</span>();<br>    <span class="hljs-built_in">iic_send_byte</span>(addr % <span class="hljs-number">256</span>);  <span class="hljs-comment">/* 发送低位内存地址 */</span><br>    <span class="hljs-built_in">iic_wait_ack</span>();<br><br>    <span class="hljs-built_in">iic_send_byte</span>(data);    <span class="hljs-comment">/* 发送1个字节 */</span><br>    <span class="hljs-built_in">iic_wait_ack</span>();<br>    <span class="hljs-built_in">iic_stop</span>();<br>    <span class="hljs-built_in">delay_ms</span>(<span class="hljs-number">10</span>);       <span class="hljs-comment">/* EEPROM写入速度慢，必须等待写入完成再写下一个 */</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>24CXX的写操作主要包含三个步骤：写入设备地址，写入目标内存地址，写入待传输数据。设备地址之前已经介绍过，高7位为固定地址，低1位为<code>'0'</code>时表示写操作。</p>
<ul>
<li>若EEPROM容量大于24C16，比如24C32和24C64，EEPROM总的字节数分别为4096和8192，对应寻址线为12根和13根，即内存地址是12位和13位的，显然发送内存地址时就需要分高字节和低字节两次发送。</li>
<li>若EEPROM容量小于或等于24C16，则寻址线最多为11根，内存地址最多是11位的。通过<code>iic_send_byte(0xA0 + ((addr &gt;&gt; 8) &lt;&lt; 1))</code>，可以让主机下发读写命令时自带3位高地址，剩下的8位地址只需要合在一起在低位发送即可，也就是<code>iic_send_byte(addr % 256)</code>。</li>
</ul>
<p>这种设备地址低位和内存地址高位相结合的设计可以看作是EEPROM和独特设计，用来节省资源。</p>
<h3 id="读操作-2"><a class="markdownIt-Anchor" href="#读操作-2"></a> 读操作</h3>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* @brief 在 AT24CXX 指定地址写入一个数据</span><br><span class="hljs-comment">* @param addr: 写入数据的目的地址</span><br><span class="hljs-comment">* @param data: 要写入的数据</span><br><span class="hljs-comment">* @retval 无</span><br><span class="hljs-comment">*/</span><br>uint8_t at24cxx_read_one_<span class="hljs-meta">byte</span>(uint16_t addr)<br>&#123;<br>    uint8_t temp = 0;<br>    iic_start();<br><br>    <span class="hljs-comment">/* 根据不同的 24CXX 型号, 发送高位地址</span><br><span class="hljs-comment">    * 1, 24C16 以上的型号, 分 2 个字节发送地址</span><br><span class="hljs-comment">    * 2, 24C16 及以下的型号, 分 1 个低字节地址 + 占用器件地址的 bit1 ~ bit3 位</span><br><span class="hljs-comment">    * 用于表示高位地址, 最多 11 位地址</span><br><span class="hljs-comment">    * 对于 24C01/02, 其器件地址格式(8bit)为: 1 0 1 0 A2 A1 A0 R/W</span><br><span class="hljs-comment">    * 对于 24C04, 其器件地址格式(8bit)为: 1 0 1 0 A2 A1 a8 R/W</span><br><span class="hljs-comment">    * 对于 24C08, 其器件地址格式(8bit)为: 1 0 1 0 A2 a9 a8 R/W</span><br><span class="hljs-comment">    * 对于 24C16, 其器件地址格式(8bit)为: 1 0 1 0 a10 a9 a8 R/W</span><br><span class="hljs-comment">    * R/W : 读/写控制位 0,表示写; 1,表示读;</span><br><span class="hljs-comment">    * A0/A1/A2 : 对应器件的 1,2,3 引脚(只有 24C01/02/04/8 有这些脚)</span><br><span class="hljs-comment">    * a8/a9/a10: 对应存储整列的高位地址, 11bit 地址最多可以表示 2048 个位置,</span><br><span class="hljs-comment">    * 可以寻址 24C16 及以内的型号</span><br><span class="hljs-comment">    */</span><br><br>   <span class="hljs-keyword">if</span> (EE_TYPE &gt; AT24C16)       <span class="hljs-comment">/* 24C16以上型号分2个字节发送地址 */</span><br>   &#123;<br>        iic_send_<span class="hljs-meta">byte</span>(0xA0);    <span class="hljs-comment">/* 最低位为0，表示写入*/</span><br>        iic_wait_ack();         <span class="hljs-comment">/* 发送完一个字节后等待ACK信号 */</span><br>        iic_send_<span class="hljs-meta">byte</span>(addr &gt;&gt; 8);       <span class="hljs-comment">/* 发送高字节地址 */</span><br>   &#125;<br>   <span class="hljs-keyword">else</span><br>   &#123;<br>        <span class="hljs-comment">/* 发送器件0xA0 + 高位a8/a9/a10地址，写数据 */</span><br>        iic_send_<span class="hljs-meta">byte</span>(0xA0 + ((addr &gt;&gt; 8) &lt;&lt; 1));<br>   &#125;<br><br>   iic_wait_ack();<br>   iic_send_<span class="hljs-meta">byte</span>(addr % 256);       <span class="hljs-comment">/* 发送低位地址*/</span><br>   iic_wait_ack();<br><br>   iic_start();                     <span class="hljs-comment">/* 重新发送起始信号*/</span><br>   iic_send_<span class="hljs-meta">byte</span>(0xA1);             <span class="hljs-comment">/* 进入接收模式，最低位为1，表示读取*/</span><br>   iic_wait_ack();<br>   temp = iic_read_<span class="hljs-meta">byte</span>(0);         <span class="hljs-comment">/* 接收一个字节数据 */</span><br>   iic_stop();<br><br>   <span class="hljs-keyword">return</span> temp;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>iic_send_byte(addr % 256)</code>用来提取内存地址的低8位。也可以用<code>addr &amp;= 0x00FF</code>来代替。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%EF%BC%88%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%EF%BC%89/" class="category-chain-item">嵌入式（裸机开发）</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>STM32中的I2C通信</div>
      <div>http://akichen891.github.io/2024/12/07/STM32中的I2C通信/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Aki Chen</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月7日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2024年12月12日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/12/12/RNN%EF%BC%9A%E5%8E%9F%E7%90%86%E3%80%81%E7%BB%84%E6%88%90%E4%B8%8E%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" title="RNN：原理、组成与简单实现">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RNN：原理、组成与简单实现</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/04/STM32%E5%86%85%E9%83%A8%E6%B8%A9%E5%BA%A6%E4%BC%A0%E6%84%9F%E5%99%A8%E9%87%87%E9%9B%86/" title="STM32F4 内部温度传感器（Internal Temperature Sensor）">
                        <span class="hidden-mobile">STM32F4 内部温度传感器（Internal Temperature Sensor）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
